<html>
  <head>
    <title>Kick | BrilliantSole JavaScript SDK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <script type="module" src="./script.js"></script>
    <script src="../utils/aframe/aframe-master.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.3/dist/aframe-physics-system.min.js"></script>
    <script src="../utils/aframe/grabbable-physics-body.js"></script>
    <script src="../utils/aframe/grabbable-listener.js"></script>
    <script src="../utils/aframe/grabbable-anchor.js"></script>
    <script src="../utils/aframe/hand-punch.js" type="module"></script>
    <script src="../utils/aframe/occlude-hand-tracking-controls.js"></script>
    <script src="../utils/aframe/palm-up-detector.js"></script>
    <script src="../utils/aframe/grow-shrink.js"></script>
    <script src="./components/platter.js"></script>
    <script src="./components/goomba.js"></script>
    <script src="./components/squashed-goomba.js"></script>
    <script src="./components/coin.js"></script>
    <script src="../utils/aframe/occlude-mesh.js"></script>
    <script src="../utils/aframe/bs-vibration.js" type="module"></script>
  </head>
  <style>
    #scene {
      width: 500px;
      height: 400px;
      margin: auto;
      border-radius: 2rem;
      overflow: hidden;
      border: solid black;
      box-sizing: border-box;
    }

    #title {
      margin: auto;
      height: 70px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;

      font-size: xx-large;
    }
  </style>
  <body>
    <nav>
      <a href="../../">home</a>
    </nav>

    <h1>Kick | BrilliantSole JavaScript SDK</h1>

    <template id="connectToDeviceTemplate">
      <div class="connectToDevice">
        <label>
          ip address:
          <input
            class="ipAddress"
            placeholder="127.0.0.1"
            type="text"
            minlength="7"
            maxlength="15"
            size="15"
          />
        </label>
        <button class="toggleConnection">connect</button>
        <progress hidden value="0" class="fileTransferProgress"></progress>
        <label hidden>
          is model ready <input type="checkbox" disabled class="isModelReady" />
        </label>
        <label hidden> gesture: <b class="maxClass"></b> </label>
      </div>
    </template>

    <div id="connectToDeviceContainers"></div>

    <a-scene
      pool__splat="mixin: splatMixin; size: 10"
      pool__coin="mixin: coinMixin; size: 10"
      pool__purr="mixin: purrMixin; size: 2; dynamic: true;"
      pool__purrfadeout="mixin: purrFadeOutMixin; size: 2; dynamic: true;"
      pool__getup="mixin: getUpMixin; size: 5; dynamic: true;"
      pool__grab="mixin: grabMixin; size: 2; dynamic: true;"
      pool__release="mixin: releaseMixin; size: 2; dynamic: true;"
      pool__punchsqueak="mixin: punchSqueakMixin; size: 2; dynamic: true;"
      pool__bounceweak="mixin: bounceWeakMixin; size: 3; dynamic: true;"
      pool__bouncemedium="mixin: bounceMediumMixin; size: 3; dynamic: true;"
      pool__bouncestrong="mixin: bounceStrongMixin; size: 3; dynamic: true;"
      id="scene"
      physics="debug: false; restitution: 0.4;"
      embedded
      grabbable-listener
      obb-collider="showColliders: false;"
      xr-mode-ui="enabled: true; XRMode: ar;"
      real-world-meshing="meshMixin: realWorldMeshMixin; meshesEnabled: true; planeMixin: realWorldPlaneMixin; planesEnabled: true; filterLabels: table, wall, floor, ceiling;"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <a-asset-item
          id="anchorModel"
          src="../../assets/3d/anchor.glb"
        ></a-asset-item>
        <a-asset-item
          id="coinModel"
          src="../../assets/3d/coin.glb"
        ></a-asset-item>
        <a-mixin
          id="realWorldPlaneMixin"
          obb-collider
          static-body
          visible="false"
        >
        </a-mixin>
        <a-mixin id="realWorldMeshMixin" occlude-mesh></a-mixin>
        <audio
          id="coinAudio"
          src="../../assets/audio/coin.wav"
          preload="auto"
        ></audio>
        <a-mixin id="coinMixin" sound="src: #coinAudio"></a-mixin>

        <audio
          id="splatAudio"
          src="../../assets/audio/splat.wav"
          preload="auto"
        ></audio>
        <a-mixin id="splatMixin" sound="src: #splatAudio"></a-mixin>

        <audio
          id="punchAudio"
          src="../../assets/audio/punch.wav"
          preload="auto"
        ></audio>

        <audio
          id="purrAudio"
          src="../../assets/audio/purr.wav"
          preload="auto"
        ></audio>
        <a-mixin id="purrMixin" sound="src: #purrAudio; loop: true;"></a-mixin>

        <audio
          id="purrFadeOutAudio"
          src="../../assets/audio/purrFadeOut.wav"
          preload="auto"
        ></audio>
        <a-mixin
          id="purrFadeOutMixin"
          sound="src: #purrFadeOutAudio;"
        ></a-mixin>

        <audio
          id="getUpAudio"
          src="../../assets/audio/getUp.wav"
          preload="auto"
        ></audio>
        <a-mixin id="getUpMixin" sound="src: #getUpAudio;"></a-mixin>

        <audio
          id="platterFadeInAudio"
          src="../../assets/audio/platterFadeIn.wav"
          preload="auto"
        ></audio>
        <audio
          id="platterFadeOutAudio"
          src="../../assets/audio/platterFadeOut.wav"
          preload="auto"
        ></audio>

        <audio
          id="grabAudio"
          src="../../assets/audio/grab.wav"
          preload="auto"
        ></audio>
        <a-mixin id="grabMixin" sound="src: #grabAudio; volume: 0.2;"></a-mixin>

        <audio
          id="releaseAudio"
          src="../../assets/audio/release.wav"
          preload="auto"
        ></audio>
        <a-mixin
          id="releaseMixin"
          sound="src: #releaseAudio; volume: 0.4;"
        ></a-mixin>

        <audio
          id="punchSqueakAudio"
          src="../../assets/audio/punchSqueak.wav"
          preload="auto"
        ></audio>
        <a-mixin
          id="punchSqueakMixin"
          sound="src: #punchSqueakAudio; volume: 1;"
        ></a-mixin>

        <audio
          id="bounceWeakAudio"
          src="../../assets/audio/bounceWeak.wav"
          preload="auto"
        ></audio>
        <a-mixin
          id="bounceWeakMixin"
          sound="src: #bounceWeakAudio; volume: 1;"
        ></a-mixin>

        <audio
          id="bounceMediumAudio"
          src="../../assets/audio/bounceMedium.wav"
          preload="auto"
        ></audio>
        <a-mixin
          id="bounceMediumMixin"
          sound="src: #bounceMediumAudio; volume: 1;"
        ></a-mixin>

        <audio
          id="bounceStrongAudio"
          src="../../assets/audio/bounceStrong.wav"
          preload="auto"
        ></audio>
        <a-mixin
          id="bounceStrongMixin"
          sound="src: #bounceStrongAudio; volume: 1;"
        ></a-mixin>
      </a-assets>
      <!--<a-entity rotation="-90 0 0" position="0 2 1">
        <a-camera
          class="lookAt"
          id="camera"
          _raycaster="objects: .raycastable; interval: 100;"
        >
          <a-sphere color="black" radius="0.001" position="0 0 -0.1"></a-sphere>
        </a-camera>
      </a-entity>
    -->

      <a-camera
        class="lookAt"
        id="camera"
        position="0 1 0"
        _raycaster="objects: .raycastable; interval: 100;"
      >
      </a-camera>

      <a-entity
        id="anchor"
        anchored="persistent: true"
        position="0.2 1 -0.3"
        grabbable
        grabbable-anchor
      >
        <a-entity
          gltf-model="#anchorModel"
          scale="0.020 0.020 0.020"
          rotation="90 0 0"
        ></a-entity>
      </a-entity>

      <template id="coinTemplate">
        <a-entity>
          <a-entity class="position">
            <a-entity class="rotation">
              <a-entity class="scale">
                <a-entity
                  gltf-model="#coinModel"
                  scale="0.22 0.22 0.22"
                ></a-entity>
              </a-entity>
            </a-entity>
          </a-entity>
        </a-entity>
      </template>

      <template id="squashedGoombaTemplate">
        <a-entity>
          <a-sphere
            class="body"
            color="#a14e00"
            radius="0.1"
            scale="1 1 0.3"
          ></a-sphere>

          <a-entity
            class="eye left"
            position="-0.02535 0.01077 0.02"
            rotation="-11.205 -20.900 0"
          >
            <a-entity class="scalar" scale="1.460 1.690 0.940">
              <a-sphere class="white" color="#fafafa" radius="0.017"></a-sphere>
              <a-entity class="controller">
                <a-sphere
                  class="black"
                  color="#000000"
                  position="0 0 0.015"
                  radius="0.008"
                  scale="1 1 -0.600"
                >
                </a-sphere>
              </a-entity>
            </a-entity>
          </a-entity>

          <a-sphere
            class="left foot"
            color="#301700"
            radius="0.05"
            position="-0.040 -0.070 0.020"
            scale="0.790 1 0.400"
            rotation="0 0 -13.900"
          ></a-sphere>
        </a-entity>
      </template>

      <!-- <a-entity
        id="squashedGoomba1"
        squashed-goomba
        position="0 1.0 -0.3"
      ></a-entity> -->

      <a-entity
        goomba="grabbable: true;"
        id="goomba1"
        position="0 1.0 -0.3"
        class="punchable"
        rotation="-90 0 0"
      ></a-entity>
      <!-- 
      <a-entity
        goomba="grabbable: true;"
        id="goomba2"
        position="0 1.0 -0.6"
        rotation="0 0 0"
      ></a-entity> -->
      <a-box
        scale="1 0.05 1"
        static-body
        position="0 0.8 -0.5"
        data-world-mesh="floor"
        color="blue"
        obb-collider
        id="testFloor"
      ></a-box>
      <!-- <a-box
        scale="1 0.05 1"
        static-body
        position="0 2 -0.5"
        data-world-mesh="floor"
        color="blue"
        obb-collider
        id="testCeiling"
      ></a-box> -->
      <!-- <a-box
        scale="2 2 0.05"
        static-body
        position="0 1 -1"
        data-world-mesh="wall"
        color="yellow"
        obb-collider
        rotation="0 0 0"
        id="testWall"
        visible="false"
      ></a-box> -->
      <!-- <a-box
        scale="2 2 0.05"
        static-body
        position="-1 1 0"
        rotation="0 90 0"
        data-world-mesh="wall"
        color="yellow"
        obb-collider
        id="testLeftWall"
      ></a-box> -->

      <template id="goombaTemplate">
        <a-entity>
          <!-- <a-sphere color="green" opacity="0.1" radius="0.15"></a-sphere> -->
          <a-sphere
            class="pet"
            color="black"
            radius="0.02"
            position="0 0.065 0"
            visible="false"
          ></a-sphere>
          <a-entity class="squash" position="0 -0.07 0">
            <a-entity class="squashOffset" position="0 0.07 0">
              <a-box
                visible="false"
                class="collider"
                scale="0.2 0.18 0.18"
              ></a-box>
              <a-sphere
                class="body"
                color="#a14e00"
                radius="0.1"
                scale="0.9 0.75 0.8"
              >
              </a-sphere>
              <a-sphere
                radius="0.30"
                class="raycastable"
                color="yellow"
                visible="false"
                opacity="0.1"
              ></a-sphere>
              <a-entity
                class="eye left"
                position="-0.02535 0.01077 0.065"
                rotation="-11.205 -20.900 0"
              >
                <a-entity class="scalar" scale="1.460 1.690 0.940">
                  <a-sphere
                    class="white"
                    color="#fafafa"
                    radius="0.017"
                  ></a-sphere>
                  <a-entity class="controller">
                    <a-sphere
                      class="black"
                      color="#000000"
                      position="0 0 0.015"
                      radius="0.008"
                      scale="1 1 -0.600"
                    >
                    </a-sphere>
                  </a-entity>
                </a-entity>
              </a-entity>
            </a-entity>
          </a-entity>
          <a-entity
            class="left leg"
            position="-0.036 -0.026 0.005"
            rotation="0 -16.292 -8.000"
          >
            <a-sphere
              class="foot"
              color="#301700"
              radius="0.05"
              position="0 -0.048 0"
              scale="0.8 0.418 1"
            ></a-sphere>
          </a-entity>
        </a-entity>
      </template>

      <a-entity
        id="leftHand"
        class="lookAt"
        hand-tracking-controls="hand: left; model-opacity: 0;"
        hand-tracking-grab-controls="hand: left;"
        occlude-hand-tracking-controls
        hand-punch
      >
        <a-entity
          id="platter"
          scale="0 0 0"
          platter
          rotation="200 0 -34.3"
          position="0 -0.03 -0.07"
        >
          <a-cylinder color="grey" height="0.01" radius="0.15"></a-cylinder>
        </a-entity>
      </a-entity>
      <a-entity
        id="rightHand"
        hand-punch
        bs-vibration
        class="lookAt"
        hand-tracking-controls="hand: right;"
        occlude-hand-tracking-controls
        hand-tracking-grab-controls="hand: right;"
      ></a-entity>
    </a-scene>
  </body>
  <script>
    const scene = document.querySelector("a-scene");
    scene.addEventListener("loaded", () => {
      return;
      setTimeout(() => {
        const lights = Array.from(document.querySelectorAll("[light]"));
        console.log(lights);
        lights.forEach((light) => {
          if (light.getAttribute("light").type != "ambient") {
            console.log(light.getAttribute("light").type);
            light.setAttribute("light", { castShadow: true });
          }
        });

        const interval = setInterval(() => {
          const realWorldMeshes = Array.from(
            document.querySelectorAll("[data-world-mesh]")
          );
          if (realWorldMeshes.length > 0) {
            clearInterval(interval);
            realWorldMeshes.forEach((entity) => {
              entity.setAttribute("shadow", "cast: false; receive: true;");
            });
          }
        }, 100);
      }, 1);
    });

    for (let i = 0; i < 0; i++) {
      const goomba = document.createElement("a-entity");
      goomba.setAttribute("goomba", "");
      goomba.setAttribute(
        "position",
        `${Math.random() * 2 - 1} 1.1 ${Math.random() * 2 - 1 - 0.5}`
      );
      goomba.setAttribute("rotation", `0 ${Math.random() * 360} 0`);
      scene.appendChild(goomba);
    }

    scene.addEventListener("loaded", () => {
      return;
      goombas.forEach((goomba) => {
        goomba.updatePhysicsEnabled(true);
        goomba.setStatus("falling");
      });
    });
  </script>
</html>
