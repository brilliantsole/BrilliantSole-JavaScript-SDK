/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
function e(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)}function t(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s}"function"==typeof SuppressedError&&SuppressedError;const s=!1,i="undefined"!=typeof window&&void 0!==window?.document,n="undefined"!=typeof process&&null!=process?.versions?.node,a=i&&navigator.userAgent||"";let r=!1;i?r=Boolean(navigator.bluetooth):n&&(r=!0);const o=i&&/Bluefy/i.test(a),c=i&&/WebBLE/i.test(a),h=i&&/Android/i.test(a),l=i&&/Safari/i.test(a)&&!/Chrome/i.test(a),f=i&&/iPad|iPhone|iPod/i.test(a),g=i&&/Macintosh/i.test(a),u=!i&&!n&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var d,p,m,v,w=Object.freeze({__proto__:null,isAndroid:h,get isBluetoothSupported(){return r},isIOS:f,isInBluefy:o,isInBrowser:i,isInDev:s,isInLensStudio:u,isInNode:n,isInProduction:!0,isInWebBLE:c,isMac:g,isSafari:l});if(u){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(v={}).log=e,v.warn=e.bind(v,"WARNING"),v.error=e.bind(v,"ERROR")}else v=console;function y(e){return(...t)=>{if(n){const s=function(){const e=(new Error).stack;if(!e)return"";const t=e.split("\n"),s=t[3]||t[2],i=s.match(/at (.*?) \(/)||s.match(/at (.*)/);return i?`[${i[1].trim()}]`:""}();e(s,...t)}else e(...t)}}if(!v.assert){const e=(e,...t)=>{e||v.warn(...t)};v.assert=e}if(!v.table){const e=(...e)=>{v.log(...e)};v.table=e}function b(){}const S=n?y(v.log.bind(v)):v.log.bind(v),C=n?y(v.warn.bind(v)):v.warn.bind(v),E=n?y(v.error.bind(v)):v.error.bind(v),M=n?y(v.table.bind(v)):v.table.bind(v),D=v.assert.bind(v);class k{constructor(t){if(m.set(this,{log:s,warn:s,assert:!0,error:!0,table:!0}),e(d,d,"f",p)[t])throw new Error(`"${t}" console already exists`);e(d,d,"f",p)[t]=this}setLevelFlags(t){Object.assign(e(this,m,"f"),t)}static setLevelFlagsForType(t,s){if(!e(this,d,"f",p)[t])throw new Error(`no console found with type "${t}"`);e(this,d,"f",p)[t].setLevelFlags(s)}static setAllLevelFlags(t){for(const s in e(this,d,"f",p))e(this,d,"f",p)[s].setLevelFlags(t)}static create(t,s){return e(this,d,"f",p)[t]||new d(t)}get log(){return e(this,m,"f").log?S:b}get warn(){return e(this,m,"f").warn?C:b}get error(){return e(this,m,"f").error?E:b}get assert(){return e(this,m,"f").assert?D:b}get table(){return e(this,m,"f").table?M:b}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}assertRangeWithError(e,t,s,i){this.assertWithError(t>=s&&t<=i,`${e} ${t} must be within ${s}-${i}`)}}function W(e,t){return k.create(e,t)}function T(e,t){k.setLevelFlagsForType(e,t)}function I(e){k.setAllLevelFlags(e)}d=k,m=new WeakMap,p={value:{}};const R=W("EventDispatcher",{log:!1});class U{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}updateEventListeners(e){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((t=>(t.shouldRemove&&R.log(`removing "${e}" eventListener`,t),!t.shouldRemove))))}addEventListener(e,t,s={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[],R.log(`creating "${e}" listeners array`,this.listeners[e]));this.listeners[e].find((e=>e.listener==t&&e.once==s.once))?R.log("already added listener"):(R.log(`adding "${e}" listener`,t,s),this.listeners[e].push({listener:t,once:s.once}),R.log(`currently have ${this.listeners[e].length} "${e}" listeners`))}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(R.log(`removing "${e}" listener...`,t),this.listeners[e].forEach((s=>{s.listener===t&&(R.log(`flagging "${e}" listener`,t),s.shouldRemove=!0)})),this.updateEventListeners(e))}removeEventListeners(e){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(R.log(`removing "${e}" listeners...`),this.listeners[e]=[])}removeAllEventListeners(){R.log("removing listeners..."),this.listeners={}}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e].forEach((s=>{if(!s.shouldRemove){R.log(`dispatching "${e}" listener`,s);try{s.listener({type:e,target:this.target,message:t})}catch(e){console.error(e)}s.once&&(R.log(`flagging "${e}" listener`,s),s.shouldRemove=!0)}})),this.updateEventListeners(e))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var L,_,A;const F=W("Timer",{log:!1});class x{get callback(){return e(this,L,"f")}set callback(e){F.assertTypeWithError(e,"function"),F.log({newCallback:e}),t(this,L,e,"f"),this.isRunning&&this.restart()}get interval(){return e(this,_,"f")}set interval(e){F.assertTypeWithError(e,"number"),F.assertWithError(e>0,"interval must be above 0"),F.log({newInterval:e}),t(this,_,e,"f"),this.isRunning&&this.restart()}constructor(e,t){L.set(this,void 0),_.set(this,void 0),A.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=e(this,A,"f")}start(s=!1){this.isRunning?F.log("interval already running"):(F.log(`starting interval every ${e(this,_,"f")}ms`),t(this,A,setInterval(e(this,L,"f"),e(this,_,"f")),"f"),s&&e(this,L,"f").call(this))}stop(){this.isRunning?(F.log("stopping interval"),clearInterval(e(this,A,"f")),t(this,A,void 0,"f")):F.log("interval already not running")}restart(e=!1){this.stop(),this.start(e)}}function $(e){for(let t=0;t<8;++t)e=(1&e?0:3988292384)^e>>>1;return 4278190080^e}L=new WeakMap,_=new WeakMap,A=new WeakMap,W("checksum",{log:!1});const O=new Uint32Array(256);for(let e=0;e<256;++e)O[e]=$(e);function B(e){let t=new Uint8Array(e),s=0;for(let e=0;e<t.byteLength;++e){const i=255&s,n=t[e];s=(O[i^n]^s>>>8)>>>0}return s}var N,P;N="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,P="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const V=new N,q=new P,z=W("ArrayBufferUtils",{log:!1});function j(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return G(e)}if(e instanceof Array){return j(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return G(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;return e.forEach((e=>{s.set(new Uint8Array(e),i),i+=e.byteLength})),s.buffer}function G(e){const t=V.encode(e);return j(t.byteLength,t)}function H(e,t,s){let i;return null!=s&&(i=e.byteOffset+t+s),z.log({dataView:e,begin:t,end:i,length:s}),new DataView(e.buffer.slice(e.byteOffset+t,i))}async function J(e){let t;if(e instanceof Array)t=Uint8Array.from(e);else if(e instanceof DataView)t=e.buffer;else if("string"==typeof e||e instanceof URL){const s=await fetch(e);t=await s.arrayBuffer()}else if(e instanceof File)t=await e.arrayBuffer();else{if(!(e instanceof ArrayBuffer))throw{error:"invalid file type",file:e};t=e}return t}function K(e){return Uint8Array.from([e]).buffer}function Q(e,{include:t,exclude:s}={}){const i=e=>{const i=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(i):!s||!s.some(i)};for(const[t,s]of(e=>{const t=new Set;do{for(const s of Reflect.ownKeys(e))t.add([e,s])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===s||!i(s))continue;const n=Reflect.getOwnPropertyDescriptor(t,s);n&&"function"==typeof n.value&&(e[s]=e[s].bind(e))}return e}var Z,X,Y,ee,te,se,ie,ne,ae,re,oe,ce,he,le,fe,ge,ue,de,pe,me,ve,we,ye,be,Se,Ce,Ee,Me,De,ke,We,Te,Ie,Re,Ue,Le,_e,Ae,Fe,xe,$e;const Oe=W("FileTransferManager",{log:!1}),Be=["getFileTypes","maxFileLength","getFileType","setFileType","getFileLength","setFileLength","getFileChecksum","setFileChecksum","setFileTransferCommand","fileTransferStatus","getFileBlock","setFileBlock","fileBytesTransferred"],Ne=["tflite","wifiServerCert","wifiServerKey"],Pe=["idle","sending","receiving"],Ve=["startSend","startReceive","cancel"],qe=["sending","receiving"],ze=[...Be,"fileTransferProgress","fileTransferComplete","fileReceived"],je=["maxFileLength","getFileLength","getFileChecksum","getFileType","fileTransferStatus"];class Ge{constructor(){Z.add(this),ne.set(this,[]),oe.set(this,X.MaxLength),fe.set(this,void 0),pe.set(this,0),ye.set(this,0),Me.set(this,"idle"),Ie.set(this,[]),Ue.set(this,void 0),Le.set(this,0),xe.set(this,!1),$e.set(this,!1),Q(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get fileTypes(){return e(this,ne,"f")}static get MaxLength(){return e(this,X,"f",re)}get maxLength(){return e(this,oe,"f")}get type(){return e(this,fe,"f")}get length(){return e(this,pe,"f")}get checksum(){return e(this,ye,"f")}get status(){return e(this,Me,"f")}parseMessage(t,s){switch(Oe.log({messageType:t}),t){case"getFileTypes":e(this,Z,"m",ae).call(this,s);break;case"maxFileLength":e(this,Z,"m",ce).call(this,s);break;case"getFileType":case"setFileType":e(this,Z,"m",ge).call(this,s);break;case"getFileLength":case"setFileLength":e(this,Z,"m",me).call(this,s);break;case"getFileChecksum":case"setFileChecksum":e(this,Z,"m",be).call(this,s);break;case"fileTransferStatus":e(this,Z,"m",De).call(this,s);break;case"getFileBlock":e(this,Z,"m",Re).call(this,s);break;case"fileBytesTransferred":e(this,Z,"m",Fe).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}async send(t,s){e(this,Z,"m",We).call(this),e(this,Z,"m",ee).call(this,t);const i=await J(s),n=i.byteLength,a=B(i);if(t!=this.type)Oe.log("different fileTypes - sending");else if(n!=this.length)Oe.log("different fileLengths - sending");else{if(a==this.checksum)return Oe.log("already sent file"),!1;Oe.log("different fileChecksums - sending")}const r=[];return r.push(e(this,Z,"m",de).call(this,t,!1)),r.push(e(this,Z,"m",we).call(this,n,!1)),r.push(e(this,Z,"m",Ce).call(this,a,!1)),r.push(e(this,Z,"m",Ee).call(this,"startSend",!1)),this.sendMessage(),await Promise.all(r),await e(this,Z,"m",_e).call(this,i),!0}async receive(t){e(this,Z,"m",We).call(this),e(this,Z,"m",ee).call(this,t),await e(this,Z,"m",de).call(this,t),await e(this,Z,"m",Ee).call(this,"startReceive")}async cancel(){e(this,Z,"m",Te).call(this),Oe.log("cancelling file transfer..."),t(this,xe,!0,"f"),await e(this,Z,"m",Ee).call(this,"cancel")}get isServerSide(){return e(this,$e,"f")}set isServerSide(s){e(this,$e,"f")!=s?(Oe.log({newIsServerSide:s}),t(this,$e,s,"f")):Oe.log("redundant isServerSide assignment")}requestRequiredInformation(){Oe.log("requesting required fileTransfer information");const e=je.map((e=>({type:e})));this.sendMessage(e,!1)}}X=Ge,ne=new WeakMap,oe=new WeakMap,fe=new WeakMap,pe=new WeakMap,ye=new WeakMap,Me=new WeakMap,Ie=new WeakMap,Ue=new WeakMap,Le=new WeakMap,xe=new WeakMap,$e=new WeakMap,Z=new WeakSet,Y=function(){return this.eventDispatcher.dispatchEvent},ee=function(e){Oe.assertEnumWithError(e,Ne)},te=function(e){Oe.assertWithError(e in Ne,`invalid typeEnum ${e}`)},se=function(e){Oe.assertWithError(e in Pe,`invalid statusEnum ${e}`)},ie=function(e){Oe.assertEnumWithError(e,Ve)},ae=function(s){const i=Array.from(new Uint8Array(s.buffer)).map((e=>Ne[e])).filter(Boolean);t(this,ne,i,"f"),Oe.log("fileTypes",i),e(this,Z,"a",Y).call(this,"getFileTypes",{fileTypes:e(this,ne,"f")})},ce=function(t){Oe.log("parseFileMaxLength",t);const s=t.getUint32(0,!0);Oe.log(`maxLength: ${s/1024}kB`),e(this,Z,"m",he).call(this,s)},he=function(s){Oe.log({maxLength:s}),t(this,oe,s,"f"),e(this,Z,"a",Y).call(this,"maxFileLength",{maxFileLength:s})},le=function(e){Oe.assertWithError(e<=this.maxLength,`file length ${e}kB too large - must be ${this.maxLength}kB or less`)},ge=function(t){Oe.log("parseFileType",t);const s=t.getUint8(0);e(this,Z,"m",te).call(this,s);const i=Ne[s];e(this,Z,"m",ue).call(this,i)},ue=function(s){Oe.log({fileTransferType:s}),t(this,fe,s,"f"),e(this,Z,"a",Y).call(this,"getFileType",{fileType:s})},de=async function(t,s){if(e(this,Z,"m",ee).call(this,t),this.type==t)return void Oe.log(`redundant type assignment ${t}`);const i=this.waitForEvent("getFileType"),n=Ne.indexOf(t);this.sendMessage([{type:"setFileType",data:K(n)}],s),await i},me=function(t){Oe.log("parseFileLength",t);const s=t.getUint32(0,!0);e(this,Z,"m",ve).call(this,s)},ve=function(s){Oe.log(`length: ${s/1024}kB`),t(this,pe,s,"f"),e(this,Z,"a",Y).call(this,"getFileLength",{fileLength:s})},we=async function(t,s){if(Oe.assertTypeWithError(t,"number"),e(this,Z,"m",le).call(this,t),this.length==t)return void Oe.log(`redundant length assignment ${t}`);const i=this.waitForEvent("getFileLength"),n=new DataView(new ArrayBuffer(4));n.setUint32(0,t,!0),this.sendMessage([{type:"setFileLength",data:n.buffer}],s),await i},be=function(t){Oe.log("checksum",t);const s=t.getUint32(0,!0);e(this,Z,"m",Se).call(this,s)},Se=function(s){Oe.log({checksum:s}),t(this,ye,s,"f"),e(this,Z,"a",Y).call(this,"getFileChecksum",{fileChecksum:s})},Ce=async function(e,t){if(Oe.assertTypeWithError(e,"number"),this.checksum==e)return void Oe.log(`redundant checksum assignment ${e}`);const s=this.waitForEvent("getFileChecksum"),i=new DataView(new ArrayBuffer(4));i.setUint32(0,e,!0),this.sendMessage([{type:"setFileChecksum",data:i.buffer}],t),await s},Ee=async function(t,s){e(this,Z,"m",ie).call(this,t);const i=this.waitForEvent("fileTransferStatus");Oe.log(`setting command ${t}`);const n=Ve.indexOf(t);this.sendMessage([{type:"setFileTransferCommand",data:K(n)}],s),await i},De=function(t){Oe.log("parseFileStatus",t);const s=t.getUint8(0);e(this,Z,"m",se).call(this,s);const i=Pe[s];e(this,Z,"m",ke).call(this,i)},ke=function(s){Oe.log({status:s}),t(this,Me,s,"f"),e(this,Z,"a",Y).call(this,"fileTransferStatus",{fileTransferStatus:s}),e(this,Ie,"f").length=0,t(this,xe,!1,"f")},We=function(){Oe.assertWithError("idle"==e(this,Me,"f"),"status is not idle")},Te=function(){Oe.assertWithError("idle"!=e(this,Me,"f"),"status is idle")},Re=async function(t){Oe.log("parseFileBlock",t),e(this,Ie,"f").push(t.buffer);const s=e(this,Ie,"f").reduce(((e,t)=>e+t.byteLength),0),i=s/e(this,pe,"f");if(Oe.log(`received ${s} of ${e(this,pe,"f")} bytes (${100*i}%)`),e(this,Z,"a",Y).call(this,"fileTransferProgress",{progress:i}),s!=e(this,pe,"f")){const e=new DataView(new ArrayBuffer(4));if(e.setUint32(0,s,!0),this.isServerSide)return;return void await this.sendMessage([{type:"fileBytesTransferred",data:e.buffer}])}Oe.log("file transfer complete");let n,a=(new Date).toLocaleString();switch(this.type){case"tflite":a+=".tflite";break;case"wifiServerCert":a+="_server.crt";break;case"wifiServerKey":a+="_server.key"}n="undefined"!=typeof File?new File(e(this,Ie,"f"),a):new Blob(e(this,Ie,"f"));const r=B(await n.arrayBuffer());Oe.log({checksum:r}),r==e(this,ye,"f")?(Oe.log("received file",n),e(this,Z,"a",Y).call(this,"getFileBlock",{fileTransferBlock:t}),e(this,Z,"a",Y).call(this,"fileTransferComplete",{direction:"receiving"}),e(this,Z,"a",Y).call(this,"fileReceived",{file:n})):Oe.error(`wrong checksum - expected ${e(this,ye,"f")}, got ${r}`)},_e=async function(s){return t(this,Ue,s,"f"),t(this,Le,0,"f"),e(this,Z,"m",Ae).call(this)},Ae=async function(){if("sending"!=this.status)return;if(e(this,xe,"f"))return void Oe.error("not sending block - busy cancelling");if(!e(this,Ue,"f"))return void(this.isServerSide||Oe.error("no buffer defined"));const s=e(this,Ue,"f");let i=e(this,Le,"f");const n=s.slice(i,i+(this.mtu-3-3));Oe.log("slicedBuffer",n);const a=1-(s.byteLength-i)/s.byteLength;Oe.log(`sending bytes ${i}-${i+n.byteLength} of ${s.byteLength} bytes (${100*a}%)`),e(this,Z,"a",Y).call(this,"fileTransferProgress",{progress:a}),0==n.byteLength?(Oe.log("finished sending buffer"),e(this,Z,"a",Y).call(this,"fileTransferComplete",{direction:"sending"})):(await this.sendMessage([{type:"setFileBlock",data:n}]),t(this,Le,i+n.byteLength,"f"))},Fe=async function(t){Oe.log("parseBytesTransferred",t);const s=t.getUint32(0,!0);if(Oe.log({bytesTransferred:s}),"sending"==this.status)return this.isServerSide||e(this,Le,"f")==s?void e(this,Z,"m",Ae).call(this):(Oe.error(`bytesTransferred are not equal - got ${s}, expected ${e(this,Le,"f")}`),void this.cancel());Oe.error("not currently sending file")},re={value:0};const He=W("MathUtils",{log:!1});const Je=65536;function Ke(e,t){const s=Date.now();var i;let n=(i=s)-i%Je+e.getUint16(t,!0);return Math.abs(s-n)>6e4&&(He.log("correcting timestamp delta"),n+=Je*Math.sign(s-n)),n}function Qe(e,t=0,s=1){return Math.min(Math.max(e,t),s)}var Ze,Xe,Ye;const et={min:1/0,max:-1/0,span:0};class tt{constructor(){Ze.add(this),Xe.set(this,Object.assign({},et))}get min(){return e(this,Xe,"f").min}get max(){return e(this,Xe,"f").max}set min(t){e(this,Xe,"f").min=t,e(this,Xe,"f").max=Math.max(t,e(this,Xe,"f").max),e(this,Ze,"m",Ye).call(this)}set max(t){e(this,Xe,"f").max=t,e(this,Xe,"f").min=Math.min(t,e(this,Xe,"f").min),e(this,Ze,"m",Ye).call(this)}reset(){Object.assign(e(this,Xe,"f"),et)}update(t){e(this,Xe,"f").min=Math.min(t,e(this,Xe,"f").min),e(this,Xe,"f").max=Math.max(t,e(this,Xe,"f").max),e(this,Ze,"m",Ye).call(this)}getNormalization(t,s){let i=function(e,t,s,i){return null==i&&(i=s-t),(e-t)/i}(t,e(this,Xe,"f").min,e(this,Xe,"f").max,e(this,Xe,"f").span);return s&&(i*=e(this,Xe,"f").span),i||0}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}var st,it,nt,at,rt;Xe=new WeakMap,Ze=new WeakSet,Ye=function(){e(this,Xe,"f").span=e(this,Xe,"f").max-e(this,Xe,"f").min};class ot{constructor(){st.set(this,{x:new tt,y:new tt})}reset(){e(this,st,"f").x.reset(),e(this,st,"f").y.reset()}update(t){e(this,st,"f").x.update(t.x),e(this,st,"f").y.update(t.y)}getNormalization(t,s){return{x:e(this,st,"f").x.getNormalization(t.x,s),y:e(this,st,"f").y.getNormalization(t.y,s)}}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}st=new WeakMap;const ct=W("PressureDataManager",{log:!1}),ht=["pressure"],lt=ht,ft=8;class gt{constructor(){it.set(this,[]),nt.set(this,void 0),at.set(this,new tt),rt.set(this,new ot)}get positions(){return e(this,it,"f")}get numberOfSensors(){return this.positions.length}parsePositions(e){const s=[];for(let t=0,i=0;i<e.byteLength;t++,i+=2)s.push({x:e.getUint8(i)/256,y:e.getUint8(i+1)/256});var i,n;ct.log({positions:s}),t(this,it,s,"f"),t(this,nt,(i=this.numberOfSensors,n=()=>new tt,new Array(i).fill(1).map(((e,t)=>{if("function"==typeof n)return n(t);{const e=n;return Object.assign({},e)}}))),"f"),this.resetRange()}resetRange(){e(this,nt,"f")?.forEach((e=>e.reset())),e(this,rt,"f").reset(),e(this,at,"f").reset()}parseData(t,s){const i={sensors:[],scaledSum:0,normalizedSum:0};for(let n=0,a=0;a<t.byteLength;n++,a+=2){const r=t.getUint16(a,!0);let o=r*s/this.numberOfSensors;const c=e(this,nt,"f")[n].updateAndGetNormalization(o,!1),h=this.positions[n];i.sensors[n]={rawValue:r,scaledValue:o,normalizedValue:c,position:h,weightedValue:0},i.scaledSum+=o}return i.normalizedSum=e(this,at,"f").updateAndGetNormalization(i.scaledSum,!1),i.scaledSum>0&&(i.center={x:0,y:0},i.sensors.forEach((e=>{e.weightedValue=e.scaledValue/i.scaledSum,i.center.x+=e.position.x*e.weightedValue,i.center.y+=e.position.y*e.weightedValue})),i.normalizedCenter=e(this,rt,"f").updateAndGetNormalization(i.center,!1)),ct.log({pressure:i}),i}}it=new WeakMap,nt=new WeakMap,at=new WeakMap,rt=new WeakMap;const ut=W("MotionSensorDataManager",{log:!1}),dt=["still","walking","running","bicycle","vehicle","tilting"],pt=["portraitUpright","landscapeLeft","portraitUpsideDown","landscapeRight","unknown"];class mt{parseVector3(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));const a={x:s,y:i,z:n};return ut.log({vector:a}),a}parseQuaternion(e,t){let[s,i,n,a]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0),e.getInt16(6,!0)].map((e=>e*t));const r={x:s,y:i,z:n,w:a};return ut.log({quaternion:r}),r}parseEuler(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));i*=-1,s*=-1,s<0&&(s+=360);const a={heading:s,pitch:i,roll:n};return ut.log({euler:a}),a}parseStepCounter(e){ut.log("parseStepCounter",e);const t=e.getUint32(0,!0);return ut.log({stepCount:t}),t}parseActivity(e){ut.log("parseActivity",e);const t={},s=e.getUint8(0);return ut.log("activityBitfield",s.toString(2)),dt.forEach(((e,i)=>{t[e]=Boolean(s&1<<i)})),ut.log("activity",t),t}parseDeviceOrientation(e){ut.log("parseDeviceOrientation",e);const t=e.getUint8(0),s=pt[t];return ut.assertWithError(s,"undefined deviceOrientation"),ut.log({deviceOrientation:s}),s}}var vt,wt;const yt=["barometer"],bt=yt,St=W("BarometerSensorDataManager",{log:!1});class Ct{constructor(){vt.add(this)}parseData(t,s){const i=t.getUint32(0,!0)*s,n=e(this,vt,"m",wt).call(this,i);return St.log({pressure:i,altitude:n}),{pressure:i}}}vt=new WeakSet,wt=function(e){const t=.0065;return 288.15/t*(1-Math.pow(e/101325,.19026643566373183))};const Et=W("ParseUtils",{log:!1});function Mt(e,t=0){const s=e.getUint8(t++);return{string:q.decode(e.buffer.slice(e.byteOffset+t,e.byteOffset+t+s)),byteOffset:t+=s}}function Dt(e,t,s,i,n=!1){let a=0;for(;a<e.byteLength;){const r=e.getUint8(a++);Et.assertWithError(r in t,`invalid messageTypeEnum ${r}`);const o=t[r];let c;n?(c=e.getUint16(a,!0),a+=2):c=e.getUint8(a++),Et.log({messageTypeEnum:r,messageType:o,messageLength:c,dataView:e,byteOffset:a});const h=H(e,a,c);Et.log({_dataView:h}),s(o,h,i),a+=c}}var kt,Wt,Tt,It,Rt,Ut,Lt,_t,At,Ft,xt,$t,Ot,Bt,Nt,Pt,Vt,qt,zt,jt,Gt,Ht,Jt,Kt,Qt,Zt,Xt,Yt,es;const ts=W("CameraManager",{log:!1}),ss=["focus","takePicture","stop","sleep","wake"],is=["idle","focusing","takingPicture","asleep"],ns=["headerSize","header","imageSize","image","footerSize","footer"],as=["resolution","qualityFactor","shutter","gain","redGain","greenGain","blueGain"],rs=["cameraStatus","cameraCommand","getCameraConfiguration","setCameraConfiguration","cameraData"],os=["getCameraConfiguration","cameraStatus"],cs=[...rs,"cameraImageProgress","cameraImage"];class hs{constructor(){kt.add(this),It.set(this,void 0),$t.set(this,0),Ot.set(this,void 0),Bt.set(this,0),Nt.set(this,0),Pt.set(this,void 0),Vt.set(this,0),qt.set(this,0),zt.set(this,void 0),jt.set(this,0),Gt.set(this,!1),Jt.set(this,{}),Kt.set(this,void 0),Qt.set(this,{resolution:{min:100,max:720},qualityFactor:{min:15,max:60},shutter:{min:4,max:16383},gain:{min:1,max:248},redGain:{min:0,max:1023},greenGain:{min:0,max:1023},blueGain:{min:0,max:1023}}),Q(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){ts.log("requesting required camera information");const e=os.map((e=>({type:e})));this.sendMessage(e,!1)}get cameraStatus(){return e(this,It,"f")}async focus(){e(this,kt,"m",At).call(this),await e(this,kt,"m",Lt).call(this,"focus")}async takePicture(){e(this,kt,"m",At).call(this),await e(this,kt,"m",Lt).call(this,"takePicture")}async stop(){e(this,kt,"m",At).call(this),await e(this,kt,"m",Lt).call(this,"stop")}async sleep(){e(this,kt,"m",At).call(this),await e(this,kt,"m",Lt).call(this,"sleep")}async wake(){e(this,kt,"m",_t).call(this),await e(this,kt,"m",Lt).call(this,"wake")}get cameraConfiguration(){return e(this,Jt,"f")}get availableCameraConfigurationTypes(){return e(this,Kt,"f")}get cameraConfigurationRanges(){return e(this,Qt,"f")}async setCameraConfiguration(t){if(ts.log({newCameraConfiguration:t}),e(this,kt,"m",Xt).call(this,t))return void ts.log("redundant camera configuration");const s=e(this,kt,"m",es).call(this,t);ts.log({setCameraConfigurationData:s});const i=this.waitForEvent("getCameraConfiguration");this.sendMessage([{type:"setCameraConfiguration",data:s.buffer}]),await i}static AssertValidCameraConfigurationType(e){ts.assertEnumWithError(e,as)}static AssertValidCameraConfigurationTypeEnum(e){ts.assertTypeWithError(e,"number"),ts.assertWithError(e in as,`invalid cameraConfigurationTypeEnum ${e}`)}parseMessage(t,s){switch(ts.log({messageType:t,dataView:s}),t){case"cameraStatus":e(this,kt,"m",Rt).call(this,s);break;case"getCameraConfiguration":case"setCameraConfiguration":e(this,kt,"m",Zt).call(this,s);break;case"cameraData":e(this,kt,"m",Ft).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}clear(){t(this,It,void 0,"f"),t(this,Bt,0,"f"),t(this,Vt,0,"f"),t(this,jt,0,"f")}}function ls(e,t,s){const i=function(e,t,s){const i=new ArrayBuffer(44+2*e.length),n=new DataView(i);fs(n,0,"RIFF"),n.setUint32(4,36+2*e.length,!0),fs(n,8,"WAVE"),fs(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,s,!0),n.setUint32(24,t,!0),n.setUint32(28,t*s*2,!0),n.setUint16(32,2*s,!0),n.setUint16(34,16,!0),fs(n,36,"data"),n.setUint32(40,2*e.length,!0);for(let t=0;t<e.length;t++)n.setInt16(44+2*t,32767*e[t],!0);return i}(e,t,s);return new Blob([i],{type:"audio/wav"})}function fs(e,t,s){for(let i=0;i<s.length;i++)e.setUint8(t+i,s.charCodeAt(i))}var gs,us,ds,ps,ms,vs,ws,ys,bs,Ss,Cs,Es,Ms,Ds,ks,Ws,Ts,Is,Rs,Us,Ls,_s,As,Fs;Wt=hs,It=new WeakMap,$t=new WeakMap,Ot=new WeakMap,Bt=new WeakMap,Nt=new WeakMap,Pt=new WeakMap,Vt=new WeakMap,qt=new WeakMap,zt=new WeakMap,jt=new WeakMap,Gt=new WeakMap,Jt=new WeakMap,Kt=new WeakMap,Qt=new WeakMap,kt=new WeakSet,Tt=function(){return this.eventDispatcher.dispatchEvent},Rt=function(t){const s=t.getUint8(0),i=is[s];e(this,kt,"m",Ut).call(this,i)},Ut=function(s){if(ts.assertEnumWithError(s,is),s==e(this,It,"f"))return void ts.log(`redundant cameraStatus ${s}`);const i=e(this,It,"f");t(this,It,s,"f"),ts.log(`updated cameraStatus to "${this.cameraStatus}"`),e(this,kt,"a",Tt).call(this,"cameraStatus",{cameraStatus:this.cameraStatus,previousCameraStatus:i}),"takingPicture"!=e(this,It,"f")&&e(this,Vt,"f")>0&&!e(this,Gt,"f")&&e(this,kt,"m",Ht).call(this)},Lt=async function(e,t){ts.assertEnumWithError(e,ss),ts.log(`sending camera command "${e}"`);const s=this.waitForEvent("cameraStatus");ts.log(`setting command "${e}"`);const i=ss.indexOf(e);this.sendMessage([{type:"cameraCommand",data:K(i)}],t),await s},_t=function(){ts.assertWithError("asleep"==e(this,It,"f"),`camera is not asleep - currently ${e(this,It,"f")}`)},At=function(){ts.assertWithError("asleep"!=e(this,It,"f"),`camera is not awake - currently ${e(this,It,"f")}`)},Ft=function(t){ts.log("parsing camera data",t),Dt(t,ns,e(this,kt,"m",xt).bind(this),null,!0)},xt=function(s,i){switch(ts.log({cameraDataType:s,dataView:i}),s){case"headerSize":t(this,$t,i.getUint16(0,!0),"f"),ts.log({headerSize:e(this,$t,"f")}),t(this,Ot,void 0,"f"),e(this,Bt,"f");break;case"header":t(this,Ot,j(e(this,Ot,"f"),i),"f"),ts.log({headerData:e(this,Ot,"f")}),t(this,Bt,e(this,Ot,"f")?.byteLength/e(this,$t,"f"),"f"),ts.log({headerProgress:e(this,Bt,"f")}),e(this,kt,"a",Tt).call(this,"cameraImageProgress",{progress:e(this,Bt,"f"),type:"header"}),1==e(this,Bt,"f")&&ts.log("finished getting header data");break;case"imageSize":t(this,Nt,i.getUint16(0,!0),"f"),ts.log({imageSize:e(this,Nt,"f")}),t(this,Pt,void 0,"f"),e(this,Vt,"f"),t(this,Gt,!1,"f");break;case"image":t(this,Pt,j(e(this,Pt,"f"),i),"f"),ts.log({imageData:e(this,Pt,"f")}),t(this,Vt,e(this,Pt,"f")?.byteLength/e(this,Nt,"f"),"f"),ts.log({imageProgress:e(this,Vt,"f")}),e(this,kt,"a",Tt).call(this,"cameraImageProgress",{progress:e(this,Vt,"f"),type:"image"}),1==e(this,Vt,"f")&&(ts.log("finished getting image data"),1==e(this,Bt,"f")&&e(this,kt,"m",Ht).call(this));break;case"footerSize":t(this,qt,i.getUint16(0,!0),"f"),ts.log({footerSize:e(this,qt,"f")}),t(this,zt,void 0,"f"),e(this,jt,"f");break;case"footer":t(this,zt,j(e(this,zt,"f"),i),"f"),ts.log({footerData:e(this,zt,"f")}),t(this,jt,e(this,zt,"f")?.byteLength/e(this,qt,"f"),"f"),ts.log({footerProgress:e(this,jt,"f")}),e(this,kt,"a",Tt).call(this,"cameraImageProgress",{progress:e(this,jt,"f"),type:"footer"}),1==e(this,jt,"f")&&(ts.log("finished getting footer data"),1==e(this,Vt,"f")&&e(this,kt,"m",Ht).call(this))}},Ht=function(){ts.log("building image...");const s=j(e(this,Ot,"f"),e(this,Pt,"f"),e(this,zt,"f"));ts.log({imageData:s});let i=new Blob([s],{type:"image/jpeg"});ts.log("created blob",i);const n=URL.createObjectURL(i);ts.log("created url",n),e(this,kt,"a",Tt).call(this,"cameraImage",{url:n,blob:i}),t(this,Gt,!0,"f")},Zt=function(s){const i={};let n=0;for(;n<s.byteLength;){const e=s.getUint8(n++),t=as[e];ts.assertWithError(t,`invalid cameraConfigurationTypeIndex ${e}`),i[t]=s.getUint16(n,!0),n+=2}ts.log({parsedCameraConfiguration:i}),t(this,Kt,Object.keys(i),"f"),t(this,Jt,i,"f"),e(this,kt,"a",Tt).call(this,"getCameraConfiguration",{cameraConfiguration:e(this,Jt,"f")})},Xt=function(e){return Object.keys(e).every((t=>this.cameraConfiguration[t]==e[t]))},Yt=function(t){ts.assertWithError(e(this,Kt,"f"),"must get initial cameraConfiguration");const s=e(this,Kt,"f")?.includes(t);return ts.assertWithError(s,`unavailable camera configuration type "${t}"`),s},es=function(t){let s=Object.keys(t);s=s.filter((t=>e(this,kt,"m",Yt).call(this,t)));const i=new DataView(new ArrayBuffer(3*s.length));return s.forEach(((e,s)=>{Wt.AssertValidCameraConfigurationType(e);const n=as.indexOf(e);i.setUint8(3*s,n);const a=t[e];i.setUint16(3*s+1,a,!0)})),ts.log({sensorConfigurationData:i}),i},W("AudioUtils",{log:!0});const xs=W("MicrophoneManager",{log:!1}),$s=["start","stop","vad"],Os=["idle","streaming","vad"],Bs=["sampleRate","bitDepth"],Ns=["8","16"],Ps=["microphoneStatus","microphoneCommand","getMicrophoneConfiguration","setMicrophoneConfiguration","microphoneData"],Vs={sampleRate:["8000","16000"],bitDepth:Ns},qs=["getMicrophoneConfiguration","microphoneStatus"],zs=[...Ps,"isRecordingMicrophone","microphoneRecording"];class js{constructor(){gs.add(this),ps.set(this,void 0),Ss.set(this,.001),Cs.set(this,0),Ds.set(this,{}),ks.set(this,void 0),Us.set(this,void 0),Ls.set(this,void 0),_s.set(this,void 0),As.set(this,!1),Fs.set(this,void 0),Q(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){xs.log("requesting required microphone information");const e=qs.map((e=>({type:e})));this.sendMessage(e,!1)}get microphoneStatus(){return e(this,ps,"f")}async start(){await e(this,gs,"m",ws).call(this,"start")}async stop(){e(this,gs,"m",ys).call(this),await e(this,gs,"m",ws).call(this,"stop")}async vad(){await e(this,gs,"m",ws).call(this,"vad")}async toggle(){switch(this.microphoneStatus){case"idle":this.start();break;case"streaming":this.stop()}}get microphoneConfiguration(){return e(this,Ds,"f")}get availableMicrophoneConfigurationTypes(){return e(this,ks,"f")}get bitDepth(){return e(this,Ds,"f").bitDepth}get sampleRate(){return e(this,Ds,"f").sampleRate}async setMicrophoneConfiguration(t){if(xs.log({newMicrophoneConfiguration:t}),e(this,gs,"m",Ts).call(this,t))return void xs.log("redundant microphone configuration");const s=e(this,gs,"m",Rs).call(this,t);xs.log({setMicrophoneConfigurationData:s});const i=this.waitForEvent("getMicrophoneConfiguration");this.sendMessage([{type:"setMicrophoneConfiguration",data:s.buffer}]),await i}static AssertValidMicrophoneConfigurationType(e){xs.assertEnumWithError(e,Bs)}static AssertValidMicrophoneConfigurationTypeEnum(e){xs.assertTypeWithError(e,"number"),xs.assertWithError(e in Bs,`invalid microphoneConfigurationTypeEnum ${e}`)}parseMessage(t,s){switch(xs.log({messageType:t,dataView:s}),t){case"microphoneStatus":e(this,gs,"m",ms).call(this,s);break;case"getMicrophoneConfiguration":case"setMicrophoneConfiguration":e(this,gs,"m",Ws).call(this,s);break;case"microphoneData":e(this,gs,"m",Es).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}get audioContext(){return e(this,Us,"f")}set audioContext(s){e(this,Us,"f")!=s?(t(this,Us,s,"f"),xs.log("assigned new audioContext",e(this,Us,"f")),e(this,Us,"f")?t(this,Cs,e(this,Us,"f").currentTime,"f"):(e(this,_s,"f")&&(e(this,_s,"f").disconnect(),t(this,_s,void 0,"f")),e(this,Ls,"f")&&(e(this,Ls,"f").disconnect(),t(this,Ls,void 0,"f")))):xs.log("redundant audioContext assignment",e(this,Us,"f"))}get gainNode(){return xs.assertWithError(e(this,Us,"f"),"audioContext assignment required for gainNode"),e(this,Ls,"f")||(xs.log("creating gainNode..."),t(this,Ls,e(this,Us,"f").createGain(),"f"),xs.log("created gainNode",e(this,Ls,"f"))),e(this,Ls,"f")}get mediaStreamDestination(){return xs.assertWithError(e(this,Us,"f"),"audioContext assignment required for mediaStreamDestination"),e(this,_s,"f")||(xs.log("creating mediaStreamDestination..."),t(this,_s,e(this,Us,"f").createMediaStreamDestination(),"f"),this.gainNode?.connect(e(this,_s,"f")),xs.log("created mediaStreamDestination",e(this,_s,"f"))),e(this,_s,"f")}get isRecording(){return e(this,As,"f")}startRecording(){this.isRecording?xs.log("already recording"):(t(this,Fs,[],"f"),t(this,As,!0,"f"),e(this,gs,"a",ds).call(this,"isRecordingMicrophone",{isRecordingMicrophone:this.isRecording}))}stopRecording(){if(this.isRecording){if(t(this,As,!1,"f"),e(this,Fs,"f")&&e(this,Fs,"f").length>0){xs.log("parsing microphone data...",e(this,Fs,"f").length);const t=j(...e(this,Fs,"f")),s=new Float32Array(t),i=ls(s,Number(this.sampleRate),1),n=URL.createObjectURL(i);e(this,gs,"a",ds).call(this,"microphoneRecording",{samples:s,sampleRate:this.sampleRate,bitDepth:this.bitDepth,blob:i,url:n})}t(this,Fs,void 0,"f"),e(this,gs,"a",ds).call(this,"isRecordingMicrophone",{isRecordingMicrophone:this.isRecording})}else xs.log("already not recording")}toggleRecording(){e(this,As,"f")?this.stopRecording():this.startRecording()}clear(){t(this,ps,void 0,"f"),t(this,Ds,{},"f"),this.isRecording&&this.stopRecording()}}var Gs;us=js,ps=new WeakMap,Ss=new WeakMap,Cs=new WeakMap,Ds=new WeakMap,ks=new WeakMap,Us=new WeakMap,Ls=new WeakMap,_s=new WeakMap,As=new WeakMap,Fs=new WeakMap,gs=new WeakSet,ds=function(){return this.eventDispatcher.dispatchEvent},ms=function(t){const s=t.getUint8(0),i=Os[s];e(this,gs,"m",vs).call(this,i)},vs=function(s){if(xs.assertEnumWithError(s,Os),s==e(this,ps,"f"))return void xs.log(`redundant microphoneStatus ${s}`);const i=e(this,ps,"f");t(this,ps,s,"f"),xs.log(`updated microphoneStatus to "${this.microphoneStatus}"`),e(this,gs,"a",ds).call(this,"microphoneStatus",{microphoneStatus:this.microphoneStatus,previousMicrophoneStatus:i})},ws=async function(e,t){xs.assertEnumWithError(e,$s),xs.log(`sending microphone command "${e}"`);const s=this.waitForEvent("microphoneStatus");xs.log(`setting command "${e}"`);const i=$s.indexOf(e);this.sendMessage([{type:"microphoneCommand",data:K(i)}],t),await s},ys=function(){xs.assertWithError("idle"!=e(this,ps,"f"),"microphone is idle")},bs=function(){xs.assertEnumWithError(this.bitDepth,Ns)},Es=function(s){e(this,gs,"m",bs).call(this),xs.log("parsing microphone data",s);const i=s.byteLength/e(this,gs,"a",Ms),n=new Float32Array(i);for(let e=0;e<i;e++){let t;switch(this.bitDepth){case"16":t=s.getInt16(2*e,!0),n[e]=t/32768;break;case"8":t=s.getInt8(e),n[e]=t/128}}if(xs.log("samples",n),e(this,As,"f")&&e(this,Fs,"f")&&e(this,Fs,"f").push(n),e(this,Us,"f")&&e(this,Ls,"f")){const s=e(this,Us,"f").createBuffer(1,n.length,Number(this.sampleRate));s.getChannelData(0).set(n);const i=e(this,Us,"f").createBufferSource();i.buffer=s;const a=s.getChannelData(0),r=Number(this.sampleRate);for(let t=0;t<e(this,Ss,"f")*r;t++)a[t]*=t/(e(this,Ss,"f")*r);for(let t=a.length-1;t>=a.length-e(this,Ss,"f")*r;t--)a[t]*=(a.length-t)/(e(this,Ss,"f")*r);i.connect(e(this,Ls,"f")),e(this,Cs,"f")<e(this,Us,"f").currentTime&&t(this,Cs,e(this,Us,"f").currentTime,"f"),i.start(e(this,Cs,"f")),t(this,Cs,e(this,Cs,"f")+s.duration,"f")}e(this,gs,"a",ds).call(this,"microphoneData",{samples:n,sampleRate:this.sampleRate,bitDepth:this.bitDepth})},Ms=function(){switch(this.bitDepth){case"8":return 1;case"16":return 2}},Ws=function(s){const i={};let n=0;for(;n<s.byteLength;){const e=s.getUint8(n++),t=Bs[e];xs.assertWithError(t,`invalid microphoneConfigurationTypeIndex ${e}`);let a=s.getUint8(n++);const r=Vs[t],o=r[a];xs.assertEnumWithError(o,r),xs.log({microphoneConfigurationType:t,value:o}),i[t]=o}xs.log({parsedMicrophoneConfiguration:i}),t(this,ks,Object.keys(i),"f"),t(this,Ds,i,"f"),e(this,gs,"a",ds).call(this,"getMicrophoneConfiguration",{microphoneConfiguration:e(this,Ds,"f")})},Ts=function(e){return Object.keys(e).every((t=>this.microphoneConfiguration[t]==e[t]))},Is=function(t){xs.assertWithError(e(this,ks,"f"),"must get initial microphoneConfiguration");const s=e(this,ks,"f")?.includes(t);return xs.assertWithError(s,`unavailable microphone configuration type "${t}"`),s},Rs=function(t){let s=Object.keys(t);s=s.filter((t=>e(this,gs,"m",Is).call(this,t)));const i=new DataView(new ArrayBuffer(2*s.length));return s.forEach(((e,s)=>{us.AssertValidMicrophoneConfigurationType(e);const n=Bs.indexOf(e);i.setUint8(2*s,n);let a=t[e];"number"==typeof a&&(a=a.toString());const r=Vs[e];xs.assertEnumWithError(a,r);const o=r.indexOf(a);i.setUint8(2*s+1,o)})),xs.log({sensorConfigurationData:i}),i};const Hs=W("SensorDataManager",{log:!1}),Js=[...ht,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation","activity","stepCounter","stepDetector","deviceOrientation","tapDetector",...yt,"camera","microphone"],Ks=[...lt,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation",...bt],Qs=["getPressurePositions","getSensorScalars","sensorData"],Zs=["getPressurePositions"],Xs=[...Qs,...Js];class Ys{constructor(){this.pressureSensorDataManager=new gt,this.motionSensorDataManager=new mt,this.barometerSensorDataManager=new Ct,Gs.set(this,new Map)}static AssertValidSensorType(e){Hs.assertEnumWithError(e,Js)}static AssertValidSensorTypeEnum(e){Hs.assertTypeWithError(e,"number"),Hs.assertWithError(e in Js,`invalid sensorTypeEnum ${e}`)}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}parseMessage(e,t){switch(Hs.log({messageType:e}),e){case"getSensorScalars":this.parseScalars(t);break;case"getPressurePositions":this.pressureSensorDataManager.parsePositions(t);break;case"sensorData":this.parseData(t);break;default:throw Error(`uncaught messageType ${e}`)}}parseScalars(t){for(let s=0;s<t.byteLength;s+=5){const i=t.getUint8(s),n=Js[i];if(!n){Hs.warn(`unknown sensorType index ${i}`);continue}const a=t.getFloat32(s+1,!0);Hs.log({sensorType:n,sensorScalar:a}),e(this,Gs,"f").set(n,a)}}parseData(e){Hs.log("sensorData",Array.from(new Uint8Array(e.buffer)));let t=0;const s=Ke(e,t);t+=2;Dt(new DataView(e.buffer,t),Js,this.parseDataCallback.bind(this),{timestamp:s})}parseDataCallback(t,s,{timestamp:i}){const n=e(this,Gs,"f").get(t)||1;let a=null;switch(t){case"pressure":a=this.pressureSensorDataManager.parseData(s,n);break;case"acceleration":case"gravity":case"linearAcceleration":case"gyroscope":case"magnetometer":a=this.motionSensorDataManager.parseVector3(s,n);break;case"gameRotation":case"rotation":a=this.motionSensorDataManager.parseQuaternion(s,n);break;case"orientation":a=this.motionSensorDataManager.parseEuler(s,n);break;case"stepCounter":a=this.motionSensorDataManager.parseStepCounter(s);break;case"stepDetector":case"tapDetector":a={};break;case"activity":a=this.motionSensorDataManager.parseActivity(s);break;case"deviceOrientation":a=this.motionSensorDataManager.parseDeviceOrientation(s);break;case"barometer":a=this.barometerSensorDataManager.parseData(s,n);break;case"camera":case"microphone":return;default:Hs.error(`uncaught sensorType "${t}"`)}Hs.assertWithError(null!=a,`no sensorData defined for sensorType "${t}"`),Hs.log({sensorType:t,sensorData:a}),this.dispatchEvent(t,{sensorType:t,[t]:a,timestamp:i}),this.dispatchEvent("sensorData",{sensorType:t,[t]:a,timestamp:i})}}var ei,ti,si,ii,ni,ai,ri,oi,ci,hi,li,fi,gi;Gs=new WeakMap;const ui=W("SensorConfigurationManager",{log:!1}),di=65535,pi=5,mi=["getSensorConfiguration","setSensorConfiguration"],vi=mi;class wi{constructor(){ei.add(this),ii.set(this,void 0),ai.set(this,{}),Q(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get configuration(){return e(this,ai,"f")}async setConfiguration(t,s){if(s&&(t=Object.assign({...this.zeroSensorConfiguration},t)),ui.log({newSensorConfiguration:t}),e(this,ei,"m",oi).call(this,t))return void ui.log("redundant sensor configuration");const i=e(this,ei,"m",fi).call(this,t);ui.log({setSensorConfigurationData:i});const n=this.waitForEvent("getSensorConfiguration");this.sendMessage([{type:"setSensorConfiguration",data:i.buffer}]),await n}static get ZeroSensorConfiguration(){return e(this,ti,"f",gi)}get zeroSensorConfiguration(){const t={};return e(this,ii,"f").forEach((e=>{t[e]=0})),t}async clearSensorConfiguration(){return this.setConfiguration(this.zeroSensorConfiguration)}parseMessage(t,s){switch(ui.log({messageType:t}),t){case"getSensorConfiguration":case"setSensorConfiguration":const i=e(this,ei,"m",ci).call(this,s);e(this,ei,"m",ri).call(this,i);break;default:throw Error(`uncaught messageType ${t}`)}}}var yi,bi,Si,Ci,Ei,Mi,Di,ki,Wi,Ti,Ii,Ri,Ui,Li,_i,Ai,Fi,xi,$i,Oi,Bi,Ni,Pi,Vi,qi,zi,ji,Gi,Hi,Ji,Ki;ti=wi,ii=new WeakMap,ai=new WeakMap,ei=new WeakSet,si=function(){return this.eventDispatcher.dispatchEvent},ni=function(t){ui.assertWithError(e(this,ii,"f"),"must get initial sensorConfiguration");const s=e(this,ii,"f")?.includes(t);return ui.log(s,`unavailable sensor type "${t}"`),s},ri=function(s){t(this,ai,s,"f"),ui.log({updatedConfiguration:e(this,ai,"f")}),e(this,ei,"a",si).call(this,"getSensorConfiguration",{sensorConfiguration:this.configuration})},oi=function(e){return Object.keys(e).every((t=>this.configuration[t]==e[t]))},ci=function(e){const s={};for(let t=0;t<e.byteLength;t+=3){const i=e.getUint8(t),n=Js[i],a=e.getUint16(t+1,!0);ui.log({sensorType:n,sensorRate:a}),n?s[n]=a:ui.warn(`unknown sensorType index ${i}`)}return ui.log({parsedSensorConfiguration:s}),t(this,ii,Object.keys(s),"f"),s},hi=function(e){ui.assertTypeWithError(e,"number"),ui.assertWithError(e>=0,`sensorRate must be 0 or greater (got ${e})`),ui.assertWithError(e<65535,`sensorRate must be 0 or greater (got ${e})`),ui.assertWithError(e%5==0,"sensorRate must be multiple of 5")},li=function(t){e(ti,ti,"m",hi).call(ti,t)},fi=function(t){let s=Object.keys(t);s=s.filter((t=>e(this,ei,"m",ni).call(this,t)));const i=new DataView(new ArrayBuffer(3*s.length));return s.forEach(((s,n)=>{Ys.AssertValidSensorType(s);const a=Js.indexOf(s);i.setUint8(3*n,a);const r=t[s];e(this,ei,"m",li).call(this,r),i.setUint16(3*n+1,r,!0)})),ui.log({sensorConfigurationData:i}),i},gi={value:{}},Js.forEach((t=>{e(ti,ti,"f",gi)[t]=0}));const Qi=W("TfliteManager",{log:!1}),Zi=["getTfliteName","setTfliteName","getTfliteTask","setTfliteTask","getTfliteSampleRate","setTfliteSampleRate","getTfliteSensorTypes","setTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","setTfliteCaptureDelay","getTfliteThreshold","setTfliteThreshold","getTfliteInferencingEnabled","setTfliteInferencingEnabled","tfliteInference"],Xi=Zi,Yi=["getTfliteName","getTfliteTask","getTfliteSampleRate","getTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","getTfliteThreshold","getTfliteInferencingEnabled"],en=["classification","regression"],tn=["pressure","linearAcceleration","gyroscope","magnetometer"];class sn{constructor(){yi.add(this),Ei.set(this,void 0),ki.set(this,void 0),Ii.set(this,void 0),Li.set(this,[]),Fi.set(this,void 0),Bi.set(this,void 0),Vi.set(this,void 0),ji.set(this,void 0),Ki.set(this,void 0),Q(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get name(){return e(this,Ei,"f")}async setName(e,t){if(Qi.assertTypeWithError(e,"string"),this.name==e)return void Qi.log(`redundant name assignment ${e}`);const s=this.waitForEvent("getTfliteName"),i=V.encode(e);this.sendMessage([{type:"setTfliteName",data:i.buffer}],t),await s}get task(){return e(this,ki,"f")}async setTask(t,s){if(e(this,yi,"m",bi).call(this,t),this.task==t)return void Qi.log(`redundant task assignment ${t}`);const i=this.waitForEvent("getTfliteTask");en.indexOf(t),this.sendMessage([{type:"setTfliteTask",data:K(commandEnum)}],s),await i}get sampleRate(){return e(this,Ii,"f")}async setSampleRate(t,s){if(Qi.assertTypeWithError(t,"number"),t-=t%5,Qi.assertWithError(t>=5,`sampleRate must be multiple of 5 greater than 0 (got ${t})`),e(this,Ii,"f")==t)return void Qi.log(`redundant sampleRate assignment ${t}`);const i=this.waitForEvent("getTfliteSampleRate"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,t,!0),this.sendMessage([{type:"setTfliteSampleRate",data:n.buffer}],s),await i}static AssertValidSensorType(e){Ys.AssertValidSensorType(e);const t=e;Qi.assertWithError(tn.includes(t),`invalid tflite sensorType "${e}"`)}get sensorTypes(){return e(this,Li,"f").slice()}async setSensorTypes(e,t){e.forEach((e=>{sn.AssertValidSensorType(e)}));const s=this.waitForEvent("getTfliteSensorTypes");var i;const n=(e=(i=e).filter(((e,t)=>i.indexOf(e)==t))).map((e=>Js.indexOf(e))).sort();Qi.log(e,n),this.sendMessage([{type:"setTfliteSensorTypes",data:Uint8Array.from(n).buffer}],t),await s}get isReady(){return e(this,Fi,"f")}get captureDelay(){return e(this,Bi,"f")}async setCaptureDelay(t,s){if(Qi.assertTypeWithError(t,"number"),e(this,Bi,"f")==t)return void Qi.log(`redundant captureDelay assignment ${t}`);const i=this.waitForEvent("getTfliteCaptureDelay"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,t,!0),this.sendMessage([{type:"setTfliteCaptureDelay",data:n.buffer}],s),await i}get threshold(){return e(this,Vi,"f")}async setThreshold(t,s){if(Qi.assertTypeWithError(t,"number"),Qi.assertWithError(t>=0,`threshold must be positive (got ${t})`),e(this,Vi,"f")==t)return void Qi.log(`redundant threshold assignment ${t}`);const i=this.waitForEvent("getTfliteThreshold"),n=new DataView(new ArrayBuffer(4));n.setFloat32(0,t,!0),this.sendMessage([{type:"setTfliteThreshold",data:n.buffer}],s),await i}get inferencingEnabled(){return e(this,ji,"f")}async setInferencingEnabled(t,s=!0){if(Qi.assertTypeWithError(t,"boolean"),!t&&!this.isReady)return;if(e(this,yi,"m",Oi).call(this),e(this,ji,"f")==t)return void Qi.log(`redundant inferencingEnabled assignment ${t}`);const i=this.waitForEvent("getTfliteInferencingEnabled");this.sendMessage([{type:"setTfliteInferencingEnabled",data:K(Number(t))}],s),await i}async toggleInferencingEnabled(){return this.setInferencingEnabled(!this.inferencingEnabled)}async enableInferencing(){this.inferencingEnabled||this.setInferencingEnabled(!0)}async disableInferencing(){this.inferencingEnabled&&this.setInferencingEnabled(!1)}parseMessage(t,s){switch(Qi.log({messageType:t}),t){case"getTfliteName":case"setTfliteName":e(this,yi,"m",Mi).call(this,s);break;case"getTfliteTask":case"setTfliteTask":e(this,yi,"m",Wi).call(this,s);break;case"getTfliteSampleRate":case"setTfliteSampleRate":e(this,yi,"m",Ri).call(this,s);break;case"getTfliteSensorTypes":case"setTfliteSensorTypes":e(this,yi,"m",_i).call(this,s);break;case"tfliteIsReady":e(this,yi,"m",xi).call(this,s);break;case"getTfliteCaptureDelay":case"setTfliteCaptureDelay":e(this,yi,"m",Ni).call(this,s);break;case"getTfliteThreshold":case"setTfliteThreshold":e(this,yi,"m",qi).call(this,s);break;case"getTfliteInferencingEnabled":case"setTfliteInferencingEnabled":e(this,yi,"m",Gi).call(this,s);break;case"tfliteInference":e(this,yi,"m",Ji).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}get configuration(){return e(this,Ki,"f")}sendConfiguration(s,i){if(s==e(this,Ki,"f"))return void Qi.log("redundant tflite configuration assignment");if(t(this,Ki,s,"f"),Qi.log("assigned new tflite configuration",this.configuration),!this.configuration)return;const{name:n,task:a,captureDelay:r,sampleRate:o,threshold:c,sensorTypes:h}=this.configuration;this.setName(n,!1),this.setTask(a,!1),null!=r&&this.setCaptureDelay(r,!1),this.setSampleRate(o,!1),null!=c&&this.setThreshold(c,!1),this.setSensorTypes(h,i)}clear(){t(this,Ki,void 0,"f"),t(this,ji,!1,"f"),t(this,Li,[],"f"),t(this,Ii,0,"f"),t(this,Fi,!1,"f")}requestRequiredInformation(){Qi.log("requesting required tflite information");const e=Yi.map((e=>({type:e})));this.sendMessage(e,!1)}}var nn,an,rn,on,cn;Ei=new WeakMap,ki=new WeakMap,Ii=new WeakMap,Li=new WeakMap,Fi=new WeakMap,Bi=new WeakMap,Vi=new WeakMap,ji=new WeakMap,Ki=new WeakMap,yi=new WeakSet,bi=function(e){Qi.assertEnumWithError(e,en)},Si=function(e){Qi.assertWithError(e in en,`invalid taskEnum ${e}`)},Ci=function(){return this.eventDispatcher.dispatchEvent},Mi=function(t){Qi.log("parseName",t);const s=q.decode(t.buffer);e(this,yi,"m",Di).call(this,s)},Di=function(s){Qi.log({name:s}),t(this,Ei,s,"f"),e(this,yi,"a",Ci).call(this,"getTfliteName",{tfliteName:s})},Wi=function(t){Qi.log("parseTask",t);const s=t.getUint8(0);e(this,yi,"m",Si).call(this,s);const i=en[s];e(this,yi,"m",Ti).call(this,i)},Ti=function(s){Qi.log({task:s}),t(this,ki,s,"f"),e(this,yi,"a",Ci).call(this,"getTfliteTask",{tfliteTask:s})},Ri=function(t){Qi.log("parseSampleRate",t);const s=t.getUint16(0,!0);e(this,yi,"m",Ui).call(this,s)},Ui=function(s){Qi.log({sampleRate:s}),t(this,Ii,s,"f"),e(this,yi,"a",Ci).call(this,"getTfliteSampleRate",{tfliteSampleRate:s})},_i=function(t){Qi.log("parseSensorTypes",t);const s=[];for(let e=0;e<t.byteLength;e++){const i=t.getUint8(e),n=Js[i];n?tn.includes(n)?s.push(n):Qi.error(`invalid tfliteSensorType ${n}`):Qi.error(`invalid sensorTypeEnum ${i}`)}e(this,yi,"m",Ai).call(this,s)},Ai=function(s){Qi.log({sensorTypes:s}),t(this,Li,s,"f"),e(this,yi,"a",Ci).call(this,"getTfliteSensorTypes",{tfliteSensorTypes:s})},xi=function(t){Qi.log("parseIsReady",t);const s=Boolean(t.getUint8(0));e(this,yi,"m",$i).call(this,s)},$i=function(s){Qi.log({isReady:s}),t(this,Fi,s,"f"),e(this,yi,"a",Ci).call(this,"tfliteIsReady",{tfliteIsReady:s})},Oi=function(){Qi.assertWithError(this.isReady,"tflite is not ready")},Ni=function(t){Qi.log("parseCaptureDelay",t);const s=t.getUint16(0,!0);e(this,yi,"m",Pi).call(this,s)},Pi=function(s){Qi.log({captureDelay:s}),t(this,Bi,s,"f"),e(this,yi,"a",Ci).call(this,"getTfliteCaptureDelay",{tfliteCaptureDelay:s})},qi=function(t){Qi.log("parseThreshold",t);const s=t.getFloat32(0,!0);e(this,yi,"m",zi).call(this,s)},zi=function(s){Qi.log({threshold:s}),t(this,Vi,s,"f"),e(this,yi,"a",Ci).call(this,"getTfliteThreshold",{tfliteThreshold:s})},Gi=function(t){Qi.log("parseInferencingEnabled",t);const s=Boolean(t.getUint8(0));e(this,yi,"m",Hi).call(this,s)},Hi=function(s){Qi.log({inferencingEnabled:s}),t(this,ji,s,"f"),e(this,yi,"a",Ci).call(this,"getTfliteInferencingEnabled",{tfliteInferencingEnabled:s})},Ji=function(t){Qi.log("parseInference",t);const s=Ke(t,0);Qi.log({timestamp:s});const i=[];for(let e=0,s=2;s<t.byteLength;e++,s+=4){const e=t.getFloat32(s,!0);i.push(e)}Qi.log("values",i);const n={timestamp:s,values:i};if("classification"==this.task){let t=0,s=0;if(i.forEach(((e,i)=>{e>t&&(t=e,s=i)})),Qi.log({maxIndex:s,maxValue:t}),n.maxIndex=s,n.maxValue=t,e(this,Ki,"f")?.classes){const{classes:t}=e(this,Ki,"f");n.maxClass=t[s],n.classValues={},i.forEach(((e,s)=>{const i=t[s];n.classValues[i]=e}))}}e(this,yi,"a",Ci).call(this,"tfliteInference",{tfliteInference:n})};const hn=W("DeviceInformationManager",{log:!1}),ln=["manufacturerName","modelNumber","hardwareRevision","firmwareRevision","softwareRevision","pnpId","serialNumber"],fn=[...ln,"deviceInformation"];class gn{constructor(){nn.add(this),rn.set(this,{})}get information(){return e(this,rn,"f")}clear(){t(this,rn,{},"f")}parseMessage(t,s){switch(hn.log({messageType:t}),t){case"manufacturerName":const i=q.decode(s.buffer);hn.log({manufacturerName:i}),e(this,nn,"m",cn).call(this,{manufacturerName:i});break;case"modelNumber":const n=q.decode(s.buffer);hn.log({modelNumber:n}),e(this,nn,"m",cn).call(this,{modelNumber:n});break;case"softwareRevision":const a=q.decode(s.buffer);hn.log({softwareRevision:a}),e(this,nn,"m",cn).call(this,{softwareRevision:a});break;case"hardwareRevision":const r=q.decode(s.buffer);hn.log({hardwareRevision:r}),e(this,nn,"m",cn).call(this,{hardwareRevision:r});break;case"firmwareRevision":const o=q.decode(s.buffer);hn.log({firmwareRevision:o}),e(this,nn,"m",cn).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===s.getUint8(0)?"Bluetooth":"USB",productId:s.getUint16(3,!0),productVersion:s.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=s.getUint16(1,!0)),hn.log({pnpId:c}),e(this,nn,"m",cn).call(this,{pnpId:c});break;case"serialNumber":const h=q.decode(s.buffer);hn.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${t}`)}}}var un,dn,pn,mn,vn,wn,yn,bn,Sn,Cn,En,Mn,Dn,kn,Wn,Tn,In,Rn;rn=new WeakMap,nn=new WeakSet,an=function(){return this.eventDispatcher.dispatchEvent},on=function(){return ln.filter((e=>"serialNumber"!=e)).every((t=>t in e(this,rn,"f")))},cn=function(t){hn.log({partialDeviceInformation:t});Object.keys(t).forEach((s=>{e(this,nn,"a",an).call(this,s,{[s]:t[s]})})),Object.assign(e(this,rn,"f"),t),hn.log({deviceInformation:e(this,rn,"f")}),e(this,nn,"a",on)&&(hn.log("completed deviceInformation"),e(this,nn,"a",an).call(this,"deviceInformation",{deviceInformation:this.information}))};const Un=W("InformationManager",{log:!1}),Ln=["leftInsole","rightInsole","leftGlove","rightGlove","glasses","generic"],_n=["left","right"],An=2,Fn=30,xn=["isCharging","getBatteryCurrent","getMtu","getId","getName","setName","getType","setType","getCurrentTime","setCurrentTime"],$n=xn;class On{constructor(){un.add(this),pn.set(this,!1),vn.set(this,void 0),yn.set(this,void 0),Sn.set(this,""),Cn.set(this,void 0),kn.set(this,0),Tn.set(this,!1),Q(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}get isCharging(){return e(this,pn,"f")}get batteryCurrent(){return e(this,vn,"f")}async getBatteryCurrent(){Un.log("getting battery current...");const e=this.waitForEvent("getBatteryCurrent");this.sendMessage([{type:"getBatteryCurrent"}]),await e}get id(){return e(this,yn,"f")}get name(){return e(this,Sn,"f")}updateName(s){Un.assertTypeWithError(s,"string"),t(this,Sn,s,"f"),Un.log({updatedName:e(this,Sn,"f")}),e(this,un,"a",dn).call(this,"getName",{name:e(this,Sn,"f")})}async setName(e){Un.assertTypeWithError(e,"string"),Un.assertRangeWithError("newName",e.length,2,30);const t=V.encode(e);Un.log({setNameData:t});const s=this.waitForEvent("getName");this.sendMessage([{type:"setName",data:t.buffer}]),await s}get type(){return e(this,Cn,"f")}get typeEnum(){return Ln.indexOf(this.type)}updateType(s){e(this,un,"m",En).call(this,s),s!=this.type?(t(this,Cn,s,"f"),Un.log({updatedType:e(this,Cn,"f")}),e(this,un,"a",dn).call(this,"getType",{type:e(this,Cn,"f")})):Un.log("redundant type assignment")}async setType(t){e(this,un,"m",En).call(this,t);const s=Ln.indexOf(t);e(this,un,"m",Dn).call(this,s)}get isInsole(){switch(this.type){case"leftInsole":case"rightInsole":return!0;default:return!1}}get isGlove(){switch(this.type){case"leftGlove":case"rightGlove":return!0;default:return!1}}get side(){switch(this.type){case"leftInsole":case"leftGlove":default:return"left";case"rightInsole":case"rightGlove":return"right"}}get mtu(){return e(this,kn,"f")}get isCurrentTimeSet(){return e(this,Tn,"f")}parseMessage(t,s){switch(Un.log({messageType:t}),t){case"isCharging":const i=Boolean(s.getUint8(0));Un.log({isCharging:i}),e(this,un,"m",mn).call(this,i);break;case"getBatteryCurrent":const n=s.getFloat32(0,!0);Un.log({batteryCurrent:n}),e(this,un,"m",wn).call(this,n);break;case"getId":const a=q.decode(s.buffer);Un.log({id:a}),e(this,un,"m",bn).call(this,a);break;case"getName":case"setName":const r=q.decode(s.buffer);Un.log({name:r}),this.updateName(r);break;case"getType":case"setType":const o=s.getUint8(0),c=Ln[o];Un.log({typeEnum:o,type:c}),this.updateType(c);break;case"getMtu":let h=s.getUint16(0,!0);"webSocket"!=this.connectionType&&"udp"!=this.connectionType&&(h=Math.min(h,512)),Un.log({mtu:h}),e(this,un,"m",Wn).call(this,h);break;case"getCurrentTime":case"setCurrentTime":const l=Number(s.getBigUint64(0,!0));e(this,un,"m",In).call(this,l);break;default:throw Error(`uncaught messageType ${t}`)}}clear(){t(this,Tn,!1,"f")}}pn=new WeakMap,vn=new WeakMap,yn=new WeakMap,Sn=new WeakMap,Cn=new WeakMap,kn=new WeakMap,Tn=new WeakMap,un=new WeakSet,dn=function(){return this.eventDispatcher.dispatchEvent},mn=function(s){Un.assertTypeWithError(s,"boolean"),t(this,pn,s,"f"),Un.log({isCharging:e(this,pn,"f")}),e(this,un,"a",dn).call(this,"isCharging",{isCharging:e(this,pn,"f")})},wn=function(s){Un.assertTypeWithError(s,"number"),t(this,vn,s,"f"),Un.log({batteryCurrent:e(this,vn,"f")}),e(this,un,"a",dn).call(this,"getBatteryCurrent",{batteryCurrent:e(this,vn,"f")})},bn=function(s){Un.assertTypeWithError(s,"string"),t(this,yn,s,"f"),Un.log({id:e(this,yn,"f")}),e(this,un,"a",dn).call(this,"getId",{id:e(this,yn,"f")})},En=function(e){Un.assertEnumWithError(e,Ln)},Mn=function(e){Un.assertTypeWithError(e,"number"),Un.assertWithError(e in Ln,`invalid typeEnum ${e}`)},Dn=async function(t){e(this,un,"m",Mn).call(this,t);const s=K(t);Un.log({setTypeData:s});const i=this.waitForEvent("getType");this.sendMessage([{type:"setType",data:s}]),await i},Wn=function(s){Un.assertTypeWithError(s,"number"),e(this,kn,"f")!=s?(t(this,kn,s,"f"),e(this,un,"a",dn).call(this,"getMtu",{mtu:e(this,kn,"f")})):Un.log("redundant mtu assignment",s)},In=function(s){Un.log({currentTime:s}),t(this,Tn,0!=s||Math.abs(Date.now()-s)<Je,"f"),e(this,Tn,"f")||e(this,un,"m",Rn).call(this,!1)},Rn=async function(e){Un.log("setting current time...");const t=new DataView(new ArrayBuffer(8));t.setBigUint64(0,BigInt(Date.now()),!0);const s=this.waitForEvent("getCurrentTime");this.sendMessage([{type:"setCurrentTime",data:t.buffer}],e),await s};const Bn=["none","strongClick100","strongClick60","strongClick30","sharpClick100","sharpClick60","sharpClick30","softBump100","softBump60","softBump30","doubleClick100","doubleClick60","tripleClick100","softFuzz60","strongBuzz100","alert750ms","alert1000ms","strongClick1_100","strongClick2_80","strongClick3_60","strongClick4_30","mediumClick100","mediumClick80","mediumClick60","sharpTick100","sharpTick80","sharpTick60","shortDoubleClickStrong100","shortDoubleClickStrong80","shortDoubleClickStrong60","shortDoubleClickStrong30","shortDoubleClickMedium100","shortDoubleClickMedium80","shortDoubleClickMedium60","shortDoubleSharpTick100","shortDoubleSharpTick80","shortDoubleSharpTick60","longDoubleSharpClickStrong100","longDoubleSharpClickStrong80","longDoubleSharpClickStrong60","longDoubleSharpClickStrong30","longDoubleSharpClickMedium100","longDoubleSharpClickMedium80","longDoubleSharpClickMedium60","longDoubleSharpTick100","longDoubleSharpTick80","longDoubleSharpTick60","buzz100","buzz80","buzz60","buzz40","buzz20","pulsingStrong100","pulsingStrong60","pulsingMedium100","pulsingMedium60","pulsingSharp100","pulsingSharp60","transitionClick100","transitionClick80","transitionClick60","transitionClick40","transitionClick20","transitionClick10","transitionHum100","transitionHum80","transitionHum60","transitionHum40","transitionHum20","transitionHum10","transitionRampDownLongSmooth2_100","transitionRampDownLongSmooth1_100","transitionRampDownMediumSmooth1_100","transitionRampDownMediumSmooth2_100","transitionRampDownShortSmooth1_100","transitionRampDownShortSmooth2_100","transitionRampDownLongSharp1_100","transitionRampDownLongSharp2_100","transitionRampDownMediumSharp1_100","transitionRampDownMediumSharp2_100","transitionRampDownShortSharp1_100","transitionRampDownShortSharp2_100","transitionRampUpLongSmooth1_100","transitionRampUpLongSmooth2_100","transitionRampUpMediumSmooth1_100","transitionRampUpMediumSmooth2_100","transitionRampUpShortSmooth1_100","transitionRampUpShortSmooth2_100","transitionRampUpLongSharp1_100","transitionRampUpLongSharp2_100","transitionRampUpMediumSharp1_100","transitionRampUpMediumSharp2_100","transitionRampUpShortSharp1_100","transitionRampUpShortSharp2_100","transitionRampDownLongSmooth1_50","transitionRampDownLongSmooth2_50","transitionRampDownMediumSmooth1_50","transitionRampDownMediumSmooth2_50","transitionRampDownShortSmooth1_50","transitionRampDownShortSmooth2_50","transitionRampDownLongSharp1_50","transitionRampDownLongSharp2_50","transitionRampDownMediumSharp1_50","transitionRampDownMediumSharp2_50","transitionRampDownShortSharp1_50","transitionRampDownShortSharp2_50","transitionRampUpLongSmooth1_50","transitionRampUpLongSmooth2_50","transitionRampUpMediumSmooth1_50","transitionRampUpMediumSmooth2_50","transitionRampUpShortSmooth1_50","transitionRampUpShortSmooth2_50","transitionRampUpLongSharp1_50","transitionRampUpLongSharp2_50","transitionRampUpMediumSharp1_50","transitionRampUpMediumSharp2_50","transitionRampUpShortSharp1_50","transitionRampUpShortSharp2_50","longBuzz100","smoothHum50","smoothHum40","smoothHum30","smoothHum20","smoothHum10"];var Nn,Pn,Vn,qn,zn,jn,Gn,Hn,Jn,Kn,Qn,Zn,Xn,Yn,ea,ta,sa,ia,na;const aa=W("VibrationManager",{log:!1}),ra=["front","rear"],oa=["waveformEffect","waveform"],ca=["getVibrationLocations","triggerVibration"],ha=ca,la=8,fa=2550,ga=1270,ua=3,da=20,pa=6;class ma{constructor(){Nn.add(this),ia.set(this,[]),Q(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}async triggerVibration(t,s=!0){let i;t.forEach((t=>{const{type:s}=t;let n,{locations:a}=t;switch(a=a||this.vibrationLocations.slice(),a=a.filter((e=>this.vibrationLocations.includes(e))),s){case"waveformEffect":{const{segments:s,loopCount:i}=t;n=e(this,Nn,"m",Yn).call(this,a,s,i)}break;case"waveform":{const{segments:s}=t;n=e(this,Nn,"m",ea).call(this,a,s)}break;default:throw Error(`invalid vibration type "${s}"`)}aa.log({type:s,arrayBuffer:n}),i=j(i,n)})),await this.sendMessage([{type:"triggerVibration",data:i}],s)}get vibrationLocations(){return e(this,ia,"f")}parseMessage(t,s){if(aa.log({messageType:t}),"getVibrationLocations"!==t)throw Error(`uncaught messageType ${t}`);{const t=Array.from(new Uint8Array(s.buffer)).map((e=>ra[e])).filter(Boolean);e(this,Nn,"m",na).call(this,t)}}}var va,wa,ya,ba,Sa,Ca,Ea,Ma,Da,ka,Wa,Ta,Ia,Ra,Ua,La,_a;ia=new WeakMap,Nn=new WeakSet,Pn=function(){return this.eventDispatcher.dispatchEvent},Vn=function(e){aa.assertTypeWithError(e,"string"),aa.assertWithError(ra.includes(e),`invalid location "${e}"`)},qn=function(t){e(this,Nn,"m",jn).call(this,t),t.forEach((t=>{e(this,Nn,"m",Vn).call(this,t)}))},zn=function(t){e(this,Nn,"m",qn).call(this,t);let s=0;return t.forEach((e=>{const t=ra.indexOf(e);s|=1<<t})),aa.log({locationsBitmask:s}),aa.assertWithError(s>0,"locationsBitmask must not be zero"),s},jn=function(e){aa.assertWithError(Array.isArray(e),"passed non-array"),aa.assertWithError(e.length>0,"passed empty array")},Gn=function(e){aa.assertWithError(Bn.includes(e),`invalid waveformEffect "${e}"`)},Hn=function(t){if(null!=t.effect){const s=t.effect;e(this,Nn,"m",Gn).call(this,s)}else{if(null==t.delay)throw Error("no effect or delay found in waveformEffectSegment");{const{delay:e}=t;aa.assertWithError(e>=0,`delay must be 0ms or greater (got ${e})`),aa.assertWithError(e<=ga,`delay must be 1270ms or less (got ${e})`)}}if(null!=t.loopCount){const{loopCount:s}=t;e(this,Nn,"m",Jn).call(this,s)}},Jn=function(e){aa.assertTypeWithError(e,"number"),aa.assertWithError(e>=0,`waveformEffectSegmentLoopCount must be 0 or greater (got ${e})`),aa.assertWithError(e<=3,`waveformEffectSegmentLoopCount must be 3 or fewer (got ${e})`)},Kn=function(t){e(this,Nn,"m",jn).call(this,t),aa.assertWithError(t.length<=8,`must have 8 waveformEffectSegments or fewer (got ${t.length})`),t.forEach((t=>{e(this,Nn,"m",Hn).call(this,t)}))},Qn=function(e){aa.assertTypeWithError(e,"number"),aa.assertWithError(e>=0,`waveformEffectSequenceLoopCount must be 0 or greater (got ${e})`),aa.assertWithError(e<=6,`waveformEffectSequenceLoopCount must be 6 or fewer (got ${e})`)},Zn=function(e){aa.assertTypeWithError(e.amplitude,"number"),aa.assertWithError(e.amplitude>=0,`amplitude must be 0 or greater (got ${e.amplitude})`),aa.assertWithError(e.amplitude<=1,`amplitude must be 1 or less (got ${e.amplitude})`),aa.assertTypeWithError(e.duration,"number"),aa.assertWithError(e.duration>0,`duration must be greater than 0ms (got ${e.duration}ms)`),aa.assertWithError(e.duration<=fa,`duration must be 2550ms or less (got ${e.duration}ms)`)},Xn=function(t){e(this,Nn,"m",jn).call(this,t),aa.assertWithError(t.length<=20,`must have 20 waveformSegments or fewer (got ${t.length})`),t.forEach((t=>{e(this,Nn,"m",Zn).call(this,t)}))},Yn=function(t,s,i=0){e(this,Nn,"m",Kn).call(this,s),e(this,Nn,"m",Qn).call(this,i);let n=[],a=0;const r=s.some((e=>{const{loopCount:t}=e;return null!=t&&t>0}))||0!=i;for(let e=0;e<s.length||r&&e<8;e++){const t=s[e]||{effect:"none"};if(null!=t.effect){const e=t.effect;n[a++]=Bn.indexOf(e)}else{if(null==t.delay)throw Error("invalid waveformEffectSegment");{const{delay:e}=t;n[a++]=128|Math.floor(e/10)}}}const o=0!=i;for(let e=0;e<s.length||o&&e<8;e++){const t=s[e]?.loopCount||0;0!=e&&4!=e||(n[a]=0);const i=e%4*2;n[a]|=t<<i,3!=e&&7!=e||a++}0!=i&&(n[a++]=i);const c=new DataView(Uint8Array.from(n).buffer);return aa.log({dataArray:n,dataView:c}),e(this,Nn,"m",sa).call(this,t,"waveformEffect",c)},ea=function(t,s){e(this,Nn,"m",Xn).call(this,s);const i=new DataView(new ArrayBuffer(2*s.length));return s.forEach(((e,t)=>{i.setUint8(2*t,Math.floor(127*e.amplitude)),i.setUint8(2*t+1,Math.floor(e.duration/10))})),aa.log({dataView:i}),e(this,Nn,"m",sa).call(this,t,"waveform",i)},ta=function(e){aa.assertTypeWithError(e,"string"),aa.assertWithError(oa.includes(e),`invalid vibrationType "${e}"`)},sa=function(t,s,i){aa.assertWithError(i?.byteLength>0,"no data received");const n=e(this,Nn,"m",zn).call(this,t);e(this,Nn,"m",ta).call(this,s);const a=oa.indexOf(s);aa.log({locationsBitmask:n,vibrationTypeIndex:a,dataView:i});const r=j(n,a,i.byteLength,i);return aa.log({data:r}),r},na=function(s){t(this,ia,s,"f"),aa.log("vibrationLocations",s),e(this,Nn,"a",Pn).call(this,"getVibrationLocations",{vibrationLocations:e(this,ia,"f")})};const Aa=W("WifiManager",{log:!1}),Fa=1,xa=32,$a=8,Oa=64,Ba=["isWifiAvailable","getWifiSSID","setWifiSSID","getWifiPassword","setWifiPassword","getWifiConnectionEnabled","setWifiConnectionEnabled","isWifiConnected","ipAddress","isWifiSecure"],Na=["getWifiSSID","getWifiPassword","getWifiConnectionEnabled","isWifiConnected","ipAddress","isWifiSecure"],Pa=Ba;class Va{constructor(){va.add(this),ya.set(this,!1),Ca.set(this,""),Ma.set(this,""),ka.set(this,void 0),Ta.set(this,!1),Ra.set(this,void 0),La.set(this,!1),Q(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Aa.log("requesting required wifi information");const e=Na.map((e=>({type:e})));this.sendMessage(e,!1)}get isWifiAvailable(){return e(this,ya,"f")}get wifiSSID(){return e(this,Ca,"f")}async setWifiSSID(t){if(e(this,va,"m",Sa).call(this),e(this,ka,"f"))return void Aa.error("cannot change ssid while wifi connection is enabled");Aa.assertTypeWithError(t,"string"),Aa.assertRangeWithError("wifiSSID",t.length,1,32);const s=V.encode(t);Aa.log({setWifiSSIDData:s});const i=this.waitForEvent("getWifiSSID");this.sendMessage([{type:"setWifiSSID",data:s.buffer}]),await i}get wifiPassword(){return e(this,Ma,"f")}async setWifiPassword(t){if(e(this,va,"m",Sa).call(this),e(this,ka,"f"))return void Aa.error("cannot change password while wifi connection is enabled");Aa.assertTypeWithError(t,"string"),t.length>0&&Aa.assertRangeWithError("wifiPassword",t.length,8,64);const s=V.encode(t);Aa.log({setWifiPasswordData:s});const i=this.waitForEvent("getWifiPassword");this.sendMessage([{type:"setWifiPassword",data:s.buffer}]),await i}get wifiConnectionEnabled(){return e(this,ka,"f")}async setWifiConnectionEnabled(t,s=!0){if(e(this,va,"m",Sa).call(this),Aa.assertTypeWithError(t,"boolean"),e(this,ka,"f")==t)return void Aa.log(`redundant wifiConnectionEnabled assignment ${t}`);const i=this.waitForEvent("getWifiConnectionEnabled");this.sendMessage([{type:"setWifiConnectionEnabled",data:K(Number(t))}],s),await i}async toggleWifiConnection(){return this.setWifiConnectionEnabled(!this.wifiConnectionEnabled)}async enableWifiConnection(){return this.setWifiConnectionEnabled(!0)}async disableWifiConnection(){return this.setWifiConnectionEnabled(!1)}get isWifiConnected(){return e(this,Ta,"f")}get ipAddress(){return e(this,Ra,"f")}get isWifiSecure(){return e(this,La,"f")}parseMessage(t,s){switch(Aa.log({messageType:t}),t){case"isWifiAvailable":const i=Boolean(s.getUint8(0));Aa.log({isWifiAvailable:i}),e(this,va,"m",ba).call(this,i);break;case"getWifiSSID":case"setWifiSSID":const n=q.decode(s.buffer);Aa.log({ssid:n}),e(this,va,"m",Ea).call(this,n);break;case"getWifiPassword":case"setWifiPassword":const a=q.decode(s.buffer);Aa.log({password:a}),e(this,va,"m",Da).call(this,a);break;case"getWifiConnectionEnabled":case"setWifiConnectionEnabled":const r=Boolean(s.getUint8(0));Aa.log({enableWifiConnection:r}),e(this,va,"m",Wa).call(this,r);break;case"isWifiConnected":const o=Boolean(s.getUint8(0));Aa.log({isWifiConnected:o}),e(this,va,"m",Ia).call(this,o);break;case"ipAddress":let c;4==s.byteLength&&(c=new Uint8Array(s.buffer.slice(0,4)).join(".")),Aa.log({ipAddress:c}),e(this,va,"m",Ua).call(this,c);break;case"isWifiSecure":const h=Boolean(s.getUint8(0));Aa.log({isWifiSecure:h}),e(this,va,"m",_a).call(this,h);break;default:throw Error(`uncaught messageType ${t}`)}}clear(){t(this,Ca,"","f"),t(this,Ma,"","f"),t(this,Ra,"","f"),t(this,Ta,!1,"f"),t(this,ya,!1,"f")}}ya=new WeakMap,Ca=new WeakMap,Ma=new WeakMap,ka=new WeakMap,Ta=new WeakMap,Ra=new WeakMap,La=new WeakMap,va=new WeakSet,wa=function(){return this.eventDispatcher.dispatchEvent},ba=function(s){Aa.assertTypeWithError(s,"boolean"),t(this,ya,s,"f"),Aa.log({isWifiAvailable:e(this,ya,"f")}),e(this,va,"a",wa).call(this,"isWifiAvailable",{isWifiAvailable:e(this,ya,"f")})},Sa=function(){Aa.assertWithError(e(this,ya,"f"),"wifi is not available")},Ea=function(s){Aa.assertTypeWithError(s,"string"),t(this,Ca,s,"f"),Aa.log({wifiSSID:e(this,Ca,"f")}),e(this,va,"a",wa).call(this,"getWifiSSID",{wifiSSID:e(this,Ca,"f")})},Da=function(s){Aa.assertTypeWithError(s,"string"),t(this,Ma,s,"f"),Aa.log({wifiPassword:e(this,Ma,"f")}),e(this,va,"a",wa).call(this,"getWifiPassword",{wifiPassword:e(this,Ma,"f")})},Wa=function(s){Aa.log({wifiConnectionEnabled:s}),t(this,ka,s,"f"),e(this,va,"a",wa).call(this,"getWifiConnectionEnabled",{wifiConnectionEnabled:s})},Ia=function(s){Aa.assertTypeWithError(s,"boolean"),t(this,Ta,s,"f"),Aa.log({isWifiConnected:e(this,Ta,"f")}),e(this,va,"a",wa).call(this,"isWifiConnected",{isWifiConnected:e(this,Ta,"f")})},Ua=function(s){t(this,Ra,s,"f"),Aa.log({ipAddress:e(this,Ra,"f")}),e(this,va,"a",wa).call(this,"ipAddress",{ipAddress:e(this,Ra,"f")})},_a=function(s){Aa.assertTypeWithError(s,"boolean"),t(this,La,s,"f"),Aa.log({isWifiSecure:e(this,La,"f")}),e(this,va,"a",wa).call(this,"isWifiSecure",{isWifiSecure:e(this,La,"f")})};const qa=W("ColorUtils",{log:!0});var za,ja,Ga,Ha,Ja,Ka,Qa,Za,Xa,Ya,er,tr,sr,ir,nr,ar,rr,or,cr,hr,lr,fr,gr,ur,dr,pr,mr,vr,wr,yr,br,Sr,Cr;const Er=W("DisplayManager",{log:!0}),Mr=["sleep","wake"],Dr=["awake","asleep"],kr=["type","width","height","pixelDepth"],Wr=["veryLow","low","medium","high","veryHigh"],Tr=["isDisplayAvailable","displayStatus","displayInformation","displayCommand","getDisplayBrightness","setDisplayBrightness","displayContextCommands"],Ir={type:["none","monocularLeft","monocularRight","binocular"],pixelDepth:["1","2","4"]},Rr=["show","clear","setColor","setColorOpacity","setOpacity","saveContext","restoreContext","selectFillColor","selectLineColor","setLineWidth","clearRect","drawRect","drawRoundRect","drawCircle","drawEllipse","selectSpriteSheet","sprite","selectFont","drawText"],Ur=["isDisplayAvailable","displayInformation","displayStatus","getDisplayBrightness"],Lr=[...Tr];class _r{constructor(){za.add(this),Ga.set(this,!1),Ka.set(this,void 0),tr.set(this,void 0),ir.set(this,void 0),or.set(this,[]),Cr.set(this,void 0),Q(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Er.log("requesting required display information");const e=Ur.map((e=>({type:e})));this.sendMessage(e,!1)}get isDisplayAvailable(){return e(this,Ga,"f")}get displayStatus(){return e(this,Ka,"f")}get isDisplayAwake(){return"awake"==e(this,Ka,"f")}async wake(){e(this,za,"m",er).call(this),await e(this,za,"m",Xa).call(this,"wake")}async sleep(){e(this,za,"m",Ya).call(this),await e(this,za,"m",Xa).call(this,"sleep")}async toggle(){switch(this.displayStatus){case"asleep":this.wake();break;case"awake":this.sleep()}}get numberOfColors(){return 2**Number(this.pixelDepth)}get displayInformation(){return e(this,tr,"f")}get pixelDepth(){return e(this,tr,"f")?.pixelDepth}get width(){return e(this,tr,"f")?.width}get height(){return e(this,tr,"f")?.width}get size(){return{width:this.width,height:this.height}}get type(){return e(this,tr,"f")?.type}get displayBrightness(){return e(this,ir,"f")}async setDisplayBrightness(t){e(this,za,"m",Ha).call(this),e(this,za,"m",ar).call(this,t);const s=K(Wr.indexOf(t)),i=this.waitForEvent("getDisplayBrightness");this.sendMessage([{type:"setDisplayBrightness",data:s}]),await i}showDisplay(t=!0){e(this,za,"m",cr).call(this,"show",void 0,t)}clearDisplay(t=!0){e(this,za,"m",cr).call(this,"clear",void 0,t)}setColor(t,s,i){var n;"string"==typeof s&&(3==(n=(n=s).replace(/^#/,"")).length&&(n=n.split("").map((e=>e+e)).join("")),qa.assertWithError(6==n.length,`hex length must be 6 (got ${n.length})`),s={r:parseInt(n.substring(0,2),16),g:parseInt(n.substring(2,4),16),b:parseInt(n.substring(4,6),16)}),Er.log(`setting color #${t}`,s),e(this,za,"m",gr).call(this,t),e(this,za,"m",lr).call(this,s);const a=new DataView(new ArrayBuffer(4));a.setUint8(0,t),a.setUint8(1,s.r),a.setUint8(2,s.g),a.setUint8(3,s.b),e(this,za,"m",cr).call(this,"setColor",a.buffer,i)}setColorOpacity(t,s,i){e(this,za,"m",gr).call(this,t),e(this,za,"m",ur).call(this,s);const n=new DataView(new ArrayBuffer(2));n.setUint8(0,t),n.setUint8(1,255*s),e(this,za,"m",cr).call(this,"setColorOpacity",n.buffer,i)}setOpacity(t,s){e(this,za,"m",ur).call(this,t),e(this,za,"m",cr).call(this,"setOpacity",K(Math.round(255*t)),s)}saveContext(t){e(this,za,"m",cr).call(this,"saveContext",void 0,t)}restoreContext(t){e(this,za,"m",cr).call(this,"restoreContext",void 0,t)}selectFillColor(t,s){e(this,za,"m",gr).call(this,t),e(this,za,"m",cr).call(this,"selectFillColor",K(t),s)}selectLineColor(t,s){e(this,za,"m",gr).call(this,t),e(this,za,"m",cr).call(this,"selectLineColor",K(t),s)}setLineWidth(t,s){e(this,za,"m",dr).call(this,t);const i=new DataView(new ArrayBuffer(2));i.setUint16(0,t,!0),e(this,za,"m",cr).call(this,"setLineWidth",i.buffer,s)}clearRect(t,s,i,n,a){const{x:r,y:o,width:c,height:h}=e(this,za,"m",yr).call(this,t,s,i,n),l=new DataView(new ArrayBuffer(8));l.setUint16(0,r,!0),l.setUint16(2,o,!0),l.setUint16(4,c,!0),l.setUint16(6,h,!0),e(this,za,"m",cr).call(this,"clearRect",l.buffer,a)}drawRect(t,s,i,n,a){const{x:r,y:o,width:c,height:h}=e(this,za,"m",yr).call(this,t,s,i,n),l=new DataView(new ArrayBuffer(8));l.setUint16(0,r,!0),l.setUint16(2,o,!0),l.setUint16(4,c,!0),l.setUint16(6,h,!0),Er.log("drawRect data",l),e(this,za,"m",cr).call(this,"drawRect",l.buffer,a)}drawRoundRect(t,s,i,n,a,r){const{x:o,y:c,width:h,height:l}=e(this,za,"m",yr).call(this,t,s,i,n),f=new DataView(new ArrayBuffer(9));f.setUint16(0,o,!0),f.setUint16(2,c,!0),f.setUint16(4,h,!0),f.setUint16(6,l,!0),f.setUint8(8,a),Er.log("drawRoundRect data",f),e(this,za,"m",cr).call(this,"drawRoundRect",f.buffer,r)}drawCircle(t,s,i,n){const{x:a,y:r,radius:o}=e(this,za,"m",br).call(this,t,s,i),c=new DataView(new ArrayBuffer(6));c.setUint16(0,a,!0),c.setUint16(2,r,!0),c.setUint16(4,o,!0),Er.log("drawCircle data",c),e(this,za,"m",cr).call(this,"drawCircle",c.buffer,n)}drawEllipse(t,s,i,n,a,r){const o=new DataView(new ArrayBuffer(10));a=e(this,za,"m",Sr).call(this,a),o.setUint16(0,t,!0),o.setUint16(2,s,!0),o.setUint16(4,i,!0),o.setUint16(6,n,!0),o.setUint16(8,a,!0),Er.log("drawEllipse data",o),e(this,za,"m",cr).call(this,"drawEllipse",o.buffer,r)}selectSpriteSheet(e,t){}drawSprite(e,t,s,i){}parseMessage(t,s){switch(Er.log({messageType:t,dataView:s}),t){case"isDisplayAvailable":e(this,za,"m",Ja).call(this,s);break;case"displayStatus":e(this,za,"m",Qa).call(this,s);break;case"displayInformation":e(this,za,"m",sr).call(this,s);break;case"getDisplayBrightness":case"setDisplayBrightness":e(this,za,"m",nr).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}clear(){t(this,Ka,void 0,"f"),t(this,Ga,!1,"f"),t(this,tr,void 0,"f"),t(this,ir,void 0,"f"),t(this,or,[],"f")}get mtu(){return e(this,Cr,"f")}set mtu(e){t(this,Cr,e,"f")}}var Ar,Fr,xr,$r,Or,Br,Nr,Pr,Vr,qr,zr,jr;Ga=new WeakMap,Ka=new WeakMap,tr=new WeakMap,ir=new WeakMap,or=new WeakMap,Cr=new WeakMap,za=new WeakSet,ja=function(){return this.eventDispatcher.dispatchEvent},Ha=function(){Er.assertWithError(e(this,Ga,"f"),"display is not available")},Ja=function(s){const i=1==s.getUint8(0);t(this,Ga,i,"f"),Er.log({isDisplayAvailable:e(this,Ga,"f")}),e(this,za,"a",ja).call(this,"isDisplayAvailable",{isDisplayAvailable:e(this,Ga,"f")})},Qa=function(t){const s=t.getUint8(0),i=Dr[s];e(this,za,"m",Za).call(this,i)},Za=function(s){if(Er.assertEnumWithError(s,Dr),s==e(this,Ka,"f"))return void Er.log(`redundant displayStatus ${s}`);const i=e(this,Ka,"f");t(this,Ka,s,"f"),Er.log(`updated displayStatus to "${this.displayStatus}"`),e(this,za,"a",ja).call(this,"displayStatus",{displayStatus:this.displayStatus,previousDisplayStatus:i})},Xa=async function(e,t){Er.assertEnumWithError(e,Mr),Er.log(`sending display command "${e}"`);const s=this.waitForEvent("displayStatus");Er.log(`setting command "${e}"`);const i=Mr.indexOf(e);this.sendMessage([{type:"displayCommand",data:K(i)}],t),await s},Ya=function(){Er.assertWithError("awake"==e(this,Ka,"f"),`display is not awake - currently ${e(this,Ka,"f")}`)},er=function(){Er.assertWithError("awake"!=e(this,Ka,"f"),"display is awake")},sr=function(s){const i={};let n=0;for(;n<s.byteLength;){const e=s.getUint8(n++),t=kr[e];switch(Er.assertWithError(t,`invalid displayInformationTypeIndex ${t}`),Er.log({displayInformationType:t}),t){case"width":case"height":{const e=s.getUint16(n,!0);i[t]=e,n+=2}break;case"pixelDepth":case"type":{const e=Ir[t];const a=e[s.getUint8(n++)];Er.assertEnumWithError(a,e),i[t]=a}}}Er.log({parsedDisplayInformation:i});const a=kr.find((e=>!(e in i)));Er.assertWithError(!a,`missingDisplayInformationType ${a}`),t(this,tr,i,"f"),e(this,za,"a",ja).call(this,"displayInformation",{displayInformation:e(this,tr,"f")})},nr=function(s){const i=s.getUint8(0),n=Wr[i];e(this,za,"m",ar).call(this,n),t(this,ir,n,"f"),Er.log({displayBrightness:e(this,ir,"f")}),e(this,za,"a",ja).call(this,"getDisplayBrightness",{displayBrightness:e(this,ir,"f")})},ar=function(e){Er.assertEnumWithError(e,Wr)},rr=function(e){Er.assertEnumWithError(e,Rr)},cr=async function(t,s,i=!1){e(this,za,"m",rr).call(this,t);const n=j(Rr.indexOf(t),s);e(this,or,"f").reduce(((e,t)=>e+t.byteLength),n.byteLength)>this.mtu-6&&(Er.log("displayContextCommandBuffers too full - sending now"),await e(this,za,"m",hr).call(this)),e(this,or,"f").push(n),i&&await e(this,za,"m",hr).call(this)},hr=async function(){Er.log("sending displayContextCommands",e(this,or,"f"));const t=j(e(this,or,"f"));await this.sendMessage([{type:"displayContextCommands",data:t}],!0),e(this,or,"f").length=0},lr=function(t){e(this,za,"m",fr).call(this,"red",t.r),e(this,za,"m",fr).call(this,"green",t.g),e(this,za,"m",fr).call(this,"blue",t.b)},fr=function(e,t){Er.assertRangeWithError(e,t,0,255)},gr=function(e){Er.assertRangeWithError("colorIndex",e,0,this.numberOfColors)},ur=function(e){Er.assertRangeWithError("opacity",e,0,1)},dr=function(e){Er.assertRangeWithError("lineWidth",e,0,this.width)},pr=function(e){return Qe(e,0,this.width-1)},mr=function(e,t){return Qe(t,1,this.width-e)},vr=function(e){return Qe(e,0,this.height-1)},wr=function(e,t){return Qe(t,1,this.height-e)},yr=function(t,s,i,n){return t=e(this,za,"m",pr).call(this,t),i=e(this,za,"m",mr).call(this,t,i),s=e(this,za,"m",vr).call(this,s),n=e(this,za,"m",wr).call(this,s,n),Er.log("clampBox",{x:t,y:s,width:i,height:n}),{x:t,y:s,width:i,height:n}},br=function(t,s,i){const{x:n,y:a,width:r,height:o}=e(this,za,"m",yr).call(this,t,s,i,i);return{x:n,y:a,radius:Math.min(r,o)}},Sr=function(e){const t=2*Math.PI,s=(e%t+t)%t;return Math.round(s/t*65535)};const Gr=W("BaseConnectionManager",{log:!1}),Hr=["webBluetooth","noble","client","webSocket","udp"],Jr=["notConnected","connecting","connected","disconnecting"],Kr=[...Jr,"connectionStatus","isConnected"],Qr=[...xn,...mi,...Qs,...ca,...Be,...Zi,...Ba,...rs,...Ps,...Tr],Zr=["batteryLevel"],Xr=["rx","tx"],Yr=[...Zr,...ln,...Xr,...Qr,"smp"];class eo{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get canUpdateFirmware(){return!1}get type(){return this.baseConstructor.type}constructor(){Ar.add(this),Or.set(this,"notConnected"),Pr.set(this,[]),Vr.set(this,!1),this.defaultMtu=23,this.mtu=this.defaultMtu,zr.set(this,new x(e(this,Ar,"m",jr).bind(this),5e3)),e(this,Ar,"m",$r).call(this)}get status(){return e(this,Or,"f")}set status(s){Gr.assertEnumWithError(s,Jr),e(this,Or,"f")!=s?(Gr.log(`new connection status "${s}"`),t(this,Or,s,"f"),this.onStatusUpdated(this.status),this.isConnected?e(this,zr,"f").start():e(this,zr,"f").stop(),"notConnected"==e(this,Or,"f")&&(this.mtu=this.defaultMtu)):Gr.log(`tried to assign same connection status "${s}"`)}get isConnected(){return"connected"==this.status}get isAvailable(){return!1}assertIsNotConnected(){Gr.assertWithError(!this.isConnected,"device is already connected")}assertIsConnected(){Gr.assertWithError(this.isConnected,"device is not connected")}assertIsConnectedAndNotDisconnecting(){this.assertIsConnected(),e(this,Ar,"m",Nr).call(this)}async connect(){this.assertIsNotConnected(),e(this,Ar,"m",Br).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){this.assertIsNotConnected(),e(this,Ar,"m",Br).call(this),Gr.assertWithError(this.canReconnect,"unable to reconnect"),this.status="connecting",Gr.log("attempting to reconnect...")}async disconnect(){this.assertIsConnected(),e(this,Ar,"m",Nr).call(this),this.status="disconnecting",Gr.log("disconnecting from device...")}async sendSmpMessage(e){this.assertIsConnectedAndNotDisconnecting(),Gr.log("sending smp message",e)}async sendTxMessages(s,i=!0){if(this.assertIsConnectedAndNotDisconnecting(),s&&(e(this,Pr,"f").push(...s),Gr.log(`appended ${s.length} messages`)),!i)return void Gr.log("not sending immediately - waiting until later");if(e(this,Vr,"f"))return void Gr.log("already sending messages - waiting until later");if(0==e(this,Pr,"f").length)return void Gr.log("no pendingMessages");t(this,Vr,!0,"f"),Gr.log("sendTxMessages",e(this,Pr,"f").slice());const n=e(this,Pr,"f").map((t=>{e(Fr,Fr,"m",xr).call(Fr,t.type);const s=Qr.indexOf(t.type),i=new DataView(new ArrayBuffer(2));return i.setUint16(0,t.data?.byteLength||0,!0),j(s,i,t.data)}));if(e(this,Pr,"f").length=0,this.mtu)for(;n.length>0;){if(n.every((e=>e.byteLength>this.mtu-3))){Gr.log("every arrayBuffer is too big to send");break}Gr.log("remaining arrayBuffers.length",n.length);let e=0,t=0;n.some((s=>{if(e+s.byteLength>this.mtu-3)return Gr.log(`stopping appending arrayBuffers ( length ${s.byteLength} too much)`),!0;Gr.log(`allowing arrayBuffer with length ${s.byteLength}`),t++,e+=s.byteLength}));const s=n.splice(0,t);Gr.log({arrayBufferCount:t,arrayBuffersToSend:s});const i=j(...s);Gr.log("sending arrayBuffer (partitioned)",i),await this.sendTxData(i)}else{const e=j(...n);Gr.log("sending arrayBuffer (all)",e),await this.sendTxData(e)}t(this,Vr,!1,"f"),this.sendTxMessages(void 0,!0)}async sendTxData(e){Gr.log("sendTxData",e)}parseRxMessage(t){Dt(t,Qr,e(this,Ar,"m",qr).bind(this),null,!0),this.onMessagesReceived()}clear(){t(this,Vr,!1,"f"),e(this,Pr,"f").length=0}remove(){this.clear(),this.onStatusUpdated=void 0,this.onMessageReceived=void 0,this.onMessagesReceived=void 0}}Fr=eo,Or=new WeakMap,Pr=new WeakMap,Vr=new WeakMap,zr=new WeakMap,Ar=new WeakSet,xr=function(e){Gr.assertEnumWithError(e,Qr)},$r=function(){Gr.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},Br=function(){Gr.assertWithError("connecting"!=this.status,"device is already connecting")},Nr=function(){Gr.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},qr=function(e,t){Gr.log({messageType:e,dataView:t}),this.onMessageReceived(e,t)},jr=function(){this.isConnected||(Gr.log("timer detected disconnection"),this.status="notConnected")};const to=W("EventUtils",{log:!1});function so(e,t){let s=e.addEventListener||e.addListener||e.on||e.AddEventListener;to.assertWithError(s,"no add listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}function io(e,t){let s=e.removeEventListener||e.removeListener||e.RemoveEventListener;to.assertWithError(s,"no remove listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}const no=W("bluetoothUUIDs",{log:!1});if(i)var ao=window.BluetoothUUID;function ro(e){return no.assertTypeWithError(e,"string"),no.assertWithError(4==e.length,"value must be 4 characters long"),`ea6d${e}-a725-4f9b-893d-c3913e33b39f`}function oo(e){return ao?.getCharacteristic?.(e)}function co(e){return ao?.getService?.(e)}const ho=Object.freeze({services:{deviceInformation:{uuid:co("device_information"),characteristics:{manufacturerName:{uuid:oo("manufacturer_name_string")},modelNumber:{uuid:oo("model_number_string")},hardwareRevision:{uuid:oo("hardware_revision_string")},firmwareRevision:{uuid:oo("firmware_revision_string")},softwareRevision:{uuid:oo("software_revision_string")},pnpId:{uuid:oo("pnp_id")},serialNumber:{uuid:oo("serial_number_string")}}},battery:{uuid:co("battery_service"),characteristics:{batteryLevel:{uuid:oo("battery_level")}}},main:{uuid:ro("0000"),characteristics:{rx:{uuid:ro("1000")},tx:{uuid:ro("1001")}}},smp:{uuid:"8d53dc1d-1db7-4cd3-868b-8a527460aa84",characteristics:{smp:{uuid:"da2e7828-fbce-4e01-ae9e-261174997c48"}}}}}),lo=[ho.services.main.uuid],fo=[ho.services.deviceInformation.uuid,ho.services.battery.uuid,ho.services.smp.uuid];function go(e){e=e.toString().toLowerCase();return Object.keys(ho.services).find((t=>{let s=ho.services[t].uuid.toString();return 4==e.length&&(s=s.slice(4,8)),e.includes("-")||(s=s.replaceAll("-","")),e==s}))}const uo=[],po=[];function mo(e){var t;return e=e.toString().toLowerCase(),Object.values(ho.services).some((s=>{const i=Object.keys(s.characteristics);return t=i.find((t=>{let i=s.characteristics[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))})),t}function vo(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"rx":case"tx":case"smp":t.read=!1}switch(e){case"batteryLevel":case"rx":case"smp":t.notify=!0}if("smp"===e)t.writeWithoutResponse=!0;if("tx"===e)t.write=!0;return t}Object.values(ho.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((s=>{const i=e.characteristics[s];lo.includes(e.uuid)&&(uo.push(i.uuid),t.push(s)),po.push(i.uuid)}))}),[]);const wo=W("BluetoothConnectionManager",{log:!1});class yo extends eo{constructor(){super(...arguments),this.isInRange=!0}get isAvailable(){return!0}onCharacteristicValueChanged(e,t){"rx"==e?this.parseRxMessage(t):this.onMessageReceived?.(e,t)}async writeCharacteristic(e,t){wo.log("writeCharacteristic",...arguments)}async sendSmpMessage(e){super.sendSmpMessage(e),await this.writeCharacteristic("smp",e)}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&await this.writeCharacteristic("tx",e)}}var bo,So,Co,Eo,Mo,Do,ko,Wo,To,Io,Ro;const Uo=W("WebBluetoothConnectionManager",{log:!1});var Lo;i&&(Lo=window.navigator.bluetooth);class _o extends yo{constructor(){super(...arguments),bo.add(this),So.set(this,{characteristicvaluechanged:e(this,bo,"m",To).bind(this)}),Co.set(this,{gattserverdisconnected:e(this,bo,"m",Ro).bind(this)}),Eo.set(this,void 0),Mo.set(this,new Map),Do.set(this,new Map)}get bluetoothId(){return this.device.id}get canUpdateFirmware(){return e(this,Do,"f").has("smp")}static get isSupported(){return Boolean(Lo)}static get type(){return"webBluetooth"}get device(){return e(this,Eo,"f")}set device(s){e(this,Eo,"f")!=s?(e(this,Eo,"f")&&io(e(this,Eo,"f"),e(this,Co,"f")),s&&so(s,e(this,Co,"f")),t(this,Eo,s,"f")):Uo.log("tried to assign the same BluetoothDevice")}get server(){return e(this,Eo,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const t=await Lo.requestDevice({filters:[{services:lo}],optionalServices:i?fo:[]});Uo.log("got BluetoothDevice"),this.device=t,Uo.log("connecting to device...");const s=await this.server.connect();Uo.log(`connected to device? ${s.connected}`),await e(this,bo,"m",ko).call(this),Uo.log("fully connected"),this.status="connected"}catch(t){Uo.error(t),this.status="notConnected",this.server?.disconnect(),e(this,bo,"m",Wo).call(this)}}async disconnect(){await e(this,bo,"m",Wo).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(t,s){super.writeCharacteristic(t,s);const i=e(this,Do,"f").get(t);Uo.assertWithError(i,`${t} characteristic not found`),Uo.log("writing characteristic",i,s);const n=i.properties||vo(t);n.writeWithoutResponse?(Uo.log("writing without response"),await i.writeValueWithoutResponse(s)):(Uo.log("writing with response"),await i.writeValueWithResponse(s)),Uo.log("wrote characteristic"),n.read&&!n.notify&&(Uo.log("reading value after write..."),await i.readValue(),(o||c)&&e(this,bo,"m",Io).call(this,i))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect();try{await this.server.connect()}catch(e){Uo.error(e),this.isInRange=!1}this.isConnected?(Uo.log("successfully reconnected!"),await e(this,bo,"m",ko).call(this),this.status="connected"):(Uo.log("unable to reconnect"),this.status="notConnected")}remove(){super.remove(),this.device=void 0}}So=new WeakMap,Co=new WeakMap,Eo=new WeakMap,Mo=new WeakMap,Do=new WeakMap,bo=new WeakSet,ko=async function(){e(this,bo,"m",Wo).call(this),Uo.log("getting services...");const t=await this.server.getPrimaryServices();Uo.log("got services",t.length),Uo.log("getting characteristics...");for(const s in t){const i=t[s];Uo.log({service:i});const n=go(i.uuid);Uo.assertWithError(n,`no name found for service uuid "${i.uuid}"`),Uo.log(`got "${n}" service`),i.name=n,e(this,Mo,"f").set(n,i),Uo.log(`getting characteristics for "${n}" service`);const a=await i.getCharacteristics();Uo.log(`got characteristics for "${n}" service`);for(const t in a){const s=a[t];Uo.log({characteristic:s});const i=mo(s.uuid);Uo.assertWithError(Boolean(i),`no name found for characteristic uuid "${s.uuid}" in "${n}" service`),Uo.log(`got "${i}" characteristic in "${n}" service`),s.name=i,e(this,Do,"f").set(i,s),so(s,e(this,So,"f"));const r=s.properties||vo(i);r.notify&&(Uo.log(`starting notifications for "${i}" characteristic`),await s.startNotifications()),r.read&&(Uo.log(`reading "${i}" characteristic...`),await s.readValue(),(o||c)&&e(this,bo,"m",Io).call(this,s))}}},Wo=async function(){this.device&&io(this.device,e(this,Co,"f"));const t=Array.from(e(this,Do,"f").keys()).map((t=>{const s=e(this,Do,"f").get(t);io(s,e(this,So,"f"));if((s.properties||vo(t)).notify)return Uo.log(`stopping notifications for "${t}" characteristic`),s.stopNotifications()}));return Promise.allSettled(t)},To=function(t){Uo.log("oncharacteristicvaluechanged");const s=t.target;e(this,bo,"m",Io).call(this,s)},Io=function(e){Uo.log("onCharacteristicValue");const t=e.name;Uo.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),Uo.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const s=e.value;Uo.assertWithError(s,`no data found for "${t}" characteristic`),Uo.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(s.buffer)));try{this.onCharacteristicValueChanged(t,s)}catch(e){Uo.error(e)}},Ro=function(){Uo.log("gattserverdisconnected"),this.status="notConnected"};const Ao=4294967296,Fo=9007199254740992;const xo={encode:function(e){let t,s=new ArrayBuffer(256),i=new DataView(s),n=0;function a(e){let a=s.byteLength;const r=n+e;for(;a<r;)a<<=1;if(a!==s.byteLength){const e=i;s=new ArrayBuffer(a),i=new DataView(s);const t=n+3>>2;for(let s=0;s<t;++s)i.setUint32(s<<2,e.getUint32(s<<2))}return t=e,i}function r(){n+=t}function o(e){r(a(1).setUint8(n,e))}function c(e){const t=a(e.length);for(let s=0;s<e.length;++s)t.setUint8(n+s,e[s]);r()}function h(e,t){t<24?o(e<<5|t):t<256?(o(e<<5|24),o(t)):t<65536?(o(e<<5|25),function(e){r(a(2).setUint16(n,e))}(t)):t<4294967296?(o(e<<5|26),function(e){r(a(4).setUint32(n,e))}(t)):(o(e<<5|27),function(e){const t=e%Ao,s=(e-t)/Ao,i=a(8);i.setUint32(n,s),i.setUint32(n+4,t),r()}(t))}if(function e(t){let s;const i=[];let l;if(!1===t)return o(244);if(!0===t)return o(245);if(null===t)return o(246);if(void 0===t)return o(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(t>=0&&t<=Fo)return h(0,t);if(-Fo<=t&&t<0)return h(1,-(t+1))}return o(251),function(e){r(a(8).setFloat64(n,e))}(t);case"string":for(s=0;s<t.length;++s){let e=t.charCodeAt(s);e<128?i.push(e):e<2048?(i.push(192|e>>6),i.push(128|63&e)):e<55296?(i.push(224|e>>12),i.push(128|e>>6&63),i.push(128|63&e)):(e=(1023&e)<<10,e|=1023&t.charCodeAt(++s),e+=65536,i.push(240|e>>18),i.push(128|e>>12&63),i.push(128|e>>6&63),i.push(128|63&e))}return h(3,i.length),c(i);default:if(Array.isArray(t))for(l=t.length,h(4,l),s=0;s<l;++s)e(t[s]);else if(t instanceof Uint8Array)h(2,t.length),c(t);else{const i=Object.keys(t);for(l=i.length,h(5,l),s=0;s<l;++s){const n=i[s];e(n),e(t[n])}}}}(e),"slice"in s)return s.slice(0,n);const l=new ArrayBuffer(n),f=new DataView(l);for(let e=0;e<n;++e)f.setUint8(e,i.getUint8(e));return l},decode:function(e,t,s){const i=new DataView(e);let n=0;function a(e,t){return n+=e,t}function r(t){return a(t,new Uint8Array(e,n,t))}function o(){return a(1,i.getUint8(n))}function c(){return a(2,i.getUint16(n))}function h(){return a(4,i.getUint32(n))}function l(){return 255===i.getUint8(n)&&(n+=1,!0)}function f(e){if(e<24)return e;if(24===e)return o();if(25===e)return c();if(26===e)return h();if(27===e)return h()*Ao+h();if(31===e)return-1;throw new Error("Invalid length encoding")}function g(e){const t=o();if(255===t)return-1;const s=f(31&t);if(s<0||t>>5!==e)throw new Error("Invalid indefinite length element");return s}function u(e,t){for(let s=0;s<t;++s){let s=o();128&s&&(s<224?(s=(31&s)<<6|63&o(),t-=1):s<240?(s=(15&s)<<12|(63&o())<<6|63&o(),t-=2):(s=(15&s)<<18|(63&o())<<12|(63&o())<<6|63&o(),t-=3)),s<65536?e.push(s):(s-=65536,e.push(55296|s>>10),e.push(56320|1023&s))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof s&&(s=function(){});const d=function e(){const h=o(),d=h>>5,p=31&h;let m,v;if(7===d)switch(p){case 25:return function(){const e=new ArrayBuffer(4),t=new DataView(e),s=c(),i=32768&s;let n=31744&s;const a=1023&s;if(31744===n)n=261120;else if(0!==n)n+=114688;else if(0!==a)return(i?-1:1)*a*5.960464477539063e-8;return t.setUint32(0,i<<16|n<<13|a<<13),t.getFloat32(0)}();case 26:return a(4,i.getFloat32(n));case 27:return a(8,i.getFloat64(n))}if(v=f(p),v<0&&(d<2||d>6))throw new Error("Invalid length");const w=[];let y;const b={};switch(d){case 0:return v;case 1:return-1-v;case 2:if(v<0){const e=[];let t=0;for(;(v=g(d))>=0;)t+=v,e.push(r(v));const s=new Uint8Array(t);let i=0;for(m=0;m<e.length;++m)s.set(e[m],i),i+=e[m].length;return s}return r(v);case 3:if(v<0)for(;(v=g(d))>=0;)u(w,v);else u(w,v);return String.fromCharCode.apply(null,w);case 4:if(v<0)for(y=[];!l();)y.push(e());else for(y=new Array(v),m=0;m<v;++m)y[m]=e();return y;case 5:for(m=0;m<v||v<0&&!l();++m){b[e()]=e()}return b;case 6:return t(e(),v);case 7:switch(v){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return s(v)}}}();if(n!==e.byteLength)throw new Error("Remaining bytes");return d}},$o=W("mcumgr",{log:!1}),Oo=0,Bo=1,No=2,Po=3,Vo=0,qo=1,zo=8,jo=0,Go=2,Ho=3,Jo=5,Ko=0,Qo=1,Zo=5,Xo=0;class Yo{constructor(){this._mtu=256,this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}onMessage(e){return this._messageCallback=e,this}onImageUploadNext(e){return this._imageUploadNextCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}onFileUploadNext(e){return this._fileUploadNextCallback=e,this}onFileUploadProgress(e){return this._fileUploadProgressCallback=e,this}onFileUploadFinished(e){return this._fileUploadFinishedCallback=e,this}onFileDownloadNext(e){return this._fileDownloadNextCallback=e,this}onFileDownloadProgress(e){return this._fileDownloadProgressCallback=e,this}onFileDownloadFinished(e){return this._fileDownloadFinishedCallback=e,this}_getMessage(e,t,s,i){let n=[];void 0!==i&&(n=[...new Uint8Array(xo.encode(i))]);const a=255&n.length,r=[e,0,n.length>>8,a,t>>8,255&t,this._seq,s,...n];return this._seq=(this._seq+1)%256,r}_notification(e){$o.log("mcumgr - message received");const t=new Uint8Array(e);this._buffer=new Uint8Array([...this._buffer,...t]);const s=256*this._buffer[2]+this._buffer[3];this._buffer.length<s+8||(this._processMessage(this._buffer.slice(0,s+8)),this._buffer=this._buffer.slice(s+8))}_processMessage(e){const[t,,s,i,n,a,,r]=e,o=xo.decode(e.slice(8).buffer),c=256*s+i,h=256*n+a;return $o.log("mcumgr - Process Message - Group: "+h+", Id: "+r+", Off: "+o.off),h===qo&&r===Qo&&o.off?(this._uploadOffset=o.off,void this._uploadNext()):t===Po&&h===zo&&r===Xo&&o.off?(this._uploadFileOffset=o.off,void this._uploadFileNext()):t===Bo&&h===zo&&r===Xo?(this._downloadFileOffset+=o.data.length,null!=o.len&&(this._downloadFileLength=o.len),$o.log("downloaded "+this._downloadFileOffset+" bytes of "+this._downloadFileLength),this._downloadFileLength>0&&this._fileDownloadProgressCallback({percentage:Math.floor(this._downloadFileOffset/this._downloadFileLength*100)}),this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}),void this._downloadFileNext()):void(this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}))}cmdReset(){return this._getMessage(No,Vo,Jo)}smpEcho(e){return this._getMessage(No,Vo,jo,{d:e})}cmdImageState(){return this._getMessage(Oo,qo,Ko)}cmdImageErase(){return this._getMessage(No,qo,Zo,{})}cmdImageTest(e){return this._getMessage(No,qo,Ko,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._getMessage(No,qo,Ko,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(!this._uploadImage)return;if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-xo.encode(e).byteLength-8-3-5;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t;const s=this._getMessage(No,qo,Qo,e);$o.log("mcumgr - _uploadNext: Message Length: "+s.length),this._imageUploadNextCallback({packet:s})}async reset(){this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}async cmdUpload(e,t=0){this._uploadIsInProgress?$o.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async cmdUploadFile(e,t){this._uploadIsInProgress?$o.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadFileOffset=0,this._uploadFile=e,this._uploadFilename=t,this._uploadFileNext())}async _uploadFileNext(){if($o.log("uploadFileNext - offset: "+this._uploadFileOffset+", length: "+this._uploadFile.byteLength),this._uploadFileOffset>=this._uploadFile.byteLength)return this._uploadIsInProgress=!1,void this._fileUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadFileOffset};0===this._uploadFileOffset&&(e.len=this._uploadFile.byteLength),e.name=this._uploadFilename,this._fileUploadProgressCallback({percentage:Math.floor(this._uploadFileOffset/this._uploadFile.byteLength*100)});const t=this._mtu-xo.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadFile.slice(this._uploadFileOffset,this._uploadFileOffset+t)),this._uploadFileOffset+=t;const s=this._getMessage(No,zo,Xo,e);$o.log("mcumgr - _uploadNext: Message Length: "+s.length),this._fileUploadNextCallback({packet:s})}async cmdDownloadFile(e,t){this._downloadIsInProgress?$o.error("Download is already in progress."):(this._downloadIsInProgress=!0,this._downloadFileOffset=0,this._downloadFileLength=0,this._downloadRemoteFilename=e,this._downloadLocalFilename=t,this._downloadFileNext())}async _downloadFileNext(){if(this._downloadFileLength>0&&this._downloadFileOffset>=this._downloadFileLength)return this._downloadIsInProgress=!1,void this._fileDownloadFinishedCallback();const e={off:this._downloadFileOffset};0===this._downloadFileOffset&&(e.name=this._downloadRemoteFilename);const t=this._getMessage(Oo,zo,Xo,e);$o.log("mcumgr - _downloadNext: Message Length: "+t.length),this._fileDownloadNextCallback({packet:t})}async imageInfo(e){const t={},s=new Uint8Array(e);if(s.length<32)throw new Error("Invalid image (too short file)");if(61!==s[0]||184!==s[1]||243!==s[2]||150!==s[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==s[4]||0!==s[5]||0!==s[6]||0!==s[7])throw new Error("Invalid image (wrong load address)");const i=s[8]+256*s[9];if(0!==s[10]||0!==s[11])throw new Error("Invalid image (wrong protected TLV area size)");const n=s[12]+256*s[13]+65536*s[14]+s[15]*2**24;if(t.imageSize=n,s.length<n+i)throw new Error("Invalid image (wrong image size)");if(0!==s[16]||0!==s[17]||0!==s[18]||0!==s[19])throw new Error("Invalid image (wrong flags)");const a=`${s[20]}.${s[21]}.${s[22]+256*s[23]}`;return t.version=a,t.hash=[...new Uint8Array(await this._hash(e.slice(0,n+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}var ec,tc,sc,ic,nc,ac,rc,oc,cc,hc,lc,fc,gc,uc,dc,pc,mc,vc,wc,yc,bc;const Sc=W("FirmwareManager",{log:!1}),Cc=["smp"],Ec=[...Cc,"firmwareImages","firmwareUploadProgress","firmwareStatus","firmwareUploadComplete"],Mc=["idle","uploading","uploaded","pending","testing","erasing"];class Dc{constructor(){ec.add(this),sc.set(this,"idle"),nc.set(this,void 0),oc.set(this,void 0),cc.set(this,new Yo),e(this,ec,"m",hc).call(this),Q(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}parseMessage(t,s){if(Sc.log({messageType:t}),"smp"!==t)throw Error(`uncaught messageType ${t}`);e(this,cc,"f")._notification(Array.from(new Uint8Array(s.buffer))),e(this,ec,"a",tc).call(this,"smp",{dataView:s})}async uploadFirmware(t){Sc.log("uploadFirmware",t);const s=this.waitForEvent("firmwareUploadComplete");await this.getImages();const i=await J(t),n=await e(this,cc,"f").imageInfo(i);Sc.log({imageInfo:n}),e(this,cc,"f").cmdUpload(i,1),e(this,ec,"m",ic).call(this,"uploading"),await s}get status(){return e(this,sc,"f")}get images(){return e(this,nc,"f")}async getImages(){const t=this.waitForEvent("firmwareImages");Sc.log("getting firmware image state..."),this.sendMessage(Uint8Array.from(e(this,cc,"f").cmdImageState()).buffer),await t}async testImage(t=1){if(e(this,ec,"m",rc).call(this,t),e(this,ec,"m",ac).call(this),!e(this,nc,"f")[t])return void Sc.log(`image ${t} not found`);if(1==e(this,nc,"f")[t].pending)return void Sc.log(`image ${t} is already pending`);if(e(this,nc,"f")[t].empty)return void Sc.log(`image ${t} is empty`);const s=this.waitForEvent("smp");Sc.log("testing firmware image..."),this.sendMessage(Uint8Array.from(e(this,cc,"f").cmdImageTest(e(this,nc,"f")[t].hash)).buffer),await s}async eraseImage(){e(this,ec,"m",ac).call(this);const t=this.waitForEvent("smp");Sc.log("erasing image..."),this.sendMessage(Uint8Array.from(e(this,cc,"f").cmdImageErase()).buffer),e(this,ec,"m",ic).call(this,"erasing"),await t,await this.getImages()}async confirmImage(t=0){if(e(this,ec,"m",rc).call(this,t),e(this,ec,"m",ac).call(this),!0===e(this,nc,"f")[t].confirmed)return void Sc.log(`image ${t} is already confirmed`);const s=this.waitForEvent("smp");Sc.log("confirming image..."),this.sendMessage(Uint8Array.from(e(this,cc,"f").cmdImageConfirm(e(this,nc,"f")[t].hash)).buffer),await s}async echo(t){Sc.assertTypeWithError(t,"string");const s=this.waitForEvent("smp");Sc.log("sending echo..."),this.sendMessage(Uint8Array.from(e(this,cc,"f").smpEcho(t)).buffer),await s}async reset(){const t=this.waitForEvent("smp");Sc.log("resetting..."),this.sendMessage(Uint8Array.from(e(this,cc,"f").cmdReset()).buffer),await t}get mtu(){return e(this,oc,"f")}set mtu(s){t(this,oc,s,"f"),e(this,cc,"f")._mtu=s}}var kc,Wc,Tc,Ic,Rc,Uc,Lc,_c,Ac,Fc,xc,$c,Oc,Bc,Nc,Pc,Vc,qc;sc=new WeakMap,nc=new WeakMap,oc=new WeakMap,cc=new WeakMap,ec=new WeakSet,tc=function(){return this.eventDispatcher.dispatchEvent},ic=function(s){Sc.assertEnumWithError(s,Mc),e(this,sc,"f")!=s?(t(this,sc,s,"f"),Sc.log({firmwareStatus:e(this,sc,"f")}),e(this,ec,"a",tc).call(this,"firmwareStatus",{firmwareStatus:e(this,sc,"f")})):Sc.log(`redundant firmwareStatus assignment "${s}"`)},ac=function(){Sc.assertWithError(e(this,nc,"f"),"didn't get imageState")},rc=function(e){Sc.assertTypeWithError(e,"number"),Sc.assertWithError(0==e||1==e,"imageIndex must be 0 or 1")},hc=function(){e(this,cc,"f").onMessage(e(this,ec,"m",lc).bind(this)),e(this,cc,"f").onFileDownloadNext(e(this,ec,"m",fc)),e(this,cc,"f").onFileDownloadProgress(e(this,ec,"m",gc).bind(this)),e(this,cc,"f").onFileDownloadFinished(e(this,ec,"m",uc).bind(this)),e(this,cc,"f").onFileUploadNext(e(this,ec,"m",dc).bind(this)),e(this,cc,"f").onFileUploadProgress(e(this,ec,"m",pc).bind(this)),e(this,cc,"f").onFileUploadFinished(e(this,ec,"m",mc).bind(this)),e(this,cc,"f").onImageUploadNext(e(this,ec,"m",vc).bind(this)),e(this,cc,"f").onImageUploadProgress(e(this,ec,"m",wc).bind(this)),e(this,cc,"f").onImageUploadFinished(e(this,ec,"m",yc).bind(this))},lc=function({op:t,group:s,id:i,data:n,length:a}){switch(Sc.log("onMcuMessage",...arguments),s){case Vo:switch(i){case jo:Sc.log(`echo "${n.r}"`);break;case Go:Sc.table(n.tasks);break;case Ho:Sc.log(n)}break;case qo:if(i===Ko)e(this,ec,"m",bc).call(this,n);break;default:throw Error(`uncaught mcuMessage group ${s}`)}},fc=function(){Sc.log("onMcuFileDownloadNext",...arguments)},gc=function(){Sc.log("onMcuFileDownloadProgress",...arguments)},uc=function(){Sc.log("onMcuFileDownloadFinished",...arguments)},dc=function(){Sc.log("onMcuFileUploadNext")},pc=function(){Sc.log("onMcuFileUploadProgress")},mc=function(){Sc.log("onMcuFileUploadFinished")},vc=function({packet:e}){Sc.log("onMcuImageUploadNext"),this.sendMessage(Uint8Array.from(e).buffer)},wc=function({percentage:t}){const s=t/100;Sc.log("onMcuImageUploadProgress",...arguments),e(this,ec,"a",tc).call(this,"firmwareUploadProgress",{progress:s})},yc=async function(){Sc.log("onMcuImageUploadFinished",...arguments),await this.getImages(),e(this,ec,"a",tc).call(this,"firmwareUploadProgress",{progress:100}),e(this,ec,"a",tc).call(this,"firmwareUploadComplete",{})},bc=function({images:s}){if(!s)return void Sc.log("no images found");t(this,nc,s,"f"),Sc.log("images",e(this,nc,"f"));let i="idle";2==e(this,nc,"f").length&&(e(this,nc,"f")[1].bootable?e(this,nc,"f")[0].confirmed?e(this,nc,"f")[1].pending?(Sc.log("reset to upload to the new firmware image"),i="pending"):(Sc.log("Slot 1 has a valid image. run testImage() to test it or upload a different image."),i="uploaded"):(Sc.log('Slot 0 has a valid image. Click "Confirm Image" to confirm it or wait and the device will swap images back.'),i="testing"):Sc.warn('Slot 1 has a invalid image. Click "Erase Image" to erase it or upload a different image')),1==e(this,nc,"f").length&&(e(this,nc,"f").push({slot:1,empty:!0,version:"Empty",pending:!1,confirmed:!1,bootable:!1,active:!1,permanent:!1}),Sc.log("Select a firmware upload image to upload to slot 1.")),e(this,ec,"m",ic).call(this,i),e(this,ec,"a",tc).call(this,"firmwareImages",{firmwareImages:e(this,nc,"f")})};const zc=W("DeviceManager",{log:!1}),jc=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class Gc{constructor(){if(kc.add(this),Wc.set(this,{getType:e(this,kc,"m",Tc).bind(this),isConnected:e(this,kc,"m",Pc).bind(this)}),Ic.set(this,[]),Rc.set(this,!1),Uc.set(this,{devices:[]}),Lc.set(this,void 0),Ac.set(this,"BS.Device"),Oc.set(this,[]),Bc.set(this,new U(this,jc)),Gc.shared&&this!=Gc.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(t){so(t,e(this,Wc,"f"))}OnDeviceConnectionStatusUpdated(t,s){if("notConnected"==s&&!t.canReconnect&&e(this,Oc,"f").includes(t)){const s=e(this,Oc,"f").indexOf(t);this.AvailableDevices.splice(s,1),e(this,kc,"m",Vc).call(this)}}get ConnectedDevices(){return e(this,Ic,"f")}get UseLocalStorage(){return e(this,Rc,"f")}set UseLocalStorage(s){e(this,kc,"m",_c).call(this),zc.assertTypeWithError(s,"boolean"),t(this,Rc,s,"f"),e(this,Rc,"f")&&!e(this,Lc,"f")&&e(this,kc,"m",xc).call(this)}get CanUseLocalStorage(){return i&&window.localStorage}get AvailableDevices(){return e(this,Oc,"f")}get CanGetDevices(){return i&&navigator.bluetooth?.getDevices}async GetDevices(){if(!i)return void zc.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void zc.warn("bluetooth is not available in this browser");if(o)return void zc.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void zc.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void zc.log("CanGetDevices is false");e(this,Lc,"f")||e(this,kc,"m",xc).call(this);const t=e(this,Lc,"f");if(!t.devices||0==t.devices.length)return void zc.log("no devices found in configuration");const s=await navigator.bluetooth.getDevices();return zc.log({bluetoothDevices:s}),s.forEach((s=>{if(!s.gatt)return;let i=t.devices.find((e=>s.id==e.bluetoothId));if(!i)return;let n=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));const a=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));if(a)return void(n&&n?.bluetoothId==a.bluetoothId&&n!=a&&(this.AvailableDevices[e(this,Oc,"f").indexOf(a)]=n));if(n)return void this.AvailableDevices.push(n);const r=new wl,o=new _o;o.device=s,s.name&&r._informationManager.updateName(s.name),r._informationManager.updateType(i.type),r.connectionManager=o,this.AvailableDevices.push(r)})),e(this,kc,"m",Vc).call(this),this.AvailableDevices}get AddEventListener(){return e(this,Bc,"f").addEventListener}get RemoveEventListener(){return e(this,Bc,"f").removeEventListener}get RemoveEventListeners(){return e(this,Bc,"f").removeEventListeners}get RemoveAllEventListeners(){return e(this,Bc,"f").removeAllEventListeners}_CheckDeviceAvailability(t){t.isConnected||t.isAvailable||!e(this,Oc,"f").includes(t)||(zc.log("removing device from availableDevices..."),e(this,Oc,"f").splice(e(this,Oc,"f").indexOf(t),1),e(this,kc,"m",Vc).call(this))}}Wc=new WeakMap,Ic=new WeakMap,Rc=new WeakMap,Uc=new WeakMap,Lc=new WeakMap,Ac=new WeakMap,Oc=new WeakMap,Bc=new WeakMap,kc=new WeakSet,Tc=function(t){e(this,Rc,"f")&&e(this,kc,"m",$c).call(this,t.target)},_c=function(){zc.assertWithError(i,"localStorage is only available in the browser"),zc.assertWithError(window.localStorage,"localStorage not found")},Fc=function(){e(this,kc,"m",_c).call(this),localStorage.setItem(e(this,Ac,"f"),JSON.stringify(e(this,Lc,"f")))},xc=async function(){e(this,kc,"m",_c).call(this);let s=localStorage.getItem(e(this,Ac,"f"));if("string"!=typeof s)return zc.log("no info found in localStorage"),t(this,Lc,Object.assign({},e(this,Uc,"f")),"f"),void e(this,kc,"m",Fc).call(this);try{const e=JSON.parse(s);zc.log({configuration:e}),t(this,Lc,e,"f"),this.CanGetDevices&&await this.GetDevices()}catch(e){zc.error(e)}},$c=function(t){if("webBluetooth"!=t.connectionType)return void zc.log("localStorage is only for webBluetooth devices");e(this,kc,"m",_c).call(this);const s=e(this,Lc,"f").devices.findIndex((e=>e.bluetoothId==t.bluetoothId));-1!=s&&(e(this,Lc,"f").devices[s].type=t.type,e(this,kc,"m",Fc).call(this))},Nc=function(){return e(this,Bc,"f").dispatchEvent},Pc=function(t){const{target:s}=t;if(s.isConnected)if(e(this,Ic,"f").includes(s))zc.log("device already included");else{if(zc.log("adding device",s),e(this,Ic,"f").push(s),this.UseLocalStorage&&"webBluetooth"==s.connectionType){const t={type:s.type,bluetoothId:s.bluetoothId,ipAddress:s.ipAddress,isWifiSecure:s.isWifiSecure},i=e(this,Lc,"f").devices.findIndex((e=>e.bluetoothId==t.bluetoothId));-1==i?e(this,Lc,"f").devices.push(t):e(this,Lc,"f").devices[i]=t,e(this,kc,"m",Fc).call(this)}e(this,kc,"a",Nc).call(this,"deviceConnected",{device:s}),e(this,kc,"a",Nc).call(this,"deviceIsConnected",{device:s}),e(this,kc,"m",qc).call(this)}else e(this,Ic,"f").includes(s)?(zc.log("removing device",s),e(this,Ic,"f").splice(e(this,Ic,"f").indexOf(s),1),e(this,kc,"a",Nc).call(this,"deviceDisconnected",{device:s}),e(this,kc,"a",Nc).call(this,"deviceIsConnected",{device:s}),e(this,kc,"m",qc).call(this)):zc.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),s.isConnected&&!this.AvailableDevices.includes(s)){const t=this.AvailableDevices.find((e=>e.bluetoothId==s.bluetoothId));zc.log({existingAvailableDevice:t}),t?this.AvailableDevices[this.AvailableDevices.indexOf(t)]=s:this.AvailableDevices.push(s),e(this,kc,"m",Vc).call(this)}this._CheckDeviceAvailability(s)},Vc=function(){zc.log({AvailableDevices:this.AvailableDevices}),e(this,kc,"a",Nc).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},qc=function(){zc.log({ConnectedDevices:this.ConnectedDevices}),e(this,kc,"a",Nc).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},Gc.shared=new Gc;var Hc=Gc.shared;const Jc=W("ServerUtils",{log:!1}),Kc=["isScanningAvailable","isScanning","startScan","stopScan","discoveredDevice","discoveredDevices","expiredDiscoveredDevice","connectToDevice","disconnectFromDevice","connectedDevices","deviceMessage","requiredDeviceInformation"];function Qc(e,...t){Jc.log("createMessage",...t);const s=t.map((t=>{"string"==typeof t&&(t={type:t}),null!=t.data?Array.isArray(t.data)||(t.data=[t.data]):t.data=[];const s=j(...t.data),i=s.byteLength;Jc.assertEnumWithError(t.type,e);const n=e.indexOf(t.type),a=new DataView(new ArrayBuffer(2));return a.setUint16(0,i,!0),j(n,a,s)}));return Jc.log("messageBuffers",...s),j(...s)}function Zc(...e){return Jc.log("createServerMessage",...e),Qc(Kc,...e)}function Xc(...e){return Jc.log("createClientDeviceMessage",...e),Qc(Yr,...e)}Zc("isScanningAvailable"),Zc("isScanning"),Zc("startScan"),Zc("stopScan"),Zc("discoveredDevices");const Yc=W("WebSocketUtils",{log:!1}),eh=["ping","pong","serverMessage"];function th(...e){return Yc.log("createWebSocketMessage",...e),Qc(eh,...e)}var sh,ih,nh,ah,rh,oh,ch,hh,lh,fh,gh,uh,dh,ph,mh,vh,wh,yh;th("ping"),th("pong");const bh=W("WebSocketConnectionManager",{log:!1}),Sh=["ping","pong","batteryLevel","deviceInformation","message"];const Ch=["deviceInformation","batteryLevel"];class Eh extends eo{get bluetoothId(){return e(this,ih,"f")??""}constructor(s,i=!1,n){super(),sh.add(this),ih.set(this,void 0),this.defaultMtu=1024,nh.set(this,void 0),ah.set(this,void 0),rh.set(this,!1),hh.set(this,{open:e(this,sh,"m",lh).bind(this),message:e(this,sh,"m",fh).bind(this),close:e(this,sh,"m",gh).bind(this),error:e(this,sh,"m",uh).bind(this)}),mh.set(this,new x(e(this,sh,"m",vh).bind(this),29e3)),this.ipAddress=s,this.isSecure=i,this.mtu=this.defaultMtu,t(this,ih,n,"f")}get isAvailable(){return!0}static get isSupported(){return!0}static get type(){return"webSocket"}get webSocket(){return e(this,nh,"f")}set webSocket(s){e(this,nh,"f")!=s?(bh.log("assigning webSocket",s),e(this,nh,"f")&&(io(e(this,nh,"f"),e(this,hh,"f")),e(this,nh,"f").readyState==e(this,nh,"f").OPEN&&e(this,nh,"f").close()),s&&so(s,e(this,hh,"f")),t(this,nh,s,"f"),bh.log("assigned webSocket")):bh.log("redundant webSocket assignment")}get ipAddress(){return e(this,ah,"f")}set ipAddress(s){this.assertIsNotConnected(),e(this,ah,"f")!=s?(t(this,ah,s,"f"),bh.log(`updated ipAddress to "${this.ipAddress}"`)):bh.log(`redundnant ipAddress assignment "${s}"`)}get isSecure(){return e(this,rh,"f")}set isSecure(s){this.assertIsNotConnected(),e(this,rh,"f")!=s?(t(this,rh,s,"f"),bh.log(`updated isSecure to "${this.isSecure}"`)):bh.log(`redundant isSecure assignment ${s}`)}get url(){return`${this.isSecure?"wss":"ws"}://${this.ipAddress}/ws`}async connect(){await super.connect();try{this.webSocket=new WebSocket(this.url)}catch(e){bh.error("error connecting to webSocket",e),this.status="notConnected"}}async disconnect(){await super.disconnect(),bh.log("closing websocket"),e(this,mh,"f").stop(),e(this,nh,"f")?.close()}get canReconnect(){return Boolean(this.webSocket)}async reconnect(){await super.reconnect(),this.webSocket=new WebSocket(this.url)}async sendSmpMessage(e){super.sendSmpMessage(e),bh.error("smp not supported on webSockets")}async sendTxData(t){await super.sendTxData(t),0!=t.byteLength&&e(this,sh,"m",ch).call(this,{type:"message",data:t})}remove(){super.remove(),this.webSocket=void 0}}var Mh,Dh,kh,Wh,Th,Ih,Rh,Uh,Lh,_h,Ah,Fh,xh,$h,Oh,Bh,Nh,Ph,Vh,qh,zh,jh,Gh,Hh,Jh,Kh,Qh,Zh,Xh,Yh,el,tl,sl,il,nl,al,rl,ol,cl,hl,ll,fl,gl,ul,dl;ih=new WeakMap,nh=new WeakMap,ah=new WeakMap,rh=new WeakMap,hh=new WeakMap,mh=new WeakMap,sh=new WeakSet,oh=function(t){this.assertIsConnected(),bh.log("sending webSocket message",t),e(this,nh,"f").send(t),e(this,mh,"f").restart()},ch=function(...t){e(this,sh,"m",oh).call(this,function(...e){return bh.log("createWebSocketMessage",...e),Qc(Sh,...e)}(...t))},lh=function(t){bh.log("webSocket.open",t),e(this,mh,"f").start(),this.status="connected",e(this,sh,"m",yh).call(this)},fh=async function(t){const s=await t.data.arrayBuffer(),i=new DataView(s);bh.log(`webSocket.message (${i.byteLength} bytes)`),e(this,sh,"m",dh).call(this,i)},gh=function(t){bh.log("webSocket.close",t),this.status="notConnected",e(this,mh,"f").stop()},uh=function(e){bh.error("webSocket.error",e)},dh=function(t){Dt(t,Sh,e(this,sh,"m",ph).bind(this),null,!0)},ph=function(t,s){switch(bh.log(`received "${t}" message (${s.byteLength} bytes)`),t){case"ping":e(this,sh,"m",wh).call(this);break;case"pong":break;case"batteryLevel":this.onMessageReceived?.("batteryLevel",s);break;case"deviceInformation":Dt(s,ln,((e,t)=>{this.onMessageReceived(e,t)}));break;case"message":this.parseRxMessage(s);break;default:bh.error(`uncaught messageType "${t}"`)}},vh=function(){bh.log("pinging"),e(this,sh,"m",ch).call(this,"ping")},wh=function(){bh.log("ponging"),e(this,sh,"m",ch).call(this,"pong")},yh=function(){e(this,sh,"m",ch).call(this,...Ch)};const pl=W("Device",{log:!1}),ml=["connectionMessage",...Kr,...Xr,...Zr,...$n,...fn,...vi,...Xs,...ha,...ze,...Xi,...Pa,...cs,...zs,...Lr,...Ec],vl=["isCharging","getBatteryCurrent","getId","getMtu","getName","getType","getCurrentTime","getSensorConfiguration","getSensorScalars","getVibrationLocations","getFileTypes","isWifiAvailable"];class wl{get bluetoothId(){return e(this,Ih,"f")?.bluetoothId}get isAvailable(){return e(this,Ih,"f")?.isAvailable}constructor(){Mh.add(this),Wh.set(this,new U(this,ml)),Ih.set(this,void 0),this.sendTxMessages=e(this,Mh,"m",Rh).bind(this),Uh.set(this,!1),Oh.set(this,Dh.ReconnectOnDisconnection),Bh.set(this,void 0),this.latestConnectionMessages=new Map,Hh.set(this,new gn),Jh.set(this,0),this._informationManager=new On,Qh.set(this,new wi),Xh.set(this,Dh.ClearSensorConfigurationOnLeave),Yh.set(this,new Ys),el.set(this,new ma),tl.set(this,new Ge),sl.set(this,new sn),il.set(this,new Dc),this.sendSmpMessage=e(this,Mh,"m",al).bind(this),rl.set(this,!1),ol.set(this,new Va),cl.set(this,new hs),ll.set(this,new js),ul.set(this,new _r),e(this,Hh,"f").eventDispatcher=e(this,Wh,"f"),this._informationManager.sendMessage=this.sendTxMessages,this._informationManager.eventDispatcher=e(this,Wh,"f"),e(this,Qh,"f").sendMessage=this.sendTxMessages,e(this,Qh,"f").eventDispatcher=e(this,Wh,"f"),e(this,Yh,"f").eventDispatcher=e(this,Wh,"f"),e(this,el,"f").sendMessage=this.sendTxMessages,e(this,el,"f").eventDispatcher=e(this,Wh,"f"),e(this,sl,"f").sendMessage=this.sendTxMessages,e(this,sl,"f").eventDispatcher=e(this,Wh,"f"),e(this,tl,"f").sendMessage=this.sendTxMessages,e(this,tl,"f").eventDispatcher=e(this,Wh,"f"),e(this,ol,"f").sendMessage=this.sendTxMessages,e(this,ol,"f").eventDispatcher=e(this,Wh,"f"),e(this,cl,"f").sendMessage=this.sendTxMessages,e(this,cl,"f").eventDispatcher=e(this,Wh,"f"),e(this,ll,"f").sendMessage=this.sendTxMessages,e(this,ll,"f").eventDispatcher=e(this,Wh,"f"),e(this,ul,"f").sendMessage=this.sendTxMessages,e(this,ul,"f").eventDispatcher=e(this,Wh,"f"),e(this,il,"f").sendMessage=this.sendSmpMessage,e(this,il,"f").eventDispatcher=e(this,Wh,"f"),this.addEventListener("getMtu",(()=>{e(this,il,"f").mtu=this.mtu,e(this,tl,"f").mtu=this.mtu,this.connectionManager.mtu=this.mtu,e(this,ul,"f").mtu=this.mtu})),this.addEventListener("getSensorConfiguration",(()=>{if("connecting"==this.connectionStatus){if(this.sensorTypes.includes("pressure")){pl.log("requesting required pressure information");const e=Zs.map((e=>({type:e})));this.sendTxMessages(e,!1)}else pl.log("don't need to request pressure infomration");if(this.sensorTypes.includes("camera")){pl.log("requesting required camera information");const e=os.map((e=>({type:e})));this.sendTxMessages(e,!1)}else pl.log("don't need to request camera infomration");if(this.sensorTypes.includes("microphone")){pl.log("requesting required microphone information");const e=qs.map((e=>({type:e})));this.sendTxMessages(e,!1)}else pl.log("don't need to request microphone infomration")}})),this.addEventListener("getFileTypes",(()=>{"connecting"==this.connectionStatus&&(this.fileTypes.length>0&&e(this,tl,"f").requestRequiredInformation(),this.fileTypes.includes("tflite")&&e(this,sl,"f").requestRequiredInformation())})),this.addEventListener("isWifiAvailable",(()=>{"connecting"==this.connectionStatus&&("client"!=this.connectionType||n)&&this.isWifiAvailable&&"client"!=this.connectionType&&e(this,ol,"f").requestRequiredInformation()})),this.addEventListener("getType",(()=>{"connecting"==this.connectionStatus&&("client"!=this.connectionType||n)&&"glasses"==this.type&&"client"!=this.connectionType&&e(this,ul,"f").requestRequiredInformation()})),this.addEventListener("isDisplayAvailable",(()=>{"connecting"==this.connectionStatus&&("client"!=this.connectionType||n)&&this.isDisplayAvailable&&"client"!=this.connectionType&&e(this,ul,"f").requestRequiredInformation()})),Hc.onDevice(this),i&&window.addEventListener("beforeunload",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()})),n&&process.on("exit",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()}))}get addEventListener(){return e(this,Wh,"f").addEventListener}get removeEventListener(){return e(this,Wh,"f").removeEventListener}get waitForEvent(){return e(this,Wh,"f").waitForEvent}get removeEventListeners(){return e(this,Wh,"f").removeEventListeners}get removeAllEventListeners(){return e(this,Wh,"f").removeAllEventListeners}get connectionManager(){return e(this,Ih,"f")}set connectionManager(s){this.connectionManager!=s?(this.connectionManager&&this.connectionManager.remove(),s&&(s.onStatusUpdated=e(this,Mh,"m",Nh).bind(this),s.onMessageReceived=e(this,Mh,"m",jh).bind(this),s.onMessagesReceived=e(this,Mh,"m",Gh).bind(this)),t(this,Ih,s,"f"),pl.log("assigned new connectionManager",e(this,Ih,"f")),this._informationManager.connectionType=this.connectionType):pl.log("same connectionManager is already assigned")}async connect(t){if(pl.log("connect options",t),t)switch(t.type){case"webBluetooth":"webBluetooth"!=this.connectionType&&(this.connectionManager=new _o);break;case"webSocket":{let e=!1;if("webSocket"==this.connectionType){const s=this.connectionManager;s.ipAddress==t.ipAddress&&s.isSecure==t.isWifiSecure||(e=!0)}else e=!0;e&&(this.connectionManager=new Eh(t.ipAddress,t.isWifiSecure,this.bluetoothId))}break;case"udp":{let e=!1;if("udp"==this.connectionType){this.connectionManager.ipAddress!=t.ipAddress&&(e=!0),this.reconnectOnDisconnection=!0}else e=!0;e&&(this.connectionManager=new UDPConnectionManager(t.ipAddress,this.bluetoothId))}}if(this.connectionManager||(this.connectionManager=e(Dh,Dh,"m",kh).call(Dh)),e(this,Mh,"m",qh).call(this),"client"==t?.type){pl.assertWithError("client"==this.connectionType,"expected clientConnectionManager");const e=this.connectionManager;return e.subType=t.subType,e.connect()}return pl.log("connectionManager type",this.connectionManager.type),this.connectionManager.connect()}get isConnected(){return e(this,Uh,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return e(this,Mh,"m",xh).call(this),e(this,Mh,"m",qh).call(this),this.connectionManager?.reconnect()}static async Connect(){const e=new Dh;return await e.connect(),e}static get ReconnectOnDisconnection(){return e(this,Dh,"f",$h)}static set ReconnectOnDisconnection(e){pl.assertTypeWithError(e,"boolean"),t(this,Dh,e,"f",$h)}get reconnectOnDisconnection(){return e(this,Oh,"f")}set reconnectOnDisconnection(e){pl.assertTypeWithError(e,"boolean"),t(this,Oh,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return e(this,Mh,"m",Lh).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){if(this.isConnected)this.disconnect();else if(this.canReconnect)try{this.reconnect()}catch(e){pl.error("error trying to reconnect",e),this.connect()}else this.connect()}get connectionStatus(){switch(e(this,Ih,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return e(this,Ih,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return e(this,Hh,"f").information}get batteryLevel(){return e(this,Jh,"f")}get id(){return this._informationManager.id}get isCharging(){return this._informationManager.isCharging}get batteryCurrent(){return this._informationManager.batteryCurrent}get getBatteryCurrent(){return this._informationManager.getBatteryCurrent}get name(){return this._informationManager.name}get setName(){return this._informationManager.setName}get type(){return this._informationManager.type}get setType(){return this._informationManager.setType}get isInsole(){return this._informationManager.isInsole}get isGlove(){return this._informationManager.isGlove}get side(){return this._informationManager.side}get mtu(){return this._informationManager.mtu}get sensorTypes(){return Object.keys(this.sensorConfiguration)}get continuousSensorTypes(){return Ks.filter((e=>this.sensorTypes.includes(e)))}get sensorConfiguration(){return e(this,Qh,"f").configuration}async setSensorConfiguration(t,s){await e(this,Qh,"f").setConfiguration(t,s)}async clearSensorConfiguration(){return e(this,Qh,"f").clearSensorConfiguration()}static get ClearSensorConfigurationOnLeave(){return e(this,Dh,"f",Zh)}static set ClearSensorConfigurationOnLeave(e){pl.assertTypeWithError(e,"boolean"),t(this,Dh,e,"f",Zh)}get clearSensorConfigurationOnLeave(){return e(this,Xh,"f")}set clearSensorConfigurationOnLeave(e){pl.assertTypeWithError(e,"boolean"),t(this,Xh,e,"f")}get numberOfPressureSensors(){return e(this,Yh,"f").pressureSensorDataManager.numberOfSensors}resetPressureRange(){e(this,Yh,"f").pressureSensorDataManager.resetRange()}get vibrationLocations(){return e(this,el,"f").vibrationLocations}async triggerVibration(t,s){e(this,el,"f").triggerVibration(t,s)}get fileTypes(){return e(this,tl,"f").fileTypes}get maxFileLength(){return e(this,tl,"f").maxLength}get validFileTypes(){return Ne.filter((e=>!(e.includes("wifi")&&!this.isWifiAvailable)))}async sendFile(t,s){pl.assertWithError(this.validFileTypes.includes(t),`invalid fileType ${t}`);const i=this.waitForEvent("fileTransferComplete");e(this,tl,"f").send(t,s),await i}async receiveFile(t){const s=this.waitForEvent("fileTransferComplete");e(this,tl,"f").receive(t),await s}get fileTransferStatus(){return e(this,tl,"f").status}cancelFileTransfer(){e(this,tl,"f").cancel()}get tfliteName(){return e(this,sl,"f").name}get setTfliteName(){return e(this,sl,"f").setName}async sendTfliteConfiguration(t){t.type="tflite",e(this,sl,"f").sendConfiguration(t,!1);await e(this,tl,"f").send(t.type,t.file)||e(this,Mh,"m",Rh).call(this)}get tfliteTask(){return e(this,sl,"f").task}get setTfliteTask(){return e(this,sl,"f").setTask}get tfliteSampleRate(){return e(this,sl,"f").sampleRate}get setTfliteSampleRate(){return e(this,sl,"f").setSampleRate}get tfliteSensorTypes(){return e(this,sl,"f").sensorTypes}get allowedTfliteSensorTypes(){return this.sensorTypes.filter((e=>tn.includes(e)))}get setTfliteSensorTypes(){return e(this,sl,"f").setSensorTypes}get tfliteIsReady(){return e(this,sl,"f").isReady}get tfliteInferencingEnabled(){return e(this,sl,"f").inferencingEnabled}get setTfliteInferencingEnabled(){return e(this,sl,"f").setInferencingEnabled}async enableTfliteInferencing(){return this.setTfliteInferencingEnabled(!0)}async disableTfliteInferencing(){return this.setTfliteInferencingEnabled(!1)}get toggleTfliteInferencing(){return e(this,sl,"f").toggleInferencingEnabled}get tfliteCaptureDelay(){return e(this,sl,"f").captureDelay}get setTfliteCaptureDelay(){return e(this,sl,"f").setCaptureDelay}get tfliteThreshold(){return e(this,sl,"f").threshold}get setTfliteThreshold(){return e(this,sl,"f").setThreshold}get canUpdateFirmware(){return e(this,Ih,"f")?.canUpdateFirmware}get uploadFirmware(){return e(this,Mh,"m",nl).call(this),e(this,il,"f").uploadFirmware}get canReset(){return this.canUpdateFirmware}async reset(){return pl.assertWithError(this.canReset,"reset is not enabled for this device"),await e(this,il,"f").reset(),e(this,Ih,"f").disconnect()}get firmwareStatus(){return e(this,il,"f").status}get getFirmwareImages(){return e(this,Mh,"m",nl).call(this),e(this,il,"f").getImages}get firmwareImages(){return e(this,il,"f").images}get eraseFirmwareImage(){return e(this,Mh,"m",nl).call(this),e(this,il,"f").eraseImage}get confirmFirmwareImage(){return e(this,Mh,"m",nl).call(this),e(this,il,"f").confirmImage}get testFirmwareImage(){return e(this,Mh,"m",nl).call(this),e(this,il,"f").testImage}get isServerSide(){return e(this,rl,"f")}set isServerSide(s){e(this,rl,"f")!=s?(pl.log({newIsServerSide:s}),t(this,rl,s,"f"),e(this,tl,"f").isServerSide=this.isServerSide):pl.log("redundant isServerSide assignment")}get isUkaton(){return this.deviceInformation.modelNumber.includes("Ukaton")}get isWifiAvailable(){return e(this,ol,"f").isWifiAvailable}get wifiSSID(){return e(this,ol,"f").wifiSSID}async setWifiSSID(t){return e(this,ol,"f").setWifiSSID(t)}get wifiPassword(){return e(this,ol,"f").wifiPassword}async setWifiPassword(t){return e(this,ol,"f").setWifiPassword(t)}get isWifiConnected(){return e(this,ol,"f").isWifiConnected}get ipAddress(){return e(this,ol,"f").ipAddress}get wifiConnectionEnabled(){return e(this,ol,"f").wifiConnectionEnabled}get enableWifiConnection(){return e(this,ol,"f").enableWifiConnection}get setWifiConnectionEnabled(){return e(this,ol,"f").setWifiConnectionEnabled}get disableWifiConnection(){return e(this,ol,"f").disableWifiConnection}get toggleWifiConnection(){return e(this,ol,"f").toggleWifiConnection}get isWifiSecure(){return e(this,ol,"f").isWifiSecure}async reconnectViaWebSockets(){pl.assertWithError(this.isWifiConnected,"wifi is not connected"),pl.assertWithError("webSocket"!=this.connectionType,"already connected via webSockets"),pl.assertTypeWithError(this.ipAddress,"string"),pl.log("reconnecting via websockets..."),await this.disconnect(),await this.connect({type:"webSocket",ipAddress:this.ipAddress,isWifiSecure:this.isWifiSecure})}async reconnectViaUDP(){pl.assertWithError(n,"udp is only available in node"),pl.assertWithError(this.isWifiConnected,"wifi is not connected"),pl.assertWithError("udp"!=this.connectionType,"already connected via udp"),pl.assertTypeWithError(this.ipAddress,"string"),pl.log("reconnecting via udp..."),await this.disconnect(),await this.connect({type:"udp",ipAddress:this.ipAddress})}get hasCamera(){return this.sensorTypes.includes("camera")}get cameraStatus(){return e(this,cl,"f").cameraStatus}async takePicture(){e(this,Mh,"m",hl).call(this),await e(this,cl,"f").takePicture()}async focusCamera(){e(this,Mh,"m",hl).call(this),await e(this,cl,"f").focus()}async stopCamera(){e(this,Mh,"m",hl).call(this),await e(this,cl,"f").stop()}async wakeCamera(){e(this,Mh,"m",hl).call(this),await e(this,cl,"f").wake()}async sleepCamera(){e(this,Mh,"m",hl).call(this),await e(this,cl,"f").sleep()}get cameraConfiguration(){return e(this,cl,"f").cameraConfiguration}get availableCameraConfigurationTypes(){return e(this,cl,"f").availableCameraConfigurationTypes}get cameraConfigurationRanges(){return e(this,cl,"f").cameraConfigurationRanges}get setCameraConfiguration(){return e(this,cl,"f").setCameraConfiguration}get hasMicrophone(){return this.sensorTypes.includes("microphone")}get microphoneStatus(){return e(this,ll,"f").microphoneStatus}async startMicrophone(){e(this,Mh,"m",fl).call(this),await e(this,ll,"f").start()}async stopMicrophone(){e(this,Mh,"m",fl).call(this),await e(this,ll,"f").stop()}async enableMicrophoneVad(){e(this,Mh,"m",fl).call(this),await e(this,ll,"f").vad()}async toggleMicrophone(){e(this,Mh,"m",fl).call(this),await e(this,ll,"f").toggle()}get microphoneConfiguration(){return e(this,ll,"f").microphoneConfiguration}get availableMicrophoneConfigurationTypes(){return e(this,ll,"f").availableMicrophoneConfigurationTypes}get setMicrophoneConfiguration(){return e(this,ll,"f").setMicrophoneConfiguration}get audioContext(){return e(this,Mh,"m",gl).call(this),e(this,ll,"f").audioContext}set audioContext(t){e(this,Mh,"m",gl).call(this),e(this,ll,"f").audioContext=t}get microphoneMediaStreamDestination(){return e(this,Mh,"m",gl).call(this),e(this,ll,"f").mediaStreamDestination}get microphoneGainNode(){return e(this,Mh,"m",gl).call(this),e(this,ll,"f").gainNode}get isRecordingMicrophone(){return e(this,ll,"f").isRecording}startRecordingMicrophone(){e(this,Mh,"m",gl).call(this),e(this,ll,"f").startRecording()}stopRecordingMicrophone(){e(this,Mh,"m",gl).call(this),e(this,ll,"f").stopRecording()}toggleMicrophoneRecording(){e(this,Mh,"m",gl).call(this),e(this,ll,"f").toggleRecording()}get isDisplayAvailable(){return e(this,ul,"f").isDisplayAvailable}get displayStatus(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").displayStatus}get displayBrightness(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").displayBrightness}get setDisplayBrightness(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").setDisplayBrightness}get displayInformation(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").displayInformation}get numberOfDisplayColors(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").numberOfColors}get wakeDisplay(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").wake}get sleepDisplay(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").sleep}get toggleDisplay(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").toggle}get isDisplayAwake(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").isDisplayAwake}get showDisplay(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").showDisplay}get clearDisplay(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").clearDisplay}get setDisplayColor(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").setColor}get setDisplayColorOpacity(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").setColorOpacity}get setDisplayOpacity(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").setOpacity}get saveDisplayContext(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").saveContext}get restoreDisplayContext(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").restoreContext}get clearDisplayRect(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").clearRect}get selectDisplayFillColor(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").selectFillColor}get selectDisplayLineColor(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").selectLineColor}get setDisplayLineWidth(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").setLineWidth}get drawDisplayRect(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").drawRect}get drawDisplayCircle(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").drawCircle}get drawDisplayEllipse(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").drawEllipse}get drawDisplayRoundRect(){return e(this,Mh,"m",dl).call(this),e(this,ul,"f").drawRoundRect}}var yl,bl,Sl,Cl,El,Ml;Dh=wl,Wh=new WeakMap,Ih=new WeakMap,Uh=new WeakMap,Oh=new WeakMap,Bh=new WeakMap,Hh=new WeakMap,Jh=new WeakMap,Qh=new WeakMap,Xh=new WeakMap,Yh=new WeakMap,el=new WeakMap,tl=new WeakMap,sl=new WeakMap,il=new WeakMap,rl=new WeakMap,ol=new WeakMap,cl=new WeakMap,ll=new WeakMap,ul=new WeakMap,Mh=new WeakSet,kh=function(){return new _o},Th=function(){return e(this,Wh,"f").dispatchEvent},Rh=async function(t,s){await(e(this,Ih,"f")?.sendTxMessages(t,s))},Lh=function(){pl.assertWithError(this.isConnected,"notConnected")},_h=function(e){return e.every((e=>{const t=this.latestConnectionMessages.has(e);return t||pl.log(`didn't receive "${e}" message`),t}))},Ah=function(){let t=e(this,Mh,"m",_h).call(this,vl);return t&&this.sensorTypes.includes("pressure")&&(t=e(this,Mh,"m",_h).call(this,Zs)),t&&this.isWifiAvailable&&(t=e(this,Mh,"m",_h).call(this,Na)),t&&this.fileTypes.length>0&&(t=e(this,Mh,"m",_h).call(this,je)),t&&this.fileTypes.includes("tflite")&&(t=e(this,Mh,"m",_h).call(this,Yi)),t&&this.hasCamera&&(t=e(this,Mh,"m",_h).call(this,os)),t&&this.hasMicrophone&&(t=e(this,Mh,"m",_h).call(this,qs)),t&&this.isDisplayAvailable&&(t=e(this,Mh,"m",_h).call(this,Ur)),t},Fh=function(){pl.log("requesting required information");const t=vl.map((e=>({type:e})));e(this,Mh,"m",Rh).call(this,t)},xh=function(){pl.assertWithError(this.canReconnect,"cannot reconnect to device")},Nh=function(s){pl.log({connectionStatus:s}),"notConnected"==s?(e(this,Mh,"m",zh).call(this),this.canReconnect&&this.reconnectOnDisconnection&&(pl.log("starting reconnect interval..."),t(this,Bh,setInterval((()=>{pl.log("attempting reconnect..."),this.reconnect()}),1e3),"f"))):null!=e(this,Bh,"f")&&(pl.log("clearing reconnect interval"),clearInterval(e(this,Bh,"f")),t(this,Bh,void 0,"f")),e(this,Mh,"m",Vh).call(this),"connected"!=s||e(this,Uh,"f")||"client"!=this.connectionType&&e(this,Mh,"m",Fh).call(this),Hc.OnDeviceConnectionStatusUpdated(this,s)},Ph=function(t=!1){e(this,Mh,"a",Th).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),e(this,Mh,"a",Th).call(this,this.connectionStatus,{}),t&&e(this,Mh,"a",Th).call(this,"isConnected",{isConnected:this.isConnected})},Vh=function(){switch(t(this,Uh,Boolean(this.connectionManager?.isConnected)&&e(this,Mh,"a",Ah)&&this._informationManager.isCurrentTimeSet,"f"),this.connectionStatus){case"connected":e(this,Uh,"f")&&e(this,Mh,"m",Ph).call(this,!0);break;case"notConnected":e(this,Mh,"m",Ph).call(this,!0);break;default:e(this,Mh,"m",Ph).call(this,!1)}},qh=function(){e(this,Mh,"m",zh).call(this),this._informationManager.clear(),e(this,Hh,"f").clear(),e(this,sl,"f").clear(),e(this,ol,"f").clear(),e(this,cl,"f").clear(),e(this,ll,"f").clear(),e(this,ul,"f").clear()},zh=function(){this.connectionManager?.clear(),this.latestConnectionMessages.clear()},jh=function(t,s){if(pl.log({messageType:t,dataView:s}),"batteryLevel"===t){const t=s.getUint8(0);pl.log("received battery level",{batteryLevel:t}),e(this,Mh,"m",Kh).call(this,t)}else if(Be.includes(t))e(this,tl,"f").parseMessage(t,s);else if(Zi.includes(t))e(this,sl,"f").parseMessage(t,s);else if(Qs.includes(t))e(this,Yh,"f").parseMessage(t,s);else if(Cc.includes(t))e(this,il,"f").parseMessage(t,s);else if(ln.includes(t))e(this,Hh,"f").parseMessage(t,s);else if(xn.includes(t))this._informationManager.parseMessage(t,s);else if(mi.includes(t))e(this,Qh,"f").parseMessage(t,s);else if(ca.includes(t))e(this,el,"f").parseMessage(t,s);else if(Ba.includes(t))e(this,ol,"f").parseMessage(t,s);else if(rs.includes(t))e(this,cl,"f").parseMessage(t,s);else if(Ps.includes(t))e(this,ll,"f").parseMessage(t,s);else{if(!Tr.includes(t))throw Error(`uncaught messageType ${t}`);e(this,ul,"f").parseMessage(t,s)}this.latestConnectionMessages.set(t,s),t.startsWith("set")&&this.latestConnectionMessages.set(t.replace("set","get"),s),e(this,Mh,"a",Th).call(this,"connectionMessage",{messageType:t,dataView:s})},Gh=function(){!this.isConnected&&e(this,Mh,"a",Ah)&&e(this,Mh,"m",Vh).call(this),"notConnected"!=this.connectionStatus&&e(this,Mh,"m",Rh).call(this)},Kh=function(s){pl.assertTypeWithError(s,"number"),e(this,Jh,"f")!=s?(t(this,Jh,s,"f"),pl.log({updatedBatteryLevel:e(this,Jh,"f")}),e(this,Mh,"a",Th).call(this,"batteryLevel",{batteryLevel:e(this,Jh,"f")})):pl.log(`duplicate batteryLevel assignment ${s}`)},nl=function(){pl.assertWithError(this.canUpdateFirmware,"can't update firmware")},al=function(t){return e(this,Mh,"m",nl).call(this),e(this,Ih,"f").sendSmpMessage(t)},hl=function(){pl.assertWithError(this.hasCamera,"camera not available")},fl=function(){pl.assertWithError(this.hasMicrophone,"microphone not available")},gl=function(){pl.assertWithError(AudioContext,"WebAudio is not supported")},dl=function(){pl.assertWithError(this.isDisplayAvailable,"display not available")},$h={value:!1},Zh={value:!0};const Dl=W("DevicePairPressureSensorDataManager",{log:!1});class kl{constructor(){yl.add(this),bl.set(this,{}),Sl.set(this,new ot),Cl.set(this,new tt),this.resetPressureRange()}resetPressureRange(){e(this,Sl,"f").reset(),e(this,Cl,"f").reset()}onDevicePressureData(t){const{pressure:s}=t.message,{side:i}=t.target;if(Dl.log({pressure:s,side:i}),e(this,bl,"f")[i]=s,e(this,yl,"a",El))return e(this,yl,"m",Ml).call(this);Dl.log("doesn't have all pressure data yet...")}}var Wl;bl=new WeakMap,Sl=new WeakMap,Cl=new WeakMap,yl=new WeakSet,El=function(){return _n.every((t=>t in e(this,bl,"f")))},Ml=function(){const t={scaledSum:0,normalizedSum:0,sensors:{left:[],right:[]}};return _n.forEach((s=>{const i=e(this,bl,"f")[s];t.scaledSum+=i.scaledSum})),t.normalizedSum+=e(this,Cl,"f").updateAndGetNormalization(t.scaledSum,!1),t.scaledSum>0&&(t.center={x:0,y:0},_n.forEach((s=>{e(this,bl,"f")[s].sensors.forEach((e=>{const i={...e};i.weightedValue=e.scaledValue/t.scaledSum;let{x:n,y:a}=e.position;n/=2,"right"==s&&(n+=.5),i.position={x:n,y:a},t.center.x+=i.position.x*i.weightedValue,t.center.y+=i.position.y*i.weightedValue,t.sensors[s].push(i)}))})),t.normalizedCenter=e(this,Sl,"f").updateAndGetNormalization(t.center,!1)),Dl.log({devicePairPressure:t}),t};const Tl=W("DevicePairSensorDataManager",{log:!1}),Il=["pressure","sensorData"];class Rl{constructor(){Wl.set(this,{}),this.pressureSensorDataManager=new kl}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}resetPressureRange(){this.pressureSensorDataManager.resetPressureRange()}onDeviceSensorData(t){const{timestamp:s,sensorType:i}=t.message;let n;if(Tl.log({sensorType:i,timestamp:s,event:t}),e(this,Wl,"f")[i]||(e(this,Wl,"f")[i]={}),e(this,Wl,"f")[i][t.target.side]=s,"pressure"===i)n=this.pressureSensorDataManager.onDevicePressureData(t);else Tl.log(`uncaught sensorType "${i}"`);if(n){const t=Object.assign({},e(this,Wl,"f")[i]);this.dispatchEvent(i,{sensorType:i,timestamps:t,[i]:n}),this.dispatchEvent("sensorData",{sensorType:i,timestamps:t,[i]:n})}else Tl.log("no value received")}}var Ul,Ll,_l,Al,Fl,xl,$l,Ol,Bl,Nl,Pl,Vl,ql,zl,jl,Gl,Hl,Jl,Kl;Wl=new WeakMap;const Ql=W("DevicePair",{log:!1});function Zl(e){return`device${t=e,t[0].toUpperCase()+t.slice(1)}`;var t}const Xl=["isConnected",...Il,...ml.map((e=>Zl(e)))],Yl=["insoles","gloves"];class ef{constructor(s){Ul.add(this),_l.set(this,void 0),Al.set(this,new U(this,Xl)),xl.set(this,void 0),$l.set(this,void 0),Vl.set(this,{isConnected:e(this,Ul,"m",zl).bind(this),sensorData:e(this,Ul,"m",Hl).bind(this),getType:e(this,Ul,"m",jl).bind(this)}),Gl.set(this,new Rl),t(this,_l,s,"f"),e(this,Gl,"f").eventDispatcher=e(this,Al,"f")}get sides(){return _n}get type(){return e(this,_l,"f")}get addEventListener(){return e(this,Al,"f").addEventListener}get removeEventListener(){return e(this,Al,"f").removeEventListener}get waitForEvent(){return e(this,Al,"f").waitForEvent}get removeEventListeners(){return e(this,Al,"f").removeEventListeners}get removeAllEventListeners(){return e(this,Al,"f").removeAllEventListeners}get left(){return e(this,xl,"f")}get right(){return e(this,$l,"f")}get isConnected(){return _n.every((e=>this[e]?.isConnected))}get isPartiallyConnected(){return _n.some((e=>this[e]?.isConnected))}get isHalfConnected(){return this.isPartiallyConnected&&!this.isConnected}assignDevice(s){if(!e(this,Ul,"m",Ol).call(this,s))return void Ql.log(`device is incorrect type ${s.type} for ${this.type} devicePair`);const i=s.side,n=this[i];if(s!=n){switch(n&&e(this,Ul,"m",Nl).call(this,n),e(this,Ul,"m",Bl).call(this,s),i){case"left":t(this,xl,s,"f");break;case"right":t(this,$l,s,"f")}return Ql.log(`assigned ${i} ${this.type} device`,s),this.resetPressureRange(),e(this,Ul,"a",Fl).call(this,"isConnected",{isConnected:this.isConnected}),e(this,Ul,"a",Fl).call(this,"deviceIsConnected",{device:s,isConnected:s.isConnected,side:i}),n}Ql.log("device already assigned")}async setSensorConfiguration(e){for(let t=0;t<_n.length;t++){const s=_n[t];this[s]?.isConnected&&await this[s].setSensorConfiguration(e)}}resetPressureRange(){_n.forEach((e=>this[e]?.resetPressureRange())),e(this,Gl,"f").resetPressureRange()}async triggerVibration(e,t){const s=_n.map((s=>this[s]?.triggerVibration(e,t))).filter(Boolean);return Promise.allSettled(s)}static get insoles(){return e(this,Ll,"f",Jl)}static get gloves(){return e(this,Ll,"f",Kl)}}var tf,sf,nf,af,rf;Ll=ef,_l=new WeakMap,Al=new WeakMap,xl=new WeakMap,$l=new WeakMap,Vl=new WeakMap,Gl=new WeakMap,Ul=new WeakSet,Fl=function(){return e(this,Al,"f").dispatchEvent},Ol=function(e){switch(this.type){case"insoles":return e.isInsole;case"gloves":return e.isGlove}},Bl=function(t){so(t,e(this,Vl,"f")),ml.forEach((s=>{t.addEventListener(s,e(this,Ul,"m",ql).bind(this))}))},Nl=function(t){io(t,e(this,Vl,"f")),ml.forEach((s=>{t.removeEventListener(s,e(this,Ul,"m",ql).bind(this))}))},Pl=function(s){const i=_n.some((i=>{if(this[i]!=s)return!1;switch(Ql.log(`removing ${i} ${this.type} device`,s),io(s,e(this,Vl,"f")),i){case"left":t(this,xl,void 0,"f");break;case"right":t(this,$l,void 0,"f")}return!0}));return i&&e(this,Ul,"a",Fl).call(this,"isConnected",{isConnected:this.isConnected}),i},ql=function(t){const{type:s,target:i,message:n}=t;e(this,Ul,"a",Fl).call(this,Zl(s),{...n,device:i,side:i.side})},zl=function(t){e(this,Ul,"a",Fl).call(this,"isConnected",{isConnected:this.isConnected})},jl=function(t){const{target:s}=t;if(this[s.side]==s)return;e(this,Ul,"m",Pl).call(this,s)&&this.assignDevice(s)},Hl=function(t){this.isConnected&&e(this,Gl,"f").onDeviceSensorData(t)},Jl={value:new Ll("insoles")},Kl={value:new Ll("gloves")},Hc.AddEventListener("deviceConnected",(t=>{const{device:s}=t.message;s.isInsole&&e(Ll,Ll,"f",Jl).assignDevice(s),s.isGlove&&e(Ll,Ll,"f",Kl).assignDevice(s)}));const of=W("ClientConnectionManager",{log:!1});class cf extends eo{constructor(){super(...arguments),tf.add(this),sf.set(this,void 0),nf.set(this,!1)}static get isSupported(){return i}static get type(){return"client"}get canUpdateFirmware(){return!1}get bluetoothId(){return e(this,sf,"f")}set bluetoothId(s){of.assertTypeWithError(s,"string"),e(this,sf,"f")!=s?t(this,sf,s,"f"):of.log("redundant bluetoothId assignment")}get isConnected(){return e(this,nf,"f")}set isConnected(s){of.assertTypeWithError(s,"boolean"),e(this,nf,"f")!=s?(t(this,nf,s,"f"),this.status=e(this,nf,"f")?"connected":"notConnected",this.isConnected&&e(this,tf,"m",af).call(this)):of.log("redundant newIsConnected assignment",s)}get isAvailable(){return this.client.isConnected}async connect(){await super.connect(),this.sendClientConnectMessage(this.subType)}async disconnect(){await super.disconnect(),this.sendClientDisconnectMessage()}get canReconnect(){return!0}async reconnect(){await super.reconnect(),this.sendClientConnectMessage()}async sendSmpMessage(e){super.sendSmpMessage(e),this.sendClientMessage({type:"smp",data:e})}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&this.sendClientMessage({type:"tx",data:e})}onClientMessage(t){of.log({dataView:t}),Dt(t,ml,e(this,tf,"m",rf).bind(this),null,!0),this.onMessagesReceived()}}var hf,lf,ff,gf,uf,df,pf,mf,vf,wf,yf,bf,Sf,Cf,Ef,Mf,Df,kf,Wf,Tf,If,Rf,Uf,Lf;sf=new WeakMap,nf=new WeakMap,tf=new WeakSet,af=function(){this.sendRequiredDeviceInformationMessage()},rf=function(e,t){let s=0;switch(of.log({messageType:e},t),e){case"isConnected":const i=Boolean(t.getUint8(s++));of.log({isConnected:i}),this.isConnected=i;break;case"rx":this.parseRxMessage(t);break;default:this.onMessageReceived(e,t)}};const _f=W("BaseClient",{log:!1}),Af=["notConnected","connecting","connected","disconnecting","connectionStatus","isConnected","isScanningAvailable","isScanning","discoveredDevice","expiredDiscoveredDevice"];class Ff{constructor(){hf.add(this),gf.set(this,{}),uf.set(this,new U(this,Af)),this._reconnectOnDisconnection=this.baseConstructor.ReconnectOnDisconnection,df.set(this,"notConnected"),vf.set(this,[]),bf.set(this,!1),Mf.set(this,!1),Rf.set(this,{})}get baseConstructor(){return this.constructor}get devices(){return e(this,gf,"f")}get addEventListener(){return e(this,uf,"f").addEventListener}get dispatchEvent(){return e(this,uf,"f").dispatchEvent}get removeEventListener(){return e(this,uf,"f").removeEventListener}get waitForEvent(){return e(this,uf,"f").waitForEvent}assertConnection(){_f.assertWithError(this.isConnected,"notConnected")}assertDisconnection(){_f.assertWithError(this.isDisconnected,"not disconnected")}static get ReconnectOnDisconnection(){return this._reconnectOnDisconnection}static set ReconnectOnDisconnection(e){_f.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get reconnectOnDisconnection(){return this._reconnectOnDisconnection}set reconnectOnDisconnection(e){_f.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get _connectionStatus(){return e(this,df,"f")}set _connectionStatus(s){switch(_f.assertTypeWithError(s,"string"),_f.log({newConnectionStatus:s}),t(this,df,s,"f"),this.dispatchEvent("connectionStatus",{connectionStatus:this.connectionStatus}),this.dispatchEvent(this.connectionStatus,{}),s){case"connected":case"notConnected":this.dispatchEvent("isConnected",{isConnected:this.isConnected}),this.isConnected||e(this,hf,"m",ff).call(this)}}get connectionStatus(){return this._connectionStatus}_sendRequiredMessages(){_f.log("sending required messages",e(this,vf,"f")),this.sendServerMessage(...e(this,hf,"a",mf))}parseMessage(t){_f.log("parseMessage",{dataView:t}),Dt(t,Kc,e(this,hf,"m",yf).bind(this),null,!0),e(this,hf,"m",wf).call(this)}get isScanningAvailable(){return e(this,hf,"a",Sf)}requestIsScanningAvailable(){this.sendServerMessage("isScanningAvailable")}get isScanning(){return e(this,hf,"a",Df)}startScan(){e(this,hf,"m",If).call(this),this.sendServerMessage("startScan")}stopScan(){e(this,hf,"m",Tf).call(this),this.sendServerMessage("stopScan")}toggleScan(){e(this,hf,"m",Ef).call(this),this.isScanning?this.stopScan():this.startScan()}get discoveredDevices(){return e(this,Rf,"f")}onDiscoveredDevice(t){_f.log({discoveredDevice:t}),e(this,Rf,"f")[t.bluetoothId]=t,this.dispatchEvent("discoveredDevice",{discoveredDevice:t})}requestDiscoveredDevices(){this.sendServerMessage({type:"discoveredDevices"})}connectToDevice(e,t){return this.requestConnectionToDevice(e,t)}requestConnectionToDevice(t,s){this.assertConnection(),_f.assertTypeWithError(t,"string");const i=e(this,hf,"m",Lf).call(this,t);return s?i.connect({type:"client",subType:s}):i.connect(),i}sendConnectToDeviceMessage(e,t){t?this.sendServerMessage({type:"connectToDevice",data:j(G(e),Hr.indexOf(t))}):this.sendServerMessage({type:"connectToDevice",data:e})}createDevice(t){const s=new wl,i=e(this,Rf,"f")[t],n=new cf;return n.discoveredDevice=Object.assign({},i),n.client=this,n.bluetoothId=t,n.sendClientMessage=this.sendDeviceMessage.bind(this,t),n.sendRequiredDeviceInformationMessage=this.sendRequiredDeviceInformationMessage.bind(this,t),n.sendClientConnectMessage=this.sendConnectToDeviceMessage.bind(this,t),n.sendClientDisconnectMessage=this.sendDisconnectFromDeviceMessage.bind(this,t),s.connectionManager=n,s}onConnectedBluetoothDeviceIds(t){_f.log({bluetoothIds:t}),t.forEach((t=>{const s=e(this,hf,"m",Lf).call(this,t);s.connectionManager.isConnected=!0,Hc._CheckDeviceAvailability(s)}))}disconnectFromDevice(e){this.requestDisconnectionFromDevice(e)}requestDisconnectionFromDevice(e){this.assertConnection(),_f.assertTypeWithError(e,"string");const t=this.devices[e];return _f.assertWithError(t,`no device found with id ${e}`),t.disconnect(),t}sendDisconnectFromDeviceMessage(e){this.sendServerMessage({type:"disconnectFromDevice",data:e})}sendDeviceMessage(e,...t){this.sendServerMessage({type:"deviceMessage",data:[e,Xc(...t)]})}sendRequiredDeviceInformationMessage(e){this.sendServerMessage({type:"requiredDeviceInformation",data:[e]})}}var xf,$f,Of,Bf,Nf,Pf,Vf,qf,zf,jf,Gf,Hf,Jf;lf=Ff,gf=new WeakMap,uf=new WeakMap,df=new WeakMap,vf=new WeakMap,bf=new WeakMap,Mf=new WeakMap,Rf=new WeakMap,hf=new WeakSet,ff=function(){t(this,hf,!1,"a",Cf),t(this,hf,!1,"a",kf);for(const t in e(this,gf,"f")){e(this,gf,"f")[t].connectionManager.isConnected=!1}e(this,vf,"f").length=0},mf=function(){return e(lf,lf,"f",pf)},wf=function(){"connecting"==this.connectionStatus&&(_f.log("checking if fully connected..."),e(this,vf,"f").includes("isScanningAvailable")?!this.isScanningAvailable||e(this,vf,"f").includes("isScanning")?(_f.log("fully connected"),this._connectionStatus="connected"):_f.log("not fully connected - didn't receive isScanning"):_f.log("not fully connected - didn't receive isScanningAvailable"))},yf=function(s,i){let n=0;switch(_f.log({messageType:s},i),s){case"isScanningAvailable":{const e=Boolean(i.getUint8(n++));_f.log({isScanningAvailable:e}),t(this,hf,e,"a",Cf)}break;case"isScanning":{const e=Boolean(i.getUint8(n++));_f.log({isScanning:e}),t(this,hf,e,"a",kf)}break;case"discoveredDevice":{const{string:e}=Mt(i,n);_f.log({discoveredDeviceString:e});const t=JSON.parse(e);_f.log({discoveredDevice:t}),this.onDiscoveredDevice(t)}break;case"expiredDiscoveredDevice":{const{string:t}=Mt(i,n);e(this,hf,"m",Uf).call(this,t)}break;case"connectedDevices":{if(0==i.byteLength)break;const{string:e}=Mt(i,n);_f.log({connectedBluetoothDeviceIdStrings:e});const t=JSON.parse(e).connectedDevices;_f.log({connectedBluetoothDeviceIds:t}),this.onConnectedBluetoothDeviceIds(t)}break;case"deviceMessage":{const{string:t,byteOffset:s}=Mt(i,n);n=s;const a=e(this,gf,"f")[t];_f.assertWithError(a,`no device found for id ${t}`);const r=a.connectionManager,o=H(i,n);r.onClientMessage(o)}break;default:_f.error(`uncaught messageType "${s}"`)}"connecting"==this.connectionStatus&&e(this,vf,"f").push(s)},Sf=function(){return e(this,bf,"f")},Cf=function(s){_f.assertTypeWithError(s,"boolean"),t(this,bf,s,"f"),this.dispatchEvent("isScanningAvailable",{isScanningAvailable:this.isScanningAvailable}),this.isScanningAvailable&&e(this,hf,"m",Wf).call(this)},Ef=function(){this.assertConnection(),_f.assertWithError(this.isScanningAvailable,"scanning is not available")},Df=function(){return e(this,Mf,"f")},kf=function(e){_f.assertTypeWithError(e,"boolean"),t(this,Mf,e,"f"),this.dispatchEvent("isScanning",{isScanning:this.isScanning})},Wf=function(){this.sendServerMessage("isScanning")},Tf=function(){_f.assertWithError(this.isScanning,"is not scanning")},If=function(){_f.assertWithError(!this.isScanning,"is already scanning")},Uf=function(t){_f.log({expiredBluetoothDeviceId:t});const s=e(this,Rf,"f")[t];s?(_f.log({expiredDiscoveredDevice:s}),delete e(this,Rf,"f")[t],this.dispatchEvent("expiredDiscoveredDevice",{discoveredDevice:s})):_f.warn(`no discoveredDevice found with id "${t}"`)},Lf=function(t){let s=e(this,gf,"f")[t];return s||(s=this.createDevice(t),e(this,gf,"f")[t]=s),s},Ff._reconnectOnDisconnection=!0,pf={value:["isScanningAvailable","discoveredDevices","connectedDevices"]};const Kf=W("WebSocketClient",{log:!1});class Qf extends Ff{constructor(){super(...arguments),xf.add(this),$f.set(this,void 0),Bf.set(this,{open:e(this,xf,"m",Nf).bind(this),message:e(this,xf,"m",Pf).bind(this),close:e(this,xf,"m",Vf).bind(this),error:e(this,xf,"m",qf).bind(this)}),Gf.set(this,new x(e(this,xf,"m",Hf).bind(this),3e4))}get webSocket(){return e(this,$f,"f")}set webSocket(s){e(this,$f,"f")!=s?(Kf.log("assigning webSocket",s),e(this,$f,"f")&&io(e(this,$f,"f"),e(this,Bf,"f")),so(s,e(this,Bf,"f")),t(this,$f,s,"f"),Kf.log("assigned webSocket")):Kf.log("redundant webSocket assignment")}get readyState(){return this.webSocket?.readyState}get isConnected(){return this.readyState==WebSocket.OPEN}get isDisconnected(){return this.readyState==WebSocket.CLOSED}connect(e=`wss://${location.host}`){this.webSocket&&this.assertDisconnection(),this._connectionStatus="connecting",this.webSocket=new WebSocket(e)}disconnect(){this.assertConnection(),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.webSocket.addEventListener("close",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this._connectionStatus="disconnecting",this.webSocket.close()}reconnect(){this.assertDisconnection(),this.connect(this.webSocket.url)}toggleConnection(e){this.isConnected?this.disconnect():e&&this.webSocket?.url==e?this.reconnect():this.connect(e)}sendMessage(t){this.assertConnection(),e(this,$f,"f").send(t),e(this,Gf,"f").restart()}sendServerMessage(...e){this.sendMessage(th({type:"serverMessage",data:Zc(...e)}))}}$f=new WeakMap,Bf=new WeakMap,Gf=new WeakMap,xf=new WeakSet,Of=function(...e){this.sendMessage(th(...e))},Nf=function(t){Kf.log("webSocket.open",t),e(this,Gf,"f").start(),this._sendRequiredMessages()},Pf=async function(t){Kf.log("webSocket.message",t);const s=await t.data.arrayBuffer(),i=new DataView(s);e(this,xf,"m",zf).call(this,i)},Vf=function(t){Kf.log("webSocket.close",t),this._connectionStatus="notConnected",Object.entries(this.devices).forEach((([e,t])=>{t.connectionManager.isConnected=!1})),e(this,Gf,"f").stop(),this.reconnectOnDisconnection&&setTimeout((()=>{this.reconnect()}),3e3)},qf=function(e){Kf.error("webSocket.error",e)},zf=function(t){Dt(t,eh,e(this,xf,"m",jf).bind(this),null,!0)},jf=function(t,s){switch(t){case"ping":e(this,xf,"m",Jf).call(this);break;case"pong":break;case"serverMessage":this.parseMessage(s);break;default:Kf.error(`uncaught messageType "${t}"`)}},Hf=function(){e(this,xf,"m",Of).call(this,"ping")},Jf=function(){e(this,xf,"m",Of).call(this,"pong")};const Zf={addEventListeners:so,removeEventListeners:io},Xf={throttle:function(e,t,s=!1){let i=0,n=null,a=null;return function(...r){const o=Date.now(),c=t-(o-i);c<=0?(n&&(clearTimeout(n),n=null),i=o,e(...r)):s&&(a=r,n||(n=setTimeout((()=>{i=Date.now(),n=null,a&&(e(...a),a=null)}),c)))}},debounce:function(e,t,s=!1){let i=null;return function(...n){const a=s&&!i;i&&clearTimeout(i),i=setTimeout((()=>{i=null,s||e(...n)}),t),a&&e(...n)}}};export{ss as CameraCommands,as as CameraConfigurationTypes,Ks as ContinuousSensorTypes,ft as DefaultNumberOfPressureSensors,wl as Device,Hc as DeviceManager,ef as DevicePair,Yl as DevicePairTypes,Ln as DeviceTypes,Wr as DisplayBrightnesses,w as Environment,Zf as EventUtils,qe as FileTransferDirections,Ne as FileTypes,Fn as MaxNameLength,la as MaxNumberOfVibrationWaveformEffectSegments,da as MaxNumberOfVibrationWaveformSegments,di as MaxSensorRate,ga as MaxVibrationWaveformEffectSegmentDelay,ua as MaxVibrationWaveformEffectSegmentLoopCount,pa as MaxVibrationWaveformEffectSequenceLoopCount,fa as MaxVibrationWaveformSegmentDuration,Oa as MaxWifiPasswordLength,xa as MaxWifiSSIDLength,$s as MicrophoneCommands,Bs as MicrophoneConfigurationTypes,Vs as MicrophoneConfigurationValues,An as MinNameLength,$a as MinWifiPasswordLength,Fa as MinWifiSSIDLength,tt as RangeHelper,pi as SensorRateStep,Js as SensorTypes,_n as Sides,tn as TfliteSensorTypes,en as TfliteTasks,Xf as ThrottleUtils,ra as VibrationLocations,oa as VibrationTypes,Bn as VibrationWaveformEffects,Qf as WebSocketClient,I as setAllConsoleLevelFlags,T as setConsoleLevelFlagsForType};
//# sourceMappingURL=brilliantsole.module.min.js.map
