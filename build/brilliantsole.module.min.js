/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
function e(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)}function t(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s}"function"==typeof SuppressedError&&SuppressedError;const s=!0,i="undefined"!=typeof window&&void 0!==window?.document,n="undefined"!=typeof process&&null!=process?.versions?.node,a=i&&navigator.userAgent||"";let r=!1;i?r=Boolean(navigator.bluetooth):n&&(r=!0);const o=i&&/Bluefy/i.test(a),c=i&&/WebBLE/i.test(a),h=i&&/Android/i.test(a),l=i&&/Safari/i.test(a)&&!/Chrome/i.test(a),f=i&&/iPad|iPhone|iPod/i.test(a),u=i&&/Macintosh/i.test(a),g=!i&&!n&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var d,m,p,v,w=Object.freeze({__proto__:null,isAndroid:h,get isBluetoothSupported(){return r},isIOS:f,isInBluefy:o,isInBrowser:i,isInDev:s,isInLensStudio:g,isInNode:n,isInProduction:false,isInWebBLE:c,isMac:u,isSafari:l});if(g){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(v={}).log=e,v.warn=e.bind(v,"WARNING"),v.error=e.bind(v,"ERROR")}else v=console;if(!v.assert){const e=(e,...t)=>{e||v.warn(...t)};v.assert=e}if(!v.table){const e=(...e)=>{v.log(...e)};v.table=e}function y(){}const b=v.log.bind(v),S=v.warn.bind(v),E=v.error.bind(v),C=v.table.bind(v),D=v.assert.bind(v);class k{constructor(t){if(p.set(this,{log:s,warn:s,assert:!0,error:!0,table:!0}),e(d,d,"f",m)[t])throw new Error(`"${t}" console already exists`);e(d,d,"f",m)[t]=this}setLevelFlags(t){Object.assign(e(this,p,"f"),t)}static setLevelFlagsForType(t,s){if(!e(this,d,"f",m)[t])throw new Error(`no console found with type "${t}"`);e(this,d,"f",m)[t].setLevelFlags(s)}static setAllLevelFlags(t){for(const s in e(this,d,"f",m))e(this,d,"f",m)[s].setLevelFlags(t)}static create(t,s){const i=e(this,d,"f",m)[t]||new d(t);return s&&i.setLevelFlags(s),i}get log(){return e(this,p,"f").log?b:y}get warn(){return e(this,p,"f").warn?S:y}get error(){return e(this,p,"f").error?E:y}get assert(){return e(this,p,"f").assert?D:y}get table(){return e(this,p,"f").table?C:y}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}}function M(e,t){return k.create(e,t)}function T(e,t){k.setLevelFlagsForType(e,t)}function W(e){k.setAllLevelFlags(e)}d=k,p=new WeakMap,m={value:{}};class I{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}addEventListener(e,t,s={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push({listener:t,once:s.once})}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((e=>e.listener!==t)))}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);if(!this.listeners[e])return;const s=this.listeners[e];s.forEach(((i,n)=>{i.listener({type:e,target:this.target,message:t}),i.once&&s.splice(n,1)}))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var _,F,U;const L=M("Timer",{log:!1});class x{get callback(){return e(this,_,"f")}set callback(e){L.assertTypeWithError(e,"function"),L.log({newCallback:e}),t(this,_,e,"f"),this.isRunning&&this.restart()}get interval(){return e(this,F,"f")}set interval(e){L.assertTypeWithError(e,"number"),L.assertWithError(e>0,"interval must be above 0"),L.log({newInterval:e}),t(this,F,e,"f"),this.isRunning&&this.restart()}constructor(e,t){_.set(this,void 0),F.set(this,void 0),U.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=e(this,U,"f")}start(){this.isRunning?L.log("interval already running"):(L.log("starting interval"),t(this,U,setInterval(e(this,_,"f"),e(this,F,"f")),"f"))}stop(){this.isRunning?(L.log("stopping interval"),clearInterval(e(this,U,"f")),t(this,U,void 0,"f")):L.log("interval already not running")}restart(){this.stop(),this.start()}}function R(e){for(let t=0;t<8;++t)e=(1&e?0:3988292384)^e>>>1;return 4278190080^e}_=new WeakMap,F=new WeakMap,U=new WeakMap,M("checksum",{log:!0});const A=new Uint32Array(256);for(let e=0;e<256;++e)A[e]=R(e);function O(e){let t=new Uint8Array(e),s=0;for(let e=0;e<t.byteLength;++e){const i=255&s,n=t[e];s=(A[i^n]^s>>>8)>>>0}return s}var $,N;$="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,N="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const B=new $,P=new N,V=M("ArrayBufferUtils",{log:!1});function z(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return j(e)}if(e instanceof Array){return z(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return j(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;return e.forEach((e=>{s.set(new Uint8Array(e),i),i+=e.byteLength})),s.buffer}function j(e){const t=B.encode(e);return z(t.byteLength,t)}function q(e,t,s){let i;return null!=s&&(i=e.byteOffset+t+s),V.log({dataView:e,begin:t,end:i,length:s}),new DataView(e.buffer.slice(e.byteOffset+t,i))}async function G(e){let t;if(e instanceof Array)t=Uint8Array.from(e);else if(e instanceof DataView)t=e.buffer;else if("string"==typeof e||e instanceof URL){const s=await fetch(e);t=await s.arrayBuffer()}else if(e instanceof File)t=await e.arrayBuffer();else{if(!(e instanceof ArrayBuffer))throw{error:"invalid file type",file:e};t=e}return t}function H(e,{include:t,exclude:s}={}){const i=e=>{const i=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(i):!s||!s.some(i)};for(const[t,s]of(e=>{const t=new Set;do{for(const s of Reflect.ownKeys(e))t.add([e,s])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===s||!i(s))continue;const n=Reflect.getOwnPropertyDescriptor(t,s);n&&"function"==typeof n.value&&(e[s]=e[s].bind(e))}return e}var J,Q,K,Z,X,Y,ee,te,se,ie,ne,ae,re,oe,ce,he,le,fe,ue,ge,de,me,pe,ve,we,ye,be,Se,Ee,Ce,De,ke,Me,Te;const We=M("FileTransferManager",{log:!0}),Ie=["maxFileLength","getFileType","setFileType","getFileLength","setFileLength","getFileChecksum","setFileChecksum","setFileTransferCommand","fileTransferStatus","getFileBlock","setFileBlock"],_e=["tflite"],Fe=["idle","sending","receiving"],Ue=["startReceive","startSend","cancel"],Le=["sending","receiving"],xe=[...Ie,"fileTransferProgress","fileTransferComplete","fileReceived"];class Re{constructor(){J.add(this),se.set(this,Q.MaxLength),re.set(this,void 0),le.set(this,0),de.set(this,0),ye.set(this,"idle"),De.set(this,[]),H(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}static get MaxLength(){return e(this,Q,"f",te)}get maxLength(){return e(this,se,"f")}get type(){return e(this,re,"f")}get length(){return e(this,le,"f")}get checksum(){return e(this,de,"f")}get status(){return e(this,ye,"f")}parseMessage(t,s){switch(We.log({messageType:t}),t){case"maxFileLength":e(this,J,"m",ie).call(this,s);break;case"getFileType":case"setFileType":e(this,J,"m",oe).call(this,s);break;case"getFileLength":case"setFileLength":e(this,J,"m",fe).call(this,s);break;case"getFileChecksum":case"setFileChecksum":e(this,J,"m",me).call(this,s);break;case"fileTransferStatus":e(this,J,"m",be).call(this,s);break;case"getFileBlock":e(this,J,"m",ke).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}async send(t,s){e(this,J,"m",Ee).call(this),e(this,J,"m",Z).call(this,t);const i=await G(s),n=[];n.push(e(this,J,"m",he).call(this,t,!1));const a=i.byteLength;n.push(e(this,J,"m",ge).call(this,a,!1));const r=O(i);n.push(e(this,J,"m",ve).call(this,r,!1)),n.push(e(this,J,"m",we).call(this,"startSend",!1)),this.sendMessage(),await Promise.all(n),await e(this,J,"m",Me).call(this,i)}async receive(t){e(this,J,"m",Ee).call(this),e(this,J,"m",Z).call(this,t),await e(this,J,"m",he).call(this,t),await e(this,J,"m",we).call(this,"startReceive")}async cancel(){e(this,J,"m",Ce).call(this),await e(this,J,"m",we).call(this,"cancel")}}Q=Re,se=new WeakMap,re=new WeakMap,le=new WeakMap,de=new WeakMap,ye=new WeakMap,De=new WeakMap,J=new WeakSet,K=function(){return this.eventDispatcher.dispatchEvent},Z=function(e){We.assertEnumWithError(e,_e)},X=function(e){We.assertWithError(e in _e,`invalid typeEnum ${e}`)},Y=function(e){We.assertWithError(e in Fe,`invalid statusEnum ${e}`)},ee=function(e){We.assertEnumWithError(e,Ue)},ie=function(t){We.log("parseFileMaxLength",t);const s=t.getUint32(0,!0);We.log(`maxLength: ${s/1024}kB`),e(this,J,"m",ne).call(this,s)},ne=function(s){We.log({maxLength:s}),t(this,se,s,"f"),e(this,J,"a",K).call(this,"maxFileLength",{maxFileLength:s})},ae=function(e){We.assertWithError(e<=this.maxLength,`file length ${e}kB too large - must be ${this.maxLength}kB or less`)},oe=function(t){We.log("parseFileType",t);const s=t.getUint8(0);e(this,J,"m",X).call(this,s);const i=_e[s];e(this,J,"m",ce).call(this,i)},ce=function(s){We.log({fileTransferType:s}),t(this,re,s,"f"),e(this,J,"a",K).call(this,"getFileType",{fileType:s})},he=async function(t,s){if(e(this,J,"m",Z).call(this,t),this.type==t)return void We.log(`redundant type assignment ${t}`);const i=this.waitForEvent("getFileType"),n=_e.indexOf(t);this.sendMessage([{type:"setFileType",data:Uint8Array.from([n]).buffer}],s),await i},fe=function(t){We.log("parseFileLength",t);const s=t.getUint32(0,!0);e(this,J,"m",ue).call(this,s)},ue=function(s){We.log(`length: ${s/1024}kB`),t(this,le,s,"f"),e(this,J,"a",K).call(this,"getFileLength",{fileLength:s})},ge=async function(t,s){if(We.assertTypeWithError(t,"number"),e(this,J,"m",ae).call(this,t),this.length==t)return void We.log(`redundant length assignment ${t}`);const i=this.waitForEvent("getFileLength"),n=new DataView(new ArrayBuffer(4));n.setUint32(0,t,!0),this.sendMessage([{type:"setFileLength",data:n.buffer}],s),await i},me=function(t){We.log("checksum",t);const s=t.getUint32(0,!0);e(this,J,"m",pe).call(this,s)},pe=function(s){We.log({checksum:s}),t(this,de,s,"f"),e(this,J,"a",K).call(this,"getFileChecksum",{fileChecksum:s})},ve=async function(e,t){if(We.assertTypeWithError(e,"number"),this.checksum==e)return void We.log(`redundant checksum assignment ${e}`);const s=this.waitForEvent("getFileChecksum"),i=new DataView(new ArrayBuffer(4));i.setUint32(0,e,!0),this.sendMessage([{type:"setFileChecksum",data:i.buffer}],t),await s},we=async function(t,s){e(this,J,"m",ee).call(this,t);const i=this.waitForEvent("fileTransferStatus"),n=Ue.indexOf(t);this.sendMessage([{type:"setFileTransferCommand",data:Uint8Array.from([n]).buffer}],s),await i},be=function(t){We.log("parseFileStatus",t);const s=t.getUint8(0);e(this,J,"m",Y).call(this,s);const i=Fe[s];e(this,J,"m",Se).call(this,i)},Se=function(s){We.log({status:s}),t(this,ye,s,"f"),e(this,J,"a",K).call(this,"fileTransferStatus",{fileTransferStatus:s}),e(this,De,"f").length=0},Ee=function(){We.assertWithError("idle"==e(this,ye,"f"),"status is not idle")},Ce=function(){We.assertWithError("idle"!=e(this,ye,"f"),"status is idle")},ke=async function(t){We.log("parseFileBlock",t),e(this,De,"f").push(t.buffer);const s=e(this,De,"f").reduce(((e,t)=>e+t.byteLength),0),i=s/e(this,le,"f");if(We.log(`received ${s} of ${e(this,le,"f")} bytes (${100*i}%)`),e(this,J,"a",K).call(this,"fileTransferProgress",{progress:i}),s!=e(this,le,"f"))return;We.log("file transfer complete");let n,a=(new Date).toLocaleString();if("tflite"===this.type)a+=".tflite";n="undefined"!=typeof File?new File(e(this,De,"f"),a):new Blob(e(this,De,"f"));const r=O(await n.arrayBuffer());We.log({checksum:r}),r==e(this,de,"f")?(We.log("received file",n),e(this,J,"a",K).call(this,"getFileBlock",{fileTransferBlock:t}),e(this,J,"a",K).call(this,"fileTransferComplete",{direction:"receiving"}),e(this,J,"a",K).call(this,"fileReceived",{file:n})):We.error(`wrong checksum - expected ${e(this,de,"f")}, got ${r}`)},Me=async function(t){return e(this,J,"m",Te).call(this,t)},Te=async function t(s,i=0){if("sending"!=this.status)return;const n=s.slice(i,i+(this.mtu-3-3));We.log("slicedBuffer",n);const a=1-(s.byteLength-i)/s.byteLength;if(We.log(`sending bytes ${i}-${i+n.byteLength} of ${s.byteLength} bytes (${100*a}%)`),e(this,J,"a",K).call(this,"fileTransferProgress",{progress:a}),0!=n.byteLength)return this.sendMessage([{type:"setFileBlock",data:n}]),e(this,J,"m",t).call(this,s,i+n.byteLength);We.log("finished sending buffer"),e(this,J,"a",K).call(this,"fileTransferComplete",{direction:"sending"})},te={value:0};const Ae=65536;function Oe(e,t){const s=Date.now();var i;return(i=s)-i%Ae+e.getUint16(t,!0)}var $e;const Ne={min:1/0,max:-1/0,range:0};class Be{constructor(){$e.set(this,Object.assign({},Ne))}reset(){Object.assign(e(this,$e,"f"),Ne)}update(t){e(this,$e,"f").min=Math.min(t,e(this,$e,"f").min),e(this,$e,"f").max=Math.max(t,e(this,$e,"f").max),e(this,$e,"f").range=e(this,$e,"f").max-e(this,$e,"f").min}getNormalization(t){return e(this,$e,"f").range*t||0}updateAndGetNormalization(e){return this.update(e),this.getNormalization(e)}}var Pe,Ve,ze,je;$e=new WeakMap;class qe{constructor(){Pe.set(this,{x:new Be,y:new Be})}reset(){e(this,Pe,"f").x.reset(),e(this,Pe,"f").y.reset()}update(t){e(this,Pe,"f").x.update(t.x),e(this,Pe,"f").y.update(t.y)}getNormalization(t){return{x:e(this,Pe,"f").x.getNormalization(t.x),y:e(this,Pe,"f").y.getNormalization(t.y)}}updateAndGetNormalization(e){return this.update(e),this.getNormalization(e)}}Pe=new WeakMap;const Ge=M("PressureDataManager",{log:!0}),He=["pressure"],Je=He;class Qe{constructor(){Ve.set(this,[]),ze.set(this,void 0),je.set(this,new qe)}get positions(){return e(this,Ve,"f")}get numberOfSensors(){return this.positions.length}parsePositions(e){const s=[];for(let t=0,i=0;i<e.byteLength;t++,i+=2)s.push({x:e.getUint8(i)/256,y:e.getUint8(i+1)/256});var i,n;Ge.log({positions:s}),t(this,Ve,s,"f"),t(this,ze,(i=this.numberOfSensors,n=()=>new Be,new Array(i).fill(1).map(((e,t)=>{if("function"==typeof n)return n(t);{const e=n;return Object.assign({},e)}}))),"f"),this.resetRange()}resetRange(){e(this,ze,"f").forEach((e=>e.reset())),e(this,je,"f").reset()}parseData(t,s){const i={sensors:[],scaledSum:0,normalizedSum:0};for(let n=0,a=0;a<t.byteLength;n++,a+=2){const r=t.getUint16(a,!0),o=r*s,c=e(this,ze,"f")[n].updateAndGetNormalization(o),h=this.positions[n];i.sensors[n]={rawValue:r,scaledValue:o,normalizedValue:c,position:h,weightedValue:0},i.scaledSum+=o,i.normalizedSum+=c/this.numberOfSensors}return i.scaledSum>0&&(i.center={x:0,y:0},i.sensors.forEach((e=>{e.weightedValue=e.scaledValue/i.scaledSum,i.center.x+=e.position.x*e.weightedValue,i.center.y+=e.position.y*e.weightedValue})),i.normalizedCenter=e(this,je,"f").updateAndGetNormalization(i.center)),Ge.log({pressure:i}),i}}Ve=new WeakMap,ze=new WeakMap,je=new WeakMap;const Ke=M("MotionSensorDataManager",{log:!0}),Ze=["still","walking","running","bicycle","vehicle","tilting"],Xe=["portraitUpright","landscapeLeft","portraitUpsideDown","landscapeRight","unknown"];class Ye{parseVector3(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));const a={x:s,y:i,z:n};return Ke.log({vector:a}),a}parseQuaternion(e,t){let[s,i,n,a]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0),e.getInt16(6,!0)].map((e=>e*t));const r={x:s,y:i,z:n,w:a};return Ke.log({quaternion:r}),r}parseEuler(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));i*=-1,s*=-1;const a={heading:s,pitch:i,roll:n};return Ke.log({euler:a}),a}parseStepCounter(e){Ke.log("parseStepCounter",e);const t=e.getUint32(0,!0);return Ke.log({stepCount:t}),t}parseActivity(e){Ke.log("parseActivity",e);const t={},s=e.getUint8(0);return Ke.log("activityBitfield",s.toString(2)),Ze.forEach(((e,i)=>{t[e]=Boolean(s&1<<i)})),Ke.log("activity",t),t}parseDeviceOrientation(e){Ke.log("parseDeviceOrientation",e);const t=e.getUint8(0),s=Xe[t];return Ke.assertWithError(s,"undefined deviceOrientation"),Ke.log({deviceOrientation:s}),s}}var et,tt;const st=["barometer"],it=st,nt=M("BarometerSensorDataManager",{log:!0});class at{constructor(){et.add(this)}parseData(t,s){const i=t.getUint32(0,!0)*s,n=e(this,et,"m",tt).call(this,i);return nt.log({pressure:i,altitude:n}),{pressure:i}}}et=new WeakSet,tt=function(e){const t=.0065;return 288.15/t*(1-Math.pow(e/101325,.19026643566373183))};const rt=M("ParseUtils",{log:!0});function ot(e,t=0){const s=e.getUint8(t++);return{string:P.decode(e.buffer.slice(e.byteOffset+t,e.byteOffset+t+s)),byteOffset:t+=s}}function ct(e,t,s,i,n=!1){let a=0;for(;a<e.byteLength;){const r=e.getUint8(a++);rt.assertWithError(r in t,`invalid messageTypeEnum ${r}`);const o=t[r];let c;n?(c=e.getUint16(a,!0),a+=2):c=e.getUint8(a++),rt.log({messageTypeEnum:r,messageType:o,messageLength:c,dataView:e,byteOffset:a});const h=q(e,a,c);rt.log({_dataView:h}),s(o,h,i),a+=c}}const ht=M("SensorDataManager",{log:!0}),lt=["acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation","activity","stepCounter","stepDetector","deviceOrientation",...He,...st],ft=["acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation",...Je,...it],ut=["getPressurePositions","getSensorScalars","sensorData"],gt=[...ut,...lt];class dt{constructor(){this.pressureSensorDataManager=new Qe,this.motionSensorDataManager=new Ye,this.barometerSensorDataManager=new at,this.scalars=new Map}static AssertValidSensorType(e){ht.assertEnumWithError(e,lt)}static AssertValidSensorTypeEnum(e){ht.assertTypeWithError(e,"number"),ht.assertWithError(e in lt,`invalid sensorTypeEnum ${e}`)}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}parseMessage(e,t){switch(ht.log({messageType:e}),e){case"getSensorScalars":this.parseScalars(t);break;case"getPressurePositions":this.pressureSensorDataManager.parsePositions(t);break;case"sensorData":this.parseData(t);break;default:throw Error(`uncaught messageType ${e}`)}}parseScalars(e){for(let t=0;t<e.byteLength;t+=5){const s=e.getUint8(t),i=lt[s];if(!i){ht.warn(`unknown sensorType index ${s}`);continue}const n=e.getFloat32(t+1,!0);ht.log({sensorType:i,sensorScalar:n}),this.scalars.set(i,n)}}parseData(e){ht.log("sensorData",Array.from(new Uint8Array(e.buffer)));let t=0;const s=Oe(e,t);t+=2;ct(new DataView(e.buffer,t),lt,this.parseDataCallback.bind(this),{timestamp:s})}parseDataCallback(e,t,{timestamp:s}){const i=this.scalars.get(e)||1;let n=null;switch(e){case"pressure":n=this.pressureSensorDataManager.parseData(t,i);break;case"acceleration":case"gravity":case"linearAcceleration":case"gyroscope":case"magnetometer":n=this.motionSensorDataManager.parseVector3(t,i);break;case"gameRotation":case"rotation":n=this.motionSensorDataManager.parseQuaternion(t,i);break;case"orientation":n=this.motionSensorDataManager.parseEuler(t,i);break;case"stepCounter":n=this.motionSensorDataManager.parseStepCounter(t);break;case"stepDetector":n={};break;case"activity":n=this.motionSensorDataManager.parseActivity(t);break;case"deviceOrientation":n=this.motionSensorDataManager.parseDeviceOrientation(t);break;case"barometer":n=this.barometerSensorDataManager.parseData(t,i);break;default:ht.error(`uncaught sensorType "${e}"`)}ht.assertWithError(null!=n,`no sensorData defined for sensorType "${e}"`),ht.log({sensorType:e,sensorData:n}),this.dispatchEvent(e,{sensorType:e,[e]:n,timestamp:s}),this.dispatchEvent("sensorData",{sensorType:e,[e]:n,timestamp:s})}}var mt,pt,vt,wt,yt,bt,St,Et,Ct,Dt,kt,Mt,Tt;const Wt=M("SensorConfigurationManager",{log:!0}),It=65535,_t=5,Ft=["getSensorConfiguration","setSensorConfiguration"];class Ut{constructor(){mt.add(this),wt.set(this,void 0),bt.set(this,void 0),H(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get configuration(){return e(this,bt,"f")}async setConfiguration(t,s){if(s&&(t=Object.assign({...this.zeroSensorConfiguration},t)),Wt.log({newSensorConfiguration:t}),e(this,mt,"m",Et).call(this,t))return void Wt.log("redundant sensor configuration");const i=e(this,mt,"m",Mt).call(this,t);Wt.log({setSensorConfigurationData:i});const n=this.waitForEvent("getSensorConfiguration");this.sendMessage([{type:"setSensorConfiguration",data:i.buffer}]),await n}static get ZeroSensorConfiguration(){return e(this,pt,"f",Tt)}get zeroSensorConfiguration(){const e={};return lt.forEach((t=>{e[t]=0})),e}async clearSensorConfiguration(){return this.setConfiguration(this.zeroSensorConfiguration)}parseMessage(t,s){switch(Wt.log({messageType:t}),t){case"getSensorConfiguration":case"setSensorConfiguration":const i=e(this,mt,"m",Ct).call(this,s);e(this,mt,"m",St).call(this,i);break;default:throw Error(`uncaught messageType ${t}`)}}}var Lt,xt,Rt,At,Ot,$t,Nt,Bt,Pt,Vt,zt,jt,qt,Gt,Ht,Jt,Qt,Kt,Zt,Xt,Yt,es,ts,ss,is,ns,as,rs,os,cs;pt=Ut,wt=new WeakMap,bt=new WeakMap,mt=new WeakSet,vt=function(){return this.eventDispatcher.dispatchEvent},yt=function(t){Wt.assertWithError(e(this,wt,"f"),"must get initial sensorConfiguration");const s=e(this,wt,"f")?.includes(t);return Wt.assert(s,`unavailable sensor type "${t}"`),s},St=function(s){t(this,bt,s,"f"),Wt.log({updatedConfiguration:e(this,bt,"f")}),e(this,mt,"a",vt).call(this,"getSensorConfiguration",{sensorConfiguration:this.configuration})},Et=function(e){return Object.keys(e).every((t=>this.configuration[t]==e[t]))},Ct=function(e){const s={};for(let t=0;t<e.byteLength;t+=3){const i=e.getUint8(t),n=lt[i];if(!n){Wt.warn(`unknown sensorType index ${i}`);continue}const a=e.getUint16(t+1,!0);Wt.log({sensorType:n,sensorRate:a}),s[n]=a}return Wt.log({parsedSensorConfiguration:s}),t(this,wt,Object.keys(s),"f"),s},Dt=function(e){Wt.assertTypeWithError(e,"number"),Wt.assertWithError(e>=0,`sensorRate must be 0 or greater (got ${e})`),Wt.assertWithError(e<65535,`sensorRate must be 0 or greater (got ${e})`),Wt.assertWithError(e%5==0,"sensorRate must be multiple of 5")},kt=function(t){e(pt,pt,"m",Dt).call(pt,t)},Mt=function(t){let s=Object.keys(t);s=s.filter((t=>e(this,mt,"m",yt).call(this,t)));const i=new DataView(new ArrayBuffer(3*s.length));return s.forEach(((s,n)=>{dt.AssertValidSensorType(s);const a=lt.indexOf(s);i.setUint8(3*n,a);const r=t[s];e(this,mt,"m",kt).call(this,r),i.setUint16(3*n+1,r,!0)})),Wt.log({sensorConfigurationData:i}),i},Tt={value:{}},lt.forEach((t=>{e(pt,pt,"f",Tt)[t]=0}));const hs=M("TfliteManager",{log:!0}),ls=["getTfliteName","setTfliteName","getTfliteTask","setTfliteTask","getTfliteSampleRate","setTfliteSampleRate","getTfliteSensorTypes","setTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","setTfliteCaptureDelay","getTfliteThreshold","setTfliteThreshold","getTfliteInferencingEnabled","setTfliteInferencingEnabled","tfliteInference"],fs=ls,us=["classification","regression"],gs=["pressure","linearAcceleration","gyroscope","magnetometer"];class ds{constructor(){Lt.add(this),Ot.set(this,void 0),Bt.set(this,void 0),zt.set(this,void 0),Gt.set(this,[]),Qt.set(this,void 0),Yt.set(this,void 0),ss.set(this,void 0),as.set(this,void 0),H(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get name(){return e(this,Ot,"f")}async setName(e,t){if(hs.assertTypeWithError(e,"string"),this.name==e)return void hs.log(`redundant name assignment ${e}`);const s=this.waitForEvent("getTfliteName"),i=B.encode(e);this.sendMessage([{type:"setTfliteName",data:i.buffer}],t),await s}get task(){return e(this,Bt,"f")}async setTask(t,s){if(e(this,Lt,"m",xt).call(this,t),this.task==t)return void hs.log(`redundant task assignment ${t}`);const i=this.waitForEvent("getTfliteTask"),n=us.indexOf(t);this.sendMessage([{type:"setTfliteTask",data:Uint8Array.from([n]).buffer}],s),await i}get sampleRate(){return e(this,zt,"f")}async setSampleRate(t,s){if(hs.assertTypeWithError(t,"number"),t-=t%5,hs.assertWithError(t>=5,`sampleRate must be multiple of 5 greater than 0 (got ${t})`),e(this,zt,"f")==t)return void hs.log(`redundant sampleRate assignment ${t}`);const i=this.waitForEvent("getTfliteSampleRate"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,t,!0),this.sendMessage([{type:"setTfliteSampleRate",data:n.buffer}],s),await i}static AssertValidSensorType(e){dt.AssertValidSensorType(e),hs.assertWithError(gs.includes(e),`invalid tflite sensorType "${e}"`)}get sensorTypes(){return e(this,Gt,"f").slice()}async setSensorTypes(e,t){e.forEach((e=>{ds.AssertValidSensorType(e)}));const s=this.waitForEvent("getTfliteSensorTypes");var i;const n=(e=(i=e).filter(((e,t)=>i.indexOf(e)==t))).map((e=>lt.indexOf(e))).sort();hs.log(e,n),this.sendMessage([{type:"setTfliteSensorTypes",data:Uint8Array.from(n).buffer}],t),await s}get isReady(){return e(this,Qt,"f")}get captureDelay(){return e(this,Yt,"f")}async setCaptureDelay(t,s){if(hs.assertTypeWithError(t,"number"),e(this,Yt,"f")==t)return void hs.log(`redundant captureDelay assignment ${t}`);const i=this.waitForEvent("getTfliteCaptureDelay"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,t,!0),this.sendMessage([{type:"setTfliteCaptureDelay",data:n.buffer}],s),await i}get threshold(){return e(this,ss,"f")}async setThreshold(t,s){if(hs.assertTypeWithError(t,"number"),hs.assertWithError(t>=0,`threshold must be positive (got ${t})`),e(this,ss,"f")==t)return void hs.log(`redundant threshold assignment ${t}`);const i=this.waitForEvent("getTfliteThreshold"),n=new DataView(new ArrayBuffer(4));n.setFloat32(0,t,!0),this.sendMessage([{type:"setTfliteThreshold",data:n.buffer}],s),await i}get inferencingEnabled(){return e(this,as,"f")}async setInferencingEnabled(t,s=!0){if(hs.assertTypeWithError(t,"boolean"),!t&&!this.isReady)return;if(e(this,Lt,"m",Xt).call(this),e(this,as,"f")==t)return void hs.log(`redundant inferencingEnabled assignment ${t}`);const i=this.waitForEvent("getTfliteInferencingEnabled");this.sendMessage([{type:"setTfliteInferencingEnabled",data:Uint8Array.from([Number(t)]).buffer}],s),await i}async toggleInferencingEnabled(){return this.setInferencingEnabled(!this.inferencingEnabled)}async enableInferencing(){this.inferencingEnabled||this.setInferencingEnabled(!0)}async disableInferencing(){this.inferencingEnabled&&this.setInferencingEnabled(!1)}parseMessage(t,s){switch(hs.log({messageType:t}),t){case"getTfliteName":case"setTfliteName":e(this,Lt,"m",$t).call(this,s);break;case"getTfliteTask":case"setTfliteTask":e(this,Lt,"m",Pt).call(this,s);break;case"getTfliteSampleRate":case"setTfliteSampleRate":e(this,Lt,"m",jt).call(this,s);break;case"getTfliteSensorTypes":case"setTfliteSensorTypes":e(this,Lt,"m",Ht).call(this,s);break;case"tfliteIsReady":e(this,Lt,"m",Kt).call(this,s);break;case"getTfliteCaptureDelay":case"setTfliteCaptureDelay":e(this,Lt,"m",es).call(this,s);break;case"getTfliteThreshold":case"setTfliteThreshold":e(this,Lt,"m",is).call(this,s);break;case"getTfliteInferencingEnabled":case"setTfliteInferencingEnabled":e(this,Lt,"m",rs).call(this,s);break;case"tfliteInference":e(this,Lt,"m",cs).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}}var ms,ps,vs,ws,ys;Ot=new WeakMap,Bt=new WeakMap,zt=new WeakMap,Gt=new WeakMap,Qt=new WeakMap,Yt=new WeakMap,ss=new WeakMap,as=new WeakMap,Lt=new WeakSet,xt=function(e){hs.assertEnumWithError(e,us)},Rt=function(e){hs.assertWithError(e in us,`invalid taskEnum ${e}`)},At=function(){return this.eventDispatcher.dispatchEvent},$t=function(t){hs.log("parseName",t);const s=P.decode(t.buffer);e(this,Lt,"m",Nt).call(this,s)},Nt=function(s){hs.log({name:s}),t(this,Ot,s,"f"),e(this,Lt,"a",At).call(this,"getTfliteName",{tfliteName:s})},Pt=function(t){hs.log("parseTask",t);const s=t.getUint8(0);e(this,Lt,"m",Rt).call(this,s);const i=us[s];e(this,Lt,"m",Vt).call(this,i)},Vt=function(s){hs.log({task:s}),t(this,Bt,s,"f"),e(this,Lt,"a",At).call(this,"getTfliteTask",{tfliteTask:s})},jt=function(t){hs.log("parseSampleRate",t);const s=t.getUint16(0,!0);e(this,Lt,"m",qt).call(this,s)},qt=function(s){hs.log({sampleRate:s}),t(this,zt,s,"f"),e(this,Lt,"a",At).call(this,"getTfliteSampleRate",{tfliteSampleRate:s})},Ht=function(t){hs.log("parseSensorTypes",t);const s=[];for(let e=0;e<t.byteLength;e++){const i=t.getUint8(e),n=lt[i];n?s.push(n):hs.error(`invalid sensorTypeEnum ${i}`)}e(this,Lt,"m",Jt).call(this,s)},Jt=function(s){hs.log({sensorTypes:s}),t(this,Gt,s,"f"),e(this,Lt,"a",At).call(this,"getTfliteSensorTypes",{tfliteSensorTypes:s})},Kt=function(t){hs.log("parseIsReady",t);const s=Boolean(t.getUint8(0));e(this,Lt,"m",Zt).call(this,s)},Zt=function(s){hs.log({isReady:s}),t(this,Qt,s,"f"),e(this,Lt,"a",At).call(this,"tfliteIsReady",{tfliteIsReady:s})},Xt=function(){hs.assertWithError(this.isReady,"tflite is not ready")},es=function(t){hs.log("parseCaptureDelay",t);const s=t.getUint16(0,!0);e(this,Lt,"m",ts).call(this,s)},ts=function(s){hs.log({captureDelay:s}),t(this,Yt,s,"f"),e(this,Lt,"a",At).call(this,"getTfliteCaptureDelay",{tfliteCaptureDelay:s})},is=function(t){hs.log("parseThreshold",t);const s=t.getFloat32(0,!0);e(this,Lt,"m",ns).call(this,s)},ns=function(s){hs.log({threshold:s}),t(this,ss,s,"f"),e(this,Lt,"a",At).call(this,"getTfliteThreshold",{tfliteThreshold:s})},rs=function(t){hs.log("parseInferencingEnabled",t);const s=Boolean(t.getUint8(0));e(this,Lt,"m",os).call(this,s)},os=function(s){hs.log({inferencingEnabled:s}),t(this,as,s,"f"),e(this,Lt,"a",At).call(this,"getTfliteInferencingEnabled",{tfliteInferencingEnabled:s})},cs=function(t){hs.log("parseInference",t);const s=Oe(t,0);hs.log({timestamp:s});const i=[];for(let e=0,s=2;s<t.byteLength;e++,s+=4){const e=t.getFloat32(s,!0);i.push(e)}hs.log("values",i);const n={timestamp:s,values:i};e(this,Lt,"a",At).call(this,"tfliteInference",{tfliteInference:n})};const bs=M("DeviceInformationManager",{log:!0}),Ss=["manufacturerName","modelNumber","softwareRevision","hardwareRevision","firmwareRevision","pnpId","serialNumber"],Es=[...Ss,"deviceInformation"];class Cs{constructor(){ms.add(this),vs.set(this,{})}get information(){return e(this,vs,"f")}clear(){t(this,vs,{},"f")}parseMessage(t,s){switch(bs.log({messageType:t}),t){case"manufacturerName":const i=P.decode(s.buffer);bs.log({manufacturerName:i}),e(this,ms,"m",ys).call(this,{manufacturerName:i});break;case"modelNumber":const n=P.decode(s.buffer);bs.log({modelNumber:n}),e(this,ms,"m",ys).call(this,{modelNumber:n});break;case"softwareRevision":const a=P.decode(s.buffer);bs.log({softwareRevision:a}),e(this,ms,"m",ys).call(this,{softwareRevision:a});break;case"hardwareRevision":const r=P.decode(s.buffer);bs.log({hardwareRevision:r}),e(this,ms,"m",ys).call(this,{hardwareRevision:r});break;case"firmwareRevision":const o=P.decode(s.buffer);bs.log({firmwareRevision:o}),e(this,ms,"m",ys).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===s.getUint8(0)?"Bluetooth":"USB",productId:s.getUint16(3,!0),productVersion:s.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=s.getUint16(1,!0)),bs.log({pnpId:c}),e(this,ms,"m",ys).call(this,{pnpId:c});break;case"serialNumber":const h=P.decode(s.buffer);bs.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${t}`)}}}var Ds,ks,Ms,Ts,Ws,Is,_s,Fs,Us,Ls,xs,Rs,As,Os,$s,Ns,Bs,Ps,Vs,zs;vs=new WeakMap,ms=new WeakSet,ps=function(){return this.eventDispatcher.dispatchEvent},ws=function(){return Ss.every((t=>t in e(this,vs,"f")))},ys=function(t){bs.log({partialDeviceInformation:t});Object.keys(t).forEach((s=>{e(this,ms,"a",ps).call(this,s,{[s]:t[s]})})),Object.assign(e(this,vs,"f"),t),bs.log({deviceInformation:e(this,vs,"f")}),e(this,ms,"a",ws)&&(bs.log("completed deviceInformation"),e(this,ms,"a",ps).call(this,"deviceInformation",{deviceInformation:this.information}))};const js=M("InformationManager",{log:!0}),qs=["leftInsole","rightInsole"],Gs=["left","right"],Hs=2,Js=30,Qs=["isCharging","getBatteryCurrent","getMtu","getId","getName","setName","getType","setType","getCurrentTime","setCurrentTime"],Ks=Qs;class Zs{constructor(){Ds.add(this),Ms.set(this,!1),Ws.set(this,void 0),_s.set(this,void 0),Us.set(this,""),xs.set(this,void 0),Ns.set(this,0),Ps.set(this,!1),H(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}get isCharging(){return e(this,Ms,"f")}get batteryCurrent(){return e(this,Ws,"f")}async getBatteryCurrent(){js.log("getting battery current...");const e=this.waitForEvent("getBatteryCurrent");this.sendMessage([{type:"getBatteryCurrent"}]),await e}get id(){return e(this,_s,"f")}get name(){return e(this,Us,"f")}async setName(e){js.assertTypeWithError(e,"string"),js.assertWithError(e.length>=2,`name must be greater than 2 characters long ("${e}" is ${e.length} characters long)`),js.assertWithError(e.length<30,`name must be less than 30 characters long ("${e}" is ${e.length} characters long)`);const t=B.encode(e);js.log({setNameData:t});const s=this.waitForEvent("getName");this.sendMessage([{type:"setName",data:t.buffer}]),await s}get type(){return e(this,xs,"f")}get typeEnum(){return qs.indexOf(this.type)}async setType(t){e(this,Ds,"m",Rs).call(this,t);const s=qs.indexOf(t);e(this,Ds,"m",$s).call(this,s)}get isInsole(){switch(this.type){case"leftInsole":case"rightInsole":return!0;default:return!1}}get insoleSide(){switch(this.type){case"leftInsole":return"left";case"rightInsole":return"right"}}get mtu(){return e(this,Ns,"f")}get isCurrentTimeSet(){return e(this,Ps,"f")}parseMessage(t,s){switch(js.log({messageType:t}),t){case"isCharging":const i=Boolean(s.getUint8(0));js.log({isCharging:i}),e(this,Ds,"m",Ts).call(this,i);break;case"getBatteryCurrent":const n=s.getFloat32(0,!0);js.log({batteryCurrent:n}),e(this,Ds,"m",Is).call(this,n);break;case"getId":const a=P.decode(s.buffer);js.log({id:a}),e(this,Ds,"m",Fs).call(this,a);break;case"getName":case"setName":const r=P.decode(s.buffer);js.log({name:r}),e(this,Ds,"m",Ls).call(this,r);break;case"getType":case"setType":const o=s.getUint8(0),c=qs[o];js.log({typeEnum:o,type:c}),e(this,Ds,"m",Os).call(this,c);break;case"getMtu":const h=s.getUint16(0,!0);js.log({mtu:h}),e(this,Ds,"m",Bs).call(this,h);break;case"getCurrentTime":case"setCurrentTime":const l=Number(s.getBigUint64(0,!0));e(this,Ds,"m",Vs).call(this,l);break;default:throw Error(`uncaught messageType ${t}`)}}clear(){t(this,Ps,!1,"f")}}Ms=new WeakMap,Ws=new WeakMap,_s=new WeakMap,Us=new WeakMap,xs=new WeakMap,Ns=new WeakMap,Ps=new WeakMap,Ds=new WeakSet,ks=function(){return this.eventDispatcher.dispatchEvent},Ts=function(s){js.assertTypeWithError(s,"boolean"),t(this,Ms,s,"f"),js.log({isCharging:e(this,Ms,"f")}),e(this,Ds,"a",ks).call(this,"isCharging",{isCharging:e(this,Ms,"f")})},Is=function(s){js.assertTypeWithError(s,"number"),t(this,Ws,s,"f"),js.log({batteryCurrent:e(this,Ws,"f")}),e(this,Ds,"a",ks).call(this,"getBatteryCurrent",{batteryCurrent:e(this,Ws,"f")})},Fs=function(s){js.assertTypeWithError(s,"string"),t(this,_s,s,"f"),js.log({id:e(this,_s,"f")}),e(this,Ds,"a",ks).call(this,"getId",{id:e(this,_s,"f")})},Ls=function(s){js.assertTypeWithError(s,"string"),t(this,Us,s,"f"),js.log({updatedName:e(this,Us,"f")}),e(this,Ds,"a",ks).call(this,"getName",{name:e(this,Us,"f")})},Rs=function(e){js.assertEnumWithError(e,qs)},As=function(e){js.assertTypeWithError(e,"number"),js.assertWithError(e in qs,`invalid typeEnum ${e}`)},Os=function(s){e(this,Ds,"m",Rs).call(this,s),s!=this.type?(t(this,xs,s,"f"),js.log({updatedType:e(this,xs,"f")}),e(this,Ds,"a",ks).call(this,"getType",{type:e(this,xs,"f")})):js.log("redundant type assignment")},$s=async function(t){e(this,Ds,"m",As).call(this,t);const s=Uint8Array.from([t]);js.log({setTypeData:s});const i=this.waitForEvent("getType");this.sendMessage([{type:"setType",data:s.buffer}]),await i},Bs=function(s){js.assertTypeWithError(s,"number"),e(this,Ns,"f")!=s?(t(this,Ns,s,"f"),e(this,Ds,"a",ks).call(this,"getMtu",{mtu:e(this,Ns,"f")})):js.log("redundant mtu assignment",s)},Vs=function(s){js.log({currentTime:s}),t(this,Ps,0!=s,"f"),e(this,Ps,"f")||e(this,Ds,"m",zs).call(this)},zs=async function(){js.log("setting current time...");const e=new DataView(new ArrayBuffer(8));e.setBigUint64(0,BigInt(Date.now()),!0);const t=this.waitForEvent("getCurrentTime");this.sendMessage([{type:"setCurrentTime",data:e.buffer}]),await t};const Xs=["none","strongClick100","strongClick60","strongClick30","sharpClick100","sharpClick60","sharpClick30","softBump100","softBump60","softBump30","doubleClick100","doubleClick60","tripleClick100","softFuzz60","strongBuzz100","alert750ms","alert1000ms","strongClick1_100","strongClick2_80","strongClick3_60","strongClick4_30","mediumClick100","mediumClick80","mediumClick60","sharpTick100","sharpTick80","sharpTick60","shortDoubleClickStrong100","shortDoubleClickStrong80","shortDoubleClickStrong60","shortDoubleClickStrong30","shortDoubleClickMedium100","shortDoubleClickMedium80","shortDoubleClickMedium60","shortDoubleSharpTick100","shortDoubleSharpTick80","shortDoubleSharpTick60","longDoubleSharpClickStrong100","longDoubleSharpClickStrong80","longDoubleSharpClickStrong60","longDoubleSharpClickStrong30","longDoubleSharpClickMedium100","longDoubleSharpClickMedium80","longDoubleSharpClickMedium60","longDoubleSharpTick100","longDoubleSharpTick80","longDoubleSharpTick60","buzz100","buzz80","buzz60","buzz40","buzz20","pulsingStrong100","pulsingStrong60","pulsingMedium100","pulsingMedium60","pulsingSharp100","pulsingSharp60","transitionClick100","transitionClick80","transitionClick60","transitionClick40","transitionClick20","transitionClick10","transitionHum100","transitionHum80","transitionHum60","transitionHum40","transitionHum20","transitionHum10","transitionRampDownLongSmooth2_100","transitionRampDownLongSmooth1_100","transitionRampDownMediumSmooth1_100","transitionRampDownMediumSmooth2_100","transitionRampDownShortSmooth1_100","transitionRampDownShortSmooth2_100","transitionRampDownLongSharp1_100","transitionRampDownLongSharp2_100","transitionRampDownMediumSharp1_100","transitionRampDownMediumSharp2_100","transitionRampDownShortSharp1_100","transitionRampDownShortSharp2_100","transitionRampUpLongSmooth1_100","transitionRampUpLongSmooth2_100","transitionRampUpMediumSmooth1_100","transitionRampUpMediumSmooth2_100","transitionRampUpShortSmooth1_100","transitionRampUpShortSmooth2_100","transitionRampUpLongSharp1_100","transitionRampUpLongSharp2_100","transitionRampUpMediumSharp1_100","transitionRampUpMediumSharp2_100","transitionRampUpShortSharp1_100","transitionRampUpShortSharp2_100","transitionRampDownLongSmooth1_50","transitionRampDownLongSmooth2_50","transitionRampDownMediumSmooth1_50","transitionRampDownMediumSmooth2_50","transitionRampDownShortSmooth1_50","transitionRampDownShortSmooth2_50","transitionRampDownLongSharp1_50","transitionRampDownLongSharp2_50","transitionRampDownMediumSharp1_50","transitionRampDownMediumSharp2_50","transitionRampDownShortSharp1_50","transitionRampDownShortSharp2_50","transitionRampUpLongSmooth1_50","transitionRampUpLongSmooth2_50","transitionRampUpMediumSmooth1_50","transitionRampUpMediumSmooth2_50","transitionRampUpShortSmooth1_50","transitionRampUpShortSmooth2_50","transitionRampUpLongSharp1_50","transitionRampUpLongSharp2_50","transitionRampUpMediumSharp1_50","transitionRampUpMediumSharp2_50","transitionRampUpShortSharp1_50","transitionRampUpShortSharp2_50","longBuzz100","smoothHum50","smoothHum40","smoothHum30","smoothHum20","smoothHum10"];var Ys,ei,ti,si,ii,ni,ai,ri,oi,ci,hi,li,fi,ui,gi,di,mi,pi,vi,wi,yi,bi,Si;const Ei=M("VibrationManager"),Ci=["front","rear"],Di=["waveformEffect","waveform"];class ki{constructor(){Ys.add(this),H(this)}static get MaxWaveformEffectSegmentDelay(){return e(this,ei,"f",ri)}get maxWaveformEffectSegmentDelay(){return ei.MaxWaveformEffectSegmentDelay}static get MaxWaveformEffectSegmentLoopCount(){return e(this,ei,"f",ci)}get maxWaveformEffectSegmentLoopCount(){return ei.MaxWaveformEffectSegmentLoopCount}static get MaxNumberOfWaveformEffectSegments(){return e(this,ei,"f",li)}get maxNumberOfWaveformEffectSegments(){return ei.MaxNumberOfWaveformEffectSegments}static get MaxWaveformEffectSequenceLoopCount(){return e(this,ei,"f",ui)}get maxWaveformEffectSequenceLoopCount(){return ei.MaxWaveformEffectSequenceLoopCount}static get MaxWaveformSegmentDuration(){return e(this,ei,"f",di)}get maxWaveformSegmentDuration(){return ei.MaxWaveformSegmentDuration}static get MaxNumberOfWaveformSegments(){return e(this,ei,"f",pi)}get maxNumberOfWaveformSegments(){return ei.MaxNumberOfWaveformSegments}async triggerVibration(t,s=!0){let i;t.forEach((t=>{const{type:s}=t;let n,{locations:a}=t;switch(a=a||Ci.slice(),s){case"waveformEffect":{const{segments:s,loopCount:i}=t;n=e(this,Ys,"m",wi).call(this,a,s,i)}break;case"waveform":{const{segments:s}=t;n=e(this,Ys,"m",yi).call(this,a,s)}break;default:throw Error(`invalid vibration type "${s}"`)}Ei.log({type:s,arrayBuffer:n}),i=z(i,n)})),await this.sendMessage([{type:"triggerVibration",data:i}],s)}}var Mi,Ti,Wi,Ii,_i,Fi,Ui,Li,xi,Ri,Ai,Oi,$i,Ni,Bi;ei=ki,Ys=new WeakSet,ti=function(e){Ei.assertTypeWithError(e,"string"),Ei.assertWithError(Ci.includes(e),`invalid location "${e}"`)},si=function(t){e(this,Ys,"m",ni).call(this,t),t.forEach((t=>{e(this,Ys,"m",ti).call(this,t)}))},ii=function(t){e(this,Ys,"m",si).call(this,t);let s=0;return t.forEach((e=>{const t=Ci.indexOf(e);s|=1<<t})),Ei.log({locationsBitmask:s}),Ei.assertWithError(s>0,"locationsBitmask must not be zero"),s},ni=function(e){Ei.assertWithError(Array.isArray(e),"passed non-array"),Ei.assertWithError(e.length>0,"passed empty array")},ai=function(e){Ei.assertWithError(Xs.includes(e),`invalid waveformEffect "${e}"`)},oi=function(t){if(null!=t.effect){const s=t.effect;e(this,Ys,"m",ai).call(this,s)}else{if(null==t.delay)throw Error("no effect or delay found in waveformEffectSegment");{const{delay:e}=t;Ei.assertWithError(e>=0,`delay must be 0ms or greater (got ${e})`),Ei.assertWithError(e<=this.maxWaveformEffectSegmentDelay,`delay must be ${this.maxWaveformEffectSegmentDelay}ms or less (got ${e})`)}}if(null!=t.loopCount){const{loopCount:s}=t;e(this,Ys,"m",hi).call(this,s)}},hi=function(e){Ei.assertTypeWithError(e,"number"),Ei.assertWithError(e>=0,`waveformEffectSegmentLoopCount must be 0 or greater (got ${e})`),Ei.assertWithError(e<=this.maxWaveformEffectSegmentLoopCount,`waveformEffectSegmentLoopCount must be ${this.maxWaveformEffectSegmentLoopCount} or fewer (got ${e})`)},fi=function(t){e(this,Ys,"m",ni).call(this,t),Ei.assertWithError(t.length<=this.maxNumberOfWaveformEffectSegments,`must have ${this.maxNumberOfWaveformEffectSegments} waveformEffectSegments or fewer (got ${t.length})`),t.forEach((t=>{e(this,Ys,"m",oi).call(this,t)}))},gi=function(e){Ei.assertTypeWithError(e,"number"),Ei.assertWithError(e>=0,`waveformEffectSequenceLoopCount must be 0 or greater (got ${e})`),Ei.assertWithError(e<=this.maxWaveformEffectSequenceLoopCount,`waveformEffectSequenceLoopCount must be ${this.maxWaveformEffectSequenceLoopCount} or fewer (got ${e})`)},mi=function(e){Ei.assertTypeWithError(e.amplitude,"number"),Ei.assertWithError(e.amplitude>=0,`amplitude must be 0 or greater (got ${e.amplitude})`),Ei.assertWithError(e.amplitude<=1,`amplitude must be 1 or less (got ${e.amplitude})`),Ei.assertTypeWithError(e.duration,"number"),Ei.assertWithError(e.duration>0,`duration must be greater than 0ms (got ${e.duration}ms)`),Ei.assertWithError(e.duration<=this.maxWaveformSegmentDuration,`duration must be ${this.maxWaveformSegmentDuration}ms or less (got ${e.duration}ms)`)},vi=function(t){e(this,Ys,"m",ni).call(this,t),Ei.assertWithError(t.length<=this.maxNumberOfWaveformSegments,`must have ${this.maxNumberOfWaveformSegments} waveformSegments or fewer (got ${t.length})`),t.forEach((t=>{e(this,Ys,"m",mi).call(this,t)}))},wi=function(t,s,i=0){e(this,Ys,"m",fi).call(this,s),e(this,Ys,"m",gi).call(this,i);let n=[],a=0;const r=s.some((e=>{const{loopCount:t}=e;return null!=t&&t>0}))||0!=i;for(let e=0;e<s.length||r&&e<this.maxNumberOfWaveformEffectSegments;e++){const t=s[e]||{effect:"none"};if(null!=t.effect){const e=t.effect;n[a++]=Xs.indexOf(e)}else{if(null==t.delay)throw Error("invalid waveformEffectSegment");{const{delay:e}=t;n[a++]=128|Math.floor(e/10)}}}const o=0!=i;for(let e=0;e<s.length||o&&e<this.maxNumberOfWaveformEffectSegments;e++){const t=s[e]?.loopCount||0;0!=e&&4!=e||(n[a]=0);const i=e%4*2;n[a]|=t<<i,3!=e&&7!=e||a++}0!=i&&(n[a++]=i);const c=new DataView(Uint8Array.from(n).buffer);return Ei.log({dataArray:n,dataView:c}),e(this,Ys,"m",Si).call(this,t,"waveformEffect",c)},yi=function(t,s){e(this,Ys,"m",vi).call(this,s);const i=new DataView(new ArrayBuffer(2*s.length));return s.forEach(((e,t)=>{i.setUint8(2*t,Math.floor(127*e.amplitude)),i.setUint8(2*t+1,Math.floor(e.duration/10))})),Ei.log({dataView:i}),e(this,Ys,"m",Si).call(this,t,"waveform",i)},bi=function(e){Ei.assertTypeWithError(e,"string"),Ei.assertWithError(Di.includes(e),`invalid vibrationType "${e}"`)},Si=function(t,s,i){Ei.assertWithError(i?.byteLength>0,"no data received");const n=e(this,Ys,"m",ii).call(this,t);e(this,Ys,"m",bi).call(this,s);const a=Di.indexOf(s);Ei.log({locationsBitmask:n,vibrationTypeIndex:a,dataView:i});const r=z(n,a,i.byteLength,i);return Ei.log({data:r}),r},ri={value:1270},ci={value:3},li={value:8},ui={value:6},di={value:2550},pi={value:20};const Pi=M("BaseConnectionManager",{log:!0}),Vi=["not connected","connecting","connected","disconnecting"],zi=[...Qs,...Ft,...ut,"triggerVibration",...ls,...Ie],ji=[...Ss,"batteryLevel","smp","rx","tx",...zi];class qi{static get isSupported(){return!1}get isSupported(){return e(this,Mi,"a",Ii).isSupported}get type(){return e(this,Mi,"a",Ii).type}constructor(){Mi.add(this),Fi.set(this,"not connected"),Oi.set(this,[]),Ni.set(this,new x(e(this,Mi,"m",Bi).bind(this),5e3)),e(this,Mi,"m",_i).call(this)}get status(){return e(this,Fi,"f")}set status(s){Pi.assertEnumWithError(s,Vi),e(this,Fi,"f")!=s?(Pi.log(`new connection status "${s}"`),t(this,Fi,s,"f"),this.onStatusUpdated(this.status),this.isConnected?e(this,Ni,"f").start():e(this,Ni,"f").stop(),"not connected"==e(this,Fi,"f")&&(this.mtu=void 0)):Pi.log(`tried to assign same connection status "${s}"`)}get isConnected(){return"connected"==this.status}async connect(){e(this,Mi,"m",Ui).call(this),e(this,Mi,"m",Li).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){e(this,Mi,"m",Ui).call(this),e(this,Mi,"m",Li).call(this),Pi.assert(this.canReconnect,"unable to reconnect")}async disconnect(){e(this,Mi,"m",xi).call(this),e(this,Mi,"m",Ri).call(this),this.status="disconnecting",Pi.log("disconnecting from device...")}async sendSmpMessage(t){e(this,Mi,"m",Ai).call(this),Pi.log("sending smp message",t)}async sendTxMessages(t,s=!0){if(e(this,Mi,"m",Ai).call(this),t&&e(this,Oi,"f").push(...t),!s)return;Pi.log("sendTxMessages",e(this,Oi,"f").slice());const i=e(this,Oi,"f").map((t=>{e(Ti,Ti,"m",Wi).call(Ti,t.type);const s=zi.indexOf(t.type),i=new DataView(new ArrayBuffer(2));return i.setUint16(0,t.data?.byteLength||0,!0),z(s,i,t.data)}));if(this.mtu)for(;i.length>0;){let e=0,t=0;i.some((s=>{if(e+s.byteLength>this.mtu-3)return!0;t++,e+=s.byteLength}));const s=i.splice(0,t);Pi.log({arrayBufferCount:t,arrayBuffersToSend:s});const n=z(...s);Pi.log("sending arrayBuffer",n),await this.sendTxData(n)}else{const e=z(...i);Pi.log("sending arrayBuffer",e),await this.sendTxData(e)}e(this,Oi,"f").length=0}async sendTxData(e){Pi.log("sendTxData",e)}parseRxMessage(t){ct(t,zi,e(this,Mi,"m",$i).bind(this),null,!0)}}Ti=qi,Fi=new WeakMap,Oi=new WeakMap,Ni=new WeakMap,Mi=new WeakSet,Wi=function(e){Pi.assertEnumWithError(e,zi)},Ii=function(){return this.constructor},_i=function(){Pi.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},Ui=function(){Pi.assertWithError(!this.isConnected,"device is already connected")},Li=function(){Pi.assertWithError("connecting"!=this.status,"device is already connecting")},xi=function(){Pi.assertWithError(this.isConnected,"device is not connected")},Ri=function(){Pi.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},Ai=function(){e(this,Mi,"m",xi).call(this),e(this,Mi,"m",Ri).call(this)},$i=function(e,t){Pi.log({messageType:e,dataView:t}),this.onMessageReceived(e,t)},Bi=function(){this.isConnected||(Pi.log("timer detected disconnection"),this.status="not connected")};const Gi=M("EventUtils",{log:!1});function Hi(e,t){let s=e.addEventListener||e.addListener||e.on||e.AddEventListener;Gi.assertWithError(s,"no add listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}function Ji(e,t){let s=e.removeEventListener||e.removeListener||e.RemoveEventListener;Gi.assertWithError(s,"no remove listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}const Qi=M("bluetoothUUIDs",{log:!1});if(i)var Ki=window.BluetoothUUID;function Zi(e){return Qi.assertTypeWithError(e,"string"),Qi.assertWithError(4==e.length,"value must be 4 characters long"),`ea6da725-${e}-4f9b-893d-c3913e33b39f`}function Xi(e){return Ki?.getCharacteristic?.(e)}function Yi(e){return Ki?.getService?.(e)}const en=Object.freeze({services:{deviceInformation:{uuid:Yi("device_information"),characteristics:{manufacturerName:{uuid:Xi("manufacturer_name_string")},modelNumber:{uuid:Xi("model_number_string")},hardwareRevision:{uuid:Xi("hardware_revision_string")},firmwareRevision:{uuid:Xi("firmware_revision_string")},softwareRevision:{uuid:Xi("software_revision_string")},pnpId:{uuid:Xi("pnp_id")},serialNumber:{uuid:Xi("serial_number_string")}}},battery:{uuid:Yi("battery_service"),characteristics:{batteryLevel:{uuid:Xi("battery_level")}}},main:{uuid:Zi("0000"),characteristics:{rx:{uuid:Zi("1000")},tx:{uuid:Zi("1001")}}},smp:{uuid:"8d53dc1d-1db7-4cd3-868b-8a527460aa84",characteristics:{smp:{uuid:"da2e7828-fbce-4e01-ae9e-261174997c48"}}}}}),tn=[en.services.main.uuid],sn=[en.services.deviceInformation.uuid,en.services.battery.uuid,en.services.smp.uuid];function nn(e){e=e.toString().toLowerCase();return Object.keys(en.services).find((t=>{let s=en.services[t].uuid.toString();return 4==e.length&&(s=s.slice(4,8)),e.includes("-")||(s=s.replaceAll("-","")),e==s}))}const an=[],rn=[];function on(e){var t;return e=e.toString().toLowerCase(),Object.values(en.services).some((s=>{const i=Object.keys(s.characteristics);return t=i.find((t=>{let i=s.characteristics[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))})),t}function cn(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"rx":case"tx":case"smp":t.read=!1}switch(e){case"batteryLevel":case"rx":case"smp":t.notify=!0}switch(e){case"tx":case"smp":t.writeWithoutResponse=!0}return t}Object.values(en.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((s=>{const i=e.characteristics[s];tn.includes(e.uuid)&&(an.push(i.uuid),t.push(s)),rn.push(i.uuid)}))}),[]);const hn=M("BluetoothConnectionManager",{log:!0});class ln extends qi{constructor(){super(...arguments),this.isInRange=!0}onCharacteristicValueChanged(e,t){"rx"==e?this.parseRxMessage(t):this.onMessageReceived?.(e,t)}async writeCharacteristic(e,t){hn.log("writeCharacteristic",...arguments)}async sendSmpMessage(e){super.sendSmpMessage(e),await this.writeCharacteristic("smp",e)}async sendTxData(e){super.sendTxData(e),await this.writeCharacteristic("tx",e)}}var fn,un,gn,dn,mn,pn,vn,wn,yn,bn,Sn;const En=M("WebBluetoothConnectionManager",{log:!0});var Cn;i&&(Cn=window.navigator.bluetooth);class Dn extends ln{constructor(){super(...arguments),fn.add(this),un.set(this,{characteristicvaluechanged:e(this,fn,"m",yn).bind(this)}),gn.set(this,{gattserverdisconnected:e(this,fn,"m",Sn).bind(this)}),dn.set(this,void 0),mn.set(this,new Map),pn.set(this,new Map)}get bluetoothId(){return this.device.id}static get isSupported(){return Boolean(Cn)}static get type(){return"webBluetooth"}get device(){return e(this,dn,"f")}set device(s){e(this,dn,"f")!=s?(e(this,dn,"f")&&Ji(e(this,dn,"f"),e(this,gn,"f")),s&&Hi(s,e(this,gn,"f")),t(this,dn,s,"f")):En.log("tried to assign the same BluetoothDevice")}get server(){return e(this,dn,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const t=await Cn.requestDevice({filters:[{services:tn}],optionalServices:i?sn:[]});En.log("got BluetoothDevice"),this.device=t,En.log("connecting to device...");const s=await this.server.connect();En.log(`connected to device? ${s.connected}`),await e(this,fn,"m",vn).call(this),En.log("fully connected"),this.status="connected"}catch(t){En.error(t),this.status="not connected",this.server?.disconnect(),e(this,fn,"m",wn).call(this)}}async disconnect(){await e(this,fn,"m",wn).call(this),await super.disconnect(),this.server?.disconnect(),this.status="not connected"}async writeCharacteristic(t,s){super.writeCharacteristic(t,s);const i=e(this,pn,"f").get(t);En.assertWithError(i,`${t} characteristic not found`),En.log("writing characteristic",i,s);const n=i.properties||cn(t);n.writeWithoutResponse?(En.log("writing without response"),await i.writeValueWithoutResponse(s)):(En.log("writing with response"),await i.writeValueWithResponse(s)),En.log("wrote characteristic"),n.read&&!n.notify&&(En.log("reading value after write..."),await i.readValue(),(o||c)&&e(this,fn,"m",bn).call(this,i))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect(),En.log("attempting to reconnect..."),this.status="connecting";try{await this.server.connect()}catch(e){En.error(e),this.isInRange=!1}this.isConnected?(En.log("successfully reconnected!"),await e(this,fn,"m",vn).call(this),this.status="connected"):(En.log("unable to reconnect"),this.status="not connected")}}un=new WeakMap,gn=new WeakMap,dn=new WeakMap,mn=new WeakMap,pn=new WeakMap,fn=new WeakSet,vn=async function(){e(this,fn,"m",wn).call(this),En.log("getting services...");const t=await this.server.getPrimaryServices();En.log("got services",t.length),await this.server.getPrimaryService("8d53dc1d-1db7-4cd3-868b-8a527460aa84"),En.log("getting characteristics...");for(const s in t){const i=t[s];En.log({service:i});const n=nn(i.uuid);En.assertWithError(n,`no name found for service uuid "${i.uuid}"`),En.log(`got "${n}" service`),i.name=n,e(this,mn,"f").set(n,i),En.log(`getting characteristics for "${n}" service`);const a=await i.getCharacteristics();En.log(`got characteristics for "${n}" service`);for(const t in a){const s=a[t];En.log({characteristic:s});const i=on(s.uuid);En.assertWithError(Boolean(i),`no name found for characteristic uuid "${s.uuid}" in "${n}" service`),En.log(`got "${i}" characteristic in "${n}" service`),s.name=i,e(this,pn,"f").set(i,s),Hi(s,e(this,un,"f"));const r=s.properties||cn(i);r.notify&&(En.log(`starting notifications for "${i}" characteristic`),await s.startNotifications()),r.read&&(En.log(`reading "${i}" characteristic...`),await s.readValue(),(o||c)&&e(this,fn,"m",bn).call(this,s))}}},wn=async function(){this.device&&Ji(this.device,e(this,gn,"f"));const t=Array.from(e(this,pn,"f").keys()).map((t=>{const s=e(this,pn,"f").get(t);Ji(s,e(this,un,"f"));if((s.properties||cn(t)).notify)return En.log(`stopping notifications for "${t}" characteristic`),s.stopNotifications()}));return Promise.allSettled(t)},yn=function(t){En.log("oncharacteristicvaluechanged");const s=t.target;e(this,fn,"m",bn).call(this,s)},bn=function(e){En.log("onCharacteristicValue");const t=e.name;En.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),En.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const s=e.value;En.assertWithError(s,`no data found for "${t}" characteristic`),En.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(s.buffer)));try{this.onCharacteristicValueChanged(t,s)}catch(e){En.error(e)}},Sn=function(){En.log("gattserverdisconnected"),this.status="not connected"};const kn=4294967296,Mn=9007199254740992;const Tn={encode:function(e){let t,s=new ArrayBuffer(256),i=new DataView(s),n=0;function a(e){let a=s.byteLength;const r=n+e;for(;a<r;)a<<=1;if(a!==s.byteLength){const e=i;s=new ArrayBuffer(a),i=new DataView(s);const t=n+3>>2;for(let s=0;s<t;++s)i.setUint32(s<<2,e.getUint32(s<<2))}return t=e,i}function r(){n+=t}function o(e){r(a(1).setUint8(n,e))}function c(e){const t=a(e.length);for(let s=0;s<e.length;++s)t.setUint8(n+s,e[s]);r()}function h(e,t){t<24?o(e<<5|t):t<256?(o(e<<5|24),o(t)):t<65536?(o(e<<5|25),function(e){r(a(2).setUint16(n,e))}(t)):t<4294967296?(o(e<<5|26),function(e){r(a(4).setUint32(n,e))}(t)):(o(e<<5|27),function(e){const t=e%kn,s=(e-t)/kn,i=a(8);i.setUint32(n,s),i.setUint32(n+4,t),r()}(t))}if(function e(t){let s;const i=[];let l;if(!1===t)return o(244);if(!0===t)return o(245);if(null===t)return o(246);if(void 0===t)return o(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(t>=0&&t<=Mn)return h(0,t);if(-Mn<=t&&t<0)return h(1,-(t+1))}return o(251),function(e){r(a(8).setFloat64(n,e))}(t);case"string":for(s=0;s<t.length;++s){let e=t.charCodeAt(s);e<128?i.push(e):e<2048?(i.push(192|e>>6),i.push(128|63&e)):e<55296?(i.push(224|e>>12),i.push(128|e>>6&63),i.push(128|63&e)):(e=(1023&e)<<10,e|=1023&t.charCodeAt(++s),e+=65536,i.push(240|e>>18),i.push(128|e>>12&63),i.push(128|e>>6&63),i.push(128|63&e))}return h(3,i.length),c(i);default:if(Array.isArray(t))for(l=t.length,h(4,l),s=0;s<l;++s)e(t[s]);else if(t instanceof Uint8Array)h(2,t.length),c(t);else{const i=Object.keys(t);for(l=i.length,h(5,l),s=0;s<l;++s){const n=i[s];e(n),e(t[n])}}}}(e),"slice"in s)return s.slice(0,n);const l=new ArrayBuffer(n),f=new DataView(l);for(let e=0;e<n;++e)f.setUint8(e,i.getUint8(e));return l},decode:function(e,t,s){const i=new DataView(e);let n=0;function a(e,t){return n+=e,t}function r(t){return a(t,new Uint8Array(e,n,t))}function o(){return a(1,i.getUint8(n))}function c(){return a(2,i.getUint16(n))}function h(){return a(4,i.getUint32(n))}function l(){return 255===i.getUint8(n)&&(n+=1,!0)}function f(e){if(e<24)return e;if(24===e)return o();if(25===e)return c();if(26===e)return h();if(27===e)return h()*kn+h();if(31===e)return-1;throw new Error("Invalid length encoding")}function u(e){const t=o();if(255===t)return-1;const s=f(31&t);if(s<0||t>>5!==e)throw new Error("Invalid indefinite length element");return s}function g(e,t){for(let s=0;s<t;++s){let s=o();128&s&&(s<224?(s=(31&s)<<6|63&o(),t-=1):s<240?(s=(15&s)<<12|(63&o())<<6|63&o(),t-=2):(s=(15&s)<<18|(63&o())<<12|(63&o())<<6|63&o(),t-=3)),s<65536?e.push(s):(s-=65536,e.push(55296|s>>10),e.push(56320|1023&s))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof s&&(s=function(){});const d=function e(){const h=o(),d=h>>5,m=31&h;let p,v;if(7===d)switch(m){case 25:return function(){const e=new ArrayBuffer(4),t=new DataView(e),s=c(),i=32768&s;let n=31744&s;const a=1023&s;if(31744===n)n=261120;else if(0!==n)n+=114688;else if(0!==a)return(i?-1:1)*a*5.960464477539063e-8;return t.setUint32(0,i<<16|n<<13|a<<13),t.getFloat32(0)}();case 26:return a(4,i.getFloat32(n));case 27:return a(8,i.getFloat64(n))}if(v=f(m),v<0&&(d<2||d>6))throw new Error("Invalid length");const w=[];let y;const b={};switch(d){case 0:return v;case 1:return-1-v;case 2:if(v<0){const e=[];let t=0;for(;(v=u(d))>=0;)t+=v,e.push(r(v));const s=new Uint8Array(t);let i=0;for(p=0;p<e.length;++p)s.set(e[p],i),i+=e[p].length;return s}return r(v);case 3:if(v<0)for(;(v=u(d))>=0;)g(w,v);else g(w,v);return String.fromCharCode.apply(null,w);case 4:if(v<0)for(y=[];!l();)y.push(e());else for(y=new Array(v),p=0;p<v;++p)y[p]=e();return y;case 5:for(p=0;p<v||v<0&&!l();++p){b[e()]=e()}return b;case 6:return t(e(),v);case 7:switch(v){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return s(v)}}}();if(n!==e.byteLength)throw new Error("Remaining bytes");return d}},Wn=M("mcumgr",{log:!0}),In=0,_n=1,Fn=2,Un=3,Ln=0,xn=1,Rn=8,An=0,On=2,$n=3,Nn=5,Bn=0,Pn=1,Vn=5,zn=0;class jn{constructor(){this._mtu=256,this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}onMessage(e){return this._messageCallback=e,this}onImageUploadNext(e){return this._imageUploadNextCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}onFileUploadNext(e){return this._fileUploadNextCallback=e,this}onFileUploadProgress(e){return this._fileUploadProgressCallback=e,this}onFileUploadFinished(e){return this._fileUploadFinishedCallback=e,this}onFileDownloadNext(e){return this._fileDownloadNextCallback=e,this}onFileDownloadProgress(e){return this._fileDownloadProgressCallback=e,this}onFileDownloadFinished(e){return this._fileDownloadFinishedCallback=e,this}_getMessage(e,t,s,i){let n=[];void 0!==i&&(n=[...new Uint8Array(Tn.encode(i))]);const a=255&n.length,r=[e,0,n.length>>8,a,t>>8,255&t,this._seq,s,...n];return this._seq=(this._seq+1)%256,r}_notification(e){Wn.log("mcumgr - message received");const t=new Uint8Array(e);this._buffer=new Uint8Array([...this._buffer,...t]);const s=256*this._buffer[2]+this._buffer[3];this._buffer.length<s+8||(this._processMessage(this._buffer.slice(0,s+8)),this._buffer=this._buffer.slice(s+8))}_processMessage(e){const[t,,s,i,n,a,,r]=e,o=Tn.decode(e.slice(8).buffer),c=256*s+i,h=256*n+a;return Wn.log("mcumgr - Process Message - Group: "+h+", Id: "+r+", Off: "+o.off),h===xn&&r===Pn&&o.off?(this._uploadOffset=o.off,void this._uploadNext()):t===Un&&h===Rn&&r===zn&&o.off?(this._uploadFileOffset=o.off,void this._uploadFileNext()):t===_n&&h===Rn&&r===zn?(this._downloadFileOffset+=o.data.length,null!=o.len&&(this._downloadFileLength=o.len),Wn.log("downloaded "+this._downloadFileOffset+" bytes of "+this._downloadFileLength),this._downloadFileLength>0&&this._fileDownloadProgressCallback({percentage:Math.floor(this._downloadFileOffset/this._downloadFileLength*100)}),this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}),void this._downloadFileNext()):void(this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}))}cmdReset(){return this._getMessage(Fn,Ln,Nn)}smpEcho(e){return this._getMessage(Fn,Ln,An,{d:e})}cmdImageState(){return this._getMessage(In,xn,Bn)}cmdImageErase(){return this._getMessage(Fn,xn,Vn,{})}cmdImageTest(e){return this._getMessage(Fn,xn,Bn,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._getMessage(Fn,xn,Bn,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(!this._uploadImage)return;if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-Tn.encode(e).byteLength-8-3-5;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t;const s=this._getMessage(Fn,xn,Pn,e);Wn.log("mcumgr - _uploadNext: Message Length: "+s.length),this._imageUploadNextCallback({packet:s})}async reset(){this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}async cmdUpload(e,t=0){this._uploadIsInProgress?Wn.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async cmdUploadFile(e,t){this._uploadIsInProgress?Wn.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadFileOffset=0,this._uploadFile=e,this._uploadFilename=t,this._uploadFileNext())}async _uploadFileNext(){if(Wn.log("uploadFileNext - offset: "+this._uploadFileOffset+", length: "+this._uploadFile.byteLength),this._uploadFileOffset>=this._uploadFile.byteLength)return this._uploadIsInProgress=!1,void this._fileUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadFileOffset};0===this._uploadFileOffset&&(e.len=this._uploadFile.byteLength),e.name=this._uploadFilename,this._fileUploadProgressCallback({percentage:Math.floor(this._uploadFileOffset/this._uploadFile.byteLength*100)});const t=this._mtu-Tn.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadFile.slice(this._uploadFileOffset,this._uploadFileOffset+t)),this._uploadFileOffset+=t;const s=this._getMessage(Fn,Rn,zn,e);Wn.log("mcumgr - _uploadNext: Message Length: "+s.length),this._fileUploadNextCallback({packet:s})}async cmdDownloadFile(e,t){this._downloadIsInProgress?Wn.error("Download is already in progress."):(this._downloadIsInProgress=!0,this._downloadFileOffset=0,this._downloadFileLength=0,this._downloadRemoteFilename=e,this._downloadLocalFilename=t,this._downloadFileNext())}async _downloadFileNext(){if(this._downloadFileLength>0&&this._downloadFileOffset>=this._downloadFileLength)return this._downloadIsInProgress=!1,void this._fileDownloadFinishedCallback();const e={off:this._downloadFileOffset};0===this._downloadFileOffset&&(e.name=this._downloadRemoteFilename);const t=this._getMessage(In,Rn,zn,e);Wn.log("mcumgr - _downloadNext: Message Length: "+t.length),this._fileDownloadNextCallback({packet:t})}async imageInfo(e){const t={},s=new Uint8Array(e);if(s.length<32)throw new Error("Invalid image (too short file)");if(61!==s[0]||184!==s[1]||243!==s[2]||150!==s[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==s[4]||0!==s[5]||0!==s[6]||0!==s[7])throw new Error("Invalid image (wrong load address)");const i=s[8]+256*s[9];if(0!==s[10]||0!==s[11])throw new Error("Invalid image (wrong protected TLV area size)");const n=s[12]+256*s[13]+65536*s[14]+s[15]*2**24;if(t.imageSize=n,s.length<n+i)throw new Error("Invalid image (wrong image size)");if(0!==s[16]||0!==s[17]||0!==s[18]||0!==s[19])throw new Error("Invalid image (wrong flags)");const a=`${s[20]}.${s[21]}.${s[22]+256*s[23]}`;return t.version=a,t.hash=[...new Uint8Array(await this._hash(e.slice(0,n+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}var qn,Gn,Hn,Jn,Qn,Kn,Zn,Xn,Yn,ea,ta,sa,ia,na,aa,ra,oa,ca,ha,la,fa;const ua=M("FirmwareManager",{log:!0}),ga=["smp"],da=[...ga,"firmwareImages","firmwareUploadProgress","firmwareStatus","firmwareUploadComplete"],ma=["idle","uploading","uploaded","pending","testing","erasing"];class pa{constructor(){qn.add(this),Hn.set(this,"idle"),Qn.set(this,void 0),Xn.set(this,void 0),Yn.set(this,new jn),e(this,qn,"m",ea).call(this),H(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}parseMessage(t,s){if(ua.log({messageType:t}),"smp"!==t)throw Error(`uncaught messageType ${t}`);e(this,Yn,"f")._notification(Array.from(new Uint8Array(s.buffer))),e(this,qn,"a",Gn).call(this,"smp",{dataView:s})}async uploadFirmware(t){ua.log("uploadFirmware",t);const s=this.waitForEvent("firmwareUploadComplete");await this.getImages();const i=await G(t),n=await e(this,Yn,"f").imageInfo(i);ua.log({imageInfo:n}),e(this,Yn,"f").cmdUpload(i,1),e(this,qn,"m",Jn).call(this,"uploading"),await s}get status(){return e(this,Hn,"f")}get images(){return e(this,Qn,"f")}async getImages(){const t=this.waitForEvent("firmwareImages");ua.log("getting firmware image state..."),this.sendMessage(Uint8Array.from(e(this,Yn,"f").cmdImageState()).buffer),await t}async testImage(t=1){if(e(this,qn,"m",Zn).call(this,t),e(this,qn,"m",Kn).call(this),!e(this,Qn,"f")[t])return void ua.log(`image ${t} not found`);if(1==e(this,Qn,"f")[t].pending)return void ua.log(`image ${t} is already pending`);if(e(this,Qn,"f")[t].empty)return void ua.log(`image ${t} is empty`);const s=this.waitForEvent("smp");ua.log("testing firmware image..."),this.sendMessage(Uint8Array.from(e(this,Yn,"f").cmdImageTest(e(this,Qn,"f")[t].hash)).buffer),await s}async eraseImage(){e(this,qn,"m",Kn).call(this);const t=this.waitForEvent("smp");ua.log("erasing image..."),this.sendMessage(Uint8Array.from(e(this,Yn,"f").cmdImageErase()).buffer),e(this,qn,"m",Jn).call(this,"erasing"),await t,await this.getImages()}async confirmImage(t=0){if(e(this,qn,"m",Zn).call(this,t),e(this,qn,"m",Kn).call(this),!0===e(this,Qn,"f")[t].confirmed)return void ua.log(`image ${t} is already confirmed`);const s=this.waitForEvent("smp");ua.log("confirming image..."),this.sendMessage(Uint8Array.from(e(this,Yn,"f").cmdImageConfirm(e(this,Qn,"f")[t].hash)).buffer),await s}async echo(t){ua.assertTypeWithError(t,"string");const s=this.waitForEvent("smp");ua.log("sending echo..."),this.sendMessage(Uint8Array.from(e(this,Yn,"f").smpEcho(t)).buffer),await s}async reset(){const t=this.waitForEvent("smp");ua.log("resetting..."),this.sendMessage(Uint8Array.from(e(this,Yn,"f").cmdReset()).buffer),await t}get mtu(){return e(this,Xn,"f")}set mtu(s){t(this,Xn,s,"f"),e(this,Yn,"f")._mtu=s}}var va,wa,ya,ba,Sa,Ea,Ca,Da,ka,Ma,Ta,Wa,Ia,_a,Fa,Ua,La,xa,Ra,Aa,Oa,$a,Na,Ba,Pa,Va,za,ja,qa,Ga,Ha,Ja,Qa,Ka,Za,Xa,Ya,er,tr,sr,ir,nr,ar,rr,or,cr,hr,lr,fr,ur;Hn=new WeakMap,Qn=new WeakMap,Xn=new WeakMap,Yn=new WeakMap,qn=new WeakSet,Gn=function(){return this.eventDispatcher.dispatchEvent},Jn=function(s){ua.assertEnumWithError(s,ma),e(this,Hn,"f")!=s?(t(this,Hn,s,"f"),ua.log({firmwareStatus:e(this,Hn,"f")}),e(this,qn,"a",Gn).call(this,"firmwareStatus",{firmwareStatus:e(this,Hn,"f")})):ua.log(`redundant firmwareStatus assignment "${s}"`)},Kn=function(){ua.assertWithError(e(this,Qn,"f"),"didn't get imageState")},Zn=function(e){ua.assertTypeWithError(e,"number"),ua.assertWithError(0==e||1==e,"imageIndex must be 0 or 1")},ea=function(){e(this,Yn,"f").onMessage(e(this,qn,"m",ta).bind(this)),e(this,Yn,"f").onFileDownloadNext(e(this,qn,"m",sa)),e(this,Yn,"f").onFileDownloadProgress(e(this,qn,"m",ia).bind(this)),e(this,Yn,"f").onFileDownloadFinished(e(this,qn,"m",na).bind(this)),e(this,Yn,"f").onFileUploadNext(e(this,qn,"m",aa).bind(this)),e(this,Yn,"f").onFileUploadProgress(e(this,qn,"m",ra).bind(this)),e(this,Yn,"f").onFileUploadFinished(e(this,qn,"m",oa).bind(this)),e(this,Yn,"f").onImageUploadNext(e(this,qn,"m",ca).bind(this)),e(this,Yn,"f").onImageUploadProgress(e(this,qn,"m",ha).bind(this)),e(this,Yn,"f").onImageUploadFinished(e(this,qn,"m",la).bind(this))},ta=function({op:t,group:s,id:i,data:n,length:a}){switch(ua.log("onMcuMessage",...arguments),s){case Ln:switch(i){case An:ua.log(`echo "${n.r}"`);break;case On:ua.table(n.tasks);break;case $n:ua.log(n)}break;case xn:if(i===Bn)e(this,qn,"m",fa).call(this,n);break;default:throw Error(`uncaught mcuMessage group ${s}`)}},sa=function(){ua.log("onMcuFileDownloadNext",...arguments)},ia=function(){ua.log("onMcuFileDownloadProgress",...arguments)},na=function(){ua.log("onMcuFileDownloadFinished",...arguments)},aa=function(){ua.log("onMcuFileUploadNext")},ra=function(){ua.log("onMcuFileUploadProgress")},oa=function(){ua.log("onMcuFileUploadFinished")},ca=function({packet:e}){ua.log("onMcuImageUploadNext"),this.sendMessage(Uint8Array.from(e).buffer)},ha=function({percentage:t}){const s=t/100;ua.log("onMcuImageUploadProgress",...arguments),e(this,qn,"a",Gn).call(this,"firmwareUploadProgress",{progress:s})},la=async function(){ua.log("onMcuImageUploadFinished",...arguments),await this.getImages(),e(this,qn,"a",Gn).call(this,"firmwareUploadProgress",{progress:100}),e(this,qn,"a",Gn).call(this,"firmwareUploadComplete",{})},fa=function({images:s}){if(!s)return void ua.log("no images found");t(this,Qn,s,"f"),ua.log("images",e(this,Qn,"f"));let i="idle";2==e(this,Qn,"f").length&&(e(this,Qn,"f")[1].bootable?e(this,Qn,"f")[0].confirmed?e(this,Qn,"f")[1].pending?(ua.log("reset to upload to the new firmware image"),i="pending"):(ua.log("Slot 1 has a valid image. run testImage() to test it or upload a different image."),i="uploaded"):(ua.log('Slot 0 has a valid image. Click "Confirm Image" to confirm it or wait and the device will swap images back.'),i="testing"):ua.warn('Slot 1 has a invalid image. Click "Erase Image" to erase it or upload a different image')),1==e(this,Qn,"f").length&&(e(this,Qn,"f").push({slot:1,empty:!0,version:"Empty",pending:!1,confirmed:!1,bootable:!1,active:!1,permanent:!1}),ua.log("Select a firmware upload image to upload to slot 1.")),e(this,qn,"m",Jn).call(this,i),e(this,qn,"a",Gn).call(this,"firmwareImages",{firmwareImages:e(this,Qn,"f")})};const gr=M("Device",{log:!0}),dr=[...[...Vi,"connectionStatus","isConnected"],...ji,"connectionMessage",...Ks,...Es,...gt,...xe,...fs,...da];class mr{get bluetoothId(){return e(this,Ea,"f")?.bluetoothId}constructor(){va.add(this),ba.set(this,new I(this,dr)),Ea.set(this,void 0),this.sendTxMessages=e(this,va,"m",Ca).bind(this),Da.set(this,!1),Fa.set(this,wa.ReconnectOnDisconnection),Ua.set(this,void 0),this.latestConnectionMessage=new Map,$a.set(this,new Cs),Na.set(this,0),Pa.set(this,new Zs),Va.set(this,new Ut),ja.set(this,wa.ClearSensorConfigurationOnLeave),Ga.set(this,new dt),Ha.set(this,new ki),Ja.set(this,new Re),Qa.set(this,new ds),Ka.set(this,new pa),this.sendSmpMessage=e(this,va,"m",Za).bind(this),e(this,$a,"f").eventDispatcher=e(this,ba,"f"),e(this,Pa,"f").sendMessage=this.sendTxMessages,e(this,Pa,"f").eventDispatcher=e(this,ba,"f"),e(this,Va,"f").sendMessage=this.sendTxMessages,e(this,Va,"f").eventDispatcher=e(this,ba,"f"),e(this,Ga,"f").eventDispatcher=e(this,ba,"f"),e(this,Ha,"f").sendMessage=this.sendTxMessages,e(this,Qa,"f").sendMessage=this.sendTxMessages,e(this,Qa,"f").eventDispatcher=e(this,ba,"f"),e(this,Ja,"f").sendMessage=this.sendTxMessages,e(this,Ja,"f").eventDispatcher=e(this,ba,"f"),e(this,Ka,"f").sendMessage=this.sendSmpMessage,e(this,Ka,"f").eventDispatcher=e(this,ba,"f"),this.addEventListener("getMtu",(()=>{e(this,Ka,"f").mtu=this.mtu,e(this,Ja,"f").mtu=this.mtu,this.connectionManager.mtu=this.mtu})),this.addEventListener("getType",(()=>{e(wa,wa,"f",Ya)&&e(wa,wa,"m",rr).call(wa,this)})),i&&window.addEventListener("beforeunload",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()})),n&&process.on("exit",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()})),this.addEventListener("isConnected",(()=>{e(wa,wa,"m",lr).call(wa,this)}))}get addEventListener(){return e(this,ba,"f").addEventListener}get removeEventListener(){return e(this,ba,"f").removeEventListener}get waitForEvent(){return e(this,ba,"f").waitForEvent}get connectionManager(){return e(this,Ea,"f")}set connectionManager(s){this.connectionManager!=s?(this.connectionManager&&(this.connectionManager.onStatusUpdated=void 0,this.connectionManager.onMessageReceived=void 0),s&&(s.onStatusUpdated=e(this,va,"m",La).bind(this),s.onMessageReceived=e(this,va,"m",Oa).bind(this)),t(this,Ea,s,"f"),gr.log("assigned new connectionManager",e(this,Ea,"f"))):gr.log("same connectionManager is already assigned")}async connect(){return this.connectionManager||(this.connectionManager=e(wa,wa,"m",ya).call(wa)),e(this,va,"m",Aa).call(this),this.connectionManager.connect()}get isConnected(){return e(this,Da,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return e(this,va,"m",Aa).call(this),this.connectionManager?.reconnect()}static get ReconnectOnDisconnection(){return e(this,wa,"f",_a)}static set ReconnectOnDisconnection(e){gr.assertTypeWithError(e,"boolean"),t(this,wa,e,"f",_a)}get reconnectOnDisconnection(){return e(this,Fa,"f")}set reconnectOnDisconnection(e){gr.assertTypeWithError(e,"boolean"),t(this,Fa,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return e(this,va,"m",ka).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){this.isConnected?this.disconnect():this.canReconnect?this.reconnect():this.connect()}get connectionStatus(){switch(e(this,Ea,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"not connected":case"connecting":case"disconnecting":return e(this,Ea,"f").status;default:return"not connected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return e(this,$a,"f").information}get batteryLevel(){return e(this,Na,"f")}get id(){return e(this,Pa,"f").id}get isCharging(){return e(this,Pa,"f").isCharging}get batteryCurrent(){return e(this,Pa,"f").batteryCurrent}get getBatteryCurrent(){return e(this,Pa,"f").getBatteryCurrent}get name(){return e(this,Pa,"f").name}get setName(){return e(this,Pa,"f").setName}get type(){return e(this,Pa,"f").type}get setType(){return e(this,Pa,"f").setType}get isInsole(){return e(this,Pa,"f").isInsole}get insoleSide(){return e(this,Pa,"f").insoleSide}get mtu(){return e(this,Pa,"f").mtu}get sensorTypes(){return Object.keys(this.sensorConfiguration)}get continuousSensorTypes(){return ft.filter((e=>this.sensorTypes.includes(e)))}get sensorConfiguration(){return e(this,Va,"f").configuration}async setSensorConfiguration(t,s){await e(this,Va,"f").setConfiguration(t,s)}async clearSensorConfiguration(){return e(this,Va,"f").clearSensorConfiguration()}static get ClearSensorConfigurationOnLeave(){return e(this,wa,"f",za)}static set ClearSensorConfigurationOnLeave(e){gr.assertTypeWithError(e,"boolean"),t(this,wa,e,"f",za)}get clearSensorConfigurationOnLeave(){return e(this,ja,"f")}set clearSensorConfigurationOnLeave(e){gr.assertTypeWithError(e,"boolean"),t(this,ja,e,"f")}static get DefaultNumberOfPressureSensors(){return e(this,wa,"f",qa)}get numberOfPressureSensors(){return e(this,Ga,"f").pressureSensorDataManager.numberOfSensors}resetPressureRange(){e(this,Ga,"f").pressureSensorDataManager.resetRange()}async triggerVibration(t,s){e(this,Ha,"f").triggerVibration(t,s)}get maxFileLength(){return e(this,Ja,"f").maxLength}async sendFile(t,s){const i=this.waitForEvent("fileTransferComplete");e(this,Ja,"f").send(t,s),await i}async receiveFile(t){const s=this.waitForEvent("fileTransferComplete");e(this,Ja,"f").receive(t),await s}get fileTransferStatus(){return e(this,Ja,"f").status}cancelFileTransfer(){e(this,Ja,"f").cancel()}get tfliteName(){return e(this,Qa,"f").name}get setTfliteName(){return e(this,Qa,"f").setName}static get TfliteTasks(){return us}get tfliteTask(){return e(this,Qa,"f").task}get setTfliteTask(){return e(this,Qa,"f").setTask}get tfliteSampleRate(){return e(this,Qa,"f").sampleRate}get setTfliteSampleRate(){return e(this,Qa,"f").setSampleRate}get tfliteSensorTypes(){return e(this,Qa,"f").sensorTypes}get allowedTfliteSensorTypes(){return this.sensorTypes.filter((e=>gs.includes(e)))}get setTfliteSensorTypes(){return e(this,Qa,"f").setSensorTypes}get tfliteIsReady(){return e(this,Qa,"f").isReady}get tfliteInferencingEnabled(){return e(this,Qa,"f").inferencingEnabled}get setTfliteInferencingEnabled(){return e(this,Qa,"f").setInferencingEnabled}async enableTfliteInferencing(){return this.setTfliteInferencingEnabled(!0)}async disableTfliteInferencing(){return this.setTfliteInferencingEnabled(!1)}get toggleTfliteInferencing(){return e(this,Qa,"f").toggleInferencingEnabled}get tfliteCaptureDelay(){return e(this,Qa,"f").captureDelay}get setTfliteCaptureDelay(){return e(this,Qa,"f").setCaptureDelay}get tfliteThreshold(){return e(this,Qa,"f").threshold}get setTfliteThreshold(){return e(this,Qa,"f").setThreshold}get uploadFirmware(){return e(this,Ka,"f").uploadFirmware}async reset(){return await e(this,Ka,"f").reset(),e(this,Ea,"f").disconnect()}get firmwareStatus(){return e(this,Ka,"f").status}get getFirmwareImages(){return e(this,Ka,"f").getImages}get firmwareImages(){return e(this,Ka,"f").images}get eraseFirmwareImage(){return e(this,Ka,"f").eraseImage}get confirmFirmwareImage(){return e(this,Ka,"f").confirmImage}get testFirmwareImage(){return e(this,Ka,"f").testImage}static get ConnectedDevices(){return e(this,wa,"f",Xa)}static get UseLocalStorage(){return e(this,wa,"f",Ya)}static set UseLocalStorage(s){e(this,wa,"m",sr).call(this),gr.assertTypeWithError(s,"boolean"),t(this,wa,s,"f",Ya),e(this,wa,"f",Ya)&&!e(this,wa,"f",tr)&&e(this,wa,"m",ar).call(this)}static get CanUseLocalStorage(){return i&&window.localStorage}static get AvailableDevices(){return e(this,wa,"f",or)}static get CanGetDevices(){return i&&navigator.bluetooth?.getDevices&&!o}static async GetDevices(){if(!i)return void gr.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void gr.warn("bluetooth is not available in this browser");if(o)return void gr.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void gr.warn("bluetooth.getDevices() is not available in this browser");e(this,wa,"f",tr)||e(this,wa,"m",ar).call(this);const t=e(this,wa,"f",tr);if(!t.devices||0==t.devices.length)return void gr.log("no devices found in configuration");const s=await navigator.bluetooth.getDevices();return gr.log({bluetoothDevices:s}),s.forEach((s=>{if(!s.gatt)return;let i=t.devices.find((e=>s.id==e.bluetoothId));if(!i)return;let n=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));const a=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));if(a)return void(n&&n?.bluetoothId==a.bluetoothId&&n!=a&&(this.AvailableDevices[e(this,wa,"f",or).indexOf(a)]=n));if(n)return void this.AvailableDevices.push(n);const r=new wa,o=new Dn;o.device=s,s.name&&e(r,Pa,"f").updateName(s.name),e(r,Pa,"f").updateType(i.type),r.connectionManager=o,this.AvailableDevices.push(r)})),e(this,wa,"m",fr).call(this),this.AvailableDevices}static get AddEventListener(){return e(this,wa,"f",cr).addEventListener}static get RemoveEventListener(){return e(this,wa,"f",cr).removeEventListener}static async Connect(){const e=new wa;return await e.connect(),e}}var pr,vr,wr,yr,br;wa=mr,ba=new WeakMap,Ea=new WeakMap,Da=new WeakMap,Fa=new WeakMap,Ua=new WeakMap,$a=new WeakMap,Na=new WeakMap,Pa=new WeakMap,Va=new WeakMap,ja=new WeakMap,Ga=new WeakMap,Ha=new WeakMap,Ja=new WeakMap,Qa=new WeakMap,Ka=new WeakMap,va=new WeakSet,ya=function(){return new Dn},Sa=function(){return e(this,ba,"f").dispatchEvent},Ca=async function(t,s){await(e(this,Ea,"f")?.sendTxMessages(t,s))},ka=function(){gr.assertWithError(this.isConnected,"not connected")},Ta=function(){return e(wa,wa,"f",Ma)},Wa=function(){return e(this,va,"a",Ta).every((e=>this.latestConnectionMessage.has(e)))},Ia=function(){const t=e(this,va,"a",Ta).map((e=>({type:e})));e(this,va,"m",Ca).call(this,t)},La=function(s){if(gr.log({connectionStatus:s}),"not connected"==s?this.canReconnect&&this.reconnectOnDisconnection&&(gr.log("starting reconnect interval..."),t(this,Ua,setInterval((()=>{gr.log("attempting reconnect..."),this.reconnect()}),1e3),"f")):null!=e(this,Ua,"f")&&(gr.log("clearing reconnect interval"),clearInterval(e(this,Ua,"f")),t(this,Ua,void 0,"f")),e(this,va,"m",Ra).call(this),"connected"!=s||e(this,Da,"f")||e(this,va,"m",Ia).call(this),"not connected"==s&&!this.canReconnect&&e(wa,wa,"f",or).includes(this)){const t=e(wa,wa,"f",or).indexOf(this);wa.AvailableDevices.splice(t,1),e(wa,wa,"m",fr).call(wa)}},xa=function(t=!1){e(this,va,"a",Sa).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),e(this,va,"a",Sa).call(this,this.connectionStatus,{}),t&&e(this,va,"a",Sa).call(this,"isConnected",{isConnected:this.isConnected})},Ra=function(){switch(t(this,Da,Boolean(this.connectionManager?.isConnected)&&e(this,va,"a",Wa)&&e(this,Pa,"f").isCurrentTimeSet,"f"),this.connectionStatus){case"connected":e(this,Da,"f")&&e(this,va,"m",xa).call(this,!0);break;case"not connected":e(this,va,"m",xa).call(this,!0);break;default:e(this,va,"m",xa).call(this,!1)}},Aa=function(){this.latestConnectionMessage.clear(),e(this,Pa,"f").clear(),e(this,$a,"f").clear()},Oa=function(t,s){if(gr.log({messageType:t,dataView:s}),"batteryLevel"===t){const t=s.getUint8(0);gr.log("received battery level",{batteryLevel:t}),e(this,va,"m",Ba).call(this,t)}else if(Ie.includes(t))e(this,Ja,"f").parseMessage(t,s);else if(ls.includes(t))e(this,Qa,"f").parseMessage(t,s);else if(ut.includes(t))e(this,Ga,"f").parseMessage(t,s);else if(ga.includes(t))e(this,Ka,"f").parseMessage(t,s);else if(Ss.includes(t))e(this,$a,"f").parseMessage(t,s);else if(Qs.includes(t))e(this,Pa,"f").parseMessage(t,s);else{if(!Ft.includes(t))throw Error(`uncaught messageType ${t}`);e(this,Va,"f").parseMessage(t,s)}this.latestConnectionMessage.set(t,s),e(this,va,"a",Sa).call(this,"connectionMessage",{messageType:t,dataView:s}),!this.isConnected&&e(this,va,"a",Wa)&&e(this,va,"m",Ra).call(this)},Ba=function(s){gr.assertTypeWithError(s,"number"),e(this,Na,"f")!=s?(t(this,Na,s,"f"),gr.log({updatedBatteryLevel:e(this,Na,"f")}),e(this,va,"a",Sa).call(this,"batteryLevel",{batteryLevel:e(this,Na,"f")})):gr.log(`duplicate batteryLevel assignment ${s}`)},Za=function(t){return e(this,Ea,"f").sendSmpMessage(t)},sr=function(){gr.assertWithError(i,"localStorage is only available in the browser"),gr.assertWithError(window.localStorage,"localStorage not found")},nr=function(){e(this,wa,"m",sr).call(this),localStorage.setItem(e(this,wa,"f",ir),JSON.stringify(e(this,wa,"f",tr)))},ar=async function(){e(this,wa,"m",sr).call(this);let s=localStorage.getItem(e(this,wa,"f",ir));if("string"!=typeof s)return gr.log("no info found in localStorage"),t(this,wa,Object.assign({},e(this,wa,"f",er)),"f",tr),void e(this,wa,"m",nr).call(this);try{const e=JSON.parse(s);gr.log({configuration:e}),t(this,wa,e,"f",tr),this.CanGetDevices&&await this.GetDevices()}catch(e){gr.error(e)}},rr=function(t){if("webBluetooth"!=t.connectionType)return void gr.log("localStorage is only for webBluetooth devices");e(this,wa,"m",sr).call(this);const s=e(this,wa,"f",tr).devices.findIndex((e=>e.bluetoothId==t.bluetoothId));-1!=s&&(e(this,wa,"f",tr).devices[s].type=t.type,e(this,wa,"m",nr).call(this))},hr=function(){return e(this,wa,"f",cr).dispatchEvent},lr=function(t){if(t.isConnected)if(e(this,wa,"f",Xa).includes(t))gr.log("device already included");else{if(gr.log("adding device",t),e(this,wa,"f",Xa).push(t),this.UseLocalStorage&&"webBluetooth"==t.connectionType){const s={type:t.type,bluetoothId:t.bluetoothId},i=e(this,wa,"f",tr).devices.findIndex((e=>e.bluetoothId==s.bluetoothId));-1==i?e(this,wa,"f",tr).devices.push(s):e(this,wa,"f",tr).devices[i]=s,e(this,wa,"m",nr).call(this)}e(this,wa,"a",hr).call(this,"deviceConnected",{device:t}),e(this,wa,"a",hr).call(this,"deviceIsConnected",{device:t}),e(this,wa,"m",ur).call(this)}else e(this,wa,"f",Xa).includes(t)?(gr.log("removing device",t),e(this,wa,"f",Xa).splice(e(this,wa,"f",Xa).indexOf(t),1),e(this,wa,"a",hr).call(this,"deviceDisconnected",{device:t}),e(this,wa,"a",hr).call(this,"deviceIsConnected",{device:t}),e(this,wa,"m",ur).call(this)):gr.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),t.isConnected&&!this.AvailableDevices.includes(t)){const s=this.AvailableDevices.find((e=>e.bluetoothId==t.bluetoothId));gr.log({existingAvailableDevice:s}),s?this.AvailableDevices[this.AvailableDevices.indexOf(s)]=t:this.AvailableDevices.push(t),e(this,wa,"m",fr).call(this)}},fr=function(){gr.log({AvailableDevices:this.AvailableDevices}),e(this,wa,"a",hr).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},ur=function(){gr.log({ConnectedDevices:this.ConnectedDevices}),e(this,wa,"a",hr).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},Ma={value:["isCharging","getBatteryCurrent","getId","getMtu","getName","getType","getCurrentTime","getSensorConfiguration","getSensorScalars","getPressurePositions","maxFileLength","getFileLength","getFileChecksum","getFileType","fileTransferStatus","getTfliteName","getTfliteTask","getTfliteSampleRate","getTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","getTfliteThreshold","getTfliteInferencingEnabled"]},_a={value:!1},za={value:!0},qa={value:8},Xa={value:[]},Ya={value:!1},er={value:{devices:[]}},tr={value:void 0},ir={value:"BS.Device"},or={value:[]},cr={value:new I(wa,["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"])},wa.CanUseLocalStorage&&(wa.UseLocalStorage=!0);const Sr=M("DevicePairPressureSensorDataManager",{log:!0});class Er{constructor(){pr.add(this),vr.set(this,{}),wr.set(this,new qe)}resetPressureRange(){e(this,wr,"f").reset()}onDevicePressureData(t){const{pressure:s}=t.message,i=t.target.insoleSide;if(Sr.log({pressure:s,insoleSide:i}),e(this,vr,"f")[i]=s,e(this,pr,"a",yr))return e(this,pr,"m",br).call(this);Sr.log("doesn't have all pressure data yet...")}}var Cr;vr=new WeakMap,wr=new WeakMap,pr=new WeakSet,yr=function(){return Gs.every((t=>t in e(this,vr,"f")))},br=function(){const t={rawSum:0,normalizedSum:0};return Gs.forEach((s=>{t.rawSum+=e(this,vr,"f")[s].scaledSum,t.normalizedSum+=e(this,vr,"f")[s].normalizedSum})),t.normalizedSum>0&&(t.center={x:0,y:0},Gs.forEach((s=>{const i=e(this,vr,"f")[s],n=i.normalizedSum/t.normalizedSum;n>0&&(t.center.y+=i.normalizedCenter.y*n,"right"==s&&(t.center.x=n))})),t.normalizedCenter=e(this,wr,"f").updateAndGetNormalization(t.center)),Sr.log({devicePairPressure:t}),t};const Dr=M("DevicePairSensorDataManager",{log:!0}),kr=["pressure","sensorData"];class Mr{constructor(){Cr.set(this,{}),this.pressureSensorDataManager=new Er}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}resetPressureRange(){this.pressureSensorDataManager.resetPressureRange()}onDeviceSensorData(t){const{timestamp:s,sensorType:i}=t.message;let n;if(Dr.log({sensorType:i,timestamp:s,event:t}),e(this,Cr,"f")[i]||(e(this,Cr,"f")[i]={}),e(this,Cr,"f")[i][t.target.insoleSide]=s,"pressure"===i)n=this.pressureSensorDataManager.onDevicePressureData(t);else Dr.log(`uncaught sensorType "${i}"`);if(n){const t=Object.assign({},e(this,Cr,"f")[i]);this.dispatchEvent(i,{sensorType:i,timestamps:t,[i]:n}),this.dispatchEvent("sensorData",{sensorType:i,timestamps:t,[i]:n})}else Dr.log("no value received")}}var Tr,Wr,Ir,_r,Fr,Ur,Lr,xr,Rr,Ar,Or,$r,Nr,Br;Cr=new WeakMap;const Pr=M("DevicePair",{log:!0});function Vr(e){return`device${t=e,t[0].toUpperCase()+t.slice(1)}`;var t}const zr=["isConnected",...kr,...dr.map((e=>Vr(e)))];class jr{constructor(){Tr.add(this),Ir.set(this,new I(this,zr)),Fr.set(this,void 0),Ur.set(this,void 0),xr.set(this,{connectionStatus:e(this,Tr,"m",Rr).bind(this),isConnected:e(this,Tr,"m",Ar).bind(this),sensorData:e(this,Tr,"m",Nr).bind(this),getSensorConfiguration:e(this,Tr,"m",Rr).bind(this),getType:e(this,Tr,"m",Or).bind(this)}),$r.set(this,new Mr),e(this,$r,"f").eventDispatcher=e(this,Ir,"f")}get addEventListener(){return e(this,Ir,"f").addEventListener}get removeEventListener(){return e(this,Ir,"f").removeEventListener}get waitForEvent(){return e(this,Ir,"f").waitForEvent}get left(){return e(this,Fr,"f")}get right(){return e(this,Ur,"f")}get isConnected(){return Gs.every((e=>this[e]?.isConnected))}get isPartiallyConnected(){return Gs.some((e=>this[e]?.isConnected))}get isHalfConnected(){return this.isPartiallyConnected&&!this.isConnected}assignInsole(s){if(!s.isInsole)return void Pr.warn("device is not an insole");const i=s.insoleSide,n=this[i];if(s!=n){switch(n&&Ji(n,e(this,xr,"f")),Hi(s,e(this,xr,"f")),i){case"left":t(this,Fr,s,"f");break;case"right":t(this,Ur,s,"f")}return Pr.log(`assigned ${i} insole`,s),this.resetPressureRange(),e(this,Tr,"a",_r).call(this,"isConnected",{isConnected:this.isConnected}),e(this,Tr,"a",_r).call(this,"deviceIsConnected",{device:s,isConnected:s.isConnected,side:i}),n}Pr.log("device already assigned")}setSensorConfiguration(e){Gs.forEach((t=>{this[t]?.setSensorConfiguration(e)}))}resetPressureRange(){e(this,$r,"f").resetPressureRange()}async triggerVibration(e,t){const s=Gs.map((s=>this[s]?.triggerVibration(e,t))).filter(Boolean);return Promise.allSettled(s)}static get shared(){return e(this,Wr,"f",Br)}}Wr=jr,Ir=new WeakMap,Fr=new WeakMap,Ur=new WeakMap,xr=new WeakMap,$r=new WeakMap,Tr=new WeakSet,_r=function(){return e(this,Ir,"f").dispatchEvent},Lr=function(t){const s=Gs.some((s=>this[s]==t&&(Pr.log(`removing ${s} insole`,t),Ji(t,e(this,xr,"f")),delete this[s],!0)));return s&&e(this,Tr,"a",_r).call(this,"isConnected",{isConnected:this.isConnected}),s},Rr=function(t){const{type:s,target:i,message:n}=t;e(this,Tr,"a",_r).call(this,Vr(s),{...n,device:i,side:i.insoleSide})},Ar=function(t){e(this,Tr,"m",Rr).call(this,t),e(this,Tr,"a",_r).call(this,"isConnected",{isConnected:this.isConnected})},Or=function(t){const{target:s}=t;if(this[s.insoleSide]==s)return;e(this,Tr,"m",Lr).call(this,s)&&this.assignInsole(s)},Nr=function(t){e(this,Tr,"m",Rr).call(this,t),this.isConnected&&e(this,$r,"f").onDeviceSensorData(t)},Br={value:new Wr},mr.AddEventListener("deviceConnected",(t=>{const s=t.message.device;s.isInsole&&e(Wr,Wr,"f",Br).assignInsole(s)}));const qr=M("ServerUtils",{log:!1}),Gr=["ping","pong","isScanningAvailable","isScanning","startScan","stopScan","discoveredDevice","discoveredDevices","expiredDiscoveredDevice","connectToDevice","disconnectFromDevice","connectedDevices","deviceMessage"];function Hr(e,...t){qr.log("createMessage",...t);const s=t.map((t=>{"string"==typeof t&&(t={type:t}),null!=t.data?Array.isArray(t.data)||(t.data=[t.data]):t.data=[];const s=z(...t.data),i=s.byteLength;qr.assertEnumWithError(t.type,e);return z(e.indexOf(t.type),Uint16Array.from([i]),s)}));return qr.log("messageBuffers",...s),z(...s)}function Jr(...e){return qr.log("createServerMessage",...e),Hr(Gr,...e)}function Qr(...e){return qr.log("createClientDeviceMessage",...e),Hr(ji,...e)}Jr("ping"),Jr("pong"),Jr("isScanningAvailable"),Jr("isScanning"),Jr("startScan"),Jr("stopScan");const Kr=Jr("discoveredDevices");var Zr,Xr,Yr,eo,to,so,io,no;const ao=M("WebSocketClientConnectionManager",{log:!0});class ro extends qi{constructor(){super(...arguments),Zr.add(this),Yr.set(this,void 0),eo.set(this,!1)}static get isSupported(){return i}static get type(){return"webSocketClient"}get bluetoothId(){return e(this,Yr,"f")}set bluetoothId(s){ao.assertTypeWithError(s,"string"),e(this,Yr,"f")!=s?t(this,Yr,s,"f"):ao.log("redundant bluetoothId assignment")}get isConnected(){return e(this,eo,"f")}set isConnected(s){ao.assertTypeWithError(s,"boolean"),e(this,eo,"f")!=s?(t(this,eo,s,"f"),this.status=e(this,eo,"f")?"connected":"not connected",this.isConnected&&e(this,Zr,"m",io).call(this)):ao.log("redundant newIsConnected assignment",s)}async connect(){await super.connect(),this.sendWebSocketConnectMessage()}async disconnect(){await super.disconnect(),this.sendWebSocketDisconnectMessage()}get canReconnect(){return!0}async reconnect(){await super.reconnect(),ao.log("attempting to reconnect..."),this.connect()}async sendSmpMessage(e){super.sendSmpMessage(e),this.sendWebSocketMessage({type:"smp",data:e})}async sendTxData(e){super.sendTxData(e),this.sendWebSocketMessage({type:"tx",data:e})}onWebSocketMessage(t){ao.log({dataView:t}),ct(t,dr,e(this,Zr,"m",no).bind(this),null,!0)}}var oo,co,ho,lo,fo,uo,go,mo,po,vo,wo,yo,bo,So,Eo,Co,Do,ko,Mo,To,Wo,Io,_o,Fo,Uo;Xr=ro,Yr=new WeakMap,eo=new WeakMap,Zr=new WeakSet,so=function(){return e(Xr,Xr,"f",to)},io=function(){this.sendWebSocketMessage(...e(this,Zr,"a",so))},no=function(e,t){let s=0;switch(e){case"isConnected":const i=Boolean(t.getUint8(s++));ao.log({isConnected:i}),this.isConnected=i;break;case"rx":this.parseRxMessage(t);break;default:this.onMessageReceived(e,t)}},to={value:[...Ss,"batteryLevel"]};const Lo=M("WebSocketClient",{log:!0}),xo=["not connected","connecting","connected","disconnecting","connectionStatus","isConnected","isScanningAvailable","isScanning","discoveredDevice","expiredDiscoveredDevice"];class Ro{constructor(){oo.add(this),lo.set(this,{}),fo.set(this,new I(this,xo)),go.set(this,e(e(this,oo,"a",ho),co,"f",uo)),mo.set(this,"not connected"),this.pingTimer=new x(e(this,oo,"m",vo).bind(this),3e7),yo.set(this,!1),Co.set(this,!1),Io.set(this,{})}get devices(){return e(this,lo,"f")}get addEventListener(){return e(this,fo,"f").addEventListener}get dispatchEvent(){return e(this,fo,"f").dispatchEvent}get removeEventListener(){return e(this,fo,"f").removeEventListener}get waitForEvent(){return e(this,fo,"f").waitForEvent}assertConnection(){Lo.assertWithError(this.isConnected,"not connected")}assertDisconnection(){Lo.assertWithError(this.isDisconnected,"not disconnected")}static get ReconnectOnDisconnection(){return e(this,co,"f",uo)}static set ReconnectOnDisconnection(e){Lo.assertTypeWithError(e,"boolean"),t(this,co,e,"f",uo)}get reconnectOnDisconnection(){return e(this,go,"f")}set reconnectOnDisconnection(e){Lo.assertTypeWithError(e,"boolean"),t(this,go,e,"f")}sendServerMessage(...e){this.sendMessage(Jr(...e))}get _connectionStatus(){return e(this,mo,"f")}set _connectionStatus(e){switch(Lo.assertTypeWithError(e,"string"),Lo.log({newConnectionStatus:e}),t(this,mo,e,"f"),this.dispatchEvent("connectionStatus",{connectionStatus:this.connectionStatus}),this.dispatchEvent(this.connectionStatus,{}),e){case"connected":case"not connected":this.dispatchEvent("isConnected",{isConnected:this.isConnected}),this.isConnected?this.sendServerMessage("isScanningAvailable","discoveredDevices","connectedDevices"):(t(this,oo,!1,"a",So),t(this,oo,!1,"a",ko))}}get connectionStatus(){return this._connectionStatus}parseMessage(t){Lo.log("parseMessage",{dataView:t}),ct(t,Gr,e(this,oo,"m",po).bind(this),null,!0)}get isScanningAvailable(){return e(this,oo,"a",bo)}requestIsScanningAvailable(){this.sendServerMessage("isScanningAvailable")}get isScanning(){return e(this,oo,"a",Do)}startScan(){e(this,oo,"m",Wo).call(this),this.sendServerMessage("startScan")}stopScan(){e(this,oo,"m",To).call(this),this.sendServerMessage("stopScan")}toggleScan(){e(this,oo,"m",Eo).call(this),this.isScanning?this.stopScan():this.startScan()}get discoveredDevices(){return e(this,Io,"f")}onDiscoveredDevice(t){Lo.log({discoveredDevice:t}),e(this,Io,"f")[t.bluetoothId]=t,this.dispatchEvent("discoveredDevice",{discoveredDevice:t})}requestDiscoveredDevices(){this.sendMessage(Kr)}connectToDevice(e){return this.requestConnectionToDevice(e)}requestConnectionToDevice(t){this.assertConnection(),Lo.assertTypeWithError(t,"string");const s=e(this,oo,"m",Fo).call(this,t);return s.connect(),s}sendConnectToDeviceMessage(e){this.sendMessage(this.createConnectToDeviceMessage(e))}createConnectToDeviceMessage(e){return Jr({type:"connectToDevice",data:e})}onConnectedBluetoothDeviceIds(t){Lo.log({bluetoothIds:t}),t.forEach((t=>{e(this,oo,"m",Fo).call(this,t).connectionManager.isConnected=!0}))}disconnectFromDevice(e){this.requestDisconnectionFromDevice(e)}requestDisconnectionFromDevice(e){this.assertConnection(),Lo.assertTypeWithError(e,"string");const t=this.devices[e];return Lo.assertWithError(t,`no device found with id ${e}`),t.disconnect(),t}sendDisconnectFromDeviceMessage(t){this.sendMessage(e(this,oo,"m",Uo).call(this,t))}sendDeviceMessage(e,...t){this.sendMessage(this.createDeviceMessage(e,...t))}createDeviceMessage(e,...t){return Jr({type:"deviceMessage",data:[e,Qr(...t)]})}}var Ao,Oo,$o,No,Bo,Po,Vo;co=Ro,lo=new WeakMap,fo=new WeakMap,go=new WeakMap,mo=new WeakMap,yo=new WeakMap,Co=new WeakMap,Io=new WeakMap,oo=new WeakSet,ho=function(){return this.constructor},po=function(s,i){let n=0;switch(s){case"ping":e(this,oo,"m",wo).call(this);break;case"pong":break;case"isScanningAvailable":{const e=Boolean(i.getUint8(n++));Lo.log({isScanningAvailable:e}),t(this,oo,e,"a",So)}break;case"isScanning":{const e=Boolean(i.getUint8(n++));Lo.log({isScanning:e}),t(this,oo,e,"a",ko)}break;case"discoveredDevice":{const{string:e}=ot(i,n);Lo.log({discoveredDeviceString:e});const t=JSON.parse(e);Lo.log({discoveredDevice:t}),this.onDiscoveredDevice(t)}break;case"expiredDiscoveredDevice":{const{string:t}=ot(i,n);e(this,oo,"m",_o).call(this,t)}break;case"connectedDevices":{if(0==i.byteLength)break;const{string:e}=ot(i,n);Lo.log({connectedBluetoothDeviceIdStrings:e});const t=JSON.parse(e);Lo.log({connectedBluetoothDeviceIds:t}),this.onConnectedBluetoothDeviceIds(t)}break;case"deviceMessage":{const{string:t,byteOffset:s}=ot(i,n);n=s;const a=e(this,lo,"f")[t];Lo.assertWithError(a,`no device found for id ${t}`);const r=a.connectionManager,o=q(i,n);r.onWebSocketMessage(o)}break;default:Lo.error(`uncaught messageType "${s}"`)}},vo=function(){this.sendServerMessage("ping")},wo=function(){this.sendServerMessage("pong")},bo=function(){return e(this,yo,"f")},So=function(s){Lo.assertTypeWithError(s,"boolean"),t(this,yo,s,"f"),this.dispatchEvent("isScanningAvailable",{isScanningAvailable:this.isScanningAvailable}),this.isScanningAvailable&&e(this,oo,"m",Mo).call(this)},Eo=function(){this.assertConnection(),Lo.assertWithError(this.isScanningAvailable,"scanning is not available")},Do=function(){return e(this,Co,"f")},ko=function(e){Lo.assertTypeWithError(e,"boolean"),t(this,Co,e,"f"),this.dispatchEvent("isScanning",{isScanning:this.isScanning})},Mo=function(){this.sendServerMessage("isScanning")},To=function(){Lo.assertWithError(this.isScanning,"is not scanning")},Wo=function(){Lo.assertWithError(!this.isScanning,"is already scanning")},_o=function(t){Lo.log({expiredBluetoothDeviceId:t});const s=e(this,Io,"f")[t];s?(Lo.log({expiredDiscoveredDevice:s}),delete e(this,Io,"f")[t],this.dispatchEvent("expiredDiscoveredDevice",{discoveredDevice:s})):Lo.warn(`no discoveredDevice found with id "${t}"`)},Fo=function(t){let s=e(this,lo,"f")[t];return s||(s=this.createDevice(t),e(this,lo,"f")[t]=s),s},Uo=function(e){return Jr({type:"disconnectFromDevice",data:e})},uo={value:!0};const zo=M("WebSocketClient",{log:!0});class jo extends Ro{constructor(){super(...arguments),Ao.add(this),Oo.set(this,void 0),$o.set(this,{open:e(this,Ao,"m",No).bind(this),message:e(this,Ao,"m",Bo).bind(this),close:e(this,Ao,"m",Po).bind(this),error:e(this,Ao,"m",Vo).bind(this)})}get webSocket(){return e(this,Oo,"f")}set webSocket(s){e(this,Oo,"f")!=s?(zo.log("assigning webSocket",s),e(this,Oo,"f")&&Ji(e(this,Oo,"f"),e(this,$o,"f")),Hi(s,e(this,$o,"f")),t(this,Oo,s,"f"),zo.log("assigned webSocket")):zo.log("redundant webSocket assignment")}get readyState(){return this.webSocket?.readyState}get isConnected(){return this.readyState==WebSocket.OPEN}get isDisconnected(){return this.readyState==WebSocket.CLOSED}connect(e=`wss://${location.host}`){this.webSocket&&this.assertDisconnection(),this._connectionStatus="connecting",this.webSocket=new WebSocket(e)}disconnect(){this.assertConnection(),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.webSocket.addEventListener("close",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this._connectionStatus="disconnecting",this.webSocket.close()}reconnect(){this.assertDisconnection(),this.webSocket=new WebSocket(this.webSocket.url)}toggleConnection(e){this.isConnected?this.disconnect():e&&this.webSocket?.url==e?this.reconnect():this.connect(e)}sendMessage(t){this.assertConnection(),e(this,Oo,"f").send(t)}createDevice(e){const t=new mr,s=new ro;return s.bluetoothId=e,s.sendWebSocketMessage=this.sendDeviceMessage.bind(this,e),s.sendWebSocketConnectMessage=this.sendConnectToDeviceMessage.bind(this,e),s.sendWebSocketDisconnectMessage=this.sendDisconnectFromDeviceMessage.bind(this,e),t.connectionManager=s,t}}Oo=new WeakMap,$o=new WeakMap,Ao=new WeakSet,No=function(e){zo.log("webSocket.open",e),this.pingTimer.start(),this._connectionStatus="connected"},Bo=async function(e){zo.log("webSocket.message",e),this.pingTimer.restart();const t=await e.data.arrayBuffer(),s=new DataView(t);this.parseMessage(s)},Po=function(e){zo.log("webSocket.close",e),this._connectionStatus="not connected",Object.entries(this.devices).forEach((([e,t])=>{t.connectionManager.isConnected=!1})),this.pingTimer.stop(),this.reconnectOnDisconnection&&setTimeout((()=>{this.reconnect()}),3e3)},Vo=function(e){zo.error("webSocket.error",e.message)};export{ft as ContinuousSensorTypes,mr as Device,jr as DevicePair,qs as DeviceTypes,w as Environment,Le as FileTransferDirections,_e as FileTypes,Js as MaxNameLength,It as MaxSensorRate,Hs as MinNameLength,_t as SensorRateStep,lt as SensorTypes,gs as TfliteSensorTypes,Ci as VibrationLocations,Di as VibrationTypes,Xs as VibrationWaveformEffects,jo as WebSocketClient,W as setAllConsoleLevelFlags,T as setConsoleLevelFlagsForType};
//# sourceMappingURL=brilliantsole.module.min.js.map
