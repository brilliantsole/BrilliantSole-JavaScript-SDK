/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
function e(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)}function t(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s}"function"==typeof SuppressedError&&SuppressedError;const s=!1,i="undefined"!=typeof window&&void 0!==window?.document,n="undefined"!=typeof process&&null!=process?.versions?.node,r=i&&navigator.userAgent||"";let a=!1;i?a=Boolean(navigator.bluetooth):n&&(a=!0);const o=i&&/Bluefy/i.test(r),c=i&&/WebBLE/i.test(r),h=i&&/Android/i.test(r),l=i&&/Safari/i.test(r)&&!/Chrome/i.test(r),f=i&&/iPad|iPhone|iPod/i.test(r),g=i&&/Macintosh/i.test(r),u=!i&&!n&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var d,m,p,v,w=Object.freeze({__proto__:null,isAndroid:h,get isBluetoothSupported(){return a},isIOS:f,isInBluefy:o,isInBrowser:i,isInDev:s,isInLensStudio:u,isInNode:n,isInProduction:!0,isInWebBLE:c,isMac:g,isSafari:l});if(u){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(v={}).log=e,v.warn=e.bind(v,"WARNING"),v.error=e.bind(v,"ERROR")}else v=console;if(!v.assert){const e=(e,...t)=>{e||v.warn(...t)};v.assert=e}if(!v.table){const e=(...e)=>{v.log(...e)};v.table=e}function y(){}const b=v.log.bind(v),S=v.warn.bind(v),E=v.error.bind(v),C=v.table.bind(v),M=v.assert.bind(v);class k{constructor(t){if(p.set(this,{log:s,warn:s,assert:!0,error:!0,table:!0}),e(d,d,"f",m)[t])throw new Error(`"${t}" console already exists`);e(d,d,"f",m)[t]=this}setLevelFlags(t){Object.assign(e(this,p,"f"),t)}static setLevelFlagsForType(t,s){if(!e(this,d,"f",m)[t])throw new Error(`no console found with type "${t}"`);e(this,d,"f",m)[t].setLevelFlags(s)}static setAllLevelFlags(t){for(const s in e(this,d,"f",m))e(this,d,"f",m)[s].setLevelFlags(t)}static create(t,s){return e(this,d,"f",m)[t]||new d(t)}get log(){return e(this,p,"f").log?b:y}get warn(){return e(this,p,"f").warn?S:y}get error(){return e(this,p,"f").error?E:y}get assert(){return e(this,p,"f").assert?M:y}get table(){return e(this,p,"f").table?C:y}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}assertRangeWithError(e,t,s,i){this.assertWithError(t>=s&&t<=i,`${e} ${t} must be within ${s}-${i}`)}}function D(e,t){return k.create(e,t)}function W(e,t){k.setLevelFlagsForType(e,t)}function T(e){k.setAllLevelFlags(e)}d=k,p=new WeakMap,m={value:{}};const I=D("EventDispatcher",{log:!1});class _{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}updateEventListeners(e){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((t=>(t.shouldRemove&&I.log(`removing "${e}" eventListener`,t),!t.shouldRemove))))}addEventListener(e,t,s={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[],I.log(`creating "${e}" listeners array`,this.listeners[e]));this.listeners[e].find((e=>e.listener==t&&e.once==s.once))?I.log("already added listener"):(I.log(`adding "${e}" listener`,t,s),this.listeners[e].push({listener:t,once:s.once}),I.log(`currently have ${this.listeners[e].length} "${e}" listeners`))}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(I.log(`removing "${e}" listener...`,t),this.listeners[e].forEach((s=>{s.listener===t&&(I.log(`flagging "${e}" listener`,t),s.shouldRemove=!0)})),this.updateEventListeners(e))}removeEventListeners(e){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(I.log(`removing "${e}" listeners...`),this.listeners[e]=[])}removeAllEventListeners(){I.log("removing listeners..."),this.listeners={}}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e].forEach((s=>{s.shouldRemove||(I.log(`dispatching "${e}" listener`,s),s.listener({type:e,target:this.target,message:t}),s.once&&(I.log(`flagging "${e}" listener`,s),s.shouldRemove=!0))})),this.updateEventListeners(e))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var U,L,F;const A=D("Timer",{log:!1});class R{get callback(){return e(this,U,"f")}set callback(e){A.assertTypeWithError(e,"function"),A.log({newCallback:e}),t(this,U,e,"f"),this.isRunning&&this.restart()}get interval(){return e(this,L,"f")}set interval(e){A.assertTypeWithError(e,"number"),A.assertWithError(e>0,"interval must be above 0"),A.log({newInterval:e}),t(this,L,e,"f"),this.isRunning&&this.restart()}constructor(e,t){U.set(this,void 0),L.set(this,void 0),F.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=e(this,F,"f")}start(s=!1){this.isRunning?A.log("interval already running"):(A.log(`starting interval every ${e(this,L,"f")}ms`),t(this,F,setInterval(e(this,U,"f"),e(this,L,"f")),"f"),s&&e(this,U,"f").call(this))}stop(){this.isRunning?(A.log("stopping interval"),clearInterval(e(this,F,"f")),t(this,F,void 0,"f")):A.log("interval already not running")}restart(e=!1){this.stop(),this.start(e)}}function x(e){for(let t=0;t<8;++t)e=(1&e?0:3988292384)^e>>>1;return 4278190080^e}U=new WeakMap,L=new WeakMap,F=new WeakMap,D("checksum",{log:!1});const $=new Uint32Array(256);for(let e=0;e<256;++e)$[e]=x(e);function O(e){let t=new Uint8Array(e),s=0;for(let e=0;e<t.byteLength;++e){const i=255&s,n=t[e];s=($[i^n]^s>>>8)>>>0}return s}var B,N;B="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,N="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const P=new B,V=new N,z=D("ArrayBufferUtils",{log:!1});function j(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return G(e)}if(e instanceof Array){return j(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return G(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;return e.forEach((e=>{s.set(new Uint8Array(e),i),i+=e.byteLength})),s.buffer}function G(e){const t=P.encode(e);return j(t.byteLength,t)}function q(e,t,s){let i;return null!=s&&(i=e.byteOffset+t+s),z.log({dataView:e,begin:t,end:i,length:s}),new DataView(e.buffer.slice(e.byteOffset+t,i))}async function H(e){let t;if(e instanceof Array)t=Uint8Array.from(e);else if(e instanceof DataView)t=e.buffer;else if("string"==typeof e||e instanceof URL){const s=await fetch(e);t=await s.arrayBuffer()}else if(e instanceof File)t=await e.arrayBuffer();else{if(!(e instanceof ArrayBuffer))throw{error:"invalid file type",file:e};t=e}return t}function J(e,{include:t,exclude:s}={}){const i=e=>{const i=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(i):!s||!s.some(i)};for(const[t,s]of(e=>{const t=new Set;do{for(const s of Reflect.ownKeys(e))t.add([e,s])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===s||!i(s))continue;const n=Reflect.getOwnPropertyDescriptor(t,s);n&&"function"==typeof n.value&&(e[s]=e[s].bind(e))}return e}var K,Q,Z,X,Y,ee,te,se,ie,ne,re,ae,oe,ce,he,le,fe,ge,ue,de,me,pe,ve,we,ye,be,Se,Ee,Ce,Me,ke,De,We,Te,Ie,_e,Ue,Le,Fe;const Ae=D("FileTransferManager",{log:!1}),Re=["maxFileLength","getFileType","setFileType","getFileLength","setFileLength","getFileChecksum","setFileChecksum","setFileTransferCommand","fileTransferStatus","getFileBlock","setFileBlock","fileBytesTransferred"],xe=["tflite","wifiServerCert","wifiServerKey"],$e=["idle","sending","receiving"],Oe=["startSend","startReceive","cancel"],Be=["sending","receiving"],Ne=[...Re,"fileTransferProgress","fileTransferComplete","fileReceived"];class Pe{constructor(){K.add(this),ie.set(this,Q.MaxLength),oe.set(this,void 0),fe.set(this,0),me.set(this,0),be.set(this,"idle"),ke.set(this,[]),We.set(this,void 0),Te.set(this,0),Le.set(this,!1),Fe.set(this,!1),J(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}static get MaxLength(){return e(this,Q,"f",se)}get maxLength(){return e(this,ie,"f")}get type(){return e(this,oe,"f")}get length(){return e(this,fe,"f")}get checksum(){return e(this,me,"f")}get status(){return e(this,be,"f")}parseMessage(t,s){switch(Ae.log({messageType:t}),t){case"maxFileLength":e(this,K,"m",ne).call(this,s);break;case"getFileType":case"setFileType":e(this,K,"m",ce).call(this,s);break;case"getFileLength":case"setFileLength":e(this,K,"m",ge).call(this,s);break;case"getFileChecksum":case"setFileChecksum":e(this,K,"m",pe).call(this,s);break;case"fileTransferStatus":e(this,K,"m",Se).call(this,s);break;case"getFileBlock":e(this,K,"m",De).call(this,s);break;case"fileBytesTransferred":e(this,K,"m",Ue).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}async send(t,s){e(this,K,"m",Ce).call(this),e(this,K,"m",X).call(this,t);const i=await H(s),n=[];n.push(e(this,K,"m",le).call(this,t,!1));const r=i.byteLength;n.push(e(this,K,"m",de).call(this,r,!1));const a=O(i);n.push(e(this,K,"m",we).call(this,a,!1)),n.push(e(this,K,"m",ye).call(this,"startSend",!1)),this.sendMessage(),await Promise.all(n),await e(this,K,"m",Ie).call(this,i)}async receive(t){e(this,K,"m",Ce).call(this),e(this,K,"m",X).call(this,t),await e(this,K,"m",le).call(this,t),await e(this,K,"m",ye).call(this,"startReceive")}async cancel(){e(this,K,"m",Me).call(this),Ae.log("cancelling file transfer..."),t(this,Le,!0,"f"),await e(this,K,"m",ye).call(this,"cancel")}get isServerSide(){return e(this,Fe,"f")}set isServerSide(s){e(this,Fe,"f")!=s?(Ae.log({newIsServerSide:s}),t(this,Fe,s,"f")):Ae.log("redundant isServerSide assignment")}}Q=Pe,ie=new WeakMap,oe=new WeakMap,fe=new WeakMap,me=new WeakMap,be=new WeakMap,ke=new WeakMap,We=new WeakMap,Te=new WeakMap,Le=new WeakMap,Fe=new WeakMap,K=new WeakSet,Z=function(){return this.eventDispatcher.dispatchEvent},X=function(e){Ae.assertEnumWithError(e,xe)},Y=function(e){Ae.assertWithError(e in xe,`invalid typeEnum ${e}`)},ee=function(e){Ae.assertWithError(e in $e,`invalid statusEnum ${e}`)},te=function(e){Ae.assertEnumWithError(e,Oe)},ne=function(t){Ae.log("parseFileMaxLength",t);const s=t.getUint32(0,!0);Ae.log(`maxLength: ${s/1024}kB`),e(this,K,"m",re).call(this,s)},re=function(s){Ae.log({maxLength:s}),t(this,ie,s,"f"),e(this,K,"a",Z).call(this,"maxFileLength",{maxFileLength:s})},ae=function(e){Ae.assertWithError(e<=this.maxLength,`file length ${e}kB too large - must be ${this.maxLength}kB or less`)},ce=function(t){Ae.log("parseFileType",t);const s=t.getUint8(0);e(this,K,"m",Y).call(this,s);const i=xe[s];e(this,K,"m",he).call(this,i)},he=function(s){Ae.log({fileTransferType:s}),t(this,oe,s,"f"),e(this,K,"a",Z).call(this,"getFileType",{fileType:s})},le=async function(t,s){if(e(this,K,"m",X).call(this,t),this.type==t)return void Ae.log(`redundant type assignment ${t}`);const i=this.waitForEvent("getFileType"),n=xe.indexOf(t);this.sendMessage([{type:"setFileType",data:Uint8Array.from([n]).buffer}],s),await i},ge=function(t){Ae.log("parseFileLength",t);const s=t.getUint32(0,!0);e(this,K,"m",ue).call(this,s)},ue=function(s){Ae.log(`length: ${s/1024}kB`),t(this,fe,s,"f"),e(this,K,"a",Z).call(this,"getFileLength",{fileLength:s})},de=async function(t,s){if(Ae.assertTypeWithError(t,"number"),e(this,K,"m",ae).call(this,t),this.length==t)return void Ae.log(`redundant length assignment ${t}`);const i=this.waitForEvent("getFileLength"),n=new DataView(new ArrayBuffer(4));n.setUint32(0,t,!0),this.sendMessage([{type:"setFileLength",data:n.buffer}],s),await i},pe=function(t){Ae.log("checksum",t);const s=t.getUint32(0,!0);e(this,K,"m",ve).call(this,s)},ve=function(s){Ae.log({checksum:s}),t(this,me,s,"f"),e(this,K,"a",Z).call(this,"getFileChecksum",{fileChecksum:s})},we=async function(e,t){if(Ae.assertTypeWithError(e,"number"),this.checksum==e)return void Ae.log(`redundant checksum assignment ${e}`);const s=this.waitForEvent("getFileChecksum"),i=new DataView(new ArrayBuffer(4));i.setUint32(0,e,!0),this.sendMessage([{type:"setFileChecksum",data:i.buffer}],t),await s},ye=async function(t,s){e(this,K,"m",te).call(this,t);const i=this.waitForEvent("fileTransferStatus");Ae.log(`setting command ${t}`);const n=Oe.indexOf(t);this.sendMessage([{type:"setFileTransferCommand",data:Uint8Array.from([n]).buffer}],s),await i},Se=function(t){Ae.log("parseFileStatus",t);const s=t.getUint8(0);e(this,K,"m",ee).call(this,s);const i=$e[s];e(this,K,"m",Ee).call(this,i)},Ee=function(s){Ae.log({status:s}),t(this,be,s,"f"),e(this,K,"a",Z).call(this,"fileTransferStatus",{fileTransferStatus:s}),e(this,ke,"f").length=0,t(this,Le,!1,"f")},Ce=function(){Ae.assertWithError("idle"==e(this,be,"f"),"status is not idle")},Me=function(){Ae.assertWithError("idle"!=e(this,be,"f"),"status is idle")},De=async function(t){Ae.log("parseFileBlock",t),e(this,ke,"f").push(t.buffer);const s=e(this,ke,"f").reduce(((e,t)=>e+t.byteLength),0),i=s/e(this,fe,"f");if(Ae.log(`received ${s} of ${e(this,fe,"f")} bytes (${100*i}%)`),e(this,K,"a",Z).call(this,"fileTransferProgress",{progress:i}),s!=e(this,fe,"f")){const e=new DataView(new ArrayBuffer(4));if(e.setUint32(0,s,!0),this.isServerSide)return;return void await this.sendMessage([{type:"fileBytesTransferred",data:e.buffer}])}Ae.log("file transfer complete");let n,r=(new Date).toLocaleString();switch(this.type){case"tflite":r+=".tflite";break;case"wifiServerCert":r+="_server.crt";break;case"wifiServerKey":r+="_server.key"}n="undefined"!=typeof File?new File(e(this,ke,"f"),r):new Blob(e(this,ke,"f"));const a=O(await n.arrayBuffer());Ae.log({checksum:a}),a==e(this,me,"f")?(Ae.log("received file",n),e(this,K,"a",Z).call(this,"getFileBlock",{fileTransferBlock:t}),e(this,K,"a",Z).call(this,"fileTransferComplete",{direction:"receiving"}),e(this,K,"a",Z).call(this,"fileReceived",{file:n})):Ae.error(`wrong checksum - expected ${e(this,me,"f")}, got ${a}`)},Ie=async function(s){return t(this,We,s,"f"),t(this,Te,0,"f"),e(this,K,"m",_e).call(this)},_e=async function(){if("sending"!=this.status)return;if(e(this,Le,"f"))return void Ae.error("not sending block - busy cancelling");if(!e(this,We,"f"))return void(this.isServerSide||Ae.error("no buffer defined"));const s=e(this,We,"f");let i=e(this,Te,"f");const n=s.slice(i,i+(this.mtu-3-3));Ae.log("slicedBuffer",n);const r=1-(s.byteLength-i)/s.byteLength;Ae.log(`sending bytes ${i}-${i+n.byteLength} of ${s.byteLength} bytes (${100*r}%)`),e(this,K,"a",Z).call(this,"fileTransferProgress",{progress:r}),0==n.byteLength?(Ae.log("finished sending buffer"),e(this,K,"a",Z).call(this,"fileTransferComplete",{direction:"sending"})):(await this.sendMessage([{type:"setFileBlock",data:n}]),t(this,Te,i+n.byteLength,"f"))},Ue=async function(t){Ae.log("parseBytesTransferred",t);const s=t.getUint32(0,!0);if(Ae.log({bytesTransferred:s}),"sending"==this.status)return this.isServerSide||e(this,Te,"f")==s?void e(this,K,"m",_e).call(this):(Ae.error(`bytesTransferred are not equal - got ${s}, expected ${e(this,Te,"f")}`),void this.cancel());Ae.error("not currently sending file")},se={value:0};const Ve=D("MathUtils",{log:!1});const ze=65536;function je(e,t){const s=Date.now();var i;let n=(i=s)-i%ze+e.getUint16(t,!0);return Math.abs(s-n)>6e4&&(Ve.log("correcting timestamp delta"),n+=ze*Math.sign(s-n)),n}var Ge,qe,He;const Je={min:1/0,max:-1/0,span:0};class Ke{constructor(){Ge.add(this),qe.set(this,Object.assign({},Je))}get min(){return e(this,qe,"f").min}get max(){return e(this,qe,"f").max}set min(t){e(this,qe,"f").min=t,e(this,qe,"f").max=Math.max(t,e(this,qe,"f").max),e(this,Ge,"m",He).call(this)}set max(t){e(this,qe,"f").max=t,e(this,qe,"f").min=Math.min(t,e(this,qe,"f").min),e(this,Ge,"m",He).call(this)}reset(){Object.assign(e(this,qe,"f"),Je)}update(t){e(this,qe,"f").min=Math.min(t,e(this,qe,"f").min),e(this,qe,"f").max=Math.max(t,e(this,qe,"f").max),e(this,Ge,"m",He).call(this)}getNormalization(t,s){let i=function(e,t,s,i){return null==i&&(i=s-t),(e-t)/i}(t,e(this,qe,"f").min,e(this,qe,"f").max,e(this,qe,"f").span);return s&&(i*=e(this,qe,"f").span),i||0}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}var Qe,Ze,Xe,Ye,et;qe=new WeakMap,Ge=new WeakSet,He=function(){e(this,qe,"f").span=e(this,qe,"f").max-e(this,qe,"f").min};class tt{constructor(){Qe.set(this,{x:new Ke,y:new Ke})}reset(){e(this,Qe,"f").x.reset(),e(this,Qe,"f").y.reset()}update(t){e(this,Qe,"f").x.update(t.x),e(this,Qe,"f").y.update(t.y)}getNormalization(t,s){return{x:e(this,Qe,"f").x.getNormalization(t.x,s),y:e(this,Qe,"f").y.getNormalization(t.y,s)}}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}Qe=new WeakMap;const st=D("PressureDataManager",{log:!1}),it=["pressure"],nt=it,rt=8;class at{constructor(){Ze.set(this,[]),Xe.set(this,void 0),Ye.set(this,new Ke),et.set(this,new tt)}get positions(){return e(this,Ze,"f")}get numberOfSensors(){return this.positions.length}parsePositions(e){const s=[];for(let t=0,i=0;i<e.byteLength;t++,i+=2)s.push({x:e.getUint8(i)/256,y:e.getUint8(i+1)/256});var i,n;st.log({positions:s}),t(this,Ze,s,"f"),t(this,Xe,(i=this.numberOfSensors,n=()=>new Ke,new Array(i).fill(1).map(((e,t)=>{if("function"==typeof n)return n(t);{const e=n;return Object.assign({},e)}}))),"f"),this.resetRange()}resetRange(){e(this,Xe,"f")?.forEach((e=>e.reset())),e(this,et,"f").reset(),e(this,Ye,"f").reset()}parseData(t,s){const i={sensors:[],scaledSum:0,normalizedSum:0};for(let n=0,r=0;r<t.byteLength;n++,r+=2){const a=t.getUint16(r,!0);let o=a*s/this.numberOfSensors;const c=e(this,Xe,"f")[n].updateAndGetNormalization(o,!1),h=this.positions[n];i.sensors[n]={rawValue:a,scaledValue:o,normalizedValue:c,position:h,weightedValue:0},i.scaledSum+=o}return i.normalizedSum=e(this,Ye,"f").updateAndGetNormalization(i.scaledSum,!1),i.scaledSum>0&&(i.center={x:0,y:0},i.sensors.forEach((e=>{e.weightedValue=e.scaledValue/i.scaledSum,i.center.x+=e.position.x*e.weightedValue,i.center.y+=e.position.y*e.weightedValue})),i.normalizedCenter=e(this,et,"f").updateAndGetNormalization(i.center,!1)),st.log({pressure:i}),i}}Ze=new WeakMap,Xe=new WeakMap,Ye=new WeakMap,et=new WeakMap;const ot=D("MotionSensorDataManager",{log:!1}),ct=["still","walking","running","bicycle","vehicle","tilting"],ht=["portraitUpright","landscapeLeft","portraitUpsideDown","landscapeRight","unknown"];class lt{parseVector3(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));const r={x:s,y:i,z:n};return ot.log({vector:r}),r}parseQuaternion(e,t){let[s,i,n,r]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0),e.getInt16(6,!0)].map((e=>e*t));const a={x:s,y:i,z:n,w:r};return ot.log({quaternion:a}),a}parseEuler(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));i*=-1,s*=-1,s+=360;const r={heading:s,pitch:i,roll:n};return ot.log({euler:r}),r}parseStepCounter(e){ot.log("parseStepCounter",e);const t=e.getUint32(0,!0);return ot.log({stepCount:t}),t}parseActivity(e){ot.log("parseActivity",e);const t={},s=e.getUint8(0);return ot.log("activityBitfield",s.toString(2)),ct.forEach(((e,i)=>{t[e]=Boolean(s&1<<i)})),ot.log("activity",t),t}parseDeviceOrientation(e){ot.log("parseDeviceOrientation",e);const t=e.getUint8(0),s=ht[t];return ot.assertWithError(s,"undefined deviceOrientation"),ot.log({deviceOrientation:s}),s}}var ft,gt;const ut=["barometer"],dt=ut,mt=D("BarometerSensorDataManager",{log:!1});class pt{constructor(){ft.add(this)}parseData(t,s){const i=t.getUint32(0,!0)*s,n=e(this,ft,"m",gt).call(this,i);return mt.log({pressure:i,altitude:n}),{pressure:i}}}ft=new WeakSet,gt=function(e){const t=.0065;return 288.15/t*(1-Math.pow(e/101325,.19026643566373183))};const vt=D("ParseUtils",{log:!1});function wt(e,t=0){const s=e.getUint8(t++);return{string:V.decode(e.buffer.slice(e.byteOffset+t,e.byteOffset+t+s)),byteOffset:t+=s}}function yt(e,t,s,i,n=!1){let r=0;for(;r<e.byteLength;){const a=e.getUint8(r++);vt.assertWithError(a in t,`invalid messageTypeEnum ${a}`);const o=t[a];let c;n?(c=e.getUint16(r,!0),r+=2):c=e.getUint8(r++),vt.log({messageTypeEnum:a,messageType:o,messageLength:c,dataView:e,byteOffset:r});const h=q(e,r,c);vt.log({_dataView:h}),s(o,h,i),r+=c}}var bt;const St=D("SensorDataManager",{log:!1}),Et=[...it,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation","activity","stepCounter","stepDetector","deviceOrientation",...ut],Ct=[...nt,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation",...dt],Mt=["getPressurePositions","getSensorScalars","sensorData"],kt=[...Mt,...Et];class Dt{constructor(){this.pressureSensorDataManager=new at,this.motionSensorDataManager=new lt,this.barometerSensorDataManager=new pt,bt.set(this,new Map)}static AssertValidSensorType(e){St.assertEnumWithError(e,Et)}static AssertValidSensorTypeEnum(e){St.assertTypeWithError(e,"number"),St.assertWithError(e in Et,`invalid sensorTypeEnum ${e}`)}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}parseMessage(e,t){switch(St.log({messageType:e}),e){case"getSensorScalars":this.parseScalars(t);break;case"getPressurePositions":this.pressureSensorDataManager.parsePositions(t);break;case"sensorData":this.parseData(t);break;default:throw Error(`uncaught messageType ${e}`)}}parseScalars(t){for(let s=0;s<t.byteLength;s+=5){const i=t.getUint8(s),n=Et[i];if(!n){St.warn(`unknown sensorType index ${i}`);continue}const r=t.getFloat32(s+1,!0);St.log({sensorType:n,sensorScalar:r}),e(this,bt,"f").set(n,r)}}parseData(e){St.log("sensorData",Array.from(new Uint8Array(e.buffer)));let t=0;const s=je(e,t);t+=2;yt(new DataView(e.buffer,t),Et,this.parseDataCallback.bind(this),{timestamp:s})}parseDataCallback(t,s,{timestamp:i}){const n=e(this,bt,"f").get(t)||1;let r=null;switch(t){case"pressure":r=this.pressureSensorDataManager.parseData(s,n);break;case"acceleration":case"gravity":case"linearAcceleration":case"gyroscope":case"magnetometer":r=this.motionSensorDataManager.parseVector3(s,n);break;case"gameRotation":case"rotation":r=this.motionSensorDataManager.parseQuaternion(s,n);break;case"orientation":r=this.motionSensorDataManager.parseEuler(s,n);break;case"stepCounter":r=this.motionSensorDataManager.parseStepCounter(s);break;case"stepDetector":r={};break;case"activity":r=this.motionSensorDataManager.parseActivity(s);break;case"deviceOrientation":r=this.motionSensorDataManager.parseDeviceOrientation(s);break;case"barometer":r=this.barometerSensorDataManager.parseData(s,n);break;default:St.error(`uncaught sensorType "${t}"`)}St.assertWithError(null!=r,`no sensorData defined for sensorType "${t}"`),St.log({sensorType:t,sensorData:r}),this.dispatchEvent(t,{sensorType:t,[t]:r,timestamp:i}),this.dispatchEvent("sensorData",{sensorType:t,[t]:r,timestamp:i})}}var Wt,Tt,It,_t,Ut,Lt,Ft,At,Rt,xt,$t,Ot,Bt;bt=new WeakMap;const Nt=D("SensorConfigurationManager",{log:!1}),Pt=65535,Vt=5,zt=["getSensorConfiguration","setSensorConfiguration"],jt=zt;class Gt{constructor(){Wt.add(this),_t.set(this,void 0),Lt.set(this,void 0),J(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get configuration(){return e(this,Lt,"f")}async setConfiguration(t,s){if(s&&(t=Object.assign({...this.zeroSensorConfiguration},t)),Nt.log({newSensorConfiguration:t}),e(this,Wt,"m",At).call(this,t))return void Nt.log("redundant sensor configuration");const i=e(this,Wt,"m",Ot).call(this,t);Nt.log({setSensorConfigurationData:i});const n=this.waitForEvent("getSensorConfiguration");this.sendMessage([{type:"setSensorConfiguration",data:i.buffer}]),await n}static get ZeroSensorConfiguration(){return e(this,Tt,"f",Bt)}get zeroSensorConfiguration(){const t={};return e(this,_t,"f").forEach((e=>{t[e]=0})),t}async clearSensorConfiguration(){return this.setConfiguration(this.zeroSensorConfiguration)}parseMessage(t,s){switch(Nt.log({messageType:t}),t){case"getSensorConfiguration":case"setSensorConfiguration":const i=e(this,Wt,"m",Rt).call(this,s);e(this,Wt,"m",Ft).call(this,i);break;default:throw Error(`uncaught messageType ${t}`)}}}var qt,Ht,Jt,Kt,Qt,Zt,Xt,Yt,es,ts,ss,is,ns,rs,as,os,cs,hs,ls,fs,gs,us,ds,ms,ps,vs,ws,ys,bs,Ss;Tt=Gt,_t=new WeakMap,Lt=new WeakMap,Wt=new WeakSet,It=function(){return this.eventDispatcher.dispatchEvent},Ut=function(t){Nt.assertWithError(e(this,_t,"f"),"must get initial sensorConfiguration");const s=e(this,_t,"f")?.includes(t);return Nt.log(s,`unavailable sensor type "${t}"`),s},Ft=function(s){t(this,Lt,s,"f"),Nt.log({updatedConfiguration:e(this,Lt,"f")}),e(this,Wt,"a",It).call(this,"getSensorConfiguration",{sensorConfiguration:this.configuration})},At=function(e){return Object.keys(e).every((t=>this.configuration[t]==e[t]))},Rt=function(e){const s={};for(let t=0;t<e.byteLength;t+=3){const i=e.getUint8(t),n=Et[i];if(!n){Nt.warn(`unknown sensorType index ${i}`);continue}const r=e.getUint16(t+1,!0);Nt.log({sensorType:n,sensorRate:r}),s[n]=r}return Nt.log({parsedSensorConfiguration:s}),t(this,_t,Object.keys(s),"f"),s},xt=function(e){Nt.assertTypeWithError(e,"number"),Nt.assertWithError(e>=0,`sensorRate must be 0 or greater (got ${e})`),Nt.assertWithError(e<65535,`sensorRate must be 0 or greater (got ${e})`),Nt.assertWithError(e%5==0,"sensorRate must be multiple of 5")},$t=function(t){e(Tt,Tt,"m",xt).call(Tt,t)},Ot=function(t){let s=Object.keys(t);s=s.filter((t=>e(this,Wt,"m",Ut).call(this,t)));const i=new DataView(new ArrayBuffer(3*s.length));return s.forEach(((s,n)=>{Dt.AssertValidSensorType(s);const r=Et.indexOf(s);i.setUint8(3*n,r);const a=t[s];e(this,Wt,"m",$t).call(this,a),i.setUint16(3*n+1,a,!0)})),Nt.log({sensorConfigurationData:i}),i},Bt={value:{}},Et.forEach((t=>{e(Tt,Tt,"f",Bt)[t]=0}));const Es=D("TfliteManager",{log:!1}),Cs=["getTfliteName","setTfliteName","getTfliteTask","setTfliteTask","getTfliteSampleRate","setTfliteSampleRate","getTfliteSensorTypes","setTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","setTfliteCaptureDelay","getTfliteThreshold","setTfliteThreshold","getTfliteInferencingEnabled","setTfliteInferencingEnabled","tfliteInference"],Ms=Cs,ks=["classification","regression"],Ds=["pressure","linearAcceleration","gyroscope","magnetometer"];class Ws{constructor(){qt.add(this),Qt.set(this,void 0),Yt.set(this,void 0),ss.set(this,void 0),rs.set(this,[]),cs.set(this,void 0),gs.set(this,void 0),ms.set(this,void 0),ws.set(this,void 0),J(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get name(){return e(this,Qt,"f")}async setName(e,t){if(Es.assertTypeWithError(e,"string"),this.name==e)return void Es.log(`redundant name assignment ${e}`);const s=this.waitForEvent("getTfliteName"),i=P.encode(e);this.sendMessage([{type:"setTfliteName",data:i.buffer}],t),await s}get task(){return e(this,Yt,"f")}async setTask(t,s){if(e(this,qt,"m",Ht).call(this,t),this.task==t)return void Es.log(`redundant task assignment ${t}`);const i=this.waitForEvent("getTfliteTask"),n=ks.indexOf(t);this.sendMessage([{type:"setTfliteTask",data:Uint8Array.from([n]).buffer}],s),await i}get sampleRate(){return e(this,ss,"f")}async setSampleRate(t,s){if(Es.assertTypeWithError(t,"number"),t-=t%5,Es.assertWithError(t>=5,`sampleRate must be multiple of 5 greater than 0 (got ${t})`),e(this,ss,"f")==t)return void Es.log(`redundant sampleRate assignment ${t}`);const i=this.waitForEvent("getTfliteSampleRate"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,t,!0),this.sendMessage([{type:"setTfliteSampleRate",data:n.buffer}],s),await i}static AssertValidSensorType(e){Dt.AssertValidSensorType(e),Es.assertWithError(Ds.includes(e),`invalid tflite sensorType "${e}"`)}get sensorTypes(){return e(this,rs,"f").slice()}async setSensorTypes(e,t){e.forEach((e=>{Ws.AssertValidSensorType(e)}));const s=this.waitForEvent("getTfliteSensorTypes");var i;const n=(e=(i=e).filter(((e,t)=>i.indexOf(e)==t))).map((e=>Et.indexOf(e))).sort();Es.log(e,n),this.sendMessage([{type:"setTfliteSensorTypes",data:Uint8Array.from(n).buffer}],t),await s}get isReady(){return e(this,cs,"f")}get captureDelay(){return e(this,gs,"f")}async setCaptureDelay(t,s){if(Es.assertTypeWithError(t,"number"),e(this,gs,"f")==t)return void Es.log(`redundant captureDelay assignment ${t}`);const i=this.waitForEvent("getTfliteCaptureDelay"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,t,!0),this.sendMessage([{type:"setTfliteCaptureDelay",data:n.buffer}],s),await i}get threshold(){return e(this,ms,"f")}async setThreshold(t,s){if(Es.assertTypeWithError(t,"number"),Es.assertWithError(t>=0,`threshold must be positive (got ${t})`),e(this,ms,"f")==t)return void Es.log(`redundant threshold assignment ${t}`);const i=this.waitForEvent("getTfliteThreshold"),n=new DataView(new ArrayBuffer(4));n.setFloat32(0,t,!0),this.sendMessage([{type:"setTfliteThreshold",data:n.buffer}],s),await i}get inferencingEnabled(){return e(this,ws,"f")}async setInferencingEnabled(t,s=!0){if(Es.assertTypeWithError(t,"boolean"),!t&&!this.isReady)return;if(e(this,qt,"m",fs).call(this),e(this,ws,"f")==t)return void Es.log(`redundant inferencingEnabled assignment ${t}`);const i=this.waitForEvent("getTfliteInferencingEnabled");this.sendMessage([{type:"setTfliteInferencingEnabled",data:Uint8Array.from([Number(t)]).buffer}],s),await i}async toggleInferencingEnabled(){return this.setInferencingEnabled(!this.inferencingEnabled)}async enableInferencing(){this.inferencingEnabled||this.setInferencingEnabled(!0)}async disableInferencing(){this.inferencingEnabled&&this.setInferencingEnabled(!1)}parseMessage(t,s){switch(Es.log({messageType:t}),t){case"getTfliteName":case"setTfliteName":e(this,qt,"m",Zt).call(this,s);break;case"getTfliteTask":case"setTfliteTask":e(this,qt,"m",es).call(this,s);break;case"getTfliteSampleRate":case"setTfliteSampleRate":e(this,qt,"m",is).call(this,s);break;case"getTfliteSensorTypes":case"setTfliteSensorTypes":e(this,qt,"m",as).call(this,s);break;case"tfliteIsReady":e(this,qt,"m",hs).call(this,s);break;case"getTfliteCaptureDelay":case"setTfliteCaptureDelay":e(this,qt,"m",us).call(this,s);break;case"getTfliteThreshold":case"setTfliteThreshold":e(this,qt,"m",ps).call(this,s);break;case"getTfliteInferencingEnabled":case"setTfliteInferencingEnabled":e(this,qt,"m",ys).call(this,s);break;case"tfliteInference":e(this,qt,"m",Ss).call(this,s);break;default:throw Error(`uncaught messageType ${t}`)}}}var Ts,Is,_s,Us,Ls;Qt=new WeakMap,Yt=new WeakMap,ss=new WeakMap,rs=new WeakMap,cs=new WeakMap,gs=new WeakMap,ms=new WeakMap,ws=new WeakMap,qt=new WeakSet,Ht=function(e){Es.assertEnumWithError(e,ks)},Jt=function(e){Es.assertWithError(e in ks,`invalid taskEnum ${e}`)},Kt=function(){return this.eventDispatcher.dispatchEvent},Zt=function(t){Es.log("parseName",t);const s=V.decode(t.buffer);e(this,qt,"m",Xt).call(this,s)},Xt=function(s){Es.log({name:s}),t(this,Qt,s,"f"),e(this,qt,"a",Kt).call(this,"getTfliteName",{tfliteName:s})},es=function(t){Es.log("parseTask",t);const s=t.getUint8(0);e(this,qt,"m",Jt).call(this,s);const i=ks[s];e(this,qt,"m",ts).call(this,i)},ts=function(s){Es.log({task:s}),t(this,Yt,s,"f"),e(this,qt,"a",Kt).call(this,"getTfliteTask",{tfliteTask:s})},is=function(t){Es.log("parseSampleRate",t);const s=t.getUint16(0,!0);e(this,qt,"m",ns).call(this,s)},ns=function(s){Es.log({sampleRate:s}),t(this,ss,s,"f"),e(this,qt,"a",Kt).call(this,"getTfliteSampleRate",{tfliteSampleRate:s})},as=function(t){Es.log("parseSensorTypes",t);const s=[];for(let e=0;e<t.byteLength;e++){const i=t.getUint8(e),n=Et[i];n?s.push(n):Es.error(`invalid sensorTypeEnum ${i}`)}e(this,qt,"m",os).call(this,s)},os=function(s){Es.log({sensorTypes:s}),t(this,rs,s,"f"),e(this,qt,"a",Kt).call(this,"getTfliteSensorTypes",{tfliteSensorTypes:s})},hs=function(t){Es.log("parseIsReady",t);const s=Boolean(t.getUint8(0));e(this,qt,"m",ls).call(this,s)},ls=function(s){Es.log({isReady:s}),t(this,cs,s,"f"),e(this,qt,"a",Kt).call(this,"tfliteIsReady",{tfliteIsReady:s})},fs=function(){Es.assertWithError(this.isReady,"tflite is not ready")},us=function(t){Es.log("parseCaptureDelay",t);const s=t.getUint16(0,!0);e(this,qt,"m",ds).call(this,s)},ds=function(s){Es.log({captureDelay:s}),t(this,gs,s,"f"),e(this,qt,"a",Kt).call(this,"getTfliteCaptureDelay",{tfliteCaptureDelay:s})},ps=function(t){Es.log("parseThreshold",t);const s=t.getFloat32(0,!0);e(this,qt,"m",vs).call(this,s)},vs=function(s){Es.log({threshold:s}),t(this,ms,s,"f"),e(this,qt,"a",Kt).call(this,"getTfliteThreshold",{tfliteThreshold:s})},ys=function(t){Es.log("parseInferencingEnabled",t);const s=Boolean(t.getUint8(0));e(this,qt,"m",bs).call(this,s)},bs=function(s){Es.log({inferencingEnabled:s}),t(this,ws,s,"f"),e(this,qt,"a",Kt).call(this,"getTfliteInferencingEnabled",{tfliteInferencingEnabled:s})},Ss=function(t){Es.log("parseInference",t);const s=je(t,0);Es.log({timestamp:s});const i=[];for(let e=0,s=2;s<t.byteLength;e++,s+=4){const e=t.getFloat32(s,!0);i.push(e)}Es.log("values",i);const n={timestamp:s,values:i};if("classification"==this.task){let e=0,t=0;i.forEach(((s,i)=>{s>e&&(e=s,t=i)})),Es.log({maxIndex:t,maxValue:e}),n.maxIndex=t,n.maxValue=e}e(this,qt,"a",Kt).call(this,"tfliteInference",{tfliteInference:n})};const Fs=D("DeviceInformationManager",{log:!1}),As=["manufacturerName","modelNumber","hardwareRevision","firmwareRevision","softwareRevision","pnpId","serialNumber"],Rs=[...As,"deviceInformation"];class xs{constructor(){Ts.add(this),_s.set(this,{})}get information(){return e(this,_s,"f")}clear(){t(this,_s,{},"f")}parseMessage(t,s){switch(Fs.log({messageType:t}),t){case"manufacturerName":const i=V.decode(s.buffer);Fs.log({manufacturerName:i}),e(this,Ts,"m",Ls).call(this,{manufacturerName:i});break;case"modelNumber":const n=V.decode(s.buffer);Fs.log({modelNumber:n}),e(this,Ts,"m",Ls).call(this,{modelNumber:n});break;case"softwareRevision":const r=V.decode(s.buffer);Fs.log({softwareRevision:r}),e(this,Ts,"m",Ls).call(this,{softwareRevision:r});break;case"hardwareRevision":const a=V.decode(s.buffer);Fs.log({hardwareRevision:a}),e(this,Ts,"m",Ls).call(this,{hardwareRevision:a});break;case"firmwareRevision":const o=V.decode(s.buffer);Fs.log({firmwareRevision:o}),e(this,Ts,"m",Ls).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===s.getUint8(0)?"Bluetooth":"USB",productId:s.getUint16(3,!0),productVersion:s.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=s.getUint16(1,!0)),Fs.log({pnpId:c}),e(this,Ts,"m",Ls).call(this,{pnpId:c});break;case"serialNumber":const h=V.decode(s.buffer);Fs.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${t}`)}}}var $s,Os,Bs,Ns,Ps,Vs,zs,js,Gs,qs,Hs,Js,Ks,Qs,Zs,Xs,Ys,ei;_s=new WeakMap,Ts=new WeakSet,Is=function(){return this.eventDispatcher.dispatchEvent},Us=function(){return As.filter((e=>"serialNumber"!=e)).every((t=>t in e(this,_s,"f")))},Ls=function(t){Fs.log({partialDeviceInformation:t});Object.keys(t).forEach((s=>{e(this,Ts,"a",Is).call(this,s,{[s]:t[s]})})),Object.assign(e(this,_s,"f"),t),Fs.log({deviceInformation:e(this,_s,"f")}),e(this,Ts,"a",Us)&&(Fs.log("completed deviceInformation"),e(this,Ts,"a",Is).call(this,"deviceInformation",{deviceInformation:this.information}))};const ti=D("InformationManager",{log:!1}),si=["leftInsole","rightInsole","leftGlove","rightGlove","glasses","generic"],ii=["left","right"],ni=2,ri=30,ai=["isCharging","getBatteryCurrent","getMtu","getId","getName","setName","getType","setType","getCurrentTime","setCurrentTime"],oi=ai;class ci{constructor(){$s.add(this),Bs.set(this,!1),Ps.set(this,void 0),zs.set(this,void 0),Gs.set(this,""),qs.set(this,void 0),Qs.set(this,0),Xs.set(this,!1),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}get isCharging(){return e(this,Bs,"f")}get batteryCurrent(){return e(this,Ps,"f")}async getBatteryCurrent(){ti.log("getting battery current...");const e=this.waitForEvent("getBatteryCurrent");this.sendMessage([{type:"getBatteryCurrent"}]),await e}get id(){return e(this,zs,"f")}get name(){return e(this,Gs,"f")}updateName(s){ti.assertTypeWithError(s,"string"),t(this,Gs,s,"f"),ti.log({updatedName:e(this,Gs,"f")}),e(this,$s,"a",Os).call(this,"getName",{name:e(this,Gs,"f")})}async setName(e){ti.assertTypeWithError(e,"string"),ti.assertRangeWithError("newName",e.length,2,30);const t=P.encode(e);ti.log({setNameData:t});const s=this.waitForEvent("getName");this.sendMessage([{type:"setName",data:t.buffer}]),await s}get type(){return e(this,qs,"f")}get typeEnum(){return si.indexOf(this.type)}updateType(s){e(this,$s,"m",Hs).call(this,s),s!=this.type?(t(this,qs,s,"f"),ti.log({updatedType:e(this,qs,"f")}),e(this,$s,"a",Os).call(this,"getType",{type:e(this,qs,"f")})):ti.log("redundant type assignment")}async setType(t){e(this,$s,"m",Hs).call(this,t);const s=si.indexOf(t);e(this,$s,"m",Ks).call(this,s)}get isInsole(){switch(this.type){case"leftInsole":case"rightInsole":return!0;default:return!1}}get isGlove(){switch(this.type){case"leftGlove":case"rightGlove":return!0;default:return!1}}get side(){switch(this.type){case"leftInsole":case"leftGlove":default:return"left";case"rightInsole":case"rightGlove":return"right"}}get mtu(){return e(this,Qs,"f")}get isCurrentTimeSet(){return e(this,Xs,"f")}parseMessage(t,s){switch(ti.log({messageType:t}),t){case"isCharging":const n=Boolean(s.getUint8(0));ti.log({isCharging:n}),e(this,$s,"m",Ns).call(this,n);break;case"getBatteryCurrent":const r=s.getFloat32(0,!0);ti.log({batteryCurrent:r}),e(this,$s,"m",Vs).call(this,r);break;case"getId":const a=V.decode(s.buffer);ti.log({id:a}),e(this,$s,"m",js).call(this,a);break;case"getName":case"setName":const o=V.decode(s.buffer);ti.log({name:o}),this.updateName(o);break;case"getType":case"setType":const c=s.getUint8(0),h=si[c];ti.log({typeEnum:c,type:h}),this.updateType(h);break;case"getMtu":let l=s.getUint16(0,!0);i&&"webBluetooth"==this.connectionType&&(l=Math.min(l,512)),ti.log({mtu:l}),e(this,$s,"m",Zs).call(this,l);break;case"getCurrentTime":case"setCurrentTime":const f=Number(s.getBigUint64(0,!0));e(this,$s,"m",Ys).call(this,f);break;default:throw Error(`uncaught messageType ${t}`)}}clear(){t(this,Xs,!1,"f")}}Bs=new WeakMap,Ps=new WeakMap,zs=new WeakMap,Gs=new WeakMap,qs=new WeakMap,Qs=new WeakMap,Xs=new WeakMap,$s=new WeakSet,Os=function(){return this.eventDispatcher.dispatchEvent},Ns=function(s){ti.assertTypeWithError(s,"boolean"),t(this,Bs,s,"f"),ti.log({isCharging:e(this,Bs,"f")}),e(this,$s,"a",Os).call(this,"isCharging",{isCharging:e(this,Bs,"f")})},Vs=function(s){ti.assertTypeWithError(s,"number"),t(this,Ps,s,"f"),ti.log({batteryCurrent:e(this,Ps,"f")}),e(this,$s,"a",Os).call(this,"getBatteryCurrent",{batteryCurrent:e(this,Ps,"f")})},js=function(s){ti.assertTypeWithError(s,"string"),t(this,zs,s,"f"),ti.log({id:e(this,zs,"f")}),e(this,$s,"a",Os).call(this,"getId",{id:e(this,zs,"f")})},Hs=function(e){ti.assertEnumWithError(e,si)},Js=function(e){ti.assertTypeWithError(e,"number"),ti.assertWithError(e in si,`invalid typeEnum ${e}`)},Ks=async function(t){e(this,$s,"m",Js).call(this,t);const s=Uint8Array.from([t]);ti.log({setTypeData:s});const i=this.waitForEvent("getType");this.sendMessage([{type:"setType",data:s.buffer}]),await i},Zs=function(s){ti.assertTypeWithError(s,"number"),e(this,Qs,"f")!=s?(t(this,Qs,s,"f"),e(this,$s,"a",Os).call(this,"getMtu",{mtu:e(this,Qs,"f")})):ti.log("redundant mtu assignment",s)},Ys=function(s){ti.log({currentTime:s}),t(this,Xs,0!=s||Math.abs(Date.now()-s)<ze,"f"),e(this,Xs,"f")||e(this,$s,"m",ei).call(this,!1)},ei=async function(e){ti.log("setting current time...");const t=new DataView(new ArrayBuffer(8));t.setBigUint64(0,BigInt(Date.now()),!0);const s=this.waitForEvent("getCurrentTime");this.sendMessage([{type:"setCurrentTime",data:t.buffer}],e),await s};const hi=["none","strongClick100","strongClick60","strongClick30","sharpClick100","sharpClick60","sharpClick30","softBump100","softBump60","softBump30","doubleClick100","doubleClick60","tripleClick100","softFuzz60","strongBuzz100","alert750ms","alert1000ms","strongClick1_100","strongClick2_80","strongClick3_60","strongClick4_30","mediumClick100","mediumClick80","mediumClick60","sharpTick100","sharpTick80","sharpTick60","shortDoubleClickStrong100","shortDoubleClickStrong80","shortDoubleClickStrong60","shortDoubleClickStrong30","shortDoubleClickMedium100","shortDoubleClickMedium80","shortDoubleClickMedium60","shortDoubleSharpTick100","shortDoubleSharpTick80","shortDoubleSharpTick60","longDoubleSharpClickStrong100","longDoubleSharpClickStrong80","longDoubleSharpClickStrong60","longDoubleSharpClickStrong30","longDoubleSharpClickMedium100","longDoubleSharpClickMedium80","longDoubleSharpClickMedium60","longDoubleSharpTick100","longDoubleSharpTick80","longDoubleSharpTick60","buzz100","buzz80","buzz60","buzz40","buzz20","pulsingStrong100","pulsingStrong60","pulsingMedium100","pulsingMedium60","pulsingSharp100","pulsingSharp60","transitionClick100","transitionClick80","transitionClick60","transitionClick40","transitionClick20","transitionClick10","transitionHum100","transitionHum80","transitionHum60","transitionHum40","transitionHum20","transitionHum10","transitionRampDownLongSmooth2_100","transitionRampDownLongSmooth1_100","transitionRampDownMediumSmooth1_100","transitionRampDownMediumSmooth2_100","transitionRampDownShortSmooth1_100","transitionRampDownShortSmooth2_100","transitionRampDownLongSharp1_100","transitionRampDownLongSharp2_100","transitionRampDownMediumSharp1_100","transitionRampDownMediumSharp2_100","transitionRampDownShortSharp1_100","transitionRampDownShortSharp2_100","transitionRampUpLongSmooth1_100","transitionRampUpLongSmooth2_100","transitionRampUpMediumSmooth1_100","transitionRampUpMediumSmooth2_100","transitionRampUpShortSmooth1_100","transitionRampUpShortSmooth2_100","transitionRampUpLongSharp1_100","transitionRampUpLongSharp2_100","transitionRampUpMediumSharp1_100","transitionRampUpMediumSharp2_100","transitionRampUpShortSharp1_100","transitionRampUpShortSharp2_100","transitionRampDownLongSmooth1_50","transitionRampDownLongSmooth2_50","transitionRampDownMediumSmooth1_50","transitionRampDownMediumSmooth2_50","transitionRampDownShortSmooth1_50","transitionRampDownShortSmooth2_50","transitionRampDownLongSharp1_50","transitionRampDownLongSharp2_50","transitionRampDownMediumSharp1_50","transitionRampDownMediumSharp2_50","transitionRampDownShortSharp1_50","transitionRampDownShortSharp2_50","transitionRampUpLongSmooth1_50","transitionRampUpLongSmooth2_50","transitionRampUpMediumSmooth1_50","transitionRampUpMediumSmooth2_50","transitionRampUpShortSmooth1_50","transitionRampUpShortSmooth2_50","transitionRampUpLongSharp1_50","transitionRampUpLongSharp2_50","transitionRampUpMediumSharp1_50","transitionRampUpMediumSharp2_50","transitionRampUpShortSharp1_50","transitionRampUpShortSharp2_50","longBuzz100","smoothHum50","smoothHum40","smoothHum30","smoothHum20","smoothHum10"];var li,fi,gi,ui,di,mi,pi,vi,wi,yi,bi,Si,Ei,Ci,Mi,ki;const Di=D("VibrationManager"),Wi=["front","rear"],Ti=["waveformEffect","waveform"],Ii=8,_i=2550,Ui=1270,Li=3,Fi=20,Ai=6;class Ri{constructor(){li.add(this),J(this)}async triggerVibration(t,s=!0){let i;t.forEach((t=>{const{type:s}=t;let n,{locations:r}=t;switch(r=r||Wi.slice(),s){case"waveformEffect":{const{segments:s,loopCount:i}=t;n=e(this,li,"m",Ei).call(this,r,s,i)}break;case"waveform":{const{segments:s}=t;n=e(this,li,"m",Ci).call(this,r,s)}break;default:throw Error(`invalid vibration type "${s}"`)}Di.log({type:s,arrayBuffer:n}),i=j(i,n)})),await this.sendMessage([{type:"triggerVibration",data:i}],s)}}var xi,$i,Oi,Bi,Ni,Pi,Vi,zi,ji,Gi,qi,Hi,Ji,Ki,Qi,Zi,Xi,Yi;li=new WeakSet,fi=function(e){Di.assertTypeWithError(e,"string"),Di.assertWithError(Wi.includes(e),`invalid location "${e}"`)},gi=function(t){e(this,li,"m",di).call(this,t),t.forEach((t=>{e(this,li,"m",fi).call(this,t)}))},ui=function(t){e(this,li,"m",gi).call(this,t);let s=0;return t.forEach((e=>{const t=Wi.indexOf(e);s|=1<<t})),Di.log({locationsBitmask:s}),Di.assertWithError(s>0,"locationsBitmask must not be zero"),s},di=function(e){Di.assertWithError(Array.isArray(e),"passed non-array"),Di.assertWithError(e.length>0,"passed empty array")},mi=function(e){Di.assertWithError(hi.includes(e),`invalid waveformEffect "${e}"`)},pi=function(t){if(null!=t.effect){const s=t.effect;e(this,li,"m",mi).call(this,s)}else{if(null==t.delay)throw Error("no effect or delay found in waveformEffectSegment");{const{delay:e}=t;Di.assertWithError(e>=0,`delay must be 0ms or greater (got ${e})`),Di.assertWithError(e<=Ui,`delay must be 1270ms or less (got ${e})`)}}if(null!=t.loopCount){const{loopCount:s}=t;e(this,li,"m",vi).call(this,s)}},vi=function(e){Di.assertTypeWithError(e,"number"),Di.assertWithError(e>=0,`waveformEffectSegmentLoopCount must be 0 or greater (got ${e})`),Di.assertWithError(e<=3,`waveformEffectSegmentLoopCount must be 3 or fewer (got ${e})`)},wi=function(t){e(this,li,"m",di).call(this,t),Di.assertWithError(t.length<=8,`must have 8 waveformEffectSegments or fewer (got ${t.length})`),t.forEach((t=>{e(this,li,"m",pi).call(this,t)}))},yi=function(e){Di.assertTypeWithError(e,"number"),Di.assertWithError(e>=0,`waveformEffectSequenceLoopCount must be 0 or greater (got ${e})`),Di.assertWithError(e<=6,`waveformEffectSequenceLoopCount must be 6 or fewer (got ${e})`)},bi=function(e){Di.assertTypeWithError(e.amplitude,"number"),Di.assertWithError(e.amplitude>=0,`amplitude must be 0 or greater (got ${e.amplitude})`),Di.assertWithError(e.amplitude<=1,`amplitude must be 1 or less (got ${e.amplitude})`),Di.assertTypeWithError(e.duration,"number"),Di.assertWithError(e.duration>0,`duration must be greater than 0ms (got ${e.duration}ms)`),Di.assertWithError(e.duration<=_i,`duration must be 2550ms or less (got ${e.duration}ms)`)},Si=function(t){e(this,li,"m",di).call(this,t),Di.assertWithError(t.length<=20,`must have 20 waveformSegments or fewer (got ${t.length})`),t.forEach((t=>{e(this,li,"m",bi).call(this,t)}))},Ei=function(t,s,i=0){e(this,li,"m",wi).call(this,s),e(this,li,"m",yi).call(this,i);let n=[],r=0;const a=s.some((e=>{const{loopCount:t}=e;return null!=t&&t>0}))||0!=i;for(let e=0;e<s.length||a&&e<8;e++){const t=s[e]||{effect:"none"};if(null!=t.effect){const e=t.effect;n[r++]=hi.indexOf(e)}else{if(null==t.delay)throw Error("invalid waveformEffectSegment");{const{delay:e}=t;n[r++]=128|Math.floor(e/10)}}}const o=0!=i;for(let e=0;e<s.length||o&&e<8;e++){const t=s[e]?.loopCount||0;0!=e&&4!=e||(n[r]=0);const i=e%4*2;n[r]|=t<<i,3!=e&&7!=e||r++}0!=i&&(n[r++]=i);const c=new DataView(Uint8Array.from(n).buffer);return Di.log({dataArray:n,dataView:c}),e(this,li,"m",ki).call(this,t,"waveformEffect",c)},Ci=function(t,s){e(this,li,"m",Si).call(this,s);const i=new DataView(new ArrayBuffer(2*s.length));return s.forEach(((e,t)=>{i.setUint8(2*t,Math.floor(127*e.amplitude)),i.setUint8(2*t+1,Math.floor(e.duration/10))})),Di.log({dataView:i}),e(this,li,"m",ki).call(this,t,"waveform",i)},Mi=function(e){Di.assertTypeWithError(e,"string"),Di.assertWithError(Ti.includes(e),`invalid vibrationType "${e}"`)},ki=function(t,s,i){Di.assertWithError(i?.byteLength>0,"no data received");const n=e(this,li,"m",ui).call(this,t);e(this,li,"m",Mi).call(this,s);const r=Ti.indexOf(s);Di.log({locationsBitmask:n,vibrationTypeIndex:r,dataView:i});const a=j(n,r,i.byteLength,i);return Di.log({data:a}),a};const en=D("WifiManager",{log:!1}),tn=1,sn=32,nn=8,rn=64,an=["isWifiAvailable","getWifiSSID","setWifiSSID","getWifiPassword","setWifiPassword","getEnableWifiConnection","setEnableWifiConnection","isWifiConnected","ipAddress","isWifiSecure"],on=["getWifiSSID","getWifiPassword","getEnableWifiConnection","isWifiConnected","ipAddress","isWifiSecure"],cn=an;class hn{constructor(){xi.add(this),Bi.set(this,!1),Vi.set(this,""),ji.set(this,""),qi.set(this,void 0),Ji.set(this,!1),Qi.set(this,void 0),Xi.set(this,!1),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}get isWifiAvailable(){return e(this,Bi,"f")}get wifiSSID(){return e(this,Vi,"f")}async setWifiSSID(t){if(e(this,xi,"m",Pi).call(this),e(this,qi,"f"))return void en.error("cannot change ssid while wifi connection is enabled");en.assertTypeWithError(t,"string"),en.assertRangeWithError("wifiSSID",t.length,1,32);const s=P.encode(t);en.log({setWifiSSIDData:s});const i=this.waitForEvent("getWifiSSID");this.sendMessage([{type:"setWifiSSID",data:s.buffer}]),await i}get wifiPassword(){return e(this,ji,"f")}async setWifiPassword(t){if(e(this,xi,"m",Pi).call(this),e(this,qi,"f"))return void en.error("cannot change password while wifi connection is enabled");en.assertTypeWithError(t,"string"),t.length>0&&en.assertRangeWithError("wifiPassword",t.length,8,64);const s=P.encode(t);en.log({setWifiPasswordData:s});const i=this.waitForEvent("getWifiPassword");this.sendMessage([{type:"setWifiPassword",data:s.buffer}]),await i}get wifiConnectionEnabled(){return e(this,qi,"f")}async setWifiConnectionEnabled(t,s=!0){if(e(this,xi,"m",Pi).call(this),en.assertTypeWithError(t,"boolean"),e(this,qi,"f")==t)return void en.log(`redundant wifiConnectionEnabled assignment ${t}`);const i=this.waitForEvent("getEnableWifiConnection");this.sendMessage([{type:"setEnableWifiConnection",data:Uint8Array.from([Number(t)]).buffer}],s),await i}async toggleWifiConnection(){return this.setWifiConnectionEnabled(!this.wifiConnectionEnabled)}async enableWifiConnection(){return this.setWifiConnectionEnabled(!0)}async disableWifiConnection(){return this.setWifiConnectionEnabled(!1)}get isWifiConnected(){return e(this,Ji,"f")}get ipAddress(){return e(this,Qi,"f")}get isWifiSecure(){return e(this,Xi,"f")}parseMessage(t,s){switch(en.log({messageType:t}),t){case"isWifiAvailable":const i=Boolean(s.getUint8(0));en.log({isWifiAvailable:i}),e(this,xi,"m",Ni).call(this,i);break;case"getWifiSSID":case"setWifiSSID":const n=V.decode(s.buffer);en.log({ssid:n}),e(this,xi,"m",zi).call(this,n);break;case"getWifiPassword":case"setWifiPassword":const r=V.decode(s.buffer);en.log({password:r}),e(this,xi,"m",Gi).call(this,r);break;case"getEnableWifiConnection":case"setEnableWifiConnection":const a=Boolean(s.getUint8(0));en.log({enableWifiConnection:a}),e(this,xi,"m",Hi).call(this,a);break;case"isWifiConnected":const o=Boolean(s.getUint8(0));en.log({isWifiConnected:o}),e(this,xi,"m",Ki).call(this,o);break;case"ipAddress":const c=new Uint8Array(s.buffer.slice(0,4)).join(".");en.log({ipAddress:c}),e(this,xi,"m",Zi).call(this,c);break;case"isWifiSecure":const h=Boolean(s.getUint8(0));en.log({isWifiSecure:h}),e(this,xi,"m",Yi).call(this,h);break;default:throw Error(`uncaught messageType ${t}`)}}clear(){t(this,Vi,"","f"),t(this,ji,"","f"),t(this,Qi,"","f"),t(this,Ji,!1,"f")}}var ln,fn,gn,un,dn,mn,pn,vn,wn,yn,bn,Sn;Bi=new WeakMap,Vi=new WeakMap,ji=new WeakMap,qi=new WeakMap,Ji=new WeakMap,Qi=new WeakMap,Xi=new WeakMap,xi=new WeakSet,$i=function(){return this.eventDispatcher.dispatchEvent},Oi=function(){en.log("requesting required wifi information");const e=on.map((e=>({type:e})));this.sendMessage(e,!1)},Ni=function(s){en.assertTypeWithError(s,"boolean"),t(this,Bi,s,"f"),en.log({isWifiAvailable:e(this,Bi,"f")}),e(this,xi,"a",$i).call(this,"isWifiAvailable",{isWifiAvailable:e(this,Bi,"f")}),this.isWifiAvailable&&e(this,xi,"m",Oi).call(this)},Pi=function(){en.assertWithError(e(this,Bi,"f"),"wifi is not available")},zi=function(s){en.assertTypeWithError(s,"string"),t(this,Vi,s,"f"),en.log({wifiSSID:e(this,Vi,"f")}),e(this,xi,"a",$i).call(this,"getWifiSSID",{wifiSSID:e(this,Vi,"f")})},Gi=function(s){en.assertTypeWithError(s,"string"),t(this,ji,s,"f"),en.log({wifiPassword:e(this,ji,"f")}),e(this,xi,"a",$i).call(this,"getWifiPassword",{wifiPassword:e(this,ji,"f")})},Hi=function(s){en.log({wifiConnectionEnabled:s}),t(this,qi,s,"f"),e(this,xi,"a",$i).call(this,"getEnableWifiConnection",{wifiConnectionEnabled:s})},Ki=function(s){en.assertTypeWithError(s,"boolean"),t(this,Ji,s,"f"),en.log({isWifiConnected:e(this,Ji,"f")}),e(this,xi,"a",$i).call(this,"isWifiConnected",{isWifiConnected:e(this,Ji,"f")})},Zi=function(s){en.assertTypeWithError(s,"string"),t(this,Qi,s,"f"),en.log({ipAddress:e(this,Qi,"f")}),e(this,xi,"a",$i).call(this,"ipAddress",{ipAddress:e(this,Qi,"f")})},Yi=function(s){en.assertTypeWithError(s,"boolean"),t(this,Xi,s,"f"),en.log({isWifiSecure:e(this,Xi,"f")}),e(this,xi,"a",$i).call(this,"isWifiSecure",{isWifiSecure:e(this,Xi,"f")})};const En=D("BaseConnectionManager",{log:!1}),Cn=["notConnected","connecting","connected","disconnecting"],Mn=[...Cn,"connectionStatus","isConnected"],kn=[...ai,...zt,...Mt,"triggerVibration",...Cs,...Re,...an],Dn=["batteryLevel"],Wn=["rx","tx"],Tn=[...Dn,...As,...Wn,...kn,"smp"];class In{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get canUpdateFirmware(){return!1}get type(){return this.baseConstructor.type}constructor(){ln.add(this),dn.set(this,"notConnected"),vn.set(this,[]),wn.set(this,!1),this.defaultMtu=23,this.mtu=this.defaultMtu,bn.set(this,new R(e(this,ln,"m",Sn).bind(this),5e3)),e(this,ln,"m",un).call(this)}get status(){return e(this,dn,"f")}set status(s){En.assertEnumWithError(s,Cn),e(this,dn,"f")!=s?(En.log(`new connection status "${s}"`),t(this,dn,s,"f"),this.onStatusUpdated(this.status),this.isConnected?e(this,bn,"f").start():e(this,bn,"f").stop(),"notConnected"==e(this,dn,"f")&&(this.mtu=this.defaultMtu)):En.log(`tried to assign same connection status "${s}"`)}get isConnected(){return"connected"==this.status}get isAvailable(){return!1}assertIsNotConnected(){En.assertWithError(!this.isConnected,"device is already connected")}assertIsConnected(){En.assertWithError(this.isConnected,"device is not connected")}assertIsConnectedAndNotDisconnecting(){this.assertIsConnected(),e(this,ln,"m",pn).call(this)}async connect(){this.assertIsNotConnected(),e(this,ln,"m",mn).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){this.assertIsNotConnected(),e(this,ln,"m",mn).call(this),En.assertWithError(this.canReconnect,"unable to reconnect"),this.status="connecting",En.log("attempting to reconnect...")}async disconnect(){this.assertIsConnected(),e(this,ln,"m",pn).call(this),this.status="disconnecting",En.log("disconnecting from device...")}async sendSmpMessage(e){this.assertIsConnectedAndNotDisconnecting(),En.log("sending smp message",e)}async sendTxMessages(s,i=!0){if(this.assertIsConnectedAndNotDisconnecting(),s&&(e(this,vn,"f").push(...s),En.log(`appended ${s.length} messages`)),!i)return void En.log("not sending immediately - waiting until later");if(e(this,wn,"f"))return void En.log("already sending messages - waiting until later");t(this,wn,!0,"f"),En.log("sendTxMessages",e(this,vn,"f").slice());const n=e(this,vn,"f").map((t=>{e(fn,fn,"m",gn).call(fn,t.type);const s=kn.indexOf(t.type),i=new DataView(new ArrayBuffer(2));return i.setUint16(0,t.data?.byteLength||0,!0),j(s,i,t.data)}));if(e(this,vn,"f").length=0,this.mtu)for(;n.length>0;){if(n.every((e=>e.byteLength>this.mtu-3))){En.log("every arrayBuffer is too big to send");break}En.log("remaining arrayBuffers.length",n.length);let e=0,t=0;n.some((s=>{if(e+s.byteLength>this.mtu-3)return En.log(`stopping appending arrayBuffers ( length ${s.byteLength} too much)`),!0;En.log(`allowing arrayBuffer with length ${s.byteLength}`),t++,e+=s.byteLength}));const s=n.splice(0,t);En.log({arrayBufferCount:t,arrayBuffersToSend:s});const i=j(...s);En.log("sending arrayBuffer (partitioned)",i),await this.sendTxData(i)}else{const e=j(...n);En.log("sending arrayBuffer (all)",e),await this.sendTxData(e)}t(this,wn,!1,"f")}async sendTxData(e){En.log("sendTxData",e)}parseRxMessage(t){yt(t,kn,e(this,ln,"m",yn).bind(this),null,!0),this.onMessagesReceived()}clear(){t(this,wn,!1,"f"),e(this,vn,"f").length=0}}fn=In,dn=new WeakMap,vn=new WeakMap,wn=new WeakMap,bn=new WeakMap,ln=new WeakSet,gn=function(e){En.assertEnumWithError(e,kn)},un=function(){En.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},mn=function(){En.assertWithError("connecting"!=this.status,"device is already connecting")},pn=function(){En.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},yn=function(e,t){En.log({messageType:e,dataView:t}),this.onMessageReceived(e,t)},Sn=function(){this.isConnected||(En.log("timer detected disconnection"),this.status="notConnected")};const _n=D("EventUtils",{log:!1});function Un(e,t){let s=e.addEventListener||e.addListener||e.on||e.AddEventListener;_n.assertWithError(s,"no add listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}function Ln(e,t){let s=e.removeEventListener||e.removeListener||e.RemoveEventListener;_n.assertWithError(s,"no remove listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}const Fn=D("bluetoothUUIDs",{log:!1});if(i)var An=window.BluetoothUUID;function Rn(e){return Fn.assertTypeWithError(e,"string"),Fn.assertWithError(4==e.length,"value must be 4 characters long"),`ea6da725-${e}-4f9b-893d-c3913e33b39f`}function xn(e){return An?.getCharacteristic?.(e)}function $n(e){return An?.getService?.(e)}const On=Object.freeze({services:{deviceInformation:{uuid:$n("device_information"),characteristics:{manufacturerName:{uuid:xn("manufacturer_name_string")},modelNumber:{uuid:xn("model_number_string")},hardwareRevision:{uuid:xn("hardware_revision_string")},firmwareRevision:{uuid:xn("firmware_revision_string")},softwareRevision:{uuid:xn("software_revision_string")},pnpId:{uuid:xn("pnp_id")},serialNumber:{uuid:xn("serial_number_string")}}},battery:{uuid:$n("battery_service"),characteristics:{batteryLevel:{uuid:xn("battery_level")}}},main:{uuid:Rn("0000"),characteristics:{rx:{uuid:Rn("1000")},tx:{uuid:Rn("1001")}}},smp:{uuid:"8d53dc1d-1db7-4cd3-868b-8a527460aa84",characteristics:{smp:{uuid:"da2e7828-fbce-4e01-ae9e-261174997c48"}}}}}),Bn=[On.services.main.uuid],Nn=[On.services.deviceInformation.uuid,On.services.battery.uuid,On.services.smp.uuid];function Pn(e){e=e.toString().toLowerCase();return Object.keys(On.services).find((t=>{let s=On.services[t].uuid.toString();return 4==e.length&&(s=s.slice(4,8)),e.includes("-")||(s=s.replaceAll("-","")),e==s}))}const Vn=[],zn=[];function jn(e){var t;return e=e.toString().toLowerCase(),Object.values(On.services).some((s=>{const i=Object.keys(s.characteristics);return t=i.find((t=>{let i=s.characteristics[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))})),t}function Gn(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"rx":case"tx":case"smp":t.read=!1}switch(e){case"batteryLevel":case"rx":case"smp":t.notify=!0}if("smp"===e)t.writeWithoutResponse=!0;if("tx"===e)t.write=!0;return t}Object.values(On.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((s=>{const i=e.characteristics[s];Bn.includes(e.uuid)&&(Vn.push(i.uuid),t.push(s)),zn.push(i.uuid)}))}),[]);const qn=D("BluetoothConnectionManager",{log:!1});class Hn extends In{constructor(){super(...arguments),this.isInRange=!0}get isAvailable(){return!0}onCharacteristicValueChanged(e,t){"rx"==e?this.parseRxMessage(t):this.onMessageReceived?.(e,t)}async writeCharacteristic(e,t){qn.log("writeCharacteristic",...arguments)}async sendSmpMessage(e){super.sendSmpMessage(e),await this.writeCharacteristic("smp",e)}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&await this.writeCharacteristic("tx",e)}}var Jn,Kn,Qn,Zn,Xn,Yn,er,tr,sr,ir,nr;const rr=D("WebBluetoothConnectionManager",{log:!1});var ar;i&&(ar=window.navigator.bluetooth);class or extends Hn{constructor(){super(...arguments),Jn.add(this),Kn.set(this,{characteristicvaluechanged:e(this,Jn,"m",sr).bind(this)}),Qn.set(this,{gattserverdisconnected:e(this,Jn,"m",nr).bind(this)}),Zn.set(this,void 0),Xn.set(this,new Map),Yn.set(this,new Map)}get bluetoothId(){return this.device.id}get canUpdateFirmware(){return e(this,Yn,"f").has("smp")}static get isSupported(){return Boolean(ar)}static get type(){return"webBluetooth"}get device(){return e(this,Zn,"f")}set device(s){e(this,Zn,"f")!=s?(e(this,Zn,"f")&&Ln(e(this,Zn,"f"),e(this,Qn,"f")),s&&Un(s,e(this,Qn,"f")),t(this,Zn,s,"f")):rr.log("tried to assign the same BluetoothDevice")}get server(){return e(this,Zn,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const t=await ar.requestDevice({filters:[{services:Bn}],optionalServices:i?Nn:[]});rr.log("got BluetoothDevice"),this.device=t,rr.log("connecting to device...");const s=await this.server.connect();rr.log(`connected to device? ${s.connected}`),await e(this,Jn,"m",er).call(this),rr.log("fully connected"),this.status="connected"}catch(t){rr.error(t),this.status="notConnected",this.server?.disconnect(),e(this,Jn,"m",tr).call(this)}}async disconnect(){await e(this,Jn,"m",tr).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(t,s){super.writeCharacteristic(t,s);const i=e(this,Yn,"f").get(t);rr.assertWithError(i,`${t} characteristic not found`),rr.log("writing characteristic",i,s);const n=i.properties||Gn(t);n.writeWithoutResponse?(rr.log("writing without response"),await i.writeValueWithoutResponse(s)):(rr.log("writing with response"),await i.writeValueWithResponse(s)),rr.log("wrote characteristic"),n.read&&!n.notify&&(rr.log("reading value after write..."),await i.readValue(),(o||c)&&e(this,Jn,"m",ir).call(this,i))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect();try{await this.server.connect()}catch(e){rr.error(e),this.isInRange=!1}this.isConnected?(rr.log("successfully reconnected!"),await e(this,Jn,"m",er).call(this),this.status="connected"):(rr.log("unable to reconnect"),this.status="notConnected")}}Kn=new WeakMap,Qn=new WeakMap,Zn=new WeakMap,Xn=new WeakMap,Yn=new WeakMap,Jn=new WeakSet,er=async function(){e(this,Jn,"m",tr).call(this),rr.log("getting services...");const t=await this.server.getPrimaryServices();rr.log("got services",t.length),rr.log("getting characteristics...");for(const s in t){const i=t[s];rr.log({service:i});const n=Pn(i.uuid);rr.assertWithError(n,`no name found for service uuid "${i.uuid}"`),rr.log(`got "${n}" service`),i.name=n,e(this,Xn,"f").set(n,i),rr.log(`getting characteristics for "${n}" service`);const r=await i.getCharacteristics();rr.log(`got characteristics for "${n}" service`);for(const t in r){const s=r[t];rr.log({characteristic:s});const i=jn(s.uuid);rr.assertWithError(Boolean(i),`no name found for characteristic uuid "${s.uuid}" in "${n}" service`),rr.log(`got "${i}" characteristic in "${n}" service`),s.name=i,e(this,Yn,"f").set(i,s),Un(s,e(this,Kn,"f"));const a=s.properties||Gn(i);a.notify&&(rr.log(`starting notifications for "${i}" characteristic`),await s.startNotifications()),a.read&&(rr.log(`reading "${i}" characteristic...`),await s.readValue(),(o||c)&&e(this,Jn,"m",ir).call(this,s))}}},tr=async function(){this.device&&Ln(this.device,e(this,Qn,"f"));const t=Array.from(e(this,Yn,"f").keys()).map((t=>{const s=e(this,Yn,"f").get(t);Ln(s,e(this,Kn,"f"));if((s.properties||Gn(t)).notify)return rr.log(`stopping notifications for "${t}" characteristic`),s.stopNotifications()}));return Promise.allSettled(t)},sr=function(t){rr.log("oncharacteristicvaluechanged");const s=t.target;e(this,Jn,"m",ir).call(this,s)},ir=function(e){rr.log("onCharacteristicValue");const t=e.name;rr.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),rr.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const s=e.value;rr.assertWithError(s,`no data found for "${t}" characteristic`),rr.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(s.buffer)));try{this.onCharacteristicValueChanged(t,s)}catch(e){rr.error(e)}},nr=function(){rr.log("gattserverdisconnected"),this.status="notConnected"};const cr=4294967296,hr=9007199254740992;const lr={encode:function(e){let t,s=new ArrayBuffer(256),i=new DataView(s),n=0;function r(e){let r=s.byteLength;const a=n+e;for(;r<a;)r<<=1;if(r!==s.byteLength){const e=i;s=new ArrayBuffer(r),i=new DataView(s);const t=n+3>>2;for(let s=0;s<t;++s)i.setUint32(s<<2,e.getUint32(s<<2))}return t=e,i}function a(){n+=t}function o(e){a(r(1).setUint8(n,e))}function c(e){const t=r(e.length);for(let s=0;s<e.length;++s)t.setUint8(n+s,e[s]);a()}function h(e,t){t<24?o(e<<5|t):t<256?(o(e<<5|24),o(t)):t<65536?(o(e<<5|25),function(e){a(r(2).setUint16(n,e))}(t)):t<4294967296?(o(e<<5|26),function(e){a(r(4).setUint32(n,e))}(t)):(o(e<<5|27),function(e){const t=e%cr,s=(e-t)/cr,i=r(8);i.setUint32(n,s),i.setUint32(n+4,t),a()}(t))}if(function e(t){let s;const i=[];let l;if(!1===t)return o(244);if(!0===t)return o(245);if(null===t)return o(246);if(void 0===t)return o(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(t>=0&&t<=hr)return h(0,t);if(-hr<=t&&t<0)return h(1,-(t+1))}return o(251),function(e){a(r(8).setFloat64(n,e))}(t);case"string":for(s=0;s<t.length;++s){let e=t.charCodeAt(s);e<128?i.push(e):e<2048?(i.push(192|e>>6),i.push(128|63&e)):e<55296?(i.push(224|e>>12),i.push(128|e>>6&63),i.push(128|63&e)):(e=(1023&e)<<10,e|=1023&t.charCodeAt(++s),e+=65536,i.push(240|e>>18),i.push(128|e>>12&63),i.push(128|e>>6&63),i.push(128|63&e))}return h(3,i.length),c(i);default:if(Array.isArray(t))for(l=t.length,h(4,l),s=0;s<l;++s)e(t[s]);else if(t instanceof Uint8Array)h(2,t.length),c(t);else{const i=Object.keys(t);for(l=i.length,h(5,l),s=0;s<l;++s){const n=i[s];e(n),e(t[n])}}}}(e),"slice"in s)return s.slice(0,n);const l=new ArrayBuffer(n),f=new DataView(l);for(let e=0;e<n;++e)f.setUint8(e,i.getUint8(e));return l},decode:function(e,t,s){const i=new DataView(e);let n=0;function r(e,t){return n+=e,t}function a(t){return r(t,new Uint8Array(e,n,t))}function o(){return r(1,i.getUint8(n))}function c(){return r(2,i.getUint16(n))}function h(){return r(4,i.getUint32(n))}function l(){return 255===i.getUint8(n)&&(n+=1,!0)}function f(e){if(e<24)return e;if(24===e)return o();if(25===e)return c();if(26===e)return h();if(27===e)return h()*cr+h();if(31===e)return-1;throw new Error("Invalid length encoding")}function g(e){const t=o();if(255===t)return-1;const s=f(31&t);if(s<0||t>>5!==e)throw new Error("Invalid indefinite length element");return s}function u(e,t){for(let s=0;s<t;++s){let s=o();128&s&&(s<224?(s=(31&s)<<6|63&o(),t-=1):s<240?(s=(15&s)<<12|(63&o())<<6|63&o(),t-=2):(s=(15&s)<<18|(63&o())<<12|(63&o())<<6|63&o(),t-=3)),s<65536?e.push(s):(s-=65536,e.push(55296|s>>10),e.push(56320|1023&s))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof s&&(s=function(){});const d=function e(){const h=o(),d=h>>5,m=31&h;let p,v;if(7===d)switch(m){case 25:return function(){const e=new ArrayBuffer(4),t=new DataView(e),s=c(),i=32768&s;let n=31744&s;const r=1023&s;if(31744===n)n=261120;else if(0!==n)n+=114688;else if(0!==r)return(i?-1:1)*r*5.960464477539063e-8;return t.setUint32(0,i<<16|n<<13|r<<13),t.getFloat32(0)}();case 26:return r(4,i.getFloat32(n));case 27:return r(8,i.getFloat64(n))}if(v=f(m),v<0&&(d<2||d>6))throw new Error("Invalid length");const w=[];let y;const b={};switch(d){case 0:return v;case 1:return-1-v;case 2:if(v<0){const e=[];let t=0;for(;(v=g(d))>=0;)t+=v,e.push(a(v));const s=new Uint8Array(t);let i=0;for(p=0;p<e.length;++p)s.set(e[p],i),i+=e[p].length;return s}return a(v);case 3:if(v<0)for(;(v=g(d))>=0;)u(w,v);else u(w,v);return String.fromCharCode.apply(null,w);case 4:if(v<0)for(y=[];!l();)y.push(e());else for(y=new Array(v),p=0;p<v;++p)y[p]=e();return y;case 5:for(p=0;p<v||v<0&&!l();++p){b[e()]=e()}return b;case 6:return t(e(),v);case 7:switch(v){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return s(v)}}}();if(n!==e.byteLength)throw new Error("Remaining bytes");return d}},fr=D("mcumgr",{log:!1}),gr=0,ur=1,dr=2,mr=3,pr=0,vr=1,wr=8,yr=0,br=2,Sr=3,Er=5,Cr=0,Mr=1,kr=5,Dr=0;class Wr{constructor(){this._mtu=256,this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}onMessage(e){return this._messageCallback=e,this}onImageUploadNext(e){return this._imageUploadNextCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}onFileUploadNext(e){return this._fileUploadNextCallback=e,this}onFileUploadProgress(e){return this._fileUploadProgressCallback=e,this}onFileUploadFinished(e){return this._fileUploadFinishedCallback=e,this}onFileDownloadNext(e){return this._fileDownloadNextCallback=e,this}onFileDownloadProgress(e){return this._fileDownloadProgressCallback=e,this}onFileDownloadFinished(e){return this._fileDownloadFinishedCallback=e,this}_getMessage(e,t,s,i){let n=[];void 0!==i&&(n=[...new Uint8Array(lr.encode(i))]);const r=255&n.length,a=[e,0,n.length>>8,r,t>>8,255&t,this._seq,s,...n];return this._seq=(this._seq+1)%256,a}_notification(e){fr.log("mcumgr - message received");const t=new Uint8Array(e);this._buffer=new Uint8Array([...this._buffer,...t]);const s=256*this._buffer[2]+this._buffer[3];this._buffer.length<s+8||(this._processMessage(this._buffer.slice(0,s+8)),this._buffer=this._buffer.slice(s+8))}_processMessage(e){const[t,,s,i,n,r,,a]=e,o=lr.decode(e.slice(8).buffer),c=256*s+i,h=256*n+r;return fr.log("mcumgr - Process Message - Group: "+h+", Id: "+a+", Off: "+o.off),h===vr&&a===Mr&&o.off?(this._uploadOffset=o.off,void this._uploadNext()):t===mr&&h===wr&&a===Dr&&o.off?(this._uploadFileOffset=o.off,void this._uploadFileNext()):t===ur&&h===wr&&a===Dr?(this._downloadFileOffset+=o.data.length,null!=o.len&&(this._downloadFileLength=o.len),fr.log("downloaded "+this._downloadFileOffset+" bytes of "+this._downloadFileLength),this._downloadFileLength>0&&this._fileDownloadProgressCallback({percentage:Math.floor(this._downloadFileOffset/this._downloadFileLength*100)}),this._messageCallback&&this._messageCallback({op:t,group:h,id:a,data:o,length:c}),void this._downloadFileNext()):void(this._messageCallback&&this._messageCallback({op:t,group:h,id:a,data:o,length:c}))}cmdReset(){return this._getMessage(dr,pr,Er)}smpEcho(e){return this._getMessage(dr,pr,yr,{d:e})}cmdImageState(){return this._getMessage(gr,vr,Cr)}cmdImageErase(){return this._getMessage(dr,vr,kr,{})}cmdImageTest(e){return this._getMessage(dr,vr,Cr,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._getMessage(dr,vr,Cr,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(!this._uploadImage)return;if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-lr.encode(e).byteLength-8-3-5;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t;const s=this._getMessage(dr,vr,Mr,e);fr.log("mcumgr - _uploadNext: Message Length: "+s.length),this._imageUploadNextCallback({packet:s})}async reset(){this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}async cmdUpload(e,t=0){this._uploadIsInProgress?fr.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async cmdUploadFile(e,t){this._uploadIsInProgress?fr.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadFileOffset=0,this._uploadFile=e,this._uploadFilename=t,this._uploadFileNext())}async _uploadFileNext(){if(fr.log("uploadFileNext - offset: "+this._uploadFileOffset+", length: "+this._uploadFile.byteLength),this._uploadFileOffset>=this._uploadFile.byteLength)return this._uploadIsInProgress=!1,void this._fileUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadFileOffset};0===this._uploadFileOffset&&(e.len=this._uploadFile.byteLength),e.name=this._uploadFilename,this._fileUploadProgressCallback({percentage:Math.floor(this._uploadFileOffset/this._uploadFile.byteLength*100)});const t=this._mtu-lr.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadFile.slice(this._uploadFileOffset,this._uploadFileOffset+t)),this._uploadFileOffset+=t;const s=this._getMessage(dr,wr,Dr,e);fr.log("mcumgr - _uploadNext: Message Length: "+s.length),this._fileUploadNextCallback({packet:s})}async cmdDownloadFile(e,t){this._downloadIsInProgress?fr.error("Download is already in progress."):(this._downloadIsInProgress=!0,this._downloadFileOffset=0,this._downloadFileLength=0,this._downloadRemoteFilename=e,this._downloadLocalFilename=t,this._downloadFileNext())}async _downloadFileNext(){if(this._downloadFileLength>0&&this._downloadFileOffset>=this._downloadFileLength)return this._downloadIsInProgress=!1,void this._fileDownloadFinishedCallback();const e={off:this._downloadFileOffset};0===this._downloadFileOffset&&(e.name=this._downloadRemoteFilename);const t=this._getMessage(gr,wr,Dr,e);fr.log("mcumgr - _downloadNext: Message Length: "+t.length),this._fileDownloadNextCallback({packet:t})}async imageInfo(e){const t={},s=new Uint8Array(e);if(s.length<32)throw new Error("Invalid image (too short file)");if(61!==s[0]||184!==s[1]||243!==s[2]||150!==s[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==s[4]||0!==s[5]||0!==s[6]||0!==s[7])throw new Error("Invalid image (wrong load address)");const i=s[8]+256*s[9];if(0!==s[10]||0!==s[11])throw new Error("Invalid image (wrong protected TLV area size)");const n=s[12]+256*s[13]+65536*s[14]+s[15]*2**24;if(t.imageSize=n,s.length<n+i)throw new Error("Invalid image (wrong image size)");if(0!==s[16]||0!==s[17]||0!==s[18]||0!==s[19])throw new Error("Invalid image (wrong flags)");const r=`${s[20]}.${s[21]}.${s[22]+256*s[23]}`;return t.version=r,t.hash=[...new Uint8Array(await this._hash(e.slice(0,n+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}var Tr,Ir,_r,Ur,Lr,Fr,Ar,Rr,xr,$r,Or,Br,Nr,Pr,Vr,zr,jr,Gr,qr,Hr,Jr;const Kr=D("FirmwareManager",{log:!1}),Qr=["smp"],Zr=[...Qr,"firmwareImages","firmwareUploadProgress","firmwareStatus","firmwareUploadComplete"],Xr=["idle","uploading","uploaded","pending","testing","erasing"];class Yr{constructor(){Tr.add(this),_r.set(this,"idle"),Lr.set(this,void 0),Rr.set(this,void 0),xr.set(this,new Wr),e(this,Tr,"m",$r).call(this),J(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}parseMessage(t,s){if(Kr.log({messageType:t}),"smp"!==t)throw Error(`uncaught messageType ${t}`);e(this,xr,"f")._notification(Array.from(new Uint8Array(s.buffer))),e(this,Tr,"a",Ir).call(this,"smp",{dataView:s})}async uploadFirmware(t){Kr.log("uploadFirmware",t);const s=this.waitForEvent("firmwareUploadComplete");await this.getImages();const i=await H(t),n=await e(this,xr,"f").imageInfo(i);Kr.log({imageInfo:n}),e(this,xr,"f").cmdUpload(i,1),e(this,Tr,"m",Ur).call(this,"uploading"),await s}get status(){return e(this,_r,"f")}get images(){return e(this,Lr,"f")}async getImages(){const t=this.waitForEvent("firmwareImages");Kr.log("getting firmware image state..."),this.sendMessage(Uint8Array.from(e(this,xr,"f").cmdImageState()).buffer),await t}async testImage(t=1){if(e(this,Tr,"m",Ar).call(this,t),e(this,Tr,"m",Fr).call(this),!e(this,Lr,"f")[t])return void Kr.log(`image ${t} not found`);if(1==e(this,Lr,"f")[t].pending)return void Kr.log(`image ${t} is already pending`);if(e(this,Lr,"f")[t].empty)return void Kr.log(`image ${t} is empty`);const s=this.waitForEvent("smp");Kr.log("testing firmware image..."),this.sendMessage(Uint8Array.from(e(this,xr,"f").cmdImageTest(e(this,Lr,"f")[t].hash)).buffer),await s}async eraseImage(){e(this,Tr,"m",Fr).call(this);const t=this.waitForEvent("smp");Kr.log("erasing image..."),this.sendMessage(Uint8Array.from(e(this,xr,"f").cmdImageErase()).buffer),e(this,Tr,"m",Ur).call(this,"erasing"),await t,await this.getImages()}async confirmImage(t=0){if(e(this,Tr,"m",Ar).call(this,t),e(this,Tr,"m",Fr).call(this),!0===e(this,Lr,"f")[t].confirmed)return void Kr.log(`image ${t} is already confirmed`);const s=this.waitForEvent("smp");Kr.log("confirming image..."),this.sendMessage(Uint8Array.from(e(this,xr,"f").cmdImageConfirm(e(this,Lr,"f")[t].hash)).buffer),await s}async echo(t){Kr.assertTypeWithError(t,"string");const s=this.waitForEvent("smp");Kr.log("sending echo..."),this.sendMessage(Uint8Array.from(e(this,xr,"f").smpEcho(t)).buffer),await s}async reset(){const t=this.waitForEvent("smp");Kr.log("resetting..."),this.sendMessage(Uint8Array.from(e(this,xr,"f").cmdReset()).buffer),await t}get mtu(){return e(this,Rr,"f")}set mtu(s){t(this,Rr,s,"f"),e(this,xr,"f")._mtu=s}}var ea,ta,sa,ia,na,ra,aa,oa,ca,ha,la,fa,ga,ua,da,ma,pa,va;_r=new WeakMap,Lr=new WeakMap,Rr=new WeakMap,xr=new WeakMap,Tr=new WeakSet,Ir=function(){return this.eventDispatcher.dispatchEvent},Ur=function(s){Kr.assertEnumWithError(s,Xr),e(this,_r,"f")!=s?(t(this,_r,s,"f"),Kr.log({firmwareStatus:e(this,_r,"f")}),e(this,Tr,"a",Ir).call(this,"firmwareStatus",{firmwareStatus:e(this,_r,"f")})):Kr.log(`redundant firmwareStatus assignment "${s}"`)},Fr=function(){Kr.assertWithError(e(this,Lr,"f"),"didn't get imageState")},Ar=function(e){Kr.assertTypeWithError(e,"number"),Kr.assertWithError(0==e||1==e,"imageIndex must be 0 or 1")},$r=function(){e(this,xr,"f").onMessage(e(this,Tr,"m",Or).bind(this)),e(this,xr,"f").onFileDownloadNext(e(this,Tr,"m",Br)),e(this,xr,"f").onFileDownloadProgress(e(this,Tr,"m",Nr).bind(this)),e(this,xr,"f").onFileDownloadFinished(e(this,Tr,"m",Pr).bind(this)),e(this,xr,"f").onFileUploadNext(e(this,Tr,"m",Vr).bind(this)),e(this,xr,"f").onFileUploadProgress(e(this,Tr,"m",zr).bind(this)),e(this,xr,"f").onFileUploadFinished(e(this,Tr,"m",jr).bind(this)),e(this,xr,"f").onImageUploadNext(e(this,Tr,"m",Gr).bind(this)),e(this,xr,"f").onImageUploadProgress(e(this,Tr,"m",qr).bind(this)),e(this,xr,"f").onImageUploadFinished(e(this,Tr,"m",Hr).bind(this))},Or=function({op:t,group:s,id:i,data:n,length:r}){switch(Kr.log("onMcuMessage",...arguments),s){case pr:switch(i){case yr:Kr.log(`echo "${n.r}"`);break;case br:Kr.table(n.tasks);break;case Sr:Kr.log(n)}break;case vr:if(i===Cr)e(this,Tr,"m",Jr).call(this,n);break;default:throw Error(`uncaught mcuMessage group ${s}`)}},Br=function(){Kr.log("onMcuFileDownloadNext",...arguments)},Nr=function(){Kr.log("onMcuFileDownloadProgress",...arguments)},Pr=function(){Kr.log("onMcuFileDownloadFinished",...arguments)},Vr=function(){Kr.log("onMcuFileUploadNext")},zr=function(){Kr.log("onMcuFileUploadProgress")},jr=function(){Kr.log("onMcuFileUploadFinished")},Gr=function({packet:e}){Kr.log("onMcuImageUploadNext"),this.sendMessage(Uint8Array.from(e).buffer)},qr=function({percentage:t}){const s=t/100;Kr.log("onMcuImageUploadProgress",...arguments),e(this,Tr,"a",Ir).call(this,"firmwareUploadProgress",{progress:s})},Hr=async function(){Kr.log("onMcuImageUploadFinished",...arguments),await this.getImages(),e(this,Tr,"a",Ir).call(this,"firmwareUploadProgress",{progress:100}),e(this,Tr,"a",Ir).call(this,"firmwareUploadComplete",{})},Jr=function({images:s}){if(!s)return void Kr.log("no images found");t(this,Lr,s,"f"),Kr.log("images",e(this,Lr,"f"));let i="idle";2==e(this,Lr,"f").length&&(e(this,Lr,"f")[1].bootable?e(this,Lr,"f")[0].confirmed?e(this,Lr,"f")[1].pending?(Kr.log("reset to upload to the new firmware image"),i="pending"):(Kr.log("Slot 1 has a valid image. run testImage() to test it or upload a different image."),i="uploaded"):(Kr.log('Slot 0 has a valid image. Click "Confirm Image" to confirm it or wait and the device will swap images back.'),i="testing"):Kr.warn('Slot 1 has a invalid image. Click "Erase Image" to erase it or upload a different image')),1==e(this,Lr,"f").length&&(e(this,Lr,"f").push({slot:1,empty:!0,version:"Empty",pending:!1,confirmed:!1,bootable:!1,active:!1,permanent:!1}),Kr.log("Select a firmware upload image to upload to slot 1.")),e(this,Tr,"m",Ur).call(this,i),e(this,Tr,"a",Ir).call(this,"firmwareImages",{firmwareImages:e(this,Lr,"f")})};const wa=D("DeviceManager",{log:!0}),ya=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class ba{constructor(){if(ea.add(this),ta.set(this,{getType:e(this,ea,"m",sa).bind(this),isConnected:e(this,ea,"m",ma).bind(this)}),ia.set(this,[]),na.set(this,!1),ra.set(this,{devices:[]}),aa.set(this,void 0),ca.set(this,"BS.Device"),ga.set(this,[]),ua.set(this,new _(this,ya)),ba.shared&&this!=ba.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(t){Un(t,e(this,ta,"f"))}OnDeviceConnectionStatusUpdated(t,s){if("notConnected"==s&&!t.canReconnect&&e(this,ga,"f").includes(t)){const s=e(this,ga,"f").indexOf(t);this.AvailableDevices.splice(s,1),e(this,ea,"m",pa).call(this)}}get ConnectedDevices(){return e(this,ia,"f")}get UseLocalStorage(){return e(this,na,"f")}set UseLocalStorage(s){e(this,ea,"m",oa).call(this),wa.assertTypeWithError(s,"boolean"),t(this,na,s,"f"),e(this,na,"f")&&!e(this,aa,"f")&&e(this,ea,"m",la).call(this)}get CanUseLocalStorage(){return i&&window.localStorage}get AvailableDevices(){return e(this,ga,"f")}get CanGetDevices(){return i&&navigator.bluetooth?.getDevices}async GetDevices(){if(!i)return void wa.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void wa.warn("bluetooth is not available in this browser");if(o)return void wa.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void wa.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void wa.log("CanGetDevices is false");e(this,aa,"f")||e(this,ea,"m",la).call(this);const t=e(this,aa,"f");if(!t.devices||0==t.devices.length)return void wa.log("no devices found in configuration");const s=await navigator.bluetooth.getDevices();return wa.log({bluetoothDevices:s}),s.forEach((s=>{if(!s.gatt)return;let i=t.devices.find((e=>s.id==e.bluetoothId));if(!i)return;let n=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));const r=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));if(r)return void(n&&n?.bluetoothId==r.bluetoothId&&n!=r&&(this.AvailableDevices[e(this,ga,"f").indexOf(r)]=n));if(n)return void this.AvailableDevices.push(n);const a=new Bo,o=new or;o.device=s,s.name&&a._informationManager.updateName(s.name),a._informationManager.updateType(i.type),a.connectionManager=o,this.AvailableDevices.push(a)})),e(this,ea,"m",pa).call(this),this.AvailableDevices}get AddEventListener(){return e(this,ua,"f").addEventListener}get RemoveEventListener(){return e(this,ua,"f").removeEventListener}get RemoveEventListeners(){return e(this,ua,"f").removeEventListeners}get RemoveAllEventListeners(){return e(this,ua,"f").removeAllEventListeners}_CheckDeviceAvailability(t){t.isConnected||t.isAvailable||!e(this,ga,"f").includes(t)||(wa.log("removing device from availableDevices..."),e(this,ga,"f").splice(e(this,ga,"f").indexOf(t),1),e(this,ea,"m",pa).call(this))}}ta=new WeakMap,ia=new WeakMap,na=new WeakMap,ra=new WeakMap,aa=new WeakMap,ca=new WeakMap,ga=new WeakMap,ua=new WeakMap,ea=new WeakSet,sa=function(t){e(this,na,"f")&&e(this,ea,"m",fa).call(this,t.target)},oa=function(){wa.assertWithError(i,"localStorage is only available in the browser"),wa.assertWithError(window.localStorage,"localStorage not found")},ha=function(){e(this,ea,"m",oa).call(this),localStorage.setItem(e(this,ca,"f"),JSON.stringify(e(this,aa,"f")))},la=async function(){e(this,ea,"m",oa).call(this);let s=localStorage.getItem(e(this,ca,"f"));if("string"!=typeof s)return wa.log("no info found in localStorage"),t(this,aa,Object.assign({},e(this,ra,"f")),"f"),void e(this,ea,"m",ha).call(this);try{const e=JSON.parse(s);wa.log({configuration:e}),t(this,aa,e,"f"),this.CanGetDevices&&await this.GetDevices()}catch(e){wa.error(e)}},fa=function(t){if("webBluetooth"!=t.connectionType)return void wa.log("localStorage is only for webBluetooth devices");e(this,ea,"m",oa).call(this);const s=e(this,aa,"f").devices.findIndex((e=>e.bluetoothId==t.bluetoothId));-1!=s&&(e(this,aa,"f").devices[s].type=t.type,e(this,ea,"m",ha).call(this))},da=function(){return e(this,ua,"f").dispatchEvent},ma=function(t){const{target:s}=t;if(s.isConnected)if(e(this,ia,"f").includes(s))wa.log("device already included");else{if(wa.log("adding device",s),e(this,ia,"f").push(s),this.UseLocalStorage&&"webBluetooth"==s.connectionType){const t={type:s.type,bluetoothId:s.bluetoothId,ipAddress:s.ipAddress,isWifiSecure:s.isWifiSecure},i=e(this,aa,"f").devices.findIndex((e=>e.bluetoothId==t.bluetoothId));-1==i?e(this,aa,"f").devices.push(t):e(this,aa,"f").devices[i]=t,e(this,ea,"m",ha).call(this)}e(this,ea,"a",da).call(this,"deviceConnected",{device:s}),e(this,ea,"a",da).call(this,"deviceIsConnected",{device:s}),e(this,ea,"m",va).call(this)}else e(this,ia,"f").includes(s)?(wa.log("removing device",s),e(this,ia,"f").splice(e(this,ia,"f").indexOf(s),1),e(this,ea,"a",da).call(this,"deviceDisconnected",{device:s}),e(this,ea,"a",da).call(this,"deviceIsConnected",{device:s}),e(this,ea,"m",va).call(this)):wa.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),s.isConnected&&!this.AvailableDevices.includes(s)){const t=this.AvailableDevices.find((e=>e.bluetoothId==s.bluetoothId));wa.log({existingAvailableDevice:t}),t?this.AvailableDevices[this.AvailableDevices.indexOf(t)]=s:this.AvailableDevices.push(s),e(this,ea,"m",pa).call(this)}this._CheckDeviceAvailability(s)},pa=function(){wa.log({AvailableDevices:this.AvailableDevices}),e(this,ea,"a",da).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},va=function(){wa.log({ConnectedDevices:this.ConnectedDevices}),e(this,ea,"a",da).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},ba.shared=new ba;var Sa=ba.shared;const Ea=D("ServerUtils",{log:!1}),Ca=["isScanningAvailable","isScanning","startScan","stopScan","discoveredDevice","discoveredDevices","expiredDiscoveredDevice","connectToDevice","disconnectFromDevice","connectedDevices","deviceMessage"];function Ma(e,...t){Ea.log("createMessage",...t);const s=t.map((t=>{"string"==typeof t&&(t={type:t}),null!=t.data?Array.isArray(t.data)||(t.data=[t.data]):t.data=[];const s=j(...t.data),i=s.byteLength;Ea.assertEnumWithError(t.type,e);const n=e.indexOf(t.type),r=new DataView(new ArrayBuffer(2));return r.setUint16(0,i,!0),j(n,r,s)}));return Ea.log("messageBuffers",...s),j(...s)}function ka(...e){return Ea.log("createServerMessage",...e),Ma(Ca,...e)}function Da(...e){return Ea.log("createClientDeviceMessage",...e),Ma(Tn,...e)}ka("isScanningAvailable"),ka("isScanning"),ka("startScan"),ka("stopScan"),ka("discoveredDevices");const Wa=D("WebSocketUtils",{log:!1}),Ta=["ping","pong","serverMessage"];function Ia(...e){return Wa.log("createWebSocketMessage",...e),Ma(Ta,...e)}var _a,Ua,La,Fa,Aa,Ra,xa,$a,Oa,Ba,Na,Pa,Va,za,ja,Ga,qa;Ia("ping"),Ia("pong");const Ha=D("WebSocketConnectionManager",{log:!1}),Ja=["ping","pong","batteryLevel","deviceInformation","message"];const Ka=["deviceInformation","batteryLevel"];class Qa extends In{get bluetoothId(){return""}constructor(t,s=!1){super(),_a.add(this),this.defaultMtu=1024,Ua.set(this,void 0),La.set(this,void 0),Fa.set(this,!1),xa.set(this,{open:e(this,_a,"m",$a).bind(this),message:e(this,_a,"m",Oa).bind(this),close:e(this,_a,"m",Ba).bind(this),error:e(this,_a,"m",Na).bind(this)}),za.set(this,new R(e(this,_a,"m",ja).bind(this),29e3)),this.ipAddress=t,this.isSecure=s,this.mtu=this.defaultMtu}get isAvailable(){return!0}static get isSupported(){return!0}static get type(){return"webSocket"}get webSocket(){return e(this,Ua,"f")}set webSocket(s){e(this,Ua,"f")!=s?(Ha.log("assigning webSocket",s),e(this,Ua,"f")&&(Ln(e(this,Ua,"f"),e(this,xa,"f")),e(this,Ua,"f").readyState==e(this,Ua,"f").OPEN&&e(this,Ua,"f").close()),Un(s,e(this,xa,"f")),t(this,Ua,s,"f"),Ha.log("assigned webSocket")):Ha.log("redundant webSocket assignment")}get ipAddress(){return e(this,La,"f")}set ipAddress(s){this.assertIsNotConnected(),e(this,La,"f")!=s?(t(this,La,s,"f"),Ha.log(`updated ipAddress to "${this.ipAddress}"`)):Ha.log(`redundnant ipAddress assignment "${s}"`)}get isSecure(){return e(this,Fa,"f")}set isSecure(s){this.assertIsNotConnected(),e(this,Fa,"f")!=s?(t(this,Fa,s,"f"),Ha.log(`updated isSecure to "${this.isSecure}"`)):Ha.log(`redundant isSecure assignment ${s}`)}get url(){return`${this.isSecure?"wss":"ws"}://${this.ipAddress}/ws`}async connect(){await super.connect(),this.webSocket=new WebSocket(this.url)}async disconnect(){await super.disconnect(),e(this,Ua,"f")?.close()}get canReconnect(){return!0}async reconnect(){await super.reconnect(),this.webSocket=new WebSocket(this.url)}async sendSmpMessage(e){super.sendSmpMessage(e),Ha.error("smp not supported on webSockets")}async sendTxData(t){super.sendTxData(t),0!=t.byteLength&&e(this,_a,"m",Ra).call(this,{type:"message",data:t})}}var Za,Xa,Ya,eo,to,so,io,no,ro,ao,oo,co,ho,lo,fo,go,uo,mo,po,vo,wo,yo,bo,So,Eo,Co,Mo,ko,Do,Wo,To,Io,_o,Uo,Lo,Fo,Ao,Ro;Ua=new WeakMap,La=new WeakMap,Fa=new WeakMap,xa=new WeakMap,za=new WeakMap,_a=new WeakSet,Aa=function(t){this.assertIsConnected(),e(this,Ua,"f").send(t),e(this,za,"f").restart()},Ra=function(...t){e(this,_a,"m",Aa).call(this,function(...e){return Ha.log("createWebSocketMessage",...e),Ma(Ja,...e)}(...t))},$a=function(t){Ha.log("webSocket.open",t),e(this,za,"f").start(),this.status="connected",e(this,_a,"m",qa).call(this)},Oa=async function(t){Ha.log("webSocket.message",t);const s=await t.data.arrayBuffer(),i=new DataView(s);e(this,_a,"m",Pa).call(this,i)},Ba=function(t){Ha.log("webSocket.close",t),this.status="notConnected",e(this,za,"f").stop()},Na=function(e){Ha.error("webSocket.error",e)},Pa=function(t){yt(t,Ja,e(this,_a,"m",Va).bind(this),null,!0)},Va=function(t,s){switch(Ha.log(`received "${t}" message (${s.byteLength} bytes)`),t){case"ping":e(this,_a,"m",Ga).call(this);break;case"pong":break;case"batteryLevel":this.onMessageReceived?.("batteryLevel",s);break;case"deviceInformation":yt(s,As,((e,t)=>{this.onMessageReceived(e,t)})),this.onMessagesReceived();break;case"message":this.parseRxMessage(s);break;default:Ha.error(`uncaught messageType "${t}"`)}},ja=function(){Ha.log("pinging"),e(this,_a,"m",Ra).call(this,"ping")},Ga=function(){Ha.log("ponging"),e(this,_a,"m",Ra).call(this,"pong")},qa=function(){e(this,_a,"m",Ra).call(this,...Ka)};const xo=D("Device",{log:!1}),$o=["connectionMessage",...Mn,...Wn,...Dn,...oi,...Rs,...jt,...kt,...Ne,...Ms,...cn,...Zr],Oo=["isCharging","getBatteryCurrent","getId","getMtu","getName","getType","getCurrentTime","getSensorConfiguration","getSensorScalars","getPressurePositions","maxFileLength","getFileLength","getFileChecksum","getFileType","fileTransferStatus","getTfliteName","getTfliteTask","getTfliteSampleRate","getTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","getTfliteThreshold","getTfliteInferencingEnabled","isWifiAvailable"];class Bo{get bluetoothId(){return e(this,so,"f")?.bluetoothId}get isAvailable(){return e(this,so,"f")?.isAvailable}constructor(){Za.add(this),eo.set(this,new _(this,$o)),so.set(this,void 0),this.sendTxMessages=e(this,Za,"m",io).bind(this),no.set(this,!1),fo.set(this,Xa.ReconnectOnDisconnection),go.set(this,void 0),this.latestConnectionMessages=new Map,So.set(this,new xs),Eo.set(this,0),this._informationManager=new ci,Mo.set(this,new Gt),Do.set(this,Xa.ClearSensorConfigurationOnLeave),Wo.set(this,new Dt),To.set(this,new Ri),Io.set(this,new Pe),_o.set(this,new Ws),Uo.set(this,new Yr),this.sendSmpMessage=e(this,Za,"m",Fo).bind(this),Ao.set(this,!1),Ro.set(this,new hn),e(this,So,"f").eventDispatcher=e(this,eo,"f"),this._informationManager.sendMessage=this.sendTxMessages,this._informationManager.eventDispatcher=e(this,eo,"f"),e(this,Mo,"f").sendMessage=this.sendTxMessages,e(this,Mo,"f").eventDispatcher=e(this,eo,"f"),e(this,Wo,"f").eventDispatcher=e(this,eo,"f"),e(this,To,"f").sendMessage=this.sendTxMessages,e(this,_o,"f").sendMessage=this.sendTxMessages,e(this,_o,"f").eventDispatcher=e(this,eo,"f"),e(this,Io,"f").sendMessage=this.sendTxMessages,e(this,Io,"f").eventDispatcher=e(this,eo,"f"),e(this,Ro,"f").sendMessage=this.sendTxMessages,e(this,Ro,"f").eventDispatcher=e(this,eo,"f"),e(this,Uo,"f").sendMessage=this.sendSmpMessage,e(this,Uo,"f").eventDispatcher=e(this,eo,"f"),this.addEventListener("getMtu",(()=>{e(this,Uo,"f").mtu=this.mtu,e(this,Io,"f").mtu=this.mtu,this.connectionManager.mtu=this.mtu})),Sa.onDevice(this),i&&window.addEventListener("beforeunload",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()})),n&&process.on("exit",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()}))}get addEventListener(){return e(this,eo,"f").addEventListener}get removeEventListener(){return e(this,eo,"f").removeEventListener}get waitForEvent(){return e(this,eo,"f").waitForEvent}get removeEventListeners(){return e(this,eo,"f").removeEventListeners}get removeAllEventListeners(){return e(this,eo,"f").removeAllEventListeners}get connectionManager(){return e(this,so,"f")}set connectionManager(s){this.connectionManager!=s?(this.connectionManager&&(this.connectionManager.onStatusUpdated=void 0,this.connectionManager.onMessageReceived=void 0,this.connectionManager.onMessagesReceived=void 0),s&&(s.onStatusUpdated=e(this,Za,"m",uo).bind(this),s.onMessageReceived=e(this,Za,"m",yo).bind(this),s.onMessagesReceived=e(this,Za,"m",bo).bind(this)),t(this,so,s,"f"),xo.log("assigned new connectionManager",e(this,so,"f")),this._informationManager.connectionType=this.connectionType):xo.log("same connectionManager is already assigned")}async connect(t){if(t)switch(xo.log("connect options",t),t.type){case"webBluetooth":this.connectionManager=new or;break;case"webSocket":this.connectionManager=new Qa(t.ipAddress,t.isSecure)}return this.connectionManager||(this.connectionManager=e(Xa,Xa,"m",Ya).call(Xa)),e(this,Za,"m",vo).call(this),this.connectionManager.connect()}get isConnected(){return e(this,no,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return e(this,Za,"m",ho).call(this),e(this,Za,"m",vo).call(this),this.connectionManager?.reconnect()}static async Connect(){const e=new Xa;return await e.connect(),e}static get ReconnectOnDisconnection(){return e(this,Xa,"f",lo)}static set ReconnectOnDisconnection(e){xo.assertTypeWithError(e,"boolean"),t(this,Xa,e,"f",lo)}get reconnectOnDisconnection(){return e(this,fo,"f")}set reconnectOnDisconnection(e){xo.assertTypeWithError(e,"boolean"),t(this,fo,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return e(this,Za,"m",ro).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){this.isConnected?this.disconnect():this.canReconnect?this.reconnect():this.connect()}get connectionStatus(){switch(e(this,so,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return e(this,so,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return e(this,So,"f").information}get batteryLevel(){return e(this,Eo,"f")}get id(){return this._informationManager.id}get isCharging(){return this._informationManager.isCharging}get batteryCurrent(){return this._informationManager.batteryCurrent}get getBatteryCurrent(){return this._informationManager.getBatteryCurrent}get name(){return this._informationManager.name}get setName(){return this._informationManager.setName}get type(){return this._informationManager.type}get setType(){return this._informationManager.setType}get isInsole(){return this._informationManager.isInsole}get isGlove(){return this._informationManager.isGlove}get side(){return this._informationManager.side}get mtu(){return this._informationManager.mtu}get sensorTypes(){return Object.keys(this.sensorConfiguration)}get continuousSensorTypes(){return Ct.filter((e=>this.sensorTypes.includes(e)))}get sensorConfiguration(){return e(this,Mo,"f").configuration}async setSensorConfiguration(t,s){await e(this,Mo,"f").setConfiguration(t,s)}async clearSensorConfiguration(){return e(this,Mo,"f").clearSensorConfiguration()}static get ClearSensorConfigurationOnLeave(){return e(this,Xa,"f",ko)}static set ClearSensorConfigurationOnLeave(e){xo.assertTypeWithError(e,"boolean"),t(this,Xa,e,"f",ko)}get clearSensorConfigurationOnLeave(){return e(this,Do,"f")}set clearSensorConfigurationOnLeave(e){xo.assertTypeWithError(e,"boolean"),t(this,Do,e,"f")}get numberOfPressureSensors(){return e(this,Wo,"f").pressureSensorDataManager.numberOfSensors}resetPressureRange(){e(this,Wo,"f").pressureSensorDataManager.resetRange()}async triggerVibration(t,s){e(this,To,"f").triggerVibration(t,s)}get maxFileLength(){return e(this,Io,"f").maxLength}get validFileTypes(){return xe.filter((e=>!(e.includes("wifi")&&!this.isWifiAvailable)))}async sendFile(t,s){xo.assertWithError(this.validFileTypes.includes(t),`invalid fileType ${t}`);const i=this.waitForEvent("fileTransferComplete");e(this,Io,"f").send(t,s),await i}async receiveFile(t){const s=this.waitForEvent("fileTransferComplete");e(this,Io,"f").receive(t),await s}get fileTransferStatus(){return e(this,Io,"f").status}cancelFileTransfer(){e(this,Io,"f").cancel()}get tfliteName(){return e(this,_o,"f").name}get setTfliteName(){return e(this,_o,"f").setName}get tfliteTask(){return e(this,_o,"f").task}get setTfliteTask(){return e(this,_o,"f").setTask}get tfliteSampleRate(){return e(this,_o,"f").sampleRate}get setTfliteSampleRate(){return e(this,_o,"f").setSampleRate}get tfliteSensorTypes(){return e(this,_o,"f").sensorTypes}get allowedTfliteSensorTypes(){return this.sensorTypes.filter((e=>Ds.includes(e)))}get setTfliteSensorTypes(){return e(this,_o,"f").setSensorTypes}get tfliteIsReady(){return e(this,_o,"f").isReady}get tfliteInferencingEnabled(){return e(this,_o,"f").inferencingEnabled}get setTfliteInferencingEnabled(){return e(this,_o,"f").setInferencingEnabled}async enableTfliteInferencing(){return this.setTfliteInferencingEnabled(!0)}async disableTfliteInferencing(){return this.setTfliteInferencingEnabled(!1)}get toggleTfliteInferencing(){return e(this,_o,"f").toggleInferencingEnabled}get tfliteCaptureDelay(){return e(this,_o,"f").captureDelay}get setTfliteCaptureDelay(){return e(this,_o,"f").setCaptureDelay}get tfliteThreshold(){return e(this,_o,"f").threshold}get setTfliteThreshold(){return e(this,_o,"f").setThreshold}get canUpdateFirmware(){return e(this,so,"f")?.canUpdateFirmware}get uploadFirmware(){return e(this,Za,"m",Lo).call(this),e(this,Uo,"f").uploadFirmware}get canReset(){return this.canUpdateFirmware}async reset(){return xo.assertWithError(this.canReset,"reset is not enabled for this device"),await e(this,Uo,"f").reset(),e(this,so,"f").disconnect()}get firmwareStatus(){return e(this,Uo,"f").status}get getFirmwareImages(){return e(this,Za,"m",Lo).call(this),e(this,Uo,"f").getImages}get firmwareImages(){return e(this,Uo,"f").images}get eraseFirmwareImage(){return e(this,Za,"m",Lo).call(this),e(this,Uo,"f").eraseImage}get confirmFirmwareImage(){return e(this,Za,"m",Lo).call(this),e(this,Uo,"f").confirmImage}get testFirmwareImage(){return e(this,Za,"m",Lo).call(this),e(this,Uo,"f").testImage}get isServerSide(){return e(this,Ao,"f")}set isServerSide(s){e(this,Ao,"f")!=s?(xo.log({newIsServerSide:s}),t(this,Ao,s,"f"),e(this,Io,"f").isServerSide=this.isServerSide):xo.log("redundant isServerSide assignment")}get isUkaton(){return this.deviceInformation.modelNumber.includes("Ukaton")}get isWifiAvailable(){return e(this,Ro,"f").isWifiAvailable}get wifiSSID(){return e(this,Ro,"f").wifiSSID}async setWifiSSID(t){return e(this,Ro,"f").setWifiSSID(t)}get wifiPassword(){return e(this,Ro,"f").wifiPassword}async setWifiPassword(t){return e(this,Ro,"f").setWifiPassword(t)}get isWifiConnected(){return e(this,Ro,"f").isWifiConnected}get ipAddress(){return e(this,Ro,"f").ipAddress}get wifiConnectionEnabled(){return e(this,Ro,"f").wifiConnectionEnabled}get enableWifiConnection(){return e(this,Ro,"f").enableWifiConnection}get setWifiConnectionEnabled(){return e(this,Ro,"f").setWifiConnectionEnabled}get disableWifiConnection(){return e(this,Ro,"f").disableWifiConnection}get toggleWifiConnection(){return e(this,Ro,"f").toggleWifiConnection}get isWifiSecure(){return e(this,Ro,"f").isWifiSecure}async reconnectViaWebSockets(){xo.assertWithError(this.isWifiConnected,"wifi is not connected"),xo.assertWithError("webSocket"!=this.connectionType,"already connected via webSockets"),xo.log("reconnecting via websockets..."),await this.disconnect(),await this.connect({type:"webSocket",ipAddress:this.ipAddress,isSecure:this.isWifiSecure})}}var No,Po,Vo,zo,jo,Go;Xa=Bo,eo=new WeakMap,so=new WeakMap,no=new WeakMap,fo=new WeakMap,go=new WeakMap,So=new WeakMap,Eo=new WeakMap,Mo=new WeakMap,Do=new WeakMap,Wo=new WeakMap,To=new WeakMap,Io=new WeakMap,_o=new WeakMap,Uo=new WeakMap,Ao=new WeakMap,Ro=new WeakMap,Za=new WeakSet,Ya=function(){return new or},to=function(){return e(this,eo,"f").dispatchEvent},io=async function(t,s){await(e(this,so,"f")?.sendTxMessages(t,s))},ro=function(){xo.assertWithError(this.isConnected,"notConnected")},ao=function(e){return e.every((e=>{const t=this.latestConnectionMessages.has(e);return t||xo.log(`didn't receive "${e}" message`),t}))},oo=function(){let t=e(this,Za,"m",ao).call(this,Oo);return t&&this.isWifiAvailable&&(t=e(this,Za,"m",ao).call(this,on)),t},co=function(){xo.log("requesting required information");const t=Oo.map((e=>({type:e})));e(this,Za,"m",io).call(this,t)},ho=function(){xo.assertWithError(this.canReconnect,"cannot reconnect to device")},uo=function(s){xo.log({connectionStatus:s}),"notConnected"==s?(e(this,Za,"m",wo).call(this),this.canReconnect&&this.reconnectOnDisconnection&&(xo.log("starting reconnect interval..."),t(this,go,setInterval((()=>{xo.log("attempting reconnect..."),this.reconnect()}),1e3),"f"))):null!=e(this,go,"f")&&(xo.log("clearing reconnect interval"),clearInterval(e(this,go,"f")),t(this,go,void 0,"f")),e(this,Za,"m",po).call(this),"connected"!=s||e(this,no,"f")||e(this,Za,"m",co).call(this),Sa.OnDeviceConnectionStatusUpdated(this,s)},mo=function(t=!1){e(this,Za,"a",to).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),e(this,Za,"a",to).call(this,this.connectionStatus,{}),t&&e(this,Za,"a",to).call(this,"isConnected",{isConnected:this.isConnected})},po=function(){switch(t(this,no,Boolean(this.connectionManager?.isConnected)&&e(this,Za,"a",oo)&&this._informationManager.isCurrentTimeSet,"f"),this.connectionStatus){case"connected":e(this,no,"f")&&e(this,Za,"m",mo).call(this,!0);break;case"notConnected":e(this,Za,"m",mo).call(this,!0);break;default:e(this,Za,"m",mo).call(this,!1)}},vo=function(){e(this,Za,"m",wo).call(this),this._informationManager.clear(),e(this,So,"f").clear(),e(this,Ro,"f").clear()},wo=function(){this.connectionManager?.clear(),this.latestConnectionMessages.clear()},yo=function(t,s){if(xo.log({messageType:t,dataView:s}),"batteryLevel"===t){const t=s.getUint8(0);xo.log("received battery level",{batteryLevel:t}),e(this,Za,"m",Co).call(this,t)}else if(Re.includes(t))e(this,Io,"f").parseMessage(t,s);else if(Cs.includes(t))e(this,_o,"f").parseMessage(t,s);else if(Mt.includes(t))e(this,Wo,"f").parseMessage(t,s);else if(Qr.includes(t))e(this,Uo,"f").parseMessage(t,s);else if(As.includes(t))e(this,So,"f").parseMessage(t,s);else if(ai.includes(t))this._informationManager.parseMessage(t,s);else if(zt.includes(t))e(this,Mo,"f").parseMessage(t,s);else{if(!an.includes(t))throw Error(`uncaught messageType ${t}`);e(this,Ro,"f").parseMessage(t,s)}this.latestConnectionMessages.set(t,s),e(this,Za,"a",to).call(this,"connectionMessage",{messageType:t,dataView:s})},bo=function(){!this.isConnected&&e(this,Za,"a",oo)&&e(this,Za,"m",po).call(this),"notConnected"!=this.connectionStatus&&e(this,Za,"m",io).call(this)},Co=function(s){xo.assertTypeWithError(s,"number"),e(this,Eo,"f")!=s?(t(this,Eo,s,"f"),xo.log({updatedBatteryLevel:e(this,Eo,"f")}),e(this,Za,"a",to).call(this,"batteryLevel",{batteryLevel:e(this,Eo,"f")})):xo.log(`duplicate batteryLevel assignment ${s}`)},Lo=function(){xo.assertWithError(this.canUpdateFirmware,"can't update firmware")},Fo=function(t){return e(this,Za,"m",Lo).call(this),e(this,so,"f").sendSmpMessage(t)},lo={value:!1},ko={value:!0};const qo=D("DevicePairPressureSensorDataManager",{log:!1});class Ho{constructor(){No.add(this),Po.set(this,{}),Vo.set(this,new tt),zo.set(this,new Ke),this.resetPressureRange()}resetPressureRange(){e(this,Vo,"f").reset(),e(this,zo,"f").reset()}onDevicePressureData(t){const{pressure:s}=t.message,{side:i}=t.target;if(qo.log({pressure:s,side:i}),e(this,Po,"f")[i]=s,e(this,No,"a",jo))return e(this,No,"m",Go).call(this);qo.log("doesn't have all pressure data yet...")}}var Jo;Po=new WeakMap,Vo=new WeakMap,zo=new WeakMap,No=new WeakSet,jo=function(){return ii.every((t=>t in e(this,Po,"f")))},Go=function(){const t={scaledSum:0,normalizedSum:0,sensors:{left:[],right:[]}};return ii.forEach((s=>{const i=e(this,Po,"f")[s];t.scaledSum+=i.scaledSum})),t.normalizedSum+=e(this,zo,"f").updateAndGetNormalization(t.scaledSum,!1),t.scaledSum>0&&(t.center={x:0,y:0},ii.forEach((s=>{e(this,Po,"f")[s].sensors.forEach((e=>{const i={...e};i.weightedValue=e.scaledValue/t.scaledSum;let{x:n,y:r}=e.position;n/=2,"right"==s&&(n+=.5),i.position={x:n,y:r},t.center.x+=i.position.x*i.weightedValue,t.center.y+=i.position.y*i.weightedValue,t.sensors[s].push(i)}))})),t.normalizedCenter=e(this,Vo,"f").updateAndGetNormalization(t.center,!1)),qo.log({devicePairPressure:t}),t};const Ko=D("DevicePairSensorDataManager",{log:!1}),Qo=["pressure","sensorData"];class Zo{constructor(){Jo.set(this,{}),this.pressureSensorDataManager=new Ho}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}resetPressureRange(){this.pressureSensorDataManager.resetPressureRange()}onDeviceSensorData(t){const{timestamp:s,sensorType:i}=t.message;let n;if(Ko.log({sensorType:i,timestamp:s,event:t}),e(this,Jo,"f")[i]||(e(this,Jo,"f")[i]={}),e(this,Jo,"f")[i][t.target.side]=s,"pressure"===i)n=this.pressureSensorDataManager.onDevicePressureData(t);else Ko.log(`uncaught sensorType "${i}"`);if(n){const t=Object.assign({},e(this,Jo,"f")[i]);this.dispatchEvent(i,{sensorType:i,timestamps:t,[i]:n}),this.dispatchEvent("sensorData",{sensorType:i,timestamps:t,[i]:n})}else Ko.log("no value received")}}var Xo,Yo,ec,tc,sc,ic,nc,rc,ac,oc,cc,hc,lc,fc,gc,uc,dc,mc,pc;Jo=new WeakMap;const vc=D("DevicePair",{log:!1});function wc(e){return`device${t=e,t[0].toUpperCase()+t.slice(1)}`;var t}const yc=["isConnected",...Qo,...$o.map((e=>wc(e)))],bc=["insoles","gloves"];class Sc{constructor(s){Xo.add(this),ec.set(this,void 0),tc.set(this,new _(this,yc)),ic.set(this,void 0),nc.set(this,void 0),hc.set(this,{isConnected:e(this,Xo,"m",fc).bind(this),sensorData:e(this,Xo,"m",dc).bind(this),getType:e(this,Xo,"m",gc).bind(this)}),uc.set(this,new Zo),t(this,ec,s,"f"),e(this,uc,"f").eventDispatcher=e(this,tc,"f")}get sides(){return ii}get type(){return e(this,ec,"f")}get addEventListener(){return e(this,tc,"f").addEventListener}get removeEventListener(){return e(this,tc,"f").removeEventListener}get waitForEvent(){return e(this,tc,"f").waitForEvent}get removeEventListeners(){return e(this,tc,"f").removeEventListeners}get removeAllEventListeners(){return e(this,tc,"f").removeAllEventListeners}get left(){return e(this,ic,"f")}get right(){return e(this,nc,"f")}get isConnected(){return ii.every((e=>this[e]?.isConnected))}get isPartiallyConnected(){return ii.some((e=>this[e]?.isConnected))}get isHalfConnected(){return this.isPartiallyConnected&&!this.isConnected}assignDevice(s){if(!e(this,Xo,"m",rc).call(this,s))return void vc.log(`device is incorrect type ${s.type} for ${this.type} devicePair`);const i=s.side,n=this[i];if(s!=n){switch(n&&e(this,Xo,"m",oc).call(this,n),e(this,Xo,"m",ac).call(this,s),i){case"left":t(this,ic,s,"f");break;case"right":t(this,nc,s,"f")}return vc.log(`assigned ${i} ${this.type} device`,s),this.resetPressureRange(),e(this,Xo,"a",sc).call(this,"isConnected",{isConnected:this.isConnected}),e(this,Xo,"a",sc).call(this,"deviceIsConnected",{device:s,isConnected:s.isConnected,side:i}),n}vc.log("device already assigned")}async setSensorConfiguration(e){for(let t=0;t<ii.length;t++){const s=ii[t];this[s]?.isConnected&&await this[s].setSensorConfiguration(e)}}resetPressureRange(){ii.forEach((e=>this[e]?.resetPressureRange())),e(this,uc,"f").resetPressureRange()}async triggerVibration(e,t){const s=ii.map((s=>this[s]?.triggerVibration(e,t))).filter(Boolean);return Promise.allSettled(s)}static get insoles(){return e(this,Yo,"f",mc)}static get gloves(){return e(this,Yo,"f",pc)}}var Ec,Cc,Mc,kc,Dc;Yo=Sc,ec=new WeakMap,tc=new WeakMap,ic=new WeakMap,nc=new WeakMap,hc=new WeakMap,uc=new WeakMap,Xo=new WeakSet,sc=function(){return e(this,tc,"f").dispatchEvent},rc=function(e){switch(this.type){case"insoles":return e.isInsole;case"gloves":return e.isGlove}},ac=function(t){Un(t,e(this,hc,"f")),$o.forEach((s=>{t.addEventListener(s,e(this,Xo,"m",lc).bind(this))}))},oc=function(t){Ln(t,e(this,hc,"f")),$o.forEach((s=>{t.removeEventListener(s,e(this,Xo,"m",lc).bind(this))}))},cc=function(s){const i=ii.some((i=>{if(this[i]!=s)return!1;switch(vc.log(`removing ${i} ${this.type} device`,s),Ln(s,e(this,hc,"f")),i){case"left":t(this,ic,void 0,"f");break;case"right":t(this,nc,void 0,"f")}return!0}));return i&&e(this,Xo,"a",sc).call(this,"isConnected",{isConnected:this.isConnected}),i},lc=function(t){const{type:s,target:i,message:n}=t;e(this,Xo,"a",sc).call(this,wc(s),{...n,device:i,side:i.side})},fc=function(t){e(this,Xo,"a",sc).call(this,"isConnected",{isConnected:this.isConnected})},gc=function(t){const{target:s}=t;if(this[s.side]==s)return;e(this,Xo,"m",cc).call(this,s)&&this.assignDevice(s)},dc=function(t){this.isConnected&&e(this,uc,"f").onDeviceSensorData(t)},mc={value:new Yo("insoles")},pc={value:new Yo("gloves")},Sa.AddEventListener("deviceConnected",(t=>{const{device:s}=t.message;s.isInsole&&e(Yo,Yo,"f",mc).assignDevice(s),s.isGlove&&e(Yo,Yo,"f",pc).assignDevice(s)}));const Wc=D("ClientConnectionManager",{log:!1}),Tc=[...As,"batteryLevel"];class Ic extends In{constructor(){super(...arguments),Ec.add(this),Cc.set(this,void 0),Mc.set(this,!1)}static get isSupported(){return i}static get type(){return"client"}get canUpdateFirmware(){return!1}get bluetoothId(){return e(this,Cc,"f")}set bluetoothId(s){Wc.assertTypeWithError(s,"string"),e(this,Cc,"f")!=s?t(this,Cc,s,"f"):Wc.log("redundant bluetoothId assignment")}get isConnected(){return e(this,Mc,"f")}set isConnected(s){Wc.assertTypeWithError(s,"boolean"),e(this,Mc,"f")!=s?(t(this,Mc,s,"f"),this.status=e(this,Mc,"f")?"connected":"notConnected",this.isConnected&&e(this,Ec,"m",kc).call(this)):Wc.log("redundant newIsConnected assignment",s)}get isAvailable(){return this.client.isConnected}async connect(){await super.connect(),this.sendClientConnectMessage()}async disconnect(){await super.disconnect(),this.sendClientDisconnectMessage()}get canReconnect(){return!0}async reconnect(){await super.reconnect(),this.connect()}async sendSmpMessage(e){super.sendSmpMessage(e),this.sendClientMessage({type:"smp",data:e})}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&this.sendClientMessage({type:"tx",data:e})}onClientMessage(t){Wc.log({dataView:t}),yt(t,$o,e(this,Ec,"m",Dc).bind(this),null,!0),this.onMessagesReceived()}}var _c,Uc,Lc,Fc,Ac,Rc,xc,$c,Oc,Bc,Nc,Pc,Vc,zc,jc,Gc,qc,Hc,Jc,Kc,Qc,Zc,Xc,Yc;Cc=new WeakMap,Mc=new WeakMap,Ec=new WeakSet,kc=function(){this.sendClientMessage(...Tc)},Dc=function(e,t){let s=0;switch(Wc.log({messageType:e},t),e){case"isConnected":const i=Boolean(t.getUint8(s++));Wc.log({isConnected:i}),this.isConnected=i;break;case"rx":this.parseRxMessage(t);break;default:this.onMessageReceived(e,t)}};const eh=D("BaseClient",{log:!1}),th=["notConnected","connecting","connected","disconnecting","connectionStatus","isConnected","isScanningAvailable","isScanning","discoveredDevice","expiredDiscoveredDevice"];class sh{constructor(){_c.add(this),Fc.set(this,{}),Ac.set(this,new _(this,th)),this._reconnectOnDisconnection=this.baseConstructor.ReconnectOnDisconnection,Rc.set(this,"notConnected"),Oc.set(this,[]),Pc.set(this,!1),Gc.set(this,!1),Zc.set(this,{})}get baseConstructor(){return this.constructor}get devices(){return e(this,Fc,"f")}get addEventListener(){return e(this,Ac,"f").addEventListener}get dispatchEvent(){return e(this,Ac,"f").dispatchEvent}get removeEventListener(){return e(this,Ac,"f").removeEventListener}get waitForEvent(){return e(this,Ac,"f").waitForEvent}assertConnection(){eh.assertWithError(this.isConnected,"notConnected")}assertDisconnection(){eh.assertWithError(this.isDisconnected,"not disconnected")}static get ReconnectOnDisconnection(){return this._reconnectOnDisconnection}static set ReconnectOnDisconnection(e){eh.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get reconnectOnDisconnection(){return this._reconnectOnDisconnection}set reconnectOnDisconnection(e){eh.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get _connectionStatus(){return e(this,Rc,"f")}set _connectionStatus(s){switch(eh.assertTypeWithError(s,"string"),eh.log({newConnectionStatus:s}),t(this,Rc,s,"f"),this.dispatchEvent("connectionStatus",{connectionStatus:this.connectionStatus}),this.dispatchEvent(this.connectionStatus,{}),s){case"connected":case"notConnected":this.dispatchEvent("isConnected",{isConnected:this.isConnected}),this.isConnected||e(this,_c,"m",Lc).call(this)}}get connectionStatus(){return this._connectionStatus}_sendRequiredMessages(){eh.log("sending required messages",e(this,Oc,"f")),this.sendServerMessage(...e(this,_c,"a",$c))}parseMessage(t){eh.log("parseMessage",{dataView:t}),yt(t,Ca,e(this,_c,"m",Nc).bind(this),null,!0),e(this,_c,"m",Bc).call(this)}get isScanningAvailable(){return e(this,_c,"a",Vc)}requestIsScanningAvailable(){this.sendServerMessage("isScanningAvailable")}get isScanning(){return e(this,_c,"a",qc)}startScan(){e(this,_c,"m",Qc).call(this),this.sendServerMessage("startScan")}stopScan(){e(this,_c,"m",Kc).call(this),this.sendServerMessage("stopScan")}toggleScan(){e(this,_c,"m",jc).call(this),this.isScanning?this.stopScan():this.startScan()}get discoveredDevices(){return e(this,Zc,"f")}onDiscoveredDevice(t){eh.log({discoveredDevice:t}),e(this,Zc,"f")[t.bluetoothId]=t,this.dispatchEvent("discoveredDevice",{discoveredDevice:t})}requestDiscoveredDevices(){this.sendServerMessage({type:"discoveredDevices"})}connectToDevice(e){return this.requestConnectionToDevice(e)}requestConnectionToDevice(t){this.assertConnection(),eh.assertTypeWithError(t,"string");const s=e(this,_c,"m",Yc).call(this,t);return s.connect(),s}sendConnectToDeviceMessage(e){this.sendServerMessage({type:"connectToDevice",data:e})}createDevice(e){const t=new Bo,s=new Ic;return s.client=this,s.bluetoothId=e,s.sendClientMessage=this.sendDeviceMessage.bind(this,e),s.sendClientConnectMessage=this.sendConnectToDeviceMessage.bind(this,e),s.sendClientDisconnectMessage=this.sendDisconnectFromDeviceMessage.bind(this,e),t.connectionManager=s,t}onConnectedBluetoothDeviceIds(t){eh.log({bluetoothIds:t}),t.forEach((t=>{const s=e(this,_c,"m",Yc).call(this,t);s.connectionManager.isConnected=!0,Sa._CheckDeviceAvailability(s)}))}disconnectFromDevice(e){this.requestDisconnectionFromDevice(e)}requestDisconnectionFromDevice(e){this.assertConnection(),eh.assertTypeWithError(e,"string");const t=this.devices[e];return eh.assertWithError(t,`no device found with id ${e}`),t.disconnect(),t}sendDisconnectFromDeviceMessage(e){this.sendServerMessage({type:"disconnectFromDevice",data:e})}sendDeviceMessage(e,...t){this.sendServerMessage({type:"deviceMessage",data:[e,Da(...t)]})}}var ih,nh,rh,ah,oh,ch,hh,lh,fh,gh,uh,dh,mh;Uc=sh,Fc=new WeakMap,Ac=new WeakMap,Rc=new WeakMap,Oc=new WeakMap,Pc=new WeakMap,Gc=new WeakMap,Zc=new WeakMap,_c=new WeakSet,Lc=function(){t(this,_c,!1,"a",zc),t(this,_c,!1,"a",Hc);for(const t in e(this,Fc,"f")){e(this,Fc,"f")[t].connectionManager.isConnected=!1}e(this,Oc,"f").length=0},$c=function(){return e(Uc,Uc,"f",xc)},Bc=function(){"connecting"==this.connectionStatus&&(eh.log("checking if fully connected..."),e(this,Oc,"f").includes("isScanningAvailable")?!this.isScanningAvailable||e(this,Oc,"f").includes("isScanning")?(eh.log("fully connected"),this._connectionStatus="connected"):eh.log("not fully connected - didn't receive isScanning"):eh.log("not fully connected - didn't receive isScanningAvailable"))},Nc=function(s,i){let n=0;switch(eh.log({messageType:s},i),s){case"isScanningAvailable":{const e=Boolean(i.getUint8(n++));eh.log({isScanningAvailable:e}),t(this,_c,e,"a",zc)}break;case"isScanning":{const e=Boolean(i.getUint8(n++));eh.log({isScanning:e}),t(this,_c,e,"a",Hc)}break;case"discoveredDevice":{const{string:e}=wt(i,n);eh.log({discoveredDeviceString:e});const t=JSON.parse(e);eh.log({discoveredDevice:t}),this.onDiscoveredDevice(t)}break;case"expiredDiscoveredDevice":{const{string:t}=wt(i,n);e(this,_c,"m",Xc).call(this,t)}break;case"connectedDevices":{if(0==i.byteLength)break;const{string:e}=wt(i,n);eh.log({connectedBluetoothDeviceIdStrings:e});const t=JSON.parse(e).connectedDevices;eh.log({connectedBluetoothDeviceIds:t}),this.onConnectedBluetoothDeviceIds(t)}break;case"deviceMessage":{const{string:t,byteOffset:s}=wt(i,n);n=s;const r=e(this,Fc,"f")[t];eh.assertWithError(r,`no device found for id ${t}`);const a=r.connectionManager,o=q(i,n);a.onClientMessage(o)}break;default:eh.error(`uncaught messageType "${s}"`)}"connecting"==this.connectionStatus&&e(this,Oc,"f").push(s)},Vc=function(){return e(this,Pc,"f")},zc=function(s){eh.assertTypeWithError(s,"boolean"),t(this,Pc,s,"f"),this.dispatchEvent("isScanningAvailable",{isScanningAvailable:this.isScanningAvailable}),this.isScanningAvailable&&e(this,_c,"m",Jc).call(this)},jc=function(){this.assertConnection(),eh.assertWithError(this.isScanningAvailable,"scanning is not available")},qc=function(){return e(this,Gc,"f")},Hc=function(e){eh.assertTypeWithError(e,"boolean"),t(this,Gc,e,"f"),this.dispatchEvent("isScanning",{isScanning:this.isScanning})},Jc=function(){this.sendServerMessage("isScanning")},Kc=function(){eh.assertWithError(this.isScanning,"is not scanning")},Qc=function(){eh.assertWithError(!this.isScanning,"is already scanning")},Xc=function(t){eh.log({expiredBluetoothDeviceId:t});const s=e(this,Zc,"f")[t];s?(eh.log({expiredDiscoveredDevice:s}),delete e(this,Zc,"f")[t],this.dispatchEvent("expiredDiscoveredDevice",{discoveredDevice:s})):eh.warn(`no discoveredDevice found with id "${t}"`)},Yc=function(t){let s=e(this,Fc,"f")[t];return s||(s=this.createDevice(t),e(this,Fc,"f")[t]=s),s},sh._reconnectOnDisconnection=!0,xc={value:["isScanningAvailable","discoveredDevices","connectedDevices"]};const ph=D("WebSocketClient",{log:!1});class vh extends sh{constructor(){super(...arguments),ih.add(this),nh.set(this,void 0),ah.set(this,{open:e(this,ih,"m",oh).bind(this),message:e(this,ih,"m",ch).bind(this),close:e(this,ih,"m",hh).bind(this),error:e(this,ih,"m",lh).bind(this)}),uh.set(this,new R(e(this,ih,"m",dh).bind(this),3e4))}get webSocket(){return e(this,nh,"f")}set webSocket(s){e(this,nh,"f")!=s?(ph.log("assigning webSocket",s),e(this,nh,"f")&&Ln(e(this,nh,"f"),e(this,ah,"f")),Un(s,e(this,ah,"f")),t(this,nh,s,"f"),ph.log("assigned webSocket")):ph.log("redundant webSocket assignment")}get readyState(){return this.webSocket?.readyState}get isConnected(){return this.readyState==WebSocket.OPEN}get isDisconnected(){return this.readyState==WebSocket.CLOSED}connect(e=`wss://${location.host}`){this.webSocket&&this.assertDisconnection(),this._connectionStatus="connecting",this.webSocket=new WebSocket(e)}disconnect(){this.assertConnection(),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.webSocket.addEventListener("close",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this._connectionStatus="disconnecting",this.webSocket.close()}reconnect(){this.assertDisconnection(),this.connect(this.webSocket.url)}toggleConnection(e){this.isConnected?this.disconnect():e&&this.webSocket?.url==e?this.reconnect():this.connect(e)}sendMessage(t){this.assertConnection(),e(this,nh,"f").send(t),e(this,uh,"f").restart()}sendServerMessage(...e){this.sendMessage(Ia({type:"serverMessage",data:ka(...e)}))}}nh=new WeakMap,ah=new WeakMap,uh=new WeakMap,ih=new WeakSet,rh=function(...e){this.sendMessage(Ia(...e))},oh=function(t){ph.log("webSocket.open",t),e(this,uh,"f").start(),this._sendRequiredMessages()},ch=async function(t){ph.log("webSocket.message",t);const s=await t.data.arrayBuffer(),i=new DataView(s);e(this,ih,"m",fh).call(this,i)},hh=function(t){ph.log("webSocket.close",t),this._connectionStatus="notConnected",Object.entries(this.devices).forEach((([e,t])=>{t.connectionManager.isConnected=!1})),e(this,uh,"f").stop(),this.reconnectOnDisconnection&&setTimeout((()=>{this.reconnect()}),3e3)},lh=function(e){ph.error("webSocket.error",e)},fh=function(t){yt(t,Ta,e(this,ih,"m",gh).bind(this),null,!0)},gh=function(t,s){switch(t){case"ping":e(this,ih,"m",mh).call(this);break;case"pong":break;case"serverMessage":this.parseMessage(s);break;default:ph.error(`uncaught messageType "${t}"`)}},dh=function(){e(this,ih,"m",rh).call(this,"ping")},mh=function(){e(this,ih,"m",rh).call(this,"pong")};export{Ct as ContinuousSensorTypes,rt as DefaultNumberOfPressureSensors,Bo as Device,Sa as DeviceManager,Sc as DevicePair,bc as DevicePairTypes,si as DeviceTypes,w as Environment,Be as FileTransferDirections,xe as FileTypes,ri as MaxNameLength,Ii as MaxNumberOfVibrationWaveformEffectSegments,Fi as MaxNumberOfVibrationWaveformSegments,Pt as MaxSensorRate,Ui as MaxVibrationWaveformEffectSegmentDelay,Li as MaxVibrationWaveformEffectSegmentLoopCount,Ai as MaxVibrationWaveformEffectSequenceLoopCount,_i as MaxVibrationWaveformSegmentDuration,rn as MaxWifiPasswordLength,sn as MaxWifiSSIDLength,ni as MinNameLength,nn as MinWifiPasswordLength,tn as MinWifiSSIDLength,Ke as RangeHelper,Vt as SensorRateStep,Et as SensorTypes,ii as Sides,Ds as TfliteSensorTypes,ks as TfliteTasks,Wi as VibrationLocations,Ti as VibrationTypes,hi as VibrationWaveformEffects,vh as WebSocketClient,T as setAllConsoleLevelFlags,W as setConsoleLevelFlagsForType};
//# sourceMappingURL=brilliantsole.module.min.js.map
