/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).BS={})}(this,(function(e){"use strict";function t(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)}function s(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s}"function"==typeof SuppressedError&&SuppressedError;const i=!1,n="undefined"!=typeof window&&void 0!==window?.document,a="undefined"!=typeof process&&null!=process?.versions?.node,r=n&&navigator.userAgent||"";let o=!1;n?o=Boolean(navigator.bluetooth):a&&(o=!0);const c=n&&/Bluefy/i.test(r),h=n&&/WebBLE/i.test(r),l=n&&/Android/i.test(r),f=n&&/Safari/i.test(r)&&!/Chrome/i.test(r),g=n&&/iPad|iPhone|iPod/i.test(r),u=n&&/Macintosh/i.test(r),d=!n&&!a&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var m,p,v,w,y=Object.freeze({__proto__:null,isAndroid:l,get isBluetoothSupported(){return o},isIOS:g,isInBluefy:c,isInBrowser:n,isInDev:i,isInLensStudio:d,isInNode:a,isInProduction:!0,isInWebBLE:h,isMac:u,isSafari:f});if(d){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(w={}).log=e,w.warn=e.bind(w,"WARNING"),w.error=e.bind(w,"ERROR")}else w=console;function b(e){return(...t)=>{if(a){const s=function(){const e=(new Error).stack;if(!e)return"";const t=e.split("\n"),s=t[3]||t[2],i=s.match(/at (.*?) \(/)||s.match(/at (.*)/);return i?`[${i[1].trim()}]`:""}();e(s,...t)}else e(...t)}}if(!w.assert){const e=(e,...t)=>{e||w.warn(...t)};w.assert=e}if(!w.table){const e=(...e)=>{w.log(...e)};w.table=e}function S(){}const C=a?b(w.log.bind(w)):w.log.bind(w),E=a?b(w.warn.bind(w)):w.warn.bind(w),M=a?b(w.error.bind(w)):w.error.bind(w),k=a?b(w.table.bind(w)):w.table.bind(w),D=w.assert.bind(w);class T{constructor(e){if(v.set(this,{log:i,warn:i,assert:!0,error:!0,table:!0}),t(m,m,"f",p)[e])throw new Error(`"${e}" console already exists`);t(m,m,"f",p)[e]=this}setLevelFlags(e){Object.assign(t(this,v,"f"),e)}static setLevelFlagsForType(e,s){if(!t(this,m,"f",p)[e])throw new Error(`no console found with type "${e}"`);t(this,m,"f",p)[e].setLevelFlags(s)}static setAllLevelFlags(e){for(const s in t(this,m,"f",p))t(this,m,"f",p)[s].setLevelFlags(e)}static create(e,s){return t(this,m,"f",p)[e]||new m(e)}get log(){return t(this,v,"f").log?C:S}get warn(){return t(this,v,"f").warn?E:S}get error(){return t(this,v,"f").error?M:S}get assert(){return t(this,v,"f").assert?D:S}get table(){return t(this,v,"f").table?k:S}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}assertRangeWithError(e,t,s,i){this.assertWithError(t>=s&&t<=i,`${e} ${t} must be within ${s}-${i}`)}}function W(e,t){return T.create(e,t)}m=T,v=new WeakMap,p={value:{}};const I=W("EventDispatcher",{log:!1});class _{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}updateEventListeners(e){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((t=>(t.shouldRemove&&I.log(`removing "${e}" eventListener`,t),!t.shouldRemove))))}addEventListener(e,t,s={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[],I.log(`creating "${e}" listeners array`,this.listeners[e]));this.listeners[e].find((e=>e.listener==t&&e.once==s.once))?I.log("already added listener"):(I.log(`adding "${e}" listener`,t,s),this.listeners[e].push({listener:t,once:s.once}),I.log(`currently have ${this.listeners[e].length} "${e}" listeners`))}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(I.log(`removing "${e}" listener...`,t),this.listeners[e].forEach((s=>{s.listener===t&&(I.log(`flagging "${e}" listener`,t),s.shouldRemove=!0)})),this.updateEventListeners(e))}removeEventListeners(e){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(I.log(`removing "${e}" listeners...`),this.listeners[e]=[])}removeAllEventListeners(){I.log("removing listeners..."),this.listeners={}}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e].forEach((s=>{s.shouldRemove||(I.log(`dispatching "${e}" listener`,s),s.listener({type:e,target:this.target,message:t}),s.once&&(I.log(`flagging "${e}" listener`,s),s.shouldRemove=!0))})),this.updateEventListeners(e))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var L,U,F;const A=W("Timer",{log:!1});class R{get callback(){return t(this,L,"f")}set callback(e){A.assertTypeWithError(e,"function"),A.log({newCallback:e}),s(this,L,e,"f"),this.isRunning&&this.restart()}get interval(){return t(this,U,"f")}set interval(e){A.assertTypeWithError(e,"number"),A.assertWithError(e>0,"interval must be above 0"),A.log({newInterval:e}),s(this,U,e,"f"),this.isRunning&&this.restart()}constructor(e,t){L.set(this,void 0),U.set(this,void 0),F.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=t(this,F,"f")}start(e=!1){this.isRunning?A.log("interval already running"):(A.log(`starting interval every ${t(this,U,"f")}ms`),s(this,F,setInterval(t(this,L,"f"),t(this,U,"f")),"f"),e&&t(this,L,"f").call(this))}stop(){this.isRunning?(A.log("stopping interval"),clearInterval(t(this,F,"f")),s(this,F,void 0,"f")):A.log("interval already not running")}restart(e=!1){this.stop(),this.start(e)}}function x(e){for(let t=0;t<8;++t)e=(1&e?0:3988292384)^e>>>1;return 4278190080^e}L=new WeakMap,U=new WeakMap,F=new WeakMap,W("checksum",{log:!1});const $=new Uint32Array(256);for(let e=0;e<256;++e)$[e]=x(e);function O(e){let t=new Uint8Array(e),s=0;for(let e=0;e<t.byteLength;++e){const i=255&s,n=t[e];s=($[i^n]^s>>>8)>>>0}return s}var B,P;B="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,P="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const N=new B,V=new P,q=W("ArrayBufferUtils",{log:!1});function z(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return j(e)}if(e instanceof Array){return z(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return j(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;return e.forEach((e=>{s.set(new Uint8Array(e),i),i+=e.byteLength})),s.buffer}function j(e){const t=N.encode(e);return z(t.byteLength,t)}function G(e,t,s){let i;return null!=s&&(i=e.byteOffset+t+s),q.log({dataView:e,begin:t,end:i,length:s}),new DataView(e.buffer.slice(e.byteOffset+t,i))}async function H(e){let t;if(e instanceof Array)t=Uint8Array.from(e);else if(e instanceof DataView)t=e.buffer;else if("string"==typeof e||e instanceof URL){const s=await fetch(e);t=await s.arrayBuffer()}else if(e instanceof File)t=await e.arrayBuffer();else{if(!(e instanceof ArrayBuffer))throw{error:"invalid file type",file:e};t=e}return t}function J(e,{include:t,exclude:s}={}){const i=e=>{const i=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(i):!s||!s.some(i)};for(const[t,s]of(e=>{const t=new Set;do{for(const s of Reflect.ownKeys(e))t.add([e,s])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===s||!i(s))continue;const n=Reflect.getOwnPropertyDescriptor(t,s);n&&"function"==typeof n.value&&(e[s]=e[s].bind(e))}return e}var K,Q,Z,X,Y,ee,te,se,ie,ne,ae,re,oe,ce,he,le,fe,ge,ue,de,me,pe,ve,we,ye,be,Se,Ce,Ee,Me,ke,De,Te,We,Ie,_e,Le,Ue,Fe,Ae,Re;const xe=W("FileTransferManager",{log:!1}),$e=["getFileTypes","maxFileLength","getFileType","setFileType","getFileLength","setFileLength","getFileChecksum","setFileChecksum","setFileTransferCommand","fileTransferStatus","getFileBlock","setFileBlock","fileBytesTransferred"],Oe=["tflite","wifiServerCert","wifiServerKey"],Be=["idle","sending","receiving"],Pe=["startSend","startReceive","cancel"],Ne=[...$e,"fileTransferProgress","fileTransferComplete","fileReceived"],Ve=["maxFileLength","getFileLength","getFileChecksum","getFileType","fileTransferStatus"];class qe{constructor(){K.add(this),se.set(this,[]),ae.set(this,Q.MaxLength),he.set(this,void 0),ue.set(this,0),ve.set(this,0),Ce.set(this,"idle"),Te.set(this,[]),Ie.set(this,void 0),_e.set(this,0),Ae.set(this,!1),Re.set(this,!1),J(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get fileTypes(){return t(this,se,"f")}static get MaxLength(){return t(this,Q,"f",ne)}get maxLength(){return t(this,ae,"f")}get type(){return t(this,he,"f")}get length(){return t(this,ue,"f")}get checksum(){return t(this,ve,"f")}get status(){return t(this,Ce,"f")}parseMessage(e,s){switch(xe.log({messageType:e}),e){case"getFileTypes":t(this,K,"m",ie).call(this,s);break;case"maxFileLength":t(this,K,"m",re).call(this,s);break;case"getFileType":case"setFileType":t(this,K,"m",le).call(this,s);break;case"getFileLength":case"setFileLength":t(this,K,"m",de).call(this,s);break;case"getFileChecksum":case"setFileChecksum":t(this,K,"m",we).call(this,s);break;case"fileTransferStatus":t(this,K,"m",Ee).call(this,s);break;case"getFileBlock":t(this,K,"m",We).call(this,s);break;case"fileBytesTransferred":t(this,K,"m",Fe).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}async send(e,s){t(this,K,"m",ke).call(this),t(this,K,"m",X).call(this,e);const i=await H(s),n=i.byteLength,a=O(i);if(e!=this.type)xe.log("different fileTypes - sending");else if(n!=this.length)xe.log("different fileLengths - sending");else{if(a==this.checksum)return xe.log("already sent file"),!1;xe.log("different fileChecksums - sending")}const r=[];return r.push(t(this,K,"m",ge).call(this,e,!1)),r.push(t(this,K,"m",pe).call(this,n,!1)),r.push(t(this,K,"m",be).call(this,a,!1)),r.push(t(this,K,"m",Se).call(this,"startSend",!1)),this.sendMessage(),await Promise.all(r),await t(this,K,"m",Le).call(this,i),!0}async receive(e){t(this,K,"m",ke).call(this),t(this,K,"m",X).call(this,e),await t(this,K,"m",ge).call(this,e),await t(this,K,"m",Se).call(this,"startReceive")}async cancel(){t(this,K,"m",De).call(this),xe.log("cancelling file transfer..."),s(this,Ae,!0,"f"),await t(this,K,"m",Se).call(this,"cancel")}get isServerSide(){return t(this,Re,"f")}set isServerSide(e){t(this,Re,"f")!=e?(xe.log({newIsServerSide:e}),s(this,Re,e,"f")):xe.log("redundant isServerSide assignment")}requestRequiredInformation(){xe.log("requesting required fileTransfer information");const e=Ve.map((e=>({type:e})));this.sendMessage(e,!1)}}Q=qe,se=new WeakMap,ae=new WeakMap,he=new WeakMap,ue=new WeakMap,ve=new WeakMap,Ce=new WeakMap,Te=new WeakMap,Ie=new WeakMap,_e=new WeakMap,Ae=new WeakMap,Re=new WeakMap,K=new WeakSet,Z=function(){return this.eventDispatcher.dispatchEvent},X=function(e){xe.assertEnumWithError(e,Oe)},Y=function(e){xe.assertWithError(e in Oe,`invalid typeEnum ${e}`)},ee=function(e){xe.assertWithError(e in Be,`invalid statusEnum ${e}`)},te=function(e){xe.assertEnumWithError(e,Pe)},ie=function(e){const i=Array.from(new Uint8Array(e.buffer)).map((e=>Oe[e])).filter(Boolean);s(this,se,i,"f"),xe.log("fileTypes",i),t(this,K,"a",Z).call(this,"getFileTypes",{fileTypes:t(this,se,"f")})},re=function(e){xe.log("parseFileMaxLength",e);const s=e.getUint32(0,!0);xe.log(`maxLength: ${s/1024}kB`),t(this,K,"m",oe).call(this,s)},oe=function(e){xe.log({maxLength:e}),s(this,ae,e,"f"),t(this,K,"a",Z).call(this,"maxFileLength",{maxFileLength:e})},ce=function(e){xe.assertWithError(e<=this.maxLength,`file length ${e}kB too large - must be ${this.maxLength}kB or less`)},le=function(e){xe.log("parseFileType",e);const s=e.getUint8(0);t(this,K,"m",Y).call(this,s);const i=Oe[s];t(this,K,"m",fe).call(this,i)},fe=function(e){xe.log({fileTransferType:e}),s(this,he,e,"f"),t(this,K,"a",Z).call(this,"getFileType",{fileType:e})},ge=async function(e,s){if(t(this,K,"m",X).call(this,e),this.type==e)return void xe.log(`redundant type assignment ${e}`);const i=this.waitForEvent("getFileType"),n=Oe.indexOf(e);this.sendMessage([{type:"setFileType",data:Uint8Array.from([n]).buffer}],s),await i},de=function(e){xe.log("parseFileLength",e);const s=e.getUint32(0,!0);t(this,K,"m",me).call(this,s)},me=function(e){xe.log(`length: ${e/1024}kB`),s(this,ue,e,"f"),t(this,K,"a",Z).call(this,"getFileLength",{fileLength:e})},pe=async function(e,s){if(xe.assertTypeWithError(e,"number"),t(this,K,"m",ce).call(this,e),this.length==e)return void xe.log(`redundant length assignment ${e}`);const i=this.waitForEvent("getFileLength"),n=new DataView(new ArrayBuffer(4));n.setUint32(0,e,!0),this.sendMessage([{type:"setFileLength",data:n.buffer}],s),await i},we=function(e){xe.log("checksum",e);const s=e.getUint32(0,!0);t(this,K,"m",ye).call(this,s)},ye=function(e){xe.log({checksum:e}),s(this,ve,e,"f"),t(this,K,"a",Z).call(this,"getFileChecksum",{fileChecksum:e})},be=async function(e,t){if(xe.assertTypeWithError(e,"number"),this.checksum==e)return void xe.log(`redundant checksum assignment ${e}`);const s=this.waitForEvent("getFileChecksum"),i=new DataView(new ArrayBuffer(4));i.setUint32(0,e,!0),this.sendMessage([{type:"setFileChecksum",data:i.buffer}],t),await s},Se=async function(e,s){t(this,K,"m",te).call(this,e);const i=this.waitForEvent("fileTransferStatus");xe.log(`setting command ${e}`);const n=Pe.indexOf(e);this.sendMessage([{type:"setFileTransferCommand",data:Uint8Array.from([n]).buffer}],s),await i},Ee=function(e){xe.log("parseFileStatus",e);const s=e.getUint8(0);t(this,K,"m",ee).call(this,s);const i=Be[s];t(this,K,"m",Me).call(this,i)},Me=function(e){xe.log({status:e}),s(this,Ce,e,"f"),t(this,K,"a",Z).call(this,"fileTransferStatus",{fileTransferStatus:e}),t(this,Te,"f").length=0,s(this,Ae,!1,"f")},ke=function(){xe.assertWithError("idle"==t(this,Ce,"f"),"status is not idle")},De=function(){xe.assertWithError("idle"!=t(this,Ce,"f"),"status is idle")},We=async function(e){xe.log("parseFileBlock",e),t(this,Te,"f").push(e.buffer);const s=t(this,Te,"f").reduce(((e,t)=>e+t.byteLength),0),i=s/t(this,ue,"f");if(xe.log(`received ${s} of ${t(this,ue,"f")} bytes (${100*i}%)`),t(this,K,"a",Z).call(this,"fileTransferProgress",{progress:i}),s!=t(this,ue,"f")){const e=new DataView(new ArrayBuffer(4));if(e.setUint32(0,s,!0),this.isServerSide)return;return void await this.sendMessage([{type:"fileBytesTransferred",data:e.buffer}])}xe.log("file transfer complete");let n,a=(new Date).toLocaleString();switch(this.type){case"tflite":a+=".tflite";break;case"wifiServerCert":a+="_server.crt";break;case"wifiServerKey":a+="_server.key"}n="undefined"!=typeof File?new File(t(this,Te,"f"),a):new Blob(t(this,Te,"f"));const r=O(await n.arrayBuffer());xe.log({checksum:r}),r==t(this,ve,"f")?(xe.log("received file",n),t(this,K,"a",Z).call(this,"getFileBlock",{fileTransferBlock:e}),t(this,K,"a",Z).call(this,"fileTransferComplete",{direction:"receiving"}),t(this,K,"a",Z).call(this,"fileReceived",{file:n})):xe.error(`wrong checksum - expected ${t(this,ve,"f")}, got ${r}`)},Le=async function(e){return s(this,Ie,e,"f"),s(this,_e,0,"f"),t(this,K,"m",Ue).call(this)},Ue=async function(){if("sending"!=this.status)return;if(t(this,Ae,"f"))return void xe.error("not sending block - busy cancelling");if(!t(this,Ie,"f"))return void(this.isServerSide||xe.error("no buffer defined"));const e=t(this,Ie,"f");let i=t(this,_e,"f");const n=e.slice(i,i+(this.mtu-3-3));xe.log("slicedBuffer",n);const a=1-(e.byteLength-i)/e.byteLength;xe.log(`sending bytes ${i}-${i+n.byteLength} of ${e.byteLength} bytes (${100*a}%)`),t(this,K,"a",Z).call(this,"fileTransferProgress",{progress:a}),0==n.byteLength?(xe.log("finished sending buffer"),t(this,K,"a",Z).call(this,"fileTransferComplete",{direction:"sending"})):(await this.sendMessage([{type:"setFileBlock",data:n}]),s(this,_e,i+n.byteLength,"f"))},Fe=async function(e){xe.log("parseBytesTransferred",e);const s=e.getUint32(0,!0);if(xe.log({bytesTransferred:s}),"sending"==this.status)return this.isServerSide||t(this,_e,"f")==s?void t(this,K,"m",Ue).call(this):(xe.error(`bytesTransferred are not equal - got ${s}, expected ${t(this,_e,"f")}`),void this.cancel());xe.error("not currently sending file")},ne={value:0};const ze=W("MathUtils",{log:!1});const je=65536;function Ge(e,t){const s=Date.now();var i;let n=(i=s)-i%je+e.getUint16(t,!0);return Math.abs(s-n)>6e4&&(ze.log("correcting timestamp delta"),n+=je*Math.sign(s-n)),n}var He,Je,Ke;const Qe={min:1/0,max:-1/0,span:0};class Ze{constructor(){He.add(this),Je.set(this,Object.assign({},Qe))}get min(){return t(this,Je,"f").min}get max(){return t(this,Je,"f").max}set min(e){t(this,Je,"f").min=e,t(this,Je,"f").max=Math.max(e,t(this,Je,"f").max),t(this,He,"m",Ke).call(this)}set max(e){t(this,Je,"f").max=e,t(this,Je,"f").min=Math.min(e,t(this,Je,"f").min),t(this,He,"m",Ke).call(this)}reset(){Object.assign(t(this,Je,"f"),Qe)}update(e){t(this,Je,"f").min=Math.min(e,t(this,Je,"f").min),t(this,Je,"f").max=Math.max(e,t(this,Je,"f").max),t(this,He,"m",Ke).call(this)}getNormalization(e,s){let i=function(e,t,s,i){return null==i&&(i=s-t),(e-t)/i}(e,t(this,Je,"f").min,t(this,Je,"f").max,t(this,Je,"f").span);return s&&(i*=t(this,Je,"f").span),i||0}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}var Xe,Ye,et,tt,st;Je=new WeakMap,He=new WeakSet,Ke=function(){t(this,Je,"f").span=t(this,Je,"f").max-t(this,Je,"f").min};class it{constructor(){Xe.set(this,{x:new Ze,y:new Ze})}reset(){t(this,Xe,"f").x.reset(),t(this,Xe,"f").y.reset()}update(e){t(this,Xe,"f").x.update(e.x),t(this,Xe,"f").y.update(e.y)}getNormalization(e,s){return{x:t(this,Xe,"f").x.getNormalization(e.x,s),y:t(this,Xe,"f").y.getNormalization(e.y,s)}}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}Xe=new WeakMap;const nt=W("PressureDataManager",{log:!1}),at=["pressure"],rt=at;class ot{constructor(){Ye.set(this,[]),et.set(this,void 0),tt.set(this,new Ze),st.set(this,new it)}get positions(){return t(this,Ye,"f")}get numberOfSensors(){return this.positions.length}parsePositions(e){const t=[];for(let s=0,i=0;i<e.byteLength;s++,i+=2)t.push({x:e.getUint8(i)/256,y:e.getUint8(i+1)/256});var i,n;nt.log({positions:t}),s(this,Ye,t,"f"),s(this,et,(i=this.numberOfSensors,n=()=>new Ze,new Array(i).fill(1).map(((e,t)=>{if("function"==typeof n)return n(t);{const e=n;return Object.assign({},e)}}))),"f"),this.resetRange()}resetRange(){t(this,et,"f")?.forEach((e=>e.reset())),t(this,st,"f").reset(),t(this,tt,"f").reset()}parseData(e,s){const i={sensors:[],scaledSum:0,normalizedSum:0};for(let n=0,a=0;a<e.byteLength;n++,a+=2){const r=e.getUint16(a,!0);let o=r*s/this.numberOfSensors;const c=t(this,et,"f")[n].updateAndGetNormalization(o,!1),h=this.positions[n];i.sensors[n]={rawValue:r,scaledValue:o,normalizedValue:c,position:h,weightedValue:0},i.scaledSum+=o}return i.normalizedSum=t(this,tt,"f").updateAndGetNormalization(i.scaledSum,!1),i.scaledSum>0&&(i.center={x:0,y:0},i.sensors.forEach((e=>{e.weightedValue=e.scaledValue/i.scaledSum,i.center.x+=e.position.x*e.weightedValue,i.center.y+=e.position.y*e.weightedValue})),i.normalizedCenter=t(this,st,"f").updateAndGetNormalization(i.center,!1)),nt.log({pressure:i}),i}}Ye=new WeakMap,et=new WeakMap,tt=new WeakMap,st=new WeakMap;const ct=W("MotionSensorDataManager",{log:!1}),ht=["still","walking","running","bicycle","vehicle","tilting"],lt=["portraitUpright","landscapeLeft","portraitUpsideDown","landscapeRight","unknown"];class ft{parseVector3(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));const a={x:s,y:i,z:n};return ct.log({vector:a}),a}parseQuaternion(e,t){let[s,i,n,a]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0),e.getInt16(6,!0)].map((e=>e*t));const r={x:s,y:i,z:n,w:a};return ct.log({quaternion:r}),r}parseEuler(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));i*=-1,s*=-1,s<0&&(s+=360);const a={heading:s,pitch:i,roll:n};return ct.log({euler:a}),a}parseStepCounter(e){ct.log("parseStepCounter",e);const t=e.getUint32(0,!0);return ct.log({stepCount:t}),t}parseActivity(e){ct.log("parseActivity",e);const t={},s=e.getUint8(0);return ct.log("activityBitfield",s.toString(2)),ht.forEach(((e,i)=>{t[e]=Boolean(s&1<<i)})),ct.log("activity",t),t}parseDeviceOrientation(e){ct.log("parseDeviceOrientation",e);const t=e.getUint8(0),s=lt[t];return ct.assertWithError(s,"undefined deviceOrientation"),ct.log({deviceOrientation:s}),s}}var gt,ut;const dt=["barometer"],mt=dt,pt=W("BarometerSensorDataManager",{log:!1});class vt{constructor(){gt.add(this)}parseData(e,s){const i=e.getUint32(0,!0)*s,n=t(this,gt,"m",ut).call(this,i);return pt.log({pressure:i,altitude:n}),{pressure:i}}}gt=new WeakSet,ut=function(e){const t=.0065;return 288.15/t*(1-Math.pow(e/101325,.19026643566373183))};const wt=W("ParseUtils",{log:!1});function yt(e,t=0){const s=e.getUint8(t++);return{string:V.decode(e.buffer.slice(e.byteOffset+t,e.byteOffset+t+s)),byteOffset:t+=s}}function bt(e,t,s,i,n=!1){let a=0;for(;a<e.byteLength;){const r=e.getUint8(a++);wt.assertWithError(r in t,`invalid messageTypeEnum ${r}`);const o=t[r];let c;n?(c=e.getUint16(a,!0),a+=2):c=e.getUint8(a++),wt.log({messageTypeEnum:r,messageType:o,messageLength:c,dataView:e,byteOffset:a});const h=G(e,a,c);wt.log({_dataView:h}),s(o,h,i),a+=c}}var St,Ct,Et,Mt,kt,Dt,Tt,Wt,It,_t,Lt,Ut,Ft,At,Rt,xt,$t,Ot,Bt,Pt,Nt,Vt,qt,zt,jt,Gt,Ht,Jt,Kt;const Qt=W("CameraManager",{log:!1}),Zt=["focus","takePicture","stop","sleep","wake"],Xt=["idle","focusing","takingPicture","asleep"],Yt=["headerSize","header","imageSize","image","footerSize","footer"],es=["resolution","qualityFactor","shutter","gain","redGain","greenGain","blueGain"],ts=["cameraStatus","cameraCommand","getCameraConfiguration","setCameraConfiguration","cameraData"],ss=["getCameraConfiguration","cameraStatus"],is=[...ts,"cameraImageProgress","cameraImage"];class ns{constructor(){St.add(this),Mt.set(this,void 0),Ut.set(this,0),Ft.set(this,void 0),At.set(this,0),Rt.set(this,0),xt.set(this,void 0),$t.set(this,0),Ot.set(this,0),Bt.set(this,void 0),Pt.set(this,0),Nt.set(this,!1),qt.set(this,{}),zt.set(this,void 0),jt.set(this,{resolution:{min:100,max:720},qualityFactor:{min:15,max:60},shutter:{min:4,max:16383},gain:{min:1,max:248},redGain:{min:0,max:1023},greenGain:{min:0,max:1023},blueGain:{min:0,max:1023}}),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Qt.log("requesting required camera information");const e=ss.map((e=>({type:e})));this.sendMessage(e,!1)}get cameraStatus(){return t(this,Mt,"f")}async focus(){t(this,St,"m",It).call(this),await t(this,St,"m",Tt).call(this,"focus")}async takePicture(){t(this,St,"m",It).call(this),await t(this,St,"m",Tt).call(this,"takePicture")}async stop(){t(this,St,"m",It).call(this),await t(this,St,"m",Tt).call(this,"stop")}async sleep(){t(this,St,"m",It).call(this),await t(this,St,"m",Tt).call(this,"sleep")}async wake(){t(this,St,"m",Wt).call(this),await t(this,St,"m",Tt).call(this,"wake")}get cameraConfiguration(){return t(this,qt,"f")}get availableCameraConfigurationTypes(){return t(this,zt,"f")}get cameraConfigurationRanges(){return t(this,jt,"f")}async setCameraConfiguration(e){if(Qt.log({newCameraConfiguration:e}),t(this,St,"m",Ht).call(this,e))return void Qt.log("redundant camera configuration");const s=t(this,St,"m",Kt).call(this,e);Qt.log({setCameraConfigurationData:s});const i=this.waitForEvent("getCameraConfiguration");this.sendMessage([{type:"setCameraConfiguration",data:s.buffer}]),await i}static AssertValidCameraConfigurationType(e){Qt.assertEnumWithError(e,es)}static AssertValidCameraConfigurationTypeEnum(e){Qt.assertTypeWithError(e,"number"),Qt.assertWithError(e in es,`invalid cameraConfigurationTypeEnum ${e}`)}parseMessage(e,s){switch(Qt.log({messageType:e,dataView:s}),e){case"cameraStatus":t(this,St,"m",kt).call(this,s);break;case"getCameraConfiguration":case"setCameraConfiguration":t(this,St,"m",Gt).call(this,s);break;case"cameraData":t(this,St,"m",_t).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){s(this,Mt,void 0,"f"),s(this,At,0,"f"),s(this,$t,0,"f"),s(this,Pt,0,"f")}}var as;Ct=ns,Mt=new WeakMap,Ut=new WeakMap,Ft=new WeakMap,At=new WeakMap,Rt=new WeakMap,xt=new WeakMap,$t=new WeakMap,Ot=new WeakMap,Bt=new WeakMap,Pt=new WeakMap,Nt=new WeakMap,qt=new WeakMap,zt=new WeakMap,jt=new WeakMap,St=new WeakSet,Et=function(){return this.eventDispatcher.dispatchEvent},kt=function(e){const s=e.getUint8(0),i=Xt[s];t(this,St,"m",Dt).call(this,i)},Dt=function(e){if(Qt.assertEnumWithError(e,Xt),e==t(this,Mt,"f"))return void Qt.log(`redundant cameraStatus ${e}`);const i=t(this,Mt,"f");s(this,Mt,e,"f"),Qt.log(`updated cameraStatus to "${this.cameraStatus}"`),t(this,St,"a",Et).call(this,"cameraStatus",{cameraStatus:this.cameraStatus,previousCameraStatus:i}),"takingPicture"!=t(this,Mt,"f")&&t(this,$t,"f")>0&&!t(this,Nt,"f")&&t(this,St,"m",Vt).call(this)},Tt=async function(e,t){Qt.assertEnumWithError(e,Zt),Qt.log(`sending camera command "${e}"`);const s=this.waitForEvent("cameraStatus");Qt.log(`setting command "${e}"`);const i=Zt.indexOf(e);this.sendMessage([{type:"cameraCommand",data:Uint8Array.from([i]).buffer}],t),await s},Wt=function(){Qt.assertWithError("asleep"==t(this,Mt,"f"),`camera is not asleep - currently ${t(this,Mt,"f")}`)},It=function(){Qt.assertWithError("asleep"!=t(this,Mt,"f"),`camera is not awake - currently ${t(this,Mt,"f")}`)},_t=function(e){Qt.log("parsing camera data",e),bt(e,Yt,t(this,St,"m",Lt).bind(this),null,!0)},Lt=function(e,i){switch(Qt.log({cameraDataType:e,dataView:i}),e){case"headerSize":s(this,Ut,i.getUint16(0,!0),"f"),Qt.log({headerSize:t(this,Ut,"f")}),s(this,Ft,void 0,"f"),t(this,At,"f");break;case"header":s(this,Ft,z(t(this,Ft,"f"),i),"f"),Qt.log({headerData:t(this,Ft,"f")}),s(this,At,t(this,Ft,"f")?.byteLength/t(this,Ut,"f"),"f"),Qt.log({headerProgress:t(this,At,"f")}),t(this,St,"a",Et).call(this,"cameraImageProgress",{progress:t(this,At,"f"),type:"header"}),1==t(this,At,"f")&&Qt.log("finished getting header data");break;case"imageSize":s(this,Rt,i.getUint16(0,!0),"f"),Qt.log({imageSize:t(this,Rt,"f")}),s(this,xt,void 0,"f"),t(this,$t,"f"),s(this,Nt,!1,"f");break;case"image":s(this,xt,z(t(this,xt,"f"),i),"f"),Qt.log({imageData:t(this,xt,"f")}),s(this,$t,t(this,xt,"f")?.byteLength/t(this,Rt,"f"),"f"),Qt.log({imageProgress:t(this,$t,"f")}),1==t(this,$t,"f")&&(Qt.log("finished getting image data"),1==t(this,At,"f")&&t(this,St,"m",Vt).call(this)),t(this,St,"a",Et).call(this,"cameraImageProgress",{progress:t(this,$t,"f"),type:"image"});break;case"footerSize":s(this,Ot,i.getUint16(0,!0),"f"),Qt.log({footerSize:t(this,Ot,"f")}),s(this,Bt,void 0,"f"),t(this,Pt,"f");break;case"footer":s(this,Bt,z(t(this,Bt,"f"),i),"f"),Qt.log({footerData:t(this,Bt,"f")}),s(this,Pt,t(this,Bt,"f")?.byteLength/t(this,Ot,"f"),"f"),Qt.log({footerProgress:t(this,Pt,"f")}),t(this,St,"a",Et).call(this,"cameraImageProgress",{progress:t(this,Pt,"f"),type:"footer"}),1==t(this,Pt,"f")&&(Qt.log("finished getting footer data"),1==t(this,$t,"f")&&t(this,St,"m",Vt).call(this))}},Vt=function(){Qt.log("building image...");const e=z(t(this,Ft,"f"),t(this,xt,"f"),t(this,Bt,"f"));Qt.log({imageData:e});let i=new Blob([e],{type:"image/jpeg"});Qt.log("created blob",i);const n=URL.createObjectURL(i);Qt.log("created url",n),t(this,St,"a",Et).call(this,"cameraImage",{url:n,blob:i}),s(this,Nt,!0,"f")},Gt=function(e){const i={};let n=0;for(;n<e.byteLength;){const t=e.getUint8(n++),s=es[t];Qt.assertWithError(s,`invalid cameraConfigurationTypeIndex ${t}`),i[s]=e.getUint16(n,!0),n+=2}Qt.log({parsedCameraConfiguration:i}),s(this,zt,Object.keys(i),"f"),s(this,qt,i,"f"),t(this,St,"a",Et).call(this,"getCameraConfiguration",{cameraConfiguration:t(this,qt,"f")})},Ht=function(e){return Object.keys(e).every((t=>this.cameraConfiguration[t]==e[t]))},Jt=function(e){Qt.assertWithError(t(this,zt,"f"),"must get initial cameraConfiguration");const s=t(this,zt,"f")?.includes(e);return Qt.assertWithError(s,`unavailable camera configuration type "${e}"`),s},Kt=function(e){let s=Object.keys(e);s=s.filter((e=>t(this,St,"m",Jt).call(this,e)));const i=new DataView(new ArrayBuffer(3*s.length));return s.forEach(((t,s)=>{Ct.AssertValidCameraConfigurationType(t);const n=es.indexOf(t);i.setUint8(3*s,n);const a=e[t];i.setUint16(3*s+1,a,!0)})),Qt.log({sensorConfigurationData:i}),i};const rs=W("SensorDataManager",{log:!1}),os=[...at,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation","activity","stepCounter","stepDetector","deviceOrientation","tapDetector",...dt,"camera"],cs=[...rt,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation",...mt],hs=["getPressurePositions","getSensorScalars","sensorData"],ls=["getPressurePositions"],fs=[...hs,...os];class gs{constructor(){this.pressureSensorDataManager=new ot,this.motionSensorDataManager=new ft,this.barometerSensorDataManager=new vt,as.set(this,new Map)}static AssertValidSensorType(e){rs.assertEnumWithError(e,os)}static AssertValidSensorTypeEnum(e){rs.assertTypeWithError(e,"number"),rs.assertWithError(e in os,`invalid sensorTypeEnum ${e}`)}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}parseMessage(e,t){switch(rs.log({messageType:e}),e){case"getSensorScalars":this.parseScalars(t);break;case"getPressurePositions":this.pressureSensorDataManager.parsePositions(t);break;case"sensorData":this.parseData(t);break;default:throw Error(`uncaught messageType ${e}`)}}parseScalars(e){for(let s=0;s<e.byteLength;s+=5){const i=e.getUint8(s),n=os[i];if(!n){rs.warn(`unknown sensorType index ${i}`);continue}const a=e.getFloat32(s+1,!0);rs.log({sensorType:n,sensorScalar:a}),t(this,as,"f").set(n,a)}}parseData(e){rs.log("sensorData",Array.from(new Uint8Array(e.buffer)));let t=0;const s=Ge(e,t);t+=2;bt(new DataView(e.buffer,t),os,this.parseDataCallback.bind(this),{timestamp:s})}parseDataCallback(e,s,{timestamp:i}){const n=t(this,as,"f").get(e)||1;let a=null;switch(e){case"pressure":a=this.pressureSensorDataManager.parseData(s,n);break;case"acceleration":case"gravity":case"linearAcceleration":case"gyroscope":case"magnetometer":a=this.motionSensorDataManager.parseVector3(s,n);break;case"gameRotation":case"rotation":a=this.motionSensorDataManager.parseQuaternion(s,n);break;case"orientation":a=this.motionSensorDataManager.parseEuler(s,n);break;case"stepCounter":a=this.motionSensorDataManager.parseStepCounter(s);break;case"stepDetector":case"tapDetector":a={};break;case"activity":a=this.motionSensorDataManager.parseActivity(s);break;case"deviceOrientation":a=this.motionSensorDataManager.parseDeviceOrientation(s);break;case"barometer":a=this.barometerSensorDataManager.parseData(s,n);break;case"camera":return;default:rs.error(`uncaught sensorType "${e}"`)}rs.assertWithError(null!=a,`no sensorData defined for sensorType "${e}"`),rs.log({sensorType:e,sensorData:a}),this.dispatchEvent(e,{sensorType:e,[e]:a,timestamp:i}),this.dispatchEvent("sensorData",{sensorType:e,[e]:a,timestamp:i})}}var us,ds,ms,ps,vs,ws,ys,bs,Ss,Cs,Es,Ms,ks;as=new WeakMap;const Ds=W("SensorConfigurationManager",{log:!1}),Ts=["getSensorConfiguration","setSensorConfiguration"],Ws=Ts;class Is{constructor(){us.add(this),ps.set(this,void 0),ws.set(this,{}),J(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get configuration(){return t(this,ws,"f")}async setConfiguration(e,s){if(s&&(e=Object.assign({...this.zeroSensorConfiguration},e)),Ds.log({newSensorConfiguration:e}),t(this,us,"m",bs).call(this,e))return void Ds.log("redundant sensor configuration");const i=t(this,us,"m",Ms).call(this,e);Ds.log({setSensorConfigurationData:i});const n=this.waitForEvent("getSensorConfiguration");this.sendMessage([{type:"setSensorConfiguration",data:i.buffer}]),await n}static get ZeroSensorConfiguration(){return t(this,ds,"f",ks)}get zeroSensorConfiguration(){const e={};return t(this,ps,"f").forEach((t=>{e[t]=0})),e}async clearSensorConfiguration(){return this.setConfiguration(this.zeroSensorConfiguration)}parseMessage(e,s){switch(Ds.log({messageType:e}),e){case"getSensorConfiguration":case"setSensorConfiguration":const i=t(this,us,"m",Ss).call(this,s);t(this,us,"m",ys).call(this,i);break;default:throw Error(`uncaught messageType ${e}`)}}}var _s,Ls,Us,Fs,As,Rs,xs,$s,Os,Bs,Ps,Ns,Vs,qs,zs,js,Gs,Hs,Js,Ks,Qs,Zs,Xs,Ys,ei,ti,si,ii,ni,ai,ri;ds=Is,ps=new WeakMap,ws=new WeakMap,us=new WeakSet,ms=function(){return this.eventDispatcher.dispatchEvent},vs=function(e){Ds.assertWithError(t(this,ps,"f"),"must get initial sensorConfiguration");const s=t(this,ps,"f")?.includes(e);return Ds.log(s,`unavailable sensor type "${e}"`),s},ys=function(e){s(this,ws,e,"f"),Ds.log({updatedConfiguration:t(this,ws,"f")}),t(this,us,"a",ms).call(this,"getSensorConfiguration",{sensorConfiguration:this.configuration})},bs=function(e){return Object.keys(e).every((t=>this.configuration[t]==e[t]))},Ss=function(e){const t={};for(let s=0;s<e.byteLength;s+=3){const i=e.getUint8(s),n=os[i],a=e.getUint16(s+1,!0);Ds.log({sensorType:n,sensorRate:a}),n?t[n]=a:Ds.warn(`unknown sensorType index ${i}`)}return Ds.log({parsedSensorConfiguration:t}),s(this,ps,Object.keys(t),"f"),t},Cs=function(e){Ds.assertTypeWithError(e,"number"),Ds.assertWithError(e>=0,`sensorRate must be 0 or greater (got ${e})`),Ds.assertWithError(e<65535,`sensorRate must be 0 or greater (got ${e})`),Ds.assertWithError(e%5==0,"sensorRate must be multiple of 5")},Es=function(e){t(ds,ds,"m",Cs).call(ds,e)},Ms=function(e){let s=Object.keys(e);s=s.filter((e=>t(this,us,"m",vs).call(this,e)));const i=new DataView(new ArrayBuffer(3*s.length));return s.forEach(((s,n)=>{gs.AssertValidSensorType(s);const a=os.indexOf(s);i.setUint8(3*n,a);const r=e[s];t(this,us,"m",Es).call(this,r),i.setUint16(3*n+1,r,!0)})),Ds.log({sensorConfigurationData:i}),i},ks={value:{}},os.forEach((e=>{t(ds,ds,"f",ks)[e]=0}));const oi=W("TfliteManager",{log:!1}),ci=["getTfliteName","setTfliteName","getTfliteTask","setTfliteTask","getTfliteSampleRate","setTfliteSampleRate","getTfliteSensorTypes","setTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","setTfliteCaptureDelay","getTfliteThreshold","setTfliteThreshold","getTfliteInferencingEnabled","setTfliteInferencingEnabled","tfliteInference"],hi=ci,li=["getTfliteName","getTfliteTask","getTfliteSampleRate","getTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","getTfliteThreshold","getTfliteInferencingEnabled"],fi=["classification","regression"],gi=["pressure","linearAcceleration","gyroscope","magnetometer"];class ui{constructor(){_s.add(this),As.set(this,void 0),$s.set(this,void 0),Ps.set(this,void 0),qs.set(this,[]),Gs.set(this,void 0),Qs.set(this,void 0),Ys.set(this,void 0),si.set(this,void 0),ri.set(this,void 0),J(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get name(){return t(this,As,"f")}async setName(e,t){if(oi.assertTypeWithError(e,"string"),this.name==e)return void oi.log(`redundant name assignment ${e}`);const s=this.waitForEvent("getTfliteName"),i=N.encode(e);this.sendMessage([{type:"setTfliteName",data:i.buffer}],t),await s}get task(){return t(this,$s,"f")}async setTask(e,s){if(t(this,_s,"m",Ls).call(this,e),this.task==e)return void oi.log(`redundant task assignment ${e}`);const i=this.waitForEvent("getTfliteTask"),n=fi.indexOf(e);this.sendMessage([{type:"setTfliteTask",data:Uint8Array.from([n]).buffer}],s),await i}get sampleRate(){return t(this,Ps,"f")}async setSampleRate(e,s){if(oi.assertTypeWithError(e,"number"),e-=e%5,oi.assertWithError(e>=5,`sampleRate must be multiple of 5 greater than 0 (got ${e})`),t(this,Ps,"f")==e)return void oi.log(`redundant sampleRate assignment ${e}`);const i=this.waitForEvent("getTfliteSampleRate"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,e,!0),this.sendMessage([{type:"setTfliteSampleRate",data:n.buffer}],s),await i}static AssertValidSensorType(e){gs.AssertValidSensorType(e);const t=e;oi.assertWithError(gi.includes(t),`invalid tflite sensorType "${e}"`)}get sensorTypes(){return t(this,qs,"f").slice()}async setSensorTypes(e,t){e.forEach((e=>{ui.AssertValidSensorType(e)}));const s=this.waitForEvent("getTfliteSensorTypes");var i;const n=(e=(i=e).filter(((e,t)=>i.indexOf(e)==t))).map((e=>os.indexOf(e))).sort();oi.log(e,n),this.sendMessage([{type:"setTfliteSensorTypes",data:Uint8Array.from(n).buffer}],t),await s}get isReady(){return t(this,Gs,"f")}get captureDelay(){return t(this,Qs,"f")}async setCaptureDelay(e,s){if(oi.assertTypeWithError(e,"number"),t(this,Qs,"f")==e)return void oi.log(`redundant captureDelay assignment ${e}`);const i=this.waitForEvent("getTfliteCaptureDelay"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,e,!0),this.sendMessage([{type:"setTfliteCaptureDelay",data:n.buffer}],s),await i}get threshold(){return t(this,Ys,"f")}async setThreshold(e,s){if(oi.assertTypeWithError(e,"number"),oi.assertWithError(e>=0,`threshold must be positive (got ${e})`),t(this,Ys,"f")==e)return void oi.log(`redundant threshold assignment ${e}`);const i=this.waitForEvent("getTfliteThreshold"),n=new DataView(new ArrayBuffer(4));n.setFloat32(0,e,!0),this.sendMessage([{type:"setTfliteThreshold",data:n.buffer}],s),await i}get inferencingEnabled(){return t(this,si,"f")}async setInferencingEnabled(e,s=!0){if(oi.assertTypeWithError(e,"boolean"),!e&&!this.isReady)return;if(t(this,_s,"m",Ks).call(this),t(this,si,"f")==e)return void oi.log(`redundant inferencingEnabled assignment ${e}`);const i=this.waitForEvent("getTfliteInferencingEnabled");this.sendMessage([{type:"setTfliteInferencingEnabled",data:Uint8Array.from([Number(e)]).buffer}],s),await i}async toggleInferencingEnabled(){return this.setInferencingEnabled(!this.inferencingEnabled)}async enableInferencing(){this.inferencingEnabled||this.setInferencingEnabled(!0)}async disableInferencing(){this.inferencingEnabled&&this.setInferencingEnabled(!1)}parseMessage(e,s){switch(oi.log({messageType:e}),e){case"getTfliteName":case"setTfliteName":t(this,_s,"m",Rs).call(this,s);break;case"getTfliteTask":case"setTfliteTask":t(this,_s,"m",Os).call(this,s);break;case"getTfliteSampleRate":case"setTfliteSampleRate":t(this,_s,"m",Ns).call(this,s);break;case"getTfliteSensorTypes":case"setTfliteSensorTypes":t(this,_s,"m",zs).call(this,s);break;case"tfliteIsReady":t(this,_s,"m",Hs).call(this,s);break;case"getTfliteCaptureDelay":case"setTfliteCaptureDelay":t(this,_s,"m",Zs).call(this,s);break;case"getTfliteThreshold":case"setTfliteThreshold":t(this,_s,"m",ei).call(this,s);break;case"getTfliteInferencingEnabled":case"setTfliteInferencingEnabled":t(this,_s,"m",ii).call(this,s);break;case"tfliteInference":t(this,_s,"m",ai).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}get configuration(){return t(this,ri,"f")}sendConfiguration(e,i){if(e==t(this,ri,"f"))return void oi.log("redundant tflite configuration assignment");if(s(this,ri,e,"f"),oi.log("assigned new tflite configuration",this.configuration),!this.configuration)return;const{name:n,task:a,captureDelay:r,sampleRate:o,threshold:c,sensorTypes:h}=this.configuration;this.setName(n,!1),this.setTask(a,!1),null!=r&&this.setCaptureDelay(r,!1),this.setSampleRate(o,!1),null!=c&&this.setThreshold(c,!1),this.setSensorTypes(h,i)}clear(){s(this,ri,void 0,"f"),s(this,si,!1,"f"),s(this,qs,[],"f"),s(this,Ps,0,"f"),s(this,Gs,!1,"f")}requestRequiredInformation(){oi.log("requesting required tflite information");const e=li.map((e=>({type:e})));this.sendMessage(e,!1)}}var di,mi,pi,vi,wi;As=new WeakMap,$s=new WeakMap,Ps=new WeakMap,qs=new WeakMap,Gs=new WeakMap,Qs=new WeakMap,Ys=new WeakMap,si=new WeakMap,ri=new WeakMap,_s=new WeakSet,Ls=function(e){oi.assertEnumWithError(e,fi)},Us=function(e){oi.assertWithError(e in fi,`invalid taskEnum ${e}`)},Fs=function(){return this.eventDispatcher.dispatchEvent},Rs=function(e){oi.log("parseName",e);const s=V.decode(e.buffer);t(this,_s,"m",xs).call(this,s)},xs=function(e){oi.log({name:e}),s(this,As,e,"f"),t(this,_s,"a",Fs).call(this,"getTfliteName",{tfliteName:e})},Os=function(e){oi.log("parseTask",e);const s=e.getUint8(0);t(this,_s,"m",Us).call(this,s);const i=fi[s];t(this,_s,"m",Bs).call(this,i)},Bs=function(e){oi.log({task:e}),s(this,$s,e,"f"),t(this,_s,"a",Fs).call(this,"getTfliteTask",{tfliteTask:e})},Ns=function(e){oi.log("parseSampleRate",e);const s=e.getUint16(0,!0);t(this,_s,"m",Vs).call(this,s)},Vs=function(e){oi.log({sampleRate:e}),s(this,Ps,e,"f"),t(this,_s,"a",Fs).call(this,"getTfliteSampleRate",{tfliteSampleRate:e})},zs=function(e){oi.log("parseSensorTypes",e);const s=[];for(let t=0;t<e.byteLength;t++){const i=e.getUint8(t),n=os[i];n?gi.includes(n)?s.push(n):oi.error(`invalid tfliteSensorType ${n}`):oi.error(`invalid sensorTypeEnum ${i}`)}t(this,_s,"m",js).call(this,s)},js=function(e){oi.log({sensorTypes:e}),s(this,qs,e,"f"),t(this,_s,"a",Fs).call(this,"getTfliteSensorTypes",{tfliteSensorTypes:e})},Hs=function(e){oi.log("parseIsReady",e);const s=Boolean(e.getUint8(0));t(this,_s,"m",Js).call(this,s)},Js=function(e){oi.log({isReady:e}),s(this,Gs,e,"f"),t(this,_s,"a",Fs).call(this,"tfliteIsReady",{tfliteIsReady:e})},Ks=function(){oi.assertWithError(this.isReady,"tflite is not ready")},Zs=function(e){oi.log("parseCaptureDelay",e);const s=e.getUint16(0,!0);t(this,_s,"m",Xs).call(this,s)},Xs=function(e){oi.log({captureDelay:e}),s(this,Qs,e,"f"),t(this,_s,"a",Fs).call(this,"getTfliteCaptureDelay",{tfliteCaptureDelay:e})},ei=function(e){oi.log("parseThreshold",e);const s=e.getFloat32(0,!0);t(this,_s,"m",ti).call(this,s)},ti=function(e){oi.log({threshold:e}),s(this,Ys,e,"f"),t(this,_s,"a",Fs).call(this,"getTfliteThreshold",{tfliteThreshold:e})},ii=function(e){oi.log("parseInferencingEnabled",e);const s=Boolean(e.getUint8(0));t(this,_s,"m",ni).call(this,s)},ni=function(e){oi.log({inferencingEnabled:e}),s(this,si,e,"f"),t(this,_s,"a",Fs).call(this,"getTfliteInferencingEnabled",{tfliteInferencingEnabled:e})},ai=function(e){oi.log("parseInference",e);const s=Ge(e,0);oi.log({timestamp:s});const i=[];for(let t=0,s=2;s<e.byteLength;t++,s+=4){const t=e.getFloat32(s,!0);i.push(t)}oi.log("values",i);const n={timestamp:s,values:i};if("classification"==this.task){let e=0,s=0;if(i.forEach(((t,i)=>{t>e&&(e=t,s=i)})),oi.log({maxIndex:s,maxValue:e}),n.maxIndex=s,n.maxValue=e,t(this,ri,"f")?.classes){const{classes:e}=t(this,ri,"f");n.maxClass=e[s],n.classValues={},i.forEach(((t,s)=>{const i=e[s];n.classValues[i]=t}))}}t(this,_s,"a",Fs).call(this,"tfliteInference",{tfliteInference:n})};const yi=W("DeviceInformationManager",{log:!1}),bi=["manufacturerName","modelNumber","hardwareRevision","firmwareRevision","softwareRevision","pnpId","serialNumber"],Si=[...bi,"deviceInformation"];class Ci{constructor(){di.add(this),pi.set(this,{})}get information(){return t(this,pi,"f")}clear(){s(this,pi,{},"f")}parseMessage(e,s){switch(yi.log({messageType:e}),e){case"manufacturerName":const i=V.decode(s.buffer);yi.log({manufacturerName:i}),t(this,di,"m",wi).call(this,{manufacturerName:i});break;case"modelNumber":const n=V.decode(s.buffer);yi.log({modelNumber:n}),t(this,di,"m",wi).call(this,{modelNumber:n});break;case"softwareRevision":const a=V.decode(s.buffer);yi.log({softwareRevision:a}),t(this,di,"m",wi).call(this,{softwareRevision:a});break;case"hardwareRevision":const r=V.decode(s.buffer);yi.log({hardwareRevision:r}),t(this,di,"m",wi).call(this,{hardwareRevision:r});break;case"firmwareRevision":const o=V.decode(s.buffer);yi.log({firmwareRevision:o}),t(this,di,"m",wi).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===s.getUint8(0)?"Bluetooth":"USB",productId:s.getUint16(3,!0),productVersion:s.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=s.getUint16(1,!0)),yi.log({pnpId:c}),t(this,di,"m",wi).call(this,{pnpId:c});break;case"serialNumber":const h=V.decode(s.buffer);yi.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${e}`)}}}var Ei,Mi,ki,Di,Ti,Wi,Ii,_i,Li,Ui,Fi,Ai,Ri,xi,$i,Oi,Bi,Pi;pi=new WeakMap,di=new WeakSet,mi=function(){return this.eventDispatcher.dispatchEvent},vi=function(){return bi.filter((e=>"serialNumber"!=e)).every((e=>e in t(this,pi,"f")))},wi=function(e){yi.log({partialDeviceInformation:e});Object.keys(e).forEach((s=>{t(this,di,"a",mi).call(this,s,{[s]:e[s]})})),Object.assign(t(this,pi,"f"),e),yi.log({deviceInformation:t(this,pi,"f")}),t(this,di,"a",vi)&&(yi.log("completed deviceInformation"),t(this,di,"a",mi).call(this,"deviceInformation",{deviceInformation:this.information}))};const Ni=W("InformationManager",{log:!1}),Vi=["leftInsole","rightInsole","leftGlove","rightGlove","glasses","generic"],qi=["left","right"],zi=["isCharging","getBatteryCurrent","getMtu","getId","getName","setName","getType","setType","getCurrentTime","setCurrentTime"],ji=zi;class Gi{constructor(){Ei.add(this),ki.set(this,!1),Ti.set(this,void 0),Ii.set(this,void 0),Li.set(this,""),Ui.set(this,void 0),xi.set(this,0),Oi.set(this,!1),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}get isCharging(){return t(this,ki,"f")}get batteryCurrent(){return t(this,Ti,"f")}async getBatteryCurrent(){Ni.log("getting battery current...");const e=this.waitForEvent("getBatteryCurrent");this.sendMessage([{type:"getBatteryCurrent"}]),await e}get id(){return t(this,Ii,"f")}get name(){return t(this,Li,"f")}updateName(e){Ni.assertTypeWithError(e,"string"),s(this,Li,e,"f"),Ni.log({updatedName:t(this,Li,"f")}),t(this,Ei,"a",Mi).call(this,"getName",{name:t(this,Li,"f")})}async setName(e){Ni.assertTypeWithError(e,"string"),Ni.assertRangeWithError("newName",e.length,2,30);const t=N.encode(e);Ni.log({setNameData:t});const s=this.waitForEvent("getName");this.sendMessage([{type:"setName",data:t.buffer}]),await s}get type(){return t(this,Ui,"f")}get typeEnum(){return Vi.indexOf(this.type)}updateType(e){t(this,Ei,"m",Fi).call(this,e),e!=this.type?(s(this,Ui,e,"f"),Ni.log({updatedType:t(this,Ui,"f")}),t(this,Ei,"a",Mi).call(this,"getType",{type:t(this,Ui,"f")})):Ni.log("redundant type assignment")}async setType(e){t(this,Ei,"m",Fi).call(this,e);const s=Vi.indexOf(e);t(this,Ei,"m",Ri).call(this,s)}get isInsole(){switch(this.type){case"leftInsole":case"rightInsole":return!0;default:return!1}}get isGlove(){switch(this.type){case"leftGlove":case"rightGlove":return!0;default:return!1}}get side(){switch(this.type){case"leftInsole":case"leftGlove":default:return"left";case"rightInsole":case"rightGlove":return"right"}}get mtu(){return t(this,xi,"f")}get isCurrentTimeSet(){return t(this,Oi,"f")}parseMessage(e,s){switch(Ni.log({messageType:e}),e){case"isCharging":const i=Boolean(s.getUint8(0));Ni.log({isCharging:i}),t(this,Ei,"m",Di).call(this,i);break;case"getBatteryCurrent":const n=s.getFloat32(0,!0);Ni.log({batteryCurrent:n}),t(this,Ei,"m",Wi).call(this,n);break;case"getId":const a=V.decode(s.buffer);Ni.log({id:a}),t(this,Ei,"m",_i).call(this,a);break;case"getName":case"setName":const r=V.decode(s.buffer);Ni.log({name:r}),this.updateName(r);break;case"getType":case"setType":const o=s.getUint8(0),c=Vi[o];Ni.log({typeEnum:o,type:c}),this.updateType(c);break;case"getMtu":let h=s.getUint16(0,!0);"webSocket"!=this.connectionType&&"udp"!=this.connectionType&&(h=Math.min(h,512)),Ni.log({mtu:h}),t(this,Ei,"m",$i).call(this,h);break;case"getCurrentTime":case"setCurrentTime":const l=Number(s.getBigUint64(0,!0));t(this,Ei,"m",Bi).call(this,l);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){s(this,Oi,!1,"f")}}ki=new WeakMap,Ti=new WeakMap,Ii=new WeakMap,Li=new WeakMap,Ui=new WeakMap,xi=new WeakMap,Oi=new WeakMap,Ei=new WeakSet,Mi=function(){return this.eventDispatcher.dispatchEvent},Di=function(e){Ni.assertTypeWithError(e,"boolean"),s(this,ki,e,"f"),Ni.log({isCharging:t(this,ki,"f")}),t(this,Ei,"a",Mi).call(this,"isCharging",{isCharging:t(this,ki,"f")})},Wi=function(e){Ni.assertTypeWithError(e,"number"),s(this,Ti,e,"f"),Ni.log({batteryCurrent:t(this,Ti,"f")}),t(this,Ei,"a",Mi).call(this,"getBatteryCurrent",{batteryCurrent:t(this,Ti,"f")})},_i=function(e){Ni.assertTypeWithError(e,"string"),s(this,Ii,e,"f"),Ni.log({id:t(this,Ii,"f")}),t(this,Ei,"a",Mi).call(this,"getId",{id:t(this,Ii,"f")})},Fi=function(e){Ni.assertEnumWithError(e,Vi)},Ai=function(e){Ni.assertTypeWithError(e,"number"),Ni.assertWithError(e in Vi,`invalid typeEnum ${e}`)},Ri=async function(e){t(this,Ei,"m",Ai).call(this,e);const s=Uint8Array.from([e]);Ni.log({setTypeData:s});const i=this.waitForEvent("getType");this.sendMessage([{type:"setType",data:s.buffer}]),await i},$i=function(e){Ni.assertTypeWithError(e,"number"),t(this,xi,"f")!=e?(s(this,xi,e,"f"),t(this,Ei,"a",Mi).call(this,"getMtu",{mtu:t(this,xi,"f")})):Ni.log("redundant mtu assignment",e)},Bi=function(e){Ni.log({currentTime:e}),s(this,Oi,0!=e||Math.abs(Date.now()-e)<je,"f"),t(this,Oi,"f")||t(this,Ei,"m",Pi).call(this,!1)},Pi=async function(e){Ni.log("setting current time...");const t=new DataView(new ArrayBuffer(8));t.setBigUint64(0,BigInt(Date.now()),!0);const s=this.waitForEvent("getCurrentTime");this.sendMessage([{type:"setCurrentTime",data:t.buffer}],e),await s};const Hi=["none","strongClick100","strongClick60","strongClick30","sharpClick100","sharpClick60","sharpClick30","softBump100","softBump60","softBump30","doubleClick100","doubleClick60","tripleClick100","softFuzz60","strongBuzz100","alert750ms","alert1000ms","strongClick1_100","strongClick2_80","strongClick3_60","strongClick4_30","mediumClick100","mediumClick80","mediumClick60","sharpTick100","sharpTick80","sharpTick60","shortDoubleClickStrong100","shortDoubleClickStrong80","shortDoubleClickStrong60","shortDoubleClickStrong30","shortDoubleClickMedium100","shortDoubleClickMedium80","shortDoubleClickMedium60","shortDoubleSharpTick100","shortDoubleSharpTick80","shortDoubleSharpTick60","longDoubleSharpClickStrong100","longDoubleSharpClickStrong80","longDoubleSharpClickStrong60","longDoubleSharpClickStrong30","longDoubleSharpClickMedium100","longDoubleSharpClickMedium80","longDoubleSharpClickMedium60","longDoubleSharpTick100","longDoubleSharpTick80","longDoubleSharpTick60","buzz100","buzz80","buzz60","buzz40","buzz20","pulsingStrong100","pulsingStrong60","pulsingMedium100","pulsingMedium60","pulsingSharp100","pulsingSharp60","transitionClick100","transitionClick80","transitionClick60","transitionClick40","transitionClick20","transitionClick10","transitionHum100","transitionHum80","transitionHum60","transitionHum40","transitionHum20","transitionHum10","transitionRampDownLongSmooth2_100","transitionRampDownLongSmooth1_100","transitionRampDownMediumSmooth1_100","transitionRampDownMediumSmooth2_100","transitionRampDownShortSmooth1_100","transitionRampDownShortSmooth2_100","transitionRampDownLongSharp1_100","transitionRampDownLongSharp2_100","transitionRampDownMediumSharp1_100","transitionRampDownMediumSharp2_100","transitionRampDownShortSharp1_100","transitionRampDownShortSharp2_100","transitionRampUpLongSmooth1_100","transitionRampUpLongSmooth2_100","transitionRampUpMediumSmooth1_100","transitionRampUpMediumSmooth2_100","transitionRampUpShortSmooth1_100","transitionRampUpShortSmooth2_100","transitionRampUpLongSharp1_100","transitionRampUpLongSharp2_100","transitionRampUpMediumSharp1_100","transitionRampUpMediumSharp2_100","transitionRampUpShortSharp1_100","transitionRampUpShortSharp2_100","transitionRampDownLongSmooth1_50","transitionRampDownLongSmooth2_50","transitionRampDownMediumSmooth1_50","transitionRampDownMediumSmooth2_50","transitionRampDownShortSmooth1_50","transitionRampDownShortSmooth2_50","transitionRampDownLongSharp1_50","transitionRampDownLongSharp2_50","transitionRampDownMediumSharp1_50","transitionRampDownMediumSharp2_50","transitionRampDownShortSharp1_50","transitionRampDownShortSharp2_50","transitionRampUpLongSmooth1_50","transitionRampUpLongSmooth2_50","transitionRampUpMediumSmooth1_50","transitionRampUpMediumSmooth2_50","transitionRampUpShortSmooth1_50","transitionRampUpShortSmooth2_50","transitionRampUpLongSharp1_50","transitionRampUpLongSharp2_50","transitionRampUpMediumSharp1_50","transitionRampUpMediumSharp2_50","transitionRampUpShortSharp1_50","transitionRampUpShortSharp2_50","longBuzz100","smoothHum50","smoothHum40","smoothHum30","smoothHum20","smoothHum10"];var Ji,Ki,Qi,Zi,Xi,Yi,en,tn,sn,nn,an,rn,on,cn,hn,ln,fn,gn,un;const dn=W("VibrationManager",{log:!1}),mn=["front","rear"],pn=["waveformEffect","waveform"],vn=["getVibrationLocations","triggerVibration"],wn=vn,yn=2550,bn=1270;class Sn{constructor(){Ji.add(this),gn.set(this,[]),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}async triggerVibration(e,s=!0){let i;e.forEach((e=>{const{type:s}=e;let n,{locations:a}=e;switch(a=a||this.vibrationLocations.slice(),a=a.filter((e=>this.vibrationLocations.includes(e))),s){case"waveformEffect":{const{segments:s,loopCount:i}=e;n=t(this,Ji,"m",cn).call(this,a,s,i)}break;case"waveform":{const{segments:s}=e;n=t(this,Ji,"m",hn).call(this,a,s)}break;default:throw Error(`invalid vibration type "${s}"`)}dn.log({type:s,arrayBuffer:n}),i=z(i,n)})),await this.sendMessage([{type:"triggerVibration",data:i}],s)}get vibrationLocations(){return t(this,gn,"f")}parseMessage(e,s){if(dn.log({messageType:e}),"getVibrationLocations"!==e)throw Error(`uncaught messageType ${e}`);{const e=Array.from(new Uint8Array(s.buffer)).map((e=>mn[e])).filter(Boolean);t(this,Ji,"m",un).call(this,e)}}}var Cn,En,Mn,kn,Dn,Tn,Wn,In,_n,Ln,Un,Fn,An,Rn,xn,$n,On;gn=new WeakMap,Ji=new WeakSet,Ki=function(){return this.eventDispatcher.dispatchEvent},Qi=function(e){dn.assertTypeWithError(e,"string"),dn.assertWithError(mn.includes(e),`invalid location "${e}"`)},Zi=function(e){t(this,Ji,"m",Yi).call(this,e),e.forEach((e=>{t(this,Ji,"m",Qi).call(this,e)}))},Xi=function(e){t(this,Ji,"m",Zi).call(this,e);let s=0;return e.forEach((e=>{const t=mn.indexOf(e);s|=1<<t})),dn.log({locationsBitmask:s}),dn.assertWithError(s>0,"locationsBitmask must not be zero"),s},Yi=function(e){dn.assertWithError(Array.isArray(e),"passed non-array"),dn.assertWithError(e.length>0,"passed empty array")},en=function(e){dn.assertWithError(Hi.includes(e),`invalid waveformEffect "${e}"`)},tn=function(e){if(null!=e.effect){const s=e.effect;t(this,Ji,"m",en).call(this,s)}else{if(null==e.delay)throw Error("no effect or delay found in waveformEffectSegment");{const{delay:t}=e;dn.assertWithError(t>=0,`delay must be 0ms or greater (got ${t})`),dn.assertWithError(t<=bn,`delay must be 1270ms or less (got ${t})`)}}if(null!=e.loopCount){const{loopCount:s}=e;t(this,Ji,"m",sn).call(this,s)}},sn=function(e){dn.assertTypeWithError(e,"number"),dn.assertWithError(e>=0,`waveformEffectSegmentLoopCount must be 0 or greater (got ${e})`),dn.assertWithError(e<=3,`waveformEffectSegmentLoopCount must be 3 or fewer (got ${e})`)},nn=function(e){t(this,Ji,"m",Yi).call(this,e),dn.assertWithError(e.length<=8,`must have 8 waveformEffectSegments or fewer (got ${e.length})`),e.forEach((e=>{t(this,Ji,"m",tn).call(this,e)}))},an=function(e){dn.assertTypeWithError(e,"number"),dn.assertWithError(e>=0,`waveformEffectSequenceLoopCount must be 0 or greater (got ${e})`),dn.assertWithError(e<=6,`waveformEffectSequenceLoopCount must be 6 or fewer (got ${e})`)},rn=function(e){dn.assertTypeWithError(e.amplitude,"number"),dn.assertWithError(e.amplitude>=0,`amplitude must be 0 or greater (got ${e.amplitude})`),dn.assertWithError(e.amplitude<=1,`amplitude must be 1 or less (got ${e.amplitude})`),dn.assertTypeWithError(e.duration,"number"),dn.assertWithError(e.duration>0,`duration must be greater than 0ms (got ${e.duration}ms)`),dn.assertWithError(e.duration<=yn,`duration must be 2550ms or less (got ${e.duration}ms)`)},on=function(e){t(this,Ji,"m",Yi).call(this,e),dn.assertWithError(e.length<=20,`must have 20 waveformSegments or fewer (got ${e.length})`),e.forEach((e=>{t(this,Ji,"m",rn).call(this,e)}))},cn=function(e,s,i=0){t(this,Ji,"m",nn).call(this,s),t(this,Ji,"m",an).call(this,i);let n=[],a=0;const r=s.some((e=>{const{loopCount:t}=e;return null!=t&&t>0}))||0!=i;for(let e=0;e<s.length||r&&e<8;e++){const t=s[e]||{effect:"none"};if(null!=t.effect){const e=t.effect;n[a++]=Hi.indexOf(e)}else{if(null==t.delay)throw Error("invalid waveformEffectSegment");{const{delay:e}=t;n[a++]=128|Math.floor(e/10)}}}const o=0!=i;for(let e=0;e<s.length||o&&e<8;e++){const t=s[e]?.loopCount||0;0!=e&&4!=e||(n[a]=0);const i=e%4*2;n[a]|=t<<i,3!=e&&7!=e||a++}0!=i&&(n[a++]=i);const c=new DataView(Uint8Array.from(n).buffer);return dn.log({dataArray:n,dataView:c}),t(this,Ji,"m",fn).call(this,e,"waveformEffect",c)},hn=function(e,s){t(this,Ji,"m",on).call(this,s);const i=new DataView(new ArrayBuffer(2*s.length));return s.forEach(((e,t)=>{i.setUint8(2*t,Math.floor(127*e.amplitude)),i.setUint8(2*t+1,Math.floor(e.duration/10))})),dn.log({dataView:i}),t(this,Ji,"m",fn).call(this,e,"waveform",i)},ln=function(e){dn.assertTypeWithError(e,"string"),dn.assertWithError(pn.includes(e),`invalid vibrationType "${e}"`)},fn=function(e,s,i){dn.assertWithError(i?.byteLength>0,"no data received");const n=t(this,Ji,"m",Xi).call(this,e);t(this,Ji,"m",ln).call(this,s);const a=pn.indexOf(s);dn.log({locationsBitmask:n,vibrationTypeIndex:a,dataView:i});const r=z(n,a,i.byteLength,i);return dn.log({data:r}),r},un=function(e){s(this,gn,e,"f"),dn.log("vibrationLocations",e),t(this,Ji,"a",Ki).call(this,"getVibrationLocations",{vibrationLocations:t(this,gn,"f")})};const Bn=W("WifiManager",{log:!1}),Pn=["isWifiAvailable","getWifiSSID","setWifiSSID","getWifiPassword","setWifiPassword","getWifiConnectionEnabled","setWifiConnectionEnabled","isWifiConnected","ipAddress","isWifiSecure"],Nn=["getWifiSSID","getWifiPassword","getWifiConnectionEnabled","isWifiConnected","ipAddress","isWifiSecure"],Vn=Pn;class qn{constructor(){Cn.add(this),Mn.set(this,!1),Tn.set(this,""),In.set(this,""),Ln.set(this,void 0),Fn.set(this,!1),Rn.set(this,void 0),$n.set(this,!1),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Bn.log("requesting required wifi information");const e=Nn.map((e=>({type:e})));this.sendMessage(e,!1)}get isWifiAvailable(){return t(this,Mn,"f")}get wifiSSID(){return t(this,Tn,"f")}async setWifiSSID(e){if(t(this,Cn,"m",Dn).call(this),t(this,Ln,"f"))return void Bn.error("cannot change ssid while wifi connection is enabled");Bn.assertTypeWithError(e,"string"),Bn.assertRangeWithError("wifiSSID",e.length,1,32);const s=N.encode(e);Bn.log({setWifiSSIDData:s});const i=this.waitForEvent("getWifiSSID");this.sendMessage([{type:"setWifiSSID",data:s.buffer}]),await i}get wifiPassword(){return t(this,In,"f")}async setWifiPassword(e){if(t(this,Cn,"m",Dn).call(this),t(this,Ln,"f"))return void Bn.error("cannot change password while wifi connection is enabled");Bn.assertTypeWithError(e,"string"),e.length>0&&Bn.assertRangeWithError("wifiPassword",e.length,8,64);const s=N.encode(e);Bn.log({setWifiPasswordData:s});const i=this.waitForEvent("getWifiPassword");this.sendMessage([{type:"setWifiPassword",data:s.buffer}]),await i}get wifiConnectionEnabled(){return t(this,Ln,"f")}async setWifiConnectionEnabled(e,s=!0){if(t(this,Cn,"m",Dn).call(this),Bn.assertTypeWithError(e,"boolean"),t(this,Ln,"f")==e)return void Bn.log(`redundant wifiConnectionEnabled assignment ${e}`);const i=this.waitForEvent("getWifiConnectionEnabled");this.sendMessage([{type:"setWifiConnectionEnabled",data:Uint8Array.from([Number(e)]).buffer}],s),await i}async toggleWifiConnection(){return this.setWifiConnectionEnabled(!this.wifiConnectionEnabled)}async enableWifiConnection(){return this.setWifiConnectionEnabled(!0)}async disableWifiConnection(){return this.setWifiConnectionEnabled(!1)}get isWifiConnected(){return t(this,Fn,"f")}get ipAddress(){return t(this,Rn,"f")}get isWifiSecure(){return t(this,$n,"f")}parseMessage(e,s){switch(Bn.log({messageType:e}),e){case"isWifiAvailable":const i=Boolean(s.getUint8(0));Bn.log({isWifiAvailable:i}),t(this,Cn,"m",kn).call(this,i);break;case"getWifiSSID":case"setWifiSSID":const n=V.decode(s.buffer);Bn.log({ssid:n}),t(this,Cn,"m",Wn).call(this,n);break;case"getWifiPassword":case"setWifiPassword":const a=V.decode(s.buffer);Bn.log({password:a}),t(this,Cn,"m",_n).call(this,a);break;case"getWifiConnectionEnabled":case"setWifiConnectionEnabled":const r=Boolean(s.getUint8(0));Bn.log({enableWifiConnection:r}),t(this,Cn,"m",Un).call(this,r);break;case"isWifiConnected":const o=Boolean(s.getUint8(0));Bn.log({isWifiConnected:o}),t(this,Cn,"m",An).call(this,o);break;case"ipAddress":let c;4==s.byteLength&&(c=new Uint8Array(s.buffer.slice(0,4)).join(".")),Bn.log({ipAddress:c}),t(this,Cn,"m",xn).call(this,c);break;case"isWifiSecure":const h=Boolean(s.getUint8(0));Bn.log({isWifiSecure:h}),t(this,Cn,"m",On).call(this,h);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){s(this,Tn,"","f"),s(this,In,"","f"),s(this,Rn,"","f"),s(this,Fn,!1,"f"),s(this,Mn,!1,"f")}}var zn,jn,Gn,Hn,Jn,Kn,Qn,Zn,Xn,Yn,ea,ta;Mn=new WeakMap,Tn=new WeakMap,In=new WeakMap,Ln=new WeakMap,Fn=new WeakMap,Rn=new WeakMap,$n=new WeakMap,Cn=new WeakSet,En=function(){return this.eventDispatcher.dispatchEvent},kn=function(e){Bn.assertTypeWithError(e,"boolean"),s(this,Mn,e,"f"),Bn.log({isWifiAvailable:t(this,Mn,"f")}),t(this,Cn,"a",En).call(this,"isWifiAvailable",{isWifiAvailable:t(this,Mn,"f")})},Dn=function(){Bn.assertWithError(t(this,Mn,"f"),"wifi is not available")},Wn=function(e){Bn.assertTypeWithError(e,"string"),s(this,Tn,e,"f"),Bn.log({wifiSSID:t(this,Tn,"f")}),t(this,Cn,"a",En).call(this,"getWifiSSID",{wifiSSID:t(this,Tn,"f")})},_n=function(e){Bn.assertTypeWithError(e,"string"),s(this,In,e,"f"),Bn.log({wifiPassword:t(this,In,"f")}),t(this,Cn,"a",En).call(this,"getWifiPassword",{wifiPassword:t(this,In,"f")})},Un=function(e){Bn.log({wifiConnectionEnabled:e}),s(this,Ln,e,"f"),t(this,Cn,"a",En).call(this,"getWifiConnectionEnabled",{wifiConnectionEnabled:e})},An=function(e){Bn.assertTypeWithError(e,"boolean"),s(this,Fn,e,"f"),Bn.log({isWifiConnected:t(this,Fn,"f")}),t(this,Cn,"a",En).call(this,"isWifiConnected",{isWifiConnected:t(this,Fn,"f")})},xn=function(e){s(this,Rn,e,"f"),Bn.log({ipAddress:t(this,Rn,"f")}),t(this,Cn,"a",En).call(this,"ipAddress",{ipAddress:t(this,Rn,"f")})},On=function(e){Bn.assertTypeWithError(e,"boolean"),s(this,$n,e,"f"),Bn.log({isWifiSecure:t(this,$n,"f")}),t(this,Cn,"a",En).call(this,"isWifiSecure",{isWifiSecure:t(this,$n,"f")})};const sa=W("BaseConnectionManager",{log:!1}),ia=["webBluetooth","noble","client","webSocket","udp"],na=["notConnected","connecting","connected","disconnecting"],aa=[...na,"connectionStatus","isConnected"],ra=[...zi,...Ts,...hs,...vn,...$e,...ci,...Pn,...ts],oa=["batteryLevel"],ca=["rx","tx"],ha=[...oa,...bi,...ca,...ra,"smp"];class la{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get canUpdateFirmware(){return!1}get type(){return this.baseConstructor.type}constructor(){zn.add(this),Jn.set(this,"notConnected"),Zn.set(this,[]),Xn.set(this,!1),this.defaultMtu=23,this.mtu=this.defaultMtu,ea.set(this,new R(t(this,zn,"m",ta).bind(this),5e3)),t(this,zn,"m",Hn).call(this)}get status(){return t(this,Jn,"f")}set status(e){sa.assertEnumWithError(e,na),t(this,Jn,"f")!=e?(sa.log(`new connection status "${e}"`),s(this,Jn,e,"f"),this.onStatusUpdated(this.status),this.isConnected?t(this,ea,"f").start():t(this,ea,"f").stop(),"notConnected"==t(this,Jn,"f")&&(this.mtu=this.defaultMtu)):sa.log(`tried to assign same connection status "${e}"`)}get isConnected(){return"connected"==this.status}get isAvailable(){return!1}assertIsNotConnected(){sa.assertWithError(!this.isConnected,"device is already connected")}assertIsConnected(){sa.assertWithError(this.isConnected,"device is not connected")}assertIsConnectedAndNotDisconnecting(){this.assertIsConnected(),t(this,zn,"m",Qn).call(this)}async connect(){this.assertIsNotConnected(),t(this,zn,"m",Kn).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){this.assertIsNotConnected(),t(this,zn,"m",Kn).call(this),sa.assertWithError(this.canReconnect,"unable to reconnect"),this.status="connecting",sa.log("attempting to reconnect...")}async disconnect(){this.assertIsConnected(),t(this,zn,"m",Qn).call(this),this.status="disconnecting",sa.log("disconnecting from device...")}async sendSmpMessage(e){this.assertIsConnectedAndNotDisconnecting(),sa.log("sending smp message",e)}async sendTxMessages(e,i=!0){if(this.assertIsConnectedAndNotDisconnecting(),e&&(t(this,Zn,"f").push(...e),sa.log(`appended ${e.length} messages`)),!i)return void sa.log("not sending immediately - waiting until later");if(t(this,Xn,"f"))return void sa.log("already sending messages - waiting until later");if(0==t(this,Zn,"f").length)return void sa.log("no pendingMessages");s(this,Xn,!0,"f"),sa.log("sendTxMessages",t(this,Zn,"f").slice());const n=t(this,Zn,"f").map((e=>{t(jn,jn,"m",Gn).call(jn,e.type);const s=ra.indexOf(e.type),i=new DataView(new ArrayBuffer(2));return i.setUint16(0,e.data?.byteLength||0,!0),z(s,i,e.data)}));if(t(this,Zn,"f").length=0,this.mtu)for(;n.length>0;){if(n.every((e=>e.byteLength>this.mtu-3))){sa.log("every arrayBuffer is too big to send");break}sa.log("remaining arrayBuffers.length",n.length);let e=0,t=0;n.some((s=>{if(e+s.byteLength>this.mtu-3)return sa.log(`stopping appending arrayBuffers ( length ${s.byteLength} too much)`),!0;sa.log(`allowing arrayBuffer with length ${s.byteLength}`),t++,e+=s.byteLength}));const s=n.splice(0,t);sa.log({arrayBufferCount:t,arrayBuffersToSend:s});const i=z(...s);sa.log("sending arrayBuffer (partitioned)",i),await this.sendTxData(i)}else{const e=z(...n);sa.log("sending arrayBuffer (all)",e),await this.sendTxData(e)}s(this,Xn,!1,"f"),this.sendTxMessages(void 0,!0)}async sendTxData(e){sa.log("sendTxData",e)}parseRxMessage(e){bt(e,ra,t(this,zn,"m",Yn).bind(this),null,!0),this.onMessagesReceived()}clear(){s(this,Xn,!1,"f"),t(this,Zn,"f").length=0}remove(){this.clear(),this.onStatusUpdated=void 0,this.onMessageReceived=void 0,this.onMessagesReceived=void 0}}jn=la,Jn=new WeakMap,Zn=new WeakMap,Xn=new WeakMap,ea=new WeakMap,zn=new WeakSet,Gn=function(e){sa.assertEnumWithError(e,ra)},Hn=function(){sa.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},Kn=function(){sa.assertWithError("connecting"!=this.status,"device is already connecting")},Qn=function(){sa.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},Yn=function(e,t){sa.log({messageType:e,dataView:t}),this.onMessageReceived(e,t)},ta=function(){this.isConnected||(sa.log("timer detected disconnection"),this.status="notConnected")};const fa=W("EventUtils",{log:!1});function ga(e,t){let s=e.addEventListener||e.addListener||e.on||e.AddEventListener;fa.assertWithError(s,"no add listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}function ua(e,t){let s=e.removeEventListener||e.removeListener||e.RemoveEventListener;fa.assertWithError(s,"no remove listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}const da=W("bluetoothUUIDs",{log:!1});if(n)var ma=window.BluetoothUUID;function pa(e){return da.assertTypeWithError(e,"string"),da.assertWithError(4==e.length,"value must be 4 characters long"),`ea6d${e}-a725-4f9b-893d-c3913e33b39f`}function va(e){return ma?.getCharacteristic?.(e)}function wa(e){return ma?.getService?.(e)}const ya=Object.freeze({services:{deviceInformation:{uuid:wa("device_information"),characteristics:{manufacturerName:{uuid:va("manufacturer_name_string")},modelNumber:{uuid:va("model_number_string")},hardwareRevision:{uuid:va("hardware_revision_string")},firmwareRevision:{uuid:va("firmware_revision_string")},softwareRevision:{uuid:va("software_revision_string")},pnpId:{uuid:va("pnp_id")},serialNumber:{uuid:va("serial_number_string")}}},battery:{uuid:wa("battery_service"),characteristics:{batteryLevel:{uuid:va("battery_level")}}},main:{uuid:pa("0000"),characteristics:{rx:{uuid:pa("1000")},tx:{uuid:pa("1001")}}},smp:{uuid:"8d53dc1d-1db7-4cd3-868b-8a527460aa84",characteristics:{smp:{uuid:"da2e7828-fbce-4e01-ae9e-261174997c48"}}}}}),ba=[ya.services.main.uuid],Sa=[ya.services.deviceInformation.uuid,ya.services.battery.uuid,ya.services.smp.uuid];function Ca(e){e=e.toString().toLowerCase();return Object.keys(ya.services).find((t=>{let s=ya.services[t].uuid.toString();return 4==e.length&&(s=s.slice(4,8)),e.includes("-")||(s=s.replaceAll("-","")),e==s}))}const Ea=[],Ma=[];function ka(e){var t;return e=e.toString().toLowerCase(),Object.values(ya.services).some((s=>{const i=Object.keys(s.characteristics);return t=i.find((t=>{let i=s.characteristics[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))})),t}function Da(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"rx":case"tx":case"smp":t.read=!1}switch(e){case"batteryLevel":case"rx":case"smp":t.notify=!0}if("smp"===e)t.writeWithoutResponse=!0;if("tx"===e)t.write=!0;return t}Object.values(ya.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((s=>{const i=e.characteristics[s];ba.includes(e.uuid)&&(Ea.push(i.uuid),t.push(s)),Ma.push(i.uuid)}))}),[]);const Ta=W("BluetoothConnectionManager",{log:!1});class Wa extends la{constructor(){super(...arguments),this.isInRange=!0}get isAvailable(){return!0}onCharacteristicValueChanged(e,t){"rx"==e?this.parseRxMessage(t):this.onMessageReceived?.(e,t)}async writeCharacteristic(e,t){Ta.log("writeCharacteristic",...arguments)}async sendSmpMessage(e){super.sendSmpMessage(e),await this.writeCharacteristic("smp",e)}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&await this.writeCharacteristic("tx",e)}}var Ia,_a,La,Ua,Fa,Aa,Ra,xa,$a,Oa,Ba;const Pa=W("WebBluetoothConnectionManager",{log:!1});var Na;n&&(Na=window.navigator.bluetooth);class Va extends Wa{constructor(){super(...arguments),Ia.add(this),_a.set(this,{characteristicvaluechanged:t(this,Ia,"m",$a).bind(this)}),La.set(this,{gattserverdisconnected:t(this,Ia,"m",Ba).bind(this)}),Ua.set(this,void 0),Fa.set(this,new Map),Aa.set(this,new Map)}get bluetoothId(){return this.device.id}get canUpdateFirmware(){return t(this,Aa,"f").has("smp")}static get isSupported(){return Boolean(Na)}static get type(){return"webBluetooth"}get device(){return t(this,Ua,"f")}set device(e){t(this,Ua,"f")!=e?(t(this,Ua,"f")&&ua(t(this,Ua,"f"),t(this,La,"f")),e&&ga(e,t(this,La,"f")),s(this,Ua,e,"f")):Pa.log("tried to assign the same BluetoothDevice")}get server(){return t(this,Ua,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const e=await Na.requestDevice({filters:[{services:ba}],optionalServices:n?Sa:[]});Pa.log("got BluetoothDevice"),this.device=e,Pa.log("connecting to device...");const s=await this.server.connect();Pa.log(`connected to device? ${s.connected}`),await t(this,Ia,"m",Ra).call(this),Pa.log("fully connected"),this.status="connected"}catch(e){Pa.error(e),this.status="notConnected",this.server?.disconnect(),t(this,Ia,"m",xa).call(this)}}async disconnect(){await t(this,Ia,"m",xa).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(e,s){super.writeCharacteristic(e,s);const i=t(this,Aa,"f").get(e);Pa.assertWithError(i,`${e} characteristic not found`),Pa.log("writing characteristic",i,s);const n=i.properties||Da(e);n.writeWithoutResponse?(Pa.log("writing without response"),await i.writeValueWithoutResponse(s)):(Pa.log("writing with response"),await i.writeValueWithResponse(s)),Pa.log("wrote characteristic"),n.read&&!n.notify&&(Pa.log("reading value after write..."),await i.readValue(),(c||h)&&t(this,Ia,"m",Oa).call(this,i))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect();try{await this.server.connect()}catch(e){Pa.error(e),this.isInRange=!1}this.isConnected?(Pa.log("successfully reconnected!"),await t(this,Ia,"m",Ra).call(this),this.status="connected"):(Pa.log("unable to reconnect"),this.status="notConnected")}remove(){super.remove(),this.device=void 0}}_a=new WeakMap,La=new WeakMap,Ua=new WeakMap,Fa=new WeakMap,Aa=new WeakMap,Ia=new WeakSet,Ra=async function(){t(this,Ia,"m",xa).call(this),Pa.log("getting services...");const e=await this.server.getPrimaryServices();Pa.log("got services",e.length),Pa.log("getting characteristics...");for(const s in e){const i=e[s];Pa.log({service:i});const n=Ca(i.uuid);Pa.assertWithError(n,`no name found for service uuid "${i.uuid}"`),Pa.log(`got "${n}" service`),i.name=n,t(this,Fa,"f").set(n,i),Pa.log(`getting characteristics for "${n}" service`);const a=await i.getCharacteristics();Pa.log(`got characteristics for "${n}" service`);for(const e in a){const s=a[e];Pa.log({characteristic:s});const i=ka(s.uuid);Pa.assertWithError(Boolean(i),`no name found for characteristic uuid "${s.uuid}" in "${n}" service`),Pa.log(`got "${i}" characteristic in "${n}" service`),s.name=i,t(this,Aa,"f").set(i,s),ga(s,t(this,_a,"f"));const r=s.properties||Da(i);r.notify&&(Pa.log(`starting notifications for "${i}" characteristic`),await s.startNotifications()),r.read&&(Pa.log(`reading "${i}" characteristic...`),await s.readValue(),(c||h)&&t(this,Ia,"m",Oa).call(this,s))}}},xa=async function(){this.device&&ua(this.device,t(this,La,"f"));const e=Array.from(t(this,Aa,"f").keys()).map((e=>{const s=t(this,Aa,"f").get(e);ua(s,t(this,_a,"f"));if((s.properties||Da(e)).notify)return Pa.log(`stopping notifications for "${e}" characteristic`),s.stopNotifications()}));return Promise.allSettled(e)},$a=function(e){Pa.log("oncharacteristicvaluechanged");const s=e.target;t(this,Ia,"m",Oa).call(this,s)},Oa=function(e){Pa.log("onCharacteristicValue");const t=e.name;Pa.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),Pa.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const s=e.value;Pa.assertWithError(s,`no data found for "${t}" characteristic`),Pa.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(s.buffer)));try{this.onCharacteristicValueChanged(t,s)}catch(e){Pa.error(e)}},Ba=function(){Pa.log("gattserverdisconnected"),this.status="notConnected"};const qa=4294967296,za=9007199254740992;const ja={encode:function(e){let t,s=new ArrayBuffer(256),i=new DataView(s),n=0;function a(e){let a=s.byteLength;const r=n+e;for(;a<r;)a<<=1;if(a!==s.byteLength){const e=i;s=new ArrayBuffer(a),i=new DataView(s);const t=n+3>>2;for(let s=0;s<t;++s)i.setUint32(s<<2,e.getUint32(s<<2))}return t=e,i}function r(){n+=t}function o(e){r(a(1).setUint8(n,e))}function c(e){const t=a(e.length);for(let s=0;s<e.length;++s)t.setUint8(n+s,e[s]);r()}function h(e,t){t<24?o(e<<5|t):t<256?(o(e<<5|24),o(t)):t<65536?(o(e<<5|25),function(e){r(a(2).setUint16(n,e))}(t)):t<4294967296?(o(e<<5|26),function(e){r(a(4).setUint32(n,e))}(t)):(o(e<<5|27),function(e){const t=e%qa,s=(e-t)/qa,i=a(8);i.setUint32(n,s),i.setUint32(n+4,t),r()}(t))}if(function e(t){let s;const i=[];let l;if(!1===t)return o(244);if(!0===t)return o(245);if(null===t)return o(246);if(void 0===t)return o(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(t>=0&&t<=za)return h(0,t);if(-za<=t&&t<0)return h(1,-(t+1))}return o(251),function(e){r(a(8).setFloat64(n,e))}(t);case"string":for(s=0;s<t.length;++s){let e=t.charCodeAt(s);e<128?i.push(e):e<2048?(i.push(192|e>>6),i.push(128|63&e)):e<55296?(i.push(224|e>>12),i.push(128|e>>6&63),i.push(128|63&e)):(e=(1023&e)<<10,e|=1023&t.charCodeAt(++s),e+=65536,i.push(240|e>>18),i.push(128|e>>12&63),i.push(128|e>>6&63),i.push(128|63&e))}return h(3,i.length),c(i);default:if(Array.isArray(t))for(l=t.length,h(4,l),s=0;s<l;++s)e(t[s]);else if(t instanceof Uint8Array)h(2,t.length),c(t);else{const i=Object.keys(t);for(l=i.length,h(5,l),s=0;s<l;++s){const n=i[s];e(n),e(t[n])}}}}(e),"slice"in s)return s.slice(0,n);const l=new ArrayBuffer(n),f=new DataView(l);for(let e=0;e<n;++e)f.setUint8(e,i.getUint8(e));return l},decode:function(e,t,s){const i=new DataView(e);let n=0;function a(e,t){return n+=e,t}function r(t){return a(t,new Uint8Array(e,n,t))}function o(){return a(1,i.getUint8(n))}function c(){return a(2,i.getUint16(n))}function h(){return a(4,i.getUint32(n))}function l(){return 255===i.getUint8(n)&&(n+=1,!0)}function f(e){if(e<24)return e;if(24===e)return o();if(25===e)return c();if(26===e)return h();if(27===e)return h()*qa+h();if(31===e)return-1;throw new Error("Invalid length encoding")}function g(e){const t=o();if(255===t)return-1;const s=f(31&t);if(s<0||t>>5!==e)throw new Error("Invalid indefinite length element");return s}function u(e,t){for(let s=0;s<t;++s){let s=o();128&s&&(s<224?(s=(31&s)<<6|63&o(),t-=1):s<240?(s=(15&s)<<12|(63&o())<<6|63&o(),t-=2):(s=(15&s)<<18|(63&o())<<12|(63&o())<<6|63&o(),t-=3)),s<65536?e.push(s):(s-=65536,e.push(55296|s>>10),e.push(56320|1023&s))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof s&&(s=function(){});const d=function e(){const h=o(),d=h>>5,m=31&h;let p,v;if(7===d)switch(m){case 25:return function(){const e=new ArrayBuffer(4),t=new DataView(e),s=c(),i=32768&s;let n=31744&s;const a=1023&s;if(31744===n)n=261120;else if(0!==n)n+=114688;else if(0!==a)return(i?-1:1)*a*5.960464477539063e-8;return t.setUint32(0,i<<16|n<<13|a<<13),t.getFloat32(0)}();case 26:return a(4,i.getFloat32(n));case 27:return a(8,i.getFloat64(n))}if(v=f(m),v<0&&(d<2||d>6))throw new Error("Invalid length");const w=[];let y;const b={};switch(d){case 0:return v;case 1:return-1-v;case 2:if(v<0){const e=[];let t=0;for(;(v=g(d))>=0;)t+=v,e.push(r(v));const s=new Uint8Array(t);let i=0;for(p=0;p<e.length;++p)s.set(e[p],i),i+=e[p].length;return s}return r(v);case 3:if(v<0)for(;(v=g(d))>=0;)u(w,v);else u(w,v);return String.fromCharCode.apply(null,w);case 4:if(v<0)for(y=[];!l();)y.push(e());else for(y=new Array(v),p=0;p<v;++p)y[p]=e();return y;case 5:for(p=0;p<v||v<0&&!l();++p){b[e()]=e()}return b;case 6:return t(e(),v);case 7:switch(v){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return s(v)}}}();if(n!==e.byteLength)throw new Error("Remaining bytes");return d}},Ga=W("mcumgr",{log:!1}),Ha=0,Ja=1,Ka=2,Qa=3,Za=0,Xa=1,Ya=8,er=0,tr=2,sr=3,ir=5,nr=0,ar=1,rr=5,or=0;class cr{constructor(){this._mtu=256,this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}onMessage(e){return this._messageCallback=e,this}onImageUploadNext(e){return this._imageUploadNextCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}onFileUploadNext(e){return this._fileUploadNextCallback=e,this}onFileUploadProgress(e){return this._fileUploadProgressCallback=e,this}onFileUploadFinished(e){return this._fileUploadFinishedCallback=e,this}onFileDownloadNext(e){return this._fileDownloadNextCallback=e,this}onFileDownloadProgress(e){return this._fileDownloadProgressCallback=e,this}onFileDownloadFinished(e){return this._fileDownloadFinishedCallback=e,this}_getMessage(e,t,s,i){let n=[];void 0!==i&&(n=[...new Uint8Array(ja.encode(i))]);const a=255&n.length,r=[e,0,n.length>>8,a,t>>8,255&t,this._seq,s,...n];return this._seq=(this._seq+1)%256,r}_notification(e){Ga.log("mcumgr - message received");const t=new Uint8Array(e);this._buffer=new Uint8Array([...this._buffer,...t]);const s=256*this._buffer[2]+this._buffer[3];this._buffer.length<s+8||(this._processMessage(this._buffer.slice(0,s+8)),this._buffer=this._buffer.slice(s+8))}_processMessage(e){const[t,,s,i,n,a,,r]=e,o=ja.decode(e.slice(8).buffer),c=256*s+i,h=256*n+a;return Ga.log("mcumgr - Process Message - Group: "+h+", Id: "+r+", Off: "+o.off),h===Xa&&r===ar&&o.off?(this._uploadOffset=o.off,void this._uploadNext()):t===Qa&&h===Ya&&r===or&&o.off?(this._uploadFileOffset=o.off,void this._uploadFileNext()):t===Ja&&h===Ya&&r===or?(this._downloadFileOffset+=o.data.length,null!=o.len&&(this._downloadFileLength=o.len),Ga.log("downloaded "+this._downloadFileOffset+" bytes of "+this._downloadFileLength),this._downloadFileLength>0&&this._fileDownloadProgressCallback({percentage:Math.floor(this._downloadFileOffset/this._downloadFileLength*100)}),this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}),void this._downloadFileNext()):void(this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}))}cmdReset(){return this._getMessage(Ka,Za,ir)}smpEcho(e){return this._getMessage(Ka,Za,er,{d:e})}cmdImageState(){return this._getMessage(Ha,Xa,nr)}cmdImageErase(){return this._getMessage(Ka,Xa,rr,{})}cmdImageTest(e){return this._getMessage(Ka,Xa,nr,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._getMessage(Ka,Xa,nr,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(!this._uploadImage)return;if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-ja.encode(e).byteLength-8-3-5;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t;const s=this._getMessage(Ka,Xa,ar,e);Ga.log("mcumgr - _uploadNext: Message Length: "+s.length),this._imageUploadNextCallback({packet:s})}async reset(){this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}async cmdUpload(e,t=0){this._uploadIsInProgress?Ga.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async cmdUploadFile(e,t){this._uploadIsInProgress?Ga.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadFileOffset=0,this._uploadFile=e,this._uploadFilename=t,this._uploadFileNext())}async _uploadFileNext(){if(Ga.log("uploadFileNext - offset: "+this._uploadFileOffset+", length: "+this._uploadFile.byteLength),this._uploadFileOffset>=this._uploadFile.byteLength)return this._uploadIsInProgress=!1,void this._fileUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadFileOffset};0===this._uploadFileOffset&&(e.len=this._uploadFile.byteLength),e.name=this._uploadFilename,this._fileUploadProgressCallback({percentage:Math.floor(this._uploadFileOffset/this._uploadFile.byteLength*100)});const t=this._mtu-ja.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadFile.slice(this._uploadFileOffset,this._uploadFileOffset+t)),this._uploadFileOffset+=t;const s=this._getMessage(Ka,Ya,or,e);Ga.log("mcumgr - _uploadNext: Message Length: "+s.length),this._fileUploadNextCallback({packet:s})}async cmdDownloadFile(e,t){this._downloadIsInProgress?Ga.error("Download is already in progress."):(this._downloadIsInProgress=!0,this._downloadFileOffset=0,this._downloadFileLength=0,this._downloadRemoteFilename=e,this._downloadLocalFilename=t,this._downloadFileNext())}async _downloadFileNext(){if(this._downloadFileLength>0&&this._downloadFileOffset>=this._downloadFileLength)return this._downloadIsInProgress=!1,void this._fileDownloadFinishedCallback();const e={off:this._downloadFileOffset};0===this._downloadFileOffset&&(e.name=this._downloadRemoteFilename);const t=this._getMessage(Ha,Ya,or,e);Ga.log("mcumgr - _downloadNext: Message Length: "+t.length),this._fileDownloadNextCallback({packet:t})}async imageInfo(e){const t={},s=new Uint8Array(e);if(s.length<32)throw new Error("Invalid image (too short file)");if(61!==s[0]||184!==s[1]||243!==s[2]||150!==s[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==s[4]||0!==s[5]||0!==s[6]||0!==s[7])throw new Error("Invalid image (wrong load address)");const i=s[8]+256*s[9];if(0!==s[10]||0!==s[11])throw new Error("Invalid image (wrong protected TLV area size)");const n=s[12]+256*s[13]+65536*s[14]+s[15]*2**24;if(t.imageSize=n,s.length<n+i)throw new Error("Invalid image (wrong image size)");if(0!==s[16]||0!==s[17]||0!==s[18]||0!==s[19])throw new Error("Invalid image (wrong flags)");const a=`${s[20]}.${s[21]}.${s[22]+256*s[23]}`;return t.version=a,t.hash=[...new Uint8Array(await this._hash(e.slice(0,n+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}var hr,lr,fr,gr,ur,dr,mr,pr,vr,wr,yr,br,Sr,Cr,Er,Mr,kr,Dr,Tr,Wr,Ir;const _r=W("FirmwareManager",{log:!1}),Lr=["smp"],Ur=[...Lr,"firmwareImages","firmwareUploadProgress","firmwareStatus","firmwareUploadComplete"],Fr=["idle","uploading","uploaded","pending","testing","erasing"];class Ar{constructor(){hr.add(this),fr.set(this,"idle"),ur.set(this,void 0),pr.set(this,void 0),vr.set(this,new cr),t(this,hr,"m",wr).call(this),J(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}parseMessage(e,s){if(_r.log({messageType:e}),"smp"!==e)throw Error(`uncaught messageType ${e}`);t(this,vr,"f")._notification(Array.from(new Uint8Array(s.buffer))),t(this,hr,"a",lr).call(this,"smp",{dataView:s})}async uploadFirmware(e){_r.log("uploadFirmware",e);const s=this.waitForEvent("firmwareUploadComplete");await this.getImages();const i=await H(e),n=await t(this,vr,"f").imageInfo(i);_r.log({imageInfo:n}),t(this,vr,"f").cmdUpload(i,1),t(this,hr,"m",gr).call(this,"uploading"),await s}get status(){return t(this,fr,"f")}get images(){return t(this,ur,"f")}async getImages(){const e=this.waitForEvent("firmwareImages");_r.log("getting firmware image state..."),this.sendMessage(Uint8Array.from(t(this,vr,"f").cmdImageState()).buffer),await e}async testImage(e=1){if(t(this,hr,"m",mr).call(this,e),t(this,hr,"m",dr).call(this),!t(this,ur,"f")[e])return void _r.log(`image ${e} not found`);if(1==t(this,ur,"f")[e].pending)return void _r.log(`image ${e} is already pending`);if(t(this,ur,"f")[e].empty)return void _r.log(`image ${e} is empty`);const s=this.waitForEvent("smp");_r.log("testing firmware image..."),this.sendMessage(Uint8Array.from(t(this,vr,"f").cmdImageTest(t(this,ur,"f")[e].hash)).buffer),await s}async eraseImage(){t(this,hr,"m",dr).call(this);const e=this.waitForEvent("smp");_r.log("erasing image..."),this.sendMessage(Uint8Array.from(t(this,vr,"f").cmdImageErase()).buffer),t(this,hr,"m",gr).call(this,"erasing"),await e,await this.getImages()}async confirmImage(e=0){if(t(this,hr,"m",mr).call(this,e),t(this,hr,"m",dr).call(this),!0===t(this,ur,"f")[e].confirmed)return void _r.log(`image ${e} is already confirmed`);const s=this.waitForEvent("smp");_r.log("confirming image..."),this.sendMessage(Uint8Array.from(t(this,vr,"f").cmdImageConfirm(t(this,ur,"f")[e].hash)).buffer),await s}async echo(e){_r.assertTypeWithError(e,"string");const s=this.waitForEvent("smp");_r.log("sending echo..."),this.sendMessage(Uint8Array.from(t(this,vr,"f").smpEcho(e)).buffer),await s}async reset(){const e=this.waitForEvent("smp");_r.log("resetting..."),this.sendMessage(Uint8Array.from(t(this,vr,"f").cmdReset()).buffer),await e}get mtu(){return t(this,pr,"f")}set mtu(e){s(this,pr,e,"f"),t(this,vr,"f")._mtu=e}}var Rr,xr,$r,Or,Br,Pr,Nr,Vr,qr,zr,jr,Gr,Hr,Jr,Kr,Qr,Zr,Xr;fr=new WeakMap,ur=new WeakMap,pr=new WeakMap,vr=new WeakMap,hr=new WeakSet,lr=function(){return this.eventDispatcher.dispatchEvent},gr=function(e){_r.assertEnumWithError(e,Fr),t(this,fr,"f")!=e?(s(this,fr,e,"f"),_r.log({firmwareStatus:t(this,fr,"f")}),t(this,hr,"a",lr).call(this,"firmwareStatus",{firmwareStatus:t(this,fr,"f")})):_r.log(`redundant firmwareStatus assignment "${e}"`)},dr=function(){_r.assertWithError(t(this,ur,"f"),"didn't get imageState")},mr=function(e){_r.assertTypeWithError(e,"number"),_r.assertWithError(0==e||1==e,"imageIndex must be 0 or 1")},wr=function(){t(this,vr,"f").onMessage(t(this,hr,"m",yr).bind(this)),t(this,vr,"f").onFileDownloadNext(t(this,hr,"m",br)),t(this,vr,"f").onFileDownloadProgress(t(this,hr,"m",Sr).bind(this)),t(this,vr,"f").onFileDownloadFinished(t(this,hr,"m",Cr).bind(this)),t(this,vr,"f").onFileUploadNext(t(this,hr,"m",Er).bind(this)),t(this,vr,"f").onFileUploadProgress(t(this,hr,"m",Mr).bind(this)),t(this,vr,"f").onFileUploadFinished(t(this,hr,"m",kr).bind(this)),t(this,vr,"f").onImageUploadNext(t(this,hr,"m",Dr).bind(this)),t(this,vr,"f").onImageUploadProgress(t(this,hr,"m",Tr).bind(this)),t(this,vr,"f").onImageUploadFinished(t(this,hr,"m",Wr).bind(this))},yr=function({op:e,group:s,id:i,data:n,length:a}){switch(_r.log("onMcuMessage",...arguments),s){case Za:switch(i){case er:_r.log(`echo "${n.r}"`);break;case tr:_r.table(n.tasks);break;case sr:_r.log(n)}break;case Xa:if(i===nr)t(this,hr,"m",Ir).call(this,n);break;default:throw Error(`uncaught mcuMessage group ${s}`)}},br=function(){_r.log("onMcuFileDownloadNext",...arguments)},Sr=function(){_r.log("onMcuFileDownloadProgress",...arguments)},Cr=function(){_r.log("onMcuFileDownloadFinished",...arguments)},Er=function(){_r.log("onMcuFileUploadNext")},Mr=function(){_r.log("onMcuFileUploadProgress")},kr=function(){_r.log("onMcuFileUploadFinished")},Dr=function({packet:e}){_r.log("onMcuImageUploadNext"),this.sendMessage(Uint8Array.from(e).buffer)},Tr=function({percentage:e}){const s=e/100;_r.log("onMcuImageUploadProgress",...arguments),t(this,hr,"a",lr).call(this,"firmwareUploadProgress",{progress:s})},Wr=async function(){_r.log("onMcuImageUploadFinished",...arguments),await this.getImages(),t(this,hr,"a",lr).call(this,"firmwareUploadProgress",{progress:100}),t(this,hr,"a",lr).call(this,"firmwareUploadComplete",{})},Ir=function({images:e}){if(!e)return void _r.log("no images found");s(this,ur,e,"f"),_r.log("images",t(this,ur,"f"));let i="idle";2==t(this,ur,"f").length&&(t(this,ur,"f")[1].bootable?t(this,ur,"f")[0].confirmed?t(this,ur,"f")[1].pending?(_r.log("reset to upload to the new firmware image"),i="pending"):(_r.log("Slot 1 has a valid image. run testImage() to test it or upload a different image."),i="uploaded"):(_r.log('Slot 0 has a valid image. Click "Confirm Image" to confirm it or wait and the device will swap images back.'),i="testing"):_r.warn('Slot 1 has a invalid image. Click "Erase Image" to erase it or upload a different image')),1==t(this,ur,"f").length&&(t(this,ur,"f").push({slot:1,empty:!0,version:"Empty",pending:!1,confirmed:!1,bootable:!1,active:!1,permanent:!1}),_r.log("Select a firmware upload image to upload to slot 1.")),t(this,hr,"m",gr).call(this,i),t(this,hr,"a",lr).call(this,"firmwareImages",{firmwareImages:t(this,ur,"f")})};const Yr=W("DeviceManager",{log:!1}),eo=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class to{constructor(){if(Rr.add(this),xr.set(this,{getType:t(this,Rr,"m",$r).bind(this),isConnected:t(this,Rr,"m",Qr).bind(this)}),Or.set(this,[]),Br.set(this,!1),Pr.set(this,{devices:[]}),Nr.set(this,void 0),qr.set(this,"BS.Device"),Hr.set(this,[]),Jr.set(this,new _(this,eo)),to.shared&&this!=to.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(e){ga(e,t(this,xr,"f"))}OnDeviceConnectionStatusUpdated(e,s){if("notConnected"==s&&!e.canReconnect&&t(this,Hr,"f").includes(e)){const s=t(this,Hr,"f").indexOf(e);this.AvailableDevices.splice(s,1),t(this,Rr,"m",Zr).call(this)}}get ConnectedDevices(){return t(this,Or,"f")}get UseLocalStorage(){return t(this,Br,"f")}set UseLocalStorage(e){t(this,Rr,"m",Vr).call(this),Yr.assertTypeWithError(e,"boolean"),s(this,Br,e,"f"),t(this,Br,"f")&&!t(this,Nr,"f")&&t(this,Rr,"m",jr).call(this)}get CanUseLocalStorage(){return n&&window.localStorage}get AvailableDevices(){return t(this,Hr,"f")}get CanGetDevices(){return n&&navigator.bluetooth?.getDevices}async GetDevices(){if(!n)return void Yr.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void Yr.warn("bluetooth is not available in this browser");if(c)return void Yr.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void Yr.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void Yr.log("CanGetDevices is false");t(this,Nr,"f")||t(this,Rr,"m",jr).call(this);const e=t(this,Nr,"f");if(!e.devices||0==e.devices.length)return void Yr.log("no devices found in configuration");const s=await navigator.bluetooth.getDevices();return Yr.log({bluetoothDevices:s}),s.forEach((s=>{if(!s.gatt)return;let i=e.devices.find((e=>s.id==e.bluetoothId));if(!i)return;let n=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));const a=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));if(a)return void(n&&n?.bluetoothId==a.bluetoothId&&n!=a&&(this.AvailableDevices[t(this,Hr,"f").indexOf(a)]=n));if(n)return void this.AvailableDevices.push(n);const r=new Ec,o=new Va;o.device=s,s.name&&r._informationManager.updateName(s.name),r._informationManager.updateType(i.type),r.connectionManager=o,this.AvailableDevices.push(r)})),t(this,Rr,"m",Zr).call(this),this.AvailableDevices}get AddEventListener(){return t(this,Jr,"f").addEventListener}get RemoveEventListener(){return t(this,Jr,"f").removeEventListener}get RemoveEventListeners(){return t(this,Jr,"f").removeEventListeners}get RemoveAllEventListeners(){return t(this,Jr,"f").removeAllEventListeners}_CheckDeviceAvailability(e){e.isConnected||e.isAvailable||!t(this,Hr,"f").includes(e)||(Yr.log("removing device from availableDevices..."),t(this,Hr,"f").splice(t(this,Hr,"f").indexOf(e),1),t(this,Rr,"m",Zr).call(this))}}xr=new WeakMap,Or=new WeakMap,Br=new WeakMap,Pr=new WeakMap,Nr=new WeakMap,qr=new WeakMap,Hr=new WeakMap,Jr=new WeakMap,Rr=new WeakSet,$r=function(e){t(this,Br,"f")&&t(this,Rr,"m",Gr).call(this,e.target)},Vr=function(){Yr.assertWithError(n,"localStorage is only available in the browser"),Yr.assertWithError(window.localStorage,"localStorage not found")},zr=function(){t(this,Rr,"m",Vr).call(this),localStorage.setItem(t(this,qr,"f"),JSON.stringify(t(this,Nr,"f")))},jr=async function(){t(this,Rr,"m",Vr).call(this);let e=localStorage.getItem(t(this,qr,"f"));if("string"!=typeof e)return Yr.log("no info found in localStorage"),s(this,Nr,Object.assign({},t(this,Pr,"f")),"f"),void t(this,Rr,"m",zr).call(this);try{const t=JSON.parse(e);Yr.log({configuration:t}),s(this,Nr,t,"f"),this.CanGetDevices&&await this.GetDevices()}catch(e){Yr.error(e)}},Gr=function(e){if("webBluetooth"!=e.connectionType)return void Yr.log("localStorage is only for webBluetooth devices");t(this,Rr,"m",Vr).call(this);const s=t(this,Nr,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1!=s&&(t(this,Nr,"f").devices[s].type=e.type,t(this,Rr,"m",zr).call(this))},Kr=function(){return t(this,Jr,"f").dispatchEvent},Qr=function(e){const{target:s}=e;if(s.isConnected)if(t(this,Or,"f").includes(s))Yr.log("device already included");else{if(Yr.log("adding device",s),t(this,Or,"f").push(s),this.UseLocalStorage&&"webBluetooth"==s.connectionType){const e={type:s.type,bluetoothId:s.bluetoothId,ipAddress:s.ipAddress,isWifiSecure:s.isWifiSecure},i=t(this,Nr,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1==i?t(this,Nr,"f").devices.push(e):t(this,Nr,"f").devices[i]=e,t(this,Rr,"m",zr).call(this)}t(this,Rr,"a",Kr).call(this,"deviceConnected",{device:s}),t(this,Rr,"a",Kr).call(this,"deviceIsConnected",{device:s}),t(this,Rr,"m",Xr).call(this)}else t(this,Or,"f").includes(s)?(Yr.log("removing device",s),t(this,Or,"f").splice(t(this,Or,"f").indexOf(s),1),t(this,Rr,"a",Kr).call(this,"deviceDisconnected",{device:s}),t(this,Rr,"a",Kr).call(this,"deviceIsConnected",{device:s}),t(this,Rr,"m",Xr).call(this)):Yr.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),s.isConnected&&!this.AvailableDevices.includes(s)){const e=this.AvailableDevices.find((e=>e.bluetoothId==s.bluetoothId));Yr.log({existingAvailableDevice:e}),e?this.AvailableDevices[this.AvailableDevices.indexOf(e)]=s:this.AvailableDevices.push(s),t(this,Rr,"m",Zr).call(this)}this._CheckDeviceAvailability(s)},Zr=function(){Yr.log({AvailableDevices:this.AvailableDevices}),t(this,Rr,"a",Kr).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},Xr=function(){Yr.log({ConnectedDevices:this.ConnectedDevices}),t(this,Rr,"a",Kr).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},to.shared=new to;var so=to.shared;const io=W("ServerUtils",{log:!1}),no=["isScanningAvailable","isScanning","startScan","stopScan","discoveredDevice","discoveredDevices","expiredDiscoveredDevice","connectToDevice","disconnectFromDevice","connectedDevices","deviceMessage","requiredDeviceInformation"];function ao(e,...t){io.log("createMessage",...t);const s=t.map((t=>{"string"==typeof t&&(t={type:t}),null!=t.data?Array.isArray(t.data)||(t.data=[t.data]):t.data=[];const s=z(...t.data),i=s.byteLength;io.assertEnumWithError(t.type,e);const n=e.indexOf(t.type),a=new DataView(new ArrayBuffer(2));return a.setUint16(0,i,!0),z(n,a,s)}));return io.log("messageBuffers",...s),z(...s)}function ro(...e){return io.log("createServerMessage",...e),ao(no,...e)}function oo(...e){return io.log("createClientDeviceMessage",...e),ao(ha,...e)}ro("isScanningAvailable"),ro("isScanning"),ro("startScan"),ro("stopScan"),ro("discoveredDevices");const co=W("WebSocketUtils",{log:!1}),ho=["ping","pong","serverMessage"];function lo(...e){return co.log("createWebSocketMessage",...e),ao(ho,...e)}var fo,go,uo,mo,po,vo,wo,yo,bo,So,Co,Eo,Mo,ko,Do,To,Wo,Io;lo("ping"),lo("pong");const _o=W("WebSocketConnectionManager",{log:!1}),Lo=["ping","pong","batteryLevel","deviceInformation","message"];const Uo=["deviceInformation","batteryLevel"];class Fo extends la{get bluetoothId(){return t(this,go,"f")??""}constructor(e,i=!1,n){super(),fo.add(this),go.set(this,void 0),this.defaultMtu=1024,uo.set(this,void 0),mo.set(this,void 0),po.set(this,!1),yo.set(this,{open:t(this,fo,"m",bo).bind(this),message:t(this,fo,"m",So).bind(this),close:t(this,fo,"m",Co).bind(this),error:t(this,fo,"m",Eo).bind(this)}),Do.set(this,new R(t(this,fo,"m",To).bind(this),29e3)),this.ipAddress=e,this.isSecure=i,this.mtu=this.defaultMtu,s(this,go,n,"f")}get isAvailable(){return!0}static get isSupported(){return!0}static get type(){return"webSocket"}get webSocket(){return t(this,uo,"f")}set webSocket(e){t(this,uo,"f")!=e?(_o.log("assigning webSocket",e),t(this,uo,"f")&&(ua(t(this,uo,"f"),t(this,yo,"f")),t(this,uo,"f").readyState==t(this,uo,"f").OPEN&&t(this,uo,"f").close()),e&&ga(e,t(this,yo,"f")),s(this,uo,e,"f"),_o.log("assigned webSocket")):_o.log("redundant webSocket assignment")}get ipAddress(){return t(this,mo,"f")}set ipAddress(e){this.assertIsNotConnected(),t(this,mo,"f")!=e?(s(this,mo,e,"f"),_o.log(`updated ipAddress to "${this.ipAddress}"`)):_o.log(`redundnant ipAddress assignment "${e}"`)}get isSecure(){return t(this,po,"f")}set isSecure(e){this.assertIsNotConnected(),t(this,po,"f")!=e?(s(this,po,e,"f"),_o.log(`updated isSecure to "${this.isSecure}"`)):_o.log(`redundant isSecure assignment ${e}`)}get url(){return`${this.isSecure?"wss":"ws"}://${this.ipAddress}/ws`}async connect(){await super.connect();try{this.webSocket=new WebSocket(this.url)}catch(e){_o.error("error connecting to webSocket",e),this.status="notConnected"}}async disconnect(){await super.disconnect(),_o.log("closing websocket"),t(this,Do,"f").stop(),t(this,uo,"f")?.close()}get canReconnect(){return Boolean(this.webSocket)}async reconnect(){await super.reconnect(),this.webSocket=new WebSocket(this.url)}async sendSmpMessage(e){super.sendSmpMessage(e),_o.error("smp not supported on webSockets")}async sendTxData(e){await super.sendTxData(e),0!=e.byteLength&&t(this,fo,"m",wo).call(this,{type:"message",data:e})}remove(){super.remove(),this.webSocket=void 0}}var Ao,Ro,xo,$o,Oo,Bo,Po,No,Vo,qo,zo,jo,Go,Ho,Jo,Ko,Qo,Zo,Xo,Yo,ec,tc,sc,ic,nc,ac,rc,oc,cc,hc,lc,fc,gc,uc,dc,mc,pc,vc,wc,yc;go=new WeakMap,uo=new WeakMap,mo=new WeakMap,po=new WeakMap,yo=new WeakMap,Do=new WeakMap,fo=new WeakSet,vo=function(e){this.assertIsConnected(),_o.log("sending webSocket message",e),t(this,uo,"f").send(e),t(this,Do,"f").restart()},wo=function(...e){t(this,fo,"m",vo).call(this,function(...e){return _o.log("createWebSocketMessage",...e),ao(Lo,...e)}(...e))},bo=function(e){_o.log("webSocket.open",e),t(this,Do,"f").start(),this.status="connected",t(this,fo,"m",Io).call(this)},So=async function(e){const s=await e.data.arrayBuffer(),i=new DataView(s);_o.log(`webSocket.message (${i.byteLength} bytes)`),t(this,fo,"m",Mo).call(this,i)},Co=function(e){_o.log("webSocket.close",e),this.status="notConnected",t(this,Do,"f").stop()},Eo=function(e){_o.error("webSocket.error",e)},Mo=function(e){bt(e,Lo,t(this,fo,"m",ko).bind(this),null,!0)},ko=function(e,s){switch(_o.log(`received "${e}" message (${s.byteLength} bytes)`),e){case"ping":t(this,fo,"m",Wo).call(this);break;case"pong":break;case"batteryLevel":this.onMessageReceived?.("batteryLevel",s);break;case"deviceInformation":bt(s,bi,((e,t)=>{this.onMessageReceived(e,t)}));break;case"message":this.parseRxMessage(s);break;default:_o.error(`uncaught messageType "${e}"`)}},To=function(){_o.log("pinging"),t(this,fo,"m",wo).call(this,"ping")},Wo=function(){_o.log("ponging"),t(this,fo,"m",wo).call(this,"pong")},Io=function(){t(this,fo,"m",wo).call(this,...Uo)};const bc=W("Device",{log:!1}),Sc=["connectionMessage",...aa,...ca,...oa,...ji,...Si,...Ws,...fs,...wn,...Ne,...hi,...Vn,...is,...Ur],Cc=["isCharging","getBatteryCurrent","getId","getMtu","getName","getType","getCurrentTime","getSensorConfiguration","getSensorScalars","getVibrationLocations","getFileTypes","isWifiAvailable"];class Ec{get bluetoothId(){return t(this,Bo,"f")?.bluetoothId}get isAvailable(){return t(this,Bo,"f")?.isAvailable}constructor(){Ao.add(this),$o.set(this,new _(this,Sc)),Bo.set(this,void 0),this.sendTxMessages=t(this,Ao,"m",Po).bind(this),No.set(this,!1),Jo.set(this,Ro.ReconnectOnDisconnection),Ko.set(this,void 0),this.latestConnectionMessages=new Map,ic.set(this,new Ci),nc.set(this,0),this._informationManager=new Gi,rc.set(this,new Is),cc.set(this,Ro.ClearSensorConfigurationOnLeave),hc.set(this,new gs),lc.set(this,new Sn),fc.set(this,new qe),gc.set(this,new ui),uc.set(this,new Ar),this.sendSmpMessage=t(this,Ao,"m",mc).bind(this),pc.set(this,!1),vc.set(this,new qn),wc.set(this,new ns),t(this,ic,"f").eventDispatcher=t(this,$o,"f"),this._informationManager.sendMessage=this.sendTxMessages,this._informationManager.eventDispatcher=t(this,$o,"f"),t(this,rc,"f").sendMessage=this.sendTxMessages,t(this,rc,"f").eventDispatcher=t(this,$o,"f"),t(this,hc,"f").eventDispatcher=t(this,$o,"f"),t(this,lc,"f").sendMessage=this.sendTxMessages,t(this,lc,"f").eventDispatcher=t(this,$o,"f"),t(this,gc,"f").sendMessage=this.sendTxMessages,t(this,gc,"f").eventDispatcher=t(this,$o,"f"),t(this,fc,"f").sendMessage=this.sendTxMessages,t(this,fc,"f").eventDispatcher=t(this,$o,"f"),t(this,vc,"f").sendMessage=this.sendTxMessages,t(this,vc,"f").eventDispatcher=t(this,$o,"f"),t(this,wc,"f").sendMessage=this.sendTxMessages,t(this,wc,"f").eventDispatcher=t(this,$o,"f"),t(this,uc,"f").sendMessage=this.sendSmpMessage,t(this,uc,"f").eventDispatcher=t(this,$o,"f"),this.addEventListener("getMtu",(()=>{t(this,uc,"f").mtu=this.mtu,t(this,fc,"f").mtu=this.mtu,this.connectionManager.mtu=this.mtu})),this.addEventListener("getSensorConfiguration",(()=>{if("connecting"==this.connectionStatus){if(this.sensorTypes.includes("pressure")){bc.log("requesting required pressure information");const e=ls.map((e=>({type:e})));this.sendTxMessages(e,!1)}else bc.log("don't need to request pressure infomration");if(this.sensorTypes.includes("camera")){bc.log("requesting required camera information");const e=ss.map((e=>({type:e})));this.sendTxMessages(e,!1)}else bc.log("don't need to request camera infomration")}})),this.addEventListener("getFileTypes",(()=>{"connecting"==this.connectionStatus&&(this.fileTypes.length>0&&t(this,fc,"f").requestRequiredInformation(),this.fileTypes.includes("tflite")&&t(this,gc,"f").requestRequiredInformation())})),this.addEventListener("isWifiAvailable",(()=>{"connecting"==this.connectionStatus&&("client"!=this.connectionType||a)&&this.isWifiAvailable&&"client"!=this.connectionType&&t(this,vc,"f").requestRequiredInformation()})),so.onDevice(this),n&&window.addEventListener("beforeunload",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()})),a&&process.on("exit",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()}))}get addEventListener(){return t(this,$o,"f").addEventListener}get removeEventListener(){return t(this,$o,"f").removeEventListener}get waitForEvent(){return t(this,$o,"f").waitForEvent}get removeEventListeners(){return t(this,$o,"f").removeEventListeners}get removeAllEventListeners(){return t(this,$o,"f").removeAllEventListeners}get connectionManager(){return t(this,Bo,"f")}set connectionManager(e){this.connectionManager!=e?(this.connectionManager&&this.connectionManager.remove(),e&&(e.onStatusUpdated=t(this,Ao,"m",Qo).bind(this),e.onMessageReceived=t(this,Ao,"m",tc).bind(this),e.onMessagesReceived=t(this,Ao,"m",sc).bind(this)),s(this,Bo,e,"f"),bc.log("assigned new connectionManager",t(this,Bo,"f")),this._informationManager.connectionType=this.connectionType):bc.log("same connectionManager is already assigned")}async connect(e){if(bc.log("connect options",e),e)switch(e.type){case"webBluetooth":"webBluetooth"!=this.connectionType&&(this.connectionManager=new Va);break;case"webSocket":{let t=!1;if("webSocket"==this.connectionType){const s=this.connectionManager;s.ipAddress==e.ipAddress&&s.isSecure==e.isWifiSecure||(t=!0)}else t=!0;t&&(this.connectionManager=new Fo(e.ipAddress,e.isWifiSecure,this.bluetoothId))}break;case"udp":{let t=!1;if("udp"==this.connectionType){this.connectionManager.ipAddress!=e.ipAddress&&(t=!0),this.reconnectOnDisconnection=!0}else t=!0;t&&(this.connectionManager=new UDPConnectionManager(e.ipAddress,this.bluetoothId))}}if(this.connectionManager||(this.connectionManager=t(Ro,Ro,"m",xo).call(Ro)),t(this,Ao,"m",Yo).call(this),"client"==e?.type){bc.assertWithError("client"==this.connectionType,"expected clientConnectionManager");const t=this.connectionManager;return t.subType=e.subType,t.connect()}return bc.log("connectionManager type",this.connectionManager.type),this.connectionManager.connect()}get isConnected(){return t(this,No,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return t(this,Ao,"m",Go).call(this),t(this,Ao,"m",Yo).call(this),this.connectionManager?.reconnect()}static async Connect(){const e=new Ro;return await e.connect(),e}static get ReconnectOnDisconnection(){return t(this,Ro,"f",Ho)}static set ReconnectOnDisconnection(e){bc.assertTypeWithError(e,"boolean"),s(this,Ro,e,"f",Ho)}get reconnectOnDisconnection(){return t(this,Jo,"f")}set reconnectOnDisconnection(e){bc.assertTypeWithError(e,"boolean"),s(this,Jo,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return t(this,Ao,"m",Vo).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){if(this.isConnected)this.disconnect();else if(this.canReconnect)try{this.reconnect()}catch(e){bc.error("error trying to reconnect",e),this.connect()}else this.connect()}get connectionStatus(){switch(t(this,Bo,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return t(this,Bo,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return t(this,ic,"f").information}get batteryLevel(){return t(this,nc,"f")}get id(){return this._informationManager.id}get isCharging(){return this._informationManager.isCharging}get batteryCurrent(){return this._informationManager.batteryCurrent}get getBatteryCurrent(){return this._informationManager.getBatteryCurrent}get name(){return this._informationManager.name}get setName(){return this._informationManager.setName}get type(){return this._informationManager.type}get setType(){return this._informationManager.setType}get isInsole(){return this._informationManager.isInsole}get isGlove(){return this._informationManager.isGlove}get side(){return this._informationManager.side}get mtu(){return this._informationManager.mtu}get sensorTypes(){return Object.keys(this.sensorConfiguration)}get continuousSensorTypes(){return cs.filter((e=>this.sensorTypes.includes(e)))}get sensorConfiguration(){return t(this,rc,"f").configuration}async setSensorConfiguration(e,s){await t(this,rc,"f").setConfiguration(e,s)}async clearSensorConfiguration(){return t(this,rc,"f").clearSensorConfiguration()}static get ClearSensorConfigurationOnLeave(){return t(this,Ro,"f",oc)}static set ClearSensorConfigurationOnLeave(e){bc.assertTypeWithError(e,"boolean"),s(this,Ro,e,"f",oc)}get clearSensorConfigurationOnLeave(){return t(this,cc,"f")}set clearSensorConfigurationOnLeave(e){bc.assertTypeWithError(e,"boolean"),s(this,cc,e,"f")}get numberOfPressureSensors(){return t(this,hc,"f").pressureSensorDataManager.numberOfSensors}resetPressureRange(){t(this,hc,"f").pressureSensorDataManager.resetRange()}get vibrationLocations(){return t(this,lc,"f").vibrationLocations}async triggerVibration(e,s){t(this,lc,"f").triggerVibration(e,s)}get fileTypes(){return t(this,fc,"f").fileTypes}get maxFileLength(){return t(this,fc,"f").maxLength}get validFileTypes(){return Oe.filter((e=>!(e.includes("wifi")&&!this.isWifiAvailable)))}async sendFile(e,s){bc.assertWithError(this.validFileTypes.includes(e),`invalid fileType ${e}`);const i=this.waitForEvent("fileTransferComplete");t(this,fc,"f").send(e,s),await i}async receiveFile(e){const s=this.waitForEvent("fileTransferComplete");t(this,fc,"f").receive(e),await s}get fileTransferStatus(){return t(this,fc,"f").status}cancelFileTransfer(){t(this,fc,"f").cancel()}get tfliteName(){return t(this,gc,"f").name}get setTfliteName(){return t(this,gc,"f").setName}async sendTfliteConfiguration(e){e.type="tflite",t(this,gc,"f").sendConfiguration(e,!1);await t(this,fc,"f").send(e.type,e.file)||t(this,Ao,"m",Po).call(this)}get tfliteTask(){return t(this,gc,"f").task}get setTfliteTask(){return t(this,gc,"f").setTask}get tfliteSampleRate(){return t(this,gc,"f").sampleRate}get setTfliteSampleRate(){return t(this,gc,"f").setSampleRate}get tfliteSensorTypes(){return t(this,gc,"f").sensorTypes}get allowedTfliteSensorTypes(){return this.sensorTypes.filter((e=>gi.includes(e)))}get setTfliteSensorTypes(){return t(this,gc,"f").setSensorTypes}get tfliteIsReady(){return t(this,gc,"f").isReady}get tfliteInferencingEnabled(){return t(this,gc,"f").inferencingEnabled}get setTfliteInferencingEnabled(){return t(this,gc,"f").setInferencingEnabled}async enableTfliteInferencing(){return this.setTfliteInferencingEnabled(!0)}async disableTfliteInferencing(){return this.setTfliteInferencingEnabled(!1)}get toggleTfliteInferencing(){return t(this,gc,"f").toggleInferencingEnabled}get tfliteCaptureDelay(){return t(this,gc,"f").captureDelay}get setTfliteCaptureDelay(){return t(this,gc,"f").setCaptureDelay}get tfliteThreshold(){return t(this,gc,"f").threshold}get setTfliteThreshold(){return t(this,gc,"f").setThreshold}get canUpdateFirmware(){return t(this,Bo,"f")?.canUpdateFirmware}get uploadFirmware(){return t(this,Ao,"m",dc).call(this),t(this,uc,"f").uploadFirmware}get canReset(){return this.canUpdateFirmware}async reset(){return bc.assertWithError(this.canReset,"reset is not enabled for this device"),await t(this,uc,"f").reset(),t(this,Bo,"f").disconnect()}get firmwareStatus(){return t(this,uc,"f").status}get getFirmwareImages(){return t(this,Ao,"m",dc).call(this),t(this,uc,"f").getImages}get firmwareImages(){return t(this,uc,"f").images}get eraseFirmwareImage(){return t(this,Ao,"m",dc).call(this),t(this,uc,"f").eraseImage}get confirmFirmwareImage(){return t(this,Ao,"m",dc).call(this),t(this,uc,"f").confirmImage}get testFirmwareImage(){return t(this,Ao,"m",dc).call(this),t(this,uc,"f").testImage}get isServerSide(){return t(this,pc,"f")}set isServerSide(e){t(this,pc,"f")!=e?(bc.log({newIsServerSide:e}),s(this,pc,e,"f"),t(this,fc,"f").isServerSide=this.isServerSide):bc.log("redundant isServerSide assignment")}get isUkaton(){return this.deviceInformation.modelNumber.includes("Ukaton")}get isWifiAvailable(){return t(this,vc,"f").isWifiAvailable}get wifiSSID(){return t(this,vc,"f").wifiSSID}async setWifiSSID(e){return t(this,vc,"f").setWifiSSID(e)}get wifiPassword(){return t(this,vc,"f").wifiPassword}async setWifiPassword(e){return t(this,vc,"f").setWifiPassword(e)}get isWifiConnected(){return t(this,vc,"f").isWifiConnected}get ipAddress(){return t(this,vc,"f").ipAddress}get wifiConnectionEnabled(){return t(this,vc,"f").wifiConnectionEnabled}get enableWifiConnection(){return t(this,vc,"f").enableWifiConnection}get setWifiConnectionEnabled(){return t(this,vc,"f").setWifiConnectionEnabled}get disableWifiConnection(){return t(this,vc,"f").disableWifiConnection}get toggleWifiConnection(){return t(this,vc,"f").toggleWifiConnection}get isWifiSecure(){return t(this,vc,"f").isWifiSecure}async reconnectViaWebSockets(){bc.assertWithError(this.isWifiConnected,"wifi is not connected"),bc.assertWithError("webSocket"!=this.connectionType,"already connected via webSockets"),bc.assertTypeWithError(this.ipAddress,"string"),bc.log("reconnecting via websockets..."),await this.disconnect(),await this.connect({type:"webSocket",ipAddress:this.ipAddress,isWifiSecure:this.isWifiSecure})}async reconnectViaUDP(){bc.assertWithError(a,"udp is only available in node"),bc.assertWithError(this.isWifiConnected,"wifi is not connected"),bc.assertWithError("udp"!=this.connectionType,"already connected via udp"),bc.assertTypeWithError(this.ipAddress,"string"),bc.log("reconnecting via udp..."),await this.disconnect(),await this.connect({type:"udp",ipAddress:this.ipAddress})}get hasCamera(){return this.sensorTypes.includes("camera")}get cameraStatus(){return t(this,wc,"f").cameraStatus}async takePicture(){t(this,Ao,"m",yc).call(this),await t(this,wc,"f").takePicture()}async focusCamera(){t(this,Ao,"m",yc).call(this),await t(this,wc,"f").focus()}async stopCamera(){t(this,Ao,"m",yc).call(this),await t(this,wc,"f").stop()}async wakeCamera(){t(this,Ao,"m",yc).call(this),await t(this,wc,"f").wake()}async sleepCamera(){t(this,Ao,"m",yc).call(this),await t(this,wc,"f").sleep()}get cameraConfiguration(){return t(this,wc,"f").cameraConfiguration}get availableCameraConfigurationTypes(){return t(this,wc,"f").availableCameraConfigurationTypes}get cameraConfigurationRanges(){return t(this,wc,"f").cameraConfigurationRanges}get setCameraConfiguration(){return t(this,wc,"f").setCameraConfiguration}}var Mc,kc,Dc,Tc,Wc,Ic;Ro=Ec,$o=new WeakMap,Bo=new WeakMap,No=new WeakMap,Jo=new WeakMap,Ko=new WeakMap,ic=new WeakMap,nc=new WeakMap,rc=new WeakMap,cc=new WeakMap,hc=new WeakMap,lc=new WeakMap,fc=new WeakMap,gc=new WeakMap,uc=new WeakMap,pc=new WeakMap,vc=new WeakMap,wc=new WeakMap,Ao=new WeakSet,xo=function(){return new Va},Oo=function(){return t(this,$o,"f").dispatchEvent},Po=async function(e,s){await(t(this,Bo,"f")?.sendTxMessages(e,s))},Vo=function(){bc.assertWithError(this.isConnected,"notConnected")},qo=function(e){return e.every((e=>{const t=this.latestConnectionMessages.has(e);return t||bc.log(`didn't receive "${e}" message`),t}))},zo=function(){let e=t(this,Ao,"m",qo).call(this,Cc);return e&&this.sensorTypes.includes("pressure")&&(e=t(this,Ao,"m",qo).call(this,ls)),e&&this.isWifiAvailable&&(e=t(this,Ao,"m",qo).call(this,Nn)),e&&this.fileTypes.length>0&&(e=t(this,Ao,"m",qo).call(this,Ve)),e&&this.fileTypes.includes("tflite")&&(e=t(this,Ao,"m",qo).call(this,li)),e&&this.hasCamera&&(e=t(this,Ao,"m",qo).call(this,ss)),e},jo=function(){bc.log("requesting required information");const e=Cc.map((e=>({type:e})));t(this,Ao,"m",Po).call(this,e)},Go=function(){bc.assertWithError(this.canReconnect,"cannot reconnect to device")},Qo=function(e){bc.log({connectionStatus:e}),"notConnected"==e?(t(this,Ao,"m",ec).call(this),this.canReconnect&&this.reconnectOnDisconnection&&(bc.log("starting reconnect interval..."),s(this,Ko,setInterval((()=>{bc.log("attempting reconnect..."),this.reconnect()}),1e3),"f"))):null!=t(this,Ko,"f")&&(bc.log("clearing reconnect interval"),clearInterval(t(this,Ko,"f")),s(this,Ko,void 0,"f")),t(this,Ao,"m",Xo).call(this),"connected"!=e||t(this,No,"f")||"client"!=this.connectionType&&t(this,Ao,"m",jo).call(this),so.OnDeviceConnectionStatusUpdated(this,e)},Zo=function(e=!1){t(this,Ao,"a",Oo).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),t(this,Ao,"a",Oo).call(this,this.connectionStatus,{}),e&&t(this,Ao,"a",Oo).call(this,"isConnected",{isConnected:this.isConnected})},Xo=function(){switch(s(this,No,Boolean(this.connectionManager?.isConnected)&&t(this,Ao,"a",zo)&&this._informationManager.isCurrentTimeSet,"f"),this.connectionStatus){case"connected":t(this,No,"f")&&t(this,Ao,"m",Zo).call(this,!0);break;case"notConnected":t(this,Ao,"m",Zo).call(this,!0);break;default:t(this,Ao,"m",Zo).call(this,!1)}},Yo=function(){t(this,Ao,"m",ec).call(this),this._informationManager.clear(),t(this,ic,"f").clear(),t(this,gc,"f").clear(),t(this,vc,"f").clear(),t(this,wc,"f").clear()},ec=function(){this.connectionManager?.clear(),this.latestConnectionMessages.clear()},tc=function(e,s){if(bc.log({messageType:e,dataView:s}),"batteryLevel"===e){const e=s.getUint8(0);bc.log("received battery level",{batteryLevel:e}),t(this,Ao,"m",ac).call(this,e)}else if($e.includes(e))t(this,fc,"f").parseMessage(e,s);else if(ci.includes(e))t(this,gc,"f").parseMessage(e,s);else if(hs.includes(e))t(this,hc,"f").parseMessage(e,s);else if(Lr.includes(e))t(this,uc,"f").parseMessage(e,s);else if(bi.includes(e))t(this,ic,"f").parseMessage(e,s);else if(zi.includes(e))this._informationManager.parseMessage(e,s);else if(Ts.includes(e))t(this,rc,"f").parseMessage(e,s);else if(vn.includes(e))t(this,lc,"f").parseMessage(e,s);else if(Pn.includes(e))t(this,vc,"f").parseMessage(e,s);else{if(!ts.includes(e))throw Error(`uncaught messageType ${e}`);t(this,wc,"f").parseMessage(e,s)}this.latestConnectionMessages.set(e,s),e.startsWith("set")&&this.latestConnectionMessages.set(e.replace("set","get"),s),t(this,Ao,"a",Oo).call(this,"connectionMessage",{messageType:e,dataView:s})},sc=function(){!this.isConnected&&t(this,Ao,"a",zo)&&t(this,Ao,"m",Xo).call(this),"notConnected"!=this.connectionStatus&&t(this,Ao,"m",Po).call(this)},ac=function(e){bc.assertTypeWithError(e,"number"),t(this,nc,"f")!=e?(s(this,nc,e,"f"),bc.log({updatedBatteryLevel:t(this,nc,"f")}),t(this,Ao,"a",Oo).call(this,"batteryLevel",{batteryLevel:t(this,nc,"f")})):bc.log(`duplicate batteryLevel assignment ${e}`)},dc=function(){bc.assertWithError(this.canUpdateFirmware,"can't update firmware")},mc=function(e){return t(this,Ao,"m",dc).call(this),t(this,Bo,"f").sendSmpMessage(e)},yc=function(){bc.assertWithError(this.hasCamera,"camera not available")},Ho={value:!1},oc={value:!0};const _c=W("DevicePairPressureSensorDataManager",{log:!1});class Lc{constructor(){Mc.add(this),kc.set(this,{}),Dc.set(this,new it),Tc.set(this,new Ze),this.resetPressureRange()}resetPressureRange(){t(this,Dc,"f").reset(),t(this,Tc,"f").reset()}onDevicePressureData(e){const{pressure:s}=e.message,{side:i}=e.target;if(_c.log({pressure:s,side:i}),t(this,kc,"f")[i]=s,t(this,Mc,"a",Wc))return t(this,Mc,"m",Ic).call(this);_c.log("doesn't have all pressure data yet...")}}var Uc;kc=new WeakMap,Dc=new WeakMap,Tc=new WeakMap,Mc=new WeakSet,Wc=function(){return qi.every((e=>e in t(this,kc,"f")))},Ic=function(){const e={scaledSum:0,normalizedSum:0,sensors:{left:[],right:[]}};return qi.forEach((s=>{const i=t(this,kc,"f")[s];e.scaledSum+=i.scaledSum})),e.normalizedSum+=t(this,Tc,"f").updateAndGetNormalization(e.scaledSum,!1),e.scaledSum>0&&(e.center={x:0,y:0},qi.forEach((s=>{t(this,kc,"f")[s].sensors.forEach((t=>{const i={...t};i.weightedValue=t.scaledValue/e.scaledSum;let{x:n,y:a}=t.position;n/=2,"right"==s&&(n+=.5),i.position={x:n,y:a},e.center.x+=i.position.x*i.weightedValue,e.center.y+=i.position.y*i.weightedValue,e.sensors[s].push(i)}))})),e.normalizedCenter=t(this,Dc,"f").updateAndGetNormalization(e.center,!1)),_c.log({devicePairPressure:e}),e};const Fc=W("DevicePairSensorDataManager",{log:!1}),Ac=["pressure","sensorData"];class Rc{constructor(){Uc.set(this,{}),this.pressureSensorDataManager=new Lc}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}resetPressureRange(){this.pressureSensorDataManager.resetPressureRange()}onDeviceSensorData(e){const{timestamp:s,sensorType:i}=e.message;let n;if(Fc.log({sensorType:i,timestamp:s,event:e}),t(this,Uc,"f")[i]||(t(this,Uc,"f")[i]={}),t(this,Uc,"f")[i][e.target.side]=s,"pressure"===i)n=this.pressureSensorDataManager.onDevicePressureData(e);else Fc.log(`uncaught sensorType "${i}"`);if(n){const e=Object.assign({},t(this,Uc,"f")[i]);this.dispatchEvent(i,{sensorType:i,timestamps:e,[i]:n}),this.dispatchEvent("sensorData",{sensorType:i,timestamps:e,[i]:n})}else Fc.log("no value received")}}var xc,$c,Oc,Bc,Pc,Nc,Vc,qc,zc,jc,Gc,Hc,Jc,Kc,Qc,Zc,Xc,Yc,eh;Uc=new WeakMap;const th=W("DevicePair",{log:!1});function sh(e){return`device${t=e,t[0].toUpperCase()+t.slice(1)}`;var t}const ih=["isConnected",...Ac,...Sc.map((e=>sh(e)))];class nh{constructor(e){xc.add(this),Oc.set(this,void 0),Bc.set(this,new _(this,ih)),Nc.set(this,void 0),Vc.set(this,void 0),Hc.set(this,{isConnected:t(this,xc,"m",Kc).bind(this),sensorData:t(this,xc,"m",Xc).bind(this),getType:t(this,xc,"m",Qc).bind(this)}),Zc.set(this,new Rc),s(this,Oc,e,"f"),t(this,Zc,"f").eventDispatcher=t(this,Bc,"f")}get sides(){return qi}get type(){return t(this,Oc,"f")}get addEventListener(){return t(this,Bc,"f").addEventListener}get removeEventListener(){return t(this,Bc,"f").removeEventListener}get waitForEvent(){return t(this,Bc,"f").waitForEvent}get removeEventListeners(){return t(this,Bc,"f").removeEventListeners}get removeAllEventListeners(){return t(this,Bc,"f").removeAllEventListeners}get left(){return t(this,Nc,"f")}get right(){return t(this,Vc,"f")}get isConnected(){return qi.every((e=>this[e]?.isConnected))}get isPartiallyConnected(){return qi.some((e=>this[e]?.isConnected))}get isHalfConnected(){return this.isPartiallyConnected&&!this.isConnected}assignDevice(e){if(!t(this,xc,"m",qc).call(this,e))return void th.log(`device is incorrect type ${e.type} for ${this.type} devicePair`);const i=e.side,n=this[i];if(e!=n){switch(n&&t(this,xc,"m",jc).call(this,n),t(this,xc,"m",zc).call(this,e),i){case"left":s(this,Nc,e,"f");break;case"right":s(this,Vc,e,"f")}return th.log(`assigned ${i} ${this.type} device`,e),this.resetPressureRange(),t(this,xc,"a",Pc).call(this,"isConnected",{isConnected:this.isConnected}),t(this,xc,"a",Pc).call(this,"deviceIsConnected",{device:e,isConnected:e.isConnected,side:i}),n}th.log("device already assigned")}async setSensorConfiguration(e){for(let t=0;t<qi.length;t++){const s=qi[t];this[s]?.isConnected&&await this[s].setSensorConfiguration(e)}}resetPressureRange(){qi.forEach((e=>this[e]?.resetPressureRange())),t(this,Zc,"f").resetPressureRange()}async triggerVibration(e,t){const s=qi.map((s=>this[s]?.triggerVibration(e,t))).filter(Boolean);return Promise.allSettled(s)}static get insoles(){return t(this,$c,"f",Yc)}static get gloves(){return t(this,$c,"f",eh)}}var ah,rh,oh,ch,hh;$c=nh,Oc=new WeakMap,Bc=new WeakMap,Nc=new WeakMap,Vc=new WeakMap,Hc=new WeakMap,Zc=new WeakMap,xc=new WeakSet,Pc=function(){return t(this,Bc,"f").dispatchEvent},qc=function(e){switch(this.type){case"insoles":return e.isInsole;case"gloves":return e.isGlove}},zc=function(e){ga(e,t(this,Hc,"f")),Sc.forEach((s=>{e.addEventListener(s,t(this,xc,"m",Jc).bind(this))}))},jc=function(e){ua(e,t(this,Hc,"f")),Sc.forEach((s=>{e.removeEventListener(s,t(this,xc,"m",Jc).bind(this))}))},Gc=function(e){const i=qi.some((i=>{if(this[i]!=e)return!1;switch(th.log(`removing ${i} ${this.type} device`,e),ua(e,t(this,Hc,"f")),i){case"left":s(this,Nc,void 0,"f");break;case"right":s(this,Vc,void 0,"f")}return!0}));return i&&t(this,xc,"a",Pc).call(this,"isConnected",{isConnected:this.isConnected}),i},Jc=function(e){const{type:s,target:i,message:n}=e;t(this,xc,"a",Pc).call(this,sh(s),{...n,device:i,side:i.side})},Kc=function(e){t(this,xc,"a",Pc).call(this,"isConnected",{isConnected:this.isConnected})},Qc=function(e){const{target:s}=e;if(this[s.side]==s)return;t(this,xc,"m",Gc).call(this,s)&&this.assignDevice(s)},Xc=function(e){this.isConnected&&t(this,Zc,"f").onDeviceSensorData(e)},Yc={value:new $c("insoles")},eh={value:new $c("gloves")},so.AddEventListener("deviceConnected",(e=>{const{device:s}=e.message;s.isInsole&&t($c,$c,"f",Yc).assignDevice(s),s.isGlove&&t($c,$c,"f",eh).assignDevice(s)}));const lh=W("ClientConnectionManager",{log:!1});class fh extends la{constructor(){super(...arguments),ah.add(this),rh.set(this,void 0),oh.set(this,!1)}static get isSupported(){return n}static get type(){return"client"}get canUpdateFirmware(){return!1}get bluetoothId(){return t(this,rh,"f")}set bluetoothId(e){lh.assertTypeWithError(e,"string"),t(this,rh,"f")!=e?s(this,rh,e,"f"):lh.log("redundant bluetoothId assignment")}get isConnected(){return t(this,oh,"f")}set isConnected(e){lh.assertTypeWithError(e,"boolean"),t(this,oh,"f")!=e?(s(this,oh,e,"f"),this.status=t(this,oh,"f")?"connected":"notConnected",this.isConnected&&t(this,ah,"m",ch).call(this)):lh.log("redundant newIsConnected assignment",e)}get isAvailable(){return this.client.isConnected}async connect(){await super.connect(),this.sendClientConnectMessage(this.subType)}async disconnect(){await super.disconnect(),this.sendClientDisconnectMessage()}get canReconnect(){return!0}async reconnect(){await super.reconnect(),this.sendClientConnectMessage()}async sendSmpMessage(e){super.sendSmpMessage(e),this.sendClientMessage({type:"smp",data:e})}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&this.sendClientMessage({type:"tx",data:e})}onClientMessage(e){lh.log({dataView:e}),bt(e,Sc,t(this,ah,"m",hh).bind(this),null,!0),this.onMessagesReceived()}}var gh,uh,dh,mh,ph,vh,wh,yh,bh,Sh,Ch,Eh,Mh,kh,Dh,Th,Wh,Ih,_h,Lh,Uh,Fh,Ah,Rh;rh=new WeakMap,oh=new WeakMap,ah=new WeakSet,ch=function(){this.sendRequiredDeviceInformationMessage()},hh=function(e,t){let s=0;switch(lh.log({messageType:e},t),e){case"isConnected":const i=Boolean(t.getUint8(s++));lh.log({isConnected:i}),this.isConnected=i;break;case"rx":this.parseRxMessage(t);break;default:this.onMessageReceived(e,t)}};const xh=W("BaseClient",{log:!1}),$h=["notConnected","connecting","connected","disconnecting","connectionStatus","isConnected","isScanningAvailable","isScanning","discoveredDevice","expiredDiscoveredDevice"];class Oh{constructor(){gh.add(this),mh.set(this,{}),ph.set(this,new _(this,$h)),this._reconnectOnDisconnection=this.baseConstructor.ReconnectOnDisconnection,vh.set(this,"notConnected"),bh.set(this,[]),Eh.set(this,!1),Th.set(this,!1),Fh.set(this,{})}get baseConstructor(){return this.constructor}get devices(){return t(this,mh,"f")}get addEventListener(){return t(this,ph,"f").addEventListener}get dispatchEvent(){return t(this,ph,"f").dispatchEvent}get removeEventListener(){return t(this,ph,"f").removeEventListener}get waitForEvent(){return t(this,ph,"f").waitForEvent}assertConnection(){xh.assertWithError(this.isConnected,"notConnected")}assertDisconnection(){xh.assertWithError(this.isDisconnected,"not disconnected")}static get ReconnectOnDisconnection(){return this._reconnectOnDisconnection}static set ReconnectOnDisconnection(e){xh.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get reconnectOnDisconnection(){return this._reconnectOnDisconnection}set reconnectOnDisconnection(e){xh.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get _connectionStatus(){return t(this,vh,"f")}set _connectionStatus(e){switch(xh.assertTypeWithError(e,"string"),xh.log({newConnectionStatus:e}),s(this,vh,e,"f"),this.dispatchEvent("connectionStatus",{connectionStatus:this.connectionStatus}),this.dispatchEvent(this.connectionStatus,{}),e){case"connected":case"notConnected":this.dispatchEvent("isConnected",{isConnected:this.isConnected}),this.isConnected||t(this,gh,"m",dh).call(this)}}get connectionStatus(){return this._connectionStatus}_sendRequiredMessages(){xh.log("sending required messages",t(this,bh,"f")),this.sendServerMessage(...t(this,gh,"a",yh))}parseMessage(e){xh.log("parseMessage",{dataView:e}),bt(e,no,t(this,gh,"m",Ch).bind(this),null,!0),t(this,gh,"m",Sh).call(this)}get isScanningAvailable(){return t(this,gh,"a",Mh)}requestIsScanningAvailable(){this.sendServerMessage("isScanningAvailable")}get isScanning(){return t(this,gh,"a",Wh)}startScan(){t(this,gh,"m",Uh).call(this),this.sendServerMessage("startScan")}stopScan(){t(this,gh,"m",Lh).call(this),this.sendServerMessage("stopScan")}toggleScan(){t(this,gh,"m",Dh).call(this),this.isScanning?this.stopScan():this.startScan()}get discoveredDevices(){return t(this,Fh,"f")}onDiscoveredDevice(e){xh.log({discoveredDevice:e}),t(this,Fh,"f")[e.bluetoothId]=e,this.dispatchEvent("discoveredDevice",{discoveredDevice:e})}requestDiscoveredDevices(){this.sendServerMessage({type:"discoveredDevices"})}connectToDevice(e,t){return this.requestConnectionToDevice(e,t)}requestConnectionToDevice(e,s){this.assertConnection(),xh.assertTypeWithError(e,"string");const i=t(this,gh,"m",Rh).call(this,e);return s?i.connect({type:"client",subType:s}):i.connect(),i}sendConnectToDeviceMessage(e,t){t?this.sendServerMessage({type:"connectToDevice",data:z(j(e),ia.indexOf(t))}):this.sendServerMessage({type:"connectToDevice",data:e})}createDevice(e){const s=new Ec,i=t(this,Fh,"f")[e],n=new fh;return n.discoveredDevice=Object.assign({},i),n.client=this,n.bluetoothId=e,n.sendClientMessage=this.sendDeviceMessage.bind(this,e),n.sendRequiredDeviceInformationMessage=this.sendRequiredDeviceInformationMessage.bind(this,e),n.sendClientConnectMessage=this.sendConnectToDeviceMessage.bind(this,e),n.sendClientDisconnectMessage=this.sendDisconnectFromDeviceMessage.bind(this,e),s.connectionManager=n,s}onConnectedBluetoothDeviceIds(e){xh.log({bluetoothIds:e}),e.forEach((e=>{const s=t(this,gh,"m",Rh).call(this,e);s.connectionManager.isConnected=!0,so._CheckDeviceAvailability(s)}))}disconnectFromDevice(e){this.requestDisconnectionFromDevice(e)}requestDisconnectionFromDevice(e){this.assertConnection(),xh.assertTypeWithError(e,"string");const t=this.devices[e];return xh.assertWithError(t,`no device found with id ${e}`),t.disconnect(),t}sendDisconnectFromDeviceMessage(e){this.sendServerMessage({type:"disconnectFromDevice",data:e})}sendDeviceMessage(e,...t){this.sendServerMessage({type:"deviceMessage",data:[e,oo(...t)]})}sendRequiredDeviceInformationMessage(e){this.sendServerMessage({type:"requiredDeviceInformation",data:[e]})}}var Bh,Ph,Nh,Vh,qh,zh,jh,Gh,Hh,Jh,Kh,Qh,Zh;uh=Oh,mh=new WeakMap,ph=new WeakMap,vh=new WeakMap,bh=new WeakMap,Eh=new WeakMap,Th=new WeakMap,Fh=new WeakMap,gh=new WeakSet,dh=function(){s(this,gh,!1,"a",kh),s(this,gh,!1,"a",Ih);for(const e in t(this,mh,"f")){t(this,mh,"f")[e].connectionManager.isConnected=!1}t(this,bh,"f").length=0},yh=function(){return t(uh,uh,"f",wh)},Sh=function(){"connecting"==this.connectionStatus&&(xh.log("checking if fully connected..."),t(this,bh,"f").includes("isScanningAvailable")?!this.isScanningAvailable||t(this,bh,"f").includes("isScanning")?(xh.log("fully connected"),this._connectionStatus="connected"):xh.log("not fully connected - didn't receive isScanning"):xh.log("not fully connected - didn't receive isScanningAvailable"))},Ch=function(e,i){let n=0;switch(xh.log({messageType:e},i),e){case"isScanningAvailable":{const e=Boolean(i.getUint8(n++));xh.log({isScanningAvailable:e}),s(this,gh,e,"a",kh)}break;case"isScanning":{const e=Boolean(i.getUint8(n++));xh.log({isScanning:e}),s(this,gh,e,"a",Ih)}break;case"discoveredDevice":{const{string:e}=yt(i,n);xh.log({discoveredDeviceString:e});const t=JSON.parse(e);xh.log({discoveredDevice:t}),this.onDiscoveredDevice(t)}break;case"expiredDiscoveredDevice":{const{string:e}=yt(i,n);t(this,gh,"m",Ah).call(this,e)}break;case"connectedDevices":{if(0==i.byteLength)break;const{string:e}=yt(i,n);xh.log({connectedBluetoothDeviceIdStrings:e});const t=JSON.parse(e).connectedDevices;xh.log({connectedBluetoothDeviceIds:t}),this.onConnectedBluetoothDeviceIds(t)}break;case"deviceMessage":{const{string:e,byteOffset:s}=yt(i,n);n=s;const a=t(this,mh,"f")[e];xh.assertWithError(a,`no device found for id ${e}`);const r=a.connectionManager,o=G(i,n);r.onClientMessage(o)}break;default:xh.error(`uncaught messageType "${e}"`)}"connecting"==this.connectionStatus&&t(this,bh,"f").push(e)},Mh=function(){return t(this,Eh,"f")},kh=function(e){xh.assertTypeWithError(e,"boolean"),s(this,Eh,e,"f"),this.dispatchEvent("isScanningAvailable",{isScanningAvailable:this.isScanningAvailable}),this.isScanningAvailable&&t(this,gh,"m",_h).call(this)},Dh=function(){this.assertConnection(),xh.assertWithError(this.isScanningAvailable,"scanning is not available")},Wh=function(){return t(this,Th,"f")},Ih=function(e){xh.assertTypeWithError(e,"boolean"),s(this,Th,e,"f"),this.dispatchEvent("isScanning",{isScanning:this.isScanning})},_h=function(){this.sendServerMessage("isScanning")},Lh=function(){xh.assertWithError(this.isScanning,"is not scanning")},Uh=function(){xh.assertWithError(!this.isScanning,"is already scanning")},Ah=function(e){xh.log({expiredBluetoothDeviceId:e});const s=t(this,Fh,"f")[e];s?(xh.log({expiredDiscoveredDevice:s}),delete t(this,Fh,"f")[e],this.dispatchEvent("expiredDiscoveredDevice",{discoveredDevice:s})):xh.warn(`no discoveredDevice found with id "${e}"`)},Rh=function(e){let s=t(this,mh,"f")[e];return s||(s=this.createDevice(e),t(this,mh,"f")[e]=s),s},Oh._reconnectOnDisconnection=!0,wh={value:["isScanningAvailable","discoveredDevices","connectedDevices"]};const Xh=W("WebSocketClient",{log:!1});Ph=new WeakMap,Vh=new WeakMap,Kh=new WeakMap,Bh=new WeakSet,Nh=function(...e){this.sendMessage(lo(...e))},qh=function(e){Xh.log("webSocket.open",e),t(this,Kh,"f").start(),this._sendRequiredMessages()},zh=async function(e){Xh.log("webSocket.message",e);const s=await e.data.arrayBuffer(),i=new DataView(s);t(this,Bh,"m",Hh).call(this,i)},jh=function(e){Xh.log("webSocket.close",e),this._connectionStatus="notConnected",Object.entries(this.devices).forEach((([e,t])=>{t.connectionManager.isConnected=!1})),t(this,Kh,"f").stop(),this.reconnectOnDisconnection&&setTimeout((()=>{this.reconnect()}),3e3)},Gh=function(e){Xh.error("webSocket.error",e)},Hh=function(e){bt(e,ho,t(this,Bh,"m",Jh).bind(this),null,!0)},Jh=function(e,s){switch(e){case"ping":t(this,Bh,"m",Zh).call(this);break;case"pong":break;case"serverMessage":this.parseMessage(s);break;default:Xh.error(`uncaught messageType "${e}"`)}},Qh=function(){t(this,Bh,"m",Nh).call(this,"ping")},Zh=function(){t(this,Bh,"m",Nh).call(this,"pong")};const Yh={addEventListeners:ga,removeEventListeners:ua},el={throttle:function(e,t,s=!1){let i=0,n=null,a=null;return function(...r){const o=Date.now(),c=t-(o-i);c<=0?(n&&(clearTimeout(n),n=null),i=o,e(...r)):s&&(a=r,n||(n=setTimeout((()=>{i=Date.now(),n=null,a&&(e(...a),a=null)}),c)))}},debounce:function(e,t,s=!1){let i=null;return function(...n){const a=s&&!i;i&&clearTimeout(i),i=setTimeout((()=>{i=null,s||e(...n)}),t),a&&e(...n)}}};e.CameraCommands=Zt,e.CameraConfigurationTypes=es,e.ContinuousSensorTypes=cs,e.DefaultNumberOfPressureSensors=8,e.Device=Ec,e.DeviceManager=so,e.DevicePair=nh,e.DevicePairTypes=["insoles","gloves"],e.DeviceTypes=Vi,e.Environment=y,e.EventUtils=Yh,e.FileTransferDirections=["sending","receiving"],e.FileTypes=Oe,e.MaxNameLength=30,e.MaxNumberOfVibrationWaveformEffectSegments=8,e.MaxNumberOfVibrationWaveformSegments=20,e.MaxSensorRate=65535,e.MaxVibrationWaveformEffectSegmentDelay=bn,e.MaxVibrationWaveformEffectSegmentLoopCount=3,e.MaxVibrationWaveformEffectSequenceLoopCount=6,e.MaxVibrationWaveformSegmentDuration=yn,e.MaxWifiPasswordLength=64,e.MaxWifiSSIDLength=32,e.MinNameLength=2,e.MinWifiPasswordLength=8,e.MinWifiSSIDLength=1,e.RangeHelper=Ze,e.SensorRateStep=5,e.SensorTypes=os,e.Sides=qi,e.TfliteSensorTypes=gi,e.TfliteTasks=fi,e.ThrottleUtils=el,e.VibrationLocations=mn,e.VibrationTypes=pn,e.VibrationWaveformEffects=Hi,e.WebSocketClient=class extends Oh{constructor(){super(...arguments),Bh.add(this),Ph.set(this,void 0),Vh.set(this,{open:t(this,Bh,"m",qh).bind(this),message:t(this,Bh,"m",zh).bind(this),close:t(this,Bh,"m",jh).bind(this),error:t(this,Bh,"m",Gh).bind(this)}),Kh.set(this,new R(t(this,Bh,"m",Qh).bind(this),3e4))}get webSocket(){return t(this,Ph,"f")}set webSocket(e){t(this,Ph,"f")!=e?(Xh.log("assigning webSocket",e),t(this,Ph,"f")&&ua(t(this,Ph,"f"),t(this,Vh,"f")),ga(e,t(this,Vh,"f")),s(this,Ph,e,"f"),Xh.log("assigned webSocket")):Xh.log("redundant webSocket assignment")}get readyState(){return this.webSocket?.readyState}get isConnected(){return this.readyState==WebSocket.OPEN}get isDisconnected(){return this.readyState==WebSocket.CLOSED}connect(e=`wss://${location.host}`){this.webSocket&&this.assertDisconnection(),this._connectionStatus="connecting",this.webSocket=new WebSocket(e)}disconnect(){this.assertConnection(),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.webSocket.addEventListener("close",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this._connectionStatus="disconnecting",this.webSocket.close()}reconnect(){this.assertDisconnection(),this.connect(this.webSocket.url)}toggleConnection(e){this.isConnected?this.disconnect():e&&this.webSocket?.url==e?this.reconnect():this.connect(e)}sendMessage(e){this.assertConnection(),t(this,Ph,"f").send(e),t(this,Kh,"f").restart()}sendServerMessage(...e){this.sendMessage(lo({type:"serverMessage",data:ro(...e)}))}},e.setAllConsoleLevelFlags=function(e){T.setAllLevelFlags(e)},e.setConsoleLevelFlagsForType=function(e,t){T.setLevelFlagsForType(e,t)}}));
//# sourceMappingURL=brilliantsole.min.js.map
