/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).BS={})}(this,(function(e){"use strict";function t(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)}function s(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s}"function"==typeof SuppressedError&&SuppressedError;const i=!1,n="undefined"!=typeof window&&void 0!==window?.document,a="undefined"!=typeof process&&null!=process?.versions?.node,r=n&&navigator.userAgent||"";let o=!1;n?o=Boolean(navigator.bluetooth):a&&(o=!0);const c=n&&/Bluefy/i.test(r),h=n&&/WebBLE/i.test(r),l=n&&/Android/i.test(r),f=n&&/Safari/i.test(r)&&!/Chrome/i.test(r),g=n&&/iPad|iPhone|iPod/i.test(r),u=n&&/Macintosh/i.test(r),d=!n&&!a&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var p,m,v,w,y=Object.freeze({__proto__:null,isAndroid:l,get isBluetoothSupported(){return o},isIOS:g,isInBluefy:c,isInBrowser:n,isInDev:i,isInLensStudio:d,isInNode:a,isInProduction:!0,isInWebBLE:h,isMac:u,isSafari:f});if(d){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(w={}).log=e,w.warn=e.bind(w,"WARNING"),w.error=e.bind(w,"ERROR")}else w=console;function b(e){return(...t)=>{if(a){const s=function(){const e=(new Error).stack;if(!e)return"";const t=e.split("\n"),s=t[3]||t[2],i=s.match(/at (.*?) \(/)||s.match(/at (.*)/);return i?`[${i[1].trim()}]`:""}();e(s,...t)}else e(...t)}}if(!w.assert){const e=(e,...t)=>{e||w.warn(...t)};w.assert=e}if(!w.table){const e=(...e)=>{w.log(...e)};w.table=e}function S(){}const C=a?b(w.log.bind(w)):w.log.bind(w),E=a?b(w.warn.bind(w)):w.warn.bind(w),M=a?b(w.error.bind(w)):w.error.bind(w),D=a?b(w.table.bind(w)):w.table.bind(w),k=w.assert.bind(w);class W{constructor(e){if(v.set(this,{log:i,warn:i,assert:!0,error:!0,table:!0}),t(p,p,"f",m)[e])throw new Error(`"${e}" console already exists`);t(p,p,"f",m)[e]=this}setLevelFlags(e){Object.assign(t(this,v,"f"),e)}static setLevelFlagsForType(e,s){if(!t(this,p,"f",m)[e])throw new Error(`no console found with type "${e}"`);t(this,p,"f",m)[e].setLevelFlags(s)}static setAllLevelFlags(e){for(const s in t(this,p,"f",m))t(this,p,"f",m)[s].setLevelFlags(e)}static create(e,s){return t(this,p,"f",m)[e]||new p(e)}get log(){return t(this,v,"f").log?C:S}get warn(){return t(this,v,"f").warn?E:S}get error(){return t(this,v,"f").error?M:S}get assert(){return t(this,v,"f").assert?k:S}get table(){return t(this,v,"f").table?D:S}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}assertRangeWithError(e,t,s,i){this.assertWithError(t>=s&&t<=i,`${e} ${t} must be within ${s}-${i}`)}}function T(e,t){return W.create(e,t)}p=W,v=new WeakMap,m={value:{}};const I=T("EventDispatcher",{log:!1});class R{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}updateEventListeners(e){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((t=>(t.shouldRemove&&I.log(`removing "${e}" eventListener`,t),!t.shouldRemove))))}addEventListener(e,t,s={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[],I.log(`creating "${e}" listeners array`,this.listeners[e]));this.listeners[e].find((e=>e.listener==t&&e.once==s.once))?I.log("already added listener"):(I.log(`adding "${e}" listener`,t,s),this.listeners[e].push({listener:t,once:s.once}),I.log(`currently have ${this.listeners[e].length} "${e}" listeners`))}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(I.log(`removing "${e}" listener...`,t),this.listeners[e].forEach((s=>{s.listener===t&&(I.log(`flagging "${e}" listener`,t),s.shouldRemove=!0)})),this.updateEventListeners(e))}removeEventListeners(e){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(I.log(`removing "${e}" listeners...`),this.listeners[e]=[])}removeAllEventListeners(){I.log("removing listeners..."),this.listeners={}}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e].forEach((s=>{if(!s.shouldRemove){I.log(`dispatching "${e}" listener`,s);try{s.listener({type:e,target:this.target,message:t})}catch(e){console.error(e)}s.once&&(I.log(`flagging "${e}" listener`,s),s.shouldRemove=!0)}})),this.updateEventListeners(e))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var U,L,_;const A=T("Timer",{log:!1});class F{get callback(){return t(this,U,"f")}set callback(e){A.assertTypeWithError(e,"function"),A.log({newCallback:e}),s(this,U,e,"f"),this.isRunning&&this.restart()}get interval(){return t(this,L,"f")}set interval(e){A.assertTypeWithError(e,"number"),A.assertWithError(e>0,"interval must be above 0"),A.log({newInterval:e}),s(this,L,e,"f"),this.isRunning&&this.restart()}constructor(e,t){U.set(this,void 0),L.set(this,void 0),_.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=t(this,_,"f")}start(e=!1){this.isRunning?A.log("interval already running"):(A.log(`starting interval every ${t(this,L,"f")}ms`),s(this,_,setInterval(t(this,U,"f"),t(this,L,"f")),"f"),e&&t(this,U,"f").call(this))}stop(){this.isRunning?(A.log("stopping interval"),clearInterval(t(this,_,"f")),s(this,_,void 0,"f")):A.log("interval already not running")}restart(e=!1){this.stop(),this.start(e)}}function x(e){for(let t=0;t<8;++t)e=(1&e?0:3988292384)^e>>>1;return 4278190080^e}U=new WeakMap,L=new WeakMap,_=new WeakMap,T("checksum",{log:!1});const $=new Uint32Array(256);for(let e=0;e<256;++e)$[e]=x(e);function O(e){let t=new Uint8Array(e),s=0;for(let e=0;e<t.byteLength;++e){const i=255&s,n=t[e];s=($[i^n]^s>>>8)>>>0}return s}var B,N;B="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,N="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const P=new B,V=new N,q=T("ArrayBufferUtils",{log:!1});function z(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return j(e)}if(e instanceof Array){return z(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return j(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;return e.forEach((e=>{s.set(new Uint8Array(e),i),i+=e.byteLength})),s.buffer}function j(e){const t=P.encode(e);return z(t.byteLength,t)}function G(e,t,s){let i;return null!=s&&(i=e.byteOffset+t+s),q.log({dataView:e,begin:t,end:i,length:s}),new DataView(e.buffer.slice(e.byteOffset+t,i))}async function H(e){let t;if(e instanceof Array)t=Uint8Array.from(e);else if(e instanceof DataView)t=e.buffer;else if("string"==typeof e||e instanceof URL){const s=await fetch(e);t=await s.arrayBuffer()}else if(e instanceof File)t=await e.arrayBuffer();else{if(!(e instanceof ArrayBuffer))throw{error:"invalid file type",file:e};t=e}return t}function J(e){return Uint8Array.from([e]).buffer}function K(e,{include:t,exclude:s}={}){const i=e=>{const i=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(i):!s||!s.some(i)};for(const[t,s]of(e=>{const t=new Set;do{for(const s of Reflect.ownKeys(e))t.add([e,s])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===s||!i(s))continue;const n=Reflect.getOwnPropertyDescriptor(t,s);n&&"function"==typeof n.value&&(e[s]=e[s].bind(e))}return e}var Q,Z,X,Y,ee,te,se,ie,ne,ae,re,oe,ce,he,le,fe,ge,ue,de,pe,me,ve,we,ye,be,Se,Ce,Ee,Me,De,ke,We,Te,Ie,Re,Ue,Le,_e,Ae,Fe,xe;const $e=T("FileTransferManager",{log:!1}),Oe=["getFileTypes","maxFileLength","getFileType","setFileType","getFileLength","setFileLength","getFileChecksum","setFileChecksum","setFileTransferCommand","fileTransferStatus","getFileBlock","setFileBlock","fileBytesTransferred"],Be=["tflite","wifiServerCert","wifiServerKey"],Ne=["idle","sending","receiving"],Pe=["startSend","startReceive","cancel"],Ve=[...Oe,"fileTransferProgress","fileTransferComplete","fileReceived"],qe=["maxFileLength","getFileLength","getFileChecksum","getFileType","fileTransferStatus"];class ze{constructor(){Q.add(this),ie.set(this,[]),re.set(this,Z.MaxLength),le.set(this,void 0),de.set(this,0),we.set(this,0),Ee.set(this,"idle"),Te.set(this,[]),Re.set(this,void 0),Ue.set(this,0),Fe.set(this,!1),xe.set(this,!1),K(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get fileTypes(){return t(this,ie,"f")}static get MaxLength(){return t(this,Z,"f",ae)}get maxLength(){return t(this,re,"f")}get type(){return t(this,le,"f")}get length(){return t(this,de,"f")}get checksum(){return t(this,we,"f")}get status(){return t(this,Ee,"f")}parseMessage(e,s){switch($e.log({messageType:e}),e){case"getFileTypes":t(this,Q,"m",ne).call(this,s);break;case"maxFileLength":t(this,Q,"m",oe).call(this,s);break;case"getFileType":case"setFileType":t(this,Q,"m",fe).call(this,s);break;case"getFileLength":case"setFileLength":t(this,Q,"m",pe).call(this,s);break;case"getFileChecksum":case"setFileChecksum":t(this,Q,"m",ye).call(this,s);break;case"fileTransferStatus":t(this,Q,"m",Me).call(this,s);break;case"getFileBlock":t(this,Q,"m",Ie).call(this,s);break;case"fileBytesTransferred":t(this,Q,"m",Ae).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}async send(e,s){t(this,Q,"m",ke).call(this),t(this,Q,"m",Y).call(this,e);const i=await H(s),n=i.byteLength,a=O(i);if(e!=this.type)$e.log("different fileTypes - sending");else if(n!=this.length)$e.log("different fileLengths - sending");else{if(a==this.checksum)return $e.log("already sent file"),!1;$e.log("different fileChecksums - sending")}const r=[];return r.push(t(this,Q,"m",ue).call(this,e,!1)),r.push(t(this,Q,"m",ve).call(this,n,!1)),r.push(t(this,Q,"m",Se).call(this,a,!1)),r.push(t(this,Q,"m",Ce).call(this,"startSend",!1)),this.sendMessage(),await Promise.all(r),await t(this,Q,"m",Le).call(this,i),!0}async receive(e){t(this,Q,"m",ke).call(this),t(this,Q,"m",Y).call(this,e),await t(this,Q,"m",ue).call(this,e),await t(this,Q,"m",Ce).call(this,"startReceive")}async cancel(){t(this,Q,"m",We).call(this),$e.log("cancelling file transfer..."),s(this,Fe,!0,"f"),await t(this,Q,"m",Ce).call(this,"cancel")}get isServerSide(){return t(this,xe,"f")}set isServerSide(e){t(this,xe,"f")!=e?($e.log({newIsServerSide:e}),s(this,xe,e,"f")):$e.log("redundant isServerSide assignment")}requestRequiredInformation(){$e.log("requesting required fileTransfer information");const e=qe.map((e=>({type:e})));this.sendMessage(e,!1)}}Z=ze,ie=new WeakMap,re=new WeakMap,le=new WeakMap,de=new WeakMap,we=new WeakMap,Ee=new WeakMap,Te=new WeakMap,Re=new WeakMap,Ue=new WeakMap,Fe=new WeakMap,xe=new WeakMap,Q=new WeakSet,X=function(){return this.eventDispatcher.dispatchEvent},Y=function(e){$e.assertEnumWithError(e,Be)},ee=function(e){$e.assertWithError(e in Be,`invalid typeEnum ${e}`)},te=function(e){$e.assertWithError(e in Ne,`invalid statusEnum ${e}`)},se=function(e){$e.assertEnumWithError(e,Pe)},ne=function(e){const i=Array.from(new Uint8Array(e.buffer)).map((e=>Be[e])).filter(Boolean);s(this,ie,i,"f"),$e.log("fileTypes",i),t(this,Q,"a",X).call(this,"getFileTypes",{fileTypes:t(this,ie,"f")})},oe=function(e){$e.log("parseFileMaxLength",e);const s=e.getUint32(0,!0);$e.log(`maxLength: ${s/1024}kB`),t(this,Q,"m",ce).call(this,s)},ce=function(e){$e.log({maxLength:e}),s(this,re,e,"f"),t(this,Q,"a",X).call(this,"maxFileLength",{maxFileLength:e})},he=function(e){$e.assertWithError(e<=this.maxLength,`file length ${e}kB too large - must be ${this.maxLength}kB or less`)},fe=function(e){$e.log("parseFileType",e);const s=e.getUint8(0);t(this,Q,"m",ee).call(this,s);const i=Be[s];t(this,Q,"m",ge).call(this,i)},ge=function(e){$e.log({fileTransferType:e}),s(this,le,e,"f"),t(this,Q,"a",X).call(this,"getFileType",{fileType:e})},ue=async function(e,s){if(t(this,Q,"m",Y).call(this,e),this.type==e)return void $e.log(`redundant type assignment ${e}`);const i=this.waitForEvent("getFileType"),n=Be.indexOf(e);this.sendMessage([{type:"setFileType",data:J(n)}],s),await i},pe=function(e){$e.log("parseFileLength",e);const s=e.getUint32(0,!0);t(this,Q,"m",me).call(this,s)},me=function(e){$e.log(`length: ${e/1024}kB`),s(this,de,e,"f"),t(this,Q,"a",X).call(this,"getFileLength",{fileLength:e})},ve=async function(e,s){if($e.assertTypeWithError(e,"number"),t(this,Q,"m",he).call(this,e),this.length==e)return void $e.log(`redundant length assignment ${e}`);const i=this.waitForEvent("getFileLength"),n=new DataView(new ArrayBuffer(4));n.setUint32(0,e,!0),this.sendMessage([{type:"setFileLength",data:n.buffer}],s),await i},ye=function(e){$e.log("checksum",e);const s=e.getUint32(0,!0);t(this,Q,"m",be).call(this,s)},be=function(e){$e.log({checksum:e}),s(this,we,e,"f"),t(this,Q,"a",X).call(this,"getFileChecksum",{fileChecksum:e})},Se=async function(e,t){if($e.assertTypeWithError(e,"number"),this.checksum==e)return void $e.log(`redundant checksum assignment ${e}`);const s=this.waitForEvent("getFileChecksum"),i=new DataView(new ArrayBuffer(4));i.setUint32(0,e,!0),this.sendMessage([{type:"setFileChecksum",data:i.buffer}],t),await s},Ce=async function(e,s){t(this,Q,"m",se).call(this,e);const i=this.waitForEvent("fileTransferStatus");$e.log(`setting command ${e}`);const n=Pe.indexOf(e);this.sendMessage([{type:"setFileTransferCommand",data:J(n)}],s),await i},Me=function(e){$e.log("parseFileStatus",e);const s=e.getUint8(0);t(this,Q,"m",te).call(this,s);const i=Ne[s];t(this,Q,"m",De).call(this,i)},De=function(e){$e.log({status:e}),s(this,Ee,e,"f"),t(this,Q,"a",X).call(this,"fileTransferStatus",{fileTransferStatus:e}),t(this,Te,"f").length=0,s(this,Fe,!1,"f")},ke=function(){$e.assertWithError("idle"==t(this,Ee,"f"),"status is not idle")},We=function(){$e.assertWithError("idle"!=t(this,Ee,"f"),"status is idle")},Ie=async function(e){$e.log("parseFileBlock",e),t(this,Te,"f").push(e.buffer);const s=t(this,Te,"f").reduce(((e,t)=>e+t.byteLength),0),i=s/t(this,de,"f");if($e.log(`received ${s} of ${t(this,de,"f")} bytes (${100*i}%)`),t(this,Q,"a",X).call(this,"fileTransferProgress",{progress:i}),s!=t(this,de,"f")){const e=new DataView(new ArrayBuffer(4));if(e.setUint32(0,s,!0),this.isServerSide)return;return void await this.sendMessage([{type:"fileBytesTransferred",data:e.buffer}])}$e.log("file transfer complete");let n,a=(new Date).toLocaleString();switch(this.type){case"tflite":a+=".tflite";break;case"wifiServerCert":a+="_server.crt";break;case"wifiServerKey":a+="_server.key"}n="undefined"!=typeof File?new File(t(this,Te,"f"),a):new Blob(t(this,Te,"f"));const r=O(await n.arrayBuffer());$e.log({checksum:r}),r==t(this,we,"f")?($e.log("received file",n),t(this,Q,"a",X).call(this,"getFileBlock",{fileTransferBlock:e}),t(this,Q,"a",X).call(this,"fileTransferComplete",{direction:"receiving"}),t(this,Q,"a",X).call(this,"fileReceived",{file:n})):$e.error(`wrong checksum - expected ${t(this,we,"f")}, got ${r}`)},Le=async function(e){return s(this,Re,e,"f"),s(this,Ue,0,"f"),t(this,Q,"m",_e).call(this)},_e=async function(){if("sending"!=this.status)return;if(t(this,Fe,"f"))return void $e.error("not sending block - busy cancelling");if(!t(this,Re,"f"))return void(this.isServerSide||$e.error("no buffer defined"));const e=t(this,Re,"f");let i=t(this,Ue,"f");const n=e.slice(i,i+(this.mtu-3-3));$e.log("slicedBuffer",n);const a=1-(e.byteLength-i)/e.byteLength;$e.log(`sending bytes ${i}-${i+n.byteLength} of ${e.byteLength} bytes (${100*a}%)`),t(this,Q,"a",X).call(this,"fileTransferProgress",{progress:a}),0==n.byteLength?($e.log("finished sending buffer"),t(this,Q,"a",X).call(this,"fileTransferComplete",{direction:"sending"})):(await this.sendMessage([{type:"setFileBlock",data:n}]),s(this,Ue,i+n.byteLength,"f"))},Ae=async function(e){$e.log("parseBytesTransferred",e);const s=e.getUint32(0,!0);if($e.log({bytesTransferred:s}),"sending"==this.status)return this.isServerSide||t(this,Ue,"f")==s?void t(this,Q,"m",_e).call(this):($e.error(`bytesTransferred are not equal - got ${s}, expected ${t(this,Ue,"f")}`),void this.cancel());$e.error("not currently sending file")},ae={value:0};const je=T("MathUtils",{log:!1});const Ge=65536;function He(e,t){const s=Date.now();var i;let n=(i=s)-i%Ge+e.getUint16(t,!0);return Math.abs(s-n)>6e4&&(je.log("correcting timestamp delta"),n+=Ge*Math.sign(s-n)),n}function Je(e,t=0,s=1){return Math.min(Math.max(e,t),s)}var Ke,Qe,Ze;const Xe={min:1/0,max:-1/0,span:0};class Ye{constructor(){Ke.add(this),Qe.set(this,Object.assign({},Xe))}get min(){return t(this,Qe,"f").min}get max(){return t(this,Qe,"f").max}set min(e){t(this,Qe,"f").min=e,t(this,Qe,"f").max=Math.max(e,t(this,Qe,"f").max),t(this,Ke,"m",Ze).call(this)}set max(e){t(this,Qe,"f").max=e,t(this,Qe,"f").min=Math.min(e,t(this,Qe,"f").min),t(this,Ke,"m",Ze).call(this)}reset(){Object.assign(t(this,Qe,"f"),Xe)}update(e){t(this,Qe,"f").min=Math.min(e,t(this,Qe,"f").min),t(this,Qe,"f").max=Math.max(e,t(this,Qe,"f").max),t(this,Ke,"m",Ze).call(this)}getNormalization(e,s){let i=function(e,t,s,i){return null==i&&(i=s-t),(e-t)/i}(e,t(this,Qe,"f").min,t(this,Qe,"f").max,t(this,Qe,"f").span);return s&&(i*=t(this,Qe,"f").span),i||0}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}var et,tt,st,it,nt;Qe=new WeakMap,Ke=new WeakSet,Ze=function(){t(this,Qe,"f").span=t(this,Qe,"f").max-t(this,Qe,"f").min};class at{constructor(){et.set(this,{x:new Ye,y:new Ye})}reset(){t(this,et,"f").x.reset(),t(this,et,"f").y.reset()}update(e){t(this,et,"f").x.update(e.x),t(this,et,"f").y.update(e.y)}getNormalization(e,s){return{x:t(this,et,"f").x.getNormalization(e.x,s),y:t(this,et,"f").y.getNormalization(e.y,s)}}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}et=new WeakMap;const rt=T("PressureDataManager",{log:!1}),ot=["pressure"],ct=ot;class ht{constructor(){tt.set(this,[]),st.set(this,void 0),it.set(this,new Ye),nt.set(this,new at)}get positions(){return t(this,tt,"f")}get numberOfSensors(){return this.positions.length}parsePositions(e){const t=[];for(let s=0,i=0;i<e.byteLength;s++,i+=2)t.push({x:e.getUint8(i)/256,y:e.getUint8(i+1)/256});var i,n;rt.log({positions:t}),s(this,tt,t,"f"),s(this,st,(i=this.numberOfSensors,n=()=>new Ye,new Array(i).fill(1).map(((e,t)=>{if("function"==typeof n)return n(t);{const e=n;return Object.assign({},e)}}))),"f"),this.resetRange()}resetRange(){t(this,st,"f")?.forEach((e=>e.reset())),t(this,nt,"f").reset(),t(this,it,"f").reset()}parseData(e,s){const i={sensors:[],scaledSum:0,normalizedSum:0};for(let n=0,a=0;a<e.byteLength;n++,a+=2){const r=e.getUint16(a,!0);let o=r*s/this.numberOfSensors;const c=t(this,st,"f")[n].updateAndGetNormalization(o,!1),h=this.positions[n];i.sensors[n]={rawValue:r,scaledValue:o,normalizedValue:c,position:h,weightedValue:0},i.scaledSum+=o}return i.normalizedSum=t(this,it,"f").updateAndGetNormalization(i.scaledSum,!1),i.scaledSum>0&&(i.center={x:0,y:0},i.sensors.forEach((e=>{e.weightedValue=e.scaledValue/i.scaledSum,i.center.x+=e.position.x*e.weightedValue,i.center.y+=e.position.y*e.weightedValue})),i.normalizedCenter=t(this,nt,"f").updateAndGetNormalization(i.center,!1)),rt.log({pressure:i}),i}}tt=new WeakMap,st=new WeakMap,it=new WeakMap,nt=new WeakMap;const lt=T("MotionSensorDataManager",{log:!1}),ft=["still","walking","running","bicycle","vehicle","tilting"],gt=["portraitUpright","landscapeLeft","portraitUpsideDown","landscapeRight","unknown"];class ut{parseVector3(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));const a={x:s,y:i,z:n};return lt.log({vector:a}),a}parseQuaternion(e,t){let[s,i,n,a]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0),e.getInt16(6,!0)].map((e=>e*t));const r={x:s,y:i,z:n,w:a};return lt.log({quaternion:r}),r}parseEuler(e,t){let[s,i,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));i*=-1,s*=-1,s<0&&(s+=360);const a={heading:s,pitch:i,roll:n};return lt.log({euler:a}),a}parseStepCounter(e){lt.log("parseStepCounter",e);const t=e.getUint32(0,!0);return lt.log({stepCount:t}),t}parseActivity(e){lt.log("parseActivity",e);const t={},s=e.getUint8(0);return lt.log("activityBitfield",s.toString(2)),ft.forEach(((e,i)=>{t[e]=Boolean(s&1<<i)})),lt.log("activity",t),t}parseDeviceOrientation(e){lt.log("parseDeviceOrientation",e);const t=e.getUint8(0),s=gt[t];return lt.assertWithError(s,"undefined deviceOrientation"),lt.log({deviceOrientation:s}),s}}var dt,pt;const mt=["barometer"],vt=mt,wt=T("BarometerSensorDataManager",{log:!1});class yt{constructor(){dt.add(this)}parseData(e,s){const i=e.getUint32(0,!0)*s,n=t(this,dt,"m",pt).call(this,i);return wt.log({pressure:i,altitude:n}),{pressure:i}}}dt=new WeakSet,pt=function(e){const t=.0065;return 288.15/t*(1-Math.pow(e/101325,.19026643566373183))};const bt=T("ParseUtils",{log:!1});function St(e,t=0){const s=e.getUint8(t++);return{string:V.decode(e.buffer.slice(e.byteOffset+t,e.byteOffset+t+s)),byteOffset:t+=s}}function Ct(e,t,s,i,n=!1){let a=0;for(;a<e.byteLength;){const r=e.getUint8(a++);bt.assertWithError(r in t,`invalid messageTypeEnum ${r}`);const o=t[r];let c;n?(c=e.getUint16(a,!0),a+=2):c=e.getUint8(a++),bt.log({messageTypeEnum:r,messageType:o,messageLength:c,dataView:e,byteOffset:a});const h=G(e,a,c);bt.log({_dataView:h}),s(o,h,i),a+=c}}var Et,Mt,Dt,kt,Wt,Tt,It,Rt,Ut,Lt,_t,At,Ft,xt,$t,Ot,Bt,Nt,Pt,Vt,qt,zt,jt,Gt,Ht,Jt,Kt,Qt,Zt;const Xt=T("CameraManager",{log:!1}),Yt=["focus","takePicture","stop","sleep","wake"],es=["idle","focusing","takingPicture","asleep"],ts=["headerSize","header","imageSize","image","footerSize","footer"],ss=["resolution","qualityFactor","shutter","gain","redGain","greenGain","blueGain"],is=["cameraStatus","cameraCommand","getCameraConfiguration","setCameraConfiguration","cameraData"],ns=["getCameraConfiguration","cameraStatus"],as=[...is,"cameraImageProgress","cameraImage"];class rs{constructor(){Et.add(this),kt.set(this,void 0),At.set(this,0),Ft.set(this,void 0),xt.set(this,0),$t.set(this,0),Ot.set(this,void 0),Bt.set(this,0),Nt.set(this,0),Pt.set(this,void 0),Vt.set(this,0),qt.set(this,!1),jt.set(this,{}),Gt.set(this,void 0),Ht.set(this,{resolution:{min:100,max:720},qualityFactor:{min:15,max:60},shutter:{min:4,max:16383},gain:{min:1,max:248},redGain:{min:0,max:1023},greenGain:{min:0,max:1023},blueGain:{min:0,max:1023}}),K(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Xt.log("requesting required camera information");const e=ns.map((e=>({type:e})));this.sendMessage(e,!1)}get cameraStatus(){return t(this,kt,"f")}async focus(){t(this,Et,"m",Ut).call(this),await t(this,Et,"m",It).call(this,"focus")}async takePicture(){t(this,Et,"m",Ut).call(this),await t(this,Et,"m",It).call(this,"takePicture")}async stop(){t(this,Et,"m",Ut).call(this),await t(this,Et,"m",It).call(this,"stop")}async sleep(){t(this,Et,"m",Ut).call(this),await t(this,Et,"m",It).call(this,"sleep")}async wake(){t(this,Et,"m",Rt).call(this),await t(this,Et,"m",It).call(this,"wake")}get cameraConfiguration(){return t(this,jt,"f")}get availableCameraConfigurationTypes(){return t(this,Gt,"f")}get cameraConfigurationRanges(){return t(this,Ht,"f")}async setCameraConfiguration(e){if(Xt.log({newCameraConfiguration:e}),t(this,Et,"m",Kt).call(this,e))return void Xt.log("redundant camera configuration");const s=t(this,Et,"m",Zt).call(this,e);Xt.log({setCameraConfigurationData:s});const i=this.waitForEvent("getCameraConfiguration");this.sendMessage([{type:"setCameraConfiguration",data:s.buffer}]),await i}static AssertValidCameraConfigurationType(e){Xt.assertEnumWithError(e,ss)}static AssertValidCameraConfigurationTypeEnum(e){Xt.assertTypeWithError(e,"number"),Xt.assertWithError(e in ss,`invalid cameraConfigurationTypeEnum ${e}`)}parseMessage(e,s){switch(Xt.log({messageType:e,dataView:s}),e){case"cameraStatus":t(this,Et,"m",Wt).call(this,s);break;case"getCameraConfiguration":case"setCameraConfiguration":t(this,Et,"m",Jt).call(this,s);break;case"cameraData":t(this,Et,"m",Lt).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){s(this,kt,void 0,"f"),s(this,xt,0,"f"),s(this,Bt,0,"f"),s(this,Vt,0,"f")}}function os(e,t,s){const i=function(e,t,s){const i=new ArrayBuffer(44+2*e.length),n=new DataView(i);cs(n,0,"RIFF"),n.setUint32(4,36+2*e.length,!0),cs(n,8,"WAVE"),cs(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,s,!0),n.setUint32(24,t,!0),n.setUint32(28,t*s*2,!0),n.setUint16(32,2*s,!0),n.setUint16(34,16,!0),cs(n,36,"data"),n.setUint32(40,2*e.length,!0);for(let t=0;t<e.length;t++)n.setInt16(44+2*t,32767*e[t],!0);return i}(e,t,s);return new Blob([i],{type:"audio/wav"})}function cs(e,t,s){for(let i=0;i<s.length;i++)e.setUint8(t+i,s.charCodeAt(i))}var hs,ls,fs,gs,us,ds,ps,ms,vs,ws,ys,bs,Ss,Cs,Es,Ms,Ds,ks,Ws,Ts,Is,Rs,Us,Ls;Mt=rs,kt=new WeakMap,At=new WeakMap,Ft=new WeakMap,xt=new WeakMap,$t=new WeakMap,Ot=new WeakMap,Bt=new WeakMap,Nt=new WeakMap,Pt=new WeakMap,Vt=new WeakMap,qt=new WeakMap,jt=new WeakMap,Gt=new WeakMap,Ht=new WeakMap,Et=new WeakSet,Dt=function(){return this.eventDispatcher.dispatchEvent},Wt=function(e){const s=e.getUint8(0),i=es[s];t(this,Et,"m",Tt).call(this,i)},Tt=function(e){if(Xt.assertEnumWithError(e,es),e==t(this,kt,"f"))return void Xt.log(`redundant cameraStatus ${e}`);const i=t(this,kt,"f");s(this,kt,e,"f"),Xt.log(`updated cameraStatus to "${this.cameraStatus}"`),t(this,Et,"a",Dt).call(this,"cameraStatus",{cameraStatus:this.cameraStatus,previousCameraStatus:i}),"takingPicture"!=t(this,kt,"f")&&t(this,Bt,"f")>0&&!t(this,qt,"f")&&t(this,Et,"m",zt).call(this)},It=async function(e,t){Xt.assertEnumWithError(e,Yt),Xt.log(`sending camera command "${e}"`);const s=this.waitForEvent("cameraStatus");Xt.log(`setting command "${e}"`);const i=Yt.indexOf(e);this.sendMessage([{type:"cameraCommand",data:J(i)}],t),await s},Rt=function(){Xt.assertWithError("asleep"==t(this,kt,"f"),`camera is not asleep - currently ${t(this,kt,"f")}`)},Ut=function(){Xt.assertWithError("asleep"!=t(this,kt,"f"),`camera is not awake - currently ${t(this,kt,"f")}`)},Lt=function(e){Xt.log("parsing camera data",e),Ct(e,ts,t(this,Et,"m",_t).bind(this),null,!0)},_t=function(e,i){switch(Xt.log({cameraDataType:e,dataView:i}),e){case"headerSize":s(this,At,i.getUint16(0,!0),"f"),Xt.log({headerSize:t(this,At,"f")}),s(this,Ft,void 0,"f"),t(this,xt,"f");break;case"header":s(this,Ft,z(t(this,Ft,"f"),i),"f"),Xt.log({headerData:t(this,Ft,"f")}),s(this,xt,t(this,Ft,"f")?.byteLength/t(this,At,"f"),"f"),Xt.log({headerProgress:t(this,xt,"f")}),t(this,Et,"a",Dt).call(this,"cameraImageProgress",{progress:t(this,xt,"f"),type:"header"}),1==t(this,xt,"f")&&Xt.log("finished getting header data");break;case"imageSize":s(this,$t,i.getUint16(0,!0),"f"),Xt.log({imageSize:t(this,$t,"f")}),s(this,Ot,void 0,"f"),t(this,Bt,"f"),s(this,qt,!1,"f");break;case"image":s(this,Ot,z(t(this,Ot,"f"),i),"f"),Xt.log({imageData:t(this,Ot,"f")}),s(this,Bt,t(this,Ot,"f")?.byteLength/t(this,$t,"f"),"f"),Xt.log({imageProgress:t(this,Bt,"f")}),t(this,Et,"a",Dt).call(this,"cameraImageProgress",{progress:t(this,Bt,"f"),type:"image"}),1==t(this,Bt,"f")&&(Xt.log("finished getting image data"),1==t(this,xt,"f")&&t(this,Et,"m",zt).call(this));break;case"footerSize":s(this,Nt,i.getUint16(0,!0),"f"),Xt.log({footerSize:t(this,Nt,"f")}),s(this,Pt,void 0,"f"),t(this,Vt,"f");break;case"footer":s(this,Pt,z(t(this,Pt,"f"),i),"f"),Xt.log({footerData:t(this,Pt,"f")}),s(this,Vt,t(this,Pt,"f")?.byteLength/t(this,Nt,"f"),"f"),Xt.log({footerProgress:t(this,Vt,"f")}),t(this,Et,"a",Dt).call(this,"cameraImageProgress",{progress:t(this,Vt,"f"),type:"footer"}),1==t(this,Vt,"f")&&(Xt.log("finished getting footer data"),1==t(this,Bt,"f")&&t(this,Et,"m",zt).call(this))}},zt=function(){Xt.log("building image...");const e=z(t(this,Ft,"f"),t(this,Ot,"f"),t(this,Pt,"f"));Xt.log({imageData:e});let i=new Blob([e],{type:"image/jpeg"});Xt.log("created blob",i);const n=URL.createObjectURL(i);Xt.log("created url",n),t(this,Et,"a",Dt).call(this,"cameraImage",{url:n,blob:i}),s(this,qt,!0,"f")},Jt=function(e){const i={};let n=0;for(;n<e.byteLength;){const t=e.getUint8(n++),s=ss[t];Xt.assertWithError(s,`invalid cameraConfigurationTypeIndex ${t}`),i[s]=e.getUint16(n,!0),n+=2}Xt.log({parsedCameraConfiguration:i}),s(this,Gt,Object.keys(i),"f"),s(this,jt,i,"f"),t(this,Et,"a",Dt).call(this,"getCameraConfiguration",{cameraConfiguration:t(this,jt,"f")})},Kt=function(e){return Object.keys(e).every((t=>this.cameraConfiguration[t]==e[t]))},Qt=function(e){Xt.assertWithError(t(this,Gt,"f"),"must get initial cameraConfiguration");const s=t(this,Gt,"f")?.includes(e);return Xt.assertWithError(s,`unavailable camera configuration type "${e}"`),s},Zt=function(e){let s=Object.keys(e);s=s.filter((e=>t(this,Et,"m",Qt).call(this,e)));const i=new DataView(new ArrayBuffer(3*s.length));return s.forEach(((t,s)=>{Mt.AssertValidCameraConfigurationType(t);const n=ss.indexOf(t);i.setUint8(3*s,n);const a=e[t];i.setUint16(3*s+1,a,!0)})),Xt.log({sensorConfigurationData:i}),i},T("AudioUtils",{log:!0});const _s=T("MicrophoneManager",{log:!1}),As=["start","stop","vad"],Fs=["idle","streaming","vad"],xs=["sampleRate","bitDepth"],$s=["8","16"],Os=["microphoneStatus","microphoneCommand","getMicrophoneConfiguration","setMicrophoneConfiguration","microphoneData"],Bs={sampleRate:["8000","16000"],bitDepth:$s},Ns=["getMicrophoneConfiguration","microphoneStatus"],Ps=[...Os,"isRecordingMicrophone","microphoneRecording"];class Vs{constructor(){hs.add(this),gs.set(this,void 0),ws.set(this,.001),ys.set(this,0),Cs.set(this,{}),Es.set(this,void 0),Ts.set(this,void 0),Is.set(this,void 0),Rs.set(this,void 0),Us.set(this,!1),Ls.set(this,void 0),K(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){_s.log("requesting required microphone information");const e=Ns.map((e=>({type:e})));this.sendMessage(e,!1)}get microphoneStatus(){return t(this,gs,"f")}async start(){await t(this,hs,"m",ps).call(this,"start")}async stop(){t(this,hs,"m",ms).call(this),await t(this,hs,"m",ps).call(this,"stop")}async vad(){await t(this,hs,"m",ps).call(this,"vad")}async toggle(){switch(this.microphoneStatus){case"idle":this.start();break;case"streaming":this.stop()}}get microphoneConfiguration(){return t(this,Cs,"f")}get availableMicrophoneConfigurationTypes(){return t(this,Es,"f")}get bitDepth(){return t(this,Cs,"f").bitDepth}get sampleRate(){return t(this,Cs,"f").sampleRate}async setMicrophoneConfiguration(e){if(_s.log({newMicrophoneConfiguration:e}),t(this,hs,"m",Ds).call(this,e))return void _s.log("redundant microphone configuration");const s=t(this,hs,"m",Ws).call(this,e);_s.log({setMicrophoneConfigurationData:s});const i=this.waitForEvent("getMicrophoneConfiguration");this.sendMessage([{type:"setMicrophoneConfiguration",data:s.buffer}]),await i}static AssertValidMicrophoneConfigurationType(e){_s.assertEnumWithError(e,xs)}static AssertValidMicrophoneConfigurationTypeEnum(e){_s.assertTypeWithError(e,"number"),_s.assertWithError(e in xs,`invalid microphoneConfigurationTypeEnum ${e}`)}parseMessage(e,s){switch(_s.log({messageType:e,dataView:s}),e){case"microphoneStatus":t(this,hs,"m",us).call(this,s);break;case"getMicrophoneConfiguration":case"setMicrophoneConfiguration":t(this,hs,"m",Ms).call(this,s);break;case"microphoneData":t(this,hs,"m",bs).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}get audioContext(){return t(this,Ts,"f")}set audioContext(e){t(this,Ts,"f")!=e?(s(this,Ts,e,"f"),_s.log("assigned new audioContext",t(this,Ts,"f")),t(this,Ts,"f")?s(this,ys,t(this,Ts,"f").currentTime,"f"):(t(this,Rs,"f")&&(t(this,Rs,"f").disconnect(),s(this,Rs,void 0,"f")),t(this,Is,"f")&&(t(this,Is,"f").disconnect(),s(this,Is,void 0,"f")))):_s.log("redundant audioContext assignment",t(this,Ts,"f"))}get gainNode(){return _s.assertWithError(t(this,Ts,"f"),"audioContext assignment required for gainNode"),t(this,Is,"f")||(_s.log("creating gainNode..."),s(this,Is,t(this,Ts,"f").createGain(),"f"),_s.log("created gainNode",t(this,Is,"f"))),t(this,Is,"f")}get mediaStreamDestination(){return _s.assertWithError(t(this,Ts,"f"),"audioContext assignment required for mediaStreamDestination"),t(this,Rs,"f")||(_s.log("creating mediaStreamDestination..."),s(this,Rs,t(this,Ts,"f").createMediaStreamDestination(),"f"),this.gainNode?.connect(t(this,Rs,"f")),_s.log("created mediaStreamDestination",t(this,Rs,"f"))),t(this,Rs,"f")}get isRecording(){return t(this,Us,"f")}startRecording(){this.isRecording?_s.log("already recording"):(s(this,Ls,[],"f"),s(this,Us,!0,"f"),t(this,hs,"a",fs).call(this,"isRecordingMicrophone",{isRecordingMicrophone:this.isRecording}))}stopRecording(){if(this.isRecording){if(s(this,Us,!1,"f"),t(this,Ls,"f")&&t(this,Ls,"f").length>0){_s.log("parsing microphone data...",t(this,Ls,"f").length);const e=z(...t(this,Ls,"f")),s=new Float32Array(e),i=os(s,Number(this.sampleRate),1),n=URL.createObjectURL(i);t(this,hs,"a",fs).call(this,"microphoneRecording",{samples:s,sampleRate:this.sampleRate,bitDepth:this.bitDepth,blob:i,url:n})}s(this,Ls,void 0,"f"),t(this,hs,"a",fs).call(this,"isRecordingMicrophone",{isRecordingMicrophone:this.isRecording})}else _s.log("already not recording")}toggleRecording(){t(this,Us,"f")?this.stopRecording():this.startRecording()}clear(){s(this,gs,void 0,"f"),s(this,Cs,{},"f"),this.isRecording&&this.stopRecording()}}var qs;ls=Vs,gs=new WeakMap,ws=new WeakMap,ys=new WeakMap,Cs=new WeakMap,Es=new WeakMap,Ts=new WeakMap,Is=new WeakMap,Rs=new WeakMap,Us=new WeakMap,Ls=new WeakMap,hs=new WeakSet,fs=function(){return this.eventDispatcher.dispatchEvent},us=function(e){const s=e.getUint8(0),i=Fs[s];t(this,hs,"m",ds).call(this,i)},ds=function(e){if(_s.assertEnumWithError(e,Fs),e==t(this,gs,"f"))return void _s.log(`redundant microphoneStatus ${e}`);const i=t(this,gs,"f");s(this,gs,e,"f"),_s.log(`updated microphoneStatus to "${this.microphoneStatus}"`),t(this,hs,"a",fs).call(this,"microphoneStatus",{microphoneStatus:this.microphoneStatus,previousMicrophoneStatus:i})},ps=async function(e,t){_s.assertEnumWithError(e,As),_s.log(`sending microphone command "${e}"`);const s=this.waitForEvent("microphoneStatus");_s.log(`setting command "${e}"`);const i=As.indexOf(e);this.sendMessage([{type:"microphoneCommand",data:J(i)}],t),await s},ms=function(){_s.assertWithError("idle"!=t(this,gs,"f"),"microphone is idle")},vs=function(){_s.assertEnumWithError(this.bitDepth,$s)},bs=function(e){t(this,hs,"m",vs).call(this),_s.log("parsing microphone data",e);const i=e.byteLength/t(this,hs,"a",Ss),n=new Float32Array(i);for(let t=0;t<i;t++){let s;switch(this.bitDepth){case"16":s=e.getInt16(2*t,!0),n[t]=s/32768;break;case"8":s=e.getInt8(t),n[t]=s/128}}if(_s.log("samples",n),t(this,Us,"f")&&t(this,Ls,"f")&&t(this,Ls,"f").push(n),t(this,Ts,"f")&&t(this,Is,"f")){const e=t(this,Ts,"f").createBuffer(1,n.length,Number(this.sampleRate));e.getChannelData(0).set(n);const i=t(this,Ts,"f").createBufferSource();i.buffer=e;const a=e.getChannelData(0),r=Number(this.sampleRate);for(let e=0;e<t(this,ws,"f")*r;e++)a[e]*=e/(t(this,ws,"f")*r);for(let e=a.length-1;e>=a.length-t(this,ws,"f")*r;e--)a[e]*=(a.length-e)/(t(this,ws,"f")*r);i.connect(t(this,Is,"f")),t(this,ys,"f")<t(this,Ts,"f").currentTime&&s(this,ys,t(this,Ts,"f").currentTime,"f"),i.start(t(this,ys,"f")),s(this,ys,t(this,ys,"f")+e.duration,"f")}t(this,hs,"a",fs).call(this,"microphoneData",{samples:n,sampleRate:this.sampleRate,bitDepth:this.bitDepth})},Ss=function(){switch(this.bitDepth){case"8":return 1;case"16":return 2}},Ms=function(e){const i={};let n=0;for(;n<e.byteLength;){const t=e.getUint8(n++),s=xs[t];_s.assertWithError(s,`invalid microphoneConfigurationTypeIndex ${t}`);let a=e.getUint8(n++);const r=Bs[s],o=r[a];_s.assertEnumWithError(o,r),_s.log({microphoneConfigurationType:s,value:o}),i[s]=o}_s.log({parsedMicrophoneConfiguration:i}),s(this,Es,Object.keys(i),"f"),s(this,Cs,i,"f"),t(this,hs,"a",fs).call(this,"getMicrophoneConfiguration",{microphoneConfiguration:t(this,Cs,"f")})},Ds=function(e){return Object.keys(e).every((t=>this.microphoneConfiguration[t]==e[t]))},ks=function(e){_s.assertWithError(t(this,Es,"f"),"must get initial microphoneConfiguration");const s=t(this,Es,"f")?.includes(e);return _s.assertWithError(s,`unavailable microphone configuration type "${e}"`),s},Ws=function(e){let s=Object.keys(e);s=s.filter((e=>t(this,hs,"m",ks).call(this,e)));const i=new DataView(new ArrayBuffer(2*s.length));return s.forEach(((t,s)=>{ls.AssertValidMicrophoneConfigurationType(t);const n=xs.indexOf(t);i.setUint8(2*s,n);let a=e[t];"number"==typeof a&&(a=a.toString());const r=Bs[t];_s.assertEnumWithError(a,r);const o=r.indexOf(a);i.setUint8(2*s+1,o)})),_s.log({sensorConfigurationData:i}),i};const zs=T("SensorDataManager",{log:!1}),js=[...ot,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation","activity","stepCounter","stepDetector","deviceOrientation","tapDetector",...mt,"camera","microphone"],Gs=[...ct,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation",...vt],Hs=["getPressurePositions","getSensorScalars","sensorData"],Js=["getPressurePositions"],Ks=[...Hs,...js];class Qs{constructor(){this.pressureSensorDataManager=new ht,this.motionSensorDataManager=new ut,this.barometerSensorDataManager=new yt,qs.set(this,new Map)}static AssertValidSensorType(e){zs.assertEnumWithError(e,js)}static AssertValidSensorTypeEnum(e){zs.assertTypeWithError(e,"number"),zs.assertWithError(e in js,`invalid sensorTypeEnum ${e}`)}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}parseMessage(e,t){switch(zs.log({messageType:e}),e){case"getSensorScalars":this.parseScalars(t);break;case"getPressurePositions":this.pressureSensorDataManager.parsePositions(t);break;case"sensorData":this.parseData(t);break;default:throw Error(`uncaught messageType ${e}`)}}parseScalars(e){for(let s=0;s<e.byteLength;s+=5){const i=e.getUint8(s),n=js[i];if(!n){zs.warn(`unknown sensorType index ${i}`);continue}const a=e.getFloat32(s+1,!0);zs.log({sensorType:n,sensorScalar:a}),t(this,qs,"f").set(n,a)}}parseData(e){zs.log("sensorData",Array.from(new Uint8Array(e.buffer)));let t=0;const s=He(e,t);t+=2;Ct(new DataView(e.buffer,t),js,this.parseDataCallback.bind(this),{timestamp:s})}parseDataCallback(e,s,{timestamp:i}){const n=t(this,qs,"f").get(e)||1;let a=null;switch(e){case"pressure":a=this.pressureSensorDataManager.parseData(s,n);break;case"acceleration":case"gravity":case"linearAcceleration":case"gyroscope":case"magnetometer":a=this.motionSensorDataManager.parseVector3(s,n);break;case"gameRotation":case"rotation":a=this.motionSensorDataManager.parseQuaternion(s,n);break;case"orientation":a=this.motionSensorDataManager.parseEuler(s,n);break;case"stepCounter":a=this.motionSensorDataManager.parseStepCounter(s);break;case"stepDetector":case"tapDetector":a={};break;case"activity":a=this.motionSensorDataManager.parseActivity(s);break;case"deviceOrientation":a=this.motionSensorDataManager.parseDeviceOrientation(s);break;case"barometer":a=this.barometerSensorDataManager.parseData(s,n);break;case"camera":case"microphone":return;default:zs.error(`uncaught sensorType "${e}"`)}zs.assertWithError(null!=a,`no sensorData defined for sensorType "${e}"`),zs.log({sensorType:e,sensorData:a}),this.dispatchEvent(e,{sensorType:e,[e]:a,timestamp:i}),this.dispatchEvent("sensorData",{sensorType:e,[e]:a,timestamp:i})}}var Zs,Xs,Ys,ei,ti,si,ii,ni,ai,ri,oi,ci,hi;qs=new WeakMap;const li=T("SensorConfigurationManager",{log:!1}),fi=["getSensorConfiguration","setSensorConfiguration"],gi=fi;class ui{constructor(){Zs.add(this),ei.set(this,void 0),si.set(this,{}),K(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get configuration(){return t(this,si,"f")}async setConfiguration(e,s){if(s&&(e=Object.assign({...this.zeroSensorConfiguration},e)),li.log({newSensorConfiguration:e}),t(this,Zs,"m",ni).call(this,e))return void li.log("redundant sensor configuration");const i=t(this,Zs,"m",ci).call(this,e);li.log({setSensorConfigurationData:i});const n=this.waitForEvent("getSensorConfiguration");this.sendMessage([{type:"setSensorConfiguration",data:i.buffer}]),await n}static get ZeroSensorConfiguration(){return t(this,Xs,"f",hi)}get zeroSensorConfiguration(){const e={};return t(this,ei,"f").forEach((t=>{e[t]=0})),e}async clearSensorConfiguration(){return this.setConfiguration(this.zeroSensorConfiguration)}parseMessage(e,s){switch(li.log({messageType:e}),e){case"getSensorConfiguration":case"setSensorConfiguration":const i=t(this,Zs,"m",ai).call(this,s);t(this,Zs,"m",ii).call(this,i);break;default:throw Error(`uncaught messageType ${e}`)}}}var di,pi,mi,vi,wi,yi,bi,Si,Ci,Ei,Mi,Di,ki,Wi,Ti,Ii,Ri,Ui,Li,_i,Ai,Fi,xi,$i,Oi,Bi,Ni,Pi,Vi,qi,zi;Xs=ui,ei=new WeakMap,si=new WeakMap,Zs=new WeakSet,Ys=function(){return this.eventDispatcher.dispatchEvent},ti=function(e){li.assertWithError(t(this,ei,"f"),"must get initial sensorConfiguration");const s=t(this,ei,"f")?.includes(e);return li.log(s,`unavailable sensor type "${e}"`),s},ii=function(e){s(this,si,e,"f"),li.log({updatedConfiguration:t(this,si,"f")}),t(this,Zs,"a",Ys).call(this,"getSensorConfiguration",{sensorConfiguration:this.configuration})},ni=function(e){return Object.keys(e).every((t=>this.configuration[t]==e[t]))},ai=function(e){const t={};for(let s=0;s<e.byteLength;s+=3){const i=e.getUint8(s),n=js[i],a=e.getUint16(s+1,!0);li.log({sensorType:n,sensorRate:a}),n?t[n]=a:li.warn(`unknown sensorType index ${i}`)}return li.log({parsedSensorConfiguration:t}),s(this,ei,Object.keys(t),"f"),t},ri=function(e){li.assertTypeWithError(e,"number"),li.assertWithError(e>=0,`sensorRate must be 0 or greater (got ${e})`),li.assertWithError(e<65535,`sensorRate must be 0 or greater (got ${e})`),li.assertWithError(e%5==0,"sensorRate must be multiple of 5")},oi=function(e){t(Xs,Xs,"m",ri).call(Xs,e)},ci=function(e){let s=Object.keys(e);s=s.filter((e=>t(this,Zs,"m",ti).call(this,e)));const i=new DataView(new ArrayBuffer(3*s.length));return s.forEach(((s,n)=>{Qs.AssertValidSensorType(s);const a=js.indexOf(s);i.setUint8(3*n,a);const r=e[s];t(this,Zs,"m",oi).call(this,r),i.setUint16(3*n+1,r,!0)})),li.log({sensorConfigurationData:i}),i},hi={value:{}},js.forEach((e=>{t(Xs,Xs,"f",hi)[e]=0}));const ji=T("TfliteManager",{log:!1}),Gi=["getTfliteName","setTfliteName","getTfliteTask","setTfliteTask","getTfliteSampleRate","setTfliteSampleRate","getTfliteSensorTypes","setTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","setTfliteCaptureDelay","getTfliteThreshold","setTfliteThreshold","getTfliteInferencingEnabled","setTfliteInferencingEnabled","tfliteInference"],Hi=Gi,Ji=["getTfliteName","getTfliteTask","getTfliteSampleRate","getTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","getTfliteThreshold","getTfliteInferencingEnabled"],Ki=["classification","regression"],Qi=["pressure","linearAcceleration","gyroscope","magnetometer"];class Zi{constructor(){di.add(this),wi.set(this,void 0),Si.set(this,void 0),Mi.set(this,void 0),Wi.set(this,[]),Ri.set(this,void 0),Ai.set(this,void 0),$i.set(this,void 0),Ni.set(this,void 0),zi.set(this,void 0),K(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get name(){return t(this,wi,"f")}async setName(e,t){if(ji.assertTypeWithError(e,"string"),this.name==e)return void ji.log(`redundant name assignment ${e}`);const s=this.waitForEvent("getTfliteName"),i=P.encode(e);this.sendMessage([{type:"setTfliteName",data:i.buffer}],t),await s}get task(){return t(this,Si,"f")}async setTask(e,s){if(t(this,di,"m",pi).call(this,e),this.task==e)return void ji.log(`redundant task assignment ${e}`);const i=this.waitForEvent("getTfliteTask");Ki.indexOf(e),this.sendMessage([{type:"setTfliteTask",data:J(commandEnum)}],s),await i}get sampleRate(){return t(this,Mi,"f")}async setSampleRate(e,s){if(ji.assertTypeWithError(e,"number"),e-=e%5,ji.assertWithError(e>=5,`sampleRate must be multiple of 5 greater than 0 (got ${e})`),t(this,Mi,"f")==e)return void ji.log(`redundant sampleRate assignment ${e}`);const i=this.waitForEvent("getTfliteSampleRate"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,e,!0),this.sendMessage([{type:"setTfliteSampleRate",data:n.buffer}],s),await i}static AssertValidSensorType(e){Qs.AssertValidSensorType(e);const t=e;ji.assertWithError(Qi.includes(t),`invalid tflite sensorType "${e}"`)}get sensorTypes(){return t(this,Wi,"f").slice()}async setSensorTypes(e,t){e.forEach((e=>{Zi.AssertValidSensorType(e)}));const s=this.waitForEvent("getTfliteSensorTypes");var i;const n=(e=(i=e).filter(((e,t)=>i.indexOf(e)==t))).map((e=>js.indexOf(e))).sort();ji.log(e,n),this.sendMessage([{type:"setTfliteSensorTypes",data:Uint8Array.from(n).buffer}],t),await s}get isReady(){return t(this,Ri,"f")}get captureDelay(){return t(this,Ai,"f")}async setCaptureDelay(e,s){if(ji.assertTypeWithError(e,"number"),t(this,Ai,"f")==e)return void ji.log(`redundant captureDelay assignment ${e}`);const i=this.waitForEvent("getTfliteCaptureDelay"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,e,!0),this.sendMessage([{type:"setTfliteCaptureDelay",data:n.buffer}],s),await i}get threshold(){return t(this,$i,"f")}async setThreshold(e,s){if(ji.assertTypeWithError(e,"number"),ji.assertWithError(e>=0,`threshold must be positive (got ${e})`),t(this,$i,"f")==e)return void ji.log(`redundant threshold assignment ${e}`);const i=this.waitForEvent("getTfliteThreshold"),n=new DataView(new ArrayBuffer(4));n.setFloat32(0,e,!0),this.sendMessage([{type:"setTfliteThreshold",data:n.buffer}],s),await i}get inferencingEnabled(){return t(this,Ni,"f")}async setInferencingEnabled(e,s=!0){if(ji.assertTypeWithError(e,"boolean"),!e&&!this.isReady)return;if(t(this,di,"m",_i).call(this),t(this,Ni,"f")==e)return void ji.log(`redundant inferencingEnabled assignment ${e}`);const i=this.waitForEvent("getTfliteInferencingEnabled");this.sendMessage([{type:"setTfliteInferencingEnabled",data:J(Number(e))}],s),await i}async toggleInferencingEnabled(){return this.setInferencingEnabled(!this.inferencingEnabled)}async enableInferencing(){this.inferencingEnabled||this.setInferencingEnabled(!0)}async disableInferencing(){this.inferencingEnabled&&this.setInferencingEnabled(!1)}parseMessage(e,s){switch(ji.log({messageType:e}),e){case"getTfliteName":case"setTfliteName":t(this,di,"m",yi).call(this,s);break;case"getTfliteTask":case"setTfliteTask":t(this,di,"m",Ci).call(this,s);break;case"getTfliteSampleRate":case"setTfliteSampleRate":t(this,di,"m",Di).call(this,s);break;case"getTfliteSensorTypes":case"setTfliteSensorTypes":t(this,di,"m",Ti).call(this,s);break;case"tfliteIsReady":t(this,di,"m",Ui).call(this,s);break;case"getTfliteCaptureDelay":case"setTfliteCaptureDelay":t(this,di,"m",Fi).call(this,s);break;case"getTfliteThreshold":case"setTfliteThreshold":t(this,di,"m",Oi).call(this,s);break;case"getTfliteInferencingEnabled":case"setTfliteInferencingEnabled":t(this,di,"m",Pi).call(this,s);break;case"tfliteInference":t(this,di,"m",qi).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}get configuration(){return t(this,zi,"f")}sendConfiguration(e,i){if(e==t(this,zi,"f"))return void ji.log("redundant tflite configuration assignment");if(s(this,zi,e,"f"),ji.log("assigned new tflite configuration",this.configuration),!this.configuration)return;const{name:n,task:a,captureDelay:r,sampleRate:o,threshold:c,sensorTypes:h}=this.configuration;this.setName(n,!1),this.setTask(a,!1),null!=r&&this.setCaptureDelay(r,!1),this.setSampleRate(o,!1),null!=c&&this.setThreshold(c,!1),this.setSensorTypes(h,i)}clear(){s(this,zi,void 0,"f"),s(this,Ni,!1,"f"),s(this,Wi,[],"f"),s(this,Mi,0,"f"),s(this,Ri,!1,"f")}requestRequiredInformation(){ji.log("requesting required tflite information");const e=Ji.map((e=>({type:e})));this.sendMessage(e,!1)}}var Xi,Yi,en,tn,sn;wi=new WeakMap,Si=new WeakMap,Mi=new WeakMap,Wi=new WeakMap,Ri=new WeakMap,Ai=new WeakMap,$i=new WeakMap,Ni=new WeakMap,zi=new WeakMap,di=new WeakSet,pi=function(e){ji.assertEnumWithError(e,Ki)},mi=function(e){ji.assertWithError(e in Ki,`invalid taskEnum ${e}`)},vi=function(){return this.eventDispatcher.dispatchEvent},yi=function(e){ji.log("parseName",e);const s=V.decode(e.buffer);t(this,di,"m",bi).call(this,s)},bi=function(e){ji.log({name:e}),s(this,wi,e,"f"),t(this,di,"a",vi).call(this,"getTfliteName",{tfliteName:e})},Ci=function(e){ji.log("parseTask",e);const s=e.getUint8(0);t(this,di,"m",mi).call(this,s);const i=Ki[s];t(this,di,"m",Ei).call(this,i)},Ei=function(e){ji.log({task:e}),s(this,Si,e,"f"),t(this,di,"a",vi).call(this,"getTfliteTask",{tfliteTask:e})},Di=function(e){ji.log("parseSampleRate",e);const s=e.getUint16(0,!0);t(this,di,"m",ki).call(this,s)},ki=function(e){ji.log({sampleRate:e}),s(this,Mi,e,"f"),t(this,di,"a",vi).call(this,"getTfliteSampleRate",{tfliteSampleRate:e})},Ti=function(e){ji.log("parseSensorTypes",e);const s=[];for(let t=0;t<e.byteLength;t++){const i=e.getUint8(t),n=js[i];n?Qi.includes(n)?s.push(n):ji.error(`invalid tfliteSensorType ${n}`):ji.error(`invalid sensorTypeEnum ${i}`)}t(this,di,"m",Ii).call(this,s)},Ii=function(e){ji.log({sensorTypes:e}),s(this,Wi,e,"f"),t(this,di,"a",vi).call(this,"getTfliteSensorTypes",{tfliteSensorTypes:e})},Ui=function(e){ji.log("parseIsReady",e);const s=Boolean(e.getUint8(0));t(this,di,"m",Li).call(this,s)},Li=function(e){ji.log({isReady:e}),s(this,Ri,e,"f"),t(this,di,"a",vi).call(this,"tfliteIsReady",{tfliteIsReady:e})},_i=function(){ji.assertWithError(this.isReady,"tflite is not ready")},Fi=function(e){ji.log("parseCaptureDelay",e);const s=e.getUint16(0,!0);t(this,di,"m",xi).call(this,s)},xi=function(e){ji.log({captureDelay:e}),s(this,Ai,e,"f"),t(this,di,"a",vi).call(this,"getTfliteCaptureDelay",{tfliteCaptureDelay:e})},Oi=function(e){ji.log("parseThreshold",e);const s=e.getFloat32(0,!0);t(this,di,"m",Bi).call(this,s)},Bi=function(e){ji.log({threshold:e}),s(this,$i,e,"f"),t(this,di,"a",vi).call(this,"getTfliteThreshold",{tfliteThreshold:e})},Pi=function(e){ji.log("parseInferencingEnabled",e);const s=Boolean(e.getUint8(0));t(this,di,"m",Vi).call(this,s)},Vi=function(e){ji.log({inferencingEnabled:e}),s(this,Ni,e,"f"),t(this,di,"a",vi).call(this,"getTfliteInferencingEnabled",{tfliteInferencingEnabled:e})},qi=function(e){ji.log("parseInference",e);const s=He(e,0);ji.log({timestamp:s});const i=[];for(let t=0,s=2;s<e.byteLength;t++,s+=4){const t=e.getFloat32(s,!0);i.push(t)}ji.log("values",i);const n={timestamp:s,values:i};if("classification"==this.task){let e=0,s=0;if(i.forEach(((t,i)=>{t>e&&(e=t,s=i)})),ji.log({maxIndex:s,maxValue:e}),n.maxIndex=s,n.maxValue=e,t(this,zi,"f")?.classes){const{classes:e}=t(this,zi,"f");n.maxClass=e[s],n.classValues={},i.forEach(((t,s)=>{const i=e[s];n.classValues[i]=t}))}}t(this,di,"a",vi).call(this,"tfliteInference",{tfliteInference:n})};const nn=T("DeviceInformationManager",{log:!1}),an=["manufacturerName","modelNumber","hardwareRevision","firmwareRevision","softwareRevision","pnpId","serialNumber"],rn=[...an,"deviceInformation"];class on{constructor(){Xi.add(this),en.set(this,{})}get information(){return t(this,en,"f")}clear(){s(this,en,{},"f")}parseMessage(e,s){switch(nn.log({messageType:e}),e){case"manufacturerName":const i=V.decode(s.buffer);nn.log({manufacturerName:i}),t(this,Xi,"m",sn).call(this,{manufacturerName:i});break;case"modelNumber":const n=V.decode(s.buffer);nn.log({modelNumber:n}),t(this,Xi,"m",sn).call(this,{modelNumber:n});break;case"softwareRevision":const a=V.decode(s.buffer);nn.log({softwareRevision:a}),t(this,Xi,"m",sn).call(this,{softwareRevision:a});break;case"hardwareRevision":const r=V.decode(s.buffer);nn.log({hardwareRevision:r}),t(this,Xi,"m",sn).call(this,{hardwareRevision:r});break;case"firmwareRevision":const o=V.decode(s.buffer);nn.log({firmwareRevision:o}),t(this,Xi,"m",sn).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===s.getUint8(0)?"Bluetooth":"USB",productId:s.getUint16(3,!0),productVersion:s.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=s.getUint16(1,!0)),nn.log({pnpId:c}),t(this,Xi,"m",sn).call(this,{pnpId:c});break;case"serialNumber":const h=V.decode(s.buffer);nn.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${e}`)}}}var cn,hn,ln,fn,gn,un,dn,pn,mn,vn,wn,yn,bn,Sn,Cn,En,Mn,Dn;en=new WeakMap,Xi=new WeakSet,Yi=function(){return this.eventDispatcher.dispatchEvent},tn=function(){return an.filter((e=>"serialNumber"!=e)).every((e=>e in t(this,en,"f")))},sn=function(e){nn.log({partialDeviceInformation:e});Object.keys(e).forEach((s=>{t(this,Xi,"a",Yi).call(this,s,{[s]:e[s]})})),Object.assign(t(this,en,"f"),e),nn.log({deviceInformation:t(this,en,"f")}),t(this,Xi,"a",tn)&&(nn.log("completed deviceInformation"),t(this,Xi,"a",Yi).call(this,"deviceInformation",{deviceInformation:this.information}))};const kn=T("InformationManager",{log:!1}),Wn=["leftInsole","rightInsole","leftGlove","rightGlove","glasses","generic"],Tn=["left","right"],In=["isCharging","getBatteryCurrent","getMtu","getId","getName","setName","getType","setType","getCurrentTime","setCurrentTime"],Rn=In;class Un{constructor(){cn.add(this),ln.set(this,!1),gn.set(this,void 0),dn.set(this,void 0),mn.set(this,""),vn.set(this,void 0),Sn.set(this,0),En.set(this,!1),K(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}get isCharging(){return t(this,ln,"f")}get batteryCurrent(){return t(this,gn,"f")}async getBatteryCurrent(){kn.log("getting battery current...");const e=this.waitForEvent("getBatteryCurrent");this.sendMessage([{type:"getBatteryCurrent"}]),await e}get id(){return t(this,dn,"f")}get name(){return t(this,mn,"f")}updateName(e){kn.assertTypeWithError(e,"string"),s(this,mn,e,"f"),kn.log({updatedName:t(this,mn,"f")}),t(this,cn,"a",hn).call(this,"getName",{name:t(this,mn,"f")})}async setName(e){kn.assertTypeWithError(e,"string"),kn.assertRangeWithError("newName",e.length,2,30);const t=P.encode(e);kn.log({setNameData:t});const s=this.waitForEvent("getName");this.sendMessage([{type:"setName",data:t.buffer}]),await s}get type(){return t(this,vn,"f")}get typeEnum(){return Wn.indexOf(this.type)}updateType(e){t(this,cn,"m",wn).call(this,e),e!=this.type?(s(this,vn,e,"f"),kn.log({updatedType:t(this,vn,"f")}),t(this,cn,"a",hn).call(this,"getType",{type:t(this,vn,"f")})):kn.log("redundant type assignment")}async setType(e){t(this,cn,"m",wn).call(this,e);const s=Wn.indexOf(e);t(this,cn,"m",bn).call(this,s)}get isInsole(){switch(this.type){case"leftInsole":case"rightInsole":return!0;default:return!1}}get isGlove(){switch(this.type){case"leftGlove":case"rightGlove":return!0;default:return!1}}get side(){switch(this.type){case"leftInsole":case"leftGlove":default:return"left";case"rightInsole":case"rightGlove":return"right"}}get mtu(){return t(this,Sn,"f")}get isCurrentTimeSet(){return t(this,En,"f")}parseMessage(e,s){switch(kn.log({messageType:e}),e){case"isCharging":const i=Boolean(s.getUint8(0));kn.log({isCharging:i}),t(this,cn,"m",fn).call(this,i);break;case"getBatteryCurrent":const n=s.getFloat32(0,!0);kn.log({batteryCurrent:n}),t(this,cn,"m",un).call(this,n);break;case"getId":const a=V.decode(s.buffer);kn.log({id:a}),t(this,cn,"m",pn).call(this,a);break;case"getName":case"setName":const r=V.decode(s.buffer);kn.log({name:r}),this.updateName(r);break;case"getType":case"setType":const o=s.getUint8(0),c=Wn[o];kn.log({typeEnum:o,type:c}),this.updateType(c);break;case"getMtu":let h=s.getUint16(0,!0);"webSocket"!=this.connectionType&&"udp"!=this.connectionType&&(h=Math.min(h,512)),kn.log({mtu:h}),t(this,cn,"m",Cn).call(this,h);break;case"getCurrentTime":case"setCurrentTime":const l=Number(s.getBigUint64(0,!0));t(this,cn,"m",Mn).call(this,l);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){s(this,En,!1,"f")}}ln=new WeakMap,gn=new WeakMap,dn=new WeakMap,mn=new WeakMap,vn=new WeakMap,Sn=new WeakMap,En=new WeakMap,cn=new WeakSet,hn=function(){return this.eventDispatcher.dispatchEvent},fn=function(e){kn.assertTypeWithError(e,"boolean"),s(this,ln,e,"f"),kn.log({isCharging:t(this,ln,"f")}),t(this,cn,"a",hn).call(this,"isCharging",{isCharging:t(this,ln,"f")})},un=function(e){kn.assertTypeWithError(e,"number"),s(this,gn,e,"f"),kn.log({batteryCurrent:t(this,gn,"f")}),t(this,cn,"a",hn).call(this,"getBatteryCurrent",{batteryCurrent:t(this,gn,"f")})},pn=function(e){kn.assertTypeWithError(e,"string"),s(this,dn,e,"f"),kn.log({id:t(this,dn,"f")}),t(this,cn,"a",hn).call(this,"getId",{id:t(this,dn,"f")})},wn=function(e){kn.assertEnumWithError(e,Wn)},yn=function(e){kn.assertTypeWithError(e,"number"),kn.assertWithError(e in Wn,`invalid typeEnum ${e}`)},bn=async function(e){t(this,cn,"m",yn).call(this,e);const s=J(e);kn.log({setTypeData:s});const i=this.waitForEvent("getType");this.sendMessage([{type:"setType",data:s}]),await i},Cn=function(e){kn.assertTypeWithError(e,"number"),t(this,Sn,"f")!=e?(s(this,Sn,e,"f"),t(this,cn,"a",hn).call(this,"getMtu",{mtu:t(this,Sn,"f")})):kn.log("redundant mtu assignment",e)},Mn=function(e){kn.log({currentTime:e}),s(this,En,0!=e||Math.abs(Date.now()-e)<Ge,"f"),t(this,En,"f")||t(this,cn,"m",Dn).call(this,!1)},Dn=async function(e){kn.log("setting current time...");const t=new DataView(new ArrayBuffer(8));t.setBigUint64(0,BigInt(Date.now()),!0);const s=this.waitForEvent("getCurrentTime");this.sendMessage([{type:"setCurrentTime",data:t.buffer}],e),await s};const Ln=["none","strongClick100","strongClick60","strongClick30","sharpClick100","sharpClick60","sharpClick30","softBump100","softBump60","softBump30","doubleClick100","doubleClick60","tripleClick100","softFuzz60","strongBuzz100","alert750ms","alert1000ms","strongClick1_100","strongClick2_80","strongClick3_60","strongClick4_30","mediumClick100","mediumClick80","mediumClick60","sharpTick100","sharpTick80","sharpTick60","shortDoubleClickStrong100","shortDoubleClickStrong80","shortDoubleClickStrong60","shortDoubleClickStrong30","shortDoubleClickMedium100","shortDoubleClickMedium80","shortDoubleClickMedium60","shortDoubleSharpTick100","shortDoubleSharpTick80","shortDoubleSharpTick60","longDoubleSharpClickStrong100","longDoubleSharpClickStrong80","longDoubleSharpClickStrong60","longDoubleSharpClickStrong30","longDoubleSharpClickMedium100","longDoubleSharpClickMedium80","longDoubleSharpClickMedium60","longDoubleSharpTick100","longDoubleSharpTick80","longDoubleSharpTick60","buzz100","buzz80","buzz60","buzz40","buzz20","pulsingStrong100","pulsingStrong60","pulsingMedium100","pulsingMedium60","pulsingSharp100","pulsingSharp60","transitionClick100","transitionClick80","transitionClick60","transitionClick40","transitionClick20","transitionClick10","transitionHum100","transitionHum80","transitionHum60","transitionHum40","transitionHum20","transitionHum10","transitionRampDownLongSmooth2_100","transitionRampDownLongSmooth1_100","transitionRampDownMediumSmooth1_100","transitionRampDownMediumSmooth2_100","transitionRampDownShortSmooth1_100","transitionRampDownShortSmooth2_100","transitionRampDownLongSharp1_100","transitionRampDownLongSharp2_100","transitionRampDownMediumSharp1_100","transitionRampDownMediumSharp2_100","transitionRampDownShortSharp1_100","transitionRampDownShortSharp2_100","transitionRampUpLongSmooth1_100","transitionRampUpLongSmooth2_100","transitionRampUpMediumSmooth1_100","transitionRampUpMediumSmooth2_100","transitionRampUpShortSmooth1_100","transitionRampUpShortSmooth2_100","transitionRampUpLongSharp1_100","transitionRampUpLongSharp2_100","transitionRampUpMediumSharp1_100","transitionRampUpMediumSharp2_100","transitionRampUpShortSharp1_100","transitionRampUpShortSharp2_100","transitionRampDownLongSmooth1_50","transitionRampDownLongSmooth2_50","transitionRampDownMediumSmooth1_50","transitionRampDownMediumSmooth2_50","transitionRampDownShortSmooth1_50","transitionRampDownShortSmooth2_50","transitionRampDownLongSharp1_50","transitionRampDownLongSharp2_50","transitionRampDownMediumSharp1_50","transitionRampDownMediumSharp2_50","transitionRampDownShortSharp1_50","transitionRampDownShortSharp2_50","transitionRampUpLongSmooth1_50","transitionRampUpLongSmooth2_50","transitionRampUpMediumSmooth1_50","transitionRampUpMediumSmooth2_50","transitionRampUpShortSmooth1_50","transitionRampUpShortSmooth2_50","transitionRampUpLongSharp1_50","transitionRampUpLongSharp2_50","transitionRampUpMediumSharp1_50","transitionRampUpMediumSharp2_50","transitionRampUpShortSharp1_50","transitionRampUpShortSharp2_50","longBuzz100","smoothHum50","smoothHum40","smoothHum30","smoothHum20","smoothHum10"];var _n,An,Fn,xn,$n,On,Bn,Nn,Pn,Vn,qn,zn,jn,Gn,Hn,Jn,Kn,Qn,Zn;const Xn=T("VibrationManager",{log:!1}),Yn=["front","rear"],ea=["waveformEffect","waveform"],ta=["getVibrationLocations","triggerVibration"],sa=ta,ia=2550,na=1270;class aa{constructor(){_n.add(this),Qn.set(this,[]),K(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}async triggerVibration(e,s=!0){let i;e.forEach((e=>{const{type:s}=e;let n,{locations:a}=e;switch(a=a||this.vibrationLocations.slice(),a=a.filter((e=>this.vibrationLocations.includes(e))),s){case"waveformEffect":{const{segments:s,loopCount:i}=e;n=t(this,_n,"m",Gn).call(this,a,s,i)}break;case"waveform":{const{segments:s}=e;n=t(this,_n,"m",Hn).call(this,a,s)}break;default:throw Error(`invalid vibration type "${s}"`)}Xn.log({type:s,arrayBuffer:n}),i=z(i,n)})),await this.sendMessage([{type:"triggerVibration",data:i}],s)}get vibrationLocations(){return t(this,Qn,"f")}parseMessage(e,s){if(Xn.log({messageType:e}),"getVibrationLocations"!==e)throw Error(`uncaught messageType ${e}`);{const e=Array.from(new Uint8Array(s.buffer)).map((e=>Yn[e])).filter(Boolean);t(this,_n,"m",Zn).call(this,e)}}}var ra,oa,ca,ha,la,fa,ga,ua,da,pa,ma,va,wa,ya,ba,Sa,Ca;Qn=new WeakMap,_n=new WeakSet,An=function(){return this.eventDispatcher.dispatchEvent},Fn=function(e){Xn.assertTypeWithError(e,"string"),Xn.assertWithError(Yn.includes(e),`invalid location "${e}"`)},xn=function(e){t(this,_n,"m",On).call(this,e),e.forEach((e=>{t(this,_n,"m",Fn).call(this,e)}))},$n=function(e){t(this,_n,"m",xn).call(this,e);let s=0;return e.forEach((e=>{const t=Yn.indexOf(e);s|=1<<t})),Xn.log({locationsBitmask:s}),Xn.assertWithError(s>0,"locationsBitmask must not be zero"),s},On=function(e){Xn.assertWithError(Array.isArray(e),"passed non-array"),Xn.assertWithError(e.length>0,"passed empty array")},Bn=function(e){Xn.assertWithError(Ln.includes(e),`invalid waveformEffect "${e}"`)},Nn=function(e){if(null!=e.effect){const s=e.effect;t(this,_n,"m",Bn).call(this,s)}else{if(null==e.delay)throw Error("no effect or delay found in waveformEffectSegment");{const{delay:t}=e;Xn.assertWithError(t>=0,`delay must be 0ms or greater (got ${t})`),Xn.assertWithError(t<=na,`delay must be 1270ms or less (got ${t})`)}}if(null!=e.loopCount){const{loopCount:s}=e;t(this,_n,"m",Pn).call(this,s)}},Pn=function(e){Xn.assertTypeWithError(e,"number"),Xn.assertWithError(e>=0,`waveformEffectSegmentLoopCount must be 0 or greater (got ${e})`),Xn.assertWithError(e<=3,`waveformEffectSegmentLoopCount must be 3 or fewer (got ${e})`)},Vn=function(e){t(this,_n,"m",On).call(this,e),Xn.assertWithError(e.length<=8,`must have 8 waveformEffectSegments or fewer (got ${e.length})`),e.forEach((e=>{t(this,_n,"m",Nn).call(this,e)}))},qn=function(e){Xn.assertTypeWithError(e,"number"),Xn.assertWithError(e>=0,`waveformEffectSequenceLoopCount must be 0 or greater (got ${e})`),Xn.assertWithError(e<=6,`waveformEffectSequenceLoopCount must be 6 or fewer (got ${e})`)},zn=function(e){Xn.assertTypeWithError(e.amplitude,"number"),Xn.assertWithError(e.amplitude>=0,`amplitude must be 0 or greater (got ${e.amplitude})`),Xn.assertWithError(e.amplitude<=1,`amplitude must be 1 or less (got ${e.amplitude})`),Xn.assertTypeWithError(e.duration,"number"),Xn.assertWithError(e.duration>0,`duration must be greater than 0ms (got ${e.duration}ms)`),Xn.assertWithError(e.duration<=ia,`duration must be 2550ms or less (got ${e.duration}ms)`)},jn=function(e){t(this,_n,"m",On).call(this,e),Xn.assertWithError(e.length<=20,`must have 20 waveformSegments or fewer (got ${e.length})`),e.forEach((e=>{t(this,_n,"m",zn).call(this,e)}))},Gn=function(e,s,i=0){t(this,_n,"m",Vn).call(this,s),t(this,_n,"m",qn).call(this,i);let n=[],a=0;const r=s.some((e=>{const{loopCount:t}=e;return null!=t&&t>0}))||0!=i;for(let e=0;e<s.length||r&&e<8;e++){const t=s[e]||{effect:"none"};if(null!=t.effect){const e=t.effect;n[a++]=Ln.indexOf(e)}else{if(null==t.delay)throw Error("invalid waveformEffectSegment");{const{delay:e}=t;n[a++]=128|Math.floor(e/10)}}}const o=0!=i;for(let e=0;e<s.length||o&&e<8;e++){const t=s[e]?.loopCount||0;0!=e&&4!=e||(n[a]=0);const i=e%4*2;n[a]|=t<<i,3!=e&&7!=e||a++}0!=i&&(n[a++]=i);const c=new DataView(Uint8Array.from(n).buffer);return Xn.log({dataArray:n,dataView:c}),t(this,_n,"m",Kn).call(this,e,"waveformEffect",c)},Hn=function(e,s){t(this,_n,"m",jn).call(this,s);const i=new DataView(new ArrayBuffer(2*s.length));return s.forEach(((e,t)=>{i.setUint8(2*t,Math.floor(127*e.amplitude)),i.setUint8(2*t+1,Math.floor(e.duration/10))})),Xn.log({dataView:i}),t(this,_n,"m",Kn).call(this,e,"waveform",i)},Jn=function(e){Xn.assertTypeWithError(e,"string"),Xn.assertWithError(ea.includes(e),`invalid vibrationType "${e}"`)},Kn=function(e,s,i){Xn.assertWithError(i?.byteLength>0,"no data received");const n=t(this,_n,"m",$n).call(this,e);t(this,_n,"m",Jn).call(this,s);const a=ea.indexOf(s);Xn.log({locationsBitmask:n,vibrationTypeIndex:a,dataView:i});const r=z(n,a,i.byteLength,i);return Xn.log({data:r}),r},Zn=function(e){s(this,Qn,e,"f"),Xn.log("vibrationLocations",e),t(this,_n,"a",An).call(this,"getVibrationLocations",{vibrationLocations:t(this,Qn,"f")})};const Ea=T("WifiManager",{log:!1}),Ma=["isWifiAvailable","getWifiSSID","setWifiSSID","getWifiPassword","setWifiPassword","getWifiConnectionEnabled","setWifiConnectionEnabled","isWifiConnected","ipAddress","isWifiSecure"],Da=["getWifiSSID","getWifiPassword","getWifiConnectionEnabled","isWifiConnected","ipAddress","isWifiSecure"],ka=Ma;class Wa{constructor(){ra.add(this),ca.set(this,!1),fa.set(this,""),ua.set(this,""),pa.set(this,void 0),va.set(this,!1),ya.set(this,void 0),Sa.set(this,!1),K(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Ea.log("requesting required wifi information");const e=Da.map((e=>({type:e})));this.sendMessage(e,!1)}get isWifiAvailable(){return t(this,ca,"f")}get wifiSSID(){return t(this,fa,"f")}async setWifiSSID(e){if(t(this,ra,"m",la).call(this),t(this,pa,"f"))return void Ea.error("cannot change ssid while wifi connection is enabled");Ea.assertTypeWithError(e,"string"),Ea.assertRangeWithError("wifiSSID",e.length,1,32);const s=P.encode(e);Ea.log({setWifiSSIDData:s});const i=this.waitForEvent("getWifiSSID");this.sendMessage([{type:"setWifiSSID",data:s.buffer}]),await i}get wifiPassword(){return t(this,ua,"f")}async setWifiPassword(e){if(t(this,ra,"m",la).call(this),t(this,pa,"f"))return void Ea.error("cannot change password while wifi connection is enabled");Ea.assertTypeWithError(e,"string"),e.length>0&&Ea.assertRangeWithError("wifiPassword",e.length,8,64);const s=P.encode(e);Ea.log({setWifiPasswordData:s});const i=this.waitForEvent("getWifiPassword");this.sendMessage([{type:"setWifiPassword",data:s.buffer}]),await i}get wifiConnectionEnabled(){return t(this,pa,"f")}async setWifiConnectionEnabled(e,s=!0){if(t(this,ra,"m",la).call(this),Ea.assertTypeWithError(e,"boolean"),t(this,pa,"f")==e)return void Ea.log(`redundant wifiConnectionEnabled assignment ${e}`);const i=this.waitForEvent("getWifiConnectionEnabled");this.sendMessage([{type:"setWifiConnectionEnabled",data:J(Number(e))}],s),await i}async toggleWifiConnection(){return this.setWifiConnectionEnabled(!this.wifiConnectionEnabled)}async enableWifiConnection(){return this.setWifiConnectionEnabled(!0)}async disableWifiConnection(){return this.setWifiConnectionEnabled(!1)}get isWifiConnected(){return t(this,va,"f")}get ipAddress(){return t(this,ya,"f")}get isWifiSecure(){return t(this,Sa,"f")}parseMessage(e,s){switch(Ea.log({messageType:e}),e){case"isWifiAvailable":const i=Boolean(s.getUint8(0));Ea.log({isWifiAvailable:i}),t(this,ra,"m",ha).call(this,i);break;case"getWifiSSID":case"setWifiSSID":const n=V.decode(s.buffer);Ea.log({ssid:n}),t(this,ra,"m",ga).call(this,n);break;case"getWifiPassword":case"setWifiPassword":const a=V.decode(s.buffer);Ea.log({password:a}),t(this,ra,"m",da).call(this,a);break;case"getWifiConnectionEnabled":case"setWifiConnectionEnabled":const r=Boolean(s.getUint8(0));Ea.log({enableWifiConnection:r}),t(this,ra,"m",ma).call(this,r);break;case"isWifiConnected":const o=Boolean(s.getUint8(0));Ea.log({isWifiConnected:o}),t(this,ra,"m",wa).call(this,o);break;case"ipAddress":let c;4==s.byteLength&&(c=new Uint8Array(s.buffer.slice(0,4)).join(".")),Ea.log({ipAddress:c}),t(this,ra,"m",ba).call(this,c);break;case"isWifiSecure":const h=Boolean(s.getUint8(0));Ea.log({isWifiSecure:h}),t(this,ra,"m",Ca).call(this,h);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){s(this,fa,"","f"),s(this,ua,"","f"),s(this,ya,"","f"),s(this,va,!1,"f"),s(this,ca,!1,"f")}}ca=new WeakMap,fa=new WeakMap,ua=new WeakMap,pa=new WeakMap,va=new WeakMap,ya=new WeakMap,Sa=new WeakMap,ra=new WeakSet,oa=function(){return this.eventDispatcher.dispatchEvent},ha=function(e){Ea.assertTypeWithError(e,"boolean"),s(this,ca,e,"f"),Ea.log({isWifiAvailable:t(this,ca,"f")}),t(this,ra,"a",oa).call(this,"isWifiAvailable",{isWifiAvailable:t(this,ca,"f")})},la=function(){Ea.assertWithError(t(this,ca,"f"),"wifi is not available")},ga=function(e){Ea.assertTypeWithError(e,"string"),s(this,fa,e,"f"),Ea.log({wifiSSID:t(this,fa,"f")}),t(this,ra,"a",oa).call(this,"getWifiSSID",{wifiSSID:t(this,fa,"f")})},da=function(e){Ea.assertTypeWithError(e,"string"),s(this,ua,e,"f"),Ea.log({wifiPassword:t(this,ua,"f")}),t(this,ra,"a",oa).call(this,"getWifiPassword",{wifiPassword:t(this,ua,"f")})},ma=function(e){Ea.log({wifiConnectionEnabled:e}),s(this,pa,e,"f"),t(this,ra,"a",oa).call(this,"getWifiConnectionEnabled",{wifiConnectionEnabled:e})},wa=function(e){Ea.assertTypeWithError(e,"boolean"),s(this,va,e,"f"),Ea.log({isWifiConnected:t(this,va,"f")}),t(this,ra,"a",oa).call(this,"isWifiConnected",{isWifiConnected:t(this,va,"f")})},ba=function(e){s(this,ya,e,"f"),Ea.log({ipAddress:t(this,ya,"f")}),t(this,ra,"a",oa).call(this,"ipAddress",{ipAddress:t(this,ya,"f")})},Ca=function(e){Ea.assertTypeWithError(e,"boolean"),s(this,Sa,e,"f"),Ea.log({isWifiSecure:t(this,Sa,"f")}),t(this,ra,"a",oa).call(this,"isWifiSecure",{isWifiSecure:t(this,Sa,"f")})};const Ta=T("ColorUtils",{log:!0});var Ia,Ra,Ua,La,_a,Aa,Fa,xa,$a,Oa,Ba,Na,Pa,Va,qa,za,ja,Ga,Ha,Ja,Ka,Qa,Za,Xa,Ya,er,tr,sr,ir,nr,ar,rr,or;const cr=T("DisplayManager",{log:!0}),hr=["sleep","wake"],lr=["awake","asleep"],fr=["type","width","height","pixelDepth"],gr=["veryLow","low","medium","high","veryHigh"],ur=["isDisplayAvailable","displayStatus","displayInformation","displayCommand","getDisplayBrightness","setDisplayBrightness","displayContextCommands"],dr={type:["none","monocularLeft","monocularRight","binocular"],pixelDepth:["1","2","4"]},pr=["show","clear","setColor","setColorOpacity","setOpacity","saveContext","restoreContext","selectFillColor","selectLineColor","setLineWidth","clearRect","drawRect","drawRoundRect","drawCircle","drawEllipse","selectSpriteSheet","sprite","selectFont","drawText"],mr=["isDisplayAvailable","displayInformation","displayStatus","getDisplayBrightness"],vr=[...ur];class wr{constructor(){Ia.add(this),Ua.set(this,!1),Aa.set(this,void 0),Na.set(this,void 0),Va.set(this,void 0),Ga.set(this,[]),or.set(this,void 0),K(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){cr.log("requesting required display information");const e=mr.map((e=>({type:e})));this.sendMessage(e,!1)}get isDisplayAvailable(){return t(this,Ua,"f")}get displayStatus(){return t(this,Aa,"f")}get isDisplayAwake(){return"awake"==t(this,Aa,"f")}async wake(){t(this,Ia,"m",Ba).call(this),await t(this,Ia,"m",$a).call(this,"wake")}async sleep(){t(this,Ia,"m",Oa).call(this),await t(this,Ia,"m",$a).call(this,"sleep")}async toggle(){switch(this.displayStatus){case"asleep":this.wake();break;case"awake":this.sleep()}}get numberOfColors(){return 2**Number(this.pixelDepth)}get displayInformation(){return t(this,Na,"f")}get pixelDepth(){return t(this,Na,"f")?.pixelDepth}get width(){return t(this,Na,"f")?.width}get height(){return t(this,Na,"f")?.width}get size(){return{width:this.width,height:this.height}}get type(){return t(this,Na,"f")?.type}get displayBrightness(){return t(this,Va,"f")}async setDisplayBrightness(e){t(this,Ia,"m",La).call(this),t(this,Ia,"m",za).call(this,e);const s=J(gr.indexOf(e)),i=this.waitForEvent("getDisplayBrightness");this.sendMessage([{type:"setDisplayBrightness",data:s}]),await i}showDisplay(e=!0){t(this,Ia,"m",Ha).call(this,"show",void 0,e)}clearDisplay(e=!0){t(this,Ia,"m",Ha).call(this,"clear",void 0,e)}setColor(e,s,i){var n;"string"==typeof s&&(3==(n=(n=s).replace(/^#/,"")).length&&(n=n.split("").map((e=>e+e)).join("")),Ta.assertWithError(6==n.length,`hex length must be 6 (got ${n.length})`),s={r:parseInt(n.substring(0,2),16),g:parseInt(n.substring(2,4),16),b:parseInt(n.substring(4,6),16)}),cr.log(`setting color #${e}`,s),t(this,Ia,"m",Za).call(this,e),t(this,Ia,"m",Ka).call(this,s);const a=new DataView(new ArrayBuffer(4));a.setUint8(0,e),a.setUint8(1,s.r),a.setUint8(2,s.g),a.setUint8(3,s.b),t(this,Ia,"m",Ha).call(this,"setColor",a.buffer,i)}setColorOpacity(e,s,i){t(this,Ia,"m",Za).call(this,e),t(this,Ia,"m",Xa).call(this,s);const n=new DataView(new ArrayBuffer(2));n.setUint8(0,e),n.setUint8(1,255*s),t(this,Ia,"m",Ha).call(this,"setColorOpacity",n.buffer,i)}setOpacity(e,s){t(this,Ia,"m",Xa).call(this,e),t(this,Ia,"m",Ha).call(this,"setOpacity",J(Math.round(255*e)),s)}saveContext(e){t(this,Ia,"m",Ha).call(this,"saveContext",void 0,e)}restoreContext(e){t(this,Ia,"m",Ha).call(this,"restoreContext",void 0,e)}selectFillColor(e,s){t(this,Ia,"m",Za).call(this,e),t(this,Ia,"m",Ha).call(this,"selectFillColor",J(e),s)}selectLineColor(e,s){t(this,Ia,"m",Za).call(this,e),t(this,Ia,"m",Ha).call(this,"selectLineColor",J(e),s)}setLineWidth(e,s){t(this,Ia,"m",Ya).call(this,e);const i=new DataView(new ArrayBuffer(2));i.setUint16(0,e,!0),t(this,Ia,"m",Ha).call(this,"setLineWidth",i.buffer,s)}clearRect(e,s,i,n,a){const{x:r,y:o,width:c,height:h}=t(this,Ia,"m",nr).call(this,e,s,i,n),l=new DataView(new ArrayBuffer(8));l.setUint16(0,r,!0),l.setUint16(2,o,!0),l.setUint16(4,c,!0),l.setUint16(6,h,!0),t(this,Ia,"m",Ha).call(this,"clearRect",l.buffer,a)}drawRect(e,s,i,n,a){const{x:r,y:o,width:c,height:h}=t(this,Ia,"m",nr).call(this,e,s,i,n),l=new DataView(new ArrayBuffer(8));l.setUint16(0,r,!0),l.setUint16(2,o,!0),l.setUint16(4,c,!0),l.setUint16(6,h,!0),cr.log("drawRect data",l),t(this,Ia,"m",Ha).call(this,"drawRect",l.buffer,a)}drawRoundRect(e,s,i,n,a,r){const{x:o,y:c,width:h,height:l}=t(this,Ia,"m",nr).call(this,e,s,i,n),f=new DataView(new ArrayBuffer(9));f.setUint16(0,o,!0),f.setUint16(2,c,!0),f.setUint16(4,h,!0),f.setUint16(6,l,!0),f.setUint8(8,a),cr.log("drawRoundRect data",f),t(this,Ia,"m",Ha).call(this,"drawRoundRect",f.buffer,r)}drawCircle(e,s,i,n){const{x:a,y:r,radius:o}=t(this,Ia,"m",ar).call(this,e,s,i),c=new DataView(new ArrayBuffer(6));c.setUint16(0,a,!0),c.setUint16(2,r,!0),c.setUint16(4,o,!0),cr.log("drawCircle data",c),t(this,Ia,"m",Ha).call(this,"drawCircle",c.buffer,n)}drawEllipse(e,s,i,n,a,r){const o=new DataView(new ArrayBuffer(10));a=t(this,Ia,"m",rr).call(this,a),o.setUint16(0,e,!0),o.setUint16(2,s,!0),o.setUint16(4,i,!0),o.setUint16(6,n,!0),o.setUint16(8,a,!0),cr.log("drawEllipse data",o),t(this,Ia,"m",Ha).call(this,"drawEllipse",o.buffer,r)}selectSpriteSheet(e,t){}drawSprite(e,t,s,i){}parseMessage(e,s){switch(cr.log({messageType:e,dataView:s}),e){case"isDisplayAvailable":t(this,Ia,"m",_a).call(this,s);break;case"displayStatus":t(this,Ia,"m",Fa).call(this,s);break;case"displayInformation":t(this,Ia,"m",Pa).call(this,s);break;case"getDisplayBrightness":case"setDisplayBrightness":t(this,Ia,"m",qa).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){s(this,Aa,void 0,"f"),s(this,Ua,!1,"f"),s(this,Na,void 0,"f"),s(this,Va,void 0,"f"),s(this,Ga,[],"f")}get mtu(){return t(this,or,"f")}set mtu(e){s(this,or,e,"f")}}var yr,br,Sr,Cr,Er,Mr,Dr,kr,Wr,Tr,Ir,Rr;Ua=new WeakMap,Aa=new WeakMap,Na=new WeakMap,Va=new WeakMap,Ga=new WeakMap,or=new WeakMap,Ia=new WeakSet,Ra=function(){return this.eventDispatcher.dispatchEvent},La=function(){cr.assertWithError(t(this,Ua,"f"),"display is not available")},_a=function(e){const i=1==e.getUint8(0);s(this,Ua,i,"f"),cr.log({isDisplayAvailable:t(this,Ua,"f")}),t(this,Ia,"a",Ra).call(this,"isDisplayAvailable",{isDisplayAvailable:t(this,Ua,"f")})},Fa=function(e){const s=e.getUint8(0),i=lr[s];t(this,Ia,"m",xa).call(this,i)},xa=function(e){if(cr.assertEnumWithError(e,lr),e==t(this,Aa,"f"))return void cr.log(`redundant displayStatus ${e}`);const i=t(this,Aa,"f");s(this,Aa,e,"f"),cr.log(`updated displayStatus to "${this.displayStatus}"`),t(this,Ia,"a",Ra).call(this,"displayStatus",{displayStatus:this.displayStatus,previousDisplayStatus:i})},$a=async function(e,t){cr.assertEnumWithError(e,hr),cr.log(`sending display command "${e}"`);const s=this.waitForEvent("displayStatus");cr.log(`setting command "${e}"`);const i=hr.indexOf(e);this.sendMessage([{type:"displayCommand",data:J(i)}],t),await s},Oa=function(){cr.assertWithError("awake"==t(this,Aa,"f"),`display is not awake - currently ${t(this,Aa,"f")}`)},Ba=function(){cr.assertWithError("awake"!=t(this,Aa,"f"),"display is awake")},Pa=function(e){const i={};let n=0;for(;n<e.byteLength;){const t=e.getUint8(n++),s=fr[t];switch(cr.assertWithError(s,`invalid displayInformationTypeIndex ${s}`),cr.log({displayInformationType:s}),s){case"width":case"height":{const t=e.getUint16(n,!0);i[s]=t,n+=2}break;case"pixelDepth":case"type":{const t=dr[s];const a=t[e.getUint8(n++)];cr.assertEnumWithError(a,t),i[s]=a}}}cr.log({parsedDisplayInformation:i});const a=fr.find((e=>!(e in i)));cr.assertWithError(!a,`missingDisplayInformationType ${a}`),s(this,Na,i,"f"),t(this,Ia,"a",Ra).call(this,"displayInformation",{displayInformation:t(this,Na,"f")})},qa=function(e){const i=e.getUint8(0),n=gr[i];t(this,Ia,"m",za).call(this,n),s(this,Va,n,"f"),cr.log({displayBrightness:t(this,Va,"f")}),t(this,Ia,"a",Ra).call(this,"getDisplayBrightness",{displayBrightness:t(this,Va,"f")})},za=function(e){cr.assertEnumWithError(e,gr)},ja=function(e){cr.assertEnumWithError(e,pr)},Ha=async function(e,s,i=!1){t(this,Ia,"m",ja).call(this,e);const n=z(pr.indexOf(e),s);t(this,Ga,"f").reduce(((e,t)=>e+t.byteLength),n.byteLength)>this.mtu-6&&(cr.log("displayContextCommandBuffers too full - sending now"),await t(this,Ia,"m",Ja).call(this)),t(this,Ga,"f").push(n),i&&await t(this,Ia,"m",Ja).call(this)},Ja=async function(){cr.log("sending displayContextCommands",t(this,Ga,"f"));const e=z(t(this,Ga,"f"));await this.sendMessage([{type:"displayContextCommands",data:e}],!0),t(this,Ga,"f").length=0},Ka=function(e){t(this,Ia,"m",Qa).call(this,"red",e.r),t(this,Ia,"m",Qa).call(this,"green",e.g),t(this,Ia,"m",Qa).call(this,"blue",e.b)},Qa=function(e,t){cr.assertRangeWithError(e,t,0,255)},Za=function(e){cr.assertRangeWithError("colorIndex",e,0,this.numberOfColors)},Xa=function(e){cr.assertRangeWithError("opacity",e,0,1)},Ya=function(e){cr.assertRangeWithError("lineWidth",e,0,this.width)},er=function(e){return Je(e,0,this.width-1)},tr=function(e,t){return Je(t,1,this.width-e)},sr=function(e){return Je(e,0,this.height-1)},ir=function(e,t){return Je(t,1,this.height-e)},nr=function(e,s,i,n){return e=t(this,Ia,"m",er).call(this,e),i=t(this,Ia,"m",tr).call(this,e,i),s=t(this,Ia,"m",sr).call(this,s),n=t(this,Ia,"m",ir).call(this,s,n),cr.log("clampBox",{x:e,y:s,width:i,height:n}),{x:e,y:s,width:i,height:n}},ar=function(e,s,i){const{x:n,y:a,width:r,height:o}=t(this,Ia,"m",nr).call(this,e,s,i,i);return{x:n,y:a,radius:Math.min(r,o)}},rr=function(e){const t=2*Math.PI,s=(e%t+t)%t;return Math.round(s/t*65535)};const Ur=T("BaseConnectionManager",{log:!1}),Lr=["webBluetooth","noble","client","webSocket","udp"],_r=["notConnected","connecting","connected","disconnecting"],Ar=[..._r,"connectionStatus","isConnected"],Fr=[...In,...fi,...Hs,...ta,...Oe,...Gi,...Ma,...is,...Os,...ur],xr=["batteryLevel"],$r=["rx","tx"],Or=[...xr,...an,...$r,...Fr,"smp"];class Br{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get canUpdateFirmware(){return!1}get type(){return this.baseConstructor.type}constructor(){yr.add(this),Er.set(this,"notConnected"),kr.set(this,[]),Wr.set(this,!1),this.defaultMtu=23,this.mtu=this.defaultMtu,Ir.set(this,new F(t(this,yr,"m",Rr).bind(this),5e3)),t(this,yr,"m",Cr).call(this)}get status(){return t(this,Er,"f")}set status(e){Ur.assertEnumWithError(e,_r),t(this,Er,"f")!=e?(Ur.log(`new connection status "${e}"`),s(this,Er,e,"f"),this.onStatusUpdated(this.status),this.isConnected?t(this,Ir,"f").start():t(this,Ir,"f").stop(),"notConnected"==t(this,Er,"f")&&(this.mtu=this.defaultMtu)):Ur.log(`tried to assign same connection status "${e}"`)}get isConnected(){return"connected"==this.status}get isAvailable(){return!1}assertIsNotConnected(){Ur.assertWithError(!this.isConnected,"device is already connected")}assertIsConnected(){Ur.assertWithError(this.isConnected,"device is not connected")}assertIsConnectedAndNotDisconnecting(){this.assertIsConnected(),t(this,yr,"m",Dr).call(this)}async connect(){this.assertIsNotConnected(),t(this,yr,"m",Mr).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){this.assertIsNotConnected(),t(this,yr,"m",Mr).call(this),Ur.assertWithError(this.canReconnect,"unable to reconnect"),this.status="connecting",Ur.log("attempting to reconnect...")}async disconnect(){this.assertIsConnected(),t(this,yr,"m",Dr).call(this),this.status="disconnecting",Ur.log("disconnecting from device...")}async sendSmpMessage(e){this.assertIsConnectedAndNotDisconnecting(),Ur.log("sending smp message",e)}async sendTxMessages(e,i=!0){if(this.assertIsConnectedAndNotDisconnecting(),e&&(t(this,kr,"f").push(...e),Ur.log(`appended ${e.length} messages`)),!i)return void Ur.log("not sending immediately - waiting until later");if(t(this,Wr,"f"))return void Ur.log("already sending messages - waiting until later");if(0==t(this,kr,"f").length)return void Ur.log("no pendingMessages");s(this,Wr,!0,"f"),Ur.log("sendTxMessages",t(this,kr,"f").slice());const n=t(this,kr,"f").map((e=>{t(br,br,"m",Sr).call(br,e.type);const s=Fr.indexOf(e.type),i=new DataView(new ArrayBuffer(2));return i.setUint16(0,e.data?.byteLength||0,!0),z(s,i,e.data)}));if(t(this,kr,"f").length=0,this.mtu)for(;n.length>0;){if(n.every((e=>e.byteLength>this.mtu-3))){Ur.log("every arrayBuffer is too big to send");break}Ur.log("remaining arrayBuffers.length",n.length);let e=0,t=0;n.some((s=>{if(e+s.byteLength>this.mtu-3)return Ur.log(`stopping appending arrayBuffers ( length ${s.byteLength} too much)`),!0;Ur.log(`allowing arrayBuffer with length ${s.byteLength}`),t++,e+=s.byteLength}));const s=n.splice(0,t);Ur.log({arrayBufferCount:t,arrayBuffersToSend:s});const i=z(...s);Ur.log("sending arrayBuffer (partitioned)",i),await this.sendTxData(i)}else{const e=z(...n);Ur.log("sending arrayBuffer (all)",e),await this.sendTxData(e)}s(this,Wr,!1,"f"),this.sendTxMessages(void 0,!0)}async sendTxData(e){Ur.log("sendTxData",e)}parseRxMessage(e){Ct(e,Fr,t(this,yr,"m",Tr).bind(this),null,!0),this.onMessagesReceived()}clear(){s(this,Wr,!1,"f"),t(this,kr,"f").length=0}remove(){this.clear(),this.onStatusUpdated=void 0,this.onMessageReceived=void 0,this.onMessagesReceived=void 0}}br=Br,Er=new WeakMap,kr=new WeakMap,Wr=new WeakMap,Ir=new WeakMap,yr=new WeakSet,Sr=function(e){Ur.assertEnumWithError(e,Fr)},Cr=function(){Ur.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},Mr=function(){Ur.assertWithError("connecting"!=this.status,"device is already connecting")},Dr=function(){Ur.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},Tr=function(e,t){Ur.log({messageType:e,dataView:t}),this.onMessageReceived(e,t)},Rr=function(){this.isConnected||(Ur.log("timer detected disconnection"),this.status="notConnected")};const Nr=T("EventUtils",{log:!1});function Pr(e,t){let s=e.addEventListener||e.addListener||e.on||e.AddEventListener;Nr.assertWithError(s,"no add listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}function Vr(e,t){let s=e.removeEventListener||e.removeListener||e.RemoveEventListener;Nr.assertWithError(s,"no remove listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}const qr=T("bluetoothUUIDs",{log:!1});if(n)var zr=window.BluetoothUUID;function jr(e){return qr.assertTypeWithError(e,"string"),qr.assertWithError(4==e.length,"value must be 4 characters long"),`ea6d${e}-a725-4f9b-893d-c3913e33b39f`}function Gr(e){return zr?.getCharacteristic?.(e)}function Hr(e){return zr?.getService?.(e)}const Jr=Object.freeze({services:{deviceInformation:{uuid:Hr("device_information"),characteristics:{manufacturerName:{uuid:Gr("manufacturer_name_string")},modelNumber:{uuid:Gr("model_number_string")},hardwareRevision:{uuid:Gr("hardware_revision_string")},firmwareRevision:{uuid:Gr("firmware_revision_string")},softwareRevision:{uuid:Gr("software_revision_string")},pnpId:{uuid:Gr("pnp_id")},serialNumber:{uuid:Gr("serial_number_string")}}},battery:{uuid:Hr("battery_service"),characteristics:{batteryLevel:{uuid:Gr("battery_level")}}},main:{uuid:jr("0000"),characteristics:{rx:{uuid:jr("1000")},tx:{uuid:jr("1001")}}},smp:{uuid:"8d53dc1d-1db7-4cd3-868b-8a527460aa84",characteristics:{smp:{uuid:"da2e7828-fbce-4e01-ae9e-261174997c48"}}}}}),Kr=[Jr.services.main.uuid],Qr=[Jr.services.deviceInformation.uuid,Jr.services.battery.uuid,Jr.services.smp.uuid];function Zr(e){e=e.toString().toLowerCase();return Object.keys(Jr.services).find((t=>{let s=Jr.services[t].uuid.toString();return 4==e.length&&(s=s.slice(4,8)),e.includes("-")||(s=s.replaceAll("-","")),e==s}))}const Xr=[],Yr=[];function eo(e){var t;return e=e.toString().toLowerCase(),Object.values(Jr.services).some((s=>{const i=Object.keys(s.characteristics);return t=i.find((t=>{let i=s.characteristics[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))})),t}function to(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"rx":case"tx":case"smp":t.read=!1}switch(e){case"batteryLevel":case"rx":case"smp":t.notify=!0}if("smp"===e)t.writeWithoutResponse=!0;if("tx"===e)t.write=!0;return t}Object.values(Jr.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((s=>{const i=e.characteristics[s];Kr.includes(e.uuid)&&(Xr.push(i.uuid),t.push(s)),Yr.push(i.uuid)}))}),[]);const so=T("BluetoothConnectionManager",{log:!1});class io extends Br{constructor(){super(...arguments),this.isInRange=!0}get isAvailable(){return!0}onCharacteristicValueChanged(e,t){"rx"==e?this.parseRxMessage(t):this.onMessageReceived?.(e,t)}async writeCharacteristic(e,t){so.log("writeCharacteristic",...arguments)}async sendSmpMessage(e){super.sendSmpMessage(e),await this.writeCharacteristic("smp",e)}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&await this.writeCharacteristic("tx",e)}}var no,ao,ro,oo,co,ho,lo,fo,go,uo,po;const mo=T("WebBluetoothConnectionManager",{log:!1});var vo;n&&(vo=window.navigator.bluetooth);class wo extends io{constructor(){super(...arguments),no.add(this),ao.set(this,{characteristicvaluechanged:t(this,no,"m",go).bind(this)}),ro.set(this,{gattserverdisconnected:t(this,no,"m",po).bind(this)}),oo.set(this,void 0),co.set(this,new Map),ho.set(this,new Map)}get bluetoothId(){return this.device.id}get canUpdateFirmware(){return t(this,ho,"f").has("smp")}static get isSupported(){return Boolean(vo)}static get type(){return"webBluetooth"}get device(){return t(this,oo,"f")}set device(e){t(this,oo,"f")!=e?(t(this,oo,"f")&&Vr(t(this,oo,"f"),t(this,ro,"f")),e&&Pr(e,t(this,ro,"f")),s(this,oo,e,"f")):mo.log("tried to assign the same BluetoothDevice")}get server(){return t(this,oo,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const e=await vo.requestDevice({filters:[{services:Kr}],optionalServices:n?Qr:[]});mo.log("got BluetoothDevice"),this.device=e,mo.log("connecting to device...");const s=await this.server.connect();mo.log(`connected to device? ${s.connected}`),await t(this,no,"m",lo).call(this),mo.log("fully connected"),this.status="connected"}catch(e){mo.error(e),this.status="notConnected",this.server?.disconnect(),t(this,no,"m",fo).call(this)}}async disconnect(){await t(this,no,"m",fo).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(e,s){super.writeCharacteristic(e,s);const i=t(this,ho,"f").get(e);mo.assertWithError(i,`${e} characteristic not found`),mo.log("writing characteristic",i,s);const n=i.properties||to(e);n.writeWithoutResponse?(mo.log("writing without response"),await i.writeValueWithoutResponse(s)):(mo.log("writing with response"),await i.writeValueWithResponse(s)),mo.log("wrote characteristic"),n.read&&!n.notify&&(mo.log("reading value after write..."),await i.readValue(),(c||h)&&t(this,no,"m",uo).call(this,i))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect();try{await this.server.connect()}catch(e){mo.error(e),this.isInRange=!1}this.isConnected?(mo.log("successfully reconnected!"),await t(this,no,"m",lo).call(this),this.status="connected"):(mo.log("unable to reconnect"),this.status="notConnected")}remove(){super.remove(),this.device=void 0}}ao=new WeakMap,ro=new WeakMap,oo=new WeakMap,co=new WeakMap,ho=new WeakMap,no=new WeakSet,lo=async function(){t(this,no,"m",fo).call(this),mo.log("getting services...");const e=await this.server.getPrimaryServices();mo.log("got services",e.length),mo.log("getting characteristics...");for(const s in e){const i=e[s];mo.log({service:i});const n=Zr(i.uuid);mo.assertWithError(n,`no name found for service uuid "${i.uuid}"`),mo.log(`got "${n}" service`),i.name=n,t(this,co,"f").set(n,i),mo.log(`getting characteristics for "${n}" service`);const a=await i.getCharacteristics();mo.log(`got characteristics for "${n}" service`);for(const e in a){const s=a[e];mo.log({characteristic:s});const i=eo(s.uuid);mo.assertWithError(Boolean(i),`no name found for characteristic uuid "${s.uuid}" in "${n}" service`),mo.log(`got "${i}" characteristic in "${n}" service`),s.name=i,t(this,ho,"f").set(i,s),Pr(s,t(this,ao,"f"));const r=s.properties||to(i);r.notify&&(mo.log(`starting notifications for "${i}" characteristic`),await s.startNotifications()),r.read&&(mo.log(`reading "${i}" characteristic...`),await s.readValue(),(c||h)&&t(this,no,"m",uo).call(this,s))}}},fo=async function(){this.device&&Vr(this.device,t(this,ro,"f"));const e=Array.from(t(this,ho,"f").keys()).map((e=>{const s=t(this,ho,"f").get(e);Vr(s,t(this,ao,"f"));if((s.properties||to(e)).notify)return mo.log(`stopping notifications for "${e}" characteristic`),s.stopNotifications()}));return Promise.allSettled(e)},go=function(e){mo.log("oncharacteristicvaluechanged");const s=e.target;t(this,no,"m",uo).call(this,s)},uo=function(e){mo.log("onCharacteristicValue");const t=e.name;mo.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),mo.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const s=e.value;mo.assertWithError(s,`no data found for "${t}" characteristic`),mo.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(s.buffer)));try{this.onCharacteristicValueChanged(t,s)}catch(e){mo.error(e)}},po=function(){mo.log("gattserverdisconnected"),this.status="notConnected"};const yo=4294967296,bo=9007199254740992;const So={encode:function(e){let t,s=new ArrayBuffer(256),i=new DataView(s),n=0;function a(e){let a=s.byteLength;const r=n+e;for(;a<r;)a<<=1;if(a!==s.byteLength){const e=i;s=new ArrayBuffer(a),i=new DataView(s);const t=n+3>>2;for(let s=0;s<t;++s)i.setUint32(s<<2,e.getUint32(s<<2))}return t=e,i}function r(){n+=t}function o(e){r(a(1).setUint8(n,e))}function c(e){const t=a(e.length);for(let s=0;s<e.length;++s)t.setUint8(n+s,e[s]);r()}function h(e,t){t<24?o(e<<5|t):t<256?(o(e<<5|24),o(t)):t<65536?(o(e<<5|25),function(e){r(a(2).setUint16(n,e))}(t)):t<4294967296?(o(e<<5|26),function(e){r(a(4).setUint32(n,e))}(t)):(o(e<<5|27),function(e){const t=e%yo,s=(e-t)/yo,i=a(8);i.setUint32(n,s),i.setUint32(n+4,t),r()}(t))}if(function e(t){let s;const i=[];let l;if(!1===t)return o(244);if(!0===t)return o(245);if(null===t)return o(246);if(void 0===t)return o(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(t>=0&&t<=bo)return h(0,t);if(-bo<=t&&t<0)return h(1,-(t+1))}return o(251),function(e){r(a(8).setFloat64(n,e))}(t);case"string":for(s=0;s<t.length;++s){let e=t.charCodeAt(s);e<128?i.push(e):e<2048?(i.push(192|e>>6),i.push(128|63&e)):e<55296?(i.push(224|e>>12),i.push(128|e>>6&63),i.push(128|63&e)):(e=(1023&e)<<10,e|=1023&t.charCodeAt(++s),e+=65536,i.push(240|e>>18),i.push(128|e>>12&63),i.push(128|e>>6&63),i.push(128|63&e))}return h(3,i.length),c(i);default:if(Array.isArray(t))for(l=t.length,h(4,l),s=0;s<l;++s)e(t[s]);else if(t instanceof Uint8Array)h(2,t.length),c(t);else{const i=Object.keys(t);for(l=i.length,h(5,l),s=0;s<l;++s){const n=i[s];e(n),e(t[n])}}}}(e),"slice"in s)return s.slice(0,n);const l=new ArrayBuffer(n),f=new DataView(l);for(let e=0;e<n;++e)f.setUint8(e,i.getUint8(e));return l},decode:function(e,t,s){const i=new DataView(e);let n=0;function a(e,t){return n+=e,t}function r(t){return a(t,new Uint8Array(e,n,t))}function o(){return a(1,i.getUint8(n))}function c(){return a(2,i.getUint16(n))}function h(){return a(4,i.getUint32(n))}function l(){return 255===i.getUint8(n)&&(n+=1,!0)}function f(e){if(e<24)return e;if(24===e)return o();if(25===e)return c();if(26===e)return h();if(27===e)return h()*yo+h();if(31===e)return-1;throw new Error("Invalid length encoding")}function g(e){const t=o();if(255===t)return-1;const s=f(31&t);if(s<0||t>>5!==e)throw new Error("Invalid indefinite length element");return s}function u(e,t){for(let s=0;s<t;++s){let s=o();128&s&&(s<224?(s=(31&s)<<6|63&o(),t-=1):s<240?(s=(15&s)<<12|(63&o())<<6|63&o(),t-=2):(s=(15&s)<<18|(63&o())<<12|(63&o())<<6|63&o(),t-=3)),s<65536?e.push(s):(s-=65536,e.push(55296|s>>10),e.push(56320|1023&s))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof s&&(s=function(){});const d=function e(){const h=o(),d=h>>5,p=31&h;let m,v;if(7===d)switch(p){case 25:return function(){const e=new ArrayBuffer(4),t=new DataView(e),s=c(),i=32768&s;let n=31744&s;const a=1023&s;if(31744===n)n=261120;else if(0!==n)n+=114688;else if(0!==a)return(i?-1:1)*a*5.960464477539063e-8;return t.setUint32(0,i<<16|n<<13|a<<13),t.getFloat32(0)}();case 26:return a(4,i.getFloat32(n));case 27:return a(8,i.getFloat64(n))}if(v=f(p),v<0&&(d<2||d>6))throw new Error("Invalid length");const w=[];let y;const b={};switch(d){case 0:return v;case 1:return-1-v;case 2:if(v<0){const e=[];let t=0;for(;(v=g(d))>=0;)t+=v,e.push(r(v));const s=new Uint8Array(t);let i=0;for(m=0;m<e.length;++m)s.set(e[m],i),i+=e[m].length;return s}return r(v);case 3:if(v<0)for(;(v=g(d))>=0;)u(w,v);else u(w,v);return String.fromCharCode.apply(null,w);case 4:if(v<0)for(y=[];!l();)y.push(e());else for(y=new Array(v),m=0;m<v;++m)y[m]=e();return y;case 5:for(m=0;m<v||v<0&&!l();++m){b[e()]=e()}return b;case 6:return t(e(),v);case 7:switch(v){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return s(v)}}}();if(n!==e.byteLength)throw new Error("Remaining bytes");return d}},Co=T("mcumgr",{log:!1}),Eo=0,Mo=1,Do=2,ko=3,Wo=0,To=1,Io=8,Ro=0,Uo=2,Lo=3,_o=5,Ao=0,Fo=1,xo=5,$o=0;class Oo{constructor(){this._mtu=256,this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}onMessage(e){return this._messageCallback=e,this}onImageUploadNext(e){return this._imageUploadNextCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}onFileUploadNext(e){return this._fileUploadNextCallback=e,this}onFileUploadProgress(e){return this._fileUploadProgressCallback=e,this}onFileUploadFinished(e){return this._fileUploadFinishedCallback=e,this}onFileDownloadNext(e){return this._fileDownloadNextCallback=e,this}onFileDownloadProgress(e){return this._fileDownloadProgressCallback=e,this}onFileDownloadFinished(e){return this._fileDownloadFinishedCallback=e,this}_getMessage(e,t,s,i){let n=[];void 0!==i&&(n=[...new Uint8Array(So.encode(i))]);const a=255&n.length,r=[e,0,n.length>>8,a,t>>8,255&t,this._seq,s,...n];return this._seq=(this._seq+1)%256,r}_notification(e){Co.log("mcumgr - message received");const t=new Uint8Array(e);this._buffer=new Uint8Array([...this._buffer,...t]);const s=256*this._buffer[2]+this._buffer[3];this._buffer.length<s+8||(this._processMessage(this._buffer.slice(0,s+8)),this._buffer=this._buffer.slice(s+8))}_processMessage(e){const[t,,s,i,n,a,,r]=e,o=So.decode(e.slice(8).buffer),c=256*s+i,h=256*n+a;return Co.log("mcumgr - Process Message - Group: "+h+", Id: "+r+", Off: "+o.off),h===To&&r===Fo&&o.off?(this._uploadOffset=o.off,void this._uploadNext()):t===ko&&h===Io&&r===$o&&o.off?(this._uploadFileOffset=o.off,void this._uploadFileNext()):t===Mo&&h===Io&&r===$o?(this._downloadFileOffset+=o.data.length,null!=o.len&&(this._downloadFileLength=o.len),Co.log("downloaded "+this._downloadFileOffset+" bytes of "+this._downloadFileLength),this._downloadFileLength>0&&this._fileDownloadProgressCallback({percentage:Math.floor(this._downloadFileOffset/this._downloadFileLength*100)}),this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}),void this._downloadFileNext()):void(this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}))}cmdReset(){return this._getMessage(Do,Wo,_o)}smpEcho(e){return this._getMessage(Do,Wo,Ro,{d:e})}cmdImageState(){return this._getMessage(Eo,To,Ao)}cmdImageErase(){return this._getMessage(Do,To,xo,{})}cmdImageTest(e){return this._getMessage(Do,To,Ao,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._getMessage(Do,To,Ao,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(!this._uploadImage)return;if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-So.encode(e).byteLength-8-3-5;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t;const s=this._getMessage(Do,To,Fo,e);Co.log("mcumgr - _uploadNext: Message Length: "+s.length),this._imageUploadNextCallback({packet:s})}async reset(){this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}async cmdUpload(e,t=0){this._uploadIsInProgress?Co.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async cmdUploadFile(e,t){this._uploadIsInProgress?Co.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadFileOffset=0,this._uploadFile=e,this._uploadFilename=t,this._uploadFileNext())}async _uploadFileNext(){if(Co.log("uploadFileNext - offset: "+this._uploadFileOffset+", length: "+this._uploadFile.byteLength),this._uploadFileOffset>=this._uploadFile.byteLength)return this._uploadIsInProgress=!1,void this._fileUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadFileOffset};0===this._uploadFileOffset&&(e.len=this._uploadFile.byteLength),e.name=this._uploadFilename,this._fileUploadProgressCallback({percentage:Math.floor(this._uploadFileOffset/this._uploadFile.byteLength*100)});const t=this._mtu-So.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadFile.slice(this._uploadFileOffset,this._uploadFileOffset+t)),this._uploadFileOffset+=t;const s=this._getMessage(Do,Io,$o,e);Co.log("mcumgr - _uploadNext: Message Length: "+s.length),this._fileUploadNextCallback({packet:s})}async cmdDownloadFile(e,t){this._downloadIsInProgress?Co.error("Download is already in progress."):(this._downloadIsInProgress=!0,this._downloadFileOffset=0,this._downloadFileLength=0,this._downloadRemoteFilename=e,this._downloadLocalFilename=t,this._downloadFileNext())}async _downloadFileNext(){if(this._downloadFileLength>0&&this._downloadFileOffset>=this._downloadFileLength)return this._downloadIsInProgress=!1,void this._fileDownloadFinishedCallback();const e={off:this._downloadFileOffset};0===this._downloadFileOffset&&(e.name=this._downloadRemoteFilename);const t=this._getMessage(Eo,Io,$o,e);Co.log("mcumgr - _downloadNext: Message Length: "+t.length),this._fileDownloadNextCallback({packet:t})}async imageInfo(e){const t={},s=new Uint8Array(e);if(s.length<32)throw new Error("Invalid image (too short file)");if(61!==s[0]||184!==s[1]||243!==s[2]||150!==s[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==s[4]||0!==s[5]||0!==s[6]||0!==s[7])throw new Error("Invalid image (wrong load address)");const i=s[8]+256*s[9];if(0!==s[10]||0!==s[11])throw new Error("Invalid image (wrong protected TLV area size)");const n=s[12]+256*s[13]+65536*s[14]+s[15]*2**24;if(t.imageSize=n,s.length<n+i)throw new Error("Invalid image (wrong image size)");if(0!==s[16]||0!==s[17]||0!==s[18]||0!==s[19])throw new Error("Invalid image (wrong flags)");const a=`${s[20]}.${s[21]}.${s[22]+256*s[23]}`;return t.version=a,t.hash=[...new Uint8Array(await this._hash(e.slice(0,n+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}var Bo,No,Po,Vo,qo,zo,jo,Go,Ho,Jo,Ko,Qo,Zo,Xo,Yo,ec,tc,sc,ic,nc,ac;const rc=T("FirmwareManager",{log:!1}),oc=["smp"],cc=[...oc,"firmwareImages","firmwareUploadProgress","firmwareStatus","firmwareUploadComplete"],hc=["idle","uploading","uploaded","pending","testing","erasing"];class lc{constructor(){Bo.add(this),Po.set(this,"idle"),qo.set(this,void 0),Go.set(this,void 0),Ho.set(this,new Oo),t(this,Bo,"m",Jo).call(this),K(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}parseMessage(e,s){if(rc.log({messageType:e}),"smp"!==e)throw Error(`uncaught messageType ${e}`);t(this,Ho,"f")._notification(Array.from(new Uint8Array(s.buffer))),t(this,Bo,"a",No).call(this,"smp",{dataView:s})}async uploadFirmware(e){rc.log("uploadFirmware",e);const s=this.waitForEvent("firmwareUploadComplete");await this.getImages();const i=await H(e),n=await t(this,Ho,"f").imageInfo(i);rc.log({imageInfo:n}),t(this,Ho,"f").cmdUpload(i,1),t(this,Bo,"m",Vo).call(this,"uploading"),await s}get status(){return t(this,Po,"f")}get images(){return t(this,qo,"f")}async getImages(){const e=this.waitForEvent("firmwareImages");rc.log("getting firmware image state..."),this.sendMessage(Uint8Array.from(t(this,Ho,"f").cmdImageState()).buffer),await e}async testImage(e=1){if(t(this,Bo,"m",jo).call(this,e),t(this,Bo,"m",zo).call(this),!t(this,qo,"f")[e])return void rc.log(`image ${e} not found`);if(1==t(this,qo,"f")[e].pending)return void rc.log(`image ${e} is already pending`);if(t(this,qo,"f")[e].empty)return void rc.log(`image ${e} is empty`);const s=this.waitForEvent("smp");rc.log("testing firmware image..."),this.sendMessage(Uint8Array.from(t(this,Ho,"f").cmdImageTest(t(this,qo,"f")[e].hash)).buffer),await s}async eraseImage(){t(this,Bo,"m",zo).call(this);const e=this.waitForEvent("smp");rc.log("erasing image..."),this.sendMessage(Uint8Array.from(t(this,Ho,"f").cmdImageErase()).buffer),t(this,Bo,"m",Vo).call(this,"erasing"),await e,await this.getImages()}async confirmImage(e=0){if(t(this,Bo,"m",jo).call(this,e),t(this,Bo,"m",zo).call(this),!0===t(this,qo,"f")[e].confirmed)return void rc.log(`image ${e} is already confirmed`);const s=this.waitForEvent("smp");rc.log("confirming image..."),this.sendMessage(Uint8Array.from(t(this,Ho,"f").cmdImageConfirm(t(this,qo,"f")[e].hash)).buffer),await s}async echo(e){rc.assertTypeWithError(e,"string");const s=this.waitForEvent("smp");rc.log("sending echo..."),this.sendMessage(Uint8Array.from(t(this,Ho,"f").smpEcho(e)).buffer),await s}async reset(){const e=this.waitForEvent("smp");rc.log("resetting..."),this.sendMessage(Uint8Array.from(t(this,Ho,"f").cmdReset()).buffer),await e}get mtu(){return t(this,Go,"f")}set mtu(e){s(this,Go,e,"f"),t(this,Ho,"f")._mtu=e}}var fc,gc,uc,dc,pc,mc,vc,wc,yc,bc,Sc,Cc,Ec,Mc,Dc,kc,Wc,Tc;Po=new WeakMap,qo=new WeakMap,Go=new WeakMap,Ho=new WeakMap,Bo=new WeakSet,No=function(){return this.eventDispatcher.dispatchEvent},Vo=function(e){rc.assertEnumWithError(e,hc),t(this,Po,"f")!=e?(s(this,Po,e,"f"),rc.log({firmwareStatus:t(this,Po,"f")}),t(this,Bo,"a",No).call(this,"firmwareStatus",{firmwareStatus:t(this,Po,"f")})):rc.log(`redundant firmwareStatus assignment "${e}"`)},zo=function(){rc.assertWithError(t(this,qo,"f"),"didn't get imageState")},jo=function(e){rc.assertTypeWithError(e,"number"),rc.assertWithError(0==e||1==e,"imageIndex must be 0 or 1")},Jo=function(){t(this,Ho,"f").onMessage(t(this,Bo,"m",Ko).bind(this)),t(this,Ho,"f").onFileDownloadNext(t(this,Bo,"m",Qo)),t(this,Ho,"f").onFileDownloadProgress(t(this,Bo,"m",Zo).bind(this)),t(this,Ho,"f").onFileDownloadFinished(t(this,Bo,"m",Xo).bind(this)),t(this,Ho,"f").onFileUploadNext(t(this,Bo,"m",Yo).bind(this)),t(this,Ho,"f").onFileUploadProgress(t(this,Bo,"m",ec).bind(this)),t(this,Ho,"f").onFileUploadFinished(t(this,Bo,"m",tc).bind(this)),t(this,Ho,"f").onImageUploadNext(t(this,Bo,"m",sc).bind(this)),t(this,Ho,"f").onImageUploadProgress(t(this,Bo,"m",ic).bind(this)),t(this,Ho,"f").onImageUploadFinished(t(this,Bo,"m",nc).bind(this))},Ko=function({op:e,group:s,id:i,data:n,length:a}){switch(rc.log("onMcuMessage",...arguments),s){case Wo:switch(i){case Ro:rc.log(`echo "${n.r}"`);break;case Uo:rc.table(n.tasks);break;case Lo:rc.log(n)}break;case To:if(i===Ao)t(this,Bo,"m",ac).call(this,n);break;default:throw Error(`uncaught mcuMessage group ${s}`)}},Qo=function(){rc.log("onMcuFileDownloadNext",...arguments)},Zo=function(){rc.log("onMcuFileDownloadProgress",...arguments)},Xo=function(){rc.log("onMcuFileDownloadFinished",...arguments)},Yo=function(){rc.log("onMcuFileUploadNext")},ec=function(){rc.log("onMcuFileUploadProgress")},tc=function(){rc.log("onMcuFileUploadFinished")},sc=function({packet:e}){rc.log("onMcuImageUploadNext"),this.sendMessage(Uint8Array.from(e).buffer)},ic=function({percentage:e}){const s=e/100;rc.log("onMcuImageUploadProgress",...arguments),t(this,Bo,"a",No).call(this,"firmwareUploadProgress",{progress:s})},nc=async function(){rc.log("onMcuImageUploadFinished",...arguments),await this.getImages(),t(this,Bo,"a",No).call(this,"firmwareUploadProgress",{progress:100}),t(this,Bo,"a",No).call(this,"firmwareUploadComplete",{})},ac=function({images:e}){if(!e)return void rc.log("no images found");s(this,qo,e,"f"),rc.log("images",t(this,qo,"f"));let i="idle";2==t(this,qo,"f").length&&(t(this,qo,"f")[1].bootable?t(this,qo,"f")[0].confirmed?t(this,qo,"f")[1].pending?(rc.log("reset to upload to the new firmware image"),i="pending"):(rc.log("Slot 1 has a valid image. run testImage() to test it or upload a different image."),i="uploaded"):(rc.log('Slot 0 has a valid image. Click "Confirm Image" to confirm it or wait and the device will swap images back.'),i="testing"):rc.warn('Slot 1 has a invalid image. Click "Erase Image" to erase it or upload a different image')),1==t(this,qo,"f").length&&(t(this,qo,"f").push({slot:1,empty:!0,version:"Empty",pending:!1,confirmed:!1,bootable:!1,active:!1,permanent:!1}),rc.log("Select a firmware upload image to upload to slot 1.")),t(this,Bo,"m",Vo).call(this,i),t(this,Bo,"a",No).call(this,"firmwareImages",{firmwareImages:t(this,qo,"f")})};const Ic=T("DeviceManager",{log:!1}),Rc=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class Uc{constructor(){if(fc.add(this),gc.set(this,{getType:t(this,fc,"m",uc).bind(this),isConnected:t(this,fc,"m",kc).bind(this)}),dc.set(this,[]),pc.set(this,!1),mc.set(this,{devices:[]}),vc.set(this,void 0),yc.set(this,"BS.Device"),Ec.set(this,[]),Mc.set(this,new R(this,Rc)),Uc.shared&&this!=Uc.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(e){Pr(e,t(this,gc,"f"))}OnDeviceConnectionStatusUpdated(e,s){if("notConnected"==s&&!e.canReconnect&&t(this,Ec,"f").includes(e)){const s=t(this,Ec,"f").indexOf(e);this.AvailableDevices.splice(s,1),t(this,fc,"m",Wc).call(this)}}get ConnectedDevices(){return t(this,dc,"f")}get UseLocalStorage(){return t(this,pc,"f")}set UseLocalStorage(e){t(this,fc,"m",wc).call(this),Ic.assertTypeWithError(e,"boolean"),s(this,pc,e,"f"),t(this,pc,"f")&&!t(this,vc,"f")&&t(this,fc,"m",Sc).call(this)}get CanUseLocalStorage(){return n&&window.localStorage}get AvailableDevices(){return t(this,Ec,"f")}get CanGetDevices(){return n&&navigator.bluetooth?.getDevices}async GetDevices(){if(!n)return void Ic.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void Ic.warn("bluetooth is not available in this browser");if(c)return void Ic.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void Ic.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void Ic.log("CanGetDevices is false");t(this,vc,"f")||t(this,fc,"m",Sc).call(this);const e=t(this,vc,"f");if(!e.devices||0==e.devices.length)return void Ic.log("no devices found in configuration");const s=await navigator.bluetooth.getDevices();return Ic.log({bluetoothDevices:s}),s.forEach((s=>{if(!s.gatt)return;let i=e.devices.find((e=>s.id==e.bluetoothId));if(!i)return;let n=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));const a=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));if(a)return void(n&&n?.bluetoothId==a.bluetoothId&&n!=a&&(this.AvailableDevices[t(this,Ec,"f").indexOf(a)]=n));if(n)return void this.AvailableDevices.push(n);const r=new il,o=new wo;o.device=s,s.name&&r._informationManager.updateName(s.name),r._informationManager.updateType(i.type),r.connectionManager=o,this.AvailableDevices.push(r)})),t(this,fc,"m",Wc).call(this),this.AvailableDevices}get AddEventListener(){return t(this,Mc,"f").addEventListener}get RemoveEventListener(){return t(this,Mc,"f").removeEventListener}get RemoveEventListeners(){return t(this,Mc,"f").removeEventListeners}get RemoveAllEventListeners(){return t(this,Mc,"f").removeAllEventListeners}_CheckDeviceAvailability(e){e.isConnected||e.isAvailable||!t(this,Ec,"f").includes(e)||(Ic.log("removing device from availableDevices..."),t(this,Ec,"f").splice(t(this,Ec,"f").indexOf(e),1),t(this,fc,"m",Wc).call(this))}}gc=new WeakMap,dc=new WeakMap,pc=new WeakMap,mc=new WeakMap,vc=new WeakMap,yc=new WeakMap,Ec=new WeakMap,Mc=new WeakMap,fc=new WeakSet,uc=function(e){t(this,pc,"f")&&t(this,fc,"m",Cc).call(this,e.target)},wc=function(){Ic.assertWithError(n,"localStorage is only available in the browser"),Ic.assertWithError(window.localStorage,"localStorage not found")},bc=function(){t(this,fc,"m",wc).call(this),localStorage.setItem(t(this,yc,"f"),JSON.stringify(t(this,vc,"f")))},Sc=async function(){t(this,fc,"m",wc).call(this);let e=localStorage.getItem(t(this,yc,"f"));if("string"!=typeof e)return Ic.log("no info found in localStorage"),s(this,vc,Object.assign({},t(this,mc,"f")),"f"),void t(this,fc,"m",bc).call(this);try{const t=JSON.parse(e);Ic.log({configuration:t}),s(this,vc,t,"f"),this.CanGetDevices&&await this.GetDevices()}catch(e){Ic.error(e)}},Cc=function(e){if("webBluetooth"!=e.connectionType)return void Ic.log("localStorage is only for webBluetooth devices");t(this,fc,"m",wc).call(this);const s=t(this,vc,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1!=s&&(t(this,vc,"f").devices[s].type=e.type,t(this,fc,"m",bc).call(this))},Dc=function(){return t(this,Mc,"f").dispatchEvent},kc=function(e){const{target:s}=e;if(s.isConnected)if(t(this,dc,"f").includes(s))Ic.log("device already included");else{if(Ic.log("adding device",s),t(this,dc,"f").push(s),this.UseLocalStorage&&"webBluetooth"==s.connectionType){const e={type:s.type,bluetoothId:s.bluetoothId,ipAddress:s.ipAddress,isWifiSecure:s.isWifiSecure},i=t(this,vc,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1==i?t(this,vc,"f").devices.push(e):t(this,vc,"f").devices[i]=e,t(this,fc,"m",bc).call(this)}t(this,fc,"a",Dc).call(this,"deviceConnected",{device:s}),t(this,fc,"a",Dc).call(this,"deviceIsConnected",{device:s}),t(this,fc,"m",Tc).call(this)}else t(this,dc,"f").includes(s)?(Ic.log("removing device",s),t(this,dc,"f").splice(t(this,dc,"f").indexOf(s),1),t(this,fc,"a",Dc).call(this,"deviceDisconnected",{device:s}),t(this,fc,"a",Dc).call(this,"deviceIsConnected",{device:s}),t(this,fc,"m",Tc).call(this)):Ic.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),s.isConnected&&!this.AvailableDevices.includes(s)){const e=this.AvailableDevices.find((e=>e.bluetoothId==s.bluetoothId));Ic.log({existingAvailableDevice:e}),e?this.AvailableDevices[this.AvailableDevices.indexOf(e)]=s:this.AvailableDevices.push(s),t(this,fc,"m",Wc).call(this)}this._CheckDeviceAvailability(s)},Wc=function(){Ic.log({AvailableDevices:this.AvailableDevices}),t(this,fc,"a",Dc).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},Tc=function(){Ic.log({ConnectedDevices:this.ConnectedDevices}),t(this,fc,"a",Dc).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},Uc.shared=new Uc;var Lc=Uc.shared;const _c=T("ServerUtils",{log:!1}),Ac=["isScanningAvailable","isScanning","startScan","stopScan","discoveredDevice","discoveredDevices","expiredDiscoveredDevice","connectToDevice","disconnectFromDevice","connectedDevices","deviceMessage","requiredDeviceInformation"];function Fc(e,...t){_c.log("createMessage",...t);const s=t.map((t=>{"string"==typeof t&&(t={type:t}),null!=t.data?Array.isArray(t.data)||(t.data=[t.data]):t.data=[];const s=z(...t.data),i=s.byteLength;_c.assertEnumWithError(t.type,e);const n=e.indexOf(t.type),a=new DataView(new ArrayBuffer(2));return a.setUint16(0,i,!0),z(n,a,s)}));return _c.log("messageBuffers",...s),z(...s)}function xc(...e){return _c.log("createServerMessage",...e),Fc(Ac,...e)}function $c(...e){return _c.log("createClientDeviceMessage",...e),Fc(Or,...e)}xc("isScanningAvailable"),xc("isScanning"),xc("startScan"),xc("stopScan"),xc("discoveredDevices");const Oc=T("WebSocketUtils",{log:!1}),Bc=["ping","pong","serverMessage"];function Nc(...e){return Oc.log("createWebSocketMessage",...e),Fc(Bc,...e)}var Pc,Vc,qc,zc,jc,Gc,Hc,Jc,Kc,Qc,Zc,Xc,Yc,eh,th,sh,ih,nh;Nc("ping"),Nc("pong");const ah=T("WebSocketConnectionManager",{log:!1}),rh=["ping","pong","batteryLevel","deviceInformation","message"];const oh=["deviceInformation","batteryLevel"];class ch extends Br{get bluetoothId(){return t(this,Vc,"f")??""}constructor(e,i=!1,n){super(),Pc.add(this),Vc.set(this,void 0),this.defaultMtu=1024,qc.set(this,void 0),zc.set(this,void 0),jc.set(this,!1),Jc.set(this,{open:t(this,Pc,"m",Kc).bind(this),message:t(this,Pc,"m",Qc).bind(this),close:t(this,Pc,"m",Zc).bind(this),error:t(this,Pc,"m",Xc).bind(this)}),th.set(this,new F(t(this,Pc,"m",sh).bind(this),29e3)),this.ipAddress=e,this.isSecure=i,this.mtu=this.defaultMtu,s(this,Vc,n,"f")}get isAvailable(){return!0}static get isSupported(){return!0}static get type(){return"webSocket"}get webSocket(){return t(this,qc,"f")}set webSocket(e){t(this,qc,"f")!=e?(ah.log("assigning webSocket",e),t(this,qc,"f")&&(Vr(t(this,qc,"f"),t(this,Jc,"f")),t(this,qc,"f").readyState==t(this,qc,"f").OPEN&&t(this,qc,"f").close()),e&&Pr(e,t(this,Jc,"f")),s(this,qc,e,"f"),ah.log("assigned webSocket")):ah.log("redundant webSocket assignment")}get ipAddress(){return t(this,zc,"f")}set ipAddress(e){this.assertIsNotConnected(),t(this,zc,"f")!=e?(s(this,zc,e,"f"),ah.log(`updated ipAddress to "${this.ipAddress}"`)):ah.log(`redundnant ipAddress assignment "${e}"`)}get isSecure(){return t(this,jc,"f")}set isSecure(e){this.assertIsNotConnected(),t(this,jc,"f")!=e?(s(this,jc,e,"f"),ah.log(`updated isSecure to "${this.isSecure}"`)):ah.log(`redundant isSecure assignment ${e}`)}get url(){return`${this.isSecure?"wss":"ws"}://${this.ipAddress}/ws`}async connect(){await super.connect();try{this.webSocket=new WebSocket(this.url)}catch(e){ah.error("error connecting to webSocket",e),this.status="notConnected"}}async disconnect(){await super.disconnect(),ah.log("closing websocket"),t(this,th,"f").stop(),t(this,qc,"f")?.close()}get canReconnect(){return Boolean(this.webSocket)}async reconnect(){await super.reconnect(),this.webSocket=new WebSocket(this.url)}async sendSmpMessage(e){super.sendSmpMessage(e),ah.error("smp not supported on webSockets")}async sendTxData(e){await super.sendTxData(e),0!=e.byteLength&&t(this,Pc,"m",Hc).call(this,{type:"message",data:e})}remove(){super.remove(),this.webSocket=void 0}}var hh,lh,fh,gh,uh,dh,ph,mh,vh,wh,yh,bh,Sh,Ch,Eh,Mh,Dh,kh,Wh,Th,Ih,Rh,Uh,Lh,_h,Ah,Fh,xh,$h,Oh,Bh,Nh,Ph,Vh,qh,zh,jh,Gh,Hh,Jh,Kh,Qh,Zh,Xh,Yh;Vc=new WeakMap,qc=new WeakMap,zc=new WeakMap,jc=new WeakMap,Jc=new WeakMap,th=new WeakMap,Pc=new WeakSet,Gc=function(e){this.assertIsConnected(),ah.log("sending webSocket message",e),t(this,qc,"f").send(e),t(this,th,"f").restart()},Hc=function(...e){t(this,Pc,"m",Gc).call(this,function(...e){return ah.log("createWebSocketMessage",...e),Fc(rh,...e)}(...e))},Kc=function(e){ah.log("webSocket.open",e),t(this,th,"f").start(),this.status="connected",t(this,Pc,"m",nh).call(this)},Qc=async function(e){const s=await e.data.arrayBuffer(),i=new DataView(s);ah.log(`webSocket.message (${i.byteLength} bytes)`),t(this,Pc,"m",Yc).call(this,i)},Zc=function(e){ah.log("webSocket.close",e),this.status="notConnected",t(this,th,"f").stop()},Xc=function(e){ah.error("webSocket.error",e)},Yc=function(e){Ct(e,rh,t(this,Pc,"m",eh).bind(this),null,!0)},eh=function(e,s){switch(ah.log(`received "${e}" message (${s.byteLength} bytes)`),e){case"ping":t(this,Pc,"m",ih).call(this);break;case"pong":break;case"batteryLevel":this.onMessageReceived?.("batteryLevel",s);break;case"deviceInformation":Ct(s,an,((e,t)=>{this.onMessageReceived(e,t)}));break;case"message":this.parseRxMessage(s);break;default:ah.error(`uncaught messageType "${e}"`)}},sh=function(){ah.log("pinging"),t(this,Pc,"m",Hc).call(this,"ping")},ih=function(){ah.log("ponging"),t(this,Pc,"m",Hc).call(this,"pong")},nh=function(){t(this,Pc,"m",Hc).call(this,...oh)};const el=T("Device",{log:!1}),tl=["connectionMessage",...Ar,...$r,...xr,...Rn,...rn,...gi,...Ks,...sa,...Ve,...Hi,...ka,...as,...Ps,...vr,...cc],sl=["isCharging","getBatteryCurrent","getId","getMtu","getName","getType","getCurrentTime","getSensorConfiguration","getSensorScalars","getVibrationLocations","getFileTypes","isWifiAvailable"];class il{get bluetoothId(){return t(this,dh,"f")?.bluetoothId}get isAvailable(){return t(this,dh,"f")?.isAvailable}constructor(){hh.add(this),gh.set(this,new R(this,tl)),dh.set(this,void 0),this.sendTxMessages=t(this,hh,"m",ph).bind(this),mh.set(this,!1),Eh.set(this,lh.ReconnectOnDisconnection),Mh.set(this,void 0),this.latestConnectionMessages=new Map,Lh.set(this,new on),_h.set(this,0),this._informationManager=new Un,Fh.set(this,new ui),$h.set(this,lh.ClearSensorConfigurationOnLeave),Oh.set(this,new Qs),Bh.set(this,new aa),Nh.set(this,new ze),Ph.set(this,new Zi),Vh.set(this,new lc),this.sendSmpMessage=t(this,hh,"m",zh).bind(this),jh.set(this,!1),Gh.set(this,new Wa),Hh.set(this,new rs),Kh.set(this,new Vs),Xh.set(this,new wr),t(this,Lh,"f").eventDispatcher=t(this,gh,"f"),this._informationManager.sendMessage=this.sendTxMessages,this._informationManager.eventDispatcher=t(this,gh,"f"),t(this,Fh,"f").sendMessage=this.sendTxMessages,t(this,Fh,"f").eventDispatcher=t(this,gh,"f"),t(this,Oh,"f").eventDispatcher=t(this,gh,"f"),t(this,Bh,"f").sendMessage=this.sendTxMessages,t(this,Bh,"f").eventDispatcher=t(this,gh,"f"),t(this,Ph,"f").sendMessage=this.sendTxMessages,t(this,Ph,"f").eventDispatcher=t(this,gh,"f"),t(this,Nh,"f").sendMessage=this.sendTxMessages,t(this,Nh,"f").eventDispatcher=t(this,gh,"f"),t(this,Gh,"f").sendMessage=this.sendTxMessages,t(this,Gh,"f").eventDispatcher=t(this,gh,"f"),t(this,Hh,"f").sendMessage=this.sendTxMessages,t(this,Hh,"f").eventDispatcher=t(this,gh,"f"),t(this,Kh,"f").sendMessage=this.sendTxMessages,t(this,Kh,"f").eventDispatcher=t(this,gh,"f"),t(this,Xh,"f").sendMessage=this.sendTxMessages,t(this,Xh,"f").eventDispatcher=t(this,gh,"f"),t(this,Vh,"f").sendMessage=this.sendSmpMessage,t(this,Vh,"f").eventDispatcher=t(this,gh,"f"),this.addEventListener("getMtu",(()=>{t(this,Vh,"f").mtu=this.mtu,t(this,Nh,"f").mtu=this.mtu,this.connectionManager.mtu=this.mtu,t(this,Xh,"f").mtu=this.mtu})),this.addEventListener("getSensorConfiguration",(()=>{if("connecting"==this.connectionStatus){if(this.sensorTypes.includes("pressure")){el.log("requesting required pressure information");const e=Js.map((e=>({type:e})));this.sendTxMessages(e,!1)}else el.log("don't need to request pressure infomration");if(this.sensorTypes.includes("camera")){el.log("requesting required camera information");const e=ns.map((e=>({type:e})));this.sendTxMessages(e,!1)}else el.log("don't need to request camera infomration");if(this.sensorTypes.includes("microphone")){el.log("requesting required microphone information");const e=Ns.map((e=>({type:e})));this.sendTxMessages(e,!1)}else el.log("don't need to request microphone infomration")}})),this.addEventListener("getFileTypes",(()=>{"connecting"==this.connectionStatus&&(this.fileTypes.length>0&&t(this,Nh,"f").requestRequiredInformation(),this.fileTypes.includes("tflite")&&t(this,Ph,"f").requestRequiredInformation())})),this.addEventListener("isWifiAvailable",(()=>{"connecting"==this.connectionStatus&&("client"!=this.connectionType||a)&&this.isWifiAvailable&&"client"!=this.connectionType&&t(this,Gh,"f").requestRequiredInformation()})),this.addEventListener("getType",(()=>{"connecting"==this.connectionStatus&&("client"!=this.connectionType||a)&&"glasses"==this.type&&"client"!=this.connectionType&&t(this,Xh,"f").requestRequiredInformation()})),this.addEventListener("isDisplayAvailable",(()=>{"connecting"==this.connectionStatus&&("client"!=this.connectionType||a)&&this.isDisplayAvailable&&"client"!=this.connectionType&&t(this,Xh,"f").requestRequiredInformation()})),Lc.onDevice(this),n&&window.addEventListener("beforeunload",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()})),a&&process.on("exit",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()}))}get addEventListener(){return t(this,gh,"f").addEventListener}get removeEventListener(){return t(this,gh,"f").removeEventListener}get waitForEvent(){return t(this,gh,"f").waitForEvent}get removeEventListeners(){return t(this,gh,"f").removeEventListeners}get removeAllEventListeners(){return t(this,gh,"f").removeAllEventListeners}get connectionManager(){return t(this,dh,"f")}set connectionManager(e){this.connectionManager!=e?(this.connectionManager&&this.connectionManager.remove(),e&&(e.onStatusUpdated=t(this,hh,"m",Dh).bind(this),e.onMessageReceived=t(this,hh,"m",Rh).bind(this),e.onMessagesReceived=t(this,hh,"m",Uh).bind(this)),s(this,dh,e,"f"),el.log("assigned new connectionManager",t(this,dh,"f")),this._informationManager.connectionType=this.connectionType):el.log("same connectionManager is already assigned")}async connect(e){if(el.log("connect options",e),e)switch(e.type){case"webBluetooth":"webBluetooth"!=this.connectionType&&(this.connectionManager=new wo);break;case"webSocket":{let t=!1;if("webSocket"==this.connectionType){const s=this.connectionManager;s.ipAddress==e.ipAddress&&s.isSecure==e.isWifiSecure||(t=!0)}else t=!0;t&&(this.connectionManager=new ch(e.ipAddress,e.isWifiSecure,this.bluetoothId))}break;case"udp":{let t=!1;if("udp"==this.connectionType){this.connectionManager.ipAddress!=e.ipAddress&&(t=!0),this.reconnectOnDisconnection=!0}else t=!0;t&&(this.connectionManager=new UDPConnectionManager(e.ipAddress,this.bluetoothId))}}if(this.connectionManager||(this.connectionManager=t(lh,lh,"m",fh).call(lh)),t(this,hh,"m",Th).call(this),"client"==e?.type){el.assertWithError("client"==this.connectionType,"expected clientConnectionManager");const t=this.connectionManager;return t.subType=e.subType,t.connect()}return el.log("connectionManager type",this.connectionManager.type),this.connectionManager.connect()}get isConnected(){return t(this,mh,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return t(this,hh,"m",Sh).call(this),t(this,hh,"m",Th).call(this),this.connectionManager?.reconnect()}static async Connect(){const e=new lh;return await e.connect(),e}static get ReconnectOnDisconnection(){return t(this,lh,"f",Ch)}static set ReconnectOnDisconnection(e){el.assertTypeWithError(e,"boolean"),s(this,lh,e,"f",Ch)}get reconnectOnDisconnection(){return t(this,Eh,"f")}set reconnectOnDisconnection(e){el.assertTypeWithError(e,"boolean"),s(this,Eh,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return t(this,hh,"m",vh).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){if(this.isConnected)this.disconnect();else if(this.canReconnect)try{this.reconnect()}catch(e){el.error("error trying to reconnect",e),this.connect()}else this.connect()}get connectionStatus(){switch(t(this,dh,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return t(this,dh,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return t(this,Lh,"f").information}get batteryLevel(){return t(this,_h,"f")}get id(){return this._informationManager.id}get isCharging(){return this._informationManager.isCharging}get batteryCurrent(){return this._informationManager.batteryCurrent}get getBatteryCurrent(){return this._informationManager.getBatteryCurrent}get name(){return this._informationManager.name}get setName(){return this._informationManager.setName}get type(){return this._informationManager.type}get setType(){return this._informationManager.setType}get isInsole(){return this._informationManager.isInsole}get isGlove(){return this._informationManager.isGlove}get side(){return this._informationManager.side}get mtu(){return this._informationManager.mtu}get sensorTypes(){return Object.keys(this.sensorConfiguration)}get continuousSensorTypes(){return Gs.filter((e=>this.sensorTypes.includes(e)))}get sensorConfiguration(){return t(this,Fh,"f").configuration}async setSensorConfiguration(e,s){await t(this,Fh,"f").setConfiguration(e,s)}async clearSensorConfiguration(){return t(this,Fh,"f").clearSensorConfiguration()}static get ClearSensorConfigurationOnLeave(){return t(this,lh,"f",xh)}static set ClearSensorConfigurationOnLeave(e){el.assertTypeWithError(e,"boolean"),s(this,lh,e,"f",xh)}get clearSensorConfigurationOnLeave(){return t(this,$h,"f")}set clearSensorConfigurationOnLeave(e){el.assertTypeWithError(e,"boolean"),s(this,$h,e,"f")}get numberOfPressureSensors(){return t(this,Oh,"f").pressureSensorDataManager.numberOfSensors}resetPressureRange(){t(this,Oh,"f").pressureSensorDataManager.resetRange()}get vibrationLocations(){return t(this,Bh,"f").vibrationLocations}async triggerVibration(e,s){t(this,Bh,"f").triggerVibration(e,s)}get fileTypes(){return t(this,Nh,"f").fileTypes}get maxFileLength(){return t(this,Nh,"f").maxLength}get validFileTypes(){return Be.filter((e=>!(e.includes("wifi")&&!this.isWifiAvailable)))}async sendFile(e,s){el.assertWithError(this.validFileTypes.includes(e),`invalid fileType ${e}`);const i=this.waitForEvent("fileTransferComplete");t(this,Nh,"f").send(e,s),await i}async receiveFile(e){const s=this.waitForEvent("fileTransferComplete");t(this,Nh,"f").receive(e),await s}get fileTransferStatus(){return t(this,Nh,"f").status}cancelFileTransfer(){t(this,Nh,"f").cancel()}get tfliteName(){return t(this,Ph,"f").name}get setTfliteName(){return t(this,Ph,"f").setName}async sendTfliteConfiguration(e){e.type="tflite",t(this,Ph,"f").sendConfiguration(e,!1);await t(this,Nh,"f").send(e.type,e.file)||t(this,hh,"m",ph).call(this)}get tfliteTask(){return t(this,Ph,"f").task}get setTfliteTask(){return t(this,Ph,"f").setTask}get tfliteSampleRate(){return t(this,Ph,"f").sampleRate}get setTfliteSampleRate(){return t(this,Ph,"f").setSampleRate}get tfliteSensorTypes(){return t(this,Ph,"f").sensorTypes}get allowedTfliteSensorTypes(){return this.sensorTypes.filter((e=>Qi.includes(e)))}get setTfliteSensorTypes(){return t(this,Ph,"f").setSensorTypes}get tfliteIsReady(){return t(this,Ph,"f").isReady}get tfliteInferencingEnabled(){return t(this,Ph,"f").inferencingEnabled}get setTfliteInferencingEnabled(){return t(this,Ph,"f").setInferencingEnabled}async enableTfliteInferencing(){return this.setTfliteInferencingEnabled(!0)}async disableTfliteInferencing(){return this.setTfliteInferencingEnabled(!1)}get toggleTfliteInferencing(){return t(this,Ph,"f").toggleInferencingEnabled}get tfliteCaptureDelay(){return t(this,Ph,"f").captureDelay}get setTfliteCaptureDelay(){return t(this,Ph,"f").setCaptureDelay}get tfliteThreshold(){return t(this,Ph,"f").threshold}get setTfliteThreshold(){return t(this,Ph,"f").setThreshold}get canUpdateFirmware(){return t(this,dh,"f")?.canUpdateFirmware}get uploadFirmware(){return t(this,hh,"m",qh).call(this),t(this,Vh,"f").uploadFirmware}get canReset(){return this.canUpdateFirmware}async reset(){return el.assertWithError(this.canReset,"reset is not enabled for this device"),await t(this,Vh,"f").reset(),t(this,dh,"f").disconnect()}get firmwareStatus(){return t(this,Vh,"f").status}get getFirmwareImages(){return t(this,hh,"m",qh).call(this),t(this,Vh,"f").getImages}get firmwareImages(){return t(this,Vh,"f").images}get eraseFirmwareImage(){return t(this,hh,"m",qh).call(this),t(this,Vh,"f").eraseImage}get confirmFirmwareImage(){return t(this,hh,"m",qh).call(this),t(this,Vh,"f").confirmImage}get testFirmwareImage(){return t(this,hh,"m",qh).call(this),t(this,Vh,"f").testImage}get isServerSide(){return t(this,jh,"f")}set isServerSide(e){t(this,jh,"f")!=e?(el.log({newIsServerSide:e}),s(this,jh,e,"f"),t(this,Nh,"f").isServerSide=this.isServerSide):el.log("redundant isServerSide assignment")}get isUkaton(){return this.deviceInformation.modelNumber.includes("Ukaton")}get isWifiAvailable(){return t(this,Gh,"f").isWifiAvailable}get wifiSSID(){return t(this,Gh,"f").wifiSSID}async setWifiSSID(e){return t(this,Gh,"f").setWifiSSID(e)}get wifiPassword(){return t(this,Gh,"f").wifiPassword}async setWifiPassword(e){return t(this,Gh,"f").setWifiPassword(e)}get isWifiConnected(){return t(this,Gh,"f").isWifiConnected}get ipAddress(){return t(this,Gh,"f").ipAddress}get wifiConnectionEnabled(){return t(this,Gh,"f").wifiConnectionEnabled}get enableWifiConnection(){return t(this,Gh,"f").enableWifiConnection}get setWifiConnectionEnabled(){return t(this,Gh,"f").setWifiConnectionEnabled}get disableWifiConnection(){return t(this,Gh,"f").disableWifiConnection}get toggleWifiConnection(){return t(this,Gh,"f").toggleWifiConnection}get isWifiSecure(){return t(this,Gh,"f").isWifiSecure}async reconnectViaWebSockets(){el.assertWithError(this.isWifiConnected,"wifi is not connected"),el.assertWithError("webSocket"!=this.connectionType,"already connected via webSockets"),el.assertTypeWithError(this.ipAddress,"string"),el.log("reconnecting via websockets..."),await this.disconnect(),await this.connect({type:"webSocket",ipAddress:this.ipAddress,isWifiSecure:this.isWifiSecure})}async reconnectViaUDP(){el.assertWithError(a,"udp is only available in node"),el.assertWithError(this.isWifiConnected,"wifi is not connected"),el.assertWithError("udp"!=this.connectionType,"already connected via udp"),el.assertTypeWithError(this.ipAddress,"string"),el.log("reconnecting via udp..."),await this.disconnect(),await this.connect({type:"udp",ipAddress:this.ipAddress})}get hasCamera(){return this.sensorTypes.includes("camera")}get cameraStatus(){return t(this,Hh,"f").cameraStatus}async takePicture(){t(this,hh,"m",Jh).call(this),await t(this,Hh,"f").takePicture()}async focusCamera(){t(this,hh,"m",Jh).call(this),await t(this,Hh,"f").focus()}async stopCamera(){t(this,hh,"m",Jh).call(this),await t(this,Hh,"f").stop()}async wakeCamera(){t(this,hh,"m",Jh).call(this),await t(this,Hh,"f").wake()}async sleepCamera(){t(this,hh,"m",Jh).call(this),await t(this,Hh,"f").sleep()}get cameraConfiguration(){return t(this,Hh,"f").cameraConfiguration}get availableCameraConfigurationTypes(){return t(this,Hh,"f").availableCameraConfigurationTypes}get cameraConfigurationRanges(){return t(this,Hh,"f").cameraConfigurationRanges}get setCameraConfiguration(){return t(this,Hh,"f").setCameraConfiguration}get hasMicrophone(){return this.sensorTypes.includes("microphone")}get microphoneStatus(){return t(this,Kh,"f").microphoneStatus}async startMicrophone(){t(this,hh,"m",Qh).call(this),await t(this,Kh,"f").start()}async stopMicrophone(){t(this,hh,"m",Qh).call(this),await t(this,Kh,"f").stop()}async enableMicrophoneVad(){t(this,hh,"m",Qh).call(this),await t(this,Kh,"f").vad()}async toggleMicrophone(){t(this,hh,"m",Qh).call(this),await t(this,Kh,"f").toggle()}get microphoneConfiguration(){return t(this,Kh,"f").microphoneConfiguration}get availableMicrophoneConfigurationTypes(){return t(this,Kh,"f").availableMicrophoneConfigurationTypes}get setMicrophoneConfiguration(){return t(this,Kh,"f").setMicrophoneConfiguration}get audioContext(){return t(this,hh,"m",Zh).call(this),t(this,Kh,"f").audioContext}set audioContext(e){t(this,hh,"m",Zh).call(this),t(this,Kh,"f").audioContext=e}get microphoneMediaStreamDestination(){return t(this,hh,"m",Zh).call(this),t(this,Kh,"f").mediaStreamDestination}get microphoneGainNode(){return t(this,hh,"m",Zh).call(this),t(this,Kh,"f").gainNode}get isRecordingMicrophone(){return t(this,Kh,"f").isRecording}startRecordingMicrophone(){t(this,hh,"m",Zh).call(this),t(this,Kh,"f").startRecording()}stopRecordingMicrophone(){t(this,hh,"m",Zh).call(this),t(this,Kh,"f").stopRecording()}toggleMicrophoneRecording(){t(this,hh,"m",Zh).call(this),t(this,Kh,"f").toggleRecording()}get isDisplayAvailable(){return t(this,Xh,"f").isDisplayAvailable}get displayStatus(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").displayStatus}get displayBrightness(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").displayBrightness}get setDisplayBrightness(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").setDisplayBrightness}get displayInformation(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").displayInformation}get numberOfDisplayColors(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").numberOfColors}get wakeDisplay(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").wake}get sleepDisplay(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").sleep}get toggleDisplay(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").toggle}get isDisplayAwake(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").isDisplayAwake}get showDisplay(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").showDisplay}get clearDisplay(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").clearDisplay}get setDisplayColor(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").setColor}get setDisplayColorOpacity(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").setColorOpacity}get setDisplayOpacity(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").setOpacity}get saveDisplayContext(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").saveContext}get restoreDisplayContext(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").restoreContext}get clearDisplayRect(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").clearRect}get selectDisplayFillColor(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").selectFillColor}get selectDisplayLineColor(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").selectLineColor}get setDisplayLineWidth(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").setLineWidth}get drawDisplayRect(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").drawRect}get drawDisplayCircle(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").drawCircle}get drawDisplayEllipse(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").drawEllipse}get drawDisplayRoundRect(){return t(this,hh,"m",Yh).call(this),t(this,Xh,"f").drawRoundRect}}var nl,al,rl,ol,cl,hl;lh=il,gh=new WeakMap,dh=new WeakMap,mh=new WeakMap,Eh=new WeakMap,Mh=new WeakMap,Lh=new WeakMap,_h=new WeakMap,Fh=new WeakMap,$h=new WeakMap,Oh=new WeakMap,Bh=new WeakMap,Nh=new WeakMap,Ph=new WeakMap,Vh=new WeakMap,jh=new WeakMap,Gh=new WeakMap,Hh=new WeakMap,Kh=new WeakMap,Xh=new WeakMap,hh=new WeakSet,fh=function(){return new wo},uh=function(){return t(this,gh,"f").dispatchEvent},ph=async function(e,s){await(t(this,dh,"f")?.sendTxMessages(e,s))},vh=function(){el.assertWithError(this.isConnected,"notConnected")},wh=function(e){return e.every((e=>{const t=this.latestConnectionMessages.has(e);return t||el.log(`didn't receive "${e}" message`),t}))},yh=function(){let e=t(this,hh,"m",wh).call(this,sl);return e&&this.sensorTypes.includes("pressure")&&(e=t(this,hh,"m",wh).call(this,Js)),e&&this.isWifiAvailable&&(e=t(this,hh,"m",wh).call(this,Da)),e&&this.fileTypes.length>0&&(e=t(this,hh,"m",wh).call(this,qe)),e&&this.fileTypes.includes("tflite")&&(e=t(this,hh,"m",wh).call(this,Ji)),e&&this.hasCamera&&(e=t(this,hh,"m",wh).call(this,ns)),e&&this.hasMicrophone&&(e=t(this,hh,"m",wh).call(this,Ns)),e&&this.isDisplayAvailable&&(e=t(this,hh,"m",wh).call(this,mr)),e},bh=function(){el.log("requesting required information");const e=sl.map((e=>({type:e})));t(this,hh,"m",ph).call(this,e)},Sh=function(){el.assertWithError(this.canReconnect,"cannot reconnect to device")},Dh=function(e){el.log({connectionStatus:e}),"notConnected"==e?(t(this,hh,"m",Ih).call(this),this.canReconnect&&this.reconnectOnDisconnection&&(el.log("starting reconnect interval..."),s(this,Mh,setInterval((()=>{el.log("attempting reconnect..."),this.reconnect()}),1e3),"f"))):null!=t(this,Mh,"f")&&(el.log("clearing reconnect interval"),clearInterval(t(this,Mh,"f")),s(this,Mh,void 0,"f")),t(this,hh,"m",Wh).call(this),"connected"!=e||t(this,mh,"f")||"client"!=this.connectionType&&t(this,hh,"m",bh).call(this),Lc.OnDeviceConnectionStatusUpdated(this,e)},kh=function(e=!1){t(this,hh,"a",uh).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),t(this,hh,"a",uh).call(this,this.connectionStatus,{}),e&&t(this,hh,"a",uh).call(this,"isConnected",{isConnected:this.isConnected})},Wh=function(){switch(s(this,mh,Boolean(this.connectionManager?.isConnected)&&t(this,hh,"a",yh)&&this._informationManager.isCurrentTimeSet,"f"),this.connectionStatus){case"connected":t(this,mh,"f")&&t(this,hh,"m",kh).call(this,!0);break;case"notConnected":t(this,hh,"m",kh).call(this,!0);break;default:t(this,hh,"m",kh).call(this,!1)}},Th=function(){t(this,hh,"m",Ih).call(this),this._informationManager.clear(),t(this,Lh,"f").clear(),t(this,Ph,"f").clear(),t(this,Gh,"f").clear(),t(this,Hh,"f").clear(),t(this,Kh,"f").clear(),t(this,Xh,"f").clear()},Ih=function(){this.connectionManager?.clear(),this.latestConnectionMessages.clear()},Rh=function(e,s){if(el.log({messageType:e,dataView:s}),"batteryLevel"===e){const e=s.getUint8(0);el.log("received battery level",{batteryLevel:e}),t(this,hh,"m",Ah).call(this,e)}else if(Oe.includes(e))t(this,Nh,"f").parseMessage(e,s);else if(Gi.includes(e))t(this,Ph,"f").parseMessage(e,s);else if(Hs.includes(e))t(this,Oh,"f").parseMessage(e,s);else if(oc.includes(e))t(this,Vh,"f").parseMessage(e,s);else if(an.includes(e))t(this,Lh,"f").parseMessage(e,s);else if(In.includes(e))this._informationManager.parseMessage(e,s);else if(fi.includes(e))t(this,Fh,"f").parseMessage(e,s);else if(ta.includes(e))t(this,Bh,"f").parseMessage(e,s);else if(Ma.includes(e))t(this,Gh,"f").parseMessage(e,s);else if(is.includes(e))t(this,Hh,"f").parseMessage(e,s);else if(Os.includes(e))t(this,Kh,"f").parseMessage(e,s);else{if(!ur.includes(e))throw Error(`uncaught messageType ${e}`);t(this,Xh,"f").parseMessage(e,s)}this.latestConnectionMessages.set(e,s),e.startsWith("set")&&this.latestConnectionMessages.set(e.replace("set","get"),s),t(this,hh,"a",uh).call(this,"connectionMessage",{messageType:e,dataView:s})},Uh=function(){!this.isConnected&&t(this,hh,"a",yh)&&t(this,hh,"m",Wh).call(this),"notConnected"!=this.connectionStatus&&t(this,hh,"m",ph).call(this)},Ah=function(e){el.assertTypeWithError(e,"number"),t(this,_h,"f")!=e?(s(this,_h,e,"f"),el.log({updatedBatteryLevel:t(this,_h,"f")}),t(this,hh,"a",uh).call(this,"batteryLevel",{batteryLevel:t(this,_h,"f")})):el.log(`duplicate batteryLevel assignment ${e}`)},qh=function(){el.assertWithError(this.canUpdateFirmware,"can't update firmware")},zh=function(e){return t(this,hh,"m",qh).call(this),t(this,dh,"f").sendSmpMessage(e)},Jh=function(){el.assertWithError(this.hasCamera,"camera not available")},Qh=function(){el.assertWithError(this.hasMicrophone,"microphone not available")},Zh=function(){el.assertWithError(AudioContext,"WebAudio is not supported")},Yh=function(){el.assertWithError(this.isDisplayAvailable,"display not available")},Ch={value:!1},xh={value:!0};const ll=T("DevicePairPressureSensorDataManager",{log:!1});class fl{constructor(){nl.add(this),al.set(this,{}),rl.set(this,new at),ol.set(this,new Ye),this.resetPressureRange()}resetPressureRange(){t(this,rl,"f").reset(),t(this,ol,"f").reset()}onDevicePressureData(e){const{pressure:s}=e.message,{side:i}=e.target;if(ll.log({pressure:s,side:i}),t(this,al,"f")[i]=s,t(this,nl,"a",cl))return t(this,nl,"m",hl).call(this);ll.log("doesn't have all pressure data yet...")}}var gl;al=new WeakMap,rl=new WeakMap,ol=new WeakMap,nl=new WeakSet,cl=function(){return Tn.every((e=>e in t(this,al,"f")))},hl=function(){const e={scaledSum:0,normalizedSum:0,sensors:{left:[],right:[]}};return Tn.forEach((s=>{const i=t(this,al,"f")[s];e.scaledSum+=i.scaledSum})),e.normalizedSum+=t(this,ol,"f").updateAndGetNormalization(e.scaledSum,!1),e.scaledSum>0&&(e.center={x:0,y:0},Tn.forEach((s=>{t(this,al,"f")[s].sensors.forEach((t=>{const i={...t};i.weightedValue=t.scaledValue/e.scaledSum;let{x:n,y:a}=t.position;n/=2,"right"==s&&(n+=.5),i.position={x:n,y:a},e.center.x+=i.position.x*i.weightedValue,e.center.y+=i.position.y*i.weightedValue,e.sensors[s].push(i)}))})),e.normalizedCenter=t(this,rl,"f").updateAndGetNormalization(e.center,!1)),ll.log({devicePairPressure:e}),e};const ul=T("DevicePairSensorDataManager",{log:!1}),dl=["pressure","sensorData"];class pl{constructor(){gl.set(this,{}),this.pressureSensorDataManager=new fl}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}resetPressureRange(){this.pressureSensorDataManager.resetPressureRange()}onDeviceSensorData(e){const{timestamp:s,sensorType:i}=e.message;let n;if(ul.log({sensorType:i,timestamp:s,event:e}),t(this,gl,"f")[i]||(t(this,gl,"f")[i]={}),t(this,gl,"f")[i][e.target.side]=s,"pressure"===i)n=this.pressureSensorDataManager.onDevicePressureData(e);else ul.log(`uncaught sensorType "${i}"`);if(n){const e=Object.assign({},t(this,gl,"f")[i]);this.dispatchEvent(i,{sensorType:i,timestamps:e,[i]:n}),this.dispatchEvent("sensorData",{sensorType:i,timestamps:e,[i]:n})}else ul.log("no value received")}}var ml,vl,wl,yl,bl,Sl,Cl,El,Ml,Dl,kl,Wl,Tl,Il,Rl,Ul,Ll,_l,Al;gl=new WeakMap;const Fl=T("DevicePair",{log:!1});function xl(e){return`device${t=e,t[0].toUpperCase()+t.slice(1)}`;var t}const $l=["isConnected",...dl,...tl.map((e=>xl(e)))];class Ol{constructor(e){ml.add(this),wl.set(this,void 0),yl.set(this,new R(this,$l)),Sl.set(this,void 0),Cl.set(this,void 0),Wl.set(this,{isConnected:t(this,ml,"m",Il).bind(this),sensorData:t(this,ml,"m",Ll).bind(this),getType:t(this,ml,"m",Rl).bind(this)}),Ul.set(this,new pl),s(this,wl,e,"f"),t(this,Ul,"f").eventDispatcher=t(this,yl,"f")}get sides(){return Tn}get type(){return t(this,wl,"f")}get addEventListener(){return t(this,yl,"f").addEventListener}get removeEventListener(){return t(this,yl,"f").removeEventListener}get waitForEvent(){return t(this,yl,"f").waitForEvent}get removeEventListeners(){return t(this,yl,"f").removeEventListeners}get removeAllEventListeners(){return t(this,yl,"f").removeAllEventListeners}get left(){return t(this,Sl,"f")}get right(){return t(this,Cl,"f")}get isConnected(){return Tn.every((e=>this[e]?.isConnected))}get isPartiallyConnected(){return Tn.some((e=>this[e]?.isConnected))}get isHalfConnected(){return this.isPartiallyConnected&&!this.isConnected}assignDevice(e){if(!t(this,ml,"m",El).call(this,e))return void Fl.log(`device is incorrect type ${e.type} for ${this.type} devicePair`);const i=e.side,n=this[i];if(e!=n){switch(n&&t(this,ml,"m",Dl).call(this,n),t(this,ml,"m",Ml).call(this,e),i){case"left":s(this,Sl,e,"f");break;case"right":s(this,Cl,e,"f")}return Fl.log(`assigned ${i} ${this.type} device`,e),this.resetPressureRange(),t(this,ml,"a",bl).call(this,"isConnected",{isConnected:this.isConnected}),t(this,ml,"a",bl).call(this,"deviceIsConnected",{device:e,isConnected:e.isConnected,side:i}),n}Fl.log("device already assigned")}async setSensorConfiguration(e){for(let t=0;t<Tn.length;t++){const s=Tn[t];this[s]?.isConnected&&await this[s].setSensorConfiguration(e)}}resetPressureRange(){Tn.forEach((e=>this[e]?.resetPressureRange())),t(this,Ul,"f").resetPressureRange()}async triggerVibration(e,t){const s=Tn.map((s=>this[s]?.triggerVibration(e,t))).filter(Boolean);return Promise.allSettled(s)}static get insoles(){return t(this,vl,"f",_l)}static get gloves(){return t(this,vl,"f",Al)}}var Bl,Nl,Pl,Vl,ql;vl=Ol,wl=new WeakMap,yl=new WeakMap,Sl=new WeakMap,Cl=new WeakMap,Wl=new WeakMap,Ul=new WeakMap,ml=new WeakSet,bl=function(){return t(this,yl,"f").dispatchEvent},El=function(e){switch(this.type){case"insoles":return e.isInsole;case"gloves":return e.isGlove}},Ml=function(e){Pr(e,t(this,Wl,"f")),tl.forEach((s=>{e.addEventListener(s,t(this,ml,"m",Tl).bind(this))}))},Dl=function(e){Vr(e,t(this,Wl,"f")),tl.forEach((s=>{e.removeEventListener(s,t(this,ml,"m",Tl).bind(this))}))},kl=function(e){const i=Tn.some((i=>{if(this[i]!=e)return!1;switch(Fl.log(`removing ${i} ${this.type} device`,e),Vr(e,t(this,Wl,"f")),i){case"left":s(this,Sl,void 0,"f");break;case"right":s(this,Cl,void 0,"f")}return!0}));return i&&t(this,ml,"a",bl).call(this,"isConnected",{isConnected:this.isConnected}),i},Tl=function(e){const{type:s,target:i,message:n}=e;t(this,ml,"a",bl).call(this,xl(s),{...n,device:i,side:i.side})},Il=function(e){t(this,ml,"a",bl).call(this,"isConnected",{isConnected:this.isConnected})},Rl=function(e){const{target:s}=e;if(this[s.side]==s)return;t(this,ml,"m",kl).call(this,s)&&this.assignDevice(s)},Ll=function(e){this.isConnected&&t(this,Ul,"f").onDeviceSensorData(e)},_l={value:new vl("insoles")},Al={value:new vl("gloves")},Lc.AddEventListener("deviceConnected",(e=>{const{device:s}=e.message;s.isInsole&&t(vl,vl,"f",_l).assignDevice(s),s.isGlove&&t(vl,vl,"f",Al).assignDevice(s)}));const zl=T("ClientConnectionManager",{log:!1});class jl extends Br{constructor(){super(...arguments),Bl.add(this),Nl.set(this,void 0),Pl.set(this,!1)}static get isSupported(){return n}static get type(){return"client"}get canUpdateFirmware(){return!1}get bluetoothId(){return t(this,Nl,"f")}set bluetoothId(e){zl.assertTypeWithError(e,"string"),t(this,Nl,"f")!=e?s(this,Nl,e,"f"):zl.log("redundant bluetoothId assignment")}get isConnected(){return t(this,Pl,"f")}set isConnected(e){zl.assertTypeWithError(e,"boolean"),t(this,Pl,"f")!=e?(s(this,Pl,e,"f"),this.status=t(this,Pl,"f")?"connected":"notConnected",this.isConnected&&t(this,Bl,"m",Vl).call(this)):zl.log("redundant newIsConnected assignment",e)}get isAvailable(){return this.client.isConnected}async connect(){await super.connect(),this.sendClientConnectMessage(this.subType)}async disconnect(){await super.disconnect(),this.sendClientDisconnectMessage()}get canReconnect(){return!0}async reconnect(){await super.reconnect(),this.sendClientConnectMessage()}async sendSmpMessage(e){super.sendSmpMessage(e),this.sendClientMessage({type:"smp",data:e})}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&this.sendClientMessage({type:"tx",data:e})}onClientMessage(e){zl.log({dataView:e}),Ct(e,tl,t(this,Bl,"m",ql).bind(this),null,!0),this.onMessagesReceived()}}var Gl,Hl,Jl,Kl,Ql,Zl,Xl,Yl,ef,tf,sf,nf,af,rf,of,cf,hf,lf,ff,gf,uf,df,pf,mf;Nl=new WeakMap,Pl=new WeakMap,Bl=new WeakSet,Vl=function(){this.sendRequiredDeviceInformationMessage()},ql=function(e,t){let s=0;switch(zl.log({messageType:e},t),e){case"isConnected":const i=Boolean(t.getUint8(s++));zl.log({isConnected:i}),this.isConnected=i;break;case"rx":this.parseRxMessage(t);break;default:this.onMessageReceived(e,t)}};const vf=T("BaseClient",{log:!1}),wf=["notConnected","connecting","connected","disconnecting","connectionStatus","isConnected","isScanningAvailable","isScanning","discoveredDevice","expiredDiscoveredDevice"];class yf{constructor(){Gl.add(this),Kl.set(this,{}),Ql.set(this,new R(this,wf)),this._reconnectOnDisconnection=this.baseConstructor.ReconnectOnDisconnection,Zl.set(this,"notConnected"),ef.set(this,[]),nf.set(this,!1),cf.set(this,!1),df.set(this,{})}get baseConstructor(){return this.constructor}get devices(){return t(this,Kl,"f")}get addEventListener(){return t(this,Ql,"f").addEventListener}get dispatchEvent(){return t(this,Ql,"f").dispatchEvent}get removeEventListener(){return t(this,Ql,"f").removeEventListener}get waitForEvent(){return t(this,Ql,"f").waitForEvent}assertConnection(){vf.assertWithError(this.isConnected,"notConnected")}assertDisconnection(){vf.assertWithError(this.isDisconnected,"not disconnected")}static get ReconnectOnDisconnection(){return this._reconnectOnDisconnection}static set ReconnectOnDisconnection(e){vf.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get reconnectOnDisconnection(){return this._reconnectOnDisconnection}set reconnectOnDisconnection(e){vf.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get _connectionStatus(){return t(this,Zl,"f")}set _connectionStatus(e){switch(vf.assertTypeWithError(e,"string"),vf.log({newConnectionStatus:e}),s(this,Zl,e,"f"),this.dispatchEvent("connectionStatus",{connectionStatus:this.connectionStatus}),this.dispatchEvent(this.connectionStatus,{}),e){case"connected":case"notConnected":this.dispatchEvent("isConnected",{isConnected:this.isConnected}),this.isConnected||t(this,Gl,"m",Jl).call(this)}}get connectionStatus(){return this._connectionStatus}_sendRequiredMessages(){vf.log("sending required messages",t(this,ef,"f")),this.sendServerMessage(...t(this,Gl,"a",Yl))}parseMessage(e){vf.log("parseMessage",{dataView:e}),Ct(e,Ac,t(this,Gl,"m",sf).bind(this),null,!0),t(this,Gl,"m",tf).call(this)}get isScanningAvailable(){return t(this,Gl,"a",af)}requestIsScanningAvailable(){this.sendServerMessage("isScanningAvailable")}get isScanning(){return t(this,Gl,"a",hf)}startScan(){t(this,Gl,"m",uf).call(this),this.sendServerMessage("startScan")}stopScan(){t(this,Gl,"m",gf).call(this),this.sendServerMessage("stopScan")}toggleScan(){t(this,Gl,"m",of).call(this),this.isScanning?this.stopScan():this.startScan()}get discoveredDevices(){return t(this,df,"f")}onDiscoveredDevice(e){vf.log({discoveredDevice:e}),t(this,df,"f")[e.bluetoothId]=e,this.dispatchEvent("discoveredDevice",{discoveredDevice:e})}requestDiscoveredDevices(){this.sendServerMessage({type:"discoveredDevices"})}connectToDevice(e,t){return this.requestConnectionToDevice(e,t)}requestConnectionToDevice(e,s){this.assertConnection(),vf.assertTypeWithError(e,"string");const i=t(this,Gl,"m",mf).call(this,e);return s?i.connect({type:"client",subType:s}):i.connect(),i}sendConnectToDeviceMessage(e,t){t?this.sendServerMessage({type:"connectToDevice",data:z(j(e),Lr.indexOf(t))}):this.sendServerMessage({type:"connectToDevice",data:e})}createDevice(e){const s=new il,i=t(this,df,"f")[e],n=new jl;return n.discoveredDevice=Object.assign({},i),n.client=this,n.bluetoothId=e,n.sendClientMessage=this.sendDeviceMessage.bind(this,e),n.sendRequiredDeviceInformationMessage=this.sendRequiredDeviceInformationMessage.bind(this,e),n.sendClientConnectMessage=this.sendConnectToDeviceMessage.bind(this,e),n.sendClientDisconnectMessage=this.sendDisconnectFromDeviceMessage.bind(this,e),s.connectionManager=n,s}onConnectedBluetoothDeviceIds(e){vf.log({bluetoothIds:e}),e.forEach((e=>{const s=t(this,Gl,"m",mf).call(this,e);s.connectionManager.isConnected=!0,Lc._CheckDeviceAvailability(s)}))}disconnectFromDevice(e){this.requestDisconnectionFromDevice(e)}requestDisconnectionFromDevice(e){this.assertConnection(),vf.assertTypeWithError(e,"string");const t=this.devices[e];return vf.assertWithError(t,`no device found with id ${e}`),t.disconnect(),t}sendDisconnectFromDeviceMessage(e){this.sendServerMessage({type:"disconnectFromDevice",data:e})}sendDeviceMessage(e,...t){this.sendServerMessage({type:"deviceMessage",data:[e,$c(...t)]})}sendRequiredDeviceInformationMessage(e){this.sendServerMessage({type:"requiredDeviceInformation",data:[e]})}}var bf,Sf,Cf,Ef,Mf,Df,kf,Wf,Tf,If,Rf,Uf,Lf;Hl=yf,Kl=new WeakMap,Ql=new WeakMap,Zl=new WeakMap,ef=new WeakMap,nf=new WeakMap,cf=new WeakMap,df=new WeakMap,Gl=new WeakSet,Jl=function(){s(this,Gl,!1,"a",rf),s(this,Gl,!1,"a",lf);for(const e in t(this,Kl,"f")){t(this,Kl,"f")[e].connectionManager.isConnected=!1}t(this,ef,"f").length=0},Yl=function(){return t(Hl,Hl,"f",Xl)},tf=function(){"connecting"==this.connectionStatus&&(vf.log("checking if fully connected..."),t(this,ef,"f").includes("isScanningAvailable")?!this.isScanningAvailable||t(this,ef,"f").includes("isScanning")?(vf.log("fully connected"),this._connectionStatus="connected"):vf.log("not fully connected - didn't receive isScanning"):vf.log("not fully connected - didn't receive isScanningAvailable"))},sf=function(e,i){let n=0;switch(vf.log({messageType:e},i),e){case"isScanningAvailable":{const e=Boolean(i.getUint8(n++));vf.log({isScanningAvailable:e}),s(this,Gl,e,"a",rf)}break;case"isScanning":{const e=Boolean(i.getUint8(n++));vf.log({isScanning:e}),s(this,Gl,e,"a",lf)}break;case"discoveredDevice":{const{string:e}=St(i,n);vf.log({discoveredDeviceString:e});const t=JSON.parse(e);vf.log({discoveredDevice:t}),this.onDiscoveredDevice(t)}break;case"expiredDiscoveredDevice":{const{string:e}=St(i,n);t(this,Gl,"m",pf).call(this,e)}break;case"connectedDevices":{if(0==i.byteLength)break;const{string:e}=St(i,n);vf.log({connectedBluetoothDeviceIdStrings:e});const t=JSON.parse(e).connectedDevices;vf.log({connectedBluetoothDeviceIds:t}),this.onConnectedBluetoothDeviceIds(t)}break;case"deviceMessage":{const{string:e,byteOffset:s}=St(i,n);n=s;const a=t(this,Kl,"f")[e];vf.assertWithError(a,`no device found for id ${e}`);const r=a.connectionManager,o=G(i,n);r.onClientMessage(o)}break;default:vf.error(`uncaught messageType "${e}"`)}"connecting"==this.connectionStatus&&t(this,ef,"f").push(e)},af=function(){return t(this,nf,"f")},rf=function(e){vf.assertTypeWithError(e,"boolean"),s(this,nf,e,"f"),this.dispatchEvent("isScanningAvailable",{isScanningAvailable:this.isScanningAvailable}),this.isScanningAvailable&&t(this,Gl,"m",ff).call(this)},of=function(){this.assertConnection(),vf.assertWithError(this.isScanningAvailable,"scanning is not available")},hf=function(){return t(this,cf,"f")},lf=function(e){vf.assertTypeWithError(e,"boolean"),s(this,cf,e,"f"),this.dispatchEvent("isScanning",{isScanning:this.isScanning})},ff=function(){this.sendServerMessage("isScanning")},gf=function(){vf.assertWithError(this.isScanning,"is not scanning")},uf=function(){vf.assertWithError(!this.isScanning,"is already scanning")},pf=function(e){vf.log({expiredBluetoothDeviceId:e});const s=t(this,df,"f")[e];s?(vf.log({expiredDiscoveredDevice:s}),delete t(this,df,"f")[e],this.dispatchEvent("expiredDiscoveredDevice",{discoveredDevice:s})):vf.warn(`no discoveredDevice found with id "${e}"`)},mf=function(e){let s=t(this,Kl,"f")[e];return s||(s=this.createDevice(e),t(this,Kl,"f")[e]=s),s},yf._reconnectOnDisconnection=!0,Xl={value:["isScanningAvailable","discoveredDevices","connectedDevices"]};const _f=T("WebSocketClient",{log:!1});Sf=new WeakMap,Ef=new WeakMap,Rf=new WeakMap,bf=new WeakSet,Cf=function(...e){this.sendMessage(Nc(...e))},Mf=function(e){_f.log("webSocket.open",e),t(this,Rf,"f").start(),this._sendRequiredMessages()},Df=async function(e){_f.log("webSocket.message",e);const s=await e.data.arrayBuffer(),i=new DataView(s);t(this,bf,"m",Tf).call(this,i)},kf=function(e){_f.log("webSocket.close",e),this._connectionStatus="notConnected",Object.entries(this.devices).forEach((([e,t])=>{t.connectionManager.isConnected=!1})),t(this,Rf,"f").stop(),this.reconnectOnDisconnection&&setTimeout((()=>{this.reconnect()}),3e3)},Wf=function(e){_f.error("webSocket.error",e)},Tf=function(e){Ct(e,Bc,t(this,bf,"m",If).bind(this),null,!0)},If=function(e,s){switch(e){case"ping":t(this,bf,"m",Lf).call(this);break;case"pong":break;case"serverMessage":this.parseMessage(s);break;default:_f.error(`uncaught messageType "${e}"`)}},Uf=function(){t(this,bf,"m",Cf).call(this,"ping")},Lf=function(){t(this,bf,"m",Cf).call(this,"pong")};const Af={addEventListeners:Pr,removeEventListeners:Vr},Ff={throttle:function(e,t,s=!1){let i=0,n=null,a=null;return function(...r){const o=Date.now(),c=t-(o-i);c<=0?(n&&(clearTimeout(n),n=null),i=o,e(...r)):s&&(a=r,n||(n=setTimeout((()=>{i=Date.now(),n=null,a&&(e(...a),a=null)}),c)))}},debounce:function(e,t,s=!1){let i=null;return function(...n){const a=s&&!i;i&&clearTimeout(i),i=setTimeout((()=>{i=null,s||e(...n)}),t),a&&e(...n)}}};e.CameraCommands=Yt,e.CameraConfigurationTypes=ss,e.ContinuousSensorTypes=Gs,e.DefaultNumberOfPressureSensors=8,e.Device=il,e.DeviceManager=Lc,e.DevicePair=Ol,e.DevicePairTypes=["insoles","gloves"],e.DeviceTypes=Wn,e.DisplayBrightnesses=gr,e.Environment=y,e.EventUtils=Af,e.FileTransferDirections=["sending","receiving"],e.FileTypes=Be,e.MaxNameLength=30,e.MaxNumberOfVibrationWaveformEffectSegments=8,e.MaxNumberOfVibrationWaveformSegments=20,e.MaxSensorRate=65535,e.MaxVibrationWaveformEffectSegmentDelay=na,e.MaxVibrationWaveformEffectSegmentLoopCount=3,e.MaxVibrationWaveformEffectSequenceLoopCount=6,e.MaxVibrationWaveformSegmentDuration=ia,e.MaxWifiPasswordLength=64,e.MaxWifiSSIDLength=32,e.MicrophoneCommands=As,e.MicrophoneConfigurationTypes=xs,e.MicrophoneConfigurationValues=Bs,e.MinNameLength=2,e.MinWifiPasswordLength=8,e.MinWifiSSIDLength=1,e.RangeHelper=Ye,e.SensorRateStep=5,e.SensorTypes=js,e.Sides=Tn,e.TfliteSensorTypes=Qi,e.TfliteTasks=Ki,e.ThrottleUtils=Ff,e.VibrationLocations=Yn,e.VibrationTypes=ea,e.VibrationWaveformEffects=Ln,e.WebSocketClient=class extends yf{constructor(){super(...arguments),bf.add(this),Sf.set(this,void 0),Ef.set(this,{open:t(this,bf,"m",Mf).bind(this),message:t(this,bf,"m",Df).bind(this),close:t(this,bf,"m",kf).bind(this),error:t(this,bf,"m",Wf).bind(this)}),Rf.set(this,new F(t(this,bf,"m",Uf).bind(this),3e4))}get webSocket(){return t(this,Sf,"f")}set webSocket(e){t(this,Sf,"f")!=e?(_f.log("assigning webSocket",e),t(this,Sf,"f")&&Vr(t(this,Sf,"f"),t(this,Ef,"f")),Pr(e,t(this,Ef,"f")),s(this,Sf,e,"f"),_f.log("assigned webSocket")):_f.log("redundant webSocket assignment")}get readyState(){return this.webSocket?.readyState}get isConnected(){return this.readyState==WebSocket.OPEN}get isDisconnected(){return this.readyState==WebSocket.CLOSED}connect(e=`wss://${location.host}`){this.webSocket&&this.assertDisconnection(),this._connectionStatus="connecting",this.webSocket=new WebSocket(e)}disconnect(){this.assertConnection(),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.webSocket.addEventListener("close",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this._connectionStatus="disconnecting",this.webSocket.close()}reconnect(){this.assertDisconnection(),this.connect(this.webSocket.url)}toggleConnection(e){this.isConnected?this.disconnect():e&&this.webSocket?.url==e?this.reconnect():this.connect(e)}sendMessage(e){this.assertConnection(),t(this,Sf,"f").send(e),t(this,Rf,"f").restart()}sendServerMessage(...e){this.sendMessage(Nc({type:"serverMessage",data:xc(...e)}))}},e.setAllConsoleLevelFlags=function(e){W.setAllLevelFlags(e)},e.setConsoleLevelFlagsForType=function(e,t){W.setLevelFlagsForType(e,t)}}));
//# sourceMappingURL=brilliantsole.min.js.map
