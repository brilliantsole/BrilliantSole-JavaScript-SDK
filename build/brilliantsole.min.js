/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).BS={})}(this,(function(e){"use strict";function t(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)}function i(e,t,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?n.call(e,i):n?n.value=i:t.set(e,i),i}"function"==typeof SuppressedError&&SuppressedError;const s=!1,n="undefined"!=typeof window&&void 0!==window?.document,a="undefined"!=typeof process&&null!=process?.versions?.node,r=n&&navigator.userAgent||"";let o=!1;n?o=Boolean(navigator.bluetooth):a&&(o=!0);const c=n&&/Bluefy/i.test(r),h=n&&/WebBLE/i.test(r),l=n&&/Android/i.test(r),f=n&&/Safari/i.test(r)&&!/Chrome/i.test(r),g=n&&/iPad|iPhone|iPod/i.test(r),u=n&&/Macintosh/i.test(r),d=!n&&!a&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var m,p,v,w,y=Object.freeze({__proto__:null,isAndroid:l,get isBluetoothSupported(){return o},isIOS:g,isInBluefy:c,isInBrowser:n,isInDev:s,isInLensStudio:d,isInNode:a,isInProduction:!0,isInWebBLE:h,isMac:u,isSafari:f});if(d){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(w={}).log=e,w.warn=e.bind(w,"WARNING"),w.error=e.bind(w,"ERROR")}else w=console;function b(e){return(...t)=>{if(a){const i=function(){const e=(new Error).stack;if(!e)return"";const t=e.split("\n"),i=t[3]||t[2],s=i.match(/at (.*?) \(/)||i.match(/at (.*)/);return s?`[${s[1].trim()}]`:""}();e(i,...t)}else e(...t)}}if(!w.assert){const e=(e,...t)=>{e||w.warn(...t)};w.assert=e}if(!w.table){const e=(...e)=>{w.log(...e)};w.table=e}function S(){}const C=a?b(w.log.bind(w)):w.log.bind(w),M=a?b(w.warn.bind(w)):w.warn.bind(w),E=a?b(w.error.bind(w)):w.error.bind(w),k=a?b(w.table.bind(w)):w.table.bind(w),D=w.assert.bind(w);class W{constructor(e){if(v.set(this,{log:s,warn:s,assert:!0,error:!0,table:!0}),t(m,m,"f",p)[e])throw new Error(`"${e}" console already exists`);t(m,m,"f",p)[e]=this}setLevelFlags(e){Object.assign(t(this,v,"f"),e)}static setLevelFlagsForType(e,i){if(!t(this,m,"f",p)[e])throw new Error(`no console found with type "${e}"`);t(this,m,"f",p)[e].setLevelFlags(i)}static setAllLevelFlags(e){for(const i in t(this,m,"f",p))t(this,m,"f",p)[i].setLevelFlags(e)}static create(e,i){return t(this,m,"f",p)[e]||new m(e)}get log(){return t(this,v,"f").log?C:S}get warn(){return t(this,v,"f").warn?M:S}get error(){return t(this,v,"f").error?E:S}get assert(){return t(this,v,"f").assert?D:S}get table(){return t(this,v,"f").table?k:S}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}assertRangeWithError(e,t,i,s){this.assertWithError(t>=i&&t<=s,`${e} ${t} must be within ${i}-${s}`)}}function T(e,t){return W.create(e,t)}m=W,v=new WeakMap,p={value:{}};const I=T("EventDispatcher",{log:!1});class _{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}updateEventListeners(e){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((t=>(t.shouldRemove&&I.log(`removing "${e}" eventListener`,t),!t.shouldRemove))))}addEventListener(e,t,i={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[],I.log(`creating "${e}" listeners array`,this.listeners[e]));this.listeners[e].find((e=>e.listener==t&&e.once==i.once))?I.log("already added listener"):(I.log(`adding "${e}" listener`,t,i),this.listeners[e].push({listener:t,once:i.once}),I.log(`currently have ${this.listeners[e].length} "${e}" listeners`))}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(I.log(`removing "${e}" listener...`,t),this.listeners[e].forEach((i=>{i.listener===t&&(I.log(`flagging "${e}" listener`,t),i.shouldRemove=!0)})),this.updateEventListeners(e))}removeEventListeners(e){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(I.log(`removing "${e}" listeners...`),this.listeners[e]=[])}removeAllEventListeners(){I.log("removing listeners..."),this.listeners={}}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e].forEach((i=>{i.shouldRemove||(I.log(`dispatching "${e}" listener`,i),i.listener({type:e,target:this.target,message:t}),i.once&&(I.log(`flagging "${e}" listener`,i),i.shouldRemove=!0))})),this.updateEventListeners(e))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var L,U,R;const F=T("Timer",{log:!1});class A{get callback(){return t(this,L,"f")}set callback(e){F.assertTypeWithError(e,"function"),F.log({newCallback:e}),i(this,L,e,"f"),this.isRunning&&this.restart()}get interval(){return t(this,U,"f")}set interval(e){F.assertTypeWithError(e,"number"),F.assertWithError(e>0,"interval must be above 0"),F.log({newInterval:e}),i(this,U,e,"f"),this.isRunning&&this.restart()}constructor(e,t){L.set(this,void 0),U.set(this,void 0),R.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=t(this,R,"f")}start(e=!1){this.isRunning?F.log("interval already running"):(F.log(`starting interval every ${t(this,U,"f")}ms`),i(this,R,setInterval(t(this,L,"f"),t(this,U,"f")),"f"),e&&t(this,L,"f").call(this))}stop(){this.isRunning?(F.log("stopping interval"),clearInterval(t(this,R,"f")),i(this,R,void 0,"f")):F.log("interval already not running")}restart(e=!1){this.stop(),this.start(e)}}function x(e){for(let t=0;t<8;++t)e=(1&e?0:3988292384)^e>>>1;return 4278190080^e}L=new WeakMap,U=new WeakMap,R=new WeakMap,T("checksum",{log:!1});const $=new Uint32Array(256);for(let e=0;e<256;++e)$[e]=x(e);function O(e){let t=new Uint8Array(e),i=0;for(let e=0;e<t.byteLength;++e){const s=255&i,n=t[e];i=($[s^n]^i>>>8)>>>0}return i}var B,N;B="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,N="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const P=new B,V=new N,q=T("ArrayBufferUtils",{log:!1});function z(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return j(e)}if(e instanceof Array){return z(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return j(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),i=new Uint8Array(t);let s=0;return e.forEach((e=>{i.set(new Uint8Array(e),s),s+=e.byteLength})),i.buffer}function j(e){const t=P.encode(e);return z(t.byteLength,t)}function G(e,t,i){let s;return null!=i&&(s=e.byteOffset+t+i),q.log({dataView:e,begin:t,end:s,length:i}),new DataView(e.buffer.slice(e.byteOffset+t,s))}async function H(e){let t;if(e instanceof Array)t=Uint8Array.from(e);else if(e instanceof DataView)t=e.buffer;else if("string"==typeof e||e instanceof URL){const i=await fetch(e);t=await i.arrayBuffer()}else if(e instanceof File)t=await e.arrayBuffer();else{if(!(e instanceof ArrayBuffer))throw{error:"invalid file type",file:e};t=e}return t}function J(e,{include:t,exclude:i}={}){const s=e=>{const s=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(s):!i||!i.some(s)};for(const[t,i]of(e=>{const t=new Set;do{for(const i of Reflect.ownKeys(e))t.add([e,i])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===i||!s(i))continue;const n=Reflect.getOwnPropertyDescriptor(t,i);n&&"function"==typeof n.value&&(e[i]=e[i].bind(e))}return e}var K,Q,Z,X,Y,ee,te,ie,se,ne,ae,re,oe,ce,he,le,fe,ge,ue,de,me,pe,ve,we,ye,be,Se,Ce,Me,Ee,ke,De,We,Te,Ie,_e,Le,Ue,Re,Fe,Ae;const xe=T("FileTransferManager",{log:!1}),$e=["getFileTypes","maxFileLength","getFileType","setFileType","getFileLength","setFileLength","getFileChecksum","setFileChecksum","setFileTransferCommand","fileTransferStatus","getFileBlock","setFileBlock","fileBytesTransferred"],Oe=["tflite","wifiServerCert","wifiServerKey"],Be=["idle","sending","receiving"],Ne=["startSend","startReceive","cancel"],Pe=[...$e,"fileTransferProgress","fileTransferComplete","fileReceived"],Ve=["maxFileLength","getFileLength","getFileChecksum","getFileType","fileTransferStatus"];class qe{constructor(){K.add(this),ie.set(this,[]),ae.set(this,Q.MaxLength),he.set(this,void 0),ue.set(this,0),ve.set(this,0),Ce.set(this,"idle"),We.set(this,[]),Ie.set(this,void 0),_e.set(this,0),Fe.set(this,!1),Ae.set(this,!1),J(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get fileTypes(){return t(this,ie,"f")}static get MaxLength(){return t(this,Q,"f",ne)}get maxLength(){return t(this,ae,"f")}get type(){return t(this,he,"f")}get length(){return t(this,ue,"f")}get checksum(){return t(this,ve,"f")}get status(){return t(this,Ce,"f")}parseMessage(e,i){switch(xe.log({messageType:e}),e){case"getFileTypes":t(this,K,"m",se).call(this,i);break;case"maxFileLength":t(this,K,"m",re).call(this,i);break;case"getFileType":case"setFileType":t(this,K,"m",le).call(this,i);break;case"getFileLength":case"setFileLength":t(this,K,"m",de).call(this,i);break;case"getFileChecksum":case"setFileChecksum":t(this,K,"m",we).call(this,i);break;case"fileTransferStatus":t(this,K,"m",Me).call(this,i);break;case"getFileBlock":t(this,K,"m",Te).call(this,i);break;case"fileBytesTransferred":t(this,K,"m",Re).call(this,i);break;default:throw Error(`uncaught messageType ${e}`)}}async send(e,i){t(this,K,"m",ke).call(this),t(this,K,"m",X).call(this,e);const s=await H(i),n=s.byteLength,a=O(s);if(e!=this.type)xe.log("different fileTypes - sending");else if(n!=this.length)xe.log("different fileLengths - sending");else{if(a==this.checksum)return xe.log("already sent file"),!1;xe.log("different fileChecksums - sending")}const r=[];return r.push(t(this,K,"m",ge).call(this,e,!1)),r.push(t(this,K,"m",pe).call(this,n,!1)),r.push(t(this,K,"m",be).call(this,a,!1)),r.push(t(this,K,"m",Se).call(this,"startSend",!1)),this.sendMessage(),await Promise.all(r),await t(this,K,"m",Le).call(this,s),!0}async receive(e){t(this,K,"m",ke).call(this),t(this,K,"m",X).call(this,e),await t(this,K,"m",ge).call(this,e),await t(this,K,"m",Se).call(this,"startReceive")}async cancel(){t(this,K,"m",De).call(this),xe.log("cancelling file transfer..."),i(this,Fe,!0,"f"),await t(this,K,"m",Se).call(this,"cancel")}get isServerSide(){return t(this,Ae,"f")}set isServerSide(e){t(this,Ae,"f")!=e?(xe.log({newIsServerSide:e}),i(this,Ae,e,"f")):xe.log("redundant isServerSide assignment")}requestRequiredInformation(){xe.log("requesting required fileTransfer information");const e=Ve.map((e=>({type:e})));this.sendMessage(e,!1)}}Q=qe,ie=new WeakMap,ae=new WeakMap,he=new WeakMap,ue=new WeakMap,ve=new WeakMap,Ce=new WeakMap,We=new WeakMap,Ie=new WeakMap,_e=new WeakMap,Fe=new WeakMap,Ae=new WeakMap,K=new WeakSet,Z=function(){return this.eventDispatcher.dispatchEvent},X=function(e){xe.assertEnumWithError(e,Oe)},Y=function(e){xe.assertWithError(e in Oe,`invalid typeEnum ${e}`)},ee=function(e){xe.assertWithError(e in Be,`invalid statusEnum ${e}`)},te=function(e){xe.assertEnumWithError(e,Ne)},se=function(e){const s=Array.from(new Uint8Array(e.buffer)).map((e=>Oe[e])).filter(Boolean);i(this,ie,s,"f"),xe.log("fileTypes",s),t(this,K,"a",Z).call(this,"getFileTypes",{fileTypes:t(this,ie,"f")})},re=function(e){xe.log("parseFileMaxLength",e);const i=e.getUint32(0,!0);xe.log(`maxLength: ${i/1024}kB`),t(this,K,"m",oe).call(this,i)},oe=function(e){xe.log({maxLength:e}),i(this,ae,e,"f"),t(this,K,"a",Z).call(this,"maxFileLength",{maxFileLength:e})},ce=function(e){xe.assertWithError(e<=this.maxLength,`file length ${e}kB too large - must be ${this.maxLength}kB or less`)},le=function(e){xe.log("parseFileType",e);const i=e.getUint8(0);t(this,K,"m",Y).call(this,i);const s=Oe[i];t(this,K,"m",fe).call(this,s)},fe=function(e){xe.log({fileTransferType:e}),i(this,he,e,"f"),t(this,K,"a",Z).call(this,"getFileType",{fileType:e})},ge=async function(e,i){if(t(this,K,"m",X).call(this,e),this.type==e)return void xe.log(`redundant type assignment ${e}`);const s=this.waitForEvent("getFileType"),n=Oe.indexOf(e);this.sendMessage([{type:"setFileType",data:Uint8Array.from([n]).buffer}],i),await s},de=function(e){xe.log("parseFileLength",e);const i=e.getUint32(0,!0);t(this,K,"m",me).call(this,i)},me=function(e){xe.log(`length: ${e/1024}kB`),i(this,ue,e,"f"),t(this,K,"a",Z).call(this,"getFileLength",{fileLength:e})},pe=async function(e,i){if(xe.assertTypeWithError(e,"number"),t(this,K,"m",ce).call(this,e),this.length==e)return void xe.log(`redundant length assignment ${e}`);const s=this.waitForEvent("getFileLength"),n=new DataView(new ArrayBuffer(4));n.setUint32(0,e,!0),this.sendMessage([{type:"setFileLength",data:n.buffer}],i),await s},we=function(e){xe.log("checksum",e);const i=e.getUint32(0,!0);t(this,K,"m",ye).call(this,i)},ye=function(e){xe.log({checksum:e}),i(this,ve,e,"f"),t(this,K,"a",Z).call(this,"getFileChecksum",{fileChecksum:e})},be=async function(e,t){if(xe.assertTypeWithError(e,"number"),this.checksum==e)return void xe.log(`redundant checksum assignment ${e}`);const i=this.waitForEvent("getFileChecksum"),s=new DataView(new ArrayBuffer(4));s.setUint32(0,e,!0),this.sendMessage([{type:"setFileChecksum",data:s.buffer}],t),await i},Se=async function(e,i){t(this,K,"m",te).call(this,e);const s=this.waitForEvent("fileTransferStatus");xe.log(`setting command ${e}`);const n=Ne.indexOf(e);this.sendMessage([{type:"setFileTransferCommand",data:Uint8Array.from([n]).buffer}],i),await s},Me=function(e){xe.log("parseFileStatus",e);const i=e.getUint8(0);t(this,K,"m",ee).call(this,i);const s=Be[i];t(this,K,"m",Ee).call(this,s)},Ee=function(e){xe.log({status:e}),i(this,Ce,e,"f"),t(this,K,"a",Z).call(this,"fileTransferStatus",{fileTransferStatus:e}),t(this,We,"f").length=0,i(this,Fe,!1,"f")},ke=function(){xe.assertWithError("idle"==t(this,Ce,"f"),"status is not idle")},De=function(){xe.assertWithError("idle"!=t(this,Ce,"f"),"status is idle")},Te=async function(e){xe.log("parseFileBlock",e),t(this,We,"f").push(e.buffer);const i=t(this,We,"f").reduce(((e,t)=>e+t.byteLength),0),s=i/t(this,ue,"f");if(xe.log(`received ${i} of ${t(this,ue,"f")} bytes (${100*s}%)`),t(this,K,"a",Z).call(this,"fileTransferProgress",{progress:s}),i!=t(this,ue,"f")){const e=new DataView(new ArrayBuffer(4));if(e.setUint32(0,i,!0),this.isServerSide)return;return void await this.sendMessage([{type:"fileBytesTransferred",data:e.buffer}])}xe.log("file transfer complete");let n,a=(new Date).toLocaleString();switch(this.type){case"tflite":a+=".tflite";break;case"wifiServerCert":a+="_server.crt";break;case"wifiServerKey":a+="_server.key"}n="undefined"!=typeof File?new File(t(this,We,"f"),a):new Blob(t(this,We,"f"));const r=O(await n.arrayBuffer());xe.log({checksum:r}),r==t(this,ve,"f")?(xe.log("received file",n),t(this,K,"a",Z).call(this,"getFileBlock",{fileTransferBlock:e}),t(this,K,"a",Z).call(this,"fileTransferComplete",{direction:"receiving"}),t(this,K,"a",Z).call(this,"fileReceived",{file:n})):xe.error(`wrong checksum - expected ${t(this,ve,"f")}, got ${r}`)},Le=async function(e){return i(this,Ie,e,"f"),i(this,_e,0,"f"),t(this,K,"m",Ue).call(this)},Ue=async function(){if("sending"!=this.status)return;if(t(this,Fe,"f"))return void xe.error("not sending block - busy cancelling");if(!t(this,Ie,"f"))return void(this.isServerSide||xe.error("no buffer defined"));const e=t(this,Ie,"f");let s=t(this,_e,"f");const n=e.slice(s,s+(this.mtu-3-3));xe.log("slicedBuffer",n);const a=1-(e.byteLength-s)/e.byteLength;xe.log(`sending bytes ${s}-${s+n.byteLength} of ${e.byteLength} bytes (${100*a}%)`),t(this,K,"a",Z).call(this,"fileTransferProgress",{progress:a}),0==n.byteLength?(xe.log("finished sending buffer"),t(this,K,"a",Z).call(this,"fileTransferComplete",{direction:"sending"})):(await this.sendMessage([{type:"setFileBlock",data:n}]),i(this,_e,s+n.byteLength,"f"))},Re=async function(e){xe.log("parseBytesTransferred",e);const i=e.getUint32(0,!0);if(xe.log({bytesTransferred:i}),"sending"==this.status)return this.isServerSide||t(this,_e,"f")==i?void t(this,K,"m",Ue).call(this):(xe.error(`bytesTransferred are not equal - got ${i}, expected ${t(this,_e,"f")}`),void this.cancel());xe.error("not currently sending file")},ne={value:0};const ze=T("MathUtils",{log:!1});const je=65536;function Ge(e,t){const i=Date.now();var s;let n=(s=i)-s%je+e.getUint16(t,!0);return Math.abs(i-n)>6e4&&(ze.log("correcting timestamp delta"),n+=je*Math.sign(i-n)),n}var He,Je,Ke;const Qe={min:1/0,max:-1/0,span:0};class Ze{constructor(){He.add(this),Je.set(this,Object.assign({},Qe))}get min(){return t(this,Je,"f").min}get max(){return t(this,Je,"f").max}set min(e){t(this,Je,"f").min=e,t(this,Je,"f").max=Math.max(e,t(this,Je,"f").max),t(this,He,"m",Ke).call(this)}set max(e){t(this,Je,"f").max=e,t(this,Je,"f").min=Math.min(e,t(this,Je,"f").min),t(this,He,"m",Ke).call(this)}reset(){Object.assign(t(this,Je,"f"),Qe)}update(e){t(this,Je,"f").min=Math.min(e,t(this,Je,"f").min),t(this,Je,"f").max=Math.max(e,t(this,Je,"f").max),t(this,He,"m",Ke).call(this)}getNormalization(e,i){let s=function(e,t,i,s){return null==s&&(s=i-t),(e-t)/s}(e,t(this,Je,"f").min,t(this,Je,"f").max,t(this,Je,"f").span);return i&&(s*=t(this,Je,"f").span),s||0}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}var Xe,Ye,et,tt,it;Je=new WeakMap,He=new WeakSet,Ke=function(){t(this,Je,"f").span=t(this,Je,"f").max-t(this,Je,"f").min};class st{constructor(){Xe.set(this,{x:new Ze,y:new Ze})}reset(){t(this,Xe,"f").x.reset(),t(this,Xe,"f").y.reset()}update(e){t(this,Xe,"f").x.update(e.x),t(this,Xe,"f").y.update(e.y)}getNormalization(e,i){return{x:t(this,Xe,"f").x.getNormalization(e.x,i),y:t(this,Xe,"f").y.getNormalization(e.y,i)}}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}Xe=new WeakMap;const nt=T("PressureDataManager",{log:!1}),at=["pressure"],rt=at;class ot{constructor(){Ye.set(this,[]),et.set(this,void 0),tt.set(this,new Ze),it.set(this,new st)}get positions(){return t(this,Ye,"f")}get numberOfSensors(){return this.positions.length}parsePositions(e){const t=[];for(let i=0,s=0;s<e.byteLength;i++,s+=2)t.push({x:e.getUint8(s)/256,y:e.getUint8(s+1)/256});var s,n;nt.log({positions:t}),i(this,Ye,t,"f"),i(this,et,(s=this.numberOfSensors,n=()=>new Ze,new Array(s).fill(1).map(((e,t)=>{if("function"==typeof n)return n(t);{const e=n;return Object.assign({},e)}}))),"f"),this.resetRange()}resetRange(){t(this,et,"f")?.forEach((e=>e.reset())),t(this,it,"f").reset(),t(this,tt,"f").reset()}parseData(e,i){const s={sensors:[],scaledSum:0,normalizedSum:0};for(let n=0,a=0;a<e.byteLength;n++,a+=2){const r=e.getUint16(a,!0);let o=r*i/this.numberOfSensors;const c=t(this,et,"f")[n].updateAndGetNormalization(o,!1),h=this.positions[n];s.sensors[n]={rawValue:r,scaledValue:o,normalizedValue:c,position:h,weightedValue:0},s.scaledSum+=o}return s.normalizedSum=t(this,tt,"f").updateAndGetNormalization(s.scaledSum,!1),s.scaledSum>0&&(s.center={x:0,y:0},s.sensors.forEach((e=>{e.weightedValue=e.scaledValue/s.scaledSum,s.center.x+=e.position.x*e.weightedValue,s.center.y+=e.position.y*e.weightedValue})),s.normalizedCenter=t(this,it,"f").updateAndGetNormalization(s.center,!1)),nt.log({pressure:s}),s}}Ye=new WeakMap,et=new WeakMap,tt=new WeakMap,it=new WeakMap;const ct=T("MotionSensorDataManager",{log:!1}),ht=["still","walking","running","bicycle","vehicle","tilting"],lt=["portraitUpright","landscapeLeft","portraitUpsideDown","landscapeRight","unknown"];class ft{parseVector3(e,t){let[i,s,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));const a={x:i,y:s,z:n};return ct.log({vector:a}),a}parseQuaternion(e,t){let[i,s,n,a]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0),e.getInt16(6,!0)].map((e=>e*t));const r={x:i,y:s,z:n,w:a};return ct.log({quaternion:r}),r}parseEuler(e,t){let[i,s,n]=[e.getInt16(0,!0),e.getInt16(2,!0),e.getInt16(4,!0)].map((e=>e*t));s*=-1,i*=-1,i<0&&(i+=360);const a={heading:i,pitch:s,roll:n};return ct.log({euler:a}),a}parseStepCounter(e){ct.log("parseStepCounter",e);const t=e.getUint32(0,!0);return ct.log({stepCount:t}),t}parseActivity(e){ct.log("parseActivity",e);const t={},i=e.getUint8(0);return ct.log("activityBitfield",i.toString(2)),ht.forEach(((e,s)=>{t[e]=Boolean(i&1<<s)})),ct.log("activity",t),t}parseDeviceOrientation(e){ct.log("parseDeviceOrientation",e);const t=e.getUint8(0),i=lt[t];return ct.assertWithError(i,"undefined deviceOrientation"),ct.log({deviceOrientation:i}),i}}var gt,ut;const dt=["barometer"],mt=dt,pt=T("BarometerSensorDataManager",{log:!1});class vt{constructor(){gt.add(this)}parseData(e,i){const s=e.getUint32(0,!0)*i,n=t(this,gt,"m",ut).call(this,s);return pt.log({pressure:s,altitude:n}),{pressure:s}}}gt=new WeakSet,ut=function(e){const t=.0065;return 288.15/t*(1-Math.pow(e/101325,.19026643566373183))};const wt=T("ParseUtils",{log:!1});function yt(e,t=0){const i=e.getUint8(t++);return{string:V.decode(e.buffer.slice(e.byteOffset+t,e.byteOffset+t+i)),byteOffset:t+=i}}function bt(e,t,i,s,n=!1){let a=0;for(;a<e.byteLength;){const r=e.getUint8(a++);wt.assertWithError(r in t,`invalid messageTypeEnum ${r}`);const o=t[r];let c;n?(c=e.getUint16(a,!0),a+=2):c=e.getUint8(a++),wt.log({messageTypeEnum:r,messageType:o,messageLength:c,dataView:e,byteOffset:a});const h=G(e,a,c);wt.log({_dataView:h}),i(o,h,s),a+=c}}var St,Ct,Mt,Et,kt,Dt,Wt,Tt,It,_t,Lt,Ut,Rt,Ft,At,xt,$t,Ot,Bt,Nt,Pt,Vt,qt,zt,jt,Gt,Ht,Jt,Kt;const Qt=T("CameraManager",{log:!1}),Zt=["focus","takePicture","stop","sleep","wake"],Xt=["idle","focusing","takingPicture","asleep"],Yt=["headerSize","header","imageSize","image","footerSize","footer"],ei=["resolution","qualityFactor","shutter","gain","redGain","greenGain","blueGain"],ti=["cameraStatus","cameraCommand","getCameraConfiguration","setCameraConfiguration","cameraData"],ii=["getCameraConfiguration","cameraStatus"],si=[...ti,"cameraImageProgress","cameraImage"];class ni{constructor(){St.add(this),Et.set(this,void 0),Ut.set(this,0),Rt.set(this,void 0),Ft.set(this,0),At.set(this,0),xt.set(this,void 0),$t.set(this,0),Ot.set(this,0),Bt.set(this,void 0),Nt.set(this,0),Pt.set(this,!1),qt.set(this,{}),zt.set(this,void 0),jt.set(this,{resolution:{min:100,max:720},qualityFactor:{min:15,max:60},shutter:{min:4,max:16383},gain:{min:1,max:248},redGain:{min:0,max:1023},greenGain:{min:0,max:1023},blueGain:{min:0,max:1023}}),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Qt.log("requesting required camera information");const e=ii.map((e=>({type:e})));this.sendMessage(e,!1)}get cameraStatus(){return t(this,Et,"f")}async focus(){t(this,St,"m",It).call(this),await t(this,St,"m",Wt).call(this,"focus")}async takePicture(){t(this,St,"m",It).call(this),await t(this,St,"m",Wt).call(this,"takePicture")}async stop(){t(this,St,"m",It).call(this),await t(this,St,"m",Wt).call(this,"stop")}async sleep(){t(this,St,"m",It).call(this),await t(this,St,"m",Wt).call(this,"sleep")}async wake(){t(this,St,"m",Tt).call(this),await t(this,St,"m",Wt).call(this,"wake")}get cameraConfiguration(){return t(this,qt,"f")}get availableCameraConfigurationTypes(){return t(this,zt,"f")}get cameraConfigurationRanges(){return t(this,jt,"f")}async setCameraConfiguration(e){if(Qt.log({newCameraConfiguration:e}),t(this,St,"m",Ht).call(this,e))return void Qt.log("redundant camera configuration");const i=t(this,St,"m",Kt).call(this,e);Qt.log({setCameraConfigurationData:i});const s=this.waitForEvent("getCameraConfiguration");this.sendMessage([{type:"setCameraConfiguration",data:i.buffer}]),await s}static AssertValidCameraConfigurationType(e){Qt.assertEnumWithError(e,ei)}static AssertValidCameraConfigurationTypeEnum(e){Qt.assertTypeWithError(e,"number"),Qt.assertWithError(e in ei,`invalid cameraConfigurationTypeEnum ${e}`)}parseMessage(e,i){switch(Qt.log({messageType:e,dataView:i}),e){case"cameraStatus":t(this,St,"m",kt).call(this,i);break;case"getCameraConfiguration":case"setCameraConfiguration":t(this,St,"m",Gt).call(this,i);break;case"cameraData":t(this,St,"m",_t).call(this,i);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){i(this,Et,void 0,"f"),i(this,Ft,0,"f"),i(this,$t,0,"f"),i(this,Nt,0,"f")}}function ai(e,t,i){const s=function(e,t,i){const s=new ArrayBuffer(44+2*e.length),n=new DataView(s);ri(n,0,"RIFF"),n.setUint32(4,36+2*e.length,!0),ri(n,8,"WAVE"),ri(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,i,!0),n.setUint32(24,t,!0),n.setUint32(28,t*i*2,!0),n.setUint16(32,2*i,!0),n.setUint16(34,16,!0),ri(n,36,"data"),n.setUint32(40,2*e.length,!0);for(let t=0;t<e.length;t++)n.setInt16(44+2*t,32767*e[t],!0);return s}(e,t,i);return new Blob([s],{type:"audio/wav"})}function ri(e,t,i){for(let s=0;s<i.length;s++)e.setUint8(t+s,i.charCodeAt(s))}var oi,ci,hi,li,fi,gi,ui,di,mi,pi,vi,wi,yi,bi,Si,Ci,Mi,Ei,ki,Di,Wi,Ti,Ii,_i;Ct=ni,Et=new WeakMap,Ut=new WeakMap,Rt=new WeakMap,Ft=new WeakMap,At=new WeakMap,xt=new WeakMap,$t=new WeakMap,Ot=new WeakMap,Bt=new WeakMap,Nt=new WeakMap,Pt=new WeakMap,qt=new WeakMap,zt=new WeakMap,jt=new WeakMap,St=new WeakSet,Mt=function(){return this.eventDispatcher.dispatchEvent},kt=function(e){const i=e.getUint8(0),s=Xt[i];t(this,St,"m",Dt).call(this,s)},Dt=function(e){if(Qt.assertEnumWithError(e,Xt),e==t(this,Et,"f"))return void Qt.log(`redundant cameraStatus ${e}`);const s=t(this,Et,"f");i(this,Et,e,"f"),Qt.log(`updated cameraStatus to "${this.cameraStatus}"`),t(this,St,"a",Mt).call(this,"cameraStatus",{cameraStatus:this.cameraStatus,previousCameraStatus:s}),"takingPicture"!=t(this,Et,"f")&&t(this,$t,"f")>0&&!t(this,Pt,"f")&&t(this,St,"m",Vt).call(this)},Wt=async function(e,t){Qt.assertEnumWithError(e,Zt),Qt.log(`sending camera command "${e}"`);const i=this.waitForEvent("cameraStatus");Qt.log(`setting command "${e}"`);const s=Zt.indexOf(e);this.sendMessage([{type:"cameraCommand",data:Uint8Array.from([s]).buffer}],t),await i},Tt=function(){Qt.assertWithError("asleep"==t(this,Et,"f"),`camera is not asleep - currently ${t(this,Et,"f")}`)},It=function(){Qt.assertWithError("asleep"!=t(this,Et,"f"),`camera is not awake - currently ${t(this,Et,"f")}`)},_t=function(e){Qt.log("parsing camera data",e),bt(e,Yt,t(this,St,"m",Lt).bind(this),null,!0)},Lt=function(e,s){switch(Qt.log({cameraDataType:e,dataView:s}),e){case"headerSize":i(this,Ut,s.getUint16(0,!0),"f"),Qt.log({headerSize:t(this,Ut,"f")}),i(this,Rt,void 0,"f"),t(this,Ft,"f");break;case"header":i(this,Rt,z(t(this,Rt,"f"),s),"f"),Qt.log({headerData:t(this,Rt,"f")}),i(this,Ft,t(this,Rt,"f")?.byteLength/t(this,Ut,"f"),"f"),Qt.log({headerProgress:t(this,Ft,"f")}),t(this,St,"a",Mt).call(this,"cameraImageProgress",{progress:t(this,Ft,"f"),type:"header"}),1==t(this,Ft,"f")&&Qt.log("finished getting header data");break;case"imageSize":i(this,At,s.getUint16(0,!0),"f"),Qt.log({imageSize:t(this,At,"f")}),i(this,xt,void 0,"f"),t(this,$t,"f"),i(this,Pt,!1,"f");break;case"image":i(this,xt,z(t(this,xt,"f"),s),"f"),Qt.log({imageData:t(this,xt,"f")}),i(this,$t,t(this,xt,"f")?.byteLength/t(this,At,"f"),"f"),Qt.log({imageProgress:t(this,$t,"f")}),t(this,St,"a",Mt).call(this,"cameraImageProgress",{progress:t(this,$t,"f"),type:"image"}),1==t(this,$t,"f")&&(Qt.log("finished getting image data"),1==t(this,Ft,"f")&&t(this,St,"m",Vt).call(this));break;case"footerSize":i(this,Ot,s.getUint16(0,!0),"f"),Qt.log({footerSize:t(this,Ot,"f")}),i(this,Bt,void 0,"f"),t(this,Nt,"f");break;case"footer":i(this,Bt,z(t(this,Bt,"f"),s),"f"),Qt.log({footerData:t(this,Bt,"f")}),i(this,Nt,t(this,Bt,"f")?.byteLength/t(this,Ot,"f"),"f"),Qt.log({footerProgress:t(this,Nt,"f")}),t(this,St,"a",Mt).call(this,"cameraImageProgress",{progress:t(this,Nt,"f"),type:"footer"}),1==t(this,Nt,"f")&&(Qt.log("finished getting footer data"),1==t(this,$t,"f")&&t(this,St,"m",Vt).call(this))}},Vt=function(){Qt.log("building image...");const e=z(t(this,Rt,"f"),t(this,xt,"f"),t(this,Bt,"f"));Qt.log({imageData:e});let s=new Blob([e],{type:"image/jpeg"});Qt.log("created blob",s);const n=URL.createObjectURL(s);Qt.log("created url",n),t(this,St,"a",Mt).call(this,"cameraImage",{url:n,blob:s}),i(this,Pt,!0,"f")},Gt=function(e){const s={};let n=0;for(;n<e.byteLength;){const t=e.getUint8(n++),i=ei[t];Qt.assertWithError(i,`invalid cameraConfigurationTypeIndex ${t}`),s[i]=e.getUint16(n,!0),n+=2}Qt.log({parsedCameraConfiguration:s}),i(this,zt,Object.keys(s),"f"),i(this,qt,s,"f"),t(this,St,"a",Mt).call(this,"getCameraConfiguration",{cameraConfiguration:t(this,qt,"f")})},Ht=function(e){return Object.keys(e).every((t=>this.cameraConfiguration[t]==e[t]))},Jt=function(e){Qt.assertWithError(t(this,zt,"f"),"must get initial cameraConfiguration");const i=t(this,zt,"f")?.includes(e);return Qt.assertWithError(i,`unavailable camera configuration type "${e}"`),i},Kt=function(e){let i=Object.keys(e);i=i.filter((e=>t(this,St,"m",Jt).call(this,e)));const s=new DataView(new ArrayBuffer(3*i.length));return i.forEach(((t,i)=>{Ct.AssertValidCameraConfigurationType(t);const n=ei.indexOf(t);s.setUint8(3*i,n);const a=e[t];s.setUint16(3*i+1,a,!0)})),Qt.log({sensorConfigurationData:s}),s},T("AudioUtils",{log:!0});const Li=T("MicrophoneManager",{log:!1}),Ui=["start","stop","vad"],Ri=["idle","streaming","vad"],Fi=["sampleRate","bitDepth"],Ai=["8","16"],xi=["microphoneStatus","microphoneCommand","getMicrophoneConfiguration","setMicrophoneConfiguration","microphoneData"],$i={sampleRate:["8000","16000"],bitDepth:Ai},Oi=["getMicrophoneConfiguration","microphoneStatus"],Bi=[...xi,"isRecordingMicrophone","microphoneRecording"];class Ni{constructor(){oi.add(this),li.set(this,void 0),pi.set(this,.001),vi.set(this,0),bi.set(this,{}),Si.set(this,void 0),Di.set(this,void 0),Wi.set(this,void 0),Ti.set(this,void 0),Ii.set(this,!1),_i.set(this,void 0),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Li.log("requesting required microphone information");const e=Oi.map((e=>({type:e})));this.sendMessage(e,!1)}get microphoneStatus(){return t(this,li,"f")}async start(){await t(this,oi,"m",ui).call(this,"start")}async stop(){t(this,oi,"m",di).call(this),await t(this,oi,"m",ui).call(this,"stop")}async vad(){await t(this,oi,"m",ui).call(this,"vad")}async toggle(){switch(this.microphoneStatus){case"idle":this.start();break;case"streaming":this.stop()}}get microphoneConfiguration(){return t(this,bi,"f")}get availableMicrophoneConfigurationTypes(){return t(this,Si,"f")}get bitDepth(){return t(this,bi,"f").bitDepth}get sampleRate(){return t(this,bi,"f").sampleRate}async setMicrophoneConfiguration(e){if(Li.log({newMicrophoneConfiguration:e}),t(this,oi,"m",Mi).call(this,e))return void Li.log("redundant microphone configuration");const i=t(this,oi,"m",ki).call(this,e);Li.log({setMicrophoneConfigurationData:i});const s=this.waitForEvent("getMicrophoneConfiguration");this.sendMessage([{type:"setMicrophoneConfiguration",data:i.buffer}]),await s}static AssertValidMicrophoneConfigurationType(e){Li.assertEnumWithError(e,Fi)}static AssertValidMicrophoneConfigurationTypeEnum(e){Li.assertTypeWithError(e,"number"),Li.assertWithError(e in Fi,`invalid microphoneConfigurationTypeEnum ${e}`)}parseMessage(e,i){switch(Li.log({messageType:e,dataView:i}),e){case"microphoneStatus":t(this,oi,"m",fi).call(this,i);break;case"getMicrophoneConfiguration":case"setMicrophoneConfiguration":t(this,oi,"m",Ci).call(this,i);break;case"microphoneData":t(this,oi,"m",wi).call(this,i);break;default:throw Error(`uncaught messageType ${e}`)}}get audioContext(){return t(this,Di,"f")}set audioContext(e){t(this,Di,"f")!=e?(i(this,Di,e,"f"),Li.log("assigned new audioContext",t(this,Di,"f")),t(this,Di,"f")?i(this,vi,t(this,Di,"f").currentTime,"f"):(t(this,Ti,"f")&&(t(this,Ti,"f").disconnect(),i(this,Ti,void 0,"f")),t(this,Wi,"f")&&(t(this,Wi,"f").disconnect(),i(this,Wi,void 0,"f")))):Li.log("redundant audioContext assignment",t(this,Di,"f"))}get gainNode(){return Li.assertWithError(t(this,Di,"f"),"audioContext assignment required for gainNode"),t(this,Wi,"f")||(Li.log("creating gainNode..."),i(this,Wi,t(this,Di,"f").createGain(),"f"),Li.log("created gainNode",t(this,Wi,"f"))),t(this,Wi,"f")}get mediaStreamDestination(){return Li.assertWithError(t(this,Di,"f"),"audioContext assignment required for mediaStreamDestination"),t(this,Ti,"f")||(Li.log("creating mediaStreamDestination..."),i(this,Ti,t(this,Di,"f").createMediaStreamDestination(),"f"),this.gainNode?.connect(t(this,Ti,"f")),Li.log("created mediaStreamDestination",t(this,Ti,"f"))),t(this,Ti,"f")}get isRecording(){return t(this,Ii,"f")}startRecording(){this.isRecording?Li.log("already recording"):(i(this,_i,[],"f"),i(this,Ii,!0,"f"),t(this,oi,"a",hi).call(this,"isRecordingMicrophone",{isRecordingMicrophone:this.isRecording}))}stopRecording(){if(this.isRecording){if(i(this,Ii,!1,"f"),t(this,_i,"f")&&t(this,_i,"f").length>0){Li.log("parsing microphone data...",t(this,_i,"f").length);const e=z(...t(this,_i,"f")),i=new Float32Array(e),s=ai(i,Number(this.sampleRate),1),n=URL.createObjectURL(s);t(this,oi,"a",hi).call(this,"microphoneRecording",{samples:i,sampleRate:this.sampleRate,bitDepth:this.bitDepth,blob:s,url:n})}i(this,_i,void 0,"f"),t(this,oi,"a",hi).call(this,"isRecordingMicrophone",{isRecordingMicrophone:this.isRecording})}else Li.log("already not recording")}toggleRecording(){t(this,Ii,"f")?this.stopRecording():this.startRecording()}clear(){i(this,li,void 0,"f"),i(this,bi,{},"f"),this.isRecording&&this.stopRecording()}}var Pi;ci=Ni,li=new WeakMap,pi=new WeakMap,vi=new WeakMap,bi=new WeakMap,Si=new WeakMap,Di=new WeakMap,Wi=new WeakMap,Ti=new WeakMap,Ii=new WeakMap,_i=new WeakMap,oi=new WeakSet,hi=function(){return this.eventDispatcher.dispatchEvent},fi=function(e){const i=e.getUint8(0),s=Ri[i];t(this,oi,"m",gi).call(this,s)},gi=function(e){if(Li.assertEnumWithError(e,Ri),e==t(this,li,"f"))return void Li.log(`redundant microphoneStatus ${e}`);const s=t(this,li,"f");i(this,li,e,"f"),Li.log(`updated microphoneStatus to "${this.microphoneStatus}"`),t(this,oi,"a",hi).call(this,"microphoneStatus",{microphoneStatus:this.microphoneStatus,previousMicrophoneStatus:s})},ui=async function(e,t){Li.assertEnumWithError(e,Ui),Li.log(`sending microphone command "${e}"`);const i=this.waitForEvent("microphoneStatus");Li.log(`setting command "${e}"`);const s=Ui.indexOf(e);this.sendMessage([{type:"microphoneCommand",data:Uint8Array.from([s]).buffer}],t),await i},di=function(){Li.assertWithError("idle"!=t(this,li,"f"),"microphone is idle")},mi=function(){Li.assertEnumWithError(this.bitDepth,Ai)},wi=function(e){t(this,oi,"m",mi).call(this),Li.log("parsing microphone data",e);const s=e.byteLength/t(this,oi,"a",yi),n=new Float32Array(s);for(let t=0;t<s;t++){let i;switch(this.bitDepth){case"16":i=e.getInt16(2*t,!0),n[t]=i/32768;break;case"8":i=e.getInt8(t),n[t]=i/128}}if(Li.log("samples",n),t(this,Ii,"f")&&t(this,_i,"f")&&t(this,_i,"f").push(n),t(this,Di,"f")&&t(this,Wi,"f")){const e=t(this,Di,"f").createBuffer(1,n.length,Number(this.sampleRate));e.getChannelData(0).set(n);const s=t(this,Di,"f").createBufferSource();s.buffer=e;const a=e.getChannelData(0),r=Number(this.sampleRate);for(let e=0;e<t(this,pi,"f")*r;e++)a[e]*=e/(t(this,pi,"f")*r);for(let e=a.length-1;e>=a.length-t(this,pi,"f")*r;e--)a[e]*=(a.length-e)/(t(this,pi,"f")*r);s.connect(t(this,Wi,"f")),t(this,vi,"f")<t(this,Di,"f").currentTime&&i(this,vi,t(this,Di,"f").currentTime,"f"),s.start(t(this,vi,"f")),i(this,vi,t(this,vi,"f")+e.duration,"f")}t(this,oi,"a",hi).call(this,"microphoneData",{samples:n,sampleRate:this.sampleRate,bitDepth:this.bitDepth})},yi=function(){switch(this.bitDepth){case"8":return 1;case"16":return 2}},Ci=function(e){const s={};let n=0;for(;n<e.byteLength;){const t=e.getUint8(n++),i=Fi[t];Li.assertWithError(i,`invalid microphoneConfigurationTypeIndex ${t}`);let a=e.getUint8(n++);const r=$i[i],o=r[a];Li.assertEnumWithError(o,r),Li.log({microphoneConfigurationType:i,value:o}),s[i]=o}Li.log({parsedMicrophoneConfiguration:s}),i(this,Si,Object.keys(s),"f"),i(this,bi,s,"f"),t(this,oi,"a",hi).call(this,"getMicrophoneConfiguration",{microphoneConfiguration:t(this,bi,"f")})},Mi=function(e){return Object.keys(e).every((t=>this.microphoneConfiguration[t]==e[t]))},Ei=function(e){Li.assertWithError(t(this,Si,"f"),"must get initial microphoneConfiguration");const i=t(this,Si,"f")?.includes(e);return Li.assertWithError(i,`unavailable microphone configuration type "${e}"`),i},ki=function(e){let i=Object.keys(e);i=i.filter((e=>t(this,oi,"m",Ei).call(this,e)));const s=new DataView(new ArrayBuffer(2*i.length));return i.forEach(((t,i)=>{ci.AssertValidMicrophoneConfigurationType(t);const n=Fi.indexOf(t);s.setUint8(2*i,n);let a=e[t];"number"==typeof a&&(a=a.toString());const r=$i[t];Li.assertEnumWithError(a,r);const o=r.indexOf(a);s.setUint8(2*i+1,o)})),Li.log({sensorConfigurationData:s}),s};const Vi=T("SensorDataManager",{log:!1}),qi=[...at,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation","activity","stepCounter","stepDetector","deviceOrientation","tapDetector",...dt,"camera","microphone"],zi=[...rt,"acceleration","gravity","linearAcceleration","gyroscope","magnetometer","gameRotation","rotation","orientation",...mt],ji=["getPressurePositions","getSensorScalars","sensorData"],Gi=["getPressurePositions"],Hi=[...ji,...qi];class Ji{constructor(){this.pressureSensorDataManager=new ot,this.motionSensorDataManager=new ft,this.barometerSensorDataManager=new vt,Pi.set(this,new Map)}static AssertValidSensorType(e){Vi.assertEnumWithError(e,qi)}static AssertValidSensorTypeEnum(e){Vi.assertTypeWithError(e,"number"),Vi.assertWithError(e in qi,`invalid sensorTypeEnum ${e}`)}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}parseMessage(e,t){switch(Vi.log({messageType:e}),e){case"getSensorScalars":this.parseScalars(t);break;case"getPressurePositions":this.pressureSensorDataManager.parsePositions(t);break;case"sensorData":this.parseData(t);break;default:throw Error(`uncaught messageType ${e}`)}}parseScalars(e){for(let i=0;i<e.byteLength;i+=5){const s=e.getUint8(i),n=qi[s];if(!n){Vi.warn(`unknown sensorType index ${s}`);continue}const a=e.getFloat32(i+1,!0);Vi.log({sensorType:n,sensorScalar:a}),t(this,Pi,"f").set(n,a)}}parseData(e){Vi.log("sensorData",Array.from(new Uint8Array(e.buffer)));let t=0;const i=Ge(e,t);t+=2;bt(new DataView(e.buffer,t),qi,this.parseDataCallback.bind(this),{timestamp:i})}parseDataCallback(e,i,{timestamp:s}){const n=t(this,Pi,"f").get(e)||1;let a=null;switch(e){case"pressure":a=this.pressureSensorDataManager.parseData(i,n);break;case"acceleration":case"gravity":case"linearAcceleration":case"gyroscope":case"magnetometer":a=this.motionSensorDataManager.parseVector3(i,n);break;case"gameRotation":case"rotation":a=this.motionSensorDataManager.parseQuaternion(i,n);break;case"orientation":a=this.motionSensorDataManager.parseEuler(i,n);break;case"stepCounter":a=this.motionSensorDataManager.parseStepCounter(i);break;case"stepDetector":case"tapDetector":a={};break;case"activity":a=this.motionSensorDataManager.parseActivity(i);break;case"deviceOrientation":a=this.motionSensorDataManager.parseDeviceOrientation(i);break;case"barometer":a=this.barometerSensorDataManager.parseData(i,n);break;case"camera":case"microphone":return;default:Vi.error(`uncaught sensorType "${e}"`)}Vi.assertWithError(null!=a,`no sensorData defined for sensorType "${e}"`),Vi.log({sensorType:e,sensorData:a}),this.dispatchEvent(e,{sensorType:e,[e]:a,timestamp:s}),this.dispatchEvent("sensorData",{sensorType:e,[e]:a,timestamp:s})}}var Ki,Qi,Zi,Xi,Yi,es,ts,is,ss,ns,as,rs,os;Pi=new WeakMap;const cs=T("SensorConfigurationManager",{log:!1}),hs=["getSensorConfiguration","setSensorConfiguration"],ls=hs;class fs{constructor(){Ki.add(this),Xi.set(this,void 0),es.set(this,{}),J(this)}get addEventListener(){return this.eventDispatcher.addEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get configuration(){return t(this,es,"f")}async setConfiguration(e,i){if(i&&(e=Object.assign({...this.zeroSensorConfiguration},e)),cs.log({newSensorConfiguration:e}),t(this,Ki,"m",is).call(this,e))return void cs.log("redundant sensor configuration");const s=t(this,Ki,"m",rs).call(this,e);cs.log({setSensorConfigurationData:s});const n=this.waitForEvent("getSensorConfiguration");this.sendMessage([{type:"setSensorConfiguration",data:s.buffer}]),await n}static get ZeroSensorConfiguration(){return t(this,Qi,"f",os)}get zeroSensorConfiguration(){const e={};return t(this,Xi,"f").forEach((t=>{e[t]=0})),e}async clearSensorConfiguration(){return this.setConfiguration(this.zeroSensorConfiguration)}parseMessage(e,i){switch(cs.log({messageType:e}),e){case"getSensorConfiguration":case"setSensorConfiguration":const s=t(this,Ki,"m",ss).call(this,i);t(this,Ki,"m",ts).call(this,s);break;default:throw Error(`uncaught messageType ${e}`)}}}var gs,us,ds,ms,ps,vs,ws,ys,bs,Ss,Cs,Ms,Es,ks,Ds,Ws,Ts,Is,_s,Ls,Us,Rs,Fs,As,xs,$s,Os,Bs,Ns,Ps,Vs;Qi=fs,Xi=new WeakMap,es=new WeakMap,Ki=new WeakSet,Zi=function(){return this.eventDispatcher.dispatchEvent},Yi=function(e){cs.assertWithError(t(this,Xi,"f"),"must get initial sensorConfiguration");const i=t(this,Xi,"f")?.includes(e);return cs.log(i,`unavailable sensor type "${e}"`),i},ts=function(e){i(this,es,e,"f"),cs.log({updatedConfiguration:t(this,es,"f")}),t(this,Ki,"a",Zi).call(this,"getSensorConfiguration",{sensorConfiguration:this.configuration})},is=function(e){return Object.keys(e).every((t=>this.configuration[t]==e[t]))},ss=function(e){const t={};for(let i=0;i<e.byteLength;i+=3){const s=e.getUint8(i),n=qi[s],a=e.getUint16(i+1,!0);cs.log({sensorType:n,sensorRate:a}),n?t[n]=a:cs.warn(`unknown sensorType index ${s}`)}return cs.log({parsedSensorConfiguration:t}),i(this,Xi,Object.keys(t),"f"),t},ns=function(e){cs.assertTypeWithError(e,"number"),cs.assertWithError(e>=0,`sensorRate must be 0 or greater (got ${e})`),cs.assertWithError(e<65535,`sensorRate must be 0 or greater (got ${e})`),cs.assertWithError(e%5==0,"sensorRate must be multiple of 5")},as=function(e){t(Qi,Qi,"m",ns).call(Qi,e)},rs=function(e){let i=Object.keys(e);i=i.filter((e=>t(this,Ki,"m",Yi).call(this,e)));const s=new DataView(new ArrayBuffer(3*i.length));return i.forEach(((i,n)=>{Ji.AssertValidSensorType(i);const a=qi.indexOf(i);s.setUint8(3*n,a);const r=e[i];t(this,Ki,"m",as).call(this,r),s.setUint16(3*n+1,r,!0)})),cs.log({sensorConfigurationData:s}),s},os={value:{}},qi.forEach((e=>{t(Qi,Qi,"f",os)[e]=0}));const qs=T("TfliteManager",{log:!1}),zs=["getTfliteName","setTfliteName","getTfliteTask","setTfliteTask","getTfliteSampleRate","setTfliteSampleRate","getTfliteSensorTypes","setTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","setTfliteCaptureDelay","getTfliteThreshold","setTfliteThreshold","getTfliteInferencingEnabled","setTfliteInferencingEnabled","tfliteInference"],js=zs,Gs=["getTfliteName","getTfliteTask","getTfliteSampleRate","getTfliteSensorTypes","tfliteIsReady","getTfliteCaptureDelay","getTfliteThreshold","getTfliteInferencingEnabled"],Hs=["classification","regression"],Js=["pressure","linearAcceleration","gyroscope","magnetometer"];class Ks{constructor(){gs.add(this),ps.set(this,void 0),ys.set(this,void 0),Cs.set(this,void 0),ks.set(this,[]),Ts.set(this,void 0),Us.set(this,void 0),As.set(this,void 0),Os.set(this,void 0),Vs.set(this,void 0),J(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}get name(){return t(this,ps,"f")}async setName(e,t){if(qs.assertTypeWithError(e,"string"),this.name==e)return void qs.log(`redundant name assignment ${e}`);const i=this.waitForEvent("getTfliteName"),s=P.encode(e);this.sendMessage([{type:"setTfliteName",data:s.buffer}],t),await i}get task(){return t(this,ys,"f")}async setTask(e,i){if(t(this,gs,"m",us).call(this,e),this.task==e)return void qs.log(`redundant task assignment ${e}`);const s=this.waitForEvent("getTfliteTask"),n=Hs.indexOf(e);this.sendMessage([{type:"setTfliteTask",data:Uint8Array.from([n]).buffer}],i),await s}get sampleRate(){return t(this,Cs,"f")}async setSampleRate(e,i){if(qs.assertTypeWithError(e,"number"),e-=e%5,qs.assertWithError(e>=5,`sampleRate must be multiple of 5 greater than 0 (got ${e})`),t(this,Cs,"f")==e)return void qs.log(`redundant sampleRate assignment ${e}`);const s=this.waitForEvent("getTfliteSampleRate"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,e,!0),this.sendMessage([{type:"setTfliteSampleRate",data:n.buffer}],i),await s}static AssertValidSensorType(e){Ji.AssertValidSensorType(e);const t=e;qs.assertWithError(Js.includes(t),`invalid tflite sensorType "${e}"`)}get sensorTypes(){return t(this,ks,"f").slice()}async setSensorTypes(e,t){e.forEach((e=>{Ks.AssertValidSensorType(e)}));const i=this.waitForEvent("getTfliteSensorTypes");var s;const n=(e=(s=e).filter(((e,t)=>s.indexOf(e)==t))).map((e=>qi.indexOf(e))).sort();qs.log(e,n),this.sendMessage([{type:"setTfliteSensorTypes",data:Uint8Array.from(n).buffer}],t),await i}get isReady(){return t(this,Ts,"f")}get captureDelay(){return t(this,Us,"f")}async setCaptureDelay(e,i){if(qs.assertTypeWithError(e,"number"),t(this,Us,"f")==e)return void qs.log(`redundant captureDelay assignment ${e}`);const s=this.waitForEvent("getTfliteCaptureDelay"),n=new DataView(new ArrayBuffer(2));n.setUint16(0,e,!0),this.sendMessage([{type:"setTfliteCaptureDelay",data:n.buffer}],i),await s}get threshold(){return t(this,As,"f")}async setThreshold(e,i){if(qs.assertTypeWithError(e,"number"),qs.assertWithError(e>=0,`threshold must be positive (got ${e})`),t(this,As,"f")==e)return void qs.log(`redundant threshold assignment ${e}`);const s=this.waitForEvent("getTfliteThreshold"),n=new DataView(new ArrayBuffer(4));n.setFloat32(0,e,!0),this.sendMessage([{type:"setTfliteThreshold",data:n.buffer}],i),await s}get inferencingEnabled(){return t(this,Os,"f")}async setInferencingEnabled(e,i=!0){if(qs.assertTypeWithError(e,"boolean"),!e&&!this.isReady)return;if(t(this,gs,"m",Ls).call(this),t(this,Os,"f")==e)return void qs.log(`redundant inferencingEnabled assignment ${e}`);const s=this.waitForEvent("getTfliteInferencingEnabled");this.sendMessage([{type:"setTfliteInferencingEnabled",data:Uint8Array.from([Number(e)]).buffer}],i),await s}async toggleInferencingEnabled(){return this.setInferencingEnabled(!this.inferencingEnabled)}async enableInferencing(){this.inferencingEnabled||this.setInferencingEnabled(!0)}async disableInferencing(){this.inferencingEnabled&&this.setInferencingEnabled(!1)}parseMessage(e,i){switch(qs.log({messageType:e}),e){case"getTfliteName":case"setTfliteName":t(this,gs,"m",vs).call(this,i);break;case"getTfliteTask":case"setTfliteTask":t(this,gs,"m",bs).call(this,i);break;case"getTfliteSampleRate":case"setTfliteSampleRate":t(this,gs,"m",Ms).call(this,i);break;case"getTfliteSensorTypes":case"setTfliteSensorTypes":t(this,gs,"m",Ds).call(this,i);break;case"tfliteIsReady":t(this,gs,"m",Is).call(this,i);break;case"getTfliteCaptureDelay":case"setTfliteCaptureDelay":t(this,gs,"m",Rs).call(this,i);break;case"getTfliteThreshold":case"setTfliteThreshold":t(this,gs,"m",xs).call(this,i);break;case"getTfliteInferencingEnabled":case"setTfliteInferencingEnabled":t(this,gs,"m",Bs).call(this,i);break;case"tfliteInference":t(this,gs,"m",Ps).call(this,i);break;default:throw Error(`uncaught messageType ${e}`)}}get configuration(){return t(this,Vs,"f")}sendConfiguration(e,s){if(e==t(this,Vs,"f"))return void qs.log("redundant tflite configuration assignment");if(i(this,Vs,e,"f"),qs.log("assigned new tflite configuration",this.configuration),!this.configuration)return;const{name:n,task:a,captureDelay:r,sampleRate:o,threshold:c,sensorTypes:h}=this.configuration;this.setName(n,!1),this.setTask(a,!1),null!=r&&this.setCaptureDelay(r,!1),this.setSampleRate(o,!1),null!=c&&this.setThreshold(c,!1),this.setSensorTypes(h,s)}clear(){i(this,Vs,void 0,"f"),i(this,Os,!1,"f"),i(this,ks,[],"f"),i(this,Cs,0,"f"),i(this,Ts,!1,"f")}requestRequiredInformation(){qs.log("requesting required tflite information");const e=Gs.map((e=>({type:e})));this.sendMessage(e,!1)}}var Qs,Zs,Xs,Ys,en;ps=new WeakMap,ys=new WeakMap,Cs=new WeakMap,ks=new WeakMap,Ts=new WeakMap,Us=new WeakMap,As=new WeakMap,Os=new WeakMap,Vs=new WeakMap,gs=new WeakSet,us=function(e){qs.assertEnumWithError(e,Hs)},ds=function(e){qs.assertWithError(e in Hs,`invalid taskEnum ${e}`)},ms=function(){return this.eventDispatcher.dispatchEvent},vs=function(e){qs.log("parseName",e);const i=V.decode(e.buffer);t(this,gs,"m",ws).call(this,i)},ws=function(e){qs.log({name:e}),i(this,ps,e,"f"),t(this,gs,"a",ms).call(this,"getTfliteName",{tfliteName:e})},bs=function(e){qs.log("parseTask",e);const i=e.getUint8(0);t(this,gs,"m",ds).call(this,i);const s=Hs[i];t(this,gs,"m",Ss).call(this,s)},Ss=function(e){qs.log({task:e}),i(this,ys,e,"f"),t(this,gs,"a",ms).call(this,"getTfliteTask",{tfliteTask:e})},Ms=function(e){qs.log("parseSampleRate",e);const i=e.getUint16(0,!0);t(this,gs,"m",Es).call(this,i)},Es=function(e){qs.log({sampleRate:e}),i(this,Cs,e,"f"),t(this,gs,"a",ms).call(this,"getTfliteSampleRate",{tfliteSampleRate:e})},Ds=function(e){qs.log("parseSensorTypes",e);const i=[];for(let t=0;t<e.byteLength;t++){const s=e.getUint8(t),n=qi[s];n?Js.includes(n)?i.push(n):qs.error(`invalid tfliteSensorType ${n}`):qs.error(`invalid sensorTypeEnum ${s}`)}t(this,gs,"m",Ws).call(this,i)},Ws=function(e){qs.log({sensorTypes:e}),i(this,ks,e,"f"),t(this,gs,"a",ms).call(this,"getTfliteSensorTypes",{tfliteSensorTypes:e})},Is=function(e){qs.log("parseIsReady",e);const i=Boolean(e.getUint8(0));t(this,gs,"m",_s).call(this,i)},_s=function(e){qs.log({isReady:e}),i(this,Ts,e,"f"),t(this,gs,"a",ms).call(this,"tfliteIsReady",{tfliteIsReady:e})},Ls=function(){qs.assertWithError(this.isReady,"tflite is not ready")},Rs=function(e){qs.log("parseCaptureDelay",e);const i=e.getUint16(0,!0);t(this,gs,"m",Fs).call(this,i)},Fs=function(e){qs.log({captureDelay:e}),i(this,Us,e,"f"),t(this,gs,"a",ms).call(this,"getTfliteCaptureDelay",{tfliteCaptureDelay:e})},xs=function(e){qs.log("parseThreshold",e);const i=e.getFloat32(0,!0);t(this,gs,"m",$s).call(this,i)},$s=function(e){qs.log({threshold:e}),i(this,As,e,"f"),t(this,gs,"a",ms).call(this,"getTfliteThreshold",{tfliteThreshold:e})},Bs=function(e){qs.log("parseInferencingEnabled",e);const i=Boolean(e.getUint8(0));t(this,gs,"m",Ns).call(this,i)},Ns=function(e){qs.log({inferencingEnabled:e}),i(this,Os,e,"f"),t(this,gs,"a",ms).call(this,"getTfliteInferencingEnabled",{tfliteInferencingEnabled:e})},Ps=function(e){qs.log("parseInference",e);const i=Ge(e,0);qs.log({timestamp:i});const s=[];for(let t=0,i=2;i<e.byteLength;t++,i+=4){const t=e.getFloat32(i,!0);s.push(t)}qs.log("values",s);const n={timestamp:i,values:s};if("classification"==this.task){let e=0,i=0;if(s.forEach(((t,s)=>{t>e&&(e=t,i=s)})),qs.log({maxIndex:i,maxValue:e}),n.maxIndex=i,n.maxValue=e,t(this,Vs,"f")?.classes){const{classes:e}=t(this,Vs,"f");n.maxClass=e[i],n.classValues={},s.forEach(((t,i)=>{const s=e[i];n.classValues[s]=t}))}}t(this,gs,"a",ms).call(this,"tfliteInference",{tfliteInference:n})};const tn=T("DeviceInformationManager",{log:!1}),sn=["manufacturerName","modelNumber","hardwareRevision","firmwareRevision","softwareRevision","pnpId","serialNumber"],nn=[...sn,"deviceInformation"];class an{constructor(){Qs.add(this),Xs.set(this,{})}get information(){return t(this,Xs,"f")}clear(){i(this,Xs,{},"f")}parseMessage(e,i){switch(tn.log({messageType:e}),e){case"manufacturerName":const s=V.decode(i.buffer);tn.log({manufacturerName:s}),t(this,Qs,"m",en).call(this,{manufacturerName:s});break;case"modelNumber":const n=V.decode(i.buffer);tn.log({modelNumber:n}),t(this,Qs,"m",en).call(this,{modelNumber:n});break;case"softwareRevision":const a=V.decode(i.buffer);tn.log({softwareRevision:a}),t(this,Qs,"m",en).call(this,{softwareRevision:a});break;case"hardwareRevision":const r=V.decode(i.buffer);tn.log({hardwareRevision:r}),t(this,Qs,"m",en).call(this,{hardwareRevision:r});break;case"firmwareRevision":const o=V.decode(i.buffer);tn.log({firmwareRevision:o}),t(this,Qs,"m",en).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===i.getUint8(0)?"Bluetooth":"USB",productId:i.getUint16(3,!0),productVersion:i.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=i.getUint16(1,!0)),tn.log({pnpId:c}),t(this,Qs,"m",en).call(this,{pnpId:c});break;case"serialNumber":const h=V.decode(i.buffer);tn.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${e}`)}}}var rn,on,cn,hn,ln,fn,gn,un,dn,mn,pn,vn,wn,yn,bn,Sn,Cn,Mn;Xs=new WeakMap,Qs=new WeakSet,Zs=function(){return this.eventDispatcher.dispatchEvent},Ys=function(){return sn.filter((e=>"serialNumber"!=e)).every((e=>e in t(this,Xs,"f")))},en=function(e){tn.log({partialDeviceInformation:e});Object.keys(e).forEach((i=>{t(this,Qs,"a",Zs).call(this,i,{[i]:e[i]})})),Object.assign(t(this,Xs,"f"),e),tn.log({deviceInformation:t(this,Xs,"f")}),t(this,Qs,"a",Ys)&&(tn.log("completed deviceInformation"),t(this,Qs,"a",Zs).call(this,"deviceInformation",{deviceInformation:this.information}))};const En=T("InformationManager",{log:!1}),kn=["leftInsole","rightInsole","leftGlove","rightGlove","glasses","generic"],Dn=["left","right"],Wn=["isCharging","getBatteryCurrent","getMtu","getId","getName","setName","getType","setType","getCurrentTime","setCurrentTime"],Tn=Wn;class In{constructor(){rn.add(this),cn.set(this,!1),ln.set(this,void 0),gn.set(this,void 0),dn.set(this,""),mn.set(this,void 0),yn.set(this,0),Sn.set(this,!1),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}get isCharging(){return t(this,cn,"f")}get batteryCurrent(){return t(this,ln,"f")}async getBatteryCurrent(){En.log("getting battery current...");const e=this.waitForEvent("getBatteryCurrent");this.sendMessage([{type:"getBatteryCurrent"}]),await e}get id(){return t(this,gn,"f")}get name(){return t(this,dn,"f")}updateName(e){En.assertTypeWithError(e,"string"),i(this,dn,e,"f"),En.log({updatedName:t(this,dn,"f")}),t(this,rn,"a",on).call(this,"getName",{name:t(this,dn,"f")})}async setName(e){En.assertTypeWithError(e,"string"),En.assertRangeWithError("newName",e.length,2,30);const t=P.encode(e);En.log({setNameData:t});const i=this.waitForEvent("getName");this.sendMessage([{type:"setName",data:t.buffer}]),await i}get type(){return t(this,mn,"f")}get typeEnum(){return kn.indexOf(this.type)}updateType(e){t(this,rn,"m",pn).call(this,e),e!=this.type?(i(this,mn,e,"f"),En.log({updatedType:t(this,mn,"f")}),t(this,rn,"a",on).call(this,"getType",{type:t(this,mn,"f")})):En.log("redundant type assignment")}async setType(e){t(this,rn,"m",pn).call(this,e);const i=kn.indexOf(e);t(this,rn,"m",wn).call(this,i)}get isInsole(){switch(this.type){case"leftInsole":case"rightInsole":return!0;default:return!1}}get isGlove(){switch(this.type){case"leftGlove":case"rightGlove":return!0;default:return!1}}get side(){switch(this.type){case"leftInsole":case"leftGlove":default:return"left";case"rightInsole":case"rightGlove":return"right"}}get mtu(){return t(this,yn,"f")}get isCurrentTimeSet(){return t(this,Sn,"f")}parseMessage(e,i){switch(En.log({messageType:e}),e){case"isCharging":const s=Boolean(i.getUint8(0));En.log({isCharging:s}),t(this,rn,"m",hn).call(this,s);break;case"getBatteryCurrent":const n=i.getFloat32(0,!0);En.log({batteryCurrent:n}),t(this,rn,"m",fn).call(this,n);break;case"getId":const a=V.decode(i.buffer);En.log({id:a}),t(this,rn,"m",un).call(this,a);break;case"getName":case"setName":const r=V.decode(i.buffer);En.log({name:r}),this.updateName(r);break;case"getType":case"setType":const o=i.getUint8(0),c=kn[o];En.log({typeEnum:o,type:c}),this.updateType(c);break;case"getMtu":let h=i.getUint16(0,!0);"webSocket"!=this.connectionType&&"udp"!=this.connectionType&&(h=Math.min(h,512)),En.log({mtu:h}),t(this,rn,"m",bn).call(this,h);break;case"getCurrentTime":case"setCurrentTime":const l=Number(i.getBigUint64(0,!0));t(this,rn,"m",Cn).call(this,l);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){i(this,Sn,!1,"f")}}cn=new WeakMap,ln=new WeakMap,gn=new WeakMap,dn=new WeakMap,mn=new WeakMap,yn=new WeakMap,Sn=new WeakMap,rn=new WeakSet,on=function(){return this.eventDispatcher.dispatchEvent},hn=function(e){En.assertTypeWithError(e,"boolean"),i(this,cn,e,"f"),En.log({isCharging:t(this,cn,"f")}),t(this,rn,"a",on).call(this,"isCharging",{isCharging:t(this,cn,"f")})},fn=function(e){En.assertTypeWithError(e,"number"),i(this,ln,e,"f"),En.log({batteryCurrent:t(this,ln,"f")}),t(this,rn,"a",on).call(this,"getBatteryCurrent",{batteryCurrent:t(this,ln,"f")})},un=function(e){En.assertTypeWithError(e,"string"),i(this,gn,e,"f"),En.log({id:t(this,gn,"f")}),t(this,rn,"a",on).call(this,"getId",{id:t(this,gn,"f")})},pn=function(e){En.assertEnumWithError(e,kn)},vn=function(e){En.assertTypeWithError(e,"number"),En.assertWithError(e in kn,`invalid typeEnum ${e}`)},wn=async function(e){t(this,rn,"m",vn).call(this,e);const i=Uint8Array.from([e]);En.log({setTypeData:i});const s=this.waitForEvent("getType");this.sendMessage([{type:"setType",data:i.buffer}]),await s},bn=function(e){En.assertTypeWithError(e,"number"),t(this,yn,"f")!=e?(i(this,yn,e,"f"),t(this,rn,"a",on).call(this,"getMtu",{mtu:t(this,yn,"f")})):En.log("redundant mtu assignment",e)},Cn=function(e){En.log({currentTime:e}),i(this,Sn,0!=e||Math.abs(Date.now()-e)<je,"f"),t(this,Sn,"f")||t(this,rn,"m",Mn).call(this,!1)},Mn=async function(e){En.log("setting current time...");const t=new DataView(new ArrayBuffer(8));t.setBigUint64(0,BigInt(Date.now()),!0);const i=this.waitForEvent("getCurrentTime");this.sendMessage([{type:"setCurrentTime",data:t.buffer}],e),await i};const _n=["none","strongClick100","strongClick60","strongClick30","sharpClick100","sharpClick60","sharpClick30","softBump100","softBump60","softBump30","doubleClick100","doubleClick60","tripleClick100","softFuzz60","strongBuzz100","alert750ms","alert1000ms","strongClick1_100","strongClick2_80","strongClick3_60","strongClick4_30","mediumClick100","mediumClick80","mediumClick60","sharpTick100","sharpTick80","sharpTick60","shortDoubleClickStrong100","shortDoubleClickStrong80","shortDoubleClickStrong60","shortDoubleClickStrong30","shortDoubleClickMedium100","shortDoubleClickMedium80","shortDoubleClickMedium60","shortDoubleSharpTick100","shortDoubleSharpTick80","shortDoubleSharpTick60","longDoubleSharpClickStrong100","longDoubleSharpClickStrong80","longDoubleSharpClickStrong60","longDoubleSharpClickStrong30","longDoubleSharpClickMedium100","longDoubleSharpClickMedium80","longDoubleSharpClickMedium60","longDoubleSharpTick100","longDoubleSharpTick80","longDoubleSharpTick60","buzz100","buzz80","buzz60","buzz40","buzz20","pulsingStrong100","pulsingStrong60","pulsingMedium100","pulsingMedium60","pulsingSharp100","pulsingSharp60","transitionClick100","transitionClick80","transitionClick60","transitionClick40","transitionClick20","transitionClick10","transitionHum100","transitionHum80","transitionHum60","transitionHum40","transitionHum20","transitionHum10","transitionRampDownLongSmooth2_100","transitionRampDownLongSmooth1_100","transitionRampDownMediumSmooth1_100","transitionRampDownMediumSmooth2_100","transitionRampDownShortSmooth1_100","transitionRampDownShortSmooth2_100","transitionRampDownLongSharp1_100","transitionRampDownLongSharp2_100","transitionRampDownMediumSharp1_100","transitionRampDownMediumSharp2_100","transitionRampDownShortSharp1_100","transitionRampDownShortSharp2_100","transitionRampUpLongSmooth1_100","transitionRampUpLongSmooth2_100","transitionRampUpMediumSmooth1_100","transitionRampUpMediumSmooth2_100","transitionRampUpShortSmooth1_100","transitionRampUpShortSmooth2_100","transitionRampUpLongSharp1_100","transitionRampUpLongSharp2_100","transitionRampUpMediumSharp1_100","transitionRampUpMediumSharp2_100","transitionRampUpShortSharp1_100","transitionRampUpShortSharp2_100","transitionRampDownLongSmooth1_50","transitionRampDownLongSmooth2_50","transitionRampDownMediumSmooth1_50","transitionRampDownMediumSmooth2_50","transitionRampDownShortSmooth1_50","transitionRampDownShortSmooth2_50","transitionRampDownLongSharp1_50","transitionRampDownLongSharp2_50","transitionRampDownMediumSharp1_50","transitionRampDownMediumSharp2_50","transitionRampDownShortSharp1_50","transitionRampDownShortSharp2_50","transitionRampUpLongSmooth1_50","transitionRampUpLongSmooth2_50","transitionRampUpMediumSmooth1_50","transitionRampUpMediumSmooth2_50","transitionRampUpShortSmooth1_50","transitionRampUpShortSmooth2_50","transitionRampUpLongSharp1_50","transitionRampUpLongSharp2_50","transitionRampUpMediumSharp1_50","transitionRampUpMediumSharp2_50","transitionRampUpShortSharp1_50","transitionRampUpShortSharp2_50","longBuzz100","smoothHum50","smoothHum40","smoothHum30","smoothHum20","smoothHum10"];var Ln,Un,Rn,Fn,An,xn,$n,On,Bn,Nn,Pn,Vn,qn,zn,jn,Gn,Hn,Jn,Kn;const Qn=T("VibrationManager",{log:!1}),Zn=["front","rear"],Xn=["waveformEffect","waveform"],Yn=["getVibrationLocations","triggerVibration"],ea=Yn,ta=2550,ia=1270;class sa{constructor(){Ln.add(this),Jn.set(this,[]),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}async triggerVibration(e,i=!0){let s;e.forEach((e=>{const{type:i}=e;let n,{locations:a}=e;switch(a=a||this.vibrationLocations.slice(),a=a.filter((e=>this.vibrationLocations.includes(e))),i){case"waveformEffect":{const{segments:i,loopCount:s}=e;n=t(this,Ln,"m",zn).call(this,a,i,s)}break;case"waveform":{const{segments:i}=e;n=t(this,Ln,"m",jn).call(this,a,i)}break;default:throw Error(`invalid vibration type "${i}"`)}Qn.log({type:i,arrayBuffer:n}),s=z(s,n)})),await this.sendMessage([{type:"triggerVibration",data:s}],i)}get vibrationLocations(){return t(this,Jn,"f")}parseMessage(e,i){if(Qn.log({messageType:e}),"getVibrationLocations"!==e)throw Error(`uncaught messageType ${e}`);{const e=Array.from(new Uint8Array(i.buffer)).map((e=>Zn[e])).filter(Boolean);t(this,Ln,"m",Kn).call(this,e)}}}var na,aa,ra,oa,ca,ha,la,fa,ga,ua,da,ma,pa,va,wa,ya,ba;Jn=new WeakMap,Ln=new WeakSet,Un=function(){return this.eventDispatcher.dispatchEvent},Rn=function(e){Qn.assertTypeWithError(e,"string"),Qn.assertWithError(Zn.includes(e),`invalid location "${e}"`)},Fn=function(e){t(this,Ln,"m",xn).call(this,e),e.forEach((e=>{t(this,Ln,"m",Rn).call(this,e)}))},An=function(e){t(this,Ln,"m",Fn).call(this,e);let i=0;return e.forEach((e=>{const t=Zn.indexOf(e);i|=1<<t})),Qn.log({locationsBitmask:i}),Qn.assertWithError(i>0,"locationsBitmask must not be zero"),i},xn=function(e){Qn.assertWithError(Array.isArray(e),"passed non-array"),Qn.assertWithError(e.length>0,"passed empty array")},$n=function(e){Qn.assertWithError(_n.includes(e),`invalid waveformEffect "${e}"`)},On=function(e){if(null!=e.effect){const i=e.effect;t(this,Ln,"m",$n).call(this,i)}else{if(null==e.delay)throw Error("no effect or delay found in waveformEffectSegment");{const{delay:t}=e;Qn.assertWithError(t>=0,`delay must be 0ms or greater (got ${t})`),Qn.assertWithError(t<=ia,`delay must be 1270ms or less (got ${t})`)}}if(null!=e.loopCount){const{loopCount:i}=e;t(this,Ln,"m",Bn).call(this,i)}},Bn=function(e){Qn.assertTypeWithError(e,"number"),Qn.assertWithError(e>=0,`waveformEffectSegmentLoopCount must be 0 or greater (got ${e})`),Qn.assertWithError(e<=3,`waveformEffectSegmentLoopCount must be 3 or fewer (got ${e})`)},Nn=function(e){t(this,Ln,"m",xn).call(this,e),Qn.assertWithError(e.length<=8,`must have 8 waveformEffectSegments or fewer (got ${e.length})`),e.forEach((e=>{t(this,Ln,"m",On).call(this,e)}))},Pn=function(e){Qn.assertTypeWithError(e,"number"),Qn.assertWithError(e>=0,`waveformEffectSequenceLoopCount must be 0 or greater (got ${e})`),Qn.assertWithError(e<=6,`waveformEffectSequenceLoopCount must be 6 or fewer (got ${e})`)},Vn=function(e){Qn.assertTypeWithError(e.amplitude,"number"),Qn.assertWithError(e.amplitude>=0,`amplitude must be 0 or greater (got ${e.amplitude})`),Qn.assertWithError(e.amplitude<=1,`amplitude must be 1 or less (got ${e.amplitude})`),Qn.assertTypeWithError(e.duration,"number"),Qn.assertWithError(e.duration>0,`duration must be greater than 0ms (got ${e.duration}ms)`),Qn.assertWithError(e.duration<=ta,`duration must be 2550ms or less (got ${e.duration}ms)`)},qn=function(e){t(this,Ln,"m",xn).call(this,e),Qn.assertWithError(e.length<=20,`must have 20 waveformSegments or fewer (got ${e.length})`),e.forEach((e=>{t(this,Ln,"m",Vn).call(this,e)}))},zn=function(e,i,s=0){t(this,Ln,"m",Nn).call(this,i),t(this,Ln,"m",Pn).call(this,s);let n=[],a=0;const r=i.some((e=>{const{loopCount:t}=e;return null!=t&&t>0}))||0!=s;for(let e=0;e<i.length||r&&e<8;e++){const t=i[e]||{effect:"none"};if(null!=t.effect){const e=t.effect;n[a++]=_n.indexOf(e)}else{if(null==t.delay)throw Error("invalid waveformEffectSegment");{const{delay:e}=t;n[a++]=128|Math.floor(e/10)}}}const o=0!=s;for(let e=0;e<i.length||o&&e<8;e++){const t=i[e]?.loopCount||0;0!=e&&4!=e||(n[a]=0);const s=e%4*2;n[a]|=t<<s,3!=e&&7!=e||a++}0!=s&&(n[a++]=s);const c=new DataView(Uint8Array.from(n).buffer);return Qn.log({dataArray:n,dataView:c}),t(this,Ln,"m",Hn).call(this,e,"waveformEffect",c)},jn=function(e,i){t(this,Ln,"m",qn).call(this,i);const s=new DataView(new ArrayBuffer(2*i.length));return i.forEach(((e,t)=>{s.setUint8(2*t,Math.floor(127*e.amplitude)),s.setUint8(2*t+1,Math.floor(e.duration/10))})),Qn.log({dataView:s}),t(this,Ln,"m",Hn).call(this,e,"waveform",s)},Gn=function(e){Qn.assertTypeWithError(e,"string"),Qn.assertWithError(Xn.includes(e),`invalid vibrationType "${e}"`)},Hn=function(e,i,s){Qn.assertWithError(s?.byteLength>0,"no data received");const n=t(this,Ln,"m",An).call(this,e);t(this,Ln,"m",Gn).call(this,i);const a=Xn.indexOf(i);Qn.log({locationsBitmask:n,vibrationTypeIndex:a,dataView:s});const r=z(n,a,s.byteLength,s);return Qn.log({data:r}),r},Kn=function(e){i(this,Jn,e,"f"),Qn.log("vibrationLocations",e),t(this,Ln,"a",Un).call(this,"getVibrationLocations",{vibrationLocations:t(this,Jn,"f")})};const Sa=T("WifiManager",{log:!1}),Ca=["isWifiAvailable","getWifiSSID","setWifiSSID","getWifiPassword","setWifiPassword","getWifiConnectionEnabled","setWifiConnectionEnabled","isWifiConnected","ipAddress","isWifiSecure"],Ma=["getWifiSSID","getWifiPassword","getWifiConnectionEnabled","isWifiConnected","ipAddress","isWifiSecure"],Ea=Ca;class ka{constructor(){na.add(this),ra.set(this,!1),ha.set(this,""),fa.set(this,""),ua.set(this,void 0),ma.set(this,!1),va.set(this,void 0),ya.set(this,!1),J(this)}get waitForEvent(){return this.eventDispatcher.waitForEvent}requestRequiredInformation(){Sa.log("requesting required wifi information");const e=Ma.map((e=>({type:e})));this.sendMessage(e,!1)}get isWifiAvailable(){return t(this,ra,"f")}get wifiSSID(){return t(this,ha,"f")}async setWifiSSID(e){if(t(this,na,"m",ca).call(this),t(this,ua,"f"))return void Sa.error("cannot change ssid while wifi connection is enabled");Sa.assertTypeWithError(e,"string"),Sa.assertRangeWithError("wifiSSID",e.length,1,32);const i=P.encode(e);Sa.log({setWifiSSIDData:i});const s=this.waitForEvent("getWifiSSID");this.sendMessage([{type:"setWifiSSID",data:i.buffer}]),await s}get wifiPassword(){return t(this,fa,"f")}async setWifiPassword(e){if(t(this,na,"m",ca).call(this),t(this,ua,"f"))return void Sa.error("cannot change password while wifi connection is enabled");Sa.assertTypeWithError(e,"string"),e.length>0&&Sa.assertRangeWithError("wifiPassword",e.length,8,64);const i=P.encode(e);Sa.log({setWifiPasswordData:i});const s=this.waitForEvent("getWifiPassword");this.sendMessage([{type:"setWifiPassword",data:i.buffer}]),await s}get wifiConnectionEnabled(){return t(this,ua,"f")}async setWifiConnectionEnabled(e,i=!0){if(t(this,na,"m",ca).call(this),Sa.assertTypeWithError(e,"boolean"),t(this,ua,"f")==e)return void Sa.log(`redundant wifiConnectionEnabled assignment ${e}`);const s=this.waitForEvent("getWifiConnectionEnabled");this.sendMessage([{type:"setWifiConnectionEnabled",data:Uint8Array.from([Number(e)]).buffer}],i),await s}async toggleWifiConnection(){return this.setWifiConnectionEnabled(!this.wifiConnectionEnabled)}async enableWifiConnection(){return this.setWifiConnectionEnabled(!0)}async disableWifiConnection(){return this.setWifiConnectionEnabled(!1)}get isWifiConnected(){return t(this,ma,"f")}get ipAddress(){return t(this,va,"f")}get isWifiSecure(){return t(this,ya,"f")}parseMessage(e,i){switch(Sa.log({messageType:e}),e){case"isWifiAvailable":const s=Boolean(i.getUint8(0));Sa.log({isWifiAvailable:s}),t(this,na,"m",oa).call(this,s);break;case"getWifiSSID":case"setWifiSSID":const n=V.decode(i.buffer);Sa.log({ssid:n}),t(this,na,"m",la).call(this,n);break;case"getWifiPassword":case"setWifiPassword":const a=V.decode(i.buffer);Sa.log({password:a}),t(this,na,"m",ga).call(this,a);break;case"getWifiConnectionEnabled":case"setWifiConnectionEnabled":const r=Boolean(i.getUint8(0));Sa.log({enableWifiConnection:r}),t(this,na,"m",da).call(this,r);break;case"isWifiConnected":const o=Boolean(i.getUint8(0));Sa.log({isWifiConnected:o}),t(this,na,"m",pa).call(this,o);break;case"ipAddress":let c;4==i.byteLength&&(c=new Uint8Array(i.buffer.slice(0,4)).join(".")),Sa.log({ipAddress:c}),t(this,na,"m",wa).call(this,c);break;case"isWifiSecure":const h=Boolean(i.getUint8(0));Sa.log({isWifiSecure:h}),t(this,na,"m",ba).call(this,h);break;default:throw Error(`uncaught messageType ${e}`)}}clear(){i(this,ha,"","f"),i(this,fa,"","f"),i(this,va,"","f"),i(this,ma,!1,"f"),i(this,ra,!1,"f")}}var Da,Wa,Ta,Ia,_a,La,Ua,Ra,Fa,Aa,xa,$a;ra=new WeakMap,ha=new WeakMap,fa=new WeakMap,ua=new WeakMap,ma=new WeakMap,va=new WeakMap,ya=new WeakMap,na=new WeakSet,aa=function(){return this.eventDispatcher.dispatchEvent},oa=function(e){Sa.assertTypeWithError(e,"boolean"),i(this,ra,e,"f"),Sa.log({isWifiAvailable:t(this,ra,"f")}),t(this,na,"a",aa).call(this,"isWifiAvailable",{isWifiAvailable:t(this,ra,"f")})},ca=function(){Sa.assertWithError(t(this,ra,"f"),"wifi is not available")},la=function(e){Sa.assertTypeWithError(e,"string"),i(this,ha,e,"f"),Sa.log({wifiSSID:t(this,ha,"f")}),t(this,na,"a",aa).call(this,"getWifiSSID",{wifiSSID:t(this,ha,"f")})},ga=function(e){Sa.assertTypeWithError(e,"string"),i(this,fa,e,"f"),Sa.log({wifiPassword:t(this,fa,"f")}),t(this,na,"a",aa).call(this,"getWifiPassword",{wifiPassword:t(this,fa,"f")})},da=function(e){Sa.log({wifiConnectionEnabled:e}),i(this,ua,e,"f"),t(this,na,"a",aa).call(this,"getWifiConnectionEnabled",{wifiConnectionEnabled:e})},pa=function(e){Sa.assertTypeWithError(e,"boolean"),i(this,ma,e,"f"),Sa.log({isWifiConnected:t(this,ma,"f")}),t(this,na,"a",aa).call(this,"isWifiConnected",{isWifiConnected:t(this,ma,"f")})},wa=function(e){i(this,va,e,"f"),Sa.log({ipAddress:t(this,va,"f")}),t(this,na,"a",aa).call(this,"ipAddress",{ipAddress:t(this,va,"f")})},ba=function(e){Sa.assertTypeWithError(e,"boolean"),i(this,ya,e,"f"),Sa.log({isWifiSecure:t(this,ya,"f")}),t(this,na,"a",aa).call(this,"isWifiSecure",{isWifiSecure:t(this,ya,"f")})};const Oa=T("BaseConnectionManager",{log:!1}),Ba=["webBluetooth","noble","client","webSocket","udp"],Na=["notConnected","connecting","connected","disconnecting"],Pa=[...Na,"connectionStatus","isConnected"],Va=[...Wn,...hs,...ji,...Yn,...$e,...zs,...Ca,...ti,...xi],qa=["batteryLevel"],za=["rx","tx"],ja=[...qa,...sn,...za,...Va,"smp"];class Ga{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get canUpdateFirmware(){return!1}get type(){return this.baseConstructor.type}constructor(){Da.add(this),_a.set(this,"notConnected"),Ra.set(this,[]),Fa.set(this,!1),this.defaultMtu=23,this.mtu=this.defaultMtu,xa.set(this,new A(t(this,Da,"m",$a).bind(this),5e3)),t(this,Da,"m",Ia).call(this)}get status(){return t(this,_a,"f")}set status(e){Oa.assertEnumWithError(e,Na),t(this,_a,"f")!=e?(Oa.log(`new connection status "${e}"`),i(this,_a,e,"f"),this.onStatusUpdated(this.status),this.isConnected?t(this,xa,"f").start():t(this,xa,"f").stop(),"notConnected"==t(this,_a,"f")&&(this.mtu=this.defaultMtu)):Oa.log(`tried to assign same connection status "${e}"`)}get isConnected(){return"connected"==this.status}get isAvailable(){return!1}assertIsNotConnected(){Oa.assertWithError(!this.isConnected,"device is already connected")}assertIsConnected(){Oa.assertWithError(this.isConnected,"device is not connected")}assertIsConnectedAndNotDisconnecting(){this.assertIsConnected(),t(this,Da,"m",Ua).call(this)}async connect(){this.assertIsNotConnected(),t(this,Da,"m",La).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){this.assertIsNotConnected(),t(this,Da,"m",La).call(this),Oa.assertWithError(this.canReconnect,"unable to reconnect"),this.status="connecting",Oa.log("attempting to reconnect...")}async disconnect(){this.assertIsConnected(),t(this,Da,"m",Ua).call(this),this.status="disconnecting",Oa.log("disconnecting from device...")}async sendSmpMessage(e){this.assertIsConnectedAndNotDisconnecting(),Oa.log("sending smp message",e)}async sendTxMessages(e,s=!0){if(this.assertIsConnectedAndNotDisconnecting(),e&&(t(this,Ra,"f").push(...e),Oa.log(`appended ${e.length} messages`)),!s)return void Oa.log("not sending immediately - waiting until later");if(t(this,Fa,"f"))return void Oa.log("already sending messages - waiting until later");if(0==t(this,Ra,"f").length)return void Oa.log("no pendingMessages");i(this,Fa,!0,"f"),Oa.log("sendTxMessages",t(this,Ra,"f").slice());const n=t(this,Ra,"f").map((e=>{t(Wa,Wa,"m",Ta).call(Wa,e.type);const i=Va.indexOf(e.type),s=new DataView(new ArrayBuffer(2));return s.setUint16(0,e.data?.byteLength||0,!0),z(i,s,e.data)}));if(t(this,Ra,"f").length=0,this.mtu)for(;n.length>0;){if(n.every((e=>e.byteLength>this.mtu-3))){Oa.log("every arrayBuffer is too big to send");break}Oa.log("remaining arrayBuffers.length",n.length);let e=0,t=0;n.some((i=>{if(e+i.byteLength>this.mtu-3)return Oa.log(`stopping appending arrayBuffers ( length ${i.byteLength} too much)`),!0;Oa.log(`allowing arrayBuffer with length ${i.byteLength}`),t++,e+=i.byteLength}));const i=n.splice(0,t);Oa.log({arrayBufferCount:t,arrayBuffersToSend:i});const s=z(...i);Oa.log("sending arrayBuffer (partitioned)",s),await this.sendTxData(s)}else{const e=z(...n);Oa.log("sending arrayBuffer (all)",e),await this.sendTxData(e)}i(this,Fa,!1,"f"),this.sendTxMessages(void 0,!0)}async sendTxData(e){Oa.log("sendTxData",e)}parseRxMessage(e){bt(e,Va,t(this,Da,"m",Aa).bind(this),null,!0),this.onMessagesReceived()}clear(){i(this,Fa,!1,"f"),t(this,Ra,"f").length=0}remove(){this.clear(),this.onStatusUpdated=void 0,this.onMessageReceived=void 0,this.onMessagesReceived=void 0}}Wa=Ga,_a=new WeakMap,Ra=new WeakMap,Fa=new WeakMap,xa=new WeakMap,Da=new WeakSet,Ta=function(e){Oa.assertEnumWithError(e,Va)},Ia=function(){Oa.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},La=function(){Oa.assertWithError("connecting"!=this.status,"device is already connecting")},Ua=function(){Oa.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},Aa=function(e,t){Oa.log({messageType:e,dataView:t}),this.onMessageReceived(e,t)},$a=function(){this.isConnected||(Oa.log("timer detected disconnection"),this.status="notConnected")};const Ha=T("EventUtils",{log:!1});function Ja(e,t){let i=e.addEventListener||e.addListener||e.on||e.AddEventListener;Ha.assertWithError(i,"no add listener function found for target"),i=i.bind(e),Object.entries(t).forEach((([e,t])=>{i(e,t)}))}function Ka(e,t){let i=e.removeEventListener||e.removeListener||e.RemoveEventListener;Ha.assertWithError(i,"no remove listener function found for target"),i=i.bind(e),Object.entries(t).forEach((([e,t])=>{i(e,t)}))}const Qa=T("bluetoothUUIDs",{log:!1});if(n)var Za=window.BluetoothUUID;function Xa(e){return Qa.assertTypeWithError(e,"string"),Qa.assertWithError(4==e.length,"value must be 4 characters long"),`ea6d${e}-a725-4f9b-893d-c3913e33b39f`}function Ya(e){return Za?.getCharacteristic?.(e)}function er(e){return Za?.getService?.(e)}const tr=Object.freeze({services:{deviceInformation:{uuid:er("device_information"),characteristics:{manufacturerName:{uuid:Ya("manufacturer_name_string")},modelNumber:{uuid:Ya("model_number_string")},hardwareRevision:{uuid:Ya("hardware_revision_string")},firmwareRevision:{uuid:Ya("firmware_revision_string")},softwareRevision:{uuid:Ya("software_revision_string")},pnpId:{uuid:Ya("pnp_id")},serialNumber:{uuid:Ya("serial_number_string")}}},battery:{uuid:er("battery_service"),characteristics:{batteryLevel:{uuid:Ya("battery_level")}}},main:{uuid:Xa("0000"),characteristics:{rx:{uuid:Xa("1000")},tx:{uuid:Xa("1001")}}},smp:{uuid:"8d53dc1d-1db7-4cd3-868b-8a527460aa84",characteristics:{smp:{uuid:"da2e7828-fbce-4e01-ae9e-261174997c48"}}}}}),ir=[tr.services.main.uuid],sr=[tr.services.deviceInformation.uuid,tr.services.battery.uuid,tr.services.smp.uuid];function nr(e){e=e.toString().toLowerCase();return Object.keys(tr.services).find((t=>{let i=tr.services[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))}const ar=[],rr=[];function or(e){var t;return e=e.toString().toLowerCase(),Object.values(tr.services).some((i=>{const s=Object.keys(i.characteristics);return t=s.find((t=>{let s=i.characteristics[t].uuid.toString();return 4==e.length&&(s=s.slice(4,8)),e.includes("-")||(s=s.replaceAll("-","")),e==s}))})),t}function cr(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"rx":case"tx":case"smp":t.read=!1}switch(e){case"batteryLevel":case"rx":case"smp":t.notify=!0}if("smp"===e)t.writeWithoutResponse=!0;if("tx"===e)t.write=!0;return t}Object.values(tr.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((i=>{const s=e.characteristics[i];ir.includes(e.uuid)&&(ar.push(s.uuid),t.push(i)),rr.push(s.uuid)}))}),[]);const hr=T("BluetoothConnectionManager",{log:!1});class lr extends Ga{constructor(){super(...arguments),this.isInRange=!0}get isAvailable(){return!0}onCharacteristicValueChanged(e,t){"rx"==e?this.parseRxMessage(t):this.onMessageReceived?.(e,t)}async writeCharacteristic(e,t){hr.log("writeCharacteristic",...arguments)}async sendSmpMessage(e){super.sendSmpMessage(e),await this.writeCharacteristic("smp",e)}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&await this.writeCharacteristic("tx",e)}}var fr,gr,ur,dr,mr,pr,vr,wr,yr,br,Sr;const Cr=T("WebBluetoothConnectionManager",{log:!1});var Mr;n&&(Mr=window.navigator.bluetooth);class Er extends lr{constructor(){super(...arguments),fr.add(this),gr.set(this,{characteristicvaluechanged:t(this,fr,"m",yr).bind(this)}),ur.set(this,{gattserverdisconnected:t(this,fr,"m",Sr).bind(this)}),dr.set(this,void 0),mr.set(this,new Map),pr.set(this,new Map)}get bluetoothId(){return this.device.id}get canUpdateFirmware(){return t(this,pr,"f").has("smp")}static get isSupported(){return Boolean(Mr)}static get type(){return"webBluetooth"}get device(){return t(this,dr,"f")}set device(e){t(this,dr,"f")!=e?(t(this,dr,"f")&&Ka(t(this,dr,"f"),t(this,ur,"f")),e&&Ja(e,t(this,ur,"f")),i(this,dr,e,"f")):Cr.log("tried to assign the same BluetoothDevice")}get server(){return t(this,dr,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const e=await Mr.requestDevice({filters:[{services:ir}],optionalServices:n?sr:[]});Cr.log("got BluetoothDevice"),this.device=e,Cr.log("connecting to device...");const i=await this.server.connect();Cr.log(`connected to device? ${i.connected}`),await t(this,fr,"m",vr).call(this),Cr.log("fully connected"),this.status="connected"}catch(e){Cr.error(e),this.status="notConnected",this.server?.disconnect(),t(this,fr,"m",wr).call(this)}}async disconnect(){await t(this,fr,"m",wr).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(e,i){super.writeCharacteristic(e,i);const s=t(this,pr,"f").get(e);Cr.assertWithError(s,`${e} characteristic not found`),Cr.log("writing characteristic",s,i);const n=s.properties||cr(e);n.writeWithoutResponse?(Cr.log("writing without response"),await s.writeValueWithoutResponse(i)):(Cr.log("writing with response"),await s.writeValueWithResponse(i)),Cr.log("wrote characteristic"),n.read&&!n.notify&&(Cr.log("reading value after write..."),await s.readValue(),(c||h)&&t(this,fr,"m",br).call(this,s))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect();try{await this.server.connect()}catch(e){Cr.error(e),this.isInRange=!1}this.isConnected?(Cr.log("successfully reconnected!"),await t(this,fr,"m",vr).call(this),this.status="connected"):(Cr.log("unable to reconnect"),this.status="notConnected")}remove(){super.remove(),this.device=void 0}}gr=new WeakMap,ur=new WeakMap,dr=new WeakMap,mr=new WeakMap,pr=new WeakMap,fr=new WeakSet,vr=async function(){t(this,fr,"m",wr).call(this),Cr.log("getting services...");const e=await this.server.getPrimaryServices();Cr.log("got services",e.length),Cr.log("getting characteristics...");for(const i in e){const s=e[i];Cr.log({service:s});const n=nr(s.uuid);Cr.assertWithError(n,`no name found for service uuid "${s.uuid}"`),Cr.log(`got "${n}" service`),s.name=n,t(this,mr,"f").set(n,s),Cr.log(`getting characteristics for "${n}" service`);const a=await s.getCharacteristics();Cr.log(`got characteristics for "${n}" service`);for(const e in a){const i=a[e];Cr.log({characteristic:i});const s=or(i.uuid);Cr.assertWithError(Boolean(s),`no name found for characteristic uuid "${i.uuid}" in "${n}" service`),Cr.log(`got "${s}" characteristic in "${n}" service`),i.name=s,t(this,pr,"f").set(s,i),Ja(i,t(this,gr,"f"));const r=i.properties||cr(s);r.notify&&(Cr.log(`starting notifications for "${s}" characteristic`),await i.startNotifications()),r.read&&(Cr.log(`reading "${s}" characteristic...`),await i.readValue(),(c||h)&&t(this,fr,"m",br).call(this,i))}}},wr=async function(){this.device&&Ka(this.device,t(this,ur,"f"));const e=Array.from(t(this,pr,"f").keys()).map((e=>{const i=t(this,pr,"f").get(e);Ka(i,t(this,gr,"f"));if((i.properties||cr(e)).notify)return Cr.log(`stopping notifications for "${e}" characteristic`),i.stopNotifications()}));return Promise.allSettled(e)},yr=function(e){Cr.log("oncharacteristicvaluechanged");const i=e.target;t(this,fr,"m",br).call(this,i)},br=function(e){Cr.log("onCharacteristicValue");const t=e.name;Cr.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),Cr.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const i=e.value;Cr.assertWithError(i,`no data found for "${t}" characteristic`),Cr.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(i.buffer)));try{this.onCharacteristicValueChanged(t,i)}catch(e){Cr.error(e)}},Sr=function(){Cr.log("gattserverdisconnected"),this.status="notConnected"};const kr=4294967296,Dr=9007199254740992;const Wr={encode:function(e){let t,i=new ArrayBuffer(256),s=new DataView(i),n=0;function a(e){let a=i.byteLength;const r=n+e;for(;a<r;)a<<=1;if(a!==i.byteLength){const e=s;i=new ArrayBuffer(a),s=new DataView(i);const t=n+3>>2;for(let i=0;i<t;++i)s.setUint32(i<<2,e.getUint32(i<<2))}return t=e,s}function r(){n+=t}function o(e){r(a(1).setUint8(n,e))}function c(e){const t=a(e.length);for(let i=0;i<e.length;++i)t.setUint8(n+i,e[i]);r()}function h(e,t){t<24?o(e<<5|t):t<256?(o(e<<5|24),o(t)):t<65536?(o(e<<5|25),function(e){r(a(2).setUint16(n,e))}(t)):t<4294967296?(o(e<<5|26),function(e){r(a(4).setUint32(n,e))}(t)):(o(e<<5|27),function(e){const t=e%kr,i=(e-t)/kr,s=a(8);s.setUint32(n,i),s.setUint32(n+4,t),r()}(t))}if(function e(t){let i;const s=[];let l;if(!1===t)return o(244);if(!0===t)return o(245);if(null===t)return o(246);if(void 0===t)return o(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(t>=0&&t<=Dr)return h(0,t);if(-Dr<=t&&t<0)return h(1,-(t+1))}return o(251),function(e){r(a(8).setFloat64(n,e))}(t);case"string":for(i=0;i<t.length;++i){let e=t.charCodeAt(i);e<128?s.push(e):e<2048?(s.push(192|e>>6),s.push(128|63&e)):e<55296?(s.push(224|e>>12),s.push(128|e>>6&63),s.push(128|63&e)):(e=(1023&e)<<10,e|=1023&t.charCodeAt(++i),e+=65536,s.push(240|e>>18),s.push(128|e>>12&63),s.push(128|e>>6&63),s.push(128|63&e))}return h(3,s.length),c(s);default:if(Array.isArray(t))for(l=t.length,h(4,l),i=0;i<l;++i)e(t[i]);else if(t instanceof Uint8Array)h(2,t.length),c(t);else{const s=Object.keys(t);for(l=s.length,h(5,l),i=0;i<l;++i){const n=s[i];e(n),e(t[n])}}}}(e),"slice"in i)return i.slice(0,n);const l=new ArrayBuffer(n),f=new DataView(l);for(let e=0;e<n;++e)f.setUint8(e,s.getUint8(e));return l},decode:function(e,t,i){const s=new DataView(e);let n=0;function a(e,t){return n+=e,t}function r(t){return a(t,new Uint8Array(e,n,t))}function o(){return a(1,s.getUint8(n))}function c(){return a(2,s.getUint16(n))}function h(){return a(4,s.getUint32(n))}function l(){return 255===s.getUint8(n)&&(n+=1,!0)}function f(e){if(e<24)return e;if(24===e)return o();if(25===e)return c();if(26===e)return h();if(27===e)return h()*kr+h();if(31===e)return-1;throw new Error("Invalid length encoding")}function g(e){const t=o();if(255===t)return-1;const i=f(31&t);if(i<0||t>>5!==e)throw new Error("Invalid indefinite length element");return i}function u(e,t){for(let i=0;i<t;++i){let i=o();128&i&&(i<224?(i=(31&i)<<6|63&o(),t-=1):i<240?(i=(15&i)<<12|(63&o())<<6|63&o(),t-=2):(i=(15&i)<<18|(63&o())<<12|(63&o())<<6|63&o(),t-=3)),i<65536?e.push(i):(i-=65536,e.push(55296|i>>10),e.push(56320|1023&i))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof i&&(i=function(){});const d=function e(){const h=o(),d=h>>5,m=31&h;let p,v;if(7===d)switch(m){case 25:return function(){const e=new ArrayBuffer(4),t=new DataView(e),i=c(),s=32768&i;let n=31744&i;const a=1023&i;if(31744===n)n=261120;else if(0!==n)n+=114688;else if(0!==a)return(s?-1:1)*a*5.960464477539063e-8;return t.setUint32(0,s<<16|n<<13|a<<13),t.getFloat32(0)}();case 26:return a(4,s.getFloat32(n));case 27:return a(8,s.getFloat64(n))}if(v=f(m),v<0&&(d<2||d>6))throw new Error("Invalid length");const w=[];let y;const b={};switch(d){case 0:return v;case 1:return-1-v;case 2:if(v<0){const e=[];let t=0;for(;(v=g(d))>=0;)t+=v,e.push(r(v));const i=new Uint8Array(t);let s=0;for(p=0;p<e.length;++p)i.set(e[p],s),s+=e[p].length;return i}return r(v);case 3:if(v<0)for(;(v=g(d))>=0;)u(w,v);else u(w,v);return String.fromCharCode.apply(null,w);case 4:if(v<0)for(y=[];!l();)y.push(e());else for(y=new Array(v),p=0;p<v;++p)y[p]=e();return y;case 5:for(p=0;p<v||v<0&&!l();++p){b[e()]=e()}return b;case 6:return t(e(),v);case 7:switch(v){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return i(v)}}}();if(n!==e.byteLength)throw new Error("Remaining bytes");return d}},Tr=T("mcumgr",{log:!1}),Ir=0,_r=1,Lr=2,Ur=3,Rr=0,Fr=1,Ar=8,xr=0,$r=2,Or=3,Br=5,Nr=0,Pr=1,Vr=5,qr=0;class zr{constructor(){this._mtu=256,this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}onMessage(e){return this._messageCallback=e,this}onImageUploadNext(e){return this._imageUploadNextCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}onFileUploadNext(e){return this._fileUploadNextCallback=e,this}onFileUploadProgress(e){return this._fileUploadProgressCallback=e,this}onFileUploadFinished(e){return this._fileUploadFinishedCallback=e,this}onFileDownloadNext(e){return this._fileDownloadNextCallback=e,this}onFileDownloadProgress(e){return this._fileDownloadProgressCallback=e,this}onFileDownloadFinished(e){return this._fileDownloadFinishedCallback=e,this}_getMessage(e,t,i,s){let n=[];void 0!==s&&(n=[...new Uint8Array(Wr.encode(s))]);const a=255&n.length,r=[e,0,n.length>>8,a,t>>8,255&t,this._seq,i,...n];return this._seq=(this._seq+1)%256,r}_notification(e){Tr.log("mcumgr - message received");const t=new Uint8Array(e);this._buffer=new Uint8Array([...this._buffer,...t]);const i=256*this._buffer[2]+this._buffer[3];this._buffer.length<i+8||(this._processMessage(this._buffer.slice(0,i+8)),this._buffer=this._buffer.slice(i+8))}_processMessage(e){const[t,,i,s,n,a,,r]=e,o=Wr.decode(e.slice(8).buffer),c=256*i+s,h=256*n+a;return Tr.log("mcumgr - Process Message - Group: "+h+", Id: "+r+", Off: "+o.off),h===Fr&&r===Pr&&o.off?(this._uploadOffset=o.off,void this._uploadNext()):t===Ur&&h===Ar&&r===qr&&o.off?(this._uploadFileOffset=o.off,void this._uploadFileNext()):t===_r&&h===Ar&&r===qr?(this._downloadFileOffset+=o.data.length,null!=o.len&&(this._downloadFileLength=o.len),Tr.log("downloaded "+this._downloadFileOffset+" bytes of "+this._downloadFileLength),this._downloadFileLength>0&&this._fileDownloadProgressCallback({percentage:Math.floor(this._downloadFileOffset/this._downloadFileLength*100)}),this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}),void this._downloadFileNext()):void(this._messageCallback&&this._messageCallback({op:t,group:h,id:r,data:o,length:c}))}cmdReset(){return this._getMessage(Lr,Rr,Br)}smpEcho(e){return this._getMessage(Lr,Rr,xr,{d:e})}cmdImageState(){return this._getMessage(Ir,Fr,Nr)}cmdImageErase(){return this._getMessage(Lr,Fr,Vr,{})}cmdImageTest(e){return this._getMessage(Lr,Fr,Nr,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._getMessage(Lr,Fr,Nr,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(!this._uploadImage)return;if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-Wr.encode(e).byteLength-8-3-5;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t;const i=this._getMessage(Lr,Fr,Pr,e);Tr.log("mcumgr - _uploadNext: Message Length: "+i.length),this._imageUploadNextCallback({packet:i})}async reset(){this._messageCallback=null,this._imageUploadProgressCallback=null,this._imageUploadNextCallback=null,this._fileUploadProgressCallback=null,this._fileUploadNextCallback=null,this._uploadIsInProgress=!1,this._downloadIsInProgress=!1,this._buffer=new Uint8Array,this._seq=0}async cmdUpload(e,t=0){this._uploadIsInProgress?Tr.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async cmdUploadFile(e,t){this._uploadIsInProgress?Tr.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadFileOffset=0,this._uploadFile=e,this._uploadFilename=t,this._uploadFileNext())}async _uploadFileNext(){if(Tr.log("uploadFileNext - offset: "+this._uploadFileOffset+", length: "+this._uploadFile.byteLength),this._uploadFileOffset>=this._uploadFile.byteLength)return this._uploadIsInProgress=!1,void this._fileUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadFileOffset};0===this._uploadFileOffset&&(e.len=this._uploadFile.byteLength),e.name=this._uploadFilename,this._fileUploadProgressCallback({percentage:Math.floor(this._uploadFileOffset/this._uploadFile.byteLength*100)});const t=this._mtu-Wr.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadFile.slice(this._uploadFileOffset,this._uploadFileOffset+t)),this._uploadFileOffset+=t;const i=this._getMessage(Lr,Ar,qr,e);Tr.log("mcumgr - _uploadNext: Message Length: "+i.length),this._fileUploadNextCallback({packet:i})}async cmdDownloadFile(e,t){this._downloadIsInProgress?Tr.error("Download is already in progress."):(this._downloadIsInProgress=!0,this._downloadFileOffset=0,this._downloadFileLength=0,this._downloadRemoteFilename=e,this._downloadLocalFilename=t,this._downloadFileNext())}async _downloadFileNext(){if(this._downloadFileLength>0&&this._downloadFileOffset>=this._downloadFileLength)return this._downloadIsInProgress=!1,void this._fileDownloadFinishedCallback();const e={off:this._downloadFileOffset};0===this._downloadFileOffset&&(e.name=this._downloadRemoteFilename);const t=this._getMessage(Ir,Ar,qr,e);Tr.log("mcumgr - _downloadNext: Message Length: "+t.length),this._fileDownloadNextCallback({packet:t})}async imageInfo(e){const t={},i=new Uint8Array(e);if(i.length<32)throw new Error("Invalid image (too short file)");if(61!==i[0]||184!==i[1]||243!==i[2]||150!==i[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==i[4]||0!==i[5]||0!==i[6]||0!==i[7])throw new Error("Invalid image (wrong load address)");const s=i[8]+256*i[9];if(0!==i[10]||0!==i[11])throw new Error("Invalid image (wrong protected TLV area size)");const n=i[12]+256*i[13]+65536*i[14]+i[15]*2**24;if(t.imageSize=n,i.length<n+s)throw new Error("Invalid image (wrong image size)");if(0!==i[16]||0!==i[17]||0!==i[18]||0!==i[19])throw new Error("Invalid image (wrong flags)");const a=`${i[20]}.${i[21]}.${i[22]+256*i[23]}`;return t.version=a,t.hash=[...new Uint8Array(await this._hash(e.slice(0,n+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}var jr,Gr,Hr,Jr,Kr,Qr,Zr,Xr,Yr,eo,to,io,so,no,ao,ro,oo,co,ho,lo,fo;const go=T("FirmwareManager",{log:!1}),uo=["smp"],mo=[...uo,"firmwareImages","firmwareUploadProgress","firmwareStatus","firmwareUploadComplete"],po=["idle","uploading","uploaded","pending","testing","erasing"];class vo{constructor(){jr.add(this),Hr.set(this,"idle"),Kr.set(this,void 0),Xr.set(this,void 0),Yr.set(this,new zr),t(this,jr,"m",eo).call(this),J(this)}get addEventListenter(){return this.eventDispatcher.addEventListener}get removeEventListener(){return this.eventDispatcher.removeEventListener}get waitForEvent(){return this.eventDispatcher.waitForEvent}parseMessage(e,i){if(go.log({messageType:e}),"smp"!==e)throw Error(`uncaught messageType ${e}`);t(this,Yr,"f")._notification(Array.from(new Uint8Array(i.buffer))),t(this,jr,"a",Gr).call(this,"smp",{dataView:i})}async uploadFirmware(e){go.log("uploadFirmware",e);const i=this.waitForEvent("firmwareUploadComplete");await this.getImages();const s=await H(e),n=await t(this,Yr,"f").imageInfo(s);go.log({imageInfo:n}),t(this,Yr,"f").cmdUpload(s,1),t(this,jr,"m",Jr).call(this,"uploading"),await i}get status(){return t(this,Hr,"f")}get images(){return t(this,Kr,"f")}async getImages(){const e=this.waitForEvent("firmwareImages");go.log("getting firmware image state..."),this.sendMessage(Uint8Array.from(t(this,Yr,"f").cmdImageState()).buffer),await e}async testImage(e=1){if(t(this,jr,"m",Zr).call(this,e),t(this,jr,"m",Qr).call(this),!t(this,Kr,"f")[e])return void go.log(`image ${e} not found`);if(1==t(this,Kr,"f")[e].pending)return void go.log(`image ${e} is already pending`);if(t(this,Kr,"f")[e].empty)return void go.log(`image ${e} is empty`);const i=this.waitForEvent("smp");go.log("testing firmware image..."),this.sendMessage(Uint8Array.from(t(this,Yr,"f").cmdImageTest(t(this,Kr,"f")[e].hash)).buffer),await i}async eraseImage(){t(this,jr,"m",Qr).call(this);const e=this.waitForEvent("smp");go.log("erasing image..."),this.sendMessage(Uint8Array.from(t(this,Yr,"f").cmdImageErase()).buffer),t(this,jr,"m",Jr).call(this,"erasing"),await e,await this.getImages()}async confirmImage(e=0){if(t(this,jr,"m",Zr).call(this,e),t(this,jr,"m",Qr).call(this),!0===t(this,Kr,"f")[e].confirmed)return void go.log(`image ${e} is already confirmed`);const i=this.waitForEvent("smp");go.log("confirming image..."),this.sendMessage(Uint8Array.from(t(this,Yr,"f").cmdImageConfirm(t(this,Kr,"f")[e].hash)).buffer),await i}async echo(e){go.assertTypeWithError(e,"string");const i=this.waitForEvent("smp");go.log("sending echo..."),this.sendMessage(Uint8Array.from(t(this,Yr,"f").smpEcho(e)).buffer),await i}async reset(){const e=this.waitForEvent("smp");go.log("resetting..."),this.sendMessage(Uint8Array.from(t(this,Yr,"f").cmdReset()).buffer),await e}get mtu(){return t(this,Xr,"f")}set mtu(e){i(this,Xr,e,"f"),t(this,Yr,"f")._mtu=e}}var wo,yo,bo,So,Co,Mo,Eo,ko,Do,Wo,To,Io,_o,Lo,Uo,Ro,Fo,Ao;Hr=new WeakMap,Kr=new WeakMap,Xr=new WeakMap,Yr=new WeakMap,jr=new WeakSet,Gr=function(){return this.eventDispatcher.dispatchEvent},Jr=function(e){go.assertEnumWithError(e,po),t(this,Hr,"f")!=e?(i(this,Hr,e,"f"),go.log({firmwareStatus:t(this,Hr,"f")}),t(this,jr,"a",Gr).call(this,"firmwareStatus",{firmwareStatus:t(this,Hr,"f")})):go.log(`redundant firmwareStatus assignment "${e}"`)},Qr=function(){go.assertWithError(t(this,Kr,"f"),"didn't get imageState")},Zr=function(e){go.assertTypeWithError(e,"number"),go.assertWithError(0==e||1==e,"imageIndex must be 0 or 1")},eo=function(){t(this,Yr,"f").onMessage(t(this,jr,"m",to).bind(this)),t(this,Yr,"f").onFileDownloadNext(t(this,jr,"m",io)),t(this,Yr,"f").onFileDownloadProgress(t(this,jr,"m",so).bind(this)),t(this,Yr,"f").onFileDownloadFinished(t(this,jr,"m",no).bind(this)),t(this,Yr,"f").onFileUploadNext(t(this,jr,"m",ao).bind(this)),t(this,Yr,"f").onFileUploadProgress(t(this,jr,"m",ro).bind(this)),t(this,Yr,"f").onFileUploadFinished(t(this,jr,"m",oo).bind(this)),t(this,Yr,"f").onImageUploadNext(t(this,jr,"m",co).bind(this)),t(this,Yr,"f").onImageUploadProgress(t(this,jr,"m",ho).bind(this)),t(this,Yr,"f").onImageUploadFinished(t(this,jr,"m",lo).bind(this))},to=function({op:e,group:i,id:s,data:n,length:a}){switch(go.log("onMcuMessage",...arguments),i){case Rr:switch(s){case xr:go.log(`echo "${n.r}"`);break;case $r:go.table(n.tasks);break;case Or:go.log(n)}break;case Fr:if(s===Nr)t(this,jr,"m",fo).call(this,n);break;default:throw Error(`uncaught mcuMessage group ${i}`)}},io=function(){go.log("onMcuFileDownloadNext",...arguments)},so=function(){go.log("onMcuFileDownloadProgress",...arguments)},no=function(){go.log("onMcuFileDownloadFinished",...arguments)},ao=function(){go.log("onMcuFileUploadNext")},ro=function(){go.log("onMcuFileUploadProgress")},oo=function(){go.log("onMcuFileUploadFinished")},co=function({packet:e}){go.log("onMcuImageUploadNext"),this.sendMessage(Uint8Array.from(e).buffer)},ho=function({percentage:e}){const i=e/100;go.log("onMcuImageUploadProgress",...arguments),t(this,jr,"a",Gr).call(this,"firmwareUploadProgress",{progress:i})},lo=async function(){go.log("onMcuImageUploadFinished",...arguments),await this.getImages(),t(this,jr,"a",Gr).call(this,"firmwareUploadProgress",{progress:100}),t(this,jr,"a",Gr).call(this,"firmwareUploadComplete",{})},fo=function({images:e}){if(!e)return void go.log("no images found");i(this,Kr,e,"f"),go.log("images",t(this,Kr,"f"));let s="idle";2==t(this,Kr,"f").length&&(t(this,Kr,"f")[1].bootable?t(this,Kr,"f")[0].confirmed?t(this,Kr,"f")[1].pending?(go.log("reset to upload to the new firmware image"),s="pending"):(go.log("Slot 1 has a valid image. run testImage() to test it or upload a different image."),s="uploaded"):(go.log('Slot 0 has a valid image. Click "Confirm Image" to confirm it or wait and the device will swap images back.'),s="testing"):go.warn('Slot 1 has a invalid image. Click "Erase Image" to erase it or upload a different image')),1==t(this,Kr,"f").length&&(t(this,Kr,"f").push({slot:1,empty:!0,version:"Empty",pending:!1,confirmed:!1,bootable:!1,active:!1,permanent:!1}),go.log("Select a firmware upload image to upload to slot 1.")),t(this,jr,"m",Jr).call(this,s),t(this,jr,"a",Gr).call(this,"firmwareImages",{firmwareImages:t(this,Kr,"f")})};const xo=T("DeviceManager",{log:!1}),$o=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class Oo{constructor(){if(wo.add(this),yo.set(this,{getType:t(this,wo,"m",bo).bind(this),isConnected:t(this,wo,"m",Ro).bind(this)}),So.set(this,[]),Co.set(this,!1),Mo.set(this,{devices:[]}),Eo.set(this,void 0),Do.set(this,"BS.Device"),_o.set(this,[]),Lo.set(this,new _(this,$o)),Oo.shared&&this!=Oo.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(e){Ja(e,t(this,yo,"f"))}OnDeviceConnectionStatusUpdated(e,i){if("notConnected"==i&&!e.canReconnect&&t(this,_o,"f").includes(e)){const i=t(this,_o,"f").indexOf(e);this.AvailableDevices.splice(i,1),t(this,wo,"m",Fo).call(this)}}get ConnectedDevices(){return t(this,So,"f")}get UseLocalStorage(){return t(this,Co,"f")}set UseLocalStorage(e){t(this,wo,"m",ko).call(this),xo.assertTypeWithError(e,"boolean"),i(this,Co,e,"f"),t(this,Co,"f")&&!t(this,Eo,"f")&&t(this,wo,"m",To).call(this)}get CanUseLocalStorage(){return n&&window.localStorage}get AvailableDevices(){return t(this,_o,"f")}get CanGetDevices(){return n&&navigator.bluetooth?.getDevices}async GetDevices(){if(!n)return void xo.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void xo.warn("bluetooth is not available in this browser");if(c)return void xo.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void xo.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void xo.log("CanGetDevices is false");t(this,Eo,"f")||t(this,wo,"m",To).call(this);const e=t(this,Eo,"f");if(!e.devices||0==e.devices.length)return void xo.log("no devices found in configuration");const i=await navigator.bluetooth.getDevices();return xo.log({bluetoothDevices:i}),i.forEach((i=>{if(!i.gatt)return;let s=e.devices.find((e=>i.id==e.bluetoothId));if(!s)return;let n=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==i.id));const a=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==i.id));if(a)return void(n&&n?.bluetoothId==a.bluetoothId&&n!=a&&(this.AvailableDevices[t(this,_o,"f").indexOf(a)]=n));if(n)return void this.AvailableDevices.push(n);const r=new ch,o=new Er;o.device=i,i.name&&r._informationManager.updateName(i.name),r._informationManager.updateType(s.type),r.connectionManager=o,this.AvailableDevices.push(r)})),t(this,wo,"m",Fo).call(this),this.AvailableDevices}get AddEventListener(){return t(this,Lo,"f").addEventListener}get RemoveEventListener(){return t(this,Lo,"f").removeEventListener}get RemoveEventListeners(){return t(this,Lo,"f").removeEventListeners}get RemoveAllEventListeners(){return t(this,Lo,"f").removeAllEventListeners}_CheckDeviceAvailability(e){e.isConnected||e.isAvailable||!t(this,_o,"f").includes(e)||(xo.log("removing device from availableDevices..."),t(this,_o,"f").splice(t(this,_o,"f").indexOf(e),1),t(this,wo,"m",Fo).call(this))}}yo=new WeakMap,So=new WeakMap,Co=new WeakMap,Mo=new WeakMap,Eo=new WeakMap,Do=new WeakMap,_o=new WeakMap,Lo=new WeakMap,wo=new WeakSet,bo=function(e){t(this,Co,"f")&&t(this,wo,"m",Io).call(this,e.target)},ko=function(){xo.assertWithError(n,"localStorage is only available in the browser"),xo.assertWithError(window.localStorage,"localStorage not found")},Wo=function(){t(this,wo,"m",ko).call(this),localStorage.setItem(t(this,Do,"f"),JSON.stringify(t(this,Eo,"f")))},To=async function(){t(this,wo,"m",ko).call(this);let e=localStorage.getItem(t(this,Do,"f"));if("string"!=typeof e)return xo.log("no info found in localStorage"),i(this,Eo,Object.assign({},t(this,Mo,"f")),"f"),void t(this,wo,"m",Wo).call(this);try{const t=JSON.parse(e);xo.log({configuration:t}),i(this,Eo,t,"f"),this.CanGetDevices&&await this.GetDevices()}catch(e){xo.error(e)}},Io=function(e){if("webBluetooth"!=e.connectionType)return void xo.log("localStorage is only for webBluetooth devices");t(this,wo,"m",ko).call(this);const i=t(this,Eo,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1!=i&&(t(this,Eo,"f").devices[i].type=e.type,t(this,wo,"m",Wo).call(this))},Uo=function(){return t(this,Lo,"f").dispatchEvent},Ro=function(e){const{target:i}=e;if(i.isConnected)if(t(this,So,"f").includes(i))xo.log("device already included");else{if(xo.log("adding device",i),t(this,So,"f").push(i),this.UseLocalStorage&&"webBluetooth"==i.connectionType){const e={type:i.type,bluetoothId:i.bluetoothId,ipAddress:i.ipAddress,isWifiSecure:i.isWifiSecure},s=t(this,Eo,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1==s?t(this,Eo,"f").devices.push(e):t(this,Eo,"f").devices[s]=e,t(this,wo,"m",Wo).call(this)}t(this,wo,"a",Uo).call(this,"deviceConnected",{device:i}),t(this,wo,"a",Uo).call(this,"deviceIsConnected",{device:i}),t(this,wo,"m",Ao).call(this)}else t(this,So,"f").includes(i)?(xo.log("removing device",i),t(this,So,"f").splice(t(this,So,"f").indexOf(i),1),t(this,wo,"a",Uo).call(this,"deviceDisconnected",{device:i}),t(this,wo,"a",Uo).call(this,"deviceIsConnected",{device:i}),t(this,wo,"m",Ao).call(this)):xo.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),i.isConnected&&!this.AvailableDevices.includes(i)){const e=this.AvailableDevices.find((e=>e.bluetoothId==i.bluetoothId));xo.log({existingAvailableDevice:e}),e?this.AvailableDevices[this.AvailableDevices.indexOf(e)]=i:this.AvailableDevices.push(i),t(this,wo,"m",Fo).call(this)}this._CheckDeviceAvailability(i)},Fo=function(){xo.log({AvailableDevices:this.AvailableDevices}),t(this,wo,"a",Uo).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},Ao=function(){xo.log({ConnectedDevices:this.ConnectedDevices}),t(this,wo,"a",Uo).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},Oo.shared=new Oo;var Bo=Oo.shared;const No=T("ServerUtils",{log:!1}),Po=["isScanningAvailable","isScanning","startScan","stopScan","discoveredDevice","discoveredDevices","expiredDiscoveredDevice","connectToDevice","disconnectFromDevice","connectedDevices","deviceMessage","requiredDeviceInformation"];function Vo(e,...t){No.log("createMessage",...t);const i=t.map((t=>{"string"==typeof t&&(t={type:t}),null!=t.data?Array.isArray(t.data)||(t.data=[t.data]):t.data=[];const i=z(...t.data),s=i.byteLength;No.assertEnumWithError(t.type,e);const n=e.indexOf(t.type),a=new DataView(new ArrayBuffer(2));return a.setUint16(0,s,!0),z(n,a,i)}));return No.log("messageBuffers",...i),z(...i)}function qo(...e){return No.log("createServerMessage",...e),Vo(Po,...e)}function zo(...e){return No.log("createClientDeviceMessage",...e),Vo(ja,...e)}qo("isScanningAvailable"),qo("isScanning"),qo("startScan"),qo("stopScan"),qo("discoveredDevices");const jo=T("WebSocketUtils",{log:!1}),Go=["ping","pong","serverMessage"];function Ho(...e){return jo.log("createWebSocketMessage",...e),Vo(Go,...e)}var Jo,Ko,Qo,Zo,Xo,Yo,ec,tc,ic,sc,nc,ac,rc,oc,cc,hc,lc,fc;Ho("ping"),Ho("pong");const gc=T("WebSocketConnectionManager",{log:!1}),uc=["ping","pong","batteryLevel","deviceInformation","message"];const dc=["deviceInformation","batteryLevel"];class mc extends Ga{get bluetoothId(){return t(this,Ko,"f")??""}constructor(e,s=!1,n){super(),Jo.add(this),Ko.set(this,void 0),this.defaultMtu=1024,Qo.set(this,void 0),Zo.set(this,void 0),Xo.set(this,!1),tc.set(this,{open:t(this,Jo,"m",ic).bind(this),message:t(this,Jo,"m",sc).bind(this),close:t(this,Jo,"m",nc).bind(this),error:t(this,Jo,"m",ac).bind(this)}),cc.set(this,new A(t(this,Jo,"m",hc).bind(this),29e3)),this.ipAddress=e,this.isSecure=s,this.mtu=this.defaultMtu,i(this,Ko,n,"f")}get isAvailable(){return!0}static get isSupported(){return!0}static get type(){return"webSocket"}get webSocket(){return t(this,Qo,"f")}set webSocket(e){t(this,Qo,"f")!=e?(gc.log("assigning webSocket",e),t(this,Qo,"f")&&(Ka(t(this,Qo,"f"),t(this,tc,"f")),t(this,Qo,"f").readyState==t(this,Qo,"f").OPEN&&t(this,Qo,"f").close()),e&&Ja(e,t(this,tc,"f")),i(this,Qo,e,"f"),gc.log("assigned webSocket")):gc.log("redundant webSocket assignment")}get ipAddress(){return t(this,Zo,"f")}set ipAddress(e){this.assertIsNotConnected(),t(this,Zo,"f")!=e?(i(this,Zo,e,"f"),gc.log(`updated ipAddress to "${this.ipAddress}"`)):gc.log(`redundnant ipAddress assignment "${e}"`)}get isSecure(){return t(this,Xo,"f")}set isSecure(e){this.assertIsNotConnected(),t(this,Xo,"f")!=e?(i(this,Xo,e,"f"),gc.log(`updated isSecure to "${this.isSecure}"`)):gc.log(`redundant isSecure assignment ${e}`)}get url(){return`${this.isSecure?"wss":"ws"}://${this.ipAddress}/ws`}async connect(){await super.connect();try{this.webSocket=new WebSocket(this.url)}catch(e){gc.error("error connecting to webSocket",e),this.status="notConnected"}}async disconnect(){await super.disconnect(),gc.log("closing websocket"),t(this,cc,"f").stop(),t(this,Qo,"f")?.close()}get canReconnect(){return Boolean(this.webSocket)}async reconnect(){await super.reconnect(),this.webSocket=new WebSocket(this.url)}async sendSmpMessage(e){super.sendSmpMessage(e),gc.error("smp not supported on webSockets")}async sendTxData(e){await super.sendTxData(e),0!=e.byteLength&&t(this,Jo,"m",ec).call(this,{type:"message",data:e})}remove(){super.remove(),this.webSocket=void 0}}var pc,vc,wc,yc,bc,Sc,Cc,Mc,Ec,kc,Dc,Wc,Tc,Ic,_c,Lc,Uc,Rc,Fc,Ac,xc,$c,Oc,Bc,Nc,Pc,Vc,qc,zc,jc,Gc,Hc,Jc,Kc,Qc,Zc,Xc,Yc,eh,th,ih,sh,nh;Ko=new WeakMap,Qo=new WeakMap,Zo=new WeakMap,Xo=new WeakMap,tc=new WeakMap,cc=new WeakMap,Jo=new WeakSet,Yo=function(e){this.assertIsConnected(),gc.log("sending webSocket message",e),t(this,Qo,"f").send(e),t(this,cc,"f").restart()},ec=function(...e){t(this,Jo,"m",Yo).call(this,function(...e){return gc.log("createWebSocketMessage",...e),Vo(uc,...e)}(...e))},ic=function(e){gc.log("webSocket.open",e),t(this,cc,"f").start(),this.status="connected",t(this,Jo,"m",fc).call(this)},sc=async function(e){const i=await e.data.arrayBuffer(),s=new DataView(i);gc.log(`webSocket.message (${s.byteLength} bytes)`),t(this,Jo,"m",rc).call(this,s)},nc=function(e){gc.log("webSocket.close",e),this.status="notConnected",t(this,cc,"f").stop()},ac=function(e){gc.error("webSocket.error",e)},rc=function(e){bt(e,uc,t(this,Jo,"m",oc).bind(this),null,!0)},oc=function(e,i){switch(gc.log(`received "${e}" message (${i.byteLength} bytes)`),e){case"ping":t(this,Jo,"m",lc).call(this);break;case"pong":break;case"batteryLevel":this.onMessageReceived?.("batteryLevel",i);break;case"deviceInformation":bt(i,sn,((e,t)=>{this.onMessageReceived(e,t)}));break;case"message":this.parseRxMessage(i);break;default:gc.error(`uncaught messageType "${e}"`)}},hc=function(){gc.log("pinging"),t(this,Jo,"m",ec).call(this,"ping")},lc=function(){gc.log("ponging"),t(this,Jo,"m",ec).call(this,"pong")},fc=function(){t(this,Jo,"m",ec).call(this,...dc)};const ah=T("Device",{log:!1}),rh=["connectionMessage",...Pa,...za,...qa,...Tn,...nn,...ls,...Hi,...ea,...Pe,...js,...Ea,...si,...Bi,...mo],oh=["isCharging","getBatteryCurrent","getId","getMtu","getName","getType","getCurrentTime","getSensorConfiguration","getSensorScalars","getVibrationLocations","getFileTypes","isWifiAvailable"];class ch{get bluetoothId(){return t(this,Sc,"f")?.bluetoothId}get isAvailable(){return t(this,Sc,"f")?.isAvailable}constructor(){pc.add(this),yc.set(this,new _(this,rh)),Sc.set(this,void 0),this.sendTxMessages=t(this,pc,"m",Cc).bind(this),Mc.set(this,!1),_c.set(this,vc.ReconnectOnDisconnection),Lc.set(this,void 0),this.latestConnectionMessages=new Map,Bc.set(this,new an),Nc.set(this,0),this._informationManager=new In,Vc.set(this,new fs),zc.set(this,vc.ClearSensorConfigurationOnLeave),jc.set(this,new Ji),Gc.set(this,new sa),Hc.set(this,new qe),Jc.set(this,new Ks),Kc.set(this,new vo),this.sendSmpMessage=t(this,pc,"m",Zc).bind(this),Xc.set(this,!1),Yc.set(this,new ka),eh.set(this,new ni),ih.set(this,new Ni),t(this,Bc,"f").eventDispatcher=t(this,yc,"f"),this._informationManager.sendMessage=this.sendTxMessages,this._informationManager.eventDispatcher=t(this,yc,"f"),t(this,Vc,"f").sendMessage=this.sendTxMessages,t(this,Vc,"f").eventDispatcher=t(this,yc,"f"),t(this,jc,"f").eventDispatcher=t(this,yc,"f"),t(this,Gc,"f").sendMessage=this.sendTxMessages,t(this,Gc,"f").eventDispatcher=t(this,yc,"f"),t(this,Jc,"f").sendMessage=this.sendTxMessages,t(this,Jc,"f").eventDispatcher=t(this,yc,"f"),t(this,Hc,"f").sendMessage=this.sendTxMessages,t(this,Hc,"f").eventDispatcher=t(this,yc,"f"),t(this,Yc,"f").sendMessage=this.sendTxMessages,t(this,Yc,"f").eventDispatcher=t(this,yc,"f"),t(this,eh,"f").sendMessage=this.sendTxMessages,t(this,eh,"f").eventDispatcher=t(this,yc,"f"),t(this,ih,"f").sendMessage=this.sendTxMessages,t(this,ih,"f").eventDispatcher=t(this,yc,"f"),t(this,Kc,"f").sendMessage=this.sendSmpMessage,t(this,Kc,"f").eventDispatcher=t(this,yc,"f"),this.addEventListener("getMtu",(()=>{t(this,Kc,"f").mtu=this.mtu,t(this,Hc,"f").mtu=this.mtu,this.connectionManager.mtu=this.mtu})),this.addEventListener("getSensorConfiguration",(()=>{if("connecting"==this.connectionStatus){if(this.sensorTypes.includes("pressure")){ah.log("requesting required pressure information");const e=Gi.map((e=>({type:e})));this.sendTxMessages(e,!1)}else ah.log("don't need to request pressure infomration");if(this.sensorTypes.includes("camera")){ah.log("requesting required camera information");const e=ii.map((e=>({type:e})));this.sendTxMessages(e,!1)}else ah.log("don't need to request camera infomration");if(this.sensorTypes.includes("microphone")){ah.log("requesting required microphone information");const e=Oi.map((e=>({type:e})));this.sendTxMessages(e,!1)}else ah.log("don't need to request microphone infomration")}})),this.addEventListener("getFileTypes",(()=>{"connecting"==this.connectionStatus&&(this.fileTypes.length>0&&t(this,Hc,"f").requestRequiredInformation(),this.fileTypes.includes("tflite")&&t(this,Jc,"f").requestRequiredInformation())})),this.addEventListener("isWifiAvailable",(()=>{"connecting"==this.connectionStatus&&("client"!=this.connectionType||a)&&this.isWifiAvailable&&"client"!=this.connectionType&&t(this,Yc,"f").requestRequiredInformation()})),Bo.onDevice(this),n&&window.addEventListener("beforeunload",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()})),a&&process.on("exit",(()=>{this.isConnected&&this.clearSensorConfigurationOnLeave&&this.clearSensorConfiguration()}))}get addEventListener(){return t(this,yc,"f").addEventListener}get removeEventListener(){return t(this,yc,"f").removeEventListener}get waitForEvent(){return t(this,yc,"f").waitForEvent}get removeEventListeners(){return t(this,yc,"f").removeEventListeners}get removeAllEventListeners(){return t(this,yc,"f").removeAllEventListeners}get connectionManager(){return t(this,Sc,"f")}set connectionManager(e){this.connectionManager!=e?(this.connectionManager&&this.connectionManager.remove(),e&&(e.onStatusUpdated=t(this,pc,"m",Uc).bind(this),e.onMessageReceived=t(this,pc,"m",$c).bind(this),e.onMessagesReceived=t(this,pc,"m",Oc).bind(this)),i(this,Sc,e,"f"),ah.log("assigned new connectionManager",t(this,Sc,"f")),this._informationManager.connectionType=this.connectionType):ah.log("same connectionManager is already assigned")}async connect(e){if(ah.log("connect options",e),e)switch(e.type){case"webBluetooth":"webBluetooth"!=this.connectionType&&(this.connectionManager=new Er);break;case"webSocket":{let t=!1;if("webSocket"==this.connectionType){const i=this.connectionManager;i.ipAddress==e.ipAddress&&i.isSecure==e.isWifiSecure||(t=!0)}else t=!0;t&&(this.connectionManager=new mc(e.ipAddress,e.isWifiSecure,this.bluetoothId))}break;case"udp":{let t=!1;if("udp"==this.connectionType){this.connectionManager.ipAddress!=e.ipAddress&&(t=!0),this.reconnectOnDisconnection=!0}else t=!0;t&&(this.connectionManager=new UDPConnectionManager(e.ipAddress,this.bluetoothId))}}if(this.connectionManager||(this.connectionManager=t(vc,vc,"m",wc).call(vc)),t(this,pc,"m",Ac).call(this),"client"==e?.type){ah.assertWithError("client"==this.connectionType,"expected clientConnectionManager");const t=this.connectionManager;return t.subType=e.subType,t.connect()}return ah.log("connectionManager type",this.connectionManager.type),this.connectionManager.connect()}get isConnected(){return t(this,Mc,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return t(this,pc,"m",Tc).call(this),t(this,pc,"m",Ac).call(this),this.connectionManager?.reconnect()}static async Connect(){const e=new vc;return await e.connect(),e}static get ReconnectOnDisconnection(){return t(this,vc,"f",Ic)}static set ReconnectOnDisconnection(e){ah.assertTypeWithError(e,"boolean"),i(this,vc,e,"f",Ic)}get reconnectOnDisconnection(){return t(this,_c,"f")}set reconnectOnDisconnection(e){ah.assertTypeWithError(e,"boolean"),i(this,_c,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return t(this,pc,"m",Ec).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){if(this.isConnected)this.disconnect();else if(this.canReconnect)try{this.reconnect()}catch(e){ah.error("error trying to reconnect",e),this.connect()}else this.connect()}get connectionStatus(){switch(t(this,Sc,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return t(this,Sc,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return t(this,Bc,"f").information}get batteryLevel(){return t(this,Nc,"f")}get id(){return this._informationManager.id}get isCharging(){return this._informationManager.isCharging}get batteryCurrent(){return this._informationManager.batteryCurrent}get getBatteryCurrent(){return this._informationManager.getBatteryCurrent}get name(){return this._informationManager.name}get setName(){return this._informationManager.setName}get type(){return this._informationManager.type}get setType(){return this._informationManager.setType}get isInsole(){return this._informationManager.isInsole}get isGlove(){return this._informationManager.isGlove}get side(){return this._informationManager.side}get mtu(){return this._informationManager.mtu}get sensorTypes(){return Object.keys(this.sensorConfiguration)}get continuousSensorTypes(){return zi.filter((e=>this.sensorTypes.includes(e)))}get sensorConfiguration(){return t(this,Vc,"f").configuration}async setSensorConfiguration(e,i){await t(this,Vc,"f").setConfiguration(e,i)}async clearSensorConfiguration(){return t(this,Vc,"f").clearSensorConfiguration()}static get ClearSensorConfigurationOnLeave(){return t(this,vc,"f",qc)}static set ClearSensorConfigurationOnLeave(e){ah.assertTypeWithError(e,"boolean"),i(this,vc,e,"f",qc)}get clearSensorConfigurationOnLeave(){return t(this,zc,"f")}set clearSensorConfigurationOnLeave(e){ah.assertTypeWithError(e,"boolean"),i(this,zc,e,"f")}get numberOfPressureSensors(){return t(this,jc,"f").pressureSensorDataManager.numberOfSensors}resetPressureRange(){t(this,jc,"f").pressureSensorDataManager.resetRange()}get vibrationLocations(){return t(this,Gc,"f").vibrationLocations}async triggerVibration(e,i){t(this,Gc,"f").triggerVibration(e,i)}get fileTypes(){return t(this,Hc,"f").fileTypes}get maxFileLength(){return t(this,Hc,"f").maxLength}get validFileTypes(){return Oe.filter((e=>!(e.includes("wifi")&&!this.isWifiAvailable)))}async sendFile(e,i){ah.assertWithError(this.validFileTypes.includes(e),`invalid fileType ${e}`);const s=this.waitForEvent("fileTransferComplete");t(this,Hc,"f").send(e,i),await s}async receiveFile(e){const i=this.waitForEvent("fileTransferComplete");t(this,Hc,"f").receive(e),await i}get fileTransferStatus(){return t(this,Hc,"f").status}cancelFileTransfer(){t(this,Hc,"f").cancel()}get tfliteName(){return t(this,Jc,"f").name}get setTfliteName(){return t(this,Jc,"f").setName}async sendTfliteConfiguration(e){e.type="tflite",t(this,Jc,"f").sendConfiguration(e,!1);await t(this,Hc,"f").send(e.type,e.file)||t(this,pc,"m",Cc).call(this)}get tfliteTask(){return t(this,Jc,"f").task}get setTfliteTask(){return t(this,Jc,"f").setTask}get tfliteSampleRate(){return t(this,Jc,"f").sampleRate}get setTfliteSampleRate(){return t(this,Jc,"f").setSampleRate}get tfliteSensorTypes(){return t(this,Jc,"f").sensorTypes}get allowedTfliteSensorTypes(){return this.sensorTypes.filter((e=>Js.includes(e)))}get setTfliteSensorTypes(){return t(this,Jc,"f").setSensorTypes}get tfliteIsReady(){return t(this,Jc,"f").isReady}get tfliteInferencingEnabled(){return t(this,Jc,"f").inferencingEnabled}get setTfliteInferencingEnabled(){return t(this,Jc,"f").setInferencingEnabled}async enableTfliteInferencing(){return this.setTfliteInferencingEnabled(!0)}async disableTfliteInferencing(){return this.setTfliteInferencingEnabled(!1)}get toggleTfliteInferencing(){return t(this,Jc,"f").toggleInferencingEnabled}get tfliteCaptureDelay(){return t(this,Jc,"f").captureDelay}get setTfliteCaptureDelay(){return t(this,Jc,"f").setCaptureDelay}get tfliteThreshold(){return t(this,Jc,"f").threshold}get setTfliteThreshold(){return t(this,Jc,"f").setThreshold}get canUpdateFirmware(){return t(this,Sc,"f")?.canUpdateFirmware}get uploadFirmware(){return t(this,pc,"m",Qc).call(this),t(this,Kc,"f").uploadFirmware}get canReset(){return this.canUpdateFirmware}async reset(){return ah.assertWithError(this.canReset,"reset is not enabled for this device"),await t(this,Kc,"f").reset(),t(this,Sc,"f").disconnect()}get firmwareStatus(){return t(this,Kc,"f").status}get getFirmwareImages(){return t(this,pc,"m",Qc).call(this),t(this,Kc,"f").getImages}get firmwareImages(){return t(this,Kc,"f").images}get eraseFirmwareImage(){return t(this,pc,"m",Qc).call(this),t(this,Kc,"f").eraseImage}get confirmFirmwareImage(){return t(this,pc,"m",Qc).call(this),t(this,Kc,"f").confirmImage}get testFirmwareImage(){return t(this,pc,"m",Qc).call(this),t(this,Kc,"f").testImage}get isServerSide(){return t(this,Xc,"f")}set isServerSide(e){t(this,Xc,"f")!=e?(ah.log({newIsServerSide:e}),i(this,Xc,e,"f"),t(this,Hc,"f").isServerSide=this.isServerSide):ah.log("redundant isServerSide assignment")}get isUkaton(){return this.deviceInformation.modelNumber.includes("Ukaton")}get isWifiAvailable(){return t(this,Yc,"f").isWifiAvailable}get wifiSSID(){return t(this,Yc,"f").wifiSSID}async setWifiSSID(e){return t(this,Yc,"f").setWifiSSID(e)}get wifiPassword(){return t(this,Yc,"f").wifiPassword}async setWifiPassword(e){return t(this,Yc,"f").setWifiPassword(e)}get isWifiConnected(){return t(this,Yc,"f").isWifiConnected}get ipAddress(){return t(this,Yc,"f").ipAddress}get wifiConnectionEnabled(){return t(this,Yc,"f").wifiConnectionEnabled}get enableWifiConnection(){return t(this,Yc,"f").enableWifiConnection}get setWifiConnectionEnabled(){return t(this,Yc,"f").setWifiConnectionEnabled}get disableWifiConnection(){return t(this,Yc,"f").disableWifiConnection}get toggleWifiConnection(){return t(this,Yc,"f").toggleWifiConnection}get isWifiSecure(){return t(this,Yc,"f").isWifiSecure}async reconnectViaWebSockets(){ah.assertWithError(this.isWifiConnected,"wifi is not connected"),ah.assertWithError("webSocket"!=this.connectionType,"already connected via webSockets"),ah.assertTypeWithError(this.ipAddress,"string"),ah.log("reconnecting via websockets..."),await this.disconnect(),await this.connect({type:"webSocket",ipAddress:this.ipAddress,isWifiSecure:this.isWifiSecure})}async reconnectViaUDP(){ah.assertWithError(a,"udp is only available in node"),ah.assertWithError(this.isWifiConnected,"wifi is not connected"),ah.assertWithError("udp"!=this.connectionType,"already connected via udp"),ah.assertTypeWithError(this.ipAddress,"string"),ah.log("reconnecting via udp..."),await this.disconnect(),await this.connect({type:"udp",ipAddress:this.ipAddress})}get hasCamera(){return this.sensorTypes.includes("camera")}get cameraStatus(){return t(this,eh,"f").cameraStatus}async takePicture(){t(this,pc,"m",th).call(this),await t(this,eh,"f").takePicture()}async focusCamera(){t(this,pc,"m",th).call(this),await t(this,eh,"f").focus()}async stopCamera(){t(this,pc,"m",th).call(this),await t(this,eh,"f").stop()}async wakeCamera(){t(this,pc,"m",th).call(this),await t(this,eh,"f").wake()}async sleepCamera(){t(this,pc,"m",th).call(this),await t(this,eh,"f").sleep()}get cameraConfiguration(){return t(this,eh,"f").cameraConfiguration}get availableCameraConfigurationTypes(){return t(this,eh,"f").availableCameraConfigurationTypes}get cameraConfigurationRanges(){return t(this,eh,"f").cameraConfigurationRanges}get setCameraConfiguration(){return t(this,eh,"f").setCameraConfiguration}get hasMicrophone(){return this.sensorTypes.includes("microphone")}get microphoneStatus(){return t(this,ih,"f").microphoneStatus}async startMicrophone(){t(this,pc,"m",sh).call(this),await t(this,ih,"f").start()}async stopMicrophone(){t(this,pc,"m",sh).call(this),await t(this,ih,"f").stop()}async enableMicrophoneVad(){t(this,pc,"m",sh).call(this),await t(this,ih,"f").vad()}async toggleMicrophone(){t(this,pc,"m",sh).call(this),await t(this,ih,"f").toggle()}get microphoneConfiguration(){return t(this,ih,"f").microphoneConfiguration}get availableMicrophoneConfigurationTypes(){return t(this,ih,"f").availableMicrophoneConfigurationTypes}get setMicrophoneConfiguration(){return t(this,ih,"f").setMicrophoneConfiguration}get audioContext(){return t(this,pc,"m",nh).call(this),t(this,ih,"f").audioContext}set audioContext(e){t(this,pc,"m",nh).call(this),t(this,ih,"f").audioContext=e}get microphoneMediaStreamDestination(){return t(this,pc,"m",nh).call(this),t(this,ih,"f").mediaStreamDestination}get microphoneGainNode(){return t(this,pc,"m",nh).call(this),t(this,ih,"f").gainNode}get isRecordingMicrophone(){return t(this,ih,"f").isRecording}startRecordingMicrophone(){t(this,pc,"m",nh).call(this),t(this,ih,"f").startRecording()}stopRecordingMicrophone(){t(this,pc,"m",nh).call(this),t(this,ih,"f").stopRecording()}toggleMicrophoneRecording(){t(this,pc,"m",nh).call(this),t(this,ih,"f").toggleRecording()}}var hh,lh,fh,gh,uh,dh;vc=ch,yc=new WeakMap,Sc=new WeakMap,Mc=new WeakMap,_c=new WeakMap,Lc=new WeakMap,Bc=new WeakMap,Nc=new WeakMap,Vc=new WeakMap,zc=new WeakMap,jc=new WeakMap,Gc=new WeakMap,Hc=new WeakMap,Jc=new WeakMap,Kc=new WeakMap,Xc=new WeakMap,Yc=new WeakMap,eh=new WeakMap,ih=new WeakMap,pc=new WeakSet,wc=function(){return new Er},bc=function(){return t(this,yc,"f").dispatchEvent},Cc=async function(e,i){await(t(this,Sc,"f")?.sendTxMessages(e,i))},Ec=function(){ah.assertWithError(this.isConnected,"notConnected")},kc=function(e){return e.every((e=>{const t=this.latestConnectionMessages.has(e);return t||ah.log(`didn't receive "${e}" message`),t}))},Dc=function(){let e=t(this,pc,"m",kc).call(this,oh);return e&&this.sensorTypes.includes("pressure")&&(e=t(this,pc,"m",kc).call(this,Gi)),e&&this.isWifiAvailable&&(e=t(this,pc,"m",kc).call(this,Ma)),e&&this.fileTypes.length>0&&(e=t(this,pc,"m",kc).call(this,Ve)),e&&this.fileTypes.includes("tflite")&&(e=t(this,pc,"m",kc).call(this,Gs)),e&&this.hasCamera&&(e=t(this,pc,"m",kc).call(this,ii)),e},Wc=function(){ah.log("requesting required information");const e=oh.map((e=>({type:e})));t(this,pc,"m",Cc).call(this,e)},Tc=function(){ah.assertWithError(this.canReconnect,"cannot reconnect to device")},Uc=function(e){ah.log({connectionStatus:e}),"notConnected"==e?(t(this,pc,"m",xc).call(this),this.canReconnect&&this.reconnectOnDisconnection&&(ah.log("starting reconnect interval..."),i(this,Lc,setInterval((()=>{ah.log("attempting reconnect..."),this.reconnect()}),1e3),"f"))):null!=t(this,Lc,"f")&&(ah.log("clearing reconnect interval"),clearInterval(t(this,Lc,"f")),i(this,Lc,void 0,"f")),t(this,pc,"m",Fc).call(this),"connected"!=e||t(this,Mc,"f")||"client"!=this.connectionType&&t(this,pc,"m",Wc).call(this),Bo.OnDeviceConnectionStatusUpdated(this,e)},Rc=function(e=!1){t(this,pc,"a",bc).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),t(this,pc,"a",bc).call(this,this.connectionStatus,{}),e&&t(this,pc,"a",bc).call(this,"isConnected",{isConnected:this.isConnected})},Fc=function(){switch(i(this,Mc,Boolean(this.connectionManager?.isConnected)&&t(this,pc,"a",Dc)&&this._informationManager.isCurrentTimeSet,"f"),this.connectionStatus){case"connected":t(this,Mc,"f")&&t(this,pc,"m",Rc).call(this,!0);break;case"notConnected":t(this,pc,"m",Rc).call(this,!0);break;default:t(this,pc,"m",Rc).call(this,!1)}},Ac=function(){t(this,pc,"m",xc).call(this),this._informationManager.clear(),t(this,Bc,"f").clear(),t(this,Jc,"f").clear(),t(this,Yc,"f").clear(),t(this,eh,"f").clear(),t(this,ih,"f").clear()},xc=function(){this.connectionManager?.clear(),this.latestConnectionMessages.clear()},$c=function(e,i){if(ah.log({messageType:e,dataView:i}),"batteryLevel"===e){const e=i.getUint8(0);ah.log("received battery level",{batteryLevel:e}),t(this,pc,"m",Pc).call(this,e)}else if($e.includes(e))t(this,Hc,"f").parseMessage(e,i);else if(zs.includes(e))t(this,Jc,"f").parseMessage(e,i);else if(ji.includes(e))t(this,jc,"f").parseMessage(e,i);else if(uo.includes(e))t(this,Kc,"f").parseMessage(e,i);else if(sn.includes(e))t(this,Bc,"f").parseMessage(e,i);else if(Wn.includes(e))this._informationManager.parseMessage(e,i);else if(hs.includes(e))t(this,Vc,"f").parseMessage(e,i);else if(Yn.includes(e))t(this,Gc,"f").parseMessage(e,i);else if(Ca.includes(e))t(this,Yc,"f").parseMessage(e,i);else if(ti.includes(e))t(this,eh,"f").parseMessage(e,i);else{if(!xi.includes(e))throw Error(`uncaught messageType ${e}`);t(this,ih,"f").parseMessage(e,i)}this.latestConnectionMessages.set(e,i),e.startsWith("set")&&this.latestConnectionMessages.set(e.replace("set","get"),i),t(this,pc,"a",bc).call(this,"connectionMessage",{messageType:e,dataView:i})},Oc=function(){!this.isConnected&&t(this,pc,"a",Dc)&&t(this,pc,"m",Fc).call(this),"notConnected"!=this.connectionStatus&&t(this,pc,"m",Cc).call(this)},Pc=function(e){ah.assertTypeWithError(e,"number"),t(this,Nc,"f")!=e?(i(this,Nc,e,"f"),ah.log({updatedBatteryLevel:t(this,Nc,"f")}),t(this,pc,"a",bc).call(this,"batteryLevel",{batteryLevel:t(this,Nc,"f")})):ah.log(`duplicate batteryLevel assignment ${e}`)},Qc=function(){ah.assertWithError(this.canUpdateFirmware,"can't update firmware")},Zc=function(e){return t(this,pc,"m",Qc).call(this),t(this,Sc,"f").sendSmpMessage(e)},th=function(){ah.assertWithError(this.hasCamera,"camera not available")},sh=function(){ah.assertWithError(this.hasMicrophone,"microphone not available")},nh=function(){ah.assertWithError(AudioContext,"WebAudio is not supported")},Ic={value:!1},qc={value:!0};const mh=T("DevicePairPressureSensorDataManager",{log:!1});class ph{constructor(){hh.add(this),lh.set(this,{}),fh.set(this,new st),gh.set(this,new Ze),this.resetPressureRange()}resetPressureRange(){t(this,fh,"f").reset(),t(this,gh,"f").reset()}onDevicePressureData(e){const{pressure:i}=e.message,{side:s}=e.target;if(mh.log({pressure:i,side:s}),t(this,lh,"f")[s]=i,t(this,hh,"a",uh))return t(this,hh,"m",dh).call(this);mh.log("doesn't have all pressure data yet...")}}var vh;lh=new WeakMap,fh=new WeakMap,gh=new WeakMap,hh=new WeakSet,uh=function(){return Dn.every((e=>e in t(this,lh,"f")))},dh=function(){const e={scaledSum:0,normalizedSum:0,sensors:{left:[],right:[]}};return Dn.forEach((i=>{const s=t(this,lh,"f")[i];e.scaledSum+=s.scaledSum})),e.normalizedSum+=t(this,gh,"f").updateAndGetNormalization(e.scaledSum,!1),e.scaledSum>0&&(e.center={x:0,y:0},Dn.forEach((i=>{t(this,lh,"f")[i].sensors.forEach((t=>{const s={...t};s.weightedValue=t.scaledValue/e.scaledSum;let{x:n,y:a}=t.position;n/=2,"right"==i&&(n+=.5),s.position={x:n,y:a},e.center.x+=s.position.x*s.weightedValue,e.center.y+=s.position.y*s.weightedValue,e.sensors[i].push(s)}))})),e.normalizedCenter=t(this,fh,"f").updateAndGetNormalization(e.center,!1)),mh.log({devicePairPressure:e}),e};const wh=T("DevicePairSensorDataManager",{log:!1}),yh=["pressure","sensorData"];class bh{constructor(){vh.set(this,{}),this.pressureSensorDataManager=new ph}get dispatchEvent(){return this.eventDispatcher.dispatchEvent}resetPressureRange(){this.pressureSensorDataManager.resetPressureRange()}onDeviceSensorData(e){const{timestamp:i,sensorType:s}=e.message;let n;if(wh.log({sensorType:s,timestamp:i,event:e}),t(this,vh,"f")[s]||(t(this,vh,"f")[s]={}),t(this,vh,"f")[s][e.target.side]=i,"pressure"===s)n=this.pressureSensorDataManager.onDevicePressureData(e);else wh.log(`uncaught sensorType "${s}"`);if(n){const e=Object.assign({},t(this,vh,"f")[s]);this.dispatchEvent(s,{sensorType:s,timestamps:e,[s]:n}),this.dispatchEvent("sensorData",{sensorType:s,timestamps:e,[s]:n})}else wh.log("no value received")}}var Sh,Ch,Mh,Eh,kh,Dh,Wh,Th,Ih,_h,Lh,Uh,Rh,Fh,Ah,xh,$h,Oh,Bh;vh=new WeakMap;const Nh=T("DevicePair",{log:!1});function Ph(e){return`device${t=e,t[0].toUpperCase()+t.slice(1)}`;var t}const Vh=["isConnected",...yh,...rh.map((e=>Ph(e)))];class qh{constructor(e){Sh.add(this),Mh.set(this,void 0),Eh.set(this,new _(this,Vh)),Dh.set(this,void 0),Wh.set(this,void 0),Uh.set(this,{isConnected:t(this,Sh,"m",Fh).bind(this),sensorData:t(this,Sh,"m",$h).bind(this),getType:t(this,Sh,"m",Ah).bind(this)}),xh.set(this,new bh),i(this,Mh,e,"f"),t(this,xh,"f").eventDispatcher=t(this,Eh,"f")}get sides(){return Dn}get type(){return t(this,Mh,"f")}get addEventListener(){return t(this,Eh,"f").addEventListener}get removeEventListener(){return t(this,Eh,"f").removeEventListener}get waitForEvent(){return t(this,Eh,"f").waitForEvent}get removeEventListeners(){return t(this,Eh,"f").removeEventListeners}get removeAllEventListeners(){return t(this,Eh,"f").removeAllEventListeners}get left(){return t(this,Dh,"f")}get right(){return t(this,Wh,"f")}get isConnected(){return Dn.every((e=>this[e]?.isConnected))}get isPartiallyConnected(){return Dn.some((e=>this[e]?.isConnected))}get isHalfConnected(){return this.isPartiallyConnected&&!this.isConnected}assignDevice(e){if(!t(this,Sh,"m",Th).call(this,e))return void Nh.log(`device is incorrect type ${e.type} for ${this.type} devicePair`);const s=e.side,n=this[s];if(e!=n){switch(n&&t(this,Sh,"m",_h).call(this,n),t(this,Sh,"m",Ih).call(this,e),s){case"left":i(this,Dh,e,"f");break;case"right":i(this,Wh,e,"f")}return Nh.log(`assigned ${s} ${this.type} device`,e),this.resetPressureRange(),t(this,Sh,"a",kh).call(this,"isConnected",{isConnected:this.isConnected}),t(this,Sh,"a",kh).call(this,"deviceIsConnected",{device:e,isConnected:e.isConnected,side:s}),n}Nh.log("device already assigned")}async setSensorConfiguration(e){for(let t=0;t<Dn.length;t++){const i=Dn[t];this[i]?.isConnected&&await this[i].setSensorConfiguration(e)}}resetPressureRange(){Dn.forEach((e=>this[e]?.resetPressureRange())),t(this,xh,"f").resetPressureRange()}async triggerVibration(e,t){const i=Dn.map((i=>this[i]?.triggerVibration(e,t))).filter(Boolean);return Promise.allSettled(i)}static get insoles(){return t(this,Ch,"f",Oh)}static get gloves(){return t(this,Ch,"f",Bh)}}var zh,jh,Gh,Hh,Jh;Ch=qh,Mh=new WeakMap,Eh=new WeakMap,Dh=new WeakMap,Wh=new WeakMap,Uh=new WeakMap,xh=new WeakMap,Sh=new WeakSet,kh=function(){return t(this,Eh,"f").dispatchEvent},Th=function(e){switch(this.type){case"insoles":return e.isInsole;case"gloves":return e.isGlove}},Ih=function(e){Ja(e,t(this,Uh,"f")),rh.forEach((i=>{e.addEventListener(i,t(this,Sh,"m",Rh).bind(this))}))},_h=function(e){Ka(e,t(this,Uh,"f")),rh.forEach((i=>{e.removeEventListener(i,t(this,Sh,"m",Rh).bind(this))}))},Lh=function(e){const s=Dn.some((s=>{if(this[s]!=e)return!1;switch(Nh.log(`removing ${s} ${this.type} device`,e),Ka(e,t(this,Uh,"f")),s){case"left":i(this,Dh,void 0,"f");break;case"right":i(this,Wh,void 0,"f")}return!0}));return s&&t(this,Sh,"a",kh).call(this,"isConnected",{isConnected:this.isConnected}),s},Rh=function(e){const{type:i,target:s,message:n}=e;t(this,Sh,"a",kh).call(this,Ph(i),{...n,device:s,side:s.side})},Fh=function(e){t(this,Sh,"a",kh).call(this,"isConnected",{isConnected:this.isConnected})},Ah=function(e){const{target:i}=e;if(this[i.side]==i)return;t(this,Sh,"m",Lh).call(this,i)&&this.assignDevice(i)},$h=function(e){this.isConnected&&t(this,xh,"f").onDeviceSensorData(e)},Oh={value:new Ch("insoles")},Bh={value:new Ch("gloves")},Bo.AddEventListener("deviceConnected",(e=>{const{device:i}=e.message;i.isInsole&&t(Ch,Ch,"f",Oh).assignDevice(i),i.isGlove&&t(Ch,Ch,"f",Bh).assignDevice(i)}));const Kh=T("ClientConnectionManager",{log:!1});class Qh extends Ga{constructor(){super(...arguments),zh.add(this),jh.set(this,void 0),Gh.set(this,!1)}static get isSupported(){return n}static get type(){return"client"}get canUpdateFirmware(){return!1}get bluetoothId(){return t(this,jh,"f")}set bluetoothId(e){Kh.assertTypeWithError(e,"string"),t(this,jh,"f")!=e?i(this,jh,e,"f"):Kh.log("redundant bluetoothId assignment")}get isConnected(){return t(this,Gh,"f")}set isConnected(e){Kh.assertTypeWithError(e,"boolean"),t(this,Gh,"f")!=e?(i(this,Gh,e,"f"),this.status=t(this,Gh,"f")?"connected":"notConnected",this.isConnected&&t(this,zh,"m",Hh).call(this)):Kh.log("redundant newIsConnected assignment",e)}get isAvailable(){return this.client.isConnected}async connect(){await super.connect(),this.sendClientConnectMessage(this.subType)}async disconnect(){await super.disconnect(),this.sendClientDisconnectMessage()}get canReconnect(){return!0}async reconnect(){await super.reconnect(),this.sendClientConnectMessage()}async sendSmpMessage(e){super.sendSmpMessage(e),this.sendClientMessage({type:"smp",data:e})}async sendTxData(e){super.sendTxData(e),0!=e.byteLength&&this.sendClientMessage({type:"tx",data:e})}onClientMessage(e){Kh.log({dataView:e}),bt(e,rh,t(this,zh,"m",Jh).bind(this),null,!0),this.onMessagesReceived()}}var Zh,Xh,Yh,el,tl,il,sl,nl,al,rl,ol,cl,hl,ll,fl,gl,ul,dl,ml,pl,vl,wl,yl,bl;jh=new WeakMap,Gh=new WeakMap,zh=new WeakSet,Hh=function(){this.sendRequiredDeviceInformationMessage()},Jh=function(e,t){let i=0;switch(Kh.log({messageType:e},t),e){case"isConnected":const s=Boolean(t.getUint8(i++));Kh.log({isConnected:s}),this.isConnected=s;break;case"rx":this.parseRxMessage(t);break;default:this.onMessageReceived(e,t)}};const Sl=T("BaseClient",{log:!1}),Cl=["notConnected","connecting","connected","disconnecting","connectionStatus","isConnected","isScanningAvailable","isScanning","discoveredDevice","expiredDiscoveredDevice"];class Ml{constructor(){Zh.add(this),el.set(this,{}),tl.set(this,new _(this,Cl)),this._reconnectOnDisconnection=this.baseConstructor.ReconnectOnDisconnection,il.set(this,"notConnected"),al.set(this,[]),cl.set(this,!1),gl.set(this,!1),wl.set(this,{})}get baseConstructor(){return this.constructor}get devices(){return t(this,el,"f")}get addEventListener(){return t(this,tl,"f").addEventListener}get dispatchEvent(){return t(this,tl,"f").dispatchEvent}get removeEventListener(){return t(this,tl,"f").removeEventListener}get waitForEvent(){return t(this,tl,"f").waitForEvent}assertConnection(){Sl.assertWithError(this.isConnected,"notConnected")}assertDisconnection(){Sl.assertWithError(this.isDisconnected,"not disconnected")}static get ReconnectOnDisconnection(){return this._reconnectOnDisconnection}static set ReconnectOnDisconnection(e){Sl.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get reconnectOnDisconnection(){return this._reconnectOnDisconnection}set reconnectOnDisconnection(e){Sl.assertTypeWithError(e,"boolean"),this._reconnectOnDisconnection=e}get _connectionStatus(){return t(this,il,"f")}set _connectionStatus(e){switch(Sl.assertTypeWithError(e,"string"),Sl.log({newConnectionStatus:e}),i(this,il,e,"f"),this.dispatchEvent("connectionStatus",{connectionStatus:this.connectionStatus}),this.dispatchEvent(this.connectionStatus,{}),e){case"connected":case"notConnected":this.dispatchEvent("isConnected",{isConnected:this.isConnected}),this.isConnected||t(this,Zh,"m",Yh).call(this)}}get connectionStatus(){return this._connectionStatus}_sendRequiredMessages(){Sl.log("sending required messages",t(this,al,"f")),this.sendServerMessage(...t(this,Zh,"a",nl))}parseMessage(e){Sl.log("parseMessage",{dataView:e}),bt(e,Po,t(this,Zh,"m",ol).bind(this),null,!0),t(this,Zh,"m",rl).call(this)}get isScanningAvailable(){return t(this,Zh,"a",hl)}requestIsScanningAvailable(){this.sendServerMessage("isScanningAvailable")}get isScanning(){return t(this,Zh,"a",ul)}startScan(){t(this,Zh,"m",vl).call(this),this.sendServerMessage("startScan")}stopScan(){t(this,Zh,"m",pl).call(this),this.sendServerMessage("stopScan")}toggleScan(){t(this,Zh,"m",fl).call(this),this.isScanning?this.stopScan():this.startScan()}get discoveredDevices(){return t(this,wl,"f")}onDiscoveredDevice(e){Sl.log({discoveredDevice:e}),t(this,wl,"f")[e.bluetoothId]=e,this.dispatchEvent("discoveredDevice",{discoveredDevice:e})}requestDiscoveredDevices(){this.sendServerMessage({type:"discoveredDevices"})}connectToDevice(e,t){return this.requestConnectionToDevice(e,t)}requestConnectionToDevice(e,i){this.assertConnection(),Sl.assertTypeWithError(e,"string");const s=t(this,Zh,"m",bl).call(this,e);return i?s.connect({type:"client",subType:i}):s.connect(),s}sendConnectToDeviceMessage(e,t){t?this.sendServerMessage({type:"connectToDevice",data:z(j(e),Ba.indexOf(t))}):this.sendServerMessage({type:"connectToDevice",data:e})}createDevice(e){const i=new ch,s=t(this,wl,"f")[e],n=new Qh;return n.discoveredDevice=Object.assign({},s),n.client=this,n.bluetoothId=e,n.sendClientMessage=this.sendDeviceMessage.bind(this,e),n.sendRequiredDeviceInformationMessage=this.sendRequiredDeviceInformationMessage.bind(this,e),n.sendClientConnectMessage=this.sendConnectToDeviceMessage.bind(this,e),n.sendClientDisconnectMessage=this.sendDisconnectFromDeviceMessage.bind(this,e),i.connectionManager=n,i}onConnectedBluetoothDeviceIds(e){Sl.log({bluetoothIds:e}),e.forEach((e=>{const i=t(this,Zh,"m",bl).call(this,e);i.connectionManager.isConnected=!0,Bo._CheckDeviceAvailability(i)}))}disconnectFromDevice(e){this.requestDisconnectionFromDevice(e)}requestDisconnectionFromDevice(e){this.assertConnection(),Sl.assertTypeWithError(e,"string");const t=this.devices[e];return Sl.assertWithError(t,`no device found with id ${e}`),t.disconnect(),t}sendDisconnectFromDeviceMessage(e){this.sendServerMessage({type:"disconnectFromDevice",data:e})}sendDeviceMessage(e,...t){this.sendServerMessage({type:"deviceMessage",data:[e,zo(...t)]})}sendRequiredDeviceInformationMessage(e){this.sendServerMessage({type:"requiredDeviceInformation",data:[e]})}}var El,kl,Dl,Wl,Tl,Il,_l,Ll,Ul,Rl,Fl,Al,xl;Xh=Ml,el=new WeakMap,tl=new WeakMap,il=new WeakMap,al=new WeakMap,cl=new WeakMap,gl=new WeakMap,wl=new WeakMap,Zh=new WeakSet,Yh=function(){i(this,Zh,!1,"a",ll),i(this,Zh,!1,"a",dl);for(const e in t(this,el,"f")){t(this,el,"f")[e].connectionManager.isConnected=!1}t(this,al,"f").length=0},nl=function(){return t(Xh,Xh,"f",sl)},rl=function(){"connecting"==this.connectionStatus&&(Sl.log("checking if fully connected..."),t(this,al,"f").includes("isScanningAvailable")?!this.isScanningAvailable||t(this,al,"f").includes("isScanning")?(Sl.log("fully connected"),this._connectionStatus="connected"):Sl.log("not fully connected - didn't receive isScanning"):Sl.log("not fully connected - didn't receive isScanningAvailable"))},ol=function(e,s){let n=0;switch(Sl.log({messageType:e},s),e){case"isScanningAvailable":{const e=Boolean(s.getUint8(n++));Sl.log({isScanningAvailable:e}),i(this,Zh,e,"a",ll)}break;case"isScanning":{const e=Boolean(s.getUint8(n++));Sl.log({isScanning:e}),i(this,Zh,e,"a",dl)}break;case"discoveredDevice":{const{string:e}=yt(s,n);Sl.log({discoveredDeviceString:e});const t=JSON.parse(e);Sl.log({discoveredDevice:t}),this.onDiscoveredDevice(t)}break;case"expiredDiscoveredDevice":{const{string:e}=yt(s,n);t(this,Zh,"m",yl).call(this,e)}break;case"connectedDevices":{if(0==s.byteLength)break;const{string:e}=yt(s,n);Sl.log({connectedBluetoothDeviceIdStrings:e});const t=JSON.parse(e).connectedDevices;Sl.log({connectedBluetoothDeviceIds:t}),this.onConnectedBluetoothDeviceIds(t)}break;case"deviceMessage":{const{string:e,byteOffset:i}=yt(s,n);n=i;const a=t(this,el,"f")[e];Sl.assertWithError(a,`no device found for id ${e}`);const r=a.connectionManager,o=G(s,n);r.onClientMessage(o)}break;default:Sl.error(`uncaught messageType "${e}"`)}"connecting"==this.connectionStatus&&t(this,al,"f").push(e)},hl=function(){return t(this,cl,"f")},ll=function(e){Sl.assertTypeWithError(e,"boolean"),i(this,cl,e,"f"),this.dispatchEvent("isScanningAvailable",{isScanningAvailable:this.isScanningAvailable}),this.isScanningAvailable&&t(this,Zh,"m",ml).call(this)},fl=function(){this.assertConnection(),Sl.assertWithError(this.isScanningAvailable,"scanning is not available")},ul=function(){return t(this,gl,"f")},dl=function(e){Sl.assertTypeWithError(e,"boolean"),i(this,gl,e,"f"),this.dispatchEvent("isScanning",{isScanning:this.isScanning})},ml=function(){this.sendServerMessage("isScanning")},pl=function(){Sl.assertWithError(this.isScanning,"is not scanning")},vl=function(){Sl.assertWithError(!this.isScanning,"is already scanning")},yl=function(e){Sl.log({expiredBluetoothDeviceId:e});const i=t(this,wl,"f")[e];i?(Sl.log({expiredDiscoveredDevice:i}),delete t(this,wl,"f")[e],this.dispatchEvent("expiredDiscoveredDevice",{discoveredDevice:i})):Sl.warn(`no discoveredDevice found with id "${e}"`)},bl=function(e){let i=t(this,el,"f")[e];return i||(i=this.createDevice(e),t(this,el,"f")[e]=i),i},Ml._reconnectOnDisconnection=!0,sl={value:["isScanningAvailable","discoveredDevices","connectedDevices"]};const $l=T("WebSocketClient",{log:!1});kl=new WeakMap,Wl=new WeakMap,Fl=new WeakMap,El=new WeakSet,Dl=function(...e){this.sendMessage(Ho(...e))},Tl=function(e){$l.log("webSocket.open",e),t(this,Fl,"f").start(),this._sendRequiredMessages()},Il=async function(e){$l.log("webSocket.message",e);const i=await e.data.arrayBuffer(),s=new DataView(i);t(this,El,"m",Ul).call(this,s)},_l=function(e){$l.log("webSocket.close",e),this._connectionStatus="notConnected",Object.entries(this.devices).forEach((([e,t])=>{t.connectionManager.isConnected=!1})),t(this,Fl,"f").stop(),this.reconnectOnDisconnection&&setTimeout((()=>{this.reconnect()}),3e3)},Ll=function(e){$l.error("webSocket.error",e)},Ul=function(e){bt(e,Go,t(this,El,"m",Rl).bind(this),null,!0)},Rl=function(e,i){switch(e){case"ping":t(this,El,"m",xl).call(this);break;case"pong":break;case"serverMessage":this.parseMessage(i);break;default:$l.error(`uncaught messageType "${e}"`)}},Al=function(){t(this,El,"m",Dl).call(this,"ping")},xl=function(){t(this,El,"m",Dl).call(this,"pong")};const Ol={addEventListeners:Ja,removeEventListeners:Ka},Bl={throttle:function(e,t,i=!1){let s=0,n=null,a=null;return function(...r){const o=Date.now(),c=t-(o-s);c<=0?(n&&(clearTimeout(n),n=null),s=o,e(...r)):i&&(a=r,n||(n=setTimeout((()=>{s=Date.now(),n=null,a&&(e(...a),a=null)}),c)))}},debounce:function(e,t,i=!1){let s=null;return function(...n){const a=i&&!s;s&&clearTimeout(s),s=setTimeout((()=>{s=null,i||e(...n)}),t),a&&e(...n)}}};e.CameraCommands=Zt,e.CameraConfigurationTypes=ei,e.ContinuousSensorTypes=zi,e.DefaultNumberOfPressureSensors=8,e.Device=ch,e.DeviceManager=Bo,e.DevicePair=qh,e.DevicePairTypes=["insoles","gloves"],e.DeviceTypes=kn,e.Environment=y,e.EventUtils=Ol,e.FileTransferDirections=["sending","receiving"],e.FileTypes=Oe,e.MaxNameLength=30,e.MaxNumberOfVibrationWaveformEffectSegments=8,e.MaxNumberOfVibrationWaveformSegments=20,e.MaxSensorRate=65535,e.MaxVibrationWaveformEffectSegmentDelay=ia,e.MaxVibrationWaveformEffectSegmentLoopCount=3,e.MaxVibrationWaveformEffectSequenceLoopCount=6,e.MaxVibrationWaveformSegmentDuration=ta,e.MaxWifiPasswordLength=64,e.MaxWifiSSIDLength=32,e.MicrophoneCommands=Ui,e.MicrophoneConfigurationTypes=Fi,e.MicrophoneConfigurationValues=$i,e.MinNameLength=2,e.MinWifiPasswordLength=8,e.MinWifiSSIDLength=1,e.RangeHelper=Ze,e.SensorRateStep=5,e.SensorTypes=qi,e.Sides=Dn,e.TfliteSensorTypes=Js,e.TfliteTasks=Hs,e.ThrottleUtils=Bl,e.VibrationLocations=Zn,e.VibrationTypes=Xn,e.VibrationWaveformEffects=_n,e.WebSocketClient=class extends Ml{constructor(){super(...arguments),El.add(this),kl.set(this,void 0),Wl.set(this,{open:t(this,El,"m",Tl).bind(this),message:t(this,El,"m",Il).bind(this),close:t(this,El,"m",_l).bind(this),error:t(this,El,"m",Ll).bind(this)}),Fl.set(this,new A(t(this,El,"m",Al).bind(this),3e4))}get webSocket(){return t(this,kl,"f")}set webSocket(e){t(this,kl,"f")!=e?($l.log("assigning webSocket",e),t(this,kl,"f")&&Ka(t(this,kl,"f"),t(this,Wl,"f")),Ja(e,t(this,Wl,"f")),i(this,kl,e,"f"),$l.log("assigned webSocket")):$l.log("redundant webSocket assignment")}get readyState(){return this.webSocket?.readyState}get isConnected(){return this.readyState==WebSocket.OPEN}get isDisconnected(){return this.readyState==WebSocket.CLOSED}connect(e=`wss://${location.host}`){this.webSocket&&this.assertDisconnection(),this._connectionStatus="connecting",this.webSocket=new WebSocket(e)}disconnect(){this.assertConnection(),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.webSocket.addEventListener("close",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this._connectionStatus="disconnecting",this.webSocket.close()}reconnect(){this.assertDisconnection(),this.connect(this.webSocket.url)}toggleConnection(e){this.isConnected?this.disconnect():e&&this.webSocket?.url==e?this.reconnect():this.connect(e)}sendMessage(e){this.assertConnection(),t(this,kl,"f").send(e),t(this,Fl,"f").restart()}sendServerMessage(...e){this.sendMessage(Ho({type:"serverMessage",data:qo(...e)}))}},e.setAllConsoleLevelFlags=function(e){W.setAllLevelFlags(e)},e.setConsoleLevelFlagsForType=function(e,t){W.setLevelFlagsForType(e,t)}}));
//# sourceMappingURL=brilliantsole.min.js.map
